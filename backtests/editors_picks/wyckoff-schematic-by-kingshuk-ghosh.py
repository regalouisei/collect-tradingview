"""
OpenClaw Backtest Results: wyckoff-schematic-by-kingshuk-ghosh
============================================================

--- SPY ---
  ERROR: object of type 'TvStrategy' has no len()

--- BTC ---
  ERROR: object of type 'TvStrategy' has no len()

--- QQQ ---
  ERROR: object of type 'TvStrategy' has no len()

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script â€” wyckoff-schematic-by-kingshuk-ghosh
Generated by OpenClaw TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover


class TvStrategy(Strategy):
    # Wyckoff Detection Parameters
    lookback = 100
    volMultiplier = 1.5
    zigzagLength = 4
    minBarsBetweenLabels = 20
    labelOffsetPct = 2.0

    def init(self):
        close = pd.Series(self.data.Close)
        high = pd.Series(self.data.High)
        low = pd.Series(self.data.Low)
        volume = pd.Series(self.data.Volume)
        
        # Volume Analysis
        self.avgVolume = self.I(pta.sma, volume, length=self.lookback)
        
        # Price Range Analysis
        self.priceRange = high - low
        self.avgRange = self.I(pta.sma, self.priceRange, length=20)
        
        # Support and Resistance
        self.highestHigh = self.I(lambda x: pd.Series(x).rolling(self.lookback).max(), high)
        self.lowestLow = self.I(lambda x: pd.Series(x).rolling(self.lookback).min(), low)
        
        # Track state
        self.phase = "None"
        self.last_signal_bar = 0

    def next(self):
        if len(self) < self.lookback:
            return
        
        # Current values
        current_vol = self.data.Volume[-1]
        current_high = self.data.High[-1]
        current_low = self.data.Low[-1]
        current_close = self.data.Close[-1]
        current_open = self.data.Open[-1]
        avg_vol = self.avgVolume[-1]
        highest = self.highestHigh[-1]
        lowest = self.lowestLow[-1]
        mid_range = (highest + lowest) / 2
        
        # Volume conditions
        high_volume = current_vol > avg_vol * self.volMultiplier
        climax_volume = current_vol > avg_vol * (self.volMultiplier + 0.5)
        
        # Price conditions
        narrow_range = self.priceRange[-1] < self.avgRange[-1] * 0.6
        range_size = highest - lowest
        
        # ===== ACCUMULATION EVENTS =====
        
        # Selling Climax (SC) - Strong down move on high volume
        sc_condition = (
            climax_volume and 
            current_close < current_open and 
            current_low <= lowest * 1.02 and
            current_close < self.data.Close[-2]
        )
        
        # Automatic Rally (AR) - Strong up move after SC
        ar_condition = (
            current_close > current_open and 
            current_vol > avg_vol and 
            self.data.Low[-2] <= self.lowestLow[-2] and
            current_close > self.data.Close[-2] * 1.01
        )
        
        # Spring - Price breaks below support then recovers
        spring_condition = (
            current_low < self.lowestLow[-1] * 0.99 and
            current_close > current_open and 
            current_vol > avg_vol and 
            current_close > current_low * 1.01
        )
        
        # Sign of Strength (SOS) - Strong up move on good volume above midpoint
        sos_condition = (
            current_close > self.data.Close[-2] and
            current_vol > avg_vol * 1.3 and
            current_close - current_open > self.avgRange[-1] and
            current_close > mid_range
        )
        
        # Last Point of Support (LPS)
        lps_condition = (
            current_low > lowest and
            current_close > current_open and
            current_vol < avg_vol and
            current_close > mid_range
        )
        
        # ===== DISTRIBUTION EVENTS =====
        
        # Buying Climax (BC) - Strong up move on climax volume
        bc_condition = (
            climax_volume and
            current_close > current_open and
            current_high >= highest
        )
        
        # Upthrust After Distribution (UTAD) - Price breaks above resistance but closes lower
        utad_condition = (
            current_high > highest * 1.01 and
            current_close < current_open and
            current_vol > avg_vol and
            current_close < current_high * 0.99
        )
        
        # Last Point of Supply (LPSY)
        lpsy_condition = (
            current_high < highest and
            current_close < current_open and
            current_vol < avg_vol and
            current_close < mid_range
        )
        
        # ===== TRADING LOGIC =====
        
        # BUY signals: Spring, SOS, LPS indicate accumulation phase strength
        if (spring_condition or sos_condition) and not self.position:
            self.buy()
            self.phase = "Accumulation"
            self.last_signal_bar = len(self)
        
        # SELL signals: UTAD, LPSY indicate distribution phase weakness
        if (utad_condition or lpsy_condition) and self.position:
            self.sell()
            self.phase = "Distribution"
            self.last_signal_bar = len(self)
        
        # Additional exit: If price closes below support after accumulation
        if self.position and current_close < lowest * 0.98:
            self.sell()
        
        # Additional exit: If price closes above resistance after distribution
        if not self.position and current_close > highest * 1.02:
            self.buy()