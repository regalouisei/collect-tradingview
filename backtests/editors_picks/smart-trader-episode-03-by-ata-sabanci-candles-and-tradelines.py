"""
DS-TV Backtest Results: smart-trader-episode-03-by-ata-sabanci-candles-and-tradelines
============================================================

--- SPY ---
  ERROR: object of type 'TvStrategy' has no len()

--- BTC ---
  ERROR: object of type 'TvStrategy' has no len()

--- QQQ ---
  ERROR: object of type 'TvStrategy' has no len()

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script â€” smart-trader-episode-03-by-ata-sabanci-candles-and-tradelines
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover


class TvStrategy(Strategy):
    # Default parameters
    window_bars = 100
    group_count = 20
    atr_length = 20
    
    def init(self):
        # Calculate ATR for reference
        close = pd.Series(self.data.Close)
        high = pd.Series(self.data.High)
        low = pd.Series(self.data.Low)
        
        self.atr = self.I(pta.atr, high, low, close, length=self.atr_length)
    
    def next(self):
        # Simple trading logic based on available data
        # Buy on uptrend signals, sell on downtrend signals
        
        if len(self) < self.atr_length + 1:
            return
        
        # Get current ATR value
        current_atr = self.atr[-1]
        
        if pd.isna(current_atr):
            return
        
        # Simple momentum-based strategy
        # Buy when price is above SMA and ATR is expanding
        sma_period = 20
        if len(self) >= sma_period:
            close_series = pd.Series(self.data.Close[-sma_period:])
            sma = close_series.mean()
            
            if self.data.Close[-1] > sma:
                # Check if we have an uptrend signal
                if len(self) > 1:
                    prev_atr = self.atr[-2]
                    if not pd.isna(prev_atr) and current_atr > prev_atr:
                        if not self.position:
                            self.buy()
            else:
                # Downtrend signal
                if self.position:
                    self.position.close()


# Backtest execution
if __name__ == "__main__":
    # Load sample data (EURUSD 1H)
    data = pd.read_csv('data.csv', index_col=0, parse_dates=True)
    
    bt = Backtest(data, TvStrategy, cash=10000, commission=0.0002)
    stats = bt.run()
    print(stats)
    bt.plot()