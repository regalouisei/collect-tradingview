"""
OpenClaw Backtest Results: volume-surprise-luxalgo
============================================================

--- SPY ---
  ERROR: Indicator "sma(1)" error. See traceback above.

--- BTC ---
  ERROR: Indicator "sma(1)" error. See traceback above.

--- QQQ ---
  ERROR: Indicator "sma(1)" error. See traceback above.

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script â€” volume-surprise-luxalgo
Generated by OpenClaw TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover


class TvStrategy(Strategy):
    length = 50
    smooth = 1

    def init(self):
        close = pd.Series(self.data.Close)
        volume = pd.Series(self.data.Volume)
        
        self.vol = self.I(pta.sma, volume, length=self.smooth)
        
        self.expected_vol = self.I(self._calculate_expected_volume)
        
        self.difference = self.I(self._calculate_difference)

    def _calculate_expected_volume(self):
        volume = pd.Series(self.data.Volume)
        vol_sma = pta.sma(volume, length=self.smooth)
        
        expected_volumes = []
        for i in range(len(vol_sma)):
            if i < self.length:
                lookback = vol_sma[:i+1]
            else:
                lookback = vol_sma[i-self.length+1:i+1]
            
            if len(lookback) > 0:
                expected_vol = lookback.mean()
            else:
                expected_vol = np.nan
            
            expected_volumes.append(expected_vol)
        
        return pd.Series(expected_volumes, index=vol_sma.index)

    def _calculate_difference(self):
        volume = pd.Series(self.data.Volume)
        vol_sma = pta.sma(volume, length=self.smooth)
        expected_vol_series = self._calculate_expected_volume()
        
        return vol_sma - expected_vol_series

    def next(self):
        current_vol = self.vol[-1]
        current_expected = self.expected_vol[-1]
        current_diff = self.difference[-1]
        
        if len(self.vol) < 2:
            return
        
        prev_diff = self.difference[-2]
        
        if not self.position:
            if current_diff > 0 and prev_diff <= 0 and current_vol > current_expected:
                self.buy()
        else:
            if current_diff < 0 and prev_diff >= 0:
                self.sell()