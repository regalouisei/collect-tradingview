"""
DS-TV Backtest Results: trend-flow-x-strategy
============================================================

--- SPY ---
  ERROR: Indicators must return (optionally a tuple of) numpy.arrays of same length as `data` (data shape: (502,); indicator "ema(macd(12,2…,9)" shape: , returned value: None)

--- BTC ---
  ERROR: Indicators must return (optionally a tuple of) numpy.arrays of same length as `data` (data shape: (732,); indicator "ema(macd(12,2…,9)" shape: , returned value: None)

--- QQQ ---
  ERROR: Indicators must return (optionally a tuple of) numpy.arrays of same length as `data` (data shape: (502,); indicator "ema(macd(12,2…,9)" shape: , returned value: None)

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script — trend-flow-x-strategy
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover

class TvStrategy(Strategy):
    param1 = 14  # example

    def init(self):
        close = pd.Series(self.data.Close)
        # Calculate indicators using self.I() wrapper
        self.rsi = self.I(pta.rsi, close, length=self.param1)
        self.ema20 = self.I(pta.ema, close, length=20)
        self.ema50 = self.I(pta.ema, close, length=50)
        self.sma20 = self.I(pta.sma, close, length=20)
        self.sma50 = self.I(pta.sma, close, length=50)
        self.macd = self.I(pta.macd, close, fast=12, slow=26, signal=9)
        self.signal = self.I(pta.ema, self.macd, length=9)
        self.adx, self.plusDI, self.minusDI = self.I(lambda: pta.adx(self.data.High, self.data.Low, self.data.Close, length=14) or pd.Series(20, index=self.data.index), length=14)
        self.wr = self.I(lambda: pta.wr(self.data.High, self.data.Low, self.data.Close, length=14) or pd.Series(-50, index=self.data.index), length=14)

    def next(self):
        # Trading logic
        if self.rsi[-1] > 55 and self.plusDI[-1] > self.minusDI[-1] and self.adx[-1] > 20 and self.wr[-1] > -50:
            self.buy()
        elif self.rsi[-1] < 45 and self.minusDI[-1] > self.plusDI[-1] and self.adx[-1] > 20 and self.wr[-1] < -50:
            self.sell()
        else:
            self.close("Buy")
            self.close("Sell")