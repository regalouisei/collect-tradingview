"""
DS-TV Backtest Results: smart-trend-zofesu
============================================================

--- SPY ---
  ERROR: Indicators must return (optionally a tuple of) numpy.arrays of same length as `data` (data shape: (502,); indicator "atr(H,L,30)" shape: , returned value: None)

--- BTC ---
  ERROR: Indicators must return (optionally a tuple of) numpy.arrays of same length as `data` (data shape: (732,); indicator "atr(H,L,30)" shape: , returned value: None)

--- QQQ ---
  ERROR: Indicators must return (optionally a tuple of) numpy.arrays of same length as `data` (data shape: (502,); indicator "atr(H,L,30)" shape: , returned value: None)

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script â€” smart-trend-zofesu
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover


class TvStrategy(Strategy):
    atr_length = 30
    multiplier = 1.8
    use_filter = True
    filter_len = 200
    use_vol = True
    vol_pct_target = 80

    def init(self):
        close = pd.Series(self.data.Close)
        atr = self.I(pta.atr, high=self.data.High, low=self.data.Low, close=close, length=self.atr_length)
        v_rank = self.I(pta.percentrank, volume=self.data.Volume, length=200)
        main_trend_ma = self.I(pta.hma, close=close, length=self.filter_len)
        main_trend_bull = close > main_trend_ma
        main_trend_bear = close < main_trend_ma
        self.trend_dir = np.nan
        self.trend_line = np.nan
        self.upper_band = self.I(lambda: self.data.High - (atr * self.multiplier), high=self.data.High, atr=atr)
        self.lower_band = self.I(lambda: self.data.Low + (atr * self.multiplier), low=self.data.Low, atr=atr)
        self.vol_confirmed = not self.use_vol or v_rank > self.vol_pct_target

    def next(self):
        if np.isnan(self.trend_line):
            self.trend_line = self.upper_band.iloc[-1]
        if self.trend_dir == 1:
            if self.data.Close[-1] < self.trend_line and self.vol_confirmed:
                self.trend_dir = -1
                self.trend_line = self.lower_band.iloc[-1]
            else:
                self.trend_line = np.maximum(self.trend_line.iloc[-1], self.upper_band.iloc[-1])
        else:
            if self.data.Close[-1] > self.trend_line and self.vol_confirmed:
                self.trend_dir = 1
                self.trend_line = self.upper_band.iloc[-1]
            else:
                self.trend_line = np.minimum(self.trend_line.iloc[-1], self.lower_band.iloc[-1])
        if self.trend_dir == 1 and np.isnan(self.trend_dir.iloc[-2]) and (not self.use_filter or main_trend_bull.iloc[-1]):
            self.buy()
        elif self.trend_dir == -1 and np.isnan(self.trend_dir.iloc[-2]) and (not self.use_filter or main_trend_bear.iloc[-1]):
            self.sell()