"""
DS-TV Backtest Results: trend-based-fibs-strict-reversal-logic-with-signal-and-alert
============================================================

--- SPY ---
  ERROR: name 'data' is not defined

--- BTC ---
  ERROR: name 'data' is not defined

--- QQQ ---
  ERROR: name 'data' is not defined

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script â€” trend-based-fibs-strict-reversal-logic-with-signal-and-alert
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover

class TvStrategy(Strategy):
    # Default parameters from Pine Script
    tfMode = "Daily"
    showLabels = True
    showFirstHL = True
    showSLTarget = True
    showEma = True
    emaLength = 20
    showEma2 = True
    emaLength2 = 100

    def init(self):
        close = pd.Series(self.data.Close)
        # Calculate indicators using self.I() wrapper
        self.indicator = self.I(pta.rsi, close, length=self.emaLength)
        self.ema1 = self.I(pta.ema, close, length=self.emaLength)
        self.ema2 = self.I(pta.ema, close, length=self.emaLength2)

    def next(self):
        # Trading logic
        if crossover(self.indicator, 30):
            self.buy()
        elif crossover(70, self.indicator):
            self.sell()

# Create a backtest instance
bt = Backtest(data, TvStrategy, cash=10000, commission=0.001)
stats = bt.run()
print(stats)