"""
DS-TV Backtest Results: all-in-one-dynamic-trade-sessions
============================================================

--- SPY ---
  ERROR: 'Position' object has no attribute 'open_price'

--- BTC ---
  ERROR: 'Position' object has no attribute 'open_price'

--- QQQ ---
  ERROR: 'Position' object has no attribute 'open_price'

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script â€” all-in-one-dynamic-trade-sessions
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover


class TvStrategy(Strategy):
    ema_len = 50
    rsi_len = 7
    atr_len = 14
    rr_ratio = 2.0

    def init(self):
        close = pd.Series(self.data.Close)
        high = pd.Series(self.data.High)
        low = pd.Series(self.data.Low)
        
        self.trend_ema = self.I(pta.ema, close, length=self.ema_len)
        self.rsi = self.I(pta.rsi, close, length=self.rsi_len)
        self.atr = self.I(pta.atr, high, low, close, length=self.atr_len)
        
        macd_result = self.I(lambda: pta.macd(close, fast=12, slow=26, signal=9))
        self.macd_line = self.I(lambda: pta.macd(close, fast=12, slow=26, signal=9)['MACD_12_26_9'] if pta.macd(close, fast=12, slow=26, signal=9) is not None else pd.Series(0, index=close.index))
        self.signal_line = self.I(lambda: pta.macd(close, fast=12, slow=26, signal=9)['MACDs_12_26_9'] if pta.macd(close, fast=12, slow=26, signal=9) is not None else pd.Series(0, index=close.index))

    def next(self):
        if len(self.data) < max(self.ema_len, self.rsi_len, self.atr_len, 26):
            return
        
        close_price = self.data.Close[-1]
        rsi_val = self.rsi[-1]
        trend_ema_val = self.trend_ema[-1]
        atr_val = self.atr[-1]
        
        is_chop = rsi_val > 45 and rsi_val < 55
        is_trending = not is_chop
        
        macd_line_val = self.macd_line[-1]
        signal_line_val = self.signal_line[-1]
        
        long_cond = (
            crossover(self.macd_line, self.signal_line) and 
            close_price > trend_ema_val and 
            rsi_val > 50 and 
            is_trending
        )
        
        short_cond = (
            crossover(self.signal_line, self.macd_line) and 
            close_price < trend_ema_val and 
            rsi_val < 50 and 
            is_trending
        )
        
        if long_cond and not self.position:
            stop_price = close_price - (atr_val * 1.5)
            dist = close_price - stop_price
            tp_price = close_price + (dist * self.rr_ratio)
            self.buy()
        
        if short_cond and not self.position:
            stop_price = close_price + (atr_val * 1.5)
            dist = stop_price - close_price
            tp_price = close_price - (dist * self.rr_ratio)
            self.sell()
        
        if self.position:
            if self.position.is_long:
                stop_price = self.position.open_price - (atr_val * 1.5)
                dist = self.position.open_price - stop_price
                tp_price = self.position.open_price + (dist * self.rr_ratio)
                
                if close_price <= stop_price or close_price >= tp_price:
                    self.position.close()
            
            elif self.position.is_short:
                stop_price = self.position.open_price + (atr_val * 1.5)
                dist = stop_price - self.position.open_price
                tp_price = self.position.open_price - (dist * self.rr_ratio)
                
                if close_price >= stop_price or close_price <= tp_price:
                    self.position.close()


if __name__ == '__main__':
    from backtesting.test import GOOG
    
    bt = Backtest(GOOG, TvStrategy, cash=10000, commission=.002)
    stats = bt.run()
    print(stats)
    bt.plot()