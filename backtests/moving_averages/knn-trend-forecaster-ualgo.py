"""
DS-TV Backtest Results: knn-trend-forecaster-ualgo
============================================================

--- SPY ---
  ERROR: '(' was never closed (knn-trend-forecaster-ualgo.py, line 37)

--- BTC ---
  ERROR: '(' was never closed (knn-trend-forecaster-ualgo.py, line 37)

--- QQQ ---
  ERROR: '(' was never closed (knn-trend-forecaster-ualgo.py, line 37)

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script â€” knn-trend-forecaster-ualgo
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover

class TvStrategy(Strategy):
    param1 = 12  # Model Sensitivity
    param2 = 18  # Forecast Horizon
    param3 = 3.0  # Tunnel Volatility

    def init(self):
        close = pd.Series(self.data.Close)
        self.rsi = self.I(pta.rsi, close, length=14)
        self.roc = self.I(lambda: pta.roc(close, 10), length=100)
        self.atr = self.I(pta.atr, high=self.data.High, low=self.data.Low, close=close, length=14)
        self.memory = []
        self.predictions = []

    def next(self):
        if len(self.memory) > 1000:
            self.memory.pop(0)
        if barstate.isconfirmed:
            outcome = (self.data.Close[-1] - self.data.Close[-10]) / self.data.Close[-10] * 100
            self.memory.append(TrainingPoint(self.I(lambda: FeatureSet(f_rsi=self.rsi[-1], f_roc=self.roc[-1], f_atr=self.atr[-1])), outcome))
        if len(self.memory) >= self.param1:
            dists = []
            changes = []
            for point in self.memory:
                dist = self.I(lambda: math.sqrt(math.pow(point.features.f1 - self.I(lambda: FeatureSet(f_rsi=self.rsi[-1], f_roc=self.roc[-1], f_atr=self.atr[-1])).f1, 2) +
                               math.pow(point.features.f2 - self.I(lambda: FeatureSet(f_rsi=self.rsi[-1], f_roc=self.roc[-1], f_atr=self.atr[-1])).f2, 2) +
                               math.pow(point.features.f3 - self.I(lambda: FeatureSet(f_rsi=self.rsi[-1], f_roc=self.roc[-1], f_atr=self.atr[-1])).f3, 2))
                dists.append(dist)
                changes.append(point.change)
            twc = 0.0
            ws = 0.0
            td = dists.copy()
            tc = changes.copy()
            for k in range(1, self.param1 + 1):
                idx = td.indexof(td.min())
                if idx != -1:
                    w = 1.0 / max(td[idx], 0.0001)
                    twc += tc[idx] * w
                    ws += w
                    td.remove(idx)
                    tc.remove(idx)
            pred = twc / ws
            self.predictions.append(pred)
        else:
            pred = 0.0
        self.predictions = self.predictions[-self.param2:]
        if len(self.predictions) > 1:
            trend = np.mean(self.predictions)
            if trend > 0.005:
                self.buy()
            elif trend < -0.005:
                self.sell()