"""
DS-TV Backtest Results: swing-trade-strategy
============================================================

--- SPY ---
  ERROR: object of type 'TvStrategy' has no len()

--- BTC ---
  ERROR: object of type 'TvStrategy' has no len()

--- QQQ ---
  ERROR: object of type 'TvStrategy' has no len()

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script â€” swing-trade-strategy
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover


class TvStrategy(Strategy):
    def init(self):
        close = pd.Series(self.data.Close)
        high = pd.Series(self.data.High)
        low = pd.Series(self.data.Low)
        
        # INDIKATOR 1: RMI TREND SNIPER
        rmi_length = 8
        close_change = close.diff()
        rmi_up = close_change.clip(lower=0).ewm(span=rmi_length, adjust=False).mean()
        rmi_down = (-close_change.clip(upper=0)).ewm(span=rmi_length, adjust=False).mean()
        rmi_value = np.where(
            rmi_down == 0, 100,
            np.where(rmi_up == 0, 0, 100 - (100 / (1 + rmi_up / rmi_down)))
        )
        rmi_value = pd.Series(rmi_value, index=close.index)
        ema5 = pta.ema(close, length=5)
        ema5_change = ema5.diff()
        rmi_signal = pd.Series(np.where(
            (rmi_value > rmi_value.shift(1)) & (ema5_change > 0), 1,
            np.where((rmi_value < rmi_value.shift(1)) & (ema5_change < 0), -1, 0)
        ), index=close.index)
        self.rmi_signal = self.I(lambda: rmi_signal)
        
        # INDIKATOR 2: ALMA SMOOTH
        alma_length = 82
        alma_offset = 0.7
        alma_sigma = 3.8
        alma_value = pta.alma(close, length=alma_length, A=alma_offset, m=alma_sigma)
        alma_signal = pd.Series(np.where(
            close > alma_value, 1,
            np.where(close < alma_value, -1, 0)
        ), index=close.index)
        self.alma_signal = self.I(lambda: alma_signal)
        
        # INDIKATOR 3: CTI
        cti_length = 45
        cti_threshold = 0.3
        cti_value = pd.Series(index=close.index, dtype=float)
        for i in range(len(close)):
            if i >= cti_length:
                cti_sum = np.sum(close.iloc[i-cti_length:i] - close.iloc[i-cti_length])
                cti_std = close.iloc[i-cti_length:i].std()
                if cti_std > 0:
                    cti_value.iloc[i] = cti_sum / (cti_length * cti_std)
                else:
                    cti_value.iloc[i] = 0
        cti_signal = pd.Series(np.where(
            cti_value > cti_threshold, 1,
            np.where(cti_value < -cti_threshold, -1, 0)
        ), index=close.index)
        self.cti_signal = self.I(lambda: cti_signal)
        
        # INDIKATOR 4: SEBASTINE TREND CATCHER
        stc_fast_length = 21
        stc_slow_length = 50
        stc_fast_ema = pta.ema(close, length=stc_fast_length)
        stc_slow_ema = pta.ema(close, length=stc_slow_length)
        stc_signal = pd.Series(np.where(
            stc_fast_ema > stc_slow_ema, 1,
            np.where(stc_fast_ema < stc_slow_ema, -1, 0)
        ), index=close.index)
        self.stc_signal = self.I(lambda: stc_signal)
        
        # INDIKATOR 5: GUNXO TREND SNIPER
        gunxo_length1 = 56
        gunxo_length2 = 56
        gunxo_ema1 = pta.ema(close, length=gunxo_length1)
        gunxo_ema2 = pta.ema(close, length=gunxo_length2)
        gunxo_signal = pd.Series(np.where(
            (close > gunxo_ema1) & (close > gunxo_ema2), 1,
            np.where((close < gunxo_ema1) & (close < gunxo_ema2), -1, 0)
        ), index=close.index)
        self.gunxo_signal = self.I(lambda: gunxo_signal)
        
        # INDIKATOR 6: DEMA DMI
        dema_length = 50
        dmi_length1 = 14
        dmi_length2 = 14
        ema1_dema = pta.ema(close, length=dema_length)
        ema2_dema = pta.ema(ema1_dema, length=dema_length)
        dema_value = 2 * ema1_dema - ema2_dema
        dmi_result = pta.adx(high, low, close, length=dmi_length1)
        di_plus = dmi_result.iloc[:, 0] if dmi_result.shape[1] > 0 else pd.Series(0, index=close.index)
        di_minus = dmi_result.iloc[:, 1] if dmi_result.shape[1] > 1 else pd.Series(0, index=close.index)
        dema_dmi_signal = pd.Series(np.where(
            (close > dema_value) & (di_plus > di_minus), 1,
            np.where((close < dema_value) & (di_minus > di_plus), -1, 0)
        ), index=close.index)
        self.dema_dmi_signal = self.I(lambda: dema_dmi_signal)
        
        # INDIKATOR 7: MM FOR LOOP
        mm_length = 13
        mm_threshold = 70
        mm_ema = pta.ema(close, length=mm_length)
        mm_high = high.rolling(window=mm_length).max()
        mm_low = low.rolling(window=mm_length).min()
        mm_percent = ((close - mm_low) / (mm_high - mm_low)) * 100
        mm_signal = pd.Series(np.where(
            (mm_percent > mm_threshold) & (close > mm_ema), 1,
            np.where((mm_percent < (100 - mm_threshold)) & (close < mm_ema), -1, 0)
        ), index=close.index)
        self.mm_signal = self.I(lambda: mm_signal)
        
        # INDIKATOR 8: DMI FOR LOOP
        dmi_loop_length = 15
        dmi_loop_ema_len = 15
        dmi_loop_slow = 44
        dmi_loop_upper_threshold = 0.25
        dmi_loop_lower_threshold = -0.25
        dmi_result2 = pta.adx(high, low, close, length=dmi_loop_length)
        di_plus2 = dmi_result2.iloc[:, 0] if dmi_result2.shape[1] > 0 else pd.Series(0, index=close.index)
        di_minus2 = dmi_result2.iloc[:, 1] if dmi_result2.shape[1] > 1 else pd.Series(0, index=close.index)
        dmi_diff = (di_plus2 - di_minus2) / 100
        dmi_diff_ema = pta.ema(dmi_diff, length=dmi_loop_ema_len)
        dmi_loop_signal = pd.Series(np.where(
            dmi_diff_ema > dmi_loop_upper_threshold, 1,
            np.where(dmi_diff_ema < dmi_loop_lower_threshold, -1, 0)
        ), index=close.index)
        self.dmi_loop_signal = self.I(lambda: dmi_loop_signal)
        
        # INDIKATOR 9: TREND OSCILLATOR
        to_length = 12
        to_fast = pta.ema(close, length=to_length)
        to_slow = pta.ema(close, length=to_length * 2)
        to_oscillator = ((to_fast - to_slow) / to_slow) * 100
        to_signal = pd.Series(np.where(
            to_oscillator > 0, 1,
            np.where(to_oscillator < 0, -1, 0)
        ), index=close.index)
        self.to_signal = self.I(lambda: to_signal)
        
        # INDIKATOR 10: STOCH FOR LOOP
        stoch_d = 5
        stoch_threshold = 50
        stoch_ema_length = 50
        stoch_lower_threshold = -0.5
        stoch_neutral_threshold = 0.1
        stoch_result = pta.stoch(high, low, close, k=stoch_d, d=stoch_d, smooth_k=3)
        stoch_value = stoch_result.iloc[:, 0] if stoch_result is not None and stoch_result.shape[1] > 0 else pd.Series(50, index=close.index)
        stoch_ema = pta.ema(stoch_value, length=stoch_ema_length)
        stoch_normalized = (stoch_value - 50) / 50
        stoch_signal = pd.Series(np.where(
            (stoch_value > stoch_threshold) & (stoch_normalized > stoch_neutral_threshold), 1,
            np.where((stoch_value < stoch_threshold) & (stoch_normalized < stoch_lower_threshold), -1, 0)
        ), index=close.index)
        self.stoch_signal = self.I(lambda: stoch_signal)
        
        self.trend_state = [0]

    def next(self):
        rmi_sig = self.rmi_signal[-1]
        alma_sig = self.alma_signal[-1]
        cti_sig = self.cti_signal[-1]
        stc_sig = self.stc_signal[-1]
        gunxo_sig = self.gunxo_signal[-1]
        dema_dmi_sig = self.dema_dmi_signal[-1]
        mm_sig = self.mm_signal[-1]
        dmi_loop_sig = self.dmi_loop_signal[-1]
        to_sig = self.to_signal[-1]
        stoch_sig = self.stoch_signal[-1]
        
        bullish_score = (
            (1 if rmi_sig == 1 else 0) +
            (2 if alma_sig == 1 else 0) +
            (1 if cti_sig == 1 else 0) +
            (2 if stc_sig == 1 else 0) +
            (1 if gunxo_sig == 1 else 0) +
            (2 if dema_dmi_sig == 1 else 0) +
            (1 if mm_sig == 1 else 0) +
            (1 if dmi_loop_sig == 1 else 0) +
            (1 if to_sig == 1 else 0) +
            (1 if stoch_sig == 1 else 0)
        )
        
        bearish_score = (
            (1 if rmi_sig == -1 else 0) +
            (2 if alma_sig == -1 else 0) +
            (1 if cti_sig == -1 else 0) +
            (2 if stc_sig == -1 else 0) +
            (1 if gunxo_sig == -1 else 0) +
            (2 if dema_dmi_sig == -1 else 0) +
            (1 if mm_sig == -1 else 0) +
            (1 if dmi_loop_sig == -1 else 0) +
            (1 if to_sig == -1 else 0) +
            (1 if stoch_sig == -1 else 0)
        )
        
        score_diff = bullish_score - bearish_score
        raw_trend = 2 if score_diff > 4 else 1 if score_diff > 1 else -2 if score_diff < -4 else -1 if score_diff < -1 else 0
        
        if raw_trend > 0:
            self.trend_state[0] = self.trend_state[0] + 1 if self.trend_state[0] >= 0 else 0
        elif raw_trend < 0:
            self.trend_state[0] = self.trend_state[0] - 1 if self.trend_state[0] <= 0 else 0
        
        confirmed_trend = raw_trend if abs(self.trend_state[0]) >= 2 else 0
        
        final_trend = confirmed_trend if confirmed_trend != 0 else 0
        
        buy_signal = final_trend >= 1
        sell_signal = final_trend <= 0 and len(self) > 1
        
        if buy_signal and not self.position:
            self.buy()
        elif sell_signal and self.position:
            self.position.close()