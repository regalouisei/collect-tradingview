"""
DS-TV Backtest Results: pro-grid-dual-asset-momentum-visualizer
============================================================

--- SPY ---
  ERROR: Indicator "λ" error. See traceback above.

--- BTC ---
  ERROR: Indicator "λ" error. See traceback above.

--- QQQ ---
  ERROR: Indicator "λ" error. See traceback above.

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script — pro-grid-dual-asset-momentum-visualizer
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover


class TvStrategy(Strategy):
    rsi_len = 14
    vol_len = 14
    lookback = 200
    use_stoch = False
    stoch_k = 14
    stoch_d = 3
    velocity_len = 5
    div_lookback = 5
    corr_len = 20

    def init(self):
        close = pd.Series(self.data.Close)
        high = pd.Series(self.data.High)
        low = pd.Series(self.data.Low)

        # Main momentum indicator - RSI
        self.momentum_main = self.I(
            lambda: pta.rsi(close, length=self.rsi_len) or pd.Series(50, index=close.index)
        )

        # ATR for volume normalization
        self.atr_main = self.I(
            lambda: pta.atr(high, low, close, length=self.vol_len) or pd.Series(0, index=close.index)
        )

        # Normalized volume (0-100)
        def norm_vol():
            atr_series = pta.atr(high, low, close, length=self.vol_len)
            if atr_series is None:
                return pd.Series(50, index=close.index)
            max_atr = atr_series.rolling(self.lookback).max()
            min_atr = atr_series.rolling(self.lookback).min()
            range_atr = max_atr - min_atr
            norm = ((atr_series - min_atr) / range_atr * 100).fillna(50)
            return norm

        self.norm_vol_main = self.I(norm_vol)

        # Stochastic alternative
        if self.use_stoch:
            stoch_result = self.I(
                lambda: pta.stoch(high, low, close, k=self.stoch_k, d=self.stoch_d) or pd.DataFrame({'STOCHk_' + str(self.stoch_k) + '_' + str(self.stoch_d): pd.Series(50, index=close.index)}, index=close.index)
            )
            self.stoch_k_main = stoch_result.iloc[:, 0] if isinstance(stoch_result, pd.DataFrame) else self.momentum_main

    def next(self):
        if len(self.data) < self.lookback + 10:
            return

        momentum = self.momentum_main[-1]
        volume_norm = self.norm_vol_main[-1]

        # Determine zone
        if momentum >= 50 and volume_norm >= 50:
            zone = "Strong Bull"
        elif momentum < 50 and volume_norm >= 50:
            zone = "Vol Spike"
        elif momentum < 50 and volume_norm < 50:
            zone = "Weak Bear"
        else:
            zone = "Low Vol"

        # Trading logic based on momentum and volume zones
        # Buy signal: Strong Bull zone with momentum above 50
        if zone == "Strong Bull" and momentum > 60:
            if not self.position:
                self.buy()

        # Sell signal: Weak Bear zone with momentum below 40
        elif zone == "Weak Bear" and momentum < 40:
            if self.position:
                self.sell()

        # Exit on Vol Spike reversal
        elif zone == "Vol Spike" and self.position:
            if momentum < 30:
                self.sell()

        # Exit on Low Vol after extended position
        elif zone == "Low Vol" and self.position:
            if len(self) % 20 == 0:  # Exit every 20 bars in low vol
                self.sell()

        # Additional momentum extremes
        if momentum > 80 and volume_norm > 70 and self.position:
            self.sell()

        if momentum < 20 and volume_norm > 70 and not self.position:
            self.buy()