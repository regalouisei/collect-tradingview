"""
DS-TV Backtest Results: xauusd-1-minute-scalping-strategy-advanced-strategy-for-exits
============================================================

--- SPY ---
  ERROR: Indicator "λ" error. See traceback above.

--- BTC ---
  ERROR: Indicator "λ" error. See traceback above.

--- QQQ ---
  ERROR: Indicator "λ" error. See traceback above.

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script — xauusd-1-minute-scalping-strategy-advanced-strategy-for-exits
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover


class TvStrategy(Strategy):
    length = 14
    overbought = 70
    oversold = 30
    takeProfit = 10
    stopLoss = 5
    use_trend_filter = True

    def init(self):
        close = pd.Series(self.data.Close)
        high = pd.Series(self.data.High)
        low = pd.Series(self.data.Low)
        
        # Calculate RSI
        self.rsi = self.I(lambda: pta.rsi(close, length=self.length) or pd.Series(50, index=close.index))
        
        # Calculate 200 EMA for trend filter
        self.ema200 = self.I(lambda: pta.ema(close, length=200) or pd.Series(close, index=close.index))
        
        # Track entry prices and TP/SL levels
        self.long_tp_price = np.nan
        self.long_sl_price = np.nan
        self.short_tp_price = np.nan
        self.short_sl_price = np.nan
        
        # Track previous position size
        self.prev_position_size = 0

    def next(self):
        # Get current values
        current_close = self.data.Close[-1]
        current_rsi = self.rsi[-1]
        current_ema200 = self.ema200[-1]
        current_position_size = self.position.size if self.position else 0
        
        # Entry conditions
        long_condition = (current_rsi < self.oversold and 
                         (not self.use_trend_filter or current_close > current_ema200))
        
        short_condition = (current_rsi > self.overbought and 
                          (not self.use_trend_filter or current_close < current_ema200))
        
        # Entry logic
        if long_condition and current_position_size == 0:
            self.buy()
        
        if short_condition and current_position_size == 0:
            self.sell()
        
        # Set TP/SL prices on entry bar
        if current_position_size > 0 and self.prev_position_size <= 0:
            self.long_tp_price = current_close + self.takeProfit * 0.01
            self.long_sl_price = current_close - self.stopLoss * 0.01
        
        if current_position_size < 0 and self.prev_position_size >= 0:
            self.short_tp_price = current_close - self.takeProfit * 0.01
            self.short_sl_price = current_close + self.stopLoss * 0.01
        
        # Exit logic for long positions
        if current_position_size > 0:
            if current_close >= self.long_tp_price or current_close <= self.long_sl_price:
                self.position.close()
        
        # Exit logic for short positions
        if current_position_size < 0:
            if current_close <= self.short_tp_price or current_close >= self.short_sl_price:
                self.position.close()
        
        # Update previous position size
        self.prev_position_size = current_position_size


if __name__ == "__main__":
    bt = Backtest(
        pd.read_csv("data.csv", index_col=0, parse_dates=True),
        TvStrategy,
        cash=1000000,
        commission=0.001,
        exclusive_orders=True
    )
    stats = bt.run()
    print(stats)
    bt.plot()