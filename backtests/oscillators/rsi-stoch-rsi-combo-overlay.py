"""
DS-TV Backtest Results: rsi-stoch-rsi-combo-overlay
============================================================

--- SPY ---
  ERROR: Indicator "_calculat…(_calculat…,14,3)" error. See traceback above.

--- BTC ---
  ERROR: Indicator "_calculat…(_calculat…,14,3)" error. See traceback above.

--- QQQ ---
  ERROR: Indicator "_calculat…(_calculat…,14,3)" error. See traceback above.

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script — rsi-stoch-rsi-combo-overlay
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover


class TvStrategy(Strategy):
    rsiLengthInput = 14
    smoothK = 3
    smoothD = 3
    lengthStoch = 14
    rsiOB = 70
    rsiOS = 30

    def init(self):
        close = pd.Series(self.data.Close)
        high = pd.Series(self.data.High)
        low = pd.Series(self.data.Low)
        
        # Calculate RSI manually (RSI = 100 - (100 / (1 + RS)) where RS = avg_gain / avg_loss)
        self.rsi = self.I(self._calculate_rsi, close, self.rsiLengthInput)
        
        # Calculate Stoch RSI based on RSI values
        self.k = self.I(self._calculate_stoch_k, self.rsi, self.lengthStoch, self.smoothK)
        self.d = self.I(self._calculate_stoch_d, self.k, self.smoothD)

    def _calculate_rsi(self, close, length):
        """Calculate RSI using pandas_ta"""
        result = pta.rsi(close, length=length)
        if result is None:
            return pd.Series(50, index=close.index)
        return result

    def _calculate_stoch_k(self, rsi, length, smoothK):
        """Calculate Stochastic RSI K line"""
        if rsi is None or len(rsi) < length:
            return pd.Series(50, index=rsi.index if rsi is not None else pd.RangeIndex(length))
        
        # Stochastic of RSI: (RSI - lowest_RSI) / (highest_RSI - lowest_RSI) * 100
        rsi_low = rsi.rolling(window=length).min()
        rsi_high = rsi.rolling(window=length).max()
        
        stoch = ((rsi - rsi_low) / (rsi_high - rsi_low)) * 100
        stoch = stoch.fillna(50)
        
        # Smooth with SMA
        k = pta.sma(stoch, length=smoothK)
        if k is None:
            return pd.Series(50, index=stoch.index)
        return k

    def _calculate_stoch_d(self, k, smoothD):
        """Calculate Stochastic RSI D line"""
        if k is None or len(k) < smoothD:
            return pd.Series(50, index=k.index if k is not None else pd.RangeIndex(smoothD))
        
        d = pta.sma(k, length=smoothD)
        if d is None:
            return pd.Series(50, index=k.index)
        return d

    def next(self):
        # Buy when RSI crosses above oversold level (30)
        if crossover(self.rsi, self.rsiOS):
            if not self.position:
                self.buy()
        
        # Sell when RSI crosses below overbought level (70)
        elif crossover(self.rsiOB, self.rsi):
            if self.position:
                self.position.close()
        
        # Alternative: Use Stoch RSI K/D crossover
        # Buy when K crosses above D in oversold zone
        elif crossover(self.k, self.d) and self.k[-1] < 30:
            if not self.position:
                self.buy()
        
        # Sell when K crosses below D in overbought zone
        elif crossover(self.d, self.k) and self.k[-1] > 70:
            if self.position:
                self.position.close()


if __name__ == "__main__":
    from backtesting.test import GOOG
    
    bt = Backtest(GOOG, TvStrategy, cash=10000, commission=.002)
    results = bt.run()
    print(results)
    bt.plot()