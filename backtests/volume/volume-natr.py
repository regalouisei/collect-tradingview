"""
DS-TV Backtest Results: volume-natr
============================================================

--- SPY ---
  ERROR: Indicators must return (optionally a tuple of) numpy.arrays of same length as `data` (data shape: (500,); indicator "sma(λ,14)" shape: , returned value: None)

--- BTC ---
  ERROR: Indicators must return (optionally a tuple of) numpy.arrays of same length as `data` (data shape: (731,); indicator "sma(λ,14)" shape: , returned value: None)

--- QQQ ---
  ERROR: Indicators must return (optionally a tuple of) numpy.arrays of same length as `data` (data shape: (500,); indicator "sma(λ,14)" shape: , returned value: None)

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script — volume-natr
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover


class TvStrategy(Strategy):
    natr_length = 14
    natr_smooth = 14

    def init(self):
        close = pd.Series(self.data.Close)
        high = pd.Series(self.data.High)
        low = pd.Series(self.data.Low)
        volume = pd.Series(self.data.Volume)
        
        # Calculate ATR and NATR
        atr = self.I(pta.atr, high, low, close, length=self.natr_length)
        natr = self.I(lambda: (atr / close * 100) if atr is not None else pd.Series(0, index=close.index))
        self.natr_smoothed = self.I(pta.sma, natr, length=self.natr_smooth)
        
        # Calculate volume-based indicators for different periods
        # Assuming 1-hour timeframe, we'll calculate rolling volume sums
        self.volume_24h = self.I(lambda: volume.rolling(24).sum())
        self.volume_12h = self.I(lambda: volume.rolling(12).sum())
        self.volume_4h = self.I(lambda: volume.rolling(4).sum())
        self.volume_1h = self.I(lambda: volume.rolling(1).sum())

    def next(self):
        # Trading logic based on NATR and volume trends
        if len(self) < 2:
            return
        
        # Get current and previous NATR values
        current_natr = self.natr_smoothed[-1]
        previous_natr = self.natr_smoothed[-2]
        
        # Get volume trend
        current_vol_24h = self.volume_24h[-1]
        previous_vol_24h = self.volume_24h[-2]
        
        # Buy signal: NATR increasing and volume increasing
        if current_natr > previous_natr and current_vol_24h > previous_vol_24h:
            if not self.position:
                self.buy()
        
        # Sell signal: NATR decreasing or volume decreasing significantly
        elif current_natr < previous_natr or current_vol_24h < previous_vol_24h * 0.8:
            if self.position:
                self.sell()