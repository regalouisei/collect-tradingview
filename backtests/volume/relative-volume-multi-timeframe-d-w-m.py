"""
DS-TV Backtest Results: relative-volume-multi-timeframe-d-w-m
============================================================

--- SPY ---
  ERROR: Indicators must return (optionally a tuple of) numpy.arrays of same length as `data` (data shape: (502,); indicator "λ" shape: , returned value: None)

--- BTC ---
  ERROR: Indicators must return (optionally a tuple of) numpy.arrays of same length as `data` (data shape: (732,); indicator "λ" shape: , returned value: None)

--- QQQ ---
  ERROR: Indicators must return (optionally a tuple of) numpy.arrays of same length as `data` (data shape: (502,); indicator "λ" shape: , returned value: None)

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script — relative-volume-multi-timeframe-d-w-m
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover

class TvStrategy(Strategy):
    param1 = 14  # example
    param2 = 14  # example
    param3 = 50  # example
    param4 = 10.0  # example

    def init(self):
        close = pd.Series(self.data.Close)
        volume = pd.Series(self.data.Volume)
        atr_raw = self.I(lambda: pta.atr(high=self.data.High, low=self.data.Low, close=close, length=self.param2))
        atr_rel_base = self.I(lambda: pta.sma(src=atr_raw, length=self.param3))
        atr_rel = atr_raw / atr_rel_base if atr_rel_base > 0 else np.nan
        atr_pct = atr_rel * 100 if atr_rel_base > 0 else np.nan
        atr_scaled = atr_rel if self.param4 == 0 else atr_pct
        atr_scaled_clamped = np.clip(atr_scaled, 0, self.param4) if self.param4 > 0 else atr_scaled
        self.rvolf = self.I(lambda: pta.rvolf(volume=volume, length=self.param1))
        self.atr_scaled = atr_scaled_clamped

    def next(self):
        if crossover(self.rvolf, 1.0):
            self.buy()
        elif crossover(3.0, self.rvolf):
            self.sell()
        atr_scaled = self.atr_scaled[-1]
        if atr_scaled is not None:
            if atr_scaled < 1.0:
                self.buy()
            elif atr_scaled > 3.0:
                self.sell()