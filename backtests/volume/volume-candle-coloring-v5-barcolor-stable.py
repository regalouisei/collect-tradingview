"""
DS-TV Backtest Results: volume-candle-coloring-v5-barcolor-stable
============================================================

--- SPY ---
  ERROR: Indicator "λ" error. See traceback above.

--- BTC ---
  ERROR: Indicator "λ" error. See traceback above.

--- QQQ ---
  ERROR: Indicator "λ" error. See traceback above.

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script — volume-candle-coloring-v5-barcolor-stable
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover


class TvStrategy(Strategy):
    volLength = 20
    lowMult = 0.7
    midMult = 1.5
    highMult = 2.5
    ultraMult = 4.0

    def init(self):
        volume = pd.Series(self.data.Volume)
        close = pd.Series(self.data.Close)
        open_ = pd.Series(self.data.Open)
        
        self.volMA = self.I(pta.sma, volume, length=self.volLength)
        
        def get_vol_states(vol_series, vol_ma_series):
            vol_low = vol_series < vol_ma_series * self.lowMult
            vol_normal = (vol_series >= vol_ma_series * self.lowMult) & (vol_series < vol_ma_series * self.midMult)
            vol_high = (vol_series >= vol_ma_series * self.midMult) & (vol_series < vol_ma_series * self.highMult)
            vol_extreme = (vol_series >= vol_ma_series * self.highMult) & (vol_series < vol_ma_series * self.ultraMult)
            vol_ultra = vol_series >= vol_ma_series * self.ultraMult
            return vol_low, vol_normal, vol_high, vol_extreme, vol_ultra
        
        self.vol_states = self.I(lambda: get_vol_states(volume, self.volMA))
        
        def get_direction(close_series, open_series):
            bull = close_series >= open_series
            bear = close_series < open_series
            return bull, bear
        
        self.direction = self.I(lambda: get_direction(close, open_))
        
        def get_color_signal(vol_states, direction):
            vol_low, vol_normal, vol_high, vol_extreme, vol_ultra = vol_states
            bull, bear = direction
            
            signal = pd.Series(0, index=bull.index)
            
            signal[bull & vol_ultra] = 1
            signal[bull & vol_extreme] = 1
            signal[bull & vol_high] = 1
            signal[bull & vol_normal] = 1
            signal[bull & vol_low] = 1
            signal[bear & vol_ultra] = -1
            signal[bear & vol_extreme] = -1
            signal[bear & vol_high] = -1
            signal[bear & vol_normal] = -1
            signal[bear & vol_low] = -1
            
            return signal
        
        self.color_signal = self.I(lambda: get_color_signal(self.vol_states, self.direction))

    def next(self):
        if len(self.data) < self.volLength + 1:
            return
        
        current_signal = self.color_signal[-1]
        
        if len(self.color_signal) > 1:
            prev_signal = self.color_signal[-2]
        else:
            prev_signal = 0
        
        if current_signal > 0 and prev_signal <= 0:
            if not self.position:
                self.buy()
        elif current_signal < 0 and prev_signal >= 0:
            if self.position:
                self.position.close()