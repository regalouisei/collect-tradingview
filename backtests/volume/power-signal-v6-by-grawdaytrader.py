"""
DS-TV Backtest Results: power-signal-v6-by-grawdaytrader
============================================================

--- SPY ---
  ERROR: invalid syntax (power-signal-v6-by-grawdaytrader.py, line 25)

--- BTC ---
  ERROR: invalid syntax (power-signal-v6-by-grawdaytrader.py, line 25)

--- QQQ ---
  ERROR: invalid syntax (power-signal-v6-by-grawdaytrader.py, line 25)

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script â€” power-signal-v6-by-grawdaytrader
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover

class TvStrategy(Strategy):
    param1 = 20  # Length
    param2 = 100  # Plot Threshold
    param3 = 150  # Signal Trigger

    def init(self):
        close = pd.Series(self.data.Close)
        volume = pd.Series(self.data.Volume)
        self.pwr = self.I(lambda: (close / self.I(lambda: self.I(request.security, syminfo.tickerid, "1D", high[1])) - 1) * 100 > -1 and volume / self.I(lambda: self.I(ta.sma, volume, self.param1)) * 100 > 150) * 1.2
        self.vr = self.I(lambda: volume / self.I(lambda: ta.sma(volume, self.param1)) * 100)
        self.px = self.I(lambda: (high - self.I(lambda: self.I(request.security, syminfo.tickerid, "1D", high[1]))) / self.I(lambda: self.I(request.security, syminfo.tickerid, "1D", high[1])) * 100)
        self.plot(self.pwr, "Power", linewidth=3, color=self.pwr > self.param2 ? color.lime : color.gray)
        self.hline(self.param2, "Threshold", color=color.yellow)
        self.hline(self.param3, "Signal Thr", color=color.red, linestyle=hline.style_dotted)
        self.hline(0)
        self.sig = self.I(ta.crossover, self.pwr, self.param3)
        self.plotshape(self.param3 and self.sig, "PSI!", style=shape.labelup, location=location.bottom, color=color.lime, textcolor=color.white, text="PSI!")

    def next(self):
        if self.I(ta.crossover, self.param3, self.pwr):
            self.buy()
        elif self.I(ta.crossover, self.pwr, self.param3):
            self.sell()