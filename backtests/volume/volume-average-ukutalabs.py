"""
DS-TV Backtest Results: volume-average-ukutalabs
============================================================

--- SPY ---
  ERROR: object of type 'TvStrategy' has no len()

--- BTC ---
  ERROR: object of type 'TvStrategy' has no len()

--- QQQ ---
  ERROR: object of type 'TvStrategy' has no len()

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script â€” volume-average-ukutalabs
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover


class TvStrategy(Strategy):
    LookBackPeriod = 13

    def init(self):
        close = pd.Series(self.data.Close)
        volume = pd.Series(self.data.Volume)
        
        self.volume_ema = self.I(pta.ema, volume, length=self.LookBackPeriod)
        self.volume = self.I(lambda: volume)
    
    def next(self):
        current_volume = self.volume[-1]
        current_volume_ema = self.volume_ema[-1]
        
        if current_volume_ema is None:
            return
        
        if len(self) < self.LookBackPeriod + 1:
            return
        
        prev_volume = self.volume[-2] if len(self.volume) > 1 else current_volume
        prev_volume_ema = self.volume_ema[-2] if len(self.volume_ema) > 1 else current_volume_ema
        
        volume_crossed_above = (prev_volume <= prev_volume_ema and current_volume > current_volume_ema)
        volume_crossed_below = (prev_volume > prev_volume_ema and current_volume <= current_volume_ema)
        
        if volume_crossed_above and not self.position:
            self.buy()
        elif volume_crossed_below and self.position:
            self.sell()


if __name__ == "__main__":
    from backtesting.test import SMA, GOOG
    
    bt = Backtest(GOOG, TvStrategy, cash=10000, commission=.002)
    stats = bt.run()
    print(stats)
    bt.plot()