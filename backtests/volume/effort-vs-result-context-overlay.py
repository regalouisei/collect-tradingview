"""
DS-TV Backtest Results: effort-vs-result-context-overlay
============================================================

--- SPY ---
  Return                    0.12%
  Buy & Hold Return         41.94%
  Max Drawdown              -0.52%
  Sharpe Ratio              0.11
  Sortino Ratio             0.19
  Calmar Ratio              0.12
  Profit Factor             1.24
  Expectancy                0.06%
  SQN                       0.11
  # Trades                  2
  Win Rate                  50.00%
  Best Trade                0.65%
  Worst Trade               -0.52%
  Avg Trade                 0.06%
  Exposure Time             0.80%
  Equity Final              100123.61$
  Equity Peak               100644.35$
  Avg Drawdown              -0.52%
  Max Drawdown Duration     11 days 00:00:00
  Max Trade Duration        3 days 00:00:00
  Avg Trade Duration        2 days 00:00:00
  Ann. Return               0.06%
  Ann. Volatility           0.55%

--- BTC ---
  Return                    3.66%
  Buy & Hold Return         46.22%
  Max Drawdown              -5.27%
  Sharpe Ratio              0.31
  Sortino Ratio             0.50
  Calmar Ratio              0.34
  Profit Factor             1.47
  Expectancy                0.79%
  SQN                       0.38
  # Trades                  4
  Win Rate                  75.00%
  Best Trade                6.19%
  Worst Trade               -6.73%
  Avg Trade                 0.68%
  Exposure Time             1.09%
  Equity Final              103657.44$
  Equity Peak               109426.14$
  Avg Drawdown              -1.82%
  Max Drawdown Duration     278 days 00:00:00
  Max Trade Duration        1 days 00:00:00
  Avg Trade Duration        1 days 00:00:00
  Ann. Return               1.81%
  Ann. Volatility           5.91%

--- QQQ ---
  Return                    0.04%
  Buy & Hold Return         42.67%
  Max Drawdown              -0.57%
  Sharpe Ratio              0.03
  Sortino Ratio             0.05
  Calmar Ratio              0.04
  Profit Factor             1.07
  Expectancy                0.02%
  SQN                       0.03
  # Trades                  2
  Win Rate                  50.00%
  Best Trade                0.62%
  Worst Trade               -0.57%
  Avg Trade                 0.02%
  Exposure Time             0.80%
  Equity Final              100039.67$
  Equity Peak               100295.86$
  Avg Drawdown              -0.41%
  Max Drawdown Duration     515 days 00:00:00
  Max Trade Duration        1 days 00:00:00
  Avg Trade Duration        1 days 00:00:00
  Ann. Return               0.02%
  Ann. Volatility           0.72%

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script â€” effort-vs-result-context-overlay
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover


class TvStrategy(Strategy):
    volLen = 20
    atrLen = 14
    progressLen = 10
    stallBars = 3
    effortHighThresh = 1.5
    weakResultThresh = 0.35

    def init(self):
        close = pd.Series(self.data.Close)
        high = pd.Series(self.data.High)
        low = pd.Series(self.data.Low)
        volume = pd.Series(self.data.Volume)

        def calculate_effort():
            volMedian = pta.sma(volume, length=self.volLen)
            relVolume = np.where(volMedian > 0, volume / volMedian, 0.0)
            
            tr = pta.true_range(high, low, close)
            atr = pta.atr(high, low, close, length=self.atrLen)
            relTR = np.where(atr > 0, tr / atr, 0.0)
            
            effortScore = (relVolume + relTR) / 2.0
            effortHigh = effortScore >= self.effortHighThresh
            
            return pd.Series(effortHigh, index=close.index)

        def calculate_result():
            netProgress = np.abs(close.values - close.shift(self.progressLen).values)
            
            grossMove = np.zeros(len(close))
            for i in range(len(close)):
                move = 0.0
                for j in range(self.progressLen):
                    if i + j + 1 < len(close):
                        move += np.abs(close.iloc[i + j] - close.iloc[i + j + 1])
                grossMove[i] = move
            
            progressEfficiency = np.where(grossMove > 0, netProgress / grossMove, 0.0)
            resultWeak = progressEfficiency <= self.weakResultThresh
            
            return pd.Series(resultWeak, index=close.index)

        def calculate_followthrough():
            current_move = np.abs(close.diff().values)
            stall_move = np.abs(close.shift(self.stallBars).diff().values)
            followThrough = current_move > stall_move
            
            return pd.Series(followThrough, index=close.index)

        self.effort_high = self.I(calculate_effort)
        self.result_weak = self.I(calculate_result)
        self.follow_through = self.I(calculate_followthrough)

        self.efficiency_state = 1
        self.prev_state = 1
        self.failure_signal = False

    def next(self):
        if len(self.data) < max(self.volLen, self.atrLen, self.progressLen + self.stallBars) + 1:
            return

        effort_high = self.effort_high[-1]
        result_weak = self.result_weak[-1]
        follow_through = self.follow_through[-1]

        efficiency_failure = effort_high and result_weak and not follow_through

        if efficiency_failure:
            self.efficiency_state = -1
        else:
            self.efficiency_state = 1

        state_changed = self.efficiency_state != self.prev_state
        self.prev_state = self.efficiency_state

        self.failure_signal = state_changed and self.efficiency_state == -1

        if self.failure_signal:
            if not self.position:
                self.buy()
        elif self.efficiency_state == 1 and self.position:
            self.position.close()