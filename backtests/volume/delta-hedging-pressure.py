"""
DS-TV Backtest Results: delta-hedging-pressure
============================================================

--- SPY ---
  ERROR: Indicator "calc_cumu…" error. See traceback above.

--- BTC ---
  ERROR: Indicator "calc_cumu…" error. See traceback above.

--- QQQ ---
  ERROR: Indicator "calc_cumu…" error. See traceback above.

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script — delta-hedging-pressure
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover


class TvStrategy(Strategy):
    lenCum = 50
    resetOnSession = True
    showBG = True

    def init(self):
        close = pd.Series(self.data.Close)
        open_ = pd.Series(self.data.Open)
        volume = pd.Series(self.data.Volume)
        
        # Calculate direction: 1 if close > open, -1 if close < open, 0 otherwise
        def calc_direction():
            result = np.where(close > open_, 1, np.where(close < open_, -1, 0))
            return pd.Series(result, index=close.index)
        
        direction = self.I(calc_direction)
        
        # Calculate hedge pressure (volume * direction)
        def calc_hedge_pressure():
            return volume * direction
        
        hedge_pressure = self.I(calc_hedge_pressure)
        
        # Calculate cumulative hedge pressure with session reset
        def calc_cumulative_hedge():
            cum_hedge = np.zeros(len(hedge_pressure))
            
            for i in range(len(hedge_pressure)):
                if i == 0:
                    cum_hedge[i] = hedge_pressure.iloc[i]
                else:
                    # Check if new day (session change)
                    is_new_session = False
                    if self.resetOnSession:
                        # Convert timestamps to date for comparison
                        current_date = pd.Timestamp(self.data.index[i]).date()
                        prev_date = pd.Timestamp(self.data.index[i-1]).date()
                        is_new_session = current_date != prev_date
                    
                    if is_new_session:
                        cum_hedge[i] = hedge_pressure.iloc[i]
                    else:
                        cum_hedge[i] = cum_hedge[i-1] + hedge_pressure.iloc[i]
            
            return pd.Series(cum_hedge, index=close.index)
        
        self.cum_hedge = self.I(calc_cumulative_hedge)

    def next(self):
        current_cum_hedge = self.cum_hedge[-1]
        
        # Determine sentiment
        if current_cum_hedge > 0:
            sentiment = "Bullish"
        elif current_cum_hedge < 0:
            sentiment = "Bearish"
        else:
            sentiment = "Neutral"
        
        # Trading logic based on sentiment
        # Buy on bullish sentiment (positive cumulative hedge pressure)
        if sentiment == "Bullish" and not self.position:
            self.buy()
        
        # Sell on bearish sentiment (negative cumulative hedge pressure)
        elif sentiment == "Bearish" and self.position:
            self.sell()
        
        # Close on neutral
        elif sentiment == "Neutral" and self.position:
            self.sell()


if __name__ == "__main__":
    # Load data
    data = pd.read_csv("data.csv", index_col=0, parse_dates=True)
    
    # Run backtest
    bt = Backtest(data, TvStrategy, cash=10000, commission=0.002)
    stats = bt.run()
    print(stats)
    bt.plot()