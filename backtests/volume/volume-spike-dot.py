"""
DS-TV Backtest Results: volume-spike-dot
============================================================

--- SPY ---
  ERROR: Indicators must return (optionally a tuple of) numpy.arrays of same length as `data` (data shape: (502,); indicator "sma(59293400,20)" shape: , returned value: None)

--- BTC ---
  ERROR: Indicators must return (optionally a tuple of) numpy.arrays of same length as `data` (data shape: (732,); indicator "sma(28624907020,20)" shape: , returned value: None)

--- QQQ ---
  ERROR: Indicators must return (optionally a tuple of) numpy.arrays of same length as `data` (data shape: (502,); indicator "sma(49779000,20)" shape: , returned value: None)

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script â€” volume-spike-dot
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover


class TvStrategy(Strategy):
    # Default parameters from Pine Script
    param1 = 20  # example
    param2 = 200.0  # example

    def init(self):
        close = pd.Series(self.data.Close)
        volume = pd.Series(self.data.Volume)
        # Calculate indicators using self.I() wrapper
        self.avgVol = self.I(pta.sma, volume[1], length=self.param1)
        self.volIncrease = self.I(lambda: ((volume - self.avgVol) / self.avgVol) * 100)

    def next(self):
        # Trading logic
        if self.I(lambda: self.volIncrease >= self.param2):
            self.buy()
        elif self.I(lambda: self.volIncrease < self.param2):
            self.sell()