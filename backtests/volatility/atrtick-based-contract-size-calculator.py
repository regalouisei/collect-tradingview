"""
DS-TV Backtest Results: atrtick-based-contract-size-calculator
============================================================

--- SPY ---
  ERROR: object of type 'TvStrategy' has no len()

--- BTC ---
  ERROR: object of type 'TvStrategy' has no len()

--- QQQ ---
  ERROR: object of type 'TvStrategy' has no len()

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script â€” atrtick-based-contract-size-calculator
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy


class TvStrategy(Strategy):
    maxLoss = 200
    riskMode = "ATR"
    atrPeriod = 14
    atrMultiple = 1.0
    stopTicks = 10
    manualDollarPerPoint = 0.0

    def init(self):
        close = pd.Series(self.data.Close)
        high = pd.Series(self.data.High)
        low = pd.Series(self.data.Low)
        
        self.atr = self.I(pta.atr, high, low, close, length=self.atrPeriod)
        
    def next(self):
        if len(self.data) < self.atrPeriod:
            return
        
        current_atr = self.atr[-1]
        
        if current_atr is None or np.isnan(current_atr):
            return
        
        symbol = "ES"
        dollar_per_point = self.manualDollarPerPoint
        
        if dollar_per_point == 0:
            if "MNQ" in symbol:
                dollar_per_point = 2
            elif "NQ" in symbol:
                dollar_per_point = 20
            elif "MES" in symbol:
                dollar_per_point = 5
            elif "ES" in symbol:
                dollar_per_point = 50
            elif "MYM" in symbol:
                dollar_per_point = 0.5
            elif "YM" in symbol:
                dollar_per_point = 5
            elif "M2K" in symbol:
                dollar_per_point = 5
            elif "RTY" in symbol:
                dollar_per_point = 50
            elif "CL" in symbol:
                dollar_per_point = 1000
            elif "GC" in symbol:
                dollar_per_point = 100
            else:
                dollar_per_point = 50
        
        if dollar_per_point <= 0:
            return
        
        if self.riskMode == "ATR":
            risk_per_contract = current_atr * self.atrMultiple * dollar_per_point
        else:
            risk_per_contract = self.stopTicks * 0.25 * dollar_per_point
        
        if risk_per_contract <= 0:
            return
        
        contracts = int(np.floor(self.maxLoss / risk_per_contract))
        
        if contracts <= 0:
            contracts = 1
        
        if not self.position:
            self.buy(size=contracts)
        elif len(self) % 20 == 0:
            self.position.close()


if __name__ == "__main__":
    from backtesting.test import SMA, GOOG
    
    bt = Backtest(GOOG, TvStrategy, cash=10000, commission=.002)
    results = bt.run()
    print(results)
    bt.plot()