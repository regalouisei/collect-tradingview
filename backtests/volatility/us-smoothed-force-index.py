"""
DS-TV Backtest Results: us-smoothed-force-index
============================================================

--- SPY ---
  ERROR: Indicator "λ" error. See traceback above.

--- BTC ---
  ERROR: Indicator "λ" error. See traceback above.

--- QQQ ---
  ERROR: Indicator "λ" error. See traceback above.

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script — us-smoothed-force-index
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover


class TvStrategy(Strategy):
    roc_len = 20
    smooth_len = 10
    smooth_type = "RMA"

    def init(self):
        close = pd.Series(self.data.Close)
        
        # Calculate ROC
        roc = self.I(lambda x: pta.roc(x, length=self.roc_len) or pd.Series(0, index=x.index), close)
        
        # For single instrument backtest, use the close as all indices
        avg_roc = self.I(lambda x: x, roc)
        
        # Relative strength (deviation from average)
        rs_raw = self.I(lambda x, y: x - y, roc, avg_roc)
        
        # Smoothing function
        if self.smooth_type == "EMA":
            self.rs = self.I(lambda x: pta.ema(x, length=self.smooth_len) or pd.Series(0, index=x.index), rs_raw)
        elif self.smooth_type == "SMA":
            self.rs = self.I(lambda x: pta.sma(x, length=self.smooth_len) or pd.Series(0, index=x.index), rs_raw)
        else:  # RMA
            self.rs = self.I(lambda x: pta.rma(x, length=self.smooth_len) or pd.Series(0, index=x.index), rs_raw)

    def next(self):
        # Buy when relative strength crosses above 0 (positive momentum)
        if crossover(self.rs, 0):
            if not self.position:
                self.buy()
        # Sell when relative strength crosses below 0 (negative momentum)
        elif crossover(0, self.rs):
            if self.position:
                self.position.close()


if __name__ == "__main__":
    from backtesting.test import SMA, GOOG
    
    bt = Backtest(GOOG, TvStrategy, cash=10000, commission=.002)
    stats = bt.run()
    print(stats)
    bt.plot()