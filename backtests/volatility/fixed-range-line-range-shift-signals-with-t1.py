"""
DS-TV Backtest Results: fixed-range-line-range-shift-signals-with-t1
============================================================

--- SPY ---
  ERROR: 'builtin_function_or_method' object has no attribute 'float'

--- BTC ---
  ERROR: 'builtin_function_or_method' object has no attribute 'float'

--- QQQ ---
  ERROR: 'builtin_function_or_method' object has no attribute 'float'

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script â€” fixed-range-line-range-shift-signals-with-t1
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover


class TvStrategy(Strategy):
    # Default parameters from Pine Script
    step = input.float(10, "Fixed Value Step", step=0.1)
    t1Distance = input.float(20, "T1 Distance", step=0.1)

    def init(self):
        close = pd.Series(self.data.Close)
        self.level = self.I(lambda: close[0] if len(close) > 0 else np.nan)
        self.prevLevel = self.I(lambda: self.level)
        self.newUpShift = self.I(lambda: False)
        self.newDownShift = self.I(lambda: False)
        self.buySignal = self.I(lambda: False)
        self.sellSignal = self.I(lambda: False)
        self.t1Active = self.I(lambda: False)
        self.tradeDirection = self.I(lambda: 0)
        self.t1Level = self.I(lambda: np.nan)
        self.t1HitBuy = self.I(lambda: False)
        self.t1HitSell = self.I(lambda: False)

    def next(self):
        close = self.data.Close[-1]
        if self.I(lambda: self.level is not np.nan):
            if close >= self.level + self.step:
                self.level = self.level + self.step
                self.newUpShift = True
            elif close <= self.level - self.step:
                self.level = self.level - self.step
                self.newDownShift = True

        if self.newUpShift:
            self.buySignal = True
        elif self.newDownShift:
            self.sellSignal = True

        if self.buySignal:
            self.t1Active = True
            self.tradeDirection = 1
            self.t1Level = close + self.t1Distance
        elif self.sellSignal:
            self.t1Active = True
            self.tradeDirection = -1
            self.t1Level = close - self.t1Distance

        if self.t1Active and (self.tradeDirection == 1 and self.data.High[-1] >= self.t1Level) or (self.tradeDirection == -1 and self.data.Low[-1] <= self.t1Level):
            self.t1Active = False

        if self.t1Active:
            self.t1HitBuy = (self.tradeDirection == 1 and self.data.High[-1] >= self.t1Level)
            self.t1HitSell = (self.tradeDirection == -1 and self.data.Low[-1] <= self.t1Level)

        if self.buySignal:
            self.buy()
        elif self.sellSignal:
            self.sell()

        self.prevLevel = self.level
        self.newUpShift = False
        self.newDownShift = False