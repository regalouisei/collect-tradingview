"""
DS-TV Backtest Results: cyberpunk-macd-pulse-engine
============================================================

--- SPY ---
  ERROR: Indicator "λ" error. See traceback above.

--- BTC ---
  ERROR: Indicator "λ" error. See traceback above.

--- QQQ ---
  ERROR: Indicator "λ" error. See traceback above.

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script — cyberpunk-macd-pulse-engine
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover


class TvStrategy(Strategy):
    mode_select = "Standard"
    div_lookback = 5

    def init(self):
        close = pd.Series(self.data.Close)
        high = pd.Series(self.data.High)
        low = pd.Series(self.data.Low)

        # Determine MACD parameters based on mode
        if self.mode_select == "Fast (Scalp)":
            fast_len, slow_len, sig_len = 8, 21, 5
        elif self.mode_select == "Slow (Swing)":
            fast_len, slow_len, sig_len = 24, 52, 18
        elif self.mode_select == "Neural Spike":
            fast_len, slow_len, sig_len = 3, 10, 2
        else:  # Standard
            fast_len, slow_len, sig_len = 12, 26, 9

        # Calculate MACD
        macd_result = self.I(
            lambda: pta.macd(close, fast=fast_len, slow=slow_len, signal=sig_len)
        )

        # Extract MACD components
        self.macd_line = self.I(
            lambda: pta.macd(close, fast=fast_len, slow=slow_len, signal=sig_len)["MACD_{}_{}_{}"
                    .format(fast_len, slow_len, sig_len)]
            if pta.macd(close, fast=fast_len, slow=slow_len, signal=sig_len) is not None
            else pd.Series(0, index=close.index)
        )

        self.signal_line = self.I(
            lambda: pta.macd(close, fast=fast_len, slow=slow_len, signal=sig_len)["MACDsh_{}_{}_{}"
                    .format(fast_len, slow_len, sig_len)]
            if pta.macd(close, fast=fast_len, slow=slow_len, signal=sig_len) is not None
            else pd.Series(0, index=close.index)
        )

        self.hist = self.I(
            lambda: pta.macd(close, fast=fast_len, slow=slow_len, signal=sig_len)["MACDh_{}_{}_{}"
                    .format(fast_len, slow_len, sig_len)]
            if pta.macd(close, fast=fast_len, slow=slow_len, signal=sig_len) is not None
            else pd.Series(0, index=close.index)
        )

    def next(self):
        # Buy on MACD crossing above Signal line
        if crossover(self.macd_line, self.signal_line):
            if not self.position:
                self.buy()
        # Sell on MACD crossing below Signal line
        elif crossover(self.signal_line, self.macd_line):
            if self.position:
                self.position.close()


if __name__ == "__main__":
    from backtesting.test import GOOG

    bt = Backtest(GOOG, TvStrategy, cash=10000, commission=.002)
    stats = bt.run()
    print(stats)
    bt.plot()