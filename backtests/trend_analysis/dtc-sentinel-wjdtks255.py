"""
DS-TV Backtest Results: dtc-sentinel-wjdtks255
============================================================

--- SPY ---
  ERROR: Indicators must return (optionally a tuple of) numpy.arrays of same length as `data` (data shape: (502,); indicator "atr(H,L,14)" shape: , returned value: None)

--- BTC ---
  ERROR: Indicators must return (optionally a tuple of) numpy.arrays of same length as `data` (data shape: (732,); indicator "atr(H,L,14)" shape: , returned value: None)

--- QQQ ---
  ERROR: Indicators must return (optionally a tuple of) numpy.arrays of same length as `data` (data shape: (502,); indicator "atr(H,L,14)" shape: , returned value: None)

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script â€” dtc-sentinel-wjdtks255
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover


class TvStrategy(Strategy):
    atrPeriod = 14

    def init(self):
        close = pd.Series(self.data.Close)
        atr = self.I(pta.atr, high=self.data.High, low=self.data.Low, close=close, length=self.atrPeriod)
        upper = self.I(lambda: self.data.High.rolling(20).max(), min_periods=20)
        lower = self.I(lambda: self.data.Low.rolling(20).min(), min_periods=20)

        self.trend = self.I(lambda: 1 if self.data.Close > upper[-1] else -1 if self.data.Close < lower[-1] else 0)

        self.upper = self.I(lambda: upper, min_periods=20)
        self.lower = self.I(lambda: lower, min_periods=20)

    def next(self):
        if crossover(self.trend, 0):
            self.buy()
        elif crossover(0, self.trend):
            self.sell()