"""
DS-TV Backtest Results: mean-deviation-trend-backquant
============================================================

--- SPY ---
  ERROR: invalid syntax (mean-deviation-trend-backquant.py, line 32)

--- BTC ---
  ERROR: invalid syntax (mean-deviation-trend-backquant.py, line 32)

--- QQQ ---
  ERROR: invalid syntax (mean-deviation-trend-backquant.py, line 32)

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script â€” mean-deviation-trend-backquant
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover


class TvStrategy(Strategy):
    param1 = 21  # Mean Length
    param2 = 14  # Deviation Smoothing
    param3 = 8  # Deviation Accumulation
    param4 = 0.7  # Band Tight (High Deviation)
    param5 = 2.6  # Band Wide (Low Deviation)
    param6 = 0.3  # Fade Threshold

    def init(self):
        close = pd.Series(self.data.Close)
        self.mean = self.I(pta.ema, close, length=self.param1)
        self.atr = self.I(pta.atr, high=self.data.High, low=self.data.Low, close=self.data.Close, length=14)
        self.rawDev = (close - self.mean) / self.atr
        self.devSmooth = self.I(pta.ema, self.rawDev, length=self.param2)
        self.cumDev = self.I(pta.sma, self.devSmooth, length=self.param3)
        self.devAbs = np.abs(self.cumDev)
        self.devHigh = self.I(lambda: close['DevAbs'].rolling(80).max(), axis=0)
        self.devNorm = self.devHigh > 0.0 ? np.min(self.devAbs / self.devHigh, 1.0) : 0.0
        self.tDir = np.sign(self.cumDev)
        self.flip = self.tDir != self.tDir[1]
        self.bandMult = self.param5 - self.devNorm * (self.param5 - self.param4)
        self.bandW = self.atr * self.bandMult
        self.activeBand = self.tDir == 1 ? self.mean - self.bandW : self.mean + self.bandW
        self.outerBand = self.tDir == 1 ? self.mean + self.bandW * 0.5 : self.mean - self.bandW * 0.5
        self.activeBand = self.I(pta.ema, self.activeBand, length=3)
        self.outerBand = self.I(pta.ema, self.outerBand, length=3)
        self.tCol = self.tDir == 1 ? self.bullCol : self.bearCol

    def next(self):
        if self.flip and self.tDir == 1:
            self.buy()
        elif self.flip and self.tDir == -1:
            self.sell()