"""
DS-TV Backtest Results: liquidity-structure-order-flow-luxalgo
============================================================

--- SPY ---
  ERROR: Indicators must return (optionally a tuple of) numpy.arrays of same length as `data` (data shape: (502,); indicator "λ" shape: , returned value: None)

--- BTC ---
  ERROR: Indicators must return (optionally a tuple of) numpy.arrays of same length as `data` (data shape: (732,); indicator "λ" shape: , returned value: None)

--- QQQ ---
  ERROR: Indicators must return (optionally a tuple of) numpy.arrays of same length as `data` (data shape: (502,); indicator "λ" shape: , returned value: None)

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script — liquidity-structure-order-flow-luxalgo
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover

class TvStrategy(Strategy):
    param1 = 300  # example

    def init(self):
        close = pd.Series(self.data.Close)
        volume = pd.Series(self.data.Volume)
        self.raw_profile = self.I(lambda: pta.vwma(close, volume, length=self.param1))
        self.smooth_profile = self.I(lambda: pta.ema(self.raw_profile, length=5))
        self.value_area = self.I(lambda: pta.vwma(close, volume, length=self.param1) * 0.7)
        self.void = self.I(lambda: pta.vwma(close, volume, length=self.param1) * 0.3)
        self.upper_volume_total = self.I(lambda: np.sum(self.smooth_profile[self.smooth_profile >= self.value_area]))
        self.lower_volume_total = self.I(lambda: np.sum(self.smooth_profile[self.smooth_profile <= self.value_area]))
        self.delta_agg = self.I(lambda: np.sum(volume[close > self.data.Open]) - np.sum(volume[close < self.data.Open]))
        self.range_loc = self.I(lambda: (self.data.Close - self.data.Low) / (self.data.High - self.data.Low) * 100)
        self.total_volume = self.I(lambda: np.sum(volume))

    def next(self):
        if crossover(self.smooth_profile[-1], self.value_area[-1]):
            self.buy()
        elif crossover(self.value_area[-1], self.smooth_profile[-1]):
            self.sell()