"""
DS-TV Backtest Results: hot-zone-radar-luxalgo
============================================================

--- SPY ---
  ERROR: Indicator "λ(float)" error. See traceback above.

--- BTC ---
  ERROR: Indicator "λ(float)" error. See traceback above.

--- QQQ ---
  ERROR: Indicator "λ(float)" error. See traceback above.

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script — hot-zone-radar-luxalgo
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover


class TvStrategy(Strategy):
    # Default parameters from Pine Script
    param1 = 200  # Profile Lookback
    param2 = 30  # Resolution (Heatmap Grid)
    param3 = 3  # Diffusion Blur
    param4 = 0.7  # Intensity Gamma
    param5 = 80.0  # S/R Sensitivity %
    param6 = 3  # Gradient Steps

    def init(self):
        close = pd.Series(self.data.Close)
        # Calculate indicators using self.I() wrapper
        self.currentProfile = self.I(lambda: pta.rsi(close, length=self.param1))
        self.historyMatrix = self.I(lambda: np.zeros((self.param2, self.param2)), dtype=float)
        self.tracePrice = self.I(pta.ema, close, length=3)
        self.slope = self.I(lambda: ta.linreg(self.tracePrice, 5, 0) - ta.linreg(self.tracePrice, 5, 1))
        self.binSize = self.I(lambda: ta.highest(self.data.High, self.param1) - ta.lowest(self.data.Low, self.param1)) / self.param2

    def next(self):
        # Trading logic
        if crossover(self.currentProfile, 30):
            self.buy()
        elif crossover(70, self.currentProfile):
            self.sell()