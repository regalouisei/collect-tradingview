"""
DS-TV Backtest Results: ict-mmmamd-power-of-3-ualgo
============================================================

--- SPY ---
  ERROR: invalid syntax (ict-mmmamd-power-of-3-ualgo.py, line 204)

--- BTC ---
  ERROR: invalid syntax (ict-mmmamd-power-of-3-ualgo.py, line 204)

--- QQQ ---
  ERROR: invalid syntax (ict-mmmamd-power-of-3-ualgo.py, line 204)

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script â€” ict-mmmamd-power-of-3-ualgo
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover

class TvStrategy(Strategy):
    atrLen = 14
    minSweepTicks = 0
    minSweepATR = 0.20
    useWicksForSweep = True
    pivotLenMSS = 3
    dispMinAtr = 0.60
    dispMinBodyPct = 0.55
    requireDisplacement = True
    fvgSearchBars = 30
    removeMitigatedFvg = True
    entryOnlyInDist = True
    slPadTicks = 1
    targetMode = "PDH/PDL + Range"
    showTargets = True
    showPDH_PDL = True
    showDealingRange = True
    drPivotLen = 5
    clrAcc = (0, 255, 255)
    clrManip = (255, 165, 0)
    clrBull = (0, 255, 0)
    clrBear = (255, 0, 0)
    clrTargetA = (255, 255, 0)
    clrTargetB = (0, 0, 255)
    clrPD = (128, 128, 128)
    clrDR = (255, 0, 255)
    lineWidth = 1
    accLineStyle = "Dashed"
    targetLineStyle = "Dotted"
    extendRight = False
    showAccumBox = True
    showPhaseLabels = True
    keepCycles = 10
    labelSizeInput = "Tiny"
    showSweepLines = True
    showMssLines = True
    lblSize = "Tiny"

    def init(self):
        close = pd.Series(self.data.Close)
        atr = self.I(pta.atr, high=self.data.High, low=self.data.Low, close=close, length=self.atrLen)
        thr = np.maximum(self.minSweepTicks * self.data.Close[0].syminfo.mintick, self.minSweepATR * atr[-1])
        self.sweepLevel = None
        self.sweepPrice = None
        self.sweepDir = 0
        self.mssLevel = None
        self.mssDir = 0
        self.dispBar = None
        self.fvgTop = None
        self.fvgBot = None
        self.entryMarked = False
        self.slPrice = None
        self.slLine = None
        self.tgt1Hit = False
        self.tgt2Hit = False
        self.pdh = None
        self.pdl = None
        self.dayStartBar = None
        self.pdhLine = None
        self.pdlLine = None
        self.pdhLbl = None
        self.pdlLbl = None

    def next(self):
        close = self.data.Close[-1]
        high = self.data.High[-1]
        low = self.data.Low[-1]
        open = self.data.Open[-1]
        atr = self.I(pta.atr, high=self.data.High, low=self.data.Low, close=close, length=self.atrLen)
        thr = np.maximum(self.minSweepTicks * self.data.Close[0].syminfo.mintick, self.minSweepATR * atr[-1])

        if self.entryMarked:
            self.updateStops()

        if self.sweepDir != 0:
            self.updateSweepLines()

        if self.mssLevel is not None:
            self.updateMssLines()

        if self.fvgTop is not None and self.fvgBot is not None:
            self.drawFvg()

        if self.dayStartBar is None:
            self.dayStartBar = self.data.index[-1]

        if self.showPDH_PDL and self.pdh is not None and self.pdl is not None:
            self.drawPDH_PDL()

        if self.showDealingRange:
            self.updateDealingRange()

        if self.showAccumBox:
            self.drawAccumulationBox()

        if self.showPhaseLabels:
            self.drawPhaseLabels()

        if self.sweepLevel is not None and self.sweepPrice is not None:
            self.trySweep()

        if self.mssLevel is not None:
            self.tryMss()

        if self.dispBar is not None:
            self.tryDisplacement()

        if self.fvgTop is not None and self.fvgBot is not None:
            self.tryFvg()

        if self.entryMarked:
            self.onFvgTouch()

        if self.showTargets:
            self.updateTargets()

        if self.showPDH_PDL:
            self.updatePDH_PDL()

        if self.showDealingRange:
            self.updateDealingRange()

    def updateStops(self):
        if self.slLine is not None and not self.slHit and self.slPrice is not None:
            if self.mssDir == 1 and self.low <= self.slPrice:
                self.slHit = True
                self.slLine.extend = extend.none
            elif self.mssDir == -1 and self.high >= self.slPrice:
                self.slHit = True
                self.slLine.extend = extend.none

    def updateSweepLines(self):
        if self.showSweepLines and not self.extendRight and self.sweepWickLn is not None:
            self.sweepWickLn.x2 = self.data.index[-1]

    def updateMssLines(self):
        if self.showMssLines and not self.extendRight and self.mssLvlLn is not None:
            self.mssLvlLn.x2 = self.data.index[-1]

    def drawFvg(self):
        if self.fvgTopLine is not None and self.fvgBotLine is not None:
            if not self.extendRight:
                self.fvgTopLine.x2 = self.data.index[-1]
                self.fvgBotLine.x2 = self.data.index[-1]

    def drawPDH_PDL(self):
        if self.pdhLine is not None and self.pdlLine is not None:
            if not self.extendRight:
                self.pdhLine.x2 = self.data.index[-1]
                self.pdlLine.x2 = self.data.index[-1]

    def updateDealingRange(self):
        if self.showDealingRange:
            if self.phDr is not None and self.plDr is not None:
                if not self.extendRight:
                    self.phDr.x2 = self.data.index[-1]
                    self.plDr.x2 = self.data.index[-1]

    def drawAccumulationBox(self):
        if self.showAccumBox:
            self.accBox.top = self.accHigh
            self.accBox.bottom = self.accLow

    def drawPhaseLabels(self):
        if self.showPhaseLabels:
            self.accLbl.y = self.accHigh
            if self.sweepLbl is not None:
                if self.sweepDir == 1:
                    self.sweepLbl.y = self.sweepPrice
                else:
                    self.sweepLbl.y = self.sweepPrice

    def trySweep(self):
        if self.sweepDir != 0:
            if self.useWicksForSweep:
                upProbe = self.high[-1]
                dnProbe = self.low[-1]
            else:
                upProbe = self.close[-1]
                dnProbe = self.close[-1]

            if self.sweepDir == 1:
                sweptUp = upProbe > self.sweepLevel
                sweptDn = dnProbe < self.sweepLevel
            else:
                sweptUp = upProbe < self.sweepLevel
                sweptDn = dnProbe > self.sweepLevel

            if sweptUp or sweptDn:
                self.entryMarked = True
                color dirColor = self.mssDir == 1 ? self.clrBull : self.clrBear
                self.entryLbl.text = self.mssDir == 1 ? "ENTRY (BULL)" : "ENTRY (BEAR)"
                self.entryLbl.textcolor = dirColor
                self.entryLbl.yloc = yloc.price

                if self.sweepDir == 1:
                    self.slPrice = self.sweepPrice + self.slPadTicks * self.data.Close[0].syminfo.mintick
                else:
                    self.slPrice = self.sweepPrice - self.slPadTicks * self.data.Close[0].syminfo.mintick

                self.slLine.color = dirColor
                self.slLine.extend = extend.none

    def tryMss(self):
        if self.sweepDir == 1 and self.close[-1] < self.mssLevel:
            self.mssDir = -1
            self.mssLevel = self.low[-1]
            self.mssLbl.text = "MSS\nBEAR"
            self.mssLbl.textcolor = self.clrBear
            self.mssLbl.yloc = yloc.abovebar

            if self.showMssLines and self.mssLvlLn is None:
                self.mssLvlLn = line.new(self.data.index[-1], self.mssLevel, self.data.index[-1], self.mssLevel, extend=extend.none, color=self.clrBear, style=line.style_dotted, width=self.lineWidth)

        elif self.sweepDir == -1 and self.close[-1] > self.mssLevel:
            self.mssDir = 1
            self.mssLevel = self.high[-1]
            self.mssLbl.text = "MSS\nBULL"
            self.mssLbl.textcolor = self.clrBull
            self.mssLbl.yloc = yloc.belowbar

            if self.showMssLines and self.mssLvlLn is None:
                self.mssLvlLn = line.new(self.data.index[-1], self.mssLevel, self.data.index[-1], self.mssLevel, extend=extend.none, color=self.clrBull, style=line.style_dotted, width=self.lineWidth)

    def tryDisplacement(self):
        if self.mssDir == 1 and self.close[-1] > self.open[-1] and self.close[-1] > self.high[-2]:
            self.dispBar = self.data.index[-1]

        elif self.mssDir == -1 and self.close[-1] < self.open[-1] and self.close[-1] < self.low[-2]:
            self.dispBar = self.data.index[-1]

    def tryFvg(self):
        if self.showFvg and self.mss and not self.fvgActive and not self.fvgMitigated and self.data.index[-1] > self.mssBar + self.fvgSearchBars:
            if self.mssDir == 1 and self.low[-1] > self.high[-2]:
                self.fvgActive = True
                self.fvgTop = self.low[-1]
                self.fvgBot = self.high[-2]
                self.fvgLbl.text = "FVG"
                self.fvgLbl.textcolor = self.clrBull
                self.fvgLbl.yloc = yloc.price

            elif self.mssDir == -1 and self.high[-1] < self.low[-2]:
                self.fvgActive = True
                self.fvgTop = self.low[-2]
                self.fvgBot = self.high[-1]
                self.fvgLbl.text = "FVG"
                self.fvgLbl.textcolor = self.clrBear
                self.fvgLbl.yloc = yloc.price

    def onFvgTouch(self):
        if self.fvgActive and not self.fvgMitigated:
            touched = self.low[-1] <= self.fvgTop and self.high[-1] >= self.fvgBot
            if touched:
                self.entryMarked = True
                color dirColor = self.mssDir == 1 ? self.clrBull : self.clrBear
                self.entryLbl.text = self.mssDir == 1 ? "ENTRY (BULL)" : "ENTRY (BEAR)"
                self.entryLbl.textcolor = dirColor
                self.entryLbl.yloc = yloc.price

                if self.sweepDir == 1:
                    self.slPrice = self.sweepPrice + self.slPadTicks * self.data.Close[0].syminfo.mintick
                else:
                    self.slPrice = self.sweepPrice - self.slPadTicks * self.data.Close[0].syminfo.mintick

                self.slLine.color = dirColor
                self.slLine.extend = extend.none

                self.fvgMitigated = True
                self.fvgActive = False

    def updateTargets(self):
        if self.showTargets and self.mss:
            wantPD = self.targetMode == "PDH/PDL" or self.targetMode == "PDH/PDL + Range"
            wantRange = self.targetMode == "Range" or self.targetMode == "PDH/PDL + Range"

            t1 = None
            t1Name = ""
            t2 = None
            t2Name = ""

            if self.mssDir == 1:
                if wantPD and self.pdh is not None:
                    t1 = self.pdh
                    t1Name = "PDH"
                if wantRange and self.accHigh is not None:
                    t2 = self.accHigh
                    t2Name = "RANGE HIGH"
            else:
                if wantPD and self.pdl is not None:
                    t1 = self.pdl
                    t1Name = "PDL"
                if wantRange and self.accLow is not None:
                    t2 = self.accLow
                    t2Name = "RANGE LOW"

            if t1 is not None:
                if self.targetLine1 is None:
                    self.targetLine1 = line.new(self.data.index[-1], t1, self.data.index[-1], t1, extend=extend.none, color=self.clrTargetA, style=self.targetLineStyle, width=self.lineWidth)
                    if self.showPhaseLabels:
                        self.targetLbl1 = label.new(self.data.index[-1], t1, t1Name, style=label.style_none, textcolor=self.clrTargetA, size=self.lblSize, yloc=yloc.price)
                else:
                    if not self.extendRight:
                        self.targetLine1.x2 = self.data.index[-1]
                    self.targetLine1.y1 = t1
                    self.targetLine1.y2 = t1
                    if self.showPhaseLabels and self.targetLbl1 is not None:
                        self.targetLbl1.x = self.data.index[-1]
                        self.targetLbl1.y = t1
                        self.targetLbl1.text = t1Name

                if not self.tgt1Hit and self.targetLine1 is not None:
                    if self.mssDir == 1 and self.high[-1] >= t1:
                        self.tgt1Hit = True
                        self.targetLine1.extend = extend.none
                    elif self.mssDir == -1 and self.low[-1] <= t1:
                        self.tgt1Hit = True
                        self.targetLine1.extend = extend.none

            if t2 is not None:
                if self.targetLine2 is None:
                    self.targetLine2 = line.new(self.data.index[-1], t2, self.data.index[-1], t2, extend=extend.none, color=self.clrTargetB, style=self.targetLineStyle, width=self.lineWidth)
                    if self.showPhaseLabels:
                        self.targetLbl2 = label.new(self.data.index[-1], t2, t2Name, style=label.style_none, textcolor=self.clrTargetB, size=self.lblSize, yloc=yloc.price)
                else:
                    if not self.extendRight:
                        self.targetLine2.x2 = self.data.index[-1]
                    self.targetLine2.y1 = t2
                    self.targetLine2.y2 = t2
                    if self.showPhaseLabels and self.targetLbl2 is not None:
                        self.targetLbl2.x = self.data.index[-1]
                        self.targetLbl2.y = t2
                        self.targetLbl2.text = t2Name

                if not self.tgt2Hit and self.targetLine2 is not None:
                    if self.mssDir == 1 and self.high[-1] >= t2:
                        self.tgt2Hit = True
                        self.targetLine2.extend = extend.none
                    elif self.mssDir == -1 and self.low[-1] <= t2:
                        self.tgt2Hit = True
                        self.targetLine2.extend = extend.none

    def updatePDH_PDL(self):
        if self.showPDH_PDL and self.pdh is not None and self.pdl is not None:
            if self.pdhLine is None:
                self.pdhLine = line.new(self.dayStartBar, self.pdh, self.data.index[-1], self.pdh, extend=extend.none, color=self.clrPD, style=line.style_dashed, width=self.lineWidth)
                if self.showPhaseLabels:
                    self.pdhLbl = label.new(self.data.index[-1], self.pdh, "PDH", style=label.style_none, textcolor=self.clrPD, size=self.lblSize, yloc=yloc.price)
            else:
                if not self.extendRight:
                    self.pdhLine.x2 = self.data.index[-1]
                self.pdhLine.y1 = self.pdh
                self.pdhLine.y2 = self.pdh
                if self.showPhaseLabels and self.pdhLbl is not None:
                    self.pdhLbl.x = self.data.index[-1]
                    self.pdhLbl.y = self.pdh

            if self.pdlLine is None:
                self.pdlLine = line.new(self.dayStartBar, self.pdl, self.data.index[-1], self.pdl, extend=extend.none, color=self.clrPD, style=line.style_dashed, width=self.lineWidth)
                if self.showPhaseLabels:
                    self.pdlLbl = label.new(self.data.index[-1], self.pdl, "PDL", style=label.style_none, textcolor=self.clrPD, size=self.lblSize, yloc=yloc.price)
            else:
                if not self.extendRight:
                    self.pdlLine.x2 = self.data.index[-1]
                self.pdlLine.y1 = self.pdl
                self.pdlLine.y2 = self.pdl
                if self.showPhaseLabels and self.pdlLbl is not None:
                    self.pdlLbl.x = self.data.index[-1]
                    self.pdlLbl.y = self.pdl

    def buy(self):
        self.position.close()
        self.position.open(self.data.index[-1], self.data.Close[-1], size=1, side=Position.SIDE_LONG)

    def sell(self):
        self.position.close()
        self.position.open(self.data.index[-1], self.data.Close[-1], size=1, side=Position.SIDE_SHORT)

    def run(self):
        self.backtest.run()