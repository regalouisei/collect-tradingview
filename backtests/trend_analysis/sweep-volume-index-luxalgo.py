"""
DS-TV Backtest Results: sweep-volume-index-luxalgo
============================================================

--- SPY ---
  ERROR: name 'color' is not defined

--- BTC ---
  ERROR: name 'color' is not defined

--- QQQ ---
  ERROR: name 'color' is not defined

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script â€” sweep-volume-index-luxalgo
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover


class TvStrategy(Strategy):
    pivotLenInput = 10
    lowerTfInput = "1"
    useThreshold = True
    atrLength = 200
    atrMult = 1.0
    alphaInput = 95
    upperEnvColor = "#089981"
    lowerEnvColor = "#f23645"
    showLevelsInput = True
    showOscFills = True
    bullColorInput = "#089981"
    bearColorInput = "#f23645"
    phLevelColor = color.new("#089981", 50)
    plLevelColor = color.new("#f23645", 50)
    phZoneColor = color.new("#089981", 85)
    plZoneColor = color.new("#f23645", 85)

    def init(self):
        close = pd.Series(self.data.Close)
        high = pd.Series(self.data.High)
        low = pd.Series(self.data.Low)
        volume = pd.Series(self.data.Volume)
        atr = self.I(pta.atr, high, low, close, length=self.atrLength)
        threshold = self.useThreshold * atr * self.atrMult
        self.upperEnv = self.I(lambda: pta.vwma, high, volume, length=self.pivotLenInput, multiplier=self.alphaInput)
        self.lowerEnv = self.I(lambda: pta.vwma, low, volume, length=self.pivotLenInput, multiplier=self.alphaInput)
        self.lastPH = na
        self.lastPL = na
        self.bullSweepVol = 0.0
        self.bearSweepVol = 0.0

    def next(self):
        close = self.data.Close[-1]
        high = self.data.High[-1]
        low = self.data.Low[-1]
        volume = self.data.Volume[-1]
        atr = self.I(pta.atr, high, low, close, length=self.atrLength)
        threshold = self.useThreshold * atr * self.atrMult
        self.upperEnv = self.I(lambda: pta.vwma, high, volume, length=self.pivotLenInput, multiplier=self.alphaInput)
        self.lowerEnv = self.I(lambda: pta.vwma, low, volume, length=self.pivotLenInput, multiplier=self.alphaInput)
        self.lastPH = self.I(lambda: pta.pivothigh, high, length=self.pivotLenInput, length2=self.pivotLenInput)
        self.lastPL = self.I(lambda: pta.pivotlow, low, length=self.pivotLenInput, length2=self.pivotLenInput)
        intrabars = self.I(lambda: request.security_lower_tf, syminfo.tickerid, self.lowerTfInput, IntrabarData.new(high, low, volume))
        if not na(self.lastPH) and high > self.lastPH and close <= self.lastPH + threshold:
            for ib in intrabars:
                if ib.h > self.lastPH:
                    self.bullSweepVol += ib.v
        if not na(self.lastPL) and low < self.lastPL and close >= self.lastPL - threshold:
            for ib in intrabars:
                if ib.l < self.lastPL:
                    self.bearSweepVol += ib.v
        if self.bullSweepVol > 0:
            self.buy()
        elif self.bearSweepVol > 0:
            self.sell()