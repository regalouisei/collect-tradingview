"""
DS-TV Backtest Results: supertrend-ai-adaptive-strategy-btc
============================================================

--- SPY ---
  ERROR: name 'high' is not defined

--- BTC ---
  ERROR: name 'high' is not defined

--- QQQ ---
  ERROR: name 'high' is not defined

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script â€” supertrend-ai-adaptive-strategy-btc
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover

class TvStrategy(Strategy):
    param1 = 10
    param2 = 3.0
    param3 = 14
    param4 = 40
    param5 = 14
    param6 = 20
    param7 = True
    param8 = 50
    param9 = 20
    param10 = 65
    param11 = "ATR"
    param12 = 2.5
    param13 = 3.0
    param14 = "RR"
    param15 = 2.5
    param16 = 6.0
    param17 = True
    param18 = 2.5
    param19 = True
    param20 = 10
    param21 = True
    param22 = 0
    param23 = 500
    param24 = True
    param25 = True
    param26 = True
    param27 = True
    param28 = True
    param29 = True
    param30 = True
    param31 = True
    param32 = True
    param33 = True
    param34 = True
    param35 = True
    param36 = True
    param37 = True
    param38 = True
    param39 = True
    param40 = True
    param41 = True
    param42 = True
    param43 = True
    param44 = True
    param45 = True
    param46 = True
    param47 = True
    param48 = True
    param49 = True
    param50 = True
    param51 = True
    param52 = True
    param53 = True
    param54 = True
    param55 = True
    param56 = True
    param57 = True
    param58 = True
    param59 = True
    param60 = True
    param61 = True
    param62 = True
    param63 = True
    param64 = True
    param65 = True
    param66 = True
    param67 = True
    param68 = True
    param69 = True
    param70 = True
    param71 = True
    param72 = True
    param73 = True
    param74 = True
    param75 = True
    param76 = True
    param77 = True
    param78 = True
    param79 = True
    param80 = True
    param81 = True
    param82 = True
    param83 = True
    param84 = True
    param85 = True
    param86 = True
    param87 = True
    param88 = True
    param89 = True
    param90 = True
    param91 = True
    param92 = True
    param93 = True
    param94 = True
    param95 = True
    param96 = True
    param97 = True
    param98 = True
    param99 = True
    param100 = True
    param101 = True
    param102 = True
    param103 = True
    param104 = True
    param105 = True
    param106 = True
    param107 = True
    param108 = True
    param109 = True
    param110 = True
    param111 = True
    param112 = True
    param113 = True
    param114 = True
    param115 = True
    param116 = True
    param117 = True
    param118 = True
    param119 = True
    param120 = True
    param121 = True
    param122 = True
    param123 = True
    param124 = True
    param125 = True
    param126 = True
    param127 = True
    param128 = True
    param129 = True
    param130 = True
    param131 = True
    param132 = True
    param133 = True
    param134 = True
    param135 = True
    param136 = True
    param137 = True
    param138 = True
    param139 = True
    param140 = True
    param141 = True
    param142 = True
    param143 = True
    param144 = True
    param145 = True
    param146 = True
    param147 = True
    param148 = True
    param149 = True
    param150 = True
    param151 = True
    param152 = True
    param153 = True
    param154 = True
    param155 = True
    param156 = True
    param157 = True
    param158 = True
    param159 = True
    param160 = True
    param161 = True
    param162 = True
    param163 = True
    param164 = True
    param165 = True
    param166 = True
    param167 = True
    param168 = True
    param169 = True
    param170 = True
    param171 = True
    param172 = True
    param173 = True
    param174 = True
    param175 = True
    param176 = True
    param177 = True
    param178 = True
    param179 = True
    param180 = True
    param181 = True
    param182 = True
    param183 = True
    param184 = True
    param185 = True
    param186 = True
    param187 = True
    param188 = True
    param189 = True
    param190 = True
    param191 = True
    param192 = True
    param193 = True
    param194 = True
    param195 = True
    param196 = True
    param197 = True
    param198 = True
    param199 = True
    param200 = True
    param201 = True
    param202 = True
    param203 = True
    param204 = True
    param205 = True
    param206 = True
    param207 = True
    param208 = True
    param209 = True
    param210 = True
    param211 = True
    param212 = True
    param213 = True
    param214 = True
    param215 = True
    param216 = True
    param217 = True
    param218 = True
    param219 = True
    param220 = True
    param221 = True
    param222 = True
    param223 = True
    param224 = True
    param225 = True
    param226 = True
    param227 = True
    param228 = True
    param229 = True
    param230 = True
    param231 = True
    param232 = True
    param233 = True
    param234 = True
    param235 = True
    param236 = True
    param237 = True
    param238 = True
    param239 = True
    param240 = True
    param241 = True
    param242 = True
    param243 = True
    param244 = True
    param245 = True
    param246 = True
    param247 = True
    param248 = True
    param249 = True
    param250 = True
    param251 = True
    param252 = True
    param253 = True
    param254 = True
    param255 = True
    param256 = True
    param257 = True
    param258 = True
    param259 = True
    param260 = True
    param261 = True
    param262 = True
    param263 = True
    param264 = True
    param265 = True
    param266 = True
    param267 = True
    param268 = True
    param269 = True
    param270 = True
    param271 = True
    param272 = True
    param273 = True
    param274 = True
    param275 = True
    param276 = True
    param277 = True
    param278 = True
    param279 = True
    param280 = True
    param281 = True
    param282 = True
    param283 = True
    param284 = True
    param285 = True
    param286 = True
    param287 = True
    param288 = True
    param289 = True
    param290 = True
    param291 = True
    param292 = True
    param293 = True
    param294 = True
    param295 = True
    param296 = True
    param297 = True
    param298 = True
    param299 = True
    param300 = True
    param301 = True
    param302 = True
    param303 = True
    param304 = True
    param305 = True
    param306 = True
    param307 = True
    param308 = True
    param309 = True
    param310 = True
    param311 = True
    param312 = True
    param313 = True
    param314 = True
    param315 = True
    param316 = True
    param317 = True
    param318 = True
    param319 = True
    param320 = True
    param321 = True
    param322 = True
    param323 = True
    param324 = True
    param325 = True
    param326 = True
    param327 = True
    param328 = True
    param329 = True
    param330 = True
    param331 = True
    param332 = True
    param333 = True
    param334 = True
    param335 = True
    param336 = True
    param337 = True
    param338 = True
    param339 = True
    param340 = True
    param341 = True
    param342 = True
    param343 = True
    param344 = True
    param345 = True
    param346 = True
    param347 = True
    param348 = True
    param349 = True
    param350 = True
    param351 = True
    param352 = True
    param353 = True
    param354 = True
    param355 = True
    param356 = True
    param357 = True
    param358 = True
    param359 = True
    param360 = True
    param361 = True
    param362 = True
    param363 = True
    param364 = True
    param365 = True
    param366 = True
    param367 = True
    param368 = True
    param369 = True
    param370 = True
    param371 = True
    param372 = True
    param373 = True
    param374 = True
    param375 = True
    param376 = True
    param377 = True
    param378 = True
    param379 = True
    param380 = True
    param381 = True
    param382 = True
    param383 = True
    param384 = True
    param385 = True
    param386 = True
    param387 = True
    param388 = True
    param389 = True
    param390 = True
    param391 = True
    param392 = True
    param393 = True
    param394 = True
    param395 = True
    param396 = True
    param397 = True
    param398 = True
    param399 = True
    param400 = True
    param401 = True
    param402 = True
    param403 = True
    param404 = True
    param405 = True
    param406 = True
    param407 = True
    param408 = True
    param409 = True
    param410 = True
    param411 = True
    param412 = True
    param413 = True
    param414 = True
    param415 = True
    param416 = True
    param417 = True
    param418 = True
    param419 = True
    param420 = True
    param421 = True
    param422 = True
    param423 = True
    param424 = True
    param425 = True
    param426 = True
    param427 = True
    param428 = True
    param429 = True
    param430 = True
    param431 = True
    param432 = True
    param433 = True
    param434 = True
    param435 = True
    param436 = True
    param437 = True
    param438 = True
    param439 = True
    param440 = True
    param441 = True
    param442 = True
    param443 = True
    param444 = True
    param445 = True
    param446 = True
    param447 = True
    param448 = True
    param449 = True
    param450 = True
    param451 = True
    param452 = True
    param453 = True
    param454 = True
    param455 = True
    param456 = True
    param457 = True
    param458 = True
    param459 = True
    param460 = True
    param461 = True
    param462 = True
    param463 = True
    param464 = True
    param465 = True
    param466 = True
    param467 = True
    param468 = True
    param469 = True
    param470 = True
    param471 = True
    param472 = True
    param473 = True
    param474 = True
    param475 = True
    param476 = True
    param477 = True
    param478 = True
    param479 = True
    param480 = True
    param481 = True
    param482 = True
    param483 = True
    param484 = True
    param485 = True
    param486 = True
    param487 = True
    param488 = True
    param489 = True
    param490 = True
    param491 = True
    param492 = True
    param493 = True
    param494 = True
    param495 = True
    param496 = True
    param497 = True
    param498 = True
    param499 = True
    param500 = True

    def init(self):
        close = pd.Series(self.data.Close)
        atr = self.I(pta.atr, high, low, close, length=self.param1)
        atrMa = self.I(pta.sma, atr, length=self.param4)
        atrRatio = atrMa > 0 and atr / atrMa or 1.0
        adx = self.I(pta.adx, high, low, close, length=self.param5)
        adxThr = self.param6
        regime = atrRatio > 1.4 and 2 or adx < adxThr and atrRatio < 0.9 and 0 or 1
        adaptMult = self.param2
        if self.param7:
            if regime == 2:
                adaptMult = self.param2 * (1.0 + (atrRatio - 1.0) * 0.4)
            elif regime == 0:
                adaptMult = self.param2 * 0.85
        adaptMult = max(min(adaptMult, self.param2 * 2.0), self.param2 * 0.5)
        upperBase = self.param8 + adaptMult * atr
        lowerBase = self.param8 - adaptMult * atr
        prevBand = self.I(lambda: self.I(pta.supertrend, high, low, close, length=self.param1, multiplier=adaptMult) or pd.Series(0.0, index=close.index))[-1]
        stBand = self.I(lambda: np.maximum(lowerBase, prevBand) if prevBand < close else np.maximum(upperBase, prevBand) if prevBand > close else prevBand) if prevBand < close else np.maximum(upperBase, prevBand) if prevBand > close else prevBand
        trendMa = self.I(pta.ema, close, length=self.param8)
        trendUp = close > trendMa
        trendDn = close < trendMa
        volMa = self.I(pta.sma, volume, length=self.param9)
        self.stBand = stBand
        self.trendMa = trendMa
        self.trendUp = trendUp
        self.trendDn = trendDn
        self.volMa = volMa

    def next(self):
        atr = self.I(pta.atr, high, low, close, length=self.param1)
        atrMa = self.I(pta.sma, atr, length=self.param4)
        atrRatio = atrMa > 0 and atr / atrMa or 1.0
        adx = self.I(pta.adx, high, low, close, length=self.param5)
        adxThr = self.param6
        regime = atrRatio > 1.4 and 2 or adx < adxThr and atrRatio < 0.9 and 0 or 1
        adaptMult = self.param2
        if self.param7:
            if regime == 2:
                adaptMult = self.param2 * (1.0 + (atrRatio - 1.0) * 0.4)
            elif regime == 0:
                adaptMult = self.param2 * 0.85
        adaptMult = max(min(adaptMult, self.param2 * 2.0), self.param2 * 0.5)
        upperBase = self.param8 + adaptMult * atr
        lowerBase = self.param8 - adaptMult * atr
        prevBand = self.I(lambda: self.I(pta.supertrend, high, low, close, length=self.param1, multiplier=adaptMult) or pd.Series(0.0, index=close.index))[-1]