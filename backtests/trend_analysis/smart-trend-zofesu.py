"""
DS-TV Backtest Results: smart-trend-zofesu
============================================================

--- SPY ---
  ERROR: Indicators must return (optionally a tuple of) numpy.arrays of same length as `data` (data shape: (502,); indicator "atr(H,L,30)" shape: , returned value: None)

--- BTC ---
  ERROR: Indicators must return (optionally a tuple of) numpy.arrays of same length as `data` (data shape: (732,); indicator "atr(H,L,30)" shape: , returned value: None)

--- QQQ ---
  ERROR: Indicators must return (optionally a tuple of) numpy.arrays of same length as `data` (data shape: (502,); indicator "atr(H,L,30)" shape: , returned value: None)

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script â€” smart-trend-zofesu
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover


class TvStrategy(Strategy):
    atr_length = 30
    multiplier = 1.8
    filter_len = 200
    vol_pct_target = 80

    def init(self):
        close = pd.Series(self.data.Close)
        atr = self.I(pta.atr, high=self.data.High, low=self.data.Low, close=close, length=self.atr_length)
        v_rank = self.I(pta.percentrank, volume=self.data.Volume, length=200)
        main_trend_ma = self.I(pta.hma, close=close, length=self.filter_len)
        self.trend_line = self.I(lambda: pd.Series([np.nan]), index=close.index)
        self.trend_dir = 1
        self.upper_band = self.I(lambda: pd.Series([np.nan]), index=close.index)
        self.lower_band = self.I(lambda: pd.Series([np.nan]), index=close.index)
        self.vol_confirmed = self.I(lambda: pd.Series([False]), index=close.index)

    def next(self):
        close = self.data.Close[-1]
        atr = self.I(pta.atr, high=self.data.High, low=self.data.Low, close=self.data.Close, length=self.atr_length)
        v_rank = self.I(pta.percentrank, volume=self.data.Volume, length=200)
        main_trend_ma = self.I(pta.hma, close=self.data.Close, length=self.filter_len)
        vol_confirmed = not self.use_vol or v_rank[-1] > self.vol_pct_target

        if pd.isna(self.trend_line[-1]):
            self.trend_line[-1] = self.data.High[-1] - (atr[-1] * self.multiplier)

        if self.trend_dir == 1:
            if close < self.trend_line[-1] and vol_confirmed:
                self.trend_dir = -1
                self.trend_line[-1] = self.data.Low[-1] + (atr[-1] * self.multiplier)
            else:
                self.trend_line[-1] = max(self.trend_line[-1], self.data.High[-1] - (atr[-1] * self.multiplier))
        else:
            if close > self.trend_line[-1] and vol_confirmed:
                self.trend_dir = 1
                self.trend_line[-1] = self.data.High[-1] - (atr[-1] * self.multiplier)
            else:
                self.trend_line[-1] = min(self.trend_line[-1], self.data.Low[-1] + (atr[-1] * self.multiplier))

        if self.trend_dir == 1:
            if self.trend_dir[-1] == -1 and (not self.use_filter or main_trend_ma[-1] > close):
                self.buy()
            elif self.trend_dir[-1] == 1 and main_trend_ma[-1] > close:
                self.sell()
        else:
            if self.trend_dir[-1] == 1 and (not self.use_filter or main_trend_ma[-1] < close):
                self.sell()
            elif self.trend_dir[-1] == -1 and main_trend_ma[-1] < close:
                self.buy()