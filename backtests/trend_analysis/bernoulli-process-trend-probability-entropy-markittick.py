"""
DS-TV Backtest Results: bernoulli-process-trend-probability-entropy-markittick
============================================================

--- SPY ---
  ERROR: Indicator "calc_entr…(calc_p_hat)" error. See traceback above.

--- BTC ---
  ERROR: Indicator "calc_entr…(calc_p_hat)" error. See traceback above.

--- QQQ ---
  ERROR: Indicator "calc_entr…(calc_p_hat)" error. See traceback above.

============================================================
Unoptimized run. No parameter tuning applied.

Source: TradingView Community Script — bernoulli-process-trend-probability-entropy-markittick
Generated by DeepStack TradingView Pipeline
"""

import numpy as np
import pandas as pd
import pandas_ta as pta
from backtesting import Backtest, Strategy
from backtesting.lib import crossover


class TvStrategy(Strategy):
    # Bernoulli Process parameters
    mode = "Price Action (Close > Open)"  # Options: "Price Action (Close > Open)", "Momentum (RSI > 50)", "Trend (Close > MA)"
    length = 20
    risk_reward = 2.0
    stop_atr = 1.5

    def init(self):
        close = pd.Series(self.data.Close)
        open_ = pd.Series(self.data.Open)
        high = pd.Series(self.data.High)
        low = pd.Series(self.data.Low)
        
        # Calculate trial outcome based on mode
        if self.mode == "Price Action (Close > Open)":
            trial_outcome = (close > open_).astype(float)
        elif self.mode == "Momentum (RSI > 50)":
            rsi = self.I(pta.rsi, close, length=14)
            trial_outcome = (rsi > 50).astype(float)
        else:  # Trend (Close > MA)
            sma = self.I(pta.sma, close, length=self.length)
            trial_outcome = (close > sma).astype(float)
        
        # Calculate Bernoulli probability
        def calc_p_hat(outcome_series):
            rolling_sum = outcome_series.rolling(window=self.length).sum()
            return rolling_sum / self.length
        
        self.p_hat = self.I(calc_p_hat, trial_outcome)
        
        # Calculate entropy
        def calc_entropy_series(p_series):
            def entropy_func(p):
                if p <= 0.0 or p >= 1.0:
                    return 0.0
                return -1.0 * (p * (np.log(p) / np.log(2)) + (1.0 - p) * (np.log(1.0 - p) / np.log(2)))
            
            return p_series.apply(entropy_func)
        
        self.entropy = self.I(calc_entropy_series, self.p_hat)
        
        # Calculate ATR for stop loss
        self.atr = self.I(pta.atr, high, low, close, length=14)

    def next(self):
        # Generate signals based on Bernoulli probability crossover
        p_hat_current = self.p_hat[-1]
        entropy_current = self.entropy[-1]
        
        # Check for crossover conditions
        signal_long = (len(self.p_hat) > 1 and 
                      self.p_hat[-2] <= 0.5 and 
                      self.p_hat[-1] > 0.5 and 
                      entropy_current < 0.95)
        
        signal_short = (len(self.p_hat) > 1 and 
                       self.p_hat[-2] >= 0.5 and 
                       self.p_hat[-1] < 0.5 and 
                       entropy_current < 0.95)
        
        # Calculate stop loss and take profit levels
        if self.atr[-1] is not None:
            atr_val = self.atr[-1]
            entry_price = self.data.Close[-1]
            
            if signal_long:
                sl_long = entry_price - (atr_val * self.stop_atr)
                tp_long = entry_price + ((entry_price - sl_long) * self.risk_reward)
                
                if not self.position:
                    self.buy()
            
            elif signal_short:
                sl_short = entry_price + (atr_val * self.stop_atr)
                tp_short = entry_price - ((sl_short - entry_price) * self.risk_reward)
                
                if self.position:
                    self.position.close()
        
        # Exit logic: close position if entropy is too high
        if self.position and entropy_current > 0.95:
            self.position.close()


if __name__ == "__main__":
    # Example backtest on SPY data
    import yfinance as yf
    
    data = yf.download("SPY", start="2020-01-01", end="2023-12-31", interval="1d")
    
    bt = Backtest(data, TvStrategy, cash=10000, commission=0.001)
    stats = bt.run()
    print(stats)
    bt.plot()