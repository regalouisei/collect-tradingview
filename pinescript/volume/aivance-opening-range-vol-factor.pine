//@version=6
indicator("Aivance Opening Range & Vol Factor", overlay = true, max_boxes_count = 500, max_lines_count = 500, max_labels_count = 500)

// --- INPUTS ---
grp_color   = "Colors"
colorLong   = input.color(color.new(#29b6f6, 80), "Color Long (Light Blue)", group=grp_color)
colorShort  = input.color(color.new(#ffb74d, 80), "Color Short (Orange)", group=grp_color)
lineColor   = input.color(color.new(color.gray, 50), "Line Color", group=grp_color)

grp_vol     = "Volume Factor Settings"
showVol     = input.bool(true, "Show Volume Factor?", group=grp_vol)
textColor   = input.color(color.white, "Text Color", group=grp_vol)
textSize    = input.string(size.normal, "Text Size", options=[size.small, size.normal, size.large], group=grp_vol)

grp_logic   = "Logic"
usePullback = input.bool(false, "Show only on Pullback?", group=grp_logic, tooltip="Draws the range only if the candle directly AFTER the trigger candle closes in the opposite direction.")

// --- TIMEFRAME-SPECIFIC VOLUME LOGIC (T-1) ---
isTriggerBar = ta.change(time("D")) != 0

// Variables to track the sum of volume for the current and previous sessions
var float currentSessionVolSum = 0.0
var float lastSessionTotalVol  = 0.0

if isTriggerBar
    // On the first bar of a new day, the accumulated sum becomes our T-1 reference
    lastSessionTotalVol := currentSessionVolSum
    // Reset the accumulator for the new session starting now
    currentSessionVolSum := volume
else
    // Add current candle volume to the session total
    currentSessionVolSum += volume

// --- CALCULATION ---
// We calculate the Volume Factor as: (Current Candle Volume / Total Volume of all candles in T-1) * 100
// This works for any timeframe (10m, 1h, 4h, etc.) because it sums the actual bars present on the chart.
currentVolFactor = (lastSessionTotalVol > 0) ? (volume / lastSessionTotalVol) * 100 : 0.0

// --- VARIABLES ---
var box sessionBox = na
var box bodyBox = na
var line l_high = na
var line l_low = na
var line l_open = na
var line l_close = na
var label volLabel = na

// Variables for Pullback Logic
var bool pendingPullback = false
var float p_high = na
var float p_low = na
var float p_open = na
var float p_close = na
var int p_index = na
var color p_color = na
var float p_volFactor = na

// Helper function for the label
drawVolLabel(idx, y, factor) =>
    txt = "Vol-Factor: " + str.tostring(factor, "#.##") + "%"
    label.new(x=idx, y=y, text=txt, xloc=xloc.bar_index, yloc=yloc.abovebar, color=color.new(color.white, 100), style=label.style_label_down, textcolor=textColor, size=textSize)

// --- MAIN LOGIC ---
if isTriggerBar
    sessionBox := na
    bodyBox := na
    l_high := na
    l_low := na
    l_open := na
    l_close := na
    volLabel := na 
    
    if usePullback
        pendingPullback := true
        p_high := high
        p_low := low
        p_open := open
        p_close := close
        p_index := bar_index
        p_color := close >= open ? colorLong : colorShort
        p_volFactor := currentVolFactor
    else
        sessionColor = close >= open ? colorLong : colorShort
        sessionBox := box.new(left = bar_index, top = high, right = bar_index + 1, bottom = low, border_color = na, bgcolor = sessionColor)
        bodyBox := box.new(left = bar_index, top = math.max(open, close), right = bar_index + 1, bottom = math.min(open, close), border_color = na, bgcolor = sessionColor)
        l_high := line.new(bar_index, high, bar_index + 1, high, color = lineColor)
        l_low := line.new(bar_index, low, bar_index + 1, low, color = lineColor)
        l_open := line.new(bar_index, open, bar_index + 1, open, color = sessionColor, style = line.style_dashed)
        l_close := line.new(bar_index, close, bar_index + 1, close, color = sessionColor, style = line.style_dashed)
        
        if showVol and lastSessionTotalVol > 0
            volLabel := drawVolLabel(bar_index, high, currentVolFactor)

else if pendingPullback
    if bar_index == p_index + 1
        triggerIsLong = p_close >= p_open
        currentIsLong = close >= open
        if triggerIsLong != currentIsLong
            sessionBox := box.new(left = p_index, top = p_high, right = bar_index + 1, bottom = p_low, border_color = na, bgcolor = p_color)
            bodyBox := box.new(left = p_index, top = math.max(p_open, p_close), right = bar_index + 1, bottom = math.min(p_open, p_close), border_color = na, bgcolor = p_color)
            l_high := line.new(p_index, p_high, bar_index + 1, p_high, color = lineColor)
            l_low := line.new(p_index, p_low, bar_index + 1, p_low, color = lineColor)
            l_open := line.new(p_index, p_open, bar_index + 1, p_open, color = p_color, style = line.style_dashed)
            l_close := line.new(p_index, p_close, bar_index + 1, p_close, color = p_color, style = line.style_dashed)
            if showVol and lastSessionTotalVol > 0
                volLabel := drawVolLabel(p_index, p_high, p_volFactor)
    pendingPullback := false

else if not na(sessionBox)
    extRight = bar_index + 1
    box.set_right(sessionBox, extRight)
    box.set_right(bodyBox, extRight)
    line.set_x2(l_high, extRight)
    line.set_x2(l_low, extRight)
    line.set_x2(l_open, extRight)
    line.set_x2(l_close, extRight)
