//@version=5
indicator("VWAP Trader NXi", overlay=true)

// --- Inputs ---
src = input.source(hlc3, title="Price Source") 
dev1Mult = input.float(2.0, title="Stdev 1 (Value Area)", step=0.1)
dev2Mult = input.float(3.0, title="Stdev 2 (Extension)", step=0.1)

showDv2 = input.bool(true, title="Show Extension Zone?")
showPrevVWAP = input.bool(true, title="Show Previous Day VWAP")

// --- Calculations ---
isNewSession = ta.change(time("D"))

var float vwapSum = 0.0
var float volumeSum = 0.0
var float v2Sum = 0.0

if isNewSession
    vwapSum := src * volume
    volumeSum := volume
    v2Sum := volume * math.pow(src, 2)
else
    vwapSum += src * volume
    volumeSum += volume
    v2Sum += volume * math.pow(src, 2)

myVwap = vwapSum / volumeSum
dev = math.sqrt(math.max(v2Sum / volumeSum - math.pow(myVwap, 2), 0))

// Band Levels
upper1 = myVwap + dev1Mult * dev
lower1 = myVwap - dev1Mult * dev
upper2 = myVwap + dev2Mult * dev
lower2 = myVwap - dev2Mult * dev

// --- Plotting ---
plot(myVwap, title="VWAP", color=color.new(#00bcd4, 0), linewidth=2)

U1 = plot(upper1, title="Upper Band 1", color=color.new(color.red, 30))
D1 = plot(lower1, title="Lower Band 1", color=color.new(color.green, 30))

U2 = plot(showDv2 ? upper2 : na, title="Upper Band 2", color=color.new(color.maroon, 50))
D2 = plot(showDv2 ? lower2 : na, title="Lower Band 2", color=color.new(color.teal, 50))

var float prevVwap = na
if isNewSession
    prevVwap := myVwap[1]
plot(showPrevVWAP ? prevVwap : na, style=plot.style_circles, color=color.gray, title="Previous Day VWAP")

fill(U1, U2, color=color.new(color.red, 85), title="Bearish Extension Zone")
fill(D1, D2, color=color.new(color.green, 85), title="Bullish Extension Zone")

// --- Alert Logic (Mean Reversion / Re-entry) ---

// 1. Price crosses back INSIDE Stdev 1
// (Crossunder upper band OR Crossover lower band)
reEntryStdev1 = ta.crossunder(close, upper1) or ta.crossover(close, lower1)

// 2. Price crosses back INSIDE Stdev 2
reEntryStdev2 = ta.crossunder(close, upper2) or ta.crossover(close, lower2)

// Define Alert Conditions
alertcondition(reEntryStdev1, title="Mean Reversion Stdev 1", message="Price broke out and closed back inside Stdev 1! Target: VWAP.")
alertcondition(reEntryStdev2, title="Mean Reversion Stdev 2", message="Price broke out and closed back inside Stdev 2! Extreme extension reversal.")

// Optional: Visual shapes on chart when re-entry happens
plotshape(reEntryStdev1, title="Re-entry Label", style=shape.xcross, location=location.abovebar, color=color.yellow, size=size.small)
