//@version=6
indicator(
    "Volume Candle Coloring v5 (BARCOLOR STABLE)",
    overlay = true
)

// ======================================================
// PARAMÈTRES
// ======================================================
volLength = input.int(20, "Période moyenne volume")

lowMult   = input.float(0.7, "Volume faible")
midMult   = input.float(1.5, "Volume fort")
highMult  = input.float(2.5, "Volume extrême")
ultraMult = input.float(4.0, "Volume ULTRA")

// ======================================================
// CALCULS
// ======================================================
volMA = ta.sma(volume, volLength)

// États de volume
volLow     = volume < volMA * lowMult
volNormal  = volume >= volMA * lowMult  and volume < volMA * midMult
volHigh    = volume >= volMA * midMult  and volume < volMA * highMult
volExtreme = volume >= volMA * highMult and volume < volMA * ultraMult
volUltra   = volume >= volMA * ultraMult

// Direction de la bougie
bull = close >= open
bear = close < open

// ======================================================
// COULEURS (ORDRE STABLE – STYLE TV)
// ======================================================

// Haussier
bullUltra    = color.aqua
bullExtreme  = color.lime
bullHigh     = color.green
bullNormal   = color.new(color.green, 40)
bullLow      = color.new(color.green, 70)

// Baissier
bearUltra    = color.fuchsia
bearExtreme  = color.orange
bearHigh     = color.red
bearNormal   = color.new(color.red, 40)
bearLow      = color.new(color.red, 70)

// Neutre
neutralCol   = color.gray

// ======================================================
// SÉLECTION DE LA COULEUR
// ======================================================
barCol =
     bull and volUltra   ? bullUltra :
     bull and volExtreme ? bullExtreme :
     bull and volHigh    ? bullHigh :
     bull and volNormal  ? bullNormal :
     bull and volLow     ? bullLow :
     bear and volUltra   ? bearUltra :
     bear and volExtreme ? bearExtreme :
     bear and volHigh    ? bearHigh :
     bear and volNormal  ? bearNormal :
     bear and volLow     ? bearLow :
     neutralCol

// ======================================================
// APPLICATION (STABLE, SANS DÉCALAGE)
// ======================================================
barcolor(barCol)

// ======================================================
// PLOT INVISIBLE (OBLIGATOIRE EN PINE v6)
// ======================================================
plot(volume, display = display.none)
