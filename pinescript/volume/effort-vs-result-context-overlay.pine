//@version=6
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  Effort vs Result Context Overlay (Tier-2)
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//
//  DESCRIPTION
//  --------------------------------------------------------------------
//  Effort vs Result Context Overlay is a Tier-2, non-directional
//  market efficiency engine designed for intraday traders.
//
//  This indicator does NOT generate buy or sell signals.
//
//  It highlights moments when market EFFORT (volume + volatility)
//  fails to produce proportional RESULT (net progress + follow-through).
//
//  This standalone version displays ONLY strong inefficiency events
//  (Efficiency Failure) to keep visuals clean and decisive.
//
//  OUTPUT
//  --------------------------------------------------------------------
//  â€¢ Red dot on price bar â†’ Efficiency FAILURE (absorption / exhaustion)
//
//  DISCLAIMER
//  --------------------------------------------------------------------
//  Educational and analytical use only. Not financial advice.
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

indicator(
    "Effort vs Result Context Overlay",
    shorttitle="EVR-T2",
    overlay=true,
    max_bars_back=5000
)

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// USER INPUTS
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

// Effort
volLen = input.int(20, "Volume Median Length", minval=10, maxval=50)
atrLen = input.int(14, "ATR Length", minval=5, maxval=50)

// Result
progressLen = input.int(10, "Net Progress Lookback", minval=5, maxval=30)
stallBars   = input.int(3,  "Follow-Through Stall Bars", minval=1, maxval=10)

// Thresholds
effortHighThresh = input.float(1.5, "High Effort Threshold", step=0.1)
weakResultThresh = input.float(0.35, "Weak Result Threshold", step=0.05)

// Visuals
showFailureDots = input.bool(true, "Show Efficiency Failure Dots")
showBG          = input.bool(true, "Show Efficiency Background")
showLabel       = input.bool(true, "Show Status Label")

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// PHASE 1 â€” EFFORT ENGINE
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

// Relative volume
volMedian = ta.sma(volume, volLen)
relVolume = volMedian > 0 ? volume / volMedian : 0.0

// Relative volatility
tr  = ta.tr(true)
atr = ta.atr(atrLen)
relTR = atr > 0 ? tr / atr : 0.0

// Composite effort
effortScore = (relVolume + relTR) / 2.0
effortHigh  = effortScore >= effortHighThresh

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// PHASE 2 â€” RESULT ENGINE
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

// Net progress
netProgress = math.abs(close - close[progressLen])

// Gross movement
grossMove = 0.0
for i = 0 to progressLen - 1
    grossMove += math.abs(close[i] - close[i + 1])

progressEfficiency = grossMove > 0 ? netProgress / grossMove : 0.0
resultWeak = progressEfficiency <= weakResultThresh

// Follow-through validation
followThrough = (
    math.abs(close - close[1]) >
    math.abs(close[stallBars] - close[stallBars + 1])
)

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// PHASE 3 â€” INEFFICIENCY ENGINE
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

// State encoding:
//  1 = OK | -1 = FAILURE
var int efficiencyState = 1

efficiencyFailure = (
    effortHigh and
    resultWeak and
    not followThrough
)

if efficiencyFailure
    efficiencyState := -1
else
    efficiencyState := 1

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// STATE-LOCKING (ANTI-SPAM)
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
var int prevEfficiencyState = na
stateChanged = efficiencyState != prevEfficiencyState
prevEfficiencyState := efficiencyState

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// EXPORTABLE STATE
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
efficiency_FAILURE = efficiencyState == -1

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// VISUALS â€” STRONG & CLEAN ONLY
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

// Optional background
bgcolor(showBG and efficiencyState == -1 ? color.new(color.red, 94) : na)

// ğŸ”´ Red dot EXACTLY ON PRICE (using plot, not plotshape)
plot(
    showFailureDots and stateChanged and efficiencyState == -1 ? close : na,
    title="Efficiency Failure",
    style=plot.style_circles,
    linewidth=4,
    color=color.red
)

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// STATUS LABEL (LAST BAR)
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
if showLabel and barstate.islast
    label.new(
        bar_index,
        high,
        efficiencyState == -1 ? "EFFICIENCY: FAILURE" : "EFFICIENCY: OK",
        style=label.style_label_down,
        textcolor=color.white,
        color=efficiencyState == -1 ? color.new(color.red, 25)
                                    : color.new(color.green, 25)
    )
