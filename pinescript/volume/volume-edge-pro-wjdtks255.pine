// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © wjdtks255

//@version=5
indicator("Volume Edge Pro [wjdtks255]", shorttitle="VEP_Pro", overlay=false)

// --- Inputs ---
lengthMA = input.int(50, title="Volume MA Period")
lookbackDays = input.int(10, title="Pivot Lookback (Days)")

// --- Calculations ---
volMA = ta.sma(volume, lengthMA)
isUpDay = close > close[1]
isDownDay = close < close[1]

// 1. Bullish Pocket Pivot (PPV): Blue
// Up-day volume > max down-day volume of the last 10 days
float maxDownVol = 0.0
for i = 1 to lookbackDays
    if close[i] < close[i+1]
        maxDownVol := math.max(maxDownVol, volume[i])
isPPV = isUpDay and volume > maxDownVol

// 2. Bearish Pivot (BPV): Purple (Added for Short Whales)
// Down-day volume > max up-day volume of the last 10 days
float maxUpVol = 0.0
for i = 1 to lookbackDays
    if close[i] > close[i+1]
        maxUpVol := math.max(maxUpVol, volume[i])
isBPV = isDownDay and volume > maxUpVol

// 3. Regular Significant Volumes
isRRV = isDownDay and volume > volMA and not isBPV // High Volume Selling
isRGV = isUpDay and volume > volMA and not isPPV  // High Volume Buying

// --- Color Logic ---
// Blue: Bull Whale / Purple: Bear Whale / Green: Strong Buy / Red: Strong Sell / Gray: Normal
volColor = isPPV ? #0081ff : isBPV ? #9c27b0 : isRGV ? #26a69a : isRRV ? #ef5350 : #b2b5be

// --- Plotting ---
plot(volume, title="Volume Bar", style=plot.style_columns, color=volColor)
plot(volMA, title="Volume MA", color=color.new(color.gray, 50))

// Signal Shapes
plotshape(isPPV, title="Bull Pivot", location=location.top, color=color.blue, style=shape.triangleup, size=size.tiny)
plotshape(isBPV, title="Bear Pivot", location=location.top, color=color.purple, style=shape.triangledown, size=size.tiny)
