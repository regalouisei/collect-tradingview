//@version=5
indicator("Volume Elite", overlay=true)

// --- הגדרות ---
volAvgLen = input.int(20, "Volume EMA Length", group="Volume Settings")
rsiLen    = input.int(14, "RSI Length", group="RSI Settings")
rsiOB     = input.int(70, "RSI Overbought (Red BG)", group="RSI Settings")
rsiGold   = input.int(55, "RSI Gold Zone (Green BG)", group="RSI Settings")
rsiOS     = input.int(30, "RSI Oversold (Blue BG)", group="RSI Settings")

// --- פילטר Timeframe ---
// פועל רק מעל 30 דקות למניעת רעש
isSupportedTF = timeframe.isdaily or timeframe.isweekly or (timeframe.isintraday and timeframe.multiplier >= 30)

// --- חישובים ---
volAvg   = ta.ema(volume, volAvgLen)
volRatio = volume / volAvg 
rsiVal   = ta.rsi(close, rsiLen)
isUp     = close > open

// --- לוגיקת מלכודת משופרת (Liquidity Grab) ---
// פטיש או פטיש הפוך עם ווליום גבוה ואסימטריה של פתילים
bodySize  = math.abs(close - open)
upperWick = high - math.max(open, close)
lowerWick = math.min(open, close) - low

// מלכודת לונג: פתיל עליון ארוך פי 2.5 מהגוף ופי 2 מהפתיל התחתון
longTrap = upperWick > bodySize * 2.5 and upperWick > lowerWick * 2 and volRatio > 1.2
// מלכודת שורט: פתיל תחתון ארוך פי 2.5 מהגוף ופי 2 מהפתיל העליון
shortTrap = lowerWick > bodySize * 2.5 and lowerWick > upperWick * 2 and volRatio > 1.2

isTrap = longTrap or shortTrap

// --- פלטת צבעי נרות (5 גוונים + סגול מלכודת) ---
color candleColor = na
if isSupportedTF
    if isTrap
        candleColor := #bb00ff // סגול זוהר למלכודות
    else if isUp
        // ירוק: מזרחני (חזק) עד כמעט שחור (חלש)
        candleColor := volRatio > 1.6 ? #00ff00 : volRatio > 1.2 ? #32cd32 : volRatio > 0.8 ? #228b22 : volRatio > 0.4 ? #004d00 : #0b1a0b
    else
        // אדום: מבוהק (חזק) עד כמעט שחור (חלש)
        candleColor := volRatio > 1.6 ? #ff0000 : volRatio > 1.2 ? #dc143c : volRatio > 0.8 ? #b22222 : volRatio > 0.4 ? #8b0000 : #1a0b0b

// צביעת גוף הנר, המסגרת והפתיל
barcolor(isSupportedTF ? candleColor : na)

// --- צביעת רקע (RSI) ---
var color bgCol = na
if isSupportedTF
    if rsiVal > rsiOB
        bgCol := color.new(color.red, 88)    // סכנה: קניית יתר
    else if rsiVal >= rsiGold and rsiVal <= 65 
        bgCol := color.new(color.green, 88)  // מומנטום: טווח הזהב
    else if rsiVal < rsiOS
        bgCol := color.new(color.blue, 88)   // הזדמנות: מכירת יתר
    else
        bgCol := na
else
    bgCol := na

bgcolor(bgCol)
