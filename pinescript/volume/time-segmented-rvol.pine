//@version=5
indicator("Time-Segmented RVOL [Coherent Tiers]", shorttitle="RVOL-Time", overlay=false, precision=2)

// --- Inputs ---
lookbackDays   = input.int(20, "Lookback (Days)", minval=1)
midThreshold   = input.float(1.5, "Green (Building) Threshold")
highThreshold  = input.float(3.0, "Yellow (High) Threshold")
superThreshold = input.float(5.0, "Pink (Super) Threshold")

// Color Inputs - Updated to your Coherent Logic
colorCold   = input.color(color.new(#2196f3, 30), "Below 1.0 (Blue)")
colorNormal = input.color(color.new(#00e676, 30), "Normal/Building (Green)")
colorHigh   = input.color(color.new(#ffd740, 30), "High/Caution (Yellow)")
colorSuper  = input.color(color.new(#ff00ff, 10), "Super High (Pink)")

// --- Logic: Historical Time-Slot Averaging ---
var volHistory = array.new_float(1440 * lookbackDays, 0.0)
int minuteIdx  = hour * 60 + minute

float sumVol = 0.0
int count = 0
for i = 0 to lookbackDays - 1
    float histVal = array.get(volHistory, (minuteIdx * lookbackDays) + i)
    if histVal > 0
        sumVol += histVal
        count += 1

float historicalAvg = count > 0 ? sumVol / count : 0.0
float rvol = historicalAvg > 0 ? volume / historicalAvg : 1.0

// Update History
int storageOffset = (minuteIdx * lookbackDays) + (bar_index % lookbackDays)
array.set(volHistory, storageOffset, volume)

// --- Coherent Color Logic ---
color rvolColor = rvol >= superThreshold ? colorSuper  : 
                  rvol >= highThreshold  ? colorHigh   : 
                  rvol >= 1.0            ? colorNormal : 
                  colorCold

// --- Plotting ---
plot(rvol, style=plot.style_columns, color=rvolColor, title="RVOL Bars", linewidth=2)
hline(1.0, "Baseline", color=color.new(color.gray, 50), linestyle=hline.style_dotted)

// Dashboard
var table rvolTable = table.new(position.top_right, 1, 1)
if barstate.islast
    table.cell(rvolTable, 0, 0, "RVOL: " + str.tostring(rvol, "#.##"), bgcolor=rvolColor, text_color=color.black)
