//@version=6
indicator(title="VWAP Enhanced (Visual Feedback)", shorttitle="VWAP+ UI", overlay=true)

// --- INPUTS ---
anchorMode = input.string("Session", "Anchor Type", options=["Session", "Week", "Month", "Year", "YTD", "Half Year", "Manual Date"], group="Selection")
manualTime = input.time(timestamp("2025-01-01 00:00"), "Manual Anchor Date", group="Selection", tooltip="Used if 'Manual Date' is selected")

src = input(hlc3, "Source", group="Calculation")
showBands = input.bool(true, "Show Bands", group="Visuals")
mult = input.float(2.0, "Band Multiplier", step=0.5, group="Visuals")

// --- RESET LOGIC ---
isManualReset = anchorMode == "Manual Date" and time >= manualTime and time[1] < manualTime

isNewPeriod = switch anchorMode
    "Session"   => timeframe.change("D")
    "Week"      => timeframe.change("W")
    "Month"     => timeframe.change("M")
    "Year"      => timeframe.change("12M")
    "YTD"       => timeframe.change("12M")
    "Half Year" => timeframe.change("6M")
    "Manual Date" => isManualReset
    => false

// --- VWAP CALCULATION ---
var float sumSrcVol = 0.0
var float sumVol = 0.0

if isNewPeriod
    sumSrcVol := src * volume
    sumVol    := volume
else
    sumSrcVol += src * volume
    sumVol    += volume

vwapValue = sumSrcVol / sumVol

// --- VISUAL UI ELEMENTS ---

// 1. Plot the VWAP
plotColor = (anchorMode == "Manual Date" and time < manualTime) ? color.new(color.blue, 100) : color.blue
plot(vwapValue, "VWAP Line", color=plotColor, linewidth=2, style=plot.style_linebr)

// 2. Highlighting the Manual Anchor Point
if isManualReset
    label.new(bar_index, high, "ANCHOR START", color=color.blue, textcolor=color.white, style=label.style_label_down)
    line.new(bar_index, low, bar_index, high, xloc=xloc.bar_index, extend=extend.both, color=color.new(color.blue, 50), style=line.style_dotted)

// 3. Status Label (On the right)
var label statusLabel = label.new(bar_index, close, "", xloc=xloc.bar_index, color=color.new(color.black, 20), textcolor=color.white, style=label.style_label_left, size=size.normal)
if barstate.islast
    label.set_xy(statusLabel, bar_index + 5, close)
    label.set_text(statusLabel, "Current VWAP Anchor: " + anchorMode + (anchorMode == "Manual Date" ? "\nDate: " + str.format("{0,date,yyyy-MM-dd}", manualTime) : ""))

// --- BANDS ---
stdev = ta.stdev(src, 30) // Approximation for visual bands
plot(showBands ? vwapValue + (stdev * mult) : na, "Upper Band", color=color.new(color.green, 50))
plot(showBands ? vwapValue - (stdev * mult) : na, "Lower Band", color=color.new(color.green, 50))
