//@version=5
indicator("Объём 24/12/4/1ч + NATR + Тренды", overlay=true)

// Входные параметры
natrLength = input.int(14, "Период NATR", minval=1)
natrSmooth = input.int(14, "Сглаживание NATR", minval=1)

// Настройки отображения
showVolume = input.bool(true, "Показать объёмы")
showNATR = input.bool(true, "Показать NATR")

// Цвета для объёмов
color24h = input.color(color.new(color.blue, 0), "24ч объём")
color12h = input.color(color.new(color.orange, 0), "12ч объём")
color4h  = input.color(color.new(color.green, 0), "4ч объём")
color1h  = input.color(color.new(color.purple, 0), "1ч объём")
colorNATR = input.color(color.new(color.red, 0), "NATR")

// Получение текущего таймфрейма в минутах
currentTF = timeframe.in_seconds() / 60

// Функция для расчёта объёма за период в $
getVolumeForPeriod(hours) =>
    bars = math.floor((hours * 60) / currentTF)
    volumeSum = 0.0
    if bars > 0
        for i = 0 to bars - 1
            volumeSum := volumeSum + (volume[i] * close[i])
    volumeSum

// Функция для определения символа и цвета стрелки
getTrendInfo(currentVol, previousVol) =>
    isUp = currentVol > previousVol
    str = isUp ? " ▲" : " ▼"
    clr = isUp ? color.lime : color.red
    [str, clr]

// Расчёт объёмов в $ (текущие значения)
v24 = getVolumeForPeriod(24)
v12 = getVolumeForPeriod(12)
v4  = getVolumeForPeriod(4)
v1  = getVolumeForPeriod(1)

// Расчёт объёмов на предыдущем баре для определения тренда
v24_p = v24[1]
v12_p = v12[1]
v4_p  = v4[1]
v1_p  = v1[1]

// Получаем данные о стрелках
[s24, c24] = getTrendInfo(v24, v24_p)
[s12, c12] = getTrendInfo(v12, v12_p)
[s4,  c4]  = getTrendInfo(v4,  v4_p)
[s1,  c1]  = getTrendInfo(v1,  v1_p)

// Расчёт NATR
atr = ta.atr(natrLength)
natr = (atr / close) * 100
natrSmoothed = ta.sma(natr, natrSmooth)

// Информационная таблица
var table infoTable = table.new(position.bottom_right, 2, 6, border_width=1)

if barstate.islast and showVolume
    table.cell(infoTable, 0, 0, "Период", text_color=color.white, bgcolor=color.gray)
    table.cell(infoTable, 1, 0, "Объём ($)", text_color=color.white, bgcolor=color.gray)
    
    // 24 часа
    table.cell(infoTable, 0, 1, "24ч" + s24, text_color=c24, bgcolor=color24h)
    table.cell(infoTable, 1, 1, "$" + str.tostring(v24, format.volume), text_color=color.white, bgcolor=color.new(color24h, 70))
    
    // 12 часов
    table.cell(infoTable, 0, 2, "12ч" + s12, text_color=c12, bgcolor=color12h)
    table.cell(infoTable, 1, 2, "$" + str.tostring(v12, format.volume), text_color=color.white, bgcolor=color.new(color12h, 70))
    
    // 4 часа
    table.cell(infoTable, 0, 3, "4ч" + s4, text_color=c4, bgcolor=color4h)
    table.cell(infoTable, 1, 3, "$" + str.tostring(v4, format.volume), text_color=color.white, bgcolor=color.new(color4h, 70))
    
    // 1 час
    table.cell(infoTable, 0, 4, "1ч" + s1, text_color=c1, bgcolor=color1h)
    table.cell(infoTable, 1, 4, "$" + str.tostring(v1, format.volume), text_color=color.white, bgcolor=color.new(color1h, 70))

    // NATR
    table.cell(infoTable, 0, 5, "NATR", text_color=color.white, bgcolor=colorNATR)
    table.cell(infoTable, 1, 5, str.tostring(natrSmoothed, "#.##") + "%", text_color=color.white, bgcolor=color.new(colorNATR, 70))
