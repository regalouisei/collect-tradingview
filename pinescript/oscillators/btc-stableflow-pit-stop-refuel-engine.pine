// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Rob_Maths

//@version=6
// -----------------------------------------------------------------------------
// SCRIPT: BTC – StableFlow: Pit-Stop & Refuel Engine | RM
// AUTHOR: Rob_Maths
// LOGIC:  Telemetry-based momentum tracking between Stablecoin supply 
//         and BTC price. 
// -----------------------------------------------------------------------------

indicator("BTC – StableFlow: Pit-Stop & Refuel Engine | RM", shorttitle="StableFlow | RM", overlay=false, precision=2)

// ==========================================
// 1. DATA INPUTS & RACING TELEMETRY
// ==========================================
usdt = request.security("CRYPTOCAP:USDT", "D", close)
usdc = request.security("CRYPTOCAP:USDC", "D", close)
dai  = request.security("CRYPTOCAP:DAI", "D", close)
stable_total = (usdt + usdc + dai) / 1e9 

grp_main = "Pit Wall Calibration"
lookback = input.int(20, "Velocity Lookback", minval=5, group=grp_main, tooltip="Measures the acceleration of fuel (Stables) vs the Engine (BTC).")
smooth   = input.int(5, "Fuel Smoothing", minval=1, group=grp_main, tooltip="EMA smoothing for the histogram.")

grp_signal = "Pit-Stop Logic"
mode_perc  = input.bool(false, "Use % Reversal Mode?", group=grp_signal)
rev_bars   = input.int(2, "Consecutive Bar Threshold", minval=1, group=grp_signal)
perc_thresh = input.float(15.0, "Reversal % Threshold", minval=1.0, group=grp_signal)
perc_window = input.int(25, "Peak Lookback Window", minval=5, group=grp_signal)

// ==========================================
// 2. THE STABLEFLOW ENGINE
// ==========================================
stable_roc = ta.roc(stable_total, lookback)
btc_roc    = ta.roc(close, lookback)
refuel_gap = ta.ema(stable_roc - btc_roc, smooth)

// ==========================================
// 3. SIGNAL & CROSSING LOGIC
// ==========================================
// Zero-Crossing Detection (Lap Transitions)
is_crossing = ta.cross(refuel_gap, 0)

// --- Logic A: Consecutive Bar Counts ---
var int up_rev_count = 0
up_rev_count := (refuel_gap > 0 and refuel_gap < refuel_gap[1]) ? up_rev_count + 1 : 0
var int dn_rev_count = 0
dn_rev_count := (refuel_gap < 0 and refuel_gap > refuel_gap[1]) ? dn_rev_count + 1 : 0

// --- Logic B: Percentage Reversal ---
local_high = ta.highest(refuel_gap, perc_window)
local_low  = ta.lowest(refuel_gap, perc_window)
up_perc_rev = math.abs((refuel_gap - local_high) / local_high) * 100
dn_perc_rev = math.abs((refuel_gap - local_low) / local_low) * 100

// --- Trigger Execution ---
is_buy_pip  = mode_perc ? (refuel_gap > 0 and up_perc_rev >= perc_thresh and up_perc_rev[1] < perc_thresh) : (up_rev_count == rev_bars)
is_sell_pip = mode_perc ? (refuel_gap < 0 and dn_perc_rev >= perc_thresh and dn_perc_rev[1] < perc_thresh) : (dn_rev_count == rev_bars)

// ==========================================
// 4. THE PIT WALL (VISUALS)
// ==========================================
col_fuel    = input.color(#00ffbb, "Fuel (Positive)", group="Visuals")
col_exhaust = input.color(#ff9900, "Exhaust (Negative)", group="Visuals")
col_pip_buy = input.color(#00ccff, "Pit-Stop (Buy)", group="Visuals")
col_pip_sel = input.color(#ff0055, "Exhaust (Sell)", group="Visuals")
col_cross   = input.color(color.new(color.gray, 80), "Lap Transition Line", group="Visuals")

hline(0, "Neutral Line", color.gray, hline.style_dotted)

// Zero-Crossing Background Highlight
bgcolor(is_crossing ? col_cross : na, title="Lap Transition Highlight")

// The Fuel Reservoir (Histogram)
plot(refuel_gap, "Fuel Momentum", color=color.new(refuel_gap > 0 ? col_fuel : col_exhaust, 30), style=plot.style_columns)

// The Pit-Stop Signals (Circles)
plot(is_buy_pip ? 0 : na, "Pit-Stop Pip", color=col_pip_buy, style=plot.style_circles, linewidth=5)
plot(is_sell_pip ? 0 : na, "Exhaust Pip", color=col_pip_sel, style=plot.style_circles, linewidth=5)

// Telemetry Dashboard
var table board = table.new(position.top_right, 2, 3, bgcolor=color.new(color.black, 30), border_width=1, border_color=color.gray)
if barstate.islast
    table.cell(board, 0, 0, "FUEL PRESSURE", text_color=color.white, text_size=size.small)
    table.cell(board, 1, 0, (refuel_gap > 0 ? "+" : "") + str.tostring(refuel_gap, "#.##"), text_color=refuel_gap > 0 ? col_fuel : col_exhaust, text_size=size.small)
    table.cell(board, 0, 1, "STABLES CAP", text_color=color.white, text_size=size.small)
    table.cell(board, 1, 1, str.tostring(stable_total, "#.##") + "B", text_color=color.white, text_size=size.small)
    table.cell(board, 0, 2, "TELEMETRY", text_color=color.white, text_size=size.small)
    table.cell(board, 1, 2, is_buy_pip ? "PIT-STOP" : is_sell_pip ? "EXHAUST" : "ON TRACK", text_color=is_buy_pip ? col_pip_buy : is_sell_pip ? col_pip_sel : color.white, text_size=size.small)
