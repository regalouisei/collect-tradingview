// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © sebastinecc

//@version=5
indicator("Sebastine – All in One Indicator ", overlay=false)

// ───── Inputs ─────
boxp   = input.int(5, "Darvas Lookback", minval=1, maxval=500)
srcOpt = input.string("Volume", "Source",
     options=["Volume","OBV","TSI","Momentum","Volatility","PVT","RSI","Supertrend"])
alertPeriod = input.int(5, "Alert Lookback", minval=1)

// ───── Core Calculations ─────
atrBox = ta.atr(boxp)
var float volSmooth = na
volSmooth := ((boxp - 1) * nz(volSmooth[1]) + atrBox) / boxp

pvt = ta.cum(((close - close[1]) / close[1]) * volume)
obv = ta.cum(close > close[1] ? volume : close < close[1] ? -volume : 0)
rsi = ta.rsi(close, 14)
tsi = ta.tsi(close, 25, 13)
mom = ta.mom(close, boxp)
st  = close + ta.atr(14) * 3

// ───── Source Selector ─────
source = switch srcOpt
    "Volume"      => volume
    "OBV"         => obv
    "TSI"         => tsi
    "Momentum"    => mom
    "Volatility"  => volSmooth
    "PVT"         => pvt
    "RSI"         => rsi
    "Supertrend"  => st
    => volume

// ───── Darvas Box ─────
TopBox    = ta.highest(source, boxp)
BottomBox = ta.lowest(source, boxp)

// ───── Plots ─────
pTop = plot(TopBox,    "Top Box",    color=color.green, linewidth=2, style=plot.style_stepline)
pBot = plot(BottomBox, "Bottom Box", color=color.red,   linewidth=2, style=plot.style_stepline)
fill(pTop, pBot, color=color.new(color.blue, 90))

plot(source, "Selected Source", color=color.white, linewidth=2, style=plot.style_stepline)
plot(source, "Histogram", style=plot.style_columns, color=color.new(color.gray, 75))

hline(0, "Zero Line", color=color.white, linestyle=hline.style_dotted)

// ───── Alerts : Direction & Structure ─────
alertcondition(TopBox > TopBox[1],    "TopBox Up",    "TopBox Rising")
alertcondition(TopBox < TopBox[1],    "TopBox Down",  "TopBox Falling")
alertcondition(BottomBox > BottomBox[1], "BottomBox Up",   "BottomBox Rising")
alertcondition(BottomBox < BottomBox[1], "BottomBox Down", "BottomBox Falling")

alertcondition(source > source[1], "Source Rising", "Source Rising")
alertcondition(source < source[1], "Source Falling", "Source Falling")

alertcondition(ta.crossover(source, 0), "Zero Cross Up", "Source crossed above zero")
alertcondition(ta.crossunder(source,0), "Zero Cross Down", "Source crossed below zero")

// ───── Touch Alerts ─────
alertcondition(source == TopBox,    "Source Touch Top",    "Source touched TopBox")
alertcondition(source == BottomBox, "Source Touch Bottom", "Source touched BottomBox")

// ───── Compression (Energy Build-Up) ─────
boxWidth = TopBox - BottomBox
isTight  = boxWidth <= ta.lowest(boxWidth, boxp)
persist = ta.sma(isTight ? 1 : 0, boxp * 6) == 1
alertcondition(persist, "Compression Zone", "Darvas Box compression detected")

// ───── Extremes Reversal Alerts ─────
lo = ta.lowest(source, alertPeriod)
hi = ta.highest(source, alertPeriod)

alertcondition(source[1] <= lo[1] and source > lo, "Bounce from Low", "Source bounced from recent low")
alertcondition(source[1] >= hi[1] and source < hi, "Rejection from High", "Source rejected from recent high")
