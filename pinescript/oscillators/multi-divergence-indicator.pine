//@version=6
indicator("Multi Divergence Indicator", overlay=true, shorttitle="Multi Div")

// Inputs
maxDist = input.int(50, "Max Bar Distance", group="General Settings")
lbL = input.int(5, "Pivot Lookback Left", group="General Settings")
lbR = input.int(5, "Pivot Lookback Right", group="General Settings")
offset_mult = input.float(0.5, "Label Offset Multiplier", group="General Settings", step=0.1)

// RSI
rsi_len = input.int(14, "RSI Length", group="RSI Settings")
rsi_src = input.source(close, "Source", group="RSI Settings")
rsi_div = input.bool(true, "Calculate Divergence", group="RSI Settings")

// MACD
macd_fast = input.int(12, "Fast Length", group="MACD Settings")
macd_slow = input.int(26, "Slow Length", group="MACD Settings")
macd_sig = input.int(9, "Signal Smoothing", group="MACD Settings")
macd_src = input.source(close, "Source", group="MACD Settings")
macd_div = input.bool(true, "Calculate Divergence", group="MACD Settings")

// Stochastic
stoch_k_len = input.int(14, "%K Length", group="Stochastic Settings")
stoch_src = input.source(close, "Source", group="Stochastic Settings")
stoch_smoothK = input.int(3, "Smooth K", group="Stochastic Settings")
stoch_smoothD = input.int(3, "Smooth D", group="Stochastic Settings")
stoch_div = input.bool(true, "Calculate Divergence", group="Stochastic Settings")

// CCI
cci_len = input.int(20, "Length", group="CCI Settings")
cci_src = input.source(close, "Source", group="CCI Settings")
cci_div = input.bool(true, "Calculate Divergence", group="CCI Settings")

// Momentum
mom_len = input.int(10, "Length", group="Momentum Settings")
mom_src = input.source(close, "Source", group="Momentum Settings")
mom_div = input.bool(true, "Calculate Divergence", group="Momentum Settings")

// Williams %R
willr_len = input.int(14, "Length", group="Williams %R Settings")
willr_div = input.bool(true, "Calculate Divergence", group="Williams %R Settings")

// Awesome Oscillator
ao_fast = input.int(5, "Fast Length", group="Awesome Oscillator Settings")
ao_slow = input.int(34, "Slow Length", group="Awesome Oscillator Settings")
ao_div = input.bool(true, "Calculate Divergence", group="Awesome Oscillator Settings")

// OBV
obv_div = input.bool(true, "Calculate Divergence", group="OBV Settings")

// ATR for offset
atr = ta.atr(14)

// Oscillators
rsi = ta.rsi(rsi_src, rsi_len)
[macdLine, signal, macdHist] = ta.macd(macd_src, macd_fast, macd_slow, macd_sig)
stochK = ta.stoch(stoch_src, high, low, stoch_k_len)
stoch_smooth = ta.sma(stochK, stoch_smoothK)
stochD = ta.sma(stoch_smooth, stoch_smoothD)
cci = ta.cci(cci_src, cci_len)
mom = ta.mom(mom_src, mom_len)
willr = ta.wpr(willr_len)
ao = ta.sma(hl2, ao_fast) - ta.sma(hl2, ao_slow)
obv_val = ta.obv

// Vars for lows
var float prevLowPrice = na
var int prevLowBar = na
var int prevLowTime = na
var float rsi_prevLow = na
var float macd_prevLow = na
var float stoch_prevLow = na
var float cci_prevLow = na
var float mom_prevLow = na
var float willr_prevLow = na
var float ao_prevLow = na
var float obv_prevLow = na

// Vars for highs
var float prevHighPrice = na
var int prevHighBar = na
var int prevHighTime = na
var float rsi_prevHigh = na
var float macd_prevHigh = na
var float stoch_prevHigh = na
var float cci_prevHigh = na
var float mom_prevHigh = na
var float willr_prevHigh = na
var float ao_prevHigh = na
var float obv_prevHigh = na

// Detect low pivots
float priceLowPivot = ta.pivotlow(low, lbL, lbR)
if not na(priceLowPivot)
    int pivotBar = bar_index - lbR
    int currTime = time[lbR]
    float currLowPrice = low[lbR]
    float curr_rsi = rsi[lbR]
    float curr_macd = macdHist[lbR]
    float curr_stoch = stochD[lbR]
    float curr_cci = cci[lbR]
    float curr_mom = mom[lbR]
    float curr_willr = willr[lbR]
    float curr_ao = ao[lbR]
    float curr_obv = obv_val[lbR]
    float atr_val = atr[lbR]
    
    int bull_count = 0
    string bull_tooltip = ""
    if not na(prevLowBar) and pivotBar - prevLowBar <= maxDist
        if rsi_div and ((currLowPrice < prevLowPrice and curr_rsi > rsi_prevLow) or (currLowPrice > prevLowPrice and curr_rsi < rsi_prevLow))
            bull_count += 1
            bull_tooltip += "RSI\n"
        if macd_div and ((currLowPrice < prevLowPrice and curr_macd > macd_prevLow) or (currLowPrice > prevLowPrice and curr_macd < macd_prevLow))
            bull_count += 1
            bull_tooltip += "MACD\n"
        if stoch_div and ((currLowPrice < prevLowPrice and curr_stoch > stoch_prevLow) or (currLowPrice > prevLowPrice and curr_stoch < stoch_prevLow))
            bull_count += 1
            bull_tooltip += "Stoch\n"
        if cci_div and ((currLowPrice < prevLowPrice and curr_cci > cci_prevLow) or (currLowPrice > prevLowPrice and curr_cci < cci_prevLow))
            bull_count += 1
            bull_tooltip += "CCI\n"
        if mom_div and ((currLowPrice < prevLowPrice and curr_mom > mom_prevLow) or (currLowPrice > prevLowPrice and curr_mom < mom_prevLow))
            bull_count += 1
            bull_tooltip += "Mom\n"
        if willr_div and ((currLowPrice < prevLowPrice and curr_willr > willr_prevLow) or (currLowPrice > prevLowPrice and curr_willr < willr_prevLow))
            bull_count += 1
            bull_tooltip += "W%R\n"
        if ao_div and ((currLowPrice < prevLowPrice and curr_ao > ao_prevLow) or (currLowPrice > prevLowPrice and curr_ao < ao_prevLow))
            bull_count += 1
            bull_tooltip += "AO\n"
        if obv_div and ((currLowPrice < prevLowPrice and curr_obv > obv_prevLow) or (currLowPrice > prevLowPrice and curr_obv < obv_prevLow))
            bull_count += 1
            bull_tooltip += "OBV\n"
    
    if bull_count > 0
        line.new(prevLowTime, prevLowPrice, currTime, currLowPrice, xloc=xloc.bar_time, extend=extend.none, color=color.green, width=1)
        label.new(currTime, currLowPrice - (atr_val * offset_mult), str.tostring(bull_count), xloc=xloc.bar_time, yloc=yloc.price, color=color.green, style=label.style_label_up, textcolor=color.white, tooltip=bull_tooltip, force_overlay=true)
    
    // Update prev
    prevLowPrice := currLowPrice
    prevLowBar := pivotBar
    prevLowTime := currTime
    rsi_prevLow := curr_rsi
    macd_prevLow := curr_macd
    stoch_prevLow := curr_stoch
    cci_prevLow := curr_cci
    mom_prevLow := curr_mom
    willr_prevLow := curr_willr
    ao_prevLow := curr_ao
    obv_prevLow := curr_obv

// Detect high pivots
float priceHighPivot = ta.pivothigh(high, lbL, lbR)
if not na(priceHighPivot)
    int pivotBar = bar_index - lbR
    int currTime = time[lbR]
    float currHighPrice = high[lbR]
    float curr_rsi = rsi[lbR]
    float curr_macd = macdHist[lbR]
    float curr_stoch = stochD[lbR]
    float curr_cci = cci[lbR]
    float curr_mom = mom[lbR]
    float curr_willr = willr[lbR]
    float curr_ao = ao[lbR]
    float curr_obv = obv_val[lbR]
    float atr_val = atr[lbR]
    
    int bear_count = 0
    string bear_tooltip = ""
    if not na(prevHighBar) and pivotBar - prevHighBar <= maxDist
        if rsi_div and ((currHighPrice > prevHighPrice and curr_rsi < rsi_prevHigh) or (currHighPrice < prevHighPrice and curr_rsi > rsi_prevHigh))
            bear_count += 1
            bear_tooltip += "RSI\n"
        if macd_div and ((currHighPrice > prevHighPrice and curr_macd < macd_prevHigh) or (currHighPrice < prevHighPrice and curr_macd > macd_prevHigh))
            bear_count += 1
            bear_tooltip += "MACD\n"
        if stoch_div and ((currHighPrice > prevHighPrice and curr_stoch < stoch_prevHigh) or (currHighPrice < prevHighPrice and curr_stoch > stoch_prevHigh))
            bear_count += 1
            bear_tooltip += "Stoch\n"
        if cci_div and ((currHighPrice > prevHighPrice and curr_cci < cci_prevHigh) or (currHighPrice < prevHighPrice and curr_cci > cci_prevHigh))
            bear_count += 1
            bear_tooltip += "CCI\n"
        if mom_div and ((currHighPrice > prevHighPrice and curr_mom < mom_prevHigh) or (currHighPrice < prevHighPrice and curr_mom > mom_prevHigh))
            bear_count += 1
            bear_tooltip += "Mom\n"
        if willr_div and ((currHighPrice > prevHighPrice and curr_willr < willr_prevHigh) or (currHighPrice < prevHighPrice and curr_willr > willr_prevHigh))
            bear_count += 1
            bear_tooltip += "W%R\n"
        if ao_div and ((currHighPrice > prevHighPrice and curr_ao < ao_prevHigh) or (currHighPrice < prevHighPrice and curr_ao > ao_prevHigh))
            bear_count += 1
            bear_tooltip += "AO\n"
        if obv_div and ((currHighPrice > prevHighPrice and curr_obv < obv_prevHigh) or (currHighPrice < prevHighPrice and curr_obv > obv_prevHigh))
            bear_count += 1
            bear_tooltip += "OBV\n"
    
    if bear_count > 0
        line.new(prevHighTime, prevHighPrice, currTime, currHighPrice, xloc=xloc.bar_time, extend=extend.none, color=color.red, width=1)
        label.new(currTime, currHighPrice + (atr_val * offset_mult), str.tostring(bear_count), xloc=xloc.bar_time, yloc=yloc.price, color=color.red, style=label.style_label_down, textcolor=color.white, tooltip=bear_tooltip, force_overlay=true)
    
    // Update prev
    prevHighPrice := currHighPrice
    prevHighBar := pivotBar
    prevHighTime := currTime
    rsi_prevHigh := curr_rsi
    macd_prevHigh := curr_macd
    stoch_prevHigh := curr_stoch
    cci_prevHigh := curr_cci
    mom_prevHigh := curr_mom
    willr_prevHigh := curr_willr
    ao_prevHigh := curr_ao
    obv_prevHigh := curr_obv
