// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © SharpStrat

//@version=6
indicator("Composite Stochastic Oscillator (CSO)", shorttitle="CSO", overlay=false, precision=2)


groupGlobal = "Global Settings"
priceSource  = input.source(close, "Price Source", group=groupGlobal)
maMethod     = input.string("RMA", "MA Method", options=["SMA","EMA","WMA","RMA"], group=groupGlobal)
finalSmooth  = input.int(3, "Final Smoothing (D)", minval=1, group=groupGlobal)



groupS1 = "Stochastic S1"
s1_k = input.int(5,  "K Period",  minval=1, group=groupS1)
s1_d = input.int(3,  "D Period",  minval=1, group=groupS1)
s1_s = input.int(1,  "Slowing",   minval=1, group=groupS1)
s1_w = input.float(5.0, "Weight", minval=0.0, step=0.1, group=groupS1)

groupS2 = "Stochastic S2"
s2_k = input.int(8,  "K Period",  minval=1, group=groupS2)
s2_d = input.int(3,  "D Period",  minval=1, group=groupS2)
s2_s = input.int(1,  "Slowing",   minval=1, group=groupS2)
s2_w = input.float(4.0, "Weight", minval=0.0, step=0.1, group=groupS2)

groupS3 = "Stochastic S3"
s3_k = input.int(13, "K Period",  minval=1, group=groupS3)
s3_d = input.int(3,  "D Period",  minval=1, group=groupS3)
s3_s = input.int(2,  "Slowing",   minval=1, group=groupS3)
s3_w = input.float(3.0, "Weight", minval=0.0, step=0.1, group=groupS3)

groupS4 = "Stochastic S4"
s4_k = input.int(21, "K Period",  minval=1, group=groupS4)
s4_d = input.int(3,  "D Period",  minval=1, group=groupS4)
s4_s = input.int(3,  "Slowing",   minval=1, group=groupS4)
s4_w = input.float(2.0, "Weight", minval=0.0, step=0.1, group=groupS4)

groupS5 = "Stochastic S5"
s5_k = input.int(34, "K Period",  minval=1, group=groupS5)
s5_d = input.int(3,  "D Period",  minval=1, group=groupS5)
s5_s = input.int(5,  "Slowing",   minval=1, group=groupS5)
s5_w = input.float(1.0, "Weight", minval=0.0, step=0.1, group=groupS5)


groupAppearance = "Appearance"
kColor       = input.color(color.lime, "K Line Color", group=groupAppearance)
dColor       = input.color(color.orange, "D Line Color", group=groupAppearance)
lineWidth    = input.int(2, "Line Width", minval=1, maxval=5, group=groupAppearance)
fillOpacity  = input.int(75, "Fill Transparency (0 opaque - 100 transparent)", minval=0, maxval=100, group=groupAppearance)


groupTable = "Table"
showTable   = input.bool(true, "Show K/D Table", group=groupTable)
tableBgTr   = input.int(70, "Table Background Transparency", minval=0, maxval=255, group=groupTable)
tableText   = input.color(color.white, "Table Text Color", group=groupTable)



groupOBOS = "Overbought/Oversold"
showOBOS   = input.bool(true, "Show OB/OS Lines", group=groupOBOS)
obLevel    = input.int(80, "Overbought Level", minval=0, maxval=100, group=groupOBOS)
osLevel    = input.int(20, "Oversold Level", minval=0, maxval=100, group=groupOBOS)
obColor    = input.color(color.red, "Overbought Line Color", group=groupOBOS)
osColor    = input.color(color.green, "Oversold Line Color", group=groupOBOS)
obStyle    = input.string("Dashed", "OB Line Style", options=["Solid","Dashed","Dotted"], group=groupOBOS)
osStyle    = input.string("Dashed", "OS Line Style", options=["Solid","Dashed","Dotted"], group=groupOBOS)


f_ma(src, len) =>
    maMethod == "SMA" ? ta.sma(src, len) :
     maMethod == "EMA" ? ta.ema(src, len) :
     maMethod == "WMA" ? ta.wma(src, len) :
     ta.rma(src, len)

f_stoch(kLen, dLen, slow) =>
    hh = ta.highest(high, kLen)
    ll = ta.lowest(low, kLen)
    rawK = hh != ll ? 100 * (priceSource - ll) / (hh - ll) : 50
    dLine = f_ma(rawK, dLen)
    slowed = f_ma(dLine, slow)
    slowed

//  CALCULATION 
s1 = f_stoch(s1_k, s1_d, s1_s)
s2 = f_stoch(s2_k, s2_d, s2_s)
s3 = f_stoch(s3_k, s3_d, s3_s)
s4 = f_stoch(s4_k, s4_d, s4_s)
s5 = f_stoch(s5_k, s5_d, s5_s)

sumW = s1_w + s2_w + s3_w + s4_w + s5_w
K_comp = sumW > 0 ? (s1*s1_w + s2*s2_w + s3*s3_w + s4*s4_w + s5*s5_w) / sumW : 50

alpha = 1.0 / finalSmooth
var float D_comp = na
D_comp := nz(D_comp[1], K_comp) * (1 - alpha) + K_comp * alpha

val = math.max(0.0, math.min(100.0, nz(K_comp, 50.0)))
r = int(math.round(val * 255.0 / 100.0))
g = int(math.round((100.0 - val) * 255.0 / 100.0))


kLine = plot(K_comp, "K", color=kColor, linewidth=lineWidth)
dLine = plot(D_comp, "D", color=dColor, linewidth=lineWidth)

fill(kLine, dLine, color=K_comp >= D_comp ? color.new(color.green, fillOpacity) : color.new(color.red, fillOpacity))


h0=hline(obLevel, "Overbought", color=showOBOS ? obColor : color.new(obColor, 100), linestyle=hline.style_dashed)
h1=hline(osLevel, "Oversold",   color=showOBOS ? osColor : color.new(osColor, 100), linestyle=hline.style_dashed)
fill(h0, h1, color=color.rgb(33, 150, 243, 90))

var table stats = table.new(position.top_right, 2, 2, border_width=1)

if barstate.islast
    table.cell(stats, 0, 0, "K", bgcolor=color.new(color.black, 70), text_color=color.white)
    table.cell(stats, 1, 0, str.tostring(K_comp, "#.##"), text_color=color.white)
    table.cell(stats, 0, 1, "D", bgcolor=color.new(color.black, 70), text_color=color.white)
    table.cell(stats, 1, 1, str.tostring(D_comp, "#.##"), text_color=color.white)
