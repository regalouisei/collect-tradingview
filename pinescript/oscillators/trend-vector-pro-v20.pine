// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © mbedaiwi2

//@version=6
strategy("Trend Vector Pro v2.0", shorttitle="TVPro", overlay=true, initial_capital=10000, default_qty_type=strategy.percent_of_equity, default_qty_value=5, 
commission_type=strategy.commission.percent, commission_value=0.04, slippage=2) 

// -----------------------------------------------------------------------------
// 1. CONFIGURATION & INPUTS  
// -----------------------------------------------------------------------------
grp_main = "Trend Configuration"
int fastLen = input.int(5, "Fast Momentum Length", minval=1, group=grp_main)
int slowLen = input.int(34, "Slow Momentum Length", minval=1, group=grp_main)
int smooth = input.int(5, "Smoothing Factor", minval=1, group=grp_main)

grp_filters = "Signal Filters & Strategy"
// Signal Mode Selection
string sigMode = input.string("Reversals Only (Cleaner)", "Signal Logic Mode", options=["Reversals Only (Cleaner)", "All Strong Pulses (Aggressive)"], group=grp_filters)

// ADX Filter
bool useAdx = input.bool(false, "Use ADX Filter?", group=grp_filters)
int adxThresh = input.int(20, "ADX Threshold", minval=1, group=grp_filters)

grp_visuals = "Visual Settings"
string textSize = input.string(size.small, "Labels Text Size", options=[size.auto, size.tiny, size.small, size.normal, size.large], group=grp_visuals)

color col_strong_bull = input.color(color.new(#00FF00, 0), "Strong Bullish", group=grp_visuals)
color col_weak_bull   = input.color(color.new(#006400, 0), "Neutral/Bullish", group=grp_visuals)
color col_neutral     = input.color(color.new(#00FFFF, 0), "Neutral (Cyan)", group=grp_visuals)
color col_weak_bear   = input.color(color.new(#8B0000, 0), "Neutral/Bearish", group=grp_visuals)
color col_strong_bear = input.color(color.new(#FF0000, 0), "Strong Bearish", group=grp_visuals)
color col_golden      = input.color(color.new(#FFD700, 0), "Golden Bar", group=grp_visuals)
color col_extended    = input.color(color.new(#D3D3D3, 0), "Extended Bar", group=grp_visuals)

grp_pivots = "Pivots Lines"
bool showPivotLines = input.bool(true, "Show Pivot Lines on Chart", group=grp_pivots)
string pivotPeriod = input.timeframe("D", "Pivot Timeframe", group=grp_pivots)

// -----------------------------------------------------------------------------
// 2. MOMENTUM ENGINE & ADX
// -----------------------------------------------------------------------------
float mid = hl2
float ao = ta.sma(mid, fastLen) - ta.sma(mid, slowLen)
float aoSmooth = ta.ema(ao, smooth) 

// ADX Calculation
[diplus, diminus, adxValue] = ta.dmi(14, 14)
bool marketIsTrending = useAdx ? (adxValue > adxThresh) : true

// -----------------------------------------------------------------------------
// 3. TREND STATE LOGIC
// -----------------------------------------------------------------------------
var color barColor = na
string stateBias = "NEUTRAL"

if aoSmooth > 0
    if aoSmooth > aoSmooth[1]
        barColor := col_strong_bull
        stateBias := "STRONG BULL"
    else
        barColor := col_weak_bull
        stateBias := "WEAK BULL"
else
    if aoSmooth < aoSmooth[1]
        barColor := col_strong_bear
        stateBias := "STRONG BEAR"
    else
        barColor := col_weak_bear
        stateBias := "WEAK BEAR"

float noiseThreshold = ta.stdev(aoSmooth, 100) * 0.2
if math.abs(aoSmooth) < noiseThreshold
    barColor := col_neutral
    stateBias := "NEUTRAL"

// -----------------------------------------------------------------------------
// 4. SPECIAL BAR LOGIC (Visuals Only)
// -----------------------------------------------------------------------------
// Extended Bars Logic (Visual)
bool showExtended = true // Internal Force
int extPeriod = 20
float extDev = 2.0
float basis = ta.sma(close, extPeriod)
float dev = ta.stdev(close, extPeriod)
float upper = basis + (dev * extDev)
float lower = basis - (dev * extDev)
bool isExtended = (close > upper) or (close < lower)

if isExtended
    barColor := col_extended
    stateBias := "EXTENDED"

// Golden Bars (Swing Points) - Used for Trailing Visuals
bool showGolden = true
bool isSwingHigh = high[1] > high[0] and high[1] > high[2]
bool isSwingLow = low[1] < low[0] and low[1] < low[2]
bool goldenBull = (stateBias == "STRONG BULL" or stateBias == "WEAK BULL") and isSwingHigh
bool goldenBear = (stateBias == "STRONG BEAR" or stateBias == "WEAK BEAR") and isSwingLow

if goldenBull or goldenBear
    barColor := col_golden

barcolor(barColor)

// -----------------------------------------------------------------------------
// 5. SIGNALS GENERATION (FIXED LOGIC)
// -----------------------------------------------------------------------------
// Initialize as false to prevent 'na' errors
bool entryLong = false
bool entryShort = false

// Logic A: Aggressive
bool aggLong = (barColor == col_strong_bull) and (barColor[1] != col_strong_bull)
bool aggShort = (barColor == col_strong_bear) and (barColor[1] != col_strong_bear)

// Logic B: Reversals Only
bool isBullBias = (stateBias == "STRONG BULL" or stateBias == "WEAK BULL")
bool isBearBias = (stateBias == "STRONG BEAR" or stateBias == "WEAK BEAR")
bool revLong = isBullBias and not isBullBias[1]
bool revShort = isBearBias and not isBearBias[1]

// Select Mode
if sigMode == "Reversals Only (Cleaner)"
    entryLong := revLong
    entryShort := revShort
else
    entryLong := aggLong
    entryShort := aggShort

// Apply ADX Filter
if useAdx
    entryLong := entryLong and marketIsTrending
    entryShort := entryShort and marketIsTrending

// -----------------------------------------------------------------------------
// 6. STRATEGY EXECUTION (BACKTESTING)
// -----------------------------------------------------------------------------
if entryLong
    strategy.entry("Long", strategy.long, comment="Long")

if entryShort
    strategy.entry("Short", strategy.short, comment="Short")

// -----------------------------------------------------------------------------
// 7. VISUALS: ARROWS & LABELS
// -----------------------------------------------------------------------------
color dynamicText = chart.fg_color 

// Entry Visuals
plotshape(entryLong, title="Long Entry", style=shape.arrowup, location=location.belowbar, color=col_strong_bull, size=size.tiny)
plotshape(entryShort, title="Short Entry", style=shape.arrowdown, location=location.abovebar, color=col_strong_bear, size=size.tiny)

if entryLong
    label.new(bar_index, low, "Long", yloc=yloc.belowbar, color=color(na), textcolor=dynamicText, style=label.style_none, size=textSize)
if entryShort
    label.new(bar_index, high, "Short", yloc=yloc.abovebar, color=color(na), textcolor=dynamicText, style=label.style_none, size=textSize)

// Trailing Visuals
plotshape(goldenBear, title="Trail Stop (Short)", style=shape.arrowdown, location=location.abovebar, color=color.yellow, size=size.tiny)
plotshape(goldenBull, title="Trail Stop (Long)", style=shape.arrowup, location=location.belowbar, color=color.yellow, size=size.tiny)

if goldenBear
    label.new(bar_index, high, "Trail\nShort", yloc=yloc.abovebar, color=color(na), textcolor=dynamicText, style=label.style_none, size=textSize)
if goldenBull
    label.new(bar_index, low, "Trail\nLong", yloc=yloc.belowbar, color=color(na), textcolor=dynamicText, style=label.style_none, size=textSize)

// -----------------------------------------------------------------------------
// 8. DASHBOARD
// -----------------------------------------------------------------------------
var label infoLabel = label.new(na, na, "")
label.delete(infoLabel)

if barstate.islast
    string biasText = "BIAS: " + stateBias
    color txtColor = barColor == col_extended ? color.gray : barColor == col_golden ? color.yellow : barColor
    infoLabel := label.new(bar_index + 3, close, text=biasText, color=color.new(chart.bg_color, 0), textcolor=txtColor, style=label.style_label_left, text_formatting=text.format_bold, size=size.small)

// -----------------------------------------------------------------------------
// 9. PIVOT POINTS
// -----------------------------------------------------------------------------
p_h = request.security(syminfo.tickerid, pivotPeriod, high[1], lookahead=barmerge.lookahead_on)
p_l = request.security(syminfo.tickerid, pivotPeriod, low[1], lookahead=barmerge.lookahead_on)
p_c = request.security(syminfo.tickerid, pivotPeriod, close[1], lookahead=barmerge.lookahead_on)

float pp = (p_h + p_l + p_c) / 3
float r1 = (2 * pp) - p_l
float s1 = (2 * pp) - p_h
float r2 = pp + (p_h - p_l)
float s2 = pp - (p_h - p_l)
float r3 = p_h + 2 * (pp - p_l)
float s3 = p_l - 2 * (p_h - pp)

color c_res = color.new(color.red, 30)
color c_sup = color.new(color.green, 30)
color c_pp  = color.new(color.yellow, 0)

draw_pivot_line(price, col, width) =>
    line.new(bar_index, price, bar_index, price, color=col, width=width)

var line l_r3 = na
var line l_r2 = na
var line l_r1 = na
var line l_pp = na
var line l_s1 = na
var line l_s2 = na
var line l_s3 = na

bool isNewPivotPeriod = ta.change(time(pivotPeriod)) != 0

if showPivotLines
    if isNewPivotPeriod
        l_r3 := draw_pivot_line(r3, c_res, 1)
        l_r2 := draw_pivot_line(r2, c_res, 1)
        l_r1 := draw_pivot_line(r1, c_res, 1)
        l_pp := draw_pivot_line(pp, c_pp, 2)
        l_s1 := draw_pivot_line(s1, c_sup, 1)
        l_s2 := draw_pivot_line(s2, c_sup, 1)
        l_s3 := draw_pivot_line(s3, c_sup, 1)
    else
        line.set_x2(l_r3, bar_index)
        line.set_x2(l_r2, bar_index)
        line.set_x2(l_r1, bar_index)
        line.set_x2(l_pp, bar_index)
        line.set_x2(l_s1, bar_index)
        line.set_x2(l_s2, bar_index)
        line.set_x2(l_s3, bar_index)
