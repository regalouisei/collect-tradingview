// This script is a derivative work based on an original LuxAlgo indicator.
// Original work (c) LuxAlgo - licensed under CC BY-NC-SA 4.0
// https://creativecommons.org/licenses/by-nc-sa/4.0/
//
// Modifications and visual restructuring (c) @Metaltek5
// Released under the same CC BY-NC-SA 4.0 license.
//
// Original Script:
// Bollinger Bands Breakout Oscillator - LuxAlgo
//
// Modified Script (long-form, script-only):
// M5_Bull/Bear Adaptive BBO (LuxAlgo Derivative, Modified by @Metaltek5)

//@version=5
indicator("M5_Bull/Bear BBO")
//------------------------------------------------------------------------------
//Settings
//------------------------------------------------------------------------------
length = input(14)

mult   = input(1.)

src    = input(close)


//Style
bull_css = input(#1848cc, 'Bullish Color'
  , group = 'Style')

bull_css1 = input(#4dd0e1, 'Bullish Color_Inverted'
  , group = 'Style')

bear_css = input(#f77c80, 'Bearish Color_Inverted'
  , group = 'Style')

bear_css1 = input(#b22833, 'Bearish Color'
  , group = 'Style')

//------------------------------------------------------------------------------
//Calculation
//------------------------------------------------------------------------------Bollinger Bands Breakout Oscillator [LUX] - modified by Metaltek5
stdev = ta.stdev(src, length) * mult
ema   = ta.ema(src, length)

upper = ema + stdev
lower = ema - stdev

bull = 0.
bear = 0.
bull_den = 0.
bear_den = 0.

for i = 0 to length-1
    bull += math.max(src[i] - upper[i], 0)
    bear += math.max(lower[i] - src[i], 0)
    
    bull_den += math.abs(src[i] - upper[i])
    bear_den += math.abs(lower[i] - src[i])
    
bull := bull/bull_den*100
bear := bear/bear_den*100


//------------------------------------------------------------------------------
//Plots
//------------------------------------------------------------------------------
bull_grad = color.from_gradient(bull, 0, 100
  , color.new(bull_css, 100)
  , color.new(bull_css, 50))

bear_grad = color.from_gradient(bear, 0, 100
  , color.new(bear_css, 100)
  , color.new(bear_css, 50))

plot0 = plot(bull-50
  , color = bull == 0 ? na : bull_css)

plot1 = plot(1-bull+50
  , color = bull == 0 ? na : bull_css1)

plot2 = plot(bear-50
  , color = bear == 0 ? na : bear_css1)

plot3 = plot(1-bear+50
  , color = bear == 0 ? na : bear_css)

plot4 = plot(0
  , color    = na
  , editable = false)

//hline(50, 'Midline')



//hline(100, title='4', color=color.new(color.green, 80), linestyle=hline.style_dotted, linewidth=1)
hline(-55, title='4', color=color.new(color.white, 80), linestyle=hline.style_solid, linewidth=2)
hline(55, title='4', color=color.new(color.white, 80), linestyle=hline.style_solid, linewidth=2)
hline(0, title='4', color=color.new(color.yellow, 80), linestyle=hline.style_solid, linewidth=2)


//line_level0 = 0
line_level1 = 65
line_level2 = 85
line_level3 = 75
line_level4 = 85
line_level5 = 85
line_level6 = 95


line_width = 1
line_width2 = 2
line_width3 = 3
line_width4 = 4

//line_color0 = bull > bear ? bull < bear ? color.rgb(255, 235, 59, 80) : color.rgb(255, 235, 59, 80) : color.rgb(255, 235, 59, 80)
line_color1 = bull < 1 ? na : bull > bear ? bull > bull[1] ? color.rgb(0, 0, 0, 100) : color.rgb(0, 0, 0, 100) : bear > bear[1] ? color.rgb(255, 0, 0,100) : color.rgb(128, 0, 0)
line_color2 = bull > bear ? (bull > bull[1] ? color.rgb(0, 0, 0, 100) : color.rgb(0, 0, 0, 100)) : (bear > bear[1] ? color.rgb(255, 0, 0,100) : color.rgb(128, 0, 0,100))
line_color3 = bull > bear ? (bull > bull[1] ? color.rgb(76, 175, 80) : color.rgb(0, 100, 0)) : (bear > bear[1] ? color.rgb(120, 123, 134, 80) :  color.rgb(120, 123, 134, 80))
line_color4 = bear < 1 ? na : bull > bear ? bull > bull[1] ?  color.rgb(76, 175, 80) :color.rgb(0, 100, 0,0) : bear > bear[1] ? color.rgb(0, 0, 0, 100) : color.rgb(0, 0, 0, 100)
line_color5 = bear > 1-bear+100 ?  (bear > bear[1] ? color.rgb(236,64,122,100) : color.rgb(136,14,79,100)) : (bull > bull[1] ? color.rgb(0,0,0,100) :  color.rgb(0,0,0,100)) 
line_color6 = bull > 1-bull+100 ? bull > bull[1] ? color.rgb(245,124,0) : color.rgb(230,81,0) : (bear > bear[1] ? color.rgb(0, 0, 0, 100) :  color.rgb(0, 0, 0, 100))

//plot(line_level0, color=line_color0, title="Level 0", linewidth = line_width2, style=plot.style_linebr)
plot(line_level1, color=line_color1, title="Level 75", linewidth = line_width4, style=plot.style_linebr)
plot(line_level2, color=line_color5, title="Level 100", linewidth = line_width2, style=plot.style_linebr)
plot(line_level3, color=line_color3, title="Level 110", linewidth = line_width2, style=plot.style_linebr)
plot(line_level4, color=line_color4, title="Level 120", linewidth = line_width2, style=plot.style_linebr)
plot(line_level5, color=line_color2, title="Level 90", linewidth = line_width2, style=plot.style_linebr)
plot(line_level6, color=line_color6, title="Level 135", linewidth = line_width2, style=plot.style_linebr)

line_level7 = -65
line_level8 = -65
line_level9 = -95
line_level10 = -75
line_level11 = -85
line_level12 = -95

line_color7 = bull < 1 ? na : bull > bear ? bull > bull[1] ? color.rgb(0, 0, 0, 100) : color.rgb(0, 0, 0, 100) : bear > bear[1] ? color.rgb(255, 0, 0) : color.rgb(128, 0, 0)
line_color8 = bull > bear ? (bull > bull[1] ? color.rgb(120, 123, 134, 80) : color.rgb(120, 123, 134, 80)) : (bear > bear[1] ? color.rgb(255, 0, 0) : color.rgb(128, 0, 0))
line_color9 = bull > bear ? (bull > bull[1] ? color.rgb(76, 175, 80,100) : color.rgb(0, 100, 0,100)) : (bear > bear[1] ? color.rgb(0, 0, 0, 100) :  color.rgb(0, 0, 0, 100))
line_color10 = bear < 1 ? na : bull > bear ? bull > bull[1] ?  color.rgb(76, 175, 80,100) :color.rgb(0, 100, 0) : bear > bear[1] ? color.rgb(0, 0, 0, 100) : color.rgb(0, 0, 0, 100)
line_color11 = bear > 1-bear+100 ?  (bear > bear[1] ? color.rgb(236,64,122) : color.rgb(136,14,79)) : (bull > bull[1] ? color.rgb(0,0,0,100) :  color.rgb(0,0,0,100)) 
line_color12 = bull > 1-bull+100 ? bull > bull[1] ? color.rgb(245,124,0,100) : color.rgb(230,81,0,100) : (bear > bear[1] ? color.rgb(0, 0, 0, 100) :  color.rgb(0, 0, 0, 100))


plot(line_level7, color=line_color12, title="Level -75", linewidth = line_width2, style=plot.style_linebr)
plot(line_level8, color=line_color10, title="Level -80", linewidth = line_width4, style=plot.style_linebr)
plot(line_level9, color=line_color9, title="Level -95", linewidth = line_width2, style=plot.style_linebr)
plot(line_level10, color=line_color11, title="Level -107.5", linewidth = line_width2, style=plot.style_linebr)
plot(line_level11, color=line_color8, title="Level -120", linewidth = line_width2, style=plot.style_linebr)
plot(line_level12, color=line_color7, title="Level -137.5", linewidth = line_width2, style=plot.style_linebr)


color.rgb(178, 181, 190, 0), color.rgb(63, 65, 71), color.rgb(76, 175, 80), color.rgb(0, 100, 0), 
color.rgb(236,64,122), color.rgb(136,14,79), color.rgb(245,124,0),color.rgb(230,81,0)
