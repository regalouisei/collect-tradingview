//@version=5
// @description 该指标结合了归一化动能算法与威廉指标(Williams %R)的变体逻辑。
// @description 通过对加权价格进行非线性平滑，识别趋势爆发的引爆点，适用于捕捉高波动率行情。
indicator("动能结构波动振荡器 [MSVO Professional]", shorttitle="MSVO", overlay=false, precision=2)

// ==========================================
// 1. 系统参数配置 (Constants & Inputs)
// ==========================================
LOOKBACK_LONG  = 21
LOOKBACK_SHORT = 8

// ==========================================
// 2. 核心量化引擎 (Quantitative Logic)
// ==========================================

// --- 阶段 A: 基础价格极值区间计算 ---
base_min_26 = ta.lowest(low, 26)
base_max_34 = ta.highest(high, 34)

// --- 阶段 B: 归一化动能平滑 (ZBGS33 对标) ---
// 利用 (当前价-极低)/(极高-极低) 将价格映射至 0-4 区间并进行 EMA 平滑
momentum_norm = ta.ema((close - base_min_26) / (base_max_34 - base_min_26) * 4, 4) * 25

// --- 阶段 C: 动态动能边界探测 ---
weighted_price = (2 * close + high + low) / 4
dyn_low_n1     = ta.lowest(low, LOOKBACK_LONG)
dyn_high_n2    = ta.highest(high, LOOKBACK_SHORT)

// --- 阶段 D: 增强型威廉指标逻辑 (Williams %R Derived) ---
williams_range_high = ta.highest(high, 14)
williams_range_low  = ta.lowest(low, 14)
williams_ext_val    = 100 - 100 * (williams_range_high - close) / (williams_range_high - williams_range_low)

// 动能双重平滑处理
fast_momentum_ema = ta.ema(williams_ext_val, 3)
slow_momentum_base = ta.ema(williams_ext_val, 7)
slow_momentum_final = ta.ema(slow_momentum_base, 5)

// 信号触发判定: 低位动能金叉 (Accumulation Signal)
acc_trigger = ta.crossover(fast_momentum_ema, slow_momentum_final) and slow_momentum_final < 20

// ==========================================
// 3. 趋势核心指标 (Core Trend Oscillator)
// ==========================================

// 非线性回归核心算法: (加权价 - 动态低点) / (动态高点 - 动态低点)
range_diff = dyn_high_n2 - dyn_low_n1
raw_oscillator_val = range_diff != 0 ? (weighted_price - dyn_low_n1) / range_diff * 100 : 0

// 主线: 动能加速线 (Core Momentum)
main_oscillator = ta.ema(raw_oscillator_val, 9)

// 信号线: 采用 0.667/0.333 加权平滑算法 (Weighted Signal Line)
signal_source = 0.667 * nz(main_oscillator[1]) + 0.333 * main_oscillator
signal_oscillator = ta.ema(signal_source, 2)

// ==========================================
// 4. 视觉渲染系统 (Visualization)
// ==========================================

// 4.1 振荡曲线绘制
plot_main   = plot(main_oscillator,   "Core Momentum (Main)",   color=color.new(color.red, 0), linewidth=2)
plot_signal = plot(signal_oscillator, "Signal Line (Smooth)", color=color.new(color.green, 0), linewidth=1)

// 4.2 动能云图填充 (Momentum Cloud)
cloud_color = main_oscillator > signal_oscillator ? color.new(color.red, 40) : color.new(color.green, 40)
fill(plot_main, plot_signal, cloud_color, title="Momentum Energy Cloud")

// 4.3 信号标签与文本确认
// 趋势启动标记 (Origin Signal)
plotshape(acc_trigger ? signal_oscillator : na, 
     title     = "Trend Origin", 
     style     = shape.labelup, 
     location  = location.absolute, 
     color     = color.new(#FF00FF, 0), 
     size      = size.small, 
     text      = "INIT", 
     textcolor = color.white)

// 阈值穿越确认 (Threshold Confirmation)
buy_entry_con   = ta.crossover(main_oscillator, 20)
sell_exit_con   = ta.crossunder(main_oscillator, 80)

plotshape(buy_entry_con ? 18 : na, 
     title     = "Entry Point", 
     style     = shape.triangleup, 
     location  = location.absolute, 
     color     = color.green, 
     size      = size.tiny, 
     text      = "BUY", 
     textcolor = color.green)

plotshape(sell_exit_con ? 82 : na, 
     title     = "Exit Point", 
     style     = shape.triangledown, 
     location  = location.absolute, 
     color     = color.red, 
     size      = size.tiny, 
     text      = "SELL", 
     textcolor = color.red)

// 4.4  结构分界线
hline(80, "Resistance Zone", color=color.new(color.gray, 50), linestyle=hline.style_dashed)
hline(50, "Neutral Pivot",   color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(20, "Support Zone",    color=color.new(color.gray, 50), linestyle=hline.style_dashed)
