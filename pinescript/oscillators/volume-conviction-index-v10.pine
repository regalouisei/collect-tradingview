// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/

// © RU55IANROUL3TT3
//@version=6
indicator("Volume Conviction Index v1.0", overlay=false, max_bars_back=5000)

// ── Inputs ────────────────────────────────────────────────────────────────
group_core = "Core Settings"
vol_len       = input.int(50,   "Volume Window", minval=10, group=group_core)
z_thresh      = input.float(1.5, "Outlier Cap Threshold", minval=0.5, step=0.1, group=group_core)
weight_recent = input.float(0.7, "Recent Change Weight %", minval=0.0, maxval=1.0, step=0.05, group=group_core)

group_filter = "Low TF Visual Filter"
show_median   = input.bool(true,  "Show Median Conviction Line", group=group_filter)
median_len    = input.int(7,      "Median Filter Length", minval=3, maxval=15, group=group_filter)

// ── Robust Median Volume Function ─────────────────────────────────────────
f_median(src, len) =>
    var float[] arr = array.new<float>(len, na)
    array.shift(arr)
    array.push(arr, src)
    array.median(arr)

// ── Median Volume & MAD ───────────────────────────────────────────────────
med_vol = f_median(volume, vol_len)

var float[] devs = array.new<float>(vol_len, na)
array.shift(devs)
array.push(devs, math.abs(volume - med_vol))
mad_vol = array.median(devs)

// ── Robust Z-Volume ───────────────────────────────────────────────────────
robust_z_vol = na(mad_vol) or mad_vol == 0 ? na : 0.6745 * (volume - med_vol) / mad_vol

// ── Outlier filter: Winsorize extremes ────────────────────────────────────
filtered_z = math.abs(robust_z_vol) > z_thresh ? math.sign(robust_z_vol) * z_thresh : robust_z_vol

// ── Weighted conviction component ─────────────────────────────────────────
vol_change_pct = volume > 0 and volume[1] > 0 ? (volume / volume[1] - 1) * 100 : 0
rvol_pct       = (volume / med_vol - 1) * 100
weighted_conv  = weight_recent * vol_change_pct + (1 - weight_recent) * rvol_pct

// ── Final raw VCI ─────────────────────────────────────────────────────────
vpi_raw = 0.6 * filtered_z + 0.4 * (weighted_conv / 10)

// ── Median line filter (aggressive low-TF reference) ──────────────────────
vci_median = ta.median(vpi_raw, median_len)

// ── Plots ─────────────────────────────────────────────────────────────────
plot(vpi_raw, "VCI", 
     color = vpi_raw > 0 ? color.new(color.teal, 20) : color.new(color.orange, 20), 
     style = plot.style_columns, 
     linewidth = 3)

plot(show_median ? vci_median : na, "Conviction Median Line", 
     color = color.new(color.white, 50), linewidth = 2, style = plot.style_linebr)

// Zero line
hline(0, color = color.gray, linestyle = hline.style_dotted)

// Subtle threshold guides (no labels)
hline(1.5, color = color.new(color.teal, 85), linestyle = hline.style_dashed)
hline(-1.5, color = color.new(color.orange, 85), linestyle = hline.style_dashed)
