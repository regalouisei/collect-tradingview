// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © PSIKLO

//@version=6
indicator("Crypto Flow Index (CFI) — RS vs BTC/ETH [Public]", shorttitle="CFI", overlay=false)

// ───────────────────────── Inputs ─────────────────────────
grpSym = "Symbols"
exch      = input.string("KRAKEN", "Exchange Prefix", group=grpSym)
benchmark = input.string("BTC", "Benchmark", options=["BTC","ETH"], group=grpSym)

useOverrideRS = input.bool(false, "Override RS Symbol", group=grpSym)
overrideRS    = input.symbol("KRAKEN:XRPBTC", "RS Symbol", group=grpSym)

useUSDFilter   = input.bool(true, "USD Trend Filter", group=grpSym)
useOverrideUSD = input.bool(false, "Override USD Symbol", group=grpSym)
overrideUSD    = input.symbol("KRAKEN:XRPUSD", "USD Symbol", group=grpSym)

grpCalc = "CFI Calculation"
lenMFI     = input.int(14, "RS-MFI Length", minval=2, group=grpCalc)
smoothLen  = input.int(6, "Smoothing (EMA)", minval=1, group=grpCalc)
useMomentum = input.bool(true, "Blend Momentum", group=grpCalc)
momLen     = input.int(14, "Momentum Length", minval=2, group=grpCalc)
momWeight  = input.float(0.35, "Momentum Weight", minval=0, maxval=1, step=0.05, group=grpCalc)

grpUSD = "USD Filter Settings"
usdFastLen = input.int(20, "USD Fast EMA", minval=2, group=grpUSD)
usdSlowLen = input.int(50, "USD Slow EMA", minval=2, group=grpUSD)

grpLevels = "Levels"
midLevel = input.int(50, "Midline", minval=1, maxval=99, group=grpLevels)
ob       = input.int(80, "Overbought", minval=50, maxval=95, group=grpLevels)
os       = input.int(20, "Oversold", minval=5, maxval=50, group=grpLevels)

grpVis = "Visuals"
showHist   = input.bool(true, "Histogram (CFI - Mid)", group=grpVis)
showLine   = input.bool(true, "CFI Line", group=grpVis)
lineAlpha  = input.int(60, "Line Transparency", minval=0, maxval=95, group=grpVis)
showBg     = input.bool(true, "Background Tint (Bias)", group=grpVis)

showRibbon   = input.bool(true, "Bias Ribbon", group=grpVis)
ribbonPos    = input.string("Top", "Ribbon Position", options=["Top","Bottom"], group=grpVis)
ribbonThick  = input.int(6, "Ribbon Thickness", minval=2, maxval=20, group=grpVis)
showNoDataBg = input.bool(false, "Tint When RS Data Missing", group=grpVis)

// ───────────────────────── Helpers ─────────────────────────
clamp(val, minv, maxv) =>
    math.max(minv, math.min(maxv, val))

// ───────────────────────── Symbols ─────────────────────────
base    = syminfo.basecurrency
autoRS  = exch + ":" + base + benchmark
autoUSD = exch + ":" + base + "USD"

rsSym  = useOverrideRS  ? overrideRS  : autoRS
usdSym = useOverrideUSD ? overrideUSD : autoUSD

// ───────────────────────── RS data (BASEBTC / BASEETH) ─────────────────────────
h = request.security(rsSym, timeframe.period, high)
l = request.security(rsSym, timeframe.period, low)
c = request.security(rsSym, timeframe.period, close)
v = request.security(rsSym, timeframe.period, volume)

rsOk = not na(c) and not na(v)

// ───────────────────────── RS-MFI (manual, v6-safe) ─────────────────────────
tp    = (h + l + c) / 3.0
mf    = tp * v
posMF = tp > tp[1] ? mf : 0.0
negMF = tp < tp[1] ? mf : 0.0

posSum = ta.sma(posMF, lenMFI) * lenMFI
negSum = ta.sma(negMF, lenMFI) * lenMFI

mfr   = negSum == 0 ? 999.0 : posSum / negSum
mfi   = 100.0 - (100.0 / (1.0 + mfr))
mfiSm = ta.ema(mfi, smoothLen)

// ───────────────────────── Momentum blend (0..100) ─────────────────────────
ret    = ta.roc(c, 1)
momRaw = ta.ema(ret, momLen)
momZ   = ta.ema(momRaw, momLen) / (ta.stdev(momRaw, momLen) + 1e-10)
momZc  = clamp(momZ, -3, 3)
mom100 = 50 + (momZc / 3) * 50

flow = useMomentum ? (mfiSm * (1 - momWeight) + mom100 * momWeight) : mfiSm
flow := clamp(flow, 0, 100)

// ───────────────────────── USD filter ─────────────────────────
usdClose = request.security(usdSym, timeframe.period, close)
usdOk    = not na(usdClose)

usdFast = ta.ema(usdClose, usdFastLen)
usdSlow = ta.ema(usdClose, usdSlowLen)

usdUp   = usdFast > usdSlow
usdDown = usdFast < usdSlow

// ───────────────────────── Bias ─────────────────────────
flowBull = rsOk and flow > midLevel and flow > flow[1]
flowBear = rsOk and flow < midLevel and flow < flow[1]

longOK  = flowBull and (not useUSDFilter or (usdOk and usdUp))
shortOK = flowBear and (not useUSDFilter or (usdOk and usdDown))

biasColor =
      not rsOk ? (showNoDataBg ? color.new(color.gray, 88) : na) :
      longOK   ? color.new(color.lime, 0) :
      shortOK  ? color.new(color.red, 0) :
      color.new(color.gray, 0)

// ───────────────────────── Plots ─────────────────────────
hline(midLevel, "Mid", color=color.new(color.gray, 70))
hline(ob, "OB", color=color.new(color.red, 75))
hline(os, "OS", color=color.new(color.green, 75))

hist = flow - midLevel
histColor =
     not rsOk ? color.new(color.gray, 70) :
     hist > 0 ? color.lime :
     hist < 0 ? color.red : color.gray

plot(showHist ? hist : na, "CFI Pressure (CFI - Mid)", style=plot.style_columns, color=histColor)
plot(showLine ? flow : na, "CFI", color=color.new(color.white, lineAlpha), linewidth=2)

bgcolor(showBg ?
     (not rsOk ? na :
      longOK  ? color.new(color.lime, 93) :
      shortOK ? color.new(color.red, 93) : na)
     : na)

// ───────────────────────── Bias ribbon (thin strip) ─────────────────────────
float ribTop = na
float ribBot = na

if ribbonPos == "Top"
    ribTop := 100
    ribBot := clamp(100 - ribbonThick, 0, 100)
else
    ribTop := clamp(ribbonThick, 0, 100)
    ribBot := 0

pRibTop = plot(showRibbon ? ribTop : na, title="Ribbon Top", display=display.none)
pRibBot = plot(showRibbon ? ribBot : na, title="Ribbon Bottom", display=display.none)

color ribFill =
      not rsOk ? (showNoDataBg ? color.new(color.gray, 88) : na) :
      longOK   ? color.new(color.lime, 86) :
      shortOK  ? color.new(color.red, 86) :
      color.new(color.gray, 92)

fill(pRibTop, pRibBot, color=ribFill, title="Bias Ribbon")

// ───────────────────────── Data window only (no tooltip/table) ─────────────────────────
plotchar(rsOk ? 1 : 0, "RS Data OK (1/0)", "", location=location.bottom, display=display.data_window)
plotchar(useUSDFilter ? (usdOk ? (usdUp ? 1 : usdDown ? -1 : 0) : 9) : 8,
     "USD Trend (1/-1/0 | 8=OFF | 9=NO DATA)", "", location=location.bottom, display=display.data_window)

// ───────────────────────── Alerts ─────────────────────────
alertcondition(longOK,  "CFI Bias Bullish", "CFI bullish (and USD filter aligned if enabled).")
alertcondition(shortOK, "CFI Bias Bearish", "CFI bearish (and USD filter aligned if enabled).")
alertcondition(ta.crossover(flow, midLevel), "CFI Cross Up", "CFI crossed above Mid.")
alertcondition(ta.crossunder(flow, midLevel), "CFI Cross Down", "CFI crossed below Mid.")
