//@version=6
indicator(title="Average True Range with MA", shorttitle="ATR+MA", overlay=false, timeframe="", timeframe_gaps=true)

// ATR inputs
length = input.int(title="ATR Length", defval=14, minval=1)
smoothing = input.string(title="ATR Smoothing", defval="RMA", options=["RMA", "SMA", "EMA", "WMA"])

// MA-on-ATR inputs
ma_length = input.int(title="MA Length (on ATR)", defval=14, minval=1)
ma_smoothing = input.string(title="MA Smoothing", defval="SMA", options=["RMA", "SMA", "EMA", "WMA"])

// Display options
show_atr = input.bool(true, title="Show ATR")
show_ma = input.bool(true, title="Show ATR MA")
atr_color = input.color(title="ATR Color", defval=color.new(#B71C1C, 0))
ma_color = input.color(title="ATR MA Color", defval=color.new(#1976D2, 0))

// generic smoothing function supporting the selected methods
ma_function(source, len, method) =>
    switch method
        "RMA" => ta.rma(source, len)
        "SMA" => ta.sma(source, len)
        "EMA" => ta.ema(source, len)
        => ta.wma(source, len)

// compute ATR (smoothing TR directly, like original) and then a moving average of the ATR
atr = ma_function(ta.tr(true), length, smoothing)
atr_ma = ma_function(atr, ma_length, ma_smoothing)

// plots
plot(show_atr ? atr : na, title="ATR", color=atr_color)
plot(show_ma ? atr_ma : na, title="ATR MA", color=ma_color, linewidth=2)
