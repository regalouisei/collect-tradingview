//@version=6
indicator("Nova Capital MACD", shorttitle="NOVA MACD", overlay=false, precision=1)

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// Parameters
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
fastLen   = input.int(13, "Fast Length",   minval=1)
slowLen   = input.int(50, "Slow Length",   minval=1)
signalLen = input.int(25, "Signal Length", minval=1)

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// Settings
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
srcOpt   = input.string("close", "Source", options=["close","hl2","hlc3","ohlc4"])
maFSOpt  = input.string("EMA", "Fast/Slow MA", options=["EMA","SMA"])
maSigOpt = input.string("EMA", "Signal MA",    options=["EMA","SMA"])

onlyClosed = input.bool(true, "Confirmed bars only")
filterZero = input.bool(true, "Zero-line filter (Long <0, Short >0)")

src = switch srcOpt
    "hl2"   => hl2
    "hlc3"  => hlc3
    "ohlc4" => ohlc4
    => close

ma(x, len, typ) =>
    typ == "EMA" ? ta.ema(x, len) : ta.sma(x, len)

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// MACD
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
fast = ma(src, fastLen, maFSOpt)
slow = ma(src, slowLen, maFSOpt)

macdLine   = fast - slow
signalLine = ma(macdLine, signalLen, maSigOpt)
hist       = macdLine - signalLine

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// Histogram colors (4 states)
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
histUp  = hist > hist[1]
histPos = hist >= 0

cPosUp   = color.rgb(0, 255, 255)
cPosDown = color.rgb(235, 235, 235)
cNegDown = color.rgb(255, 0, 0)
cNegUp   = color.rgb(255, 160, 190)

histColor = histPos ? (histUp ? cPosUp : cPosDown) : (histUp ? cNegUp : cNegDown)

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// Plots (order: Histogram, MACD, Signal)
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
plot(hist,       title="Histogram", style=plot.style_columns, color=histColor)
plot(macdLine,   title="MACD",       color=color.rgb(170, 0, 255), linewidth=2)
plot(signalLine, title="Signal",     color=color.rgb(255, 140, 0), linewidth=2)
hline(0, "Zero", color=color.new(color.white, 70))

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// Signals
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ok = onlyClosed ? barstate.isconfirmed : true

longRaw  = ta.crossover(macdLine, signalLine)
shortRaw = ta.crossunder(macdLine, signalLine)

longSig  = ok and longRaw  and (not filterZero or macdLine < 0)
shortSig = ok and shortRaw and (not filterZero or macdLine > 0)

// Label colors
txtBlue = color.rgb(60, 150, 255)
shortBg = color.rgb(255, 80, 80)
longBg  = color.rgb(0, 200, 0)

plotshape(shortSig, title="Short",
     style=shape.labeldown, location=location.top, text="Short",
     color=shortBg, textcolor=txtBlue, size=size.tiny)

plotshape(longSig, title="Long",
     style=shape.labelup, location=location.bottom, text="Long",
     color=longBg, textcolor=txtBlue, size=size.tiny)

// Hidden outputs (0.0 / 1.0)
plot(longSig ? 1.0 : 0.0,  title="LongVal",  display=display.none)
plot(shortSig ? 1.0 : 0.0, title="ShortVal", display=display.none)

// Alerts
alertcondition(longSig,  title="NOVA MACD Long",  message="NOVA MACD LONG — {{ticker}} ({{interval}})")
alertcondition(shortSig, title="NOVA MACD Short", message="NOVA MACD SHORT — {{ticker}} ({{interval}})")

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// Fixed brand label (user cannot change it)
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
var label brandLabel = na

// Hardcoded brand settings
brandText       = "@NOVACAPITAL.VIP"
brandOffsetBars = 20
brandPadY       = 0.8

if barstate.islast
    // Auto Y = above the highest of the 3 series (MACD, Signal, Hist)
    maxLine = math.max(math.max(macdLine, signalLine), hist)
    yBrand  = maxLine + brandPadY

    if not na(brandLabel)
        label.delete(brandLabel)

    brandLabel := label.new(
        bar_index + brandOffsetBars, yBrand, brandText,
        xloc=xloc.bar_index, yloc=yloc.price,
        style=label.style_label_left,
        color=color.new(color.black, 100),
        textcolor=color.new(color.blue, 0),
        size=size.normal
    )
