// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © oquant

//@version=6
indicator("Robust Scaled Dema | Oquant")
import TradingView/ta/10 as ta


//inputs 

src = input.source(close, title = "Source", group = "Source")
demalen = input.int(25, "Dema Length", group = "Robust Scaled Dema")
rslen = input.int(40, "Robust Scaling Length", group = "Robust Scaled Dema")
upperthreshold = input.float(0.5, step = 0.1, title = "Upper Threshold", group = "Thresholds")
lowerthreshold = input.float(0, step = 0.1, title = "Lower Threshold", group = "Thresholds")


//dema

dema = ta.dema(src, demalen)

//robust scaling

q1 = ta.percentile_linear_interpolation(dema, rslen, 25)
q3 = ta.percentile_linear_interpolation(dema, rslen, 75)
demamedian = ta.percentile_linear_interpolation(dema, rslen, 50)

iqr = q3 - q1 

robustscaling = (dema - demamedian)/iqr


//signals

long = robustscaling > upperthreshold
short = robustscaling < lowerthreshold


var oquant = 0

if long and not short 
    oquant := 1

if short 
    oquant := -1


//plotting

oquantgreen = color.rgb(31, 211, 37)
oquantpurple = color.rgb(188, 8, 219)

colors = oquant==1 ? oquantgreen : oquant==-1 ? oquantpurple : na

plot(robustscaling, "Robust Scaled Dema", colors, linewidth = 2)
plot(upperthreshold, "Upper Threshold", oquantgreen)
plot(lowerthreshold, "Lower Threshold", oquantpurple)
plotcandle(open, high, low, close, "Plot Bars", colors, colors, bordercolor = colors, force_overlay = true)

alertcondition(ta.crossover(oquant, 0), "Robust Scaled Dema Long", "Robust Scaled Dema Long {{exchange}}:{{ticker}}")
alertcondition(ta.crossunder(oquant, 0), "Robust Scaled Dema Short", "Robust Scaled Dema Short {{exchange}}:{{ticker}}")
