// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Rob_Maths

//@version=6
// -----------------------------------------------------------------------------
// SCRIPT: BTC - RHODL Ratio (Proxy Flow Edition) | RM
// AUTHOR: Rob_Maths
// METHODOLOGY: Approximates the Realized HODL Ratio by analyzing the "Flow"
//              between young (<1Y) and old (>=1Y) supply cohorts. 
//              It captures speculative intensity without requiring 
//              premium realized-value age-band feeds.
// -----------------------------------------------------------------------------

indicator("BTC - RHODL (Proxy Flow) | RM", shorttitle="RHODL Proxy | RM", overlay=false, precision=2)

// ===========================
// 1. SETTINGS
// ===========================
grp_src  = "Data Source"
sym_1y   = input.symbol("GLASSNODE:BTC_ACTIVE1Y", "1Y+ Supply Symbol", group=grp_src, tooltip="Required: Ticker showing % of supply held for 1+ year.")

grp_mod  = "Model Parameters"
yWin     = input.int(30,   "Young Window (Days)", minval=7, group=grp_mod, tooltip="Lookback for recent speculative 'young' money flow.")
oWin     = input.int(365,  "Old Window (Days)",   minval=30, group=grp_mod, tooltip="Lookback for 'old' money baseline.")
smooth   = input.int(14,   "Smoothing (SMA)",     minval=1, group=grp_mod)
ageDiv   = input.float(365.0, "Age Normalization Divisor", minval=1.0, group=grp_mod)

grp_vis  = "Visuals"
th_high  = input.float(0.5,  "Overheated (Top)", step=0.05, group=grp_vis)
th_low   = input.float(-0.5, "Undervalued (Bottom)", step=0.05, group=grp_vis)

// ===========================
// 2. DATA ENGINE (DAILY LOCK)
// ===========================
f_calc_flow(_sym, _yW, _oW, _aD) =>
    _raw1y = request.security(_sym, "D", close, ignore_invalid_symbol=true)
    // Normalize to 0-100%
    _pct1y = _raw1y <= 2.0 ? _raw1y * 100.0 : _raw1y
    
    _youngPool = 100.0 - _pct1y
    _dYoung    = _youngPool - _youngPool[1]
    _dOld      = _pct1y - _pct1y[1]
    
// Sum positive flow changes directly using math.max
    _cumY = ta.cum(math.max(_dYoung, 0.0))
    _cumO = ta.cum(math.max(_dOld, 0.0))
    
    _yFlow = _cumY - _cumY[_yW]
    _oFlow = _cumO - _cumO[_oW]
    
    // Age Normalization (Genesis: Jan 3, 2009)
    _ageDays = (time - timestamp(2009, 1, 3)) / 86400000.0
    _ratio   = (_yFlow / math.max(_oFlow, 1e-9)) * (_ageDays / _aD)
    math.log10(math.max(_ratio, 1e-9))

d_rhodl = request.security(syminfo.tickerid, "D", f_calc_flow(sym_1y, yWin, oWin, ageDiv))
rhodl_ma = ta.sma(d_rhodl, smooth)

// ===========================
// 3. PLOTTING & DASHBOARD
// ===========================
c_line = color.rgb(217, 119, 6) // RM Orange
c_top  = color.rgb(220, 38, 38) // Red
c_bot  = color.rgb(22, 163, 74) // Green

plot(rhodl_ma, "RHODL Proxy", color=c_line, linewidth=2)
hline(th_high, "Top Band", color=color.new(c_top, 50), linestyle=hline.style_dashed)
hline(th_low,  "Bottom Band", color=color.new(c_bot, 50), linestyle=hline.style_dashed)

// Shading
bg_col = rhodl_ma > th_high ? color.new(c_top, 85) : rhodl_ma < th_low ? color.new(c_bot, 85) : na
bgcolor(bg_col, title="Regime Highlight")

// Dashboard
var table info = table.new(position.bottom_right, 2, 2, border_width=1)
if barstate.islast
    _status = rhodl_ma > th_high ? "OVERHEATED" : rhodl_ma < th_low ? "ACCUMULATION" : "NEUTRAL"
    _s_col  = rhodl_ma > th_high ? c_top : rhodl_ma < th_low ? c_bot : color.gray
    table.cell(info, 0, 0, "RHODL SCORE", bgcolor=color.gray, text_color=color.white, text_size=size.small)
    table.cell(info, 1, 0, str.tostring(rhodl_ma, "#.2"), bgcolor=color.black, text_color=color.white, text_size=size.small)
    table.cell(info, 0, 1, "REGIME", bgcolor=color.gray, text_color=color.white, text_size=size.small)
    table.cell(info, 1, 1, _status, bgcolor=color.black, text_color=_s_col, text_size=size.small)
