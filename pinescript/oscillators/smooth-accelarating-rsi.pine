// This Pine ScriptÂ® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© MisinkoMaster

//@version=6
indicator("Smooth Accelarating RSI", "SA RSI | MisinkoMaster", overlay = false)
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Import Libraries
import TradingView/ta/12
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Get User Defined Inputs
src = input.source(close, "Source",
     tooltip = "Changes the source of the RSI.",
     group = "Smooth Accelarating RSI | MisinkoMaster")
len = input.int(24, "RSI Length", step = 1, minval = 2,
     tooltip = "Changes the length of the RSI.",
     group = "Smooth Accelarating RSI | MisinkoMaster")

sap = input.int(12, "Smooth Accelarating",
     tooltip = "Changes the lenfth of the smoothing in the RSI in the calculation",
     group = "Smooth Accelarating RSI | MisinkoMaster")

matype = input.string("RMA", "MA Type",
     options = ["RMA", "SMA", "EMA", "WMA", "DEMA", "TEMA", "HMA", "ALMA"],
     tooltip = "Changes the MA used in the entire indicator.",
     group = "Moving Average")

offset = input.float(0.85, "Offset", step = 0.05, minval = 0,
     group = "| ALMA Only |", inline = "ALMA")
sigma = input.float(6, "Sigma", step = 0.5, minval = 0,
     group = "| ALMA Only |", inline = "ALMA")

ut = input.int(55, "Upper Treshhold", step = 1,
     tooltip = "Changes the Upper Treshhold for RSI long",
     group = "Treshholds", inline = "T")
lt = input.int(45, "Lower Treshhold", step = 1,
     tooltip = "Changes the Lower Treshhold for RSI short",
     group = "Treshholds", inline = "T")

obt = input.int(85, "Overbought Treshhold", step = 1, minval = 55,
     tooltip = "Changes the Overbought Treshhold for catching low value zones",
     group = "Treshholds", inline = "O")
ost = input.int(15, "Oversold Treshhold", step = 1, maxval = 45,
     tooltip = "Changes the Oversold Treshhold for catching high value zones",
     group = "Treshholds", inline = "O")
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Calculations
change = src-src[1]

gain = math.max(change, 0)
loss = math.abs(math.min(change, 0))


[avg_gain, avg_loss] = switch matype
    "RMA" => [ta.rma(gain, len), ta.rma(loss, len)]
    "SMA" => [ta.sma(gain, len), ta.sma(loss, len)]
    "EMA" => [ta.ema(gain, len), ta.ema(loss, len)]
    "WMA" => [ta.wma(gain, len), ta.wma(loss, len)]
    "DEMA" => [ta.dema(gain, len), ta.dema(loss, len)]
    "TEMA" => [ta.tema(gain, len), ta.tema(loss, len)]
    "HMA" => [ta.hma(gain, len), ta.hma(loss, len)]
    "ALMA" => [ta.alma(gain, len, offset, sigma), ta.alma(loss, len, offset, sigma)]

slen = math.round(math.sqrt(len))
[sg, sl] = switch matype
    "RMA" => [ta.rma(avg_gain, slen), ta.rma(avg_loss, slen)]
    "SMA" => [ta.sma(avg_gain, slen), ta.sma(avg_loss, slen)]
    "EMA" => [ta.ema(avg_gain, slen), ta.ema(avg_loss, slen)]
    "WMA" => [ta.wma(avg_gain, slen), ta.wma(avg_loss, slen)]
    "DEMA" => [ta.dema(avg_gain, slen), ta.dema(avg_loss, slen)]
    "TEMA" => [ta.tema(avg_gain, slen), ta.tema(avg_loss, slen)]
    "HMA" => [ta.hma(avg_gain, slen), ta.hma(avg_loss, slen)]
    "ALMA" => [ta.alma(avg_gain, slen, offset, sigma), ta.alma(avg_loss, slen, offset, sigma)]

rsis = 100 - 100 / (1+avg_gain/avg_loss)
rsif = 100 - 100 / (1+sg/sl)

ab = 2/(1+len)
b = 2/(1+(slen+len)/2)

brsi_ = (rsis*(1-ab)+(rsis*2-rsis[1])*ab+rsif*b+rsif*(1-b))/2
brsi = ta.hma(brsi_[1]*(1-b)+brsi_*b, sap)
rsi = (brsi+brsi)/2
cm = rsi-rsi[1]
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Trend Logic
var trend = 0

L = rsi > ut
S = rsi < lt

if L
    trend := 1
if S
    trend := -1
////////////////////////////////////////////////////////////////////////////////////////////////////
//Plotting
divergence = 50+cm

var col = color.rgb(72, 72, 72)
var colT = color.rgb(72, 72, 72, 50)
if trend == 1
    col := color.rgb(0, 255, 187)
    colT := color.rgb(0, 255, 187, 50)
if trend == -1
    col := color.rgb(255, 0, 157)
    colT := color.rgb(255, 0, 157, 50)

var colD = color.rgb(0, 255, 187, 70)
if divergence > 50
    colD := color.rgb(0, 255, 187, 70)
if divergence < 50
    colD := color.rgb(255, 0, 157, 70)

bc = rsi > obt
sc = rsi < ost

plotshape(trend == 1 and trend[1] != 1 ? src : na, style = shape.labelup, location = location.belowbar, size = size.normal, color = color.rgb(0, 255, 187), display = display.pane, force_overlay = true, text = "ð“›ð“¸ð“·ð“°", textcolor = color.rgb(7, 114, 86))
plotshape(trend == -1 and trend[1] != -1 ? src : na, style = shape.labeldown,location = location.abovebar, size = size.normal,color = color.rgb(255, 0, 157), display = display.pane, force_overlay = true, text = "ð“¢ð“±ð“¸ð“»ð“½", textcolor = color.rgb(95, 11, 63))

var colOB = rsi > obt ? color.rgb(255, 0, 157, 70) : color.rgb(0, 0, 0, 100)
var colOS = rsi > obt ? color.rgb(255, 0, 157, 70) : color.rgb(0, 0, 0, 100)


bgcolor(colOB, force_overlay = true)
bgcolor(colOB, force_overlay = false)
bgcolor(colOS, force_overlay = true)
bgcolor(colOS, force_overlay = false)

lp = plot(ut, title = "Long Treshhold", color = color.rgb(71, 70, 70), display = display.pane, linewidth = 3)
sp = plot(lt, title = "Short Treshhold", color = color.rgb(71, 70, 70), display = display.pane, linewidth = 3)
obp = plot(obt, title = "OB Treshhold", color = color.rgb(0, 255, 187), display = display.pane, linewidth = 3)
osp = plot(ost, title = "OS Treshhold", color = color.rgb(255, 0, 157), display = display.pane, linewidth = 3)

fill(sp, osp, color.rgb(255, 0, 157, 85))
fill(lp, obp, color.rgb(0, 255, 187, 85))
fill(lp, sp, color.rgb(71, 70, 70, 75))

plotcandle(open, high, low, close, bordercolor = col, color = col, force_overlay = true, display = display.pane)

rsip = plot(rsi, "Self-Correcting RSI | MisinkoMaster", color = col, linewidth = 2)
plot(divergence, "Divergence", color = colD, style = plot.style_histogram, histbase = 50)

fill(rsip, obp, colOB)
fill(rsip, osp, colOS)
