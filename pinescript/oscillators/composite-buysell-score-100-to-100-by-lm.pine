// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © LouisMont

//@version=5
indicator("Composite Buy/Sell Score [-100 to +100] (Stabilized + Sensitivity) by LM", overlay=false)

// === INPUTS ===
// PPO
ppo_fast     = input.int(12, title="PPO Fast EMA")
ppo_slow     = input.int(26, title="PPO Slow EMA")
ppo_signal_len = input.int(9, title="PPO Signal Smoothing")

// ADX
adx_length   = input.int(14, title="ADX Length")
adx_threshold = input.int(20, title="ADX Threshold")

// RSI
rsi_length   = input.int(14, title="RSI Length")
rsi_overbought = input.int(70, title="RSI Overbought")
rsi_oversold   = input.int(30, title="RSI Oversold")

// Stochastic RSI
stoch_rsi_length = input.int(14, title="Stoch RSI Length")
stoch_k = input.int(3, title="%K")
stoch_d = input.int(3, title="%D")

// MACD
macd_fast = input.int(12, title="MACD Fast")
macd_slow = input.int(26, title="MACD Slow")
macd_signal = input.int(9, title="MACD Signal")

// Williams %R
wpr_length = input.int(14, title="Williams %R Length")

// Smoothing and Stability Controls
smooth_len = input.int(5, "Final Score Smoothing Length", minval=1)
confirmBars = input.int(2, "Confirm Bars for Each Signal", minval=1)

// Sensitivity Multiplier
sensitivity_mult = input.float(1.5, "Sensitivity Multiplier", minval=0.1, step=0.1)

// === CALCULATIONS ===

// PPO
ema_fast = ta.ema(close, ppo_fast)
ema_slow = ta.ema(close, ppo_slow)
ppo = (ema_fast - ema_slow) / ema_slow * 100
ppo_signal_line = ta.ema(ppo, ppo_signal_len)
ppo_dir = ta.crossover(ppo, ppo_signal_line) ? 1 : ta.crossunder(ppo, ppo_signal_line) ? -1 : 0

// ADX
up = ta.change(high)
down = -ta.change(low)
plusDM = na(up) ? na : (up > down and up > 0 ? up : 0)
minusDM = na(down) ? na : (down > up and down > 0 ? down : 0)
trur = ta.rma(ta.tr, adx_length)
plusDI = 100 * ta.rma(plusDM, adx_length) / trur
minusDI = 100 * ta.rma(minusDM, adx_length) / trur
dx = 100 * math.abs(plusDI - minusDI) / (plusDI + minusDI)
adx = ta.rma(dx, adx_length)
adx_signal = adx > adx_threshold ? 1 : -1

// RSI
rsi = ta.rsi(close, rsi_length)
rsi_signal = (rsi > rsi[1] and rsi < rsi_overbought) ? 1 : (rsi < rsi[1] and rsi > rsi_oversold ? -1 : 0)

// Stoch RSI
rsi_stoch = ta.rsi(close, stoch_rsi_length)
stoch_k_val = ta.sma(ta.stoch(rsi_stoch, rsi_stoch, rsi_stoch, stoch_rsi_length), stoch_k)
stoch_d_val = ta.sma(stoch_k_val, stoch_d)
stoch_signal = (stoch_k_val > stoch_d_val and stoch_k_val > stoch_k_val[1]) ? 1 : (stoch_k_val < stoch_d_val and stoch_k_val < stoch_k_val[1] ? -1 : 0)

// MACD
[macd_line, macd_signal_line, _] = ta.macd(close, macd_fast, macd_slow, macd_signal)
macd_signal_val = macd_line > macd_signal_line ? 1 : macd_line < macd_signal_line ? -1 : 0

// Williams %R
highestHigh = ta.highest(high, wpr_length)
lowestLow   = ta.lowest(low, wpr_length)
wpr = (highestHigh - close) / (highestHigh - lowestLow) * -100
wpr_signal = (wpr > -80 and wpr > wpr[1]) ? 1 : (wpr < -20 and wpr < wpr[1] ? -1 : 0)

// === SMOOTH EACH INDICATOR’S SIGNAL (ConfirmBars) ===
ppo_dir_slow     = ta.sma(ppo_dir, confirmBars)
adx_signal_slow  = ta.sma(adx_signal, confirmBars)
rsi_signal_slow  = ta.sma(rsi_signal, confirmBars)
stoch_signal_slow= ta.sma(stoch_signal, confirmBars)
macd_signal_slow = ta.sma(macd_signal_val, confirmBars)
wpr_signal_slow  = ta.sma(wpr_signal, confirmBars)

// === WEIGHTS (Rebalanced for smoother behavior) ===
w_ppo   = 10
w_adx   = 20
w_rsi   = 25
w_stoch = 10
w_macd  = 25
w_wpr   = 10
w_total = w_ppo + w_adx + w_rsi + w_stoch + w_macd + w_wpr

// === FINAL COMPOSITE SCORE ===
combined_score = (ppo_dir_slow * w_ppo + adx_signal_slow * w_adx + rsi_signal_slow * w_rsi + stoch_signal_slow * w_stoch + macd_signal_slow * w_macd + wpr_signal_slow * w_wpr)

score_normalized = combined_score / w_total * 100
score_smoothed = ta.ema(score_normalized, smooth_len)

// === APPLY SENSITIVITY MULTIPLIER ===
score_final = score_smoothed * sensitivity_mult

// === PLOT ===
plot(score_final, title="Smoothed Composite Score",
     color=color.new(score_final > 0 ? color.green : score_final < 0 ? color.red : color.gray, 0),
     linewidth=2)

hline(0, "Neutral", color=color.gray, linestyle=hline.style_dotted)
hline(100, "Buy (+100)", color=color.new(color.green, 70), linestyle=hline.style_dashed)
hline(-100, "Sell (-100)", color=color.new(color.red, 70), linestyle=hline.style_dashed)

// === ADAPTIVE BACKGROUND COLOR ===
show_bg = input.bool(true, title="Highlight Background by Trend Strength")

bg_alpha = math.min(math.abs(score_final) * 0.6, 90)
bg_color = score_final >= 0 ? color.new(color.green, 100 - bg_alpha) : color.new(color.red, 100 - bg_alpha)
bgcolor(show_bg ? bg_color : na)
