// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © BOSWaves

//@version=6
indicator("Reduced-Lag Chande Momentum Oscillator [BOSWaves]", shorttitle="Reduced-Lag CMO [BOSWaves]", overlay=false, explicit_plot_zorder=true)

// ============================================================================
// Inputs
// ============================================================================
length = input.int(9, title="CMO Length", minval=1, 
     tooltip="Number of bars used to calculate the Chande Momentum Oscillator. Lower values = more responsive but noisier, higher values = smoother but slower.")

overbought = input.int(50, title="Overbought Level", minval=0, maxval=100, 
     tooltip="CMO level above which the market is considered overbought. Typical range: 40-60. Reversal signals trigger when price exits this zone.")

oversold = input.int(-50, title="Oversold Level", minval=-100, maxval=0, 
     tooltip="CMO level below which the market is considered oversold. Typical range: -40 to -60. Reversal signals trigger when price exits this zone.")

// Lag reduction and smoothing inputs
useReducedLag = input.bool(true, title="Use Reduced-Lag Filter", group="Lag Reduction", 
     tooltip="Applies Ehlers' reduced-lag EMA filter to minimize lag while maintaining responsiveness. Recommended: ON for faster signals.")

reducedLagLength = input.int(8, title="Reduced-Lag Length", minval=1, maxval=10, group="Lag Reduction", 
     tooltip="Period for the reduced-lag filter. Lower values = less lag but more noise. Typical range: 5-10.")

smoothType = input.string("EMA", title="Smoothing Type", options=["None", "SMA", "EMA", "WMA"], group="Smoothing", 
     tooltip="Type of moving average applied to smooth the CMO line:\n• None - No smoothing (raw signal)\n• SMA - Simple Moving Average (equal weight)\n• EMA - Exponential (recent data weighted more)\n• WMA - Weighted (linear weighting)")

smoothLength = input.int(15, title="Smoothing Length", minval=1, group="Smoothing", 
     tooltip="Number of bars for smoothing the CMO. Higher values = smoother line but slower signals. Typical range: 10-20.")

// Signal inputs
showSignals = input.bool(true, title="Show Signals", group="Signals", 
     tooltip="Display buy/sell signal arrows on the chart when signals are triggered.")

signalMode = input.string("All", title="Signal Mode", options=["All", "Momentum Only", "Reversal Only"], group="Signals", 
     tooltip="Filter which types of signals to display:\n• All - Both momentum and reversal signals\n• Momentum Only - Only zero-line crossovers\n• Reversal Only - Only oversold/overbought reversals")

// Cooldown period input
useCooldown = input.bool(true, title="Use Signal Cooldown", group="Signals", 
     tooltip="Prevents multiple signals from appearing too close together, reducing noise and false signals.")

cooldownBars = input.int(10, title="Cooldown Period (Bars)", minval=1, maxval=100, group="Signals", 
     tooltip="Minimum number of bars required between consecutive signals (buy or sell). Higher values = fewer but potentially higher quality signals.")

// Candle color inputs
colorCandles = input.bool(true, title="Color Candles with Momentum", group="Candle Colors", 
     tooltip="Colors the price candles based on CMO momentum. Green = bullish, Red = bearish, with gradient transitions.")

greyCandles = input.bool(false, title="Grey Candles", group="Candle Colors", 
     tooltip="Override momentum coloring and display all candles in grey. Useful for cleaner chart visualization.")

// Color gradient inputs
colorIntensity = input.int(90, title="Color Intensity", minval=0, maxval=100, group="Color Gradient", 
     tooltip="Adjusts the vibrancy of the CMO line gradient colors. 0 = muted colors, 100 = maximum saturation. Does not affect calculation.")

// ============================================================================
// Core Calculations
// ============================================================================

// Calculate CMO
calcCMO(src, len) =>
    up = math.max(src - src[1], 0)
    down = math.max(src[1] - src, 0)
    sumUp = math.sum(up, len)
    sumDown = math.sum(down, len)
    cmo = 100 * (sumUp - sumDown) / (sumUp + sumDown)
    cmo

// Reduced-lag filter function (Ehlers)
reducedLag(src, len) =>
    ema1 = ta.ema(src, len)
    ema2 = ta.ema(ema1, len)
    rl = ema1 + (ema1 - ema2)
    rl

// Smoothing function
applySmoothing(src, type, len) =>
    switch type
        "SMA" => ta.sma(src, len)
        "EMA" => ta.ema(src, len)
        "WMA" => ta.wma(src, len)
        => src

// Calculate raw CMO
rawCMO = calcCMO(close, length)

// Apply reduced-lag filter
cmoRL = useReducedLag ? reducedLag(rawCMO, reducedLagLength) : rawCMO

// Apply smoothing
cmoSmooth = applySmoothing(cmoRL, smoothType, smoothLength)

// ============================================================================
// Visual Elements
// ============================================================================

// Create shadow line (hardcoded settings for smooth shadow effect)
cmoShadow = ta.sma(cmoSmooth, 10)

// Create middle line between main and shadow
cmoMiddle = ta.sma(cmoSmooth, 5)

// Calculate momentum metrics
cmoVelocity = ta.change(cmoSmooth)
cmoAcceleration = ta.change(cmoVelocity)

// Gradient color calculation
colorSmoothLength = 5
colorSmoothedCMO = ta.ema(cmoSmooth, colorSmoothLength)

// Create simple gradient color based directly on CMO value
getGradientColor(cmoValue, intensity) =>
    // CMO ranges from -100 to +100, normalize to 0-1
    norm = (cmoValue + 100) / 200
    
    // Simple three-color gradient: Red -> Yellow -> Green
    if norm < 0.5
        // Red to Yellow (bearish to neutral)
        factor = norm * 2
        red = 255
        green = math.round(255 * factor)
        blue = 0
        color.rgb(red, green, blue)
    else
        // Yellow to Green (neutral to bullish)
        factor = (norm - 0.5) * 2
        red = math.round(255 * (1 - factor))
        green = 255
        blue = 0
        color.rgb(red, green, blue)

// Apply gradient colors
lineColor = getGradientColor(colorSmoothedCMO, colorIntensity)
middleColor = color.new(lineColor, 45)
shadowColor = color.new(lineColor, 70)

// Plot lines and fills
p3 = plot(cmoShadow, 
     title="CMO Shadow", 
     color=shadowColor, 
     linewidth=5, display=display.none)

// Plot middle line
p2 = plot(cmoMiddle, 
     title="CMO Middle", 
     color=middleColor, 
     linewidth=5)

// Plot main CMO line
p1 = plot(cmoSmooth, 
     title="CMO", 
     color=lineColor, 
     linewidth=5)

// Fill between main line and middle for glow effect
fill(p1, p2, 
     color=cmoSmooth > cmoMiddle ? lineColor : na, 
     title="Main to Middle Fill Up")
     
fill(p1, p2, 
     color=cmoSmooth < cmoMiddle ? lineColor : na, 
     title="Main to Middle Fill Down")

// Fill between middle line and shadow for glow effect
fill(p2, p3, 
     color=cmoMiddle > cmoShadow ? middleColor : na, 
     title="Middle to Shadow Fill Up")
     
fill(p2, p3, 
     color=cmoMiddle < cmoShadow ? middleColor : na, 
     title="Middle to Shadow Fill Down")

// Reference lines and zone fills
hline(0, title="Zero Line", color=color.gray, linestyle=hline.style_solid, linewidth=1)
hline(overbought, title="Overbought", color=color.new(color.red, 60), linestyle=hline.style_dashed)
hline(oversold, title="Oversold", color=color.new(color.green, 60), linestyle=hline.style_dashed)

// Zone boundary plots
obPlot = plot(overbought, color=na, display=display.none, title="OB Level")
osPlot = plot(oversold, color=na, display=display.none, title="OS Level")
topPlot = plot(100, color=na, display=display.none, title="Top Level")
bottomPlot = plot(-100, color=na, display=display.none, title="Bottom Level")

// Zone fills
fill(obPlot, topPlot, color=color.new(color.red, 92), title="Overbought Zone Fill")
fill(osPlot, bottomPlot, color=color.new(color.green, 92), title="Oversold Zone Fill")

// ============================================================================
// Signal System
// ============================================================================

// Signal detection
momentumBuy = ta.crossover(cmoSmooth, 0) and cmoVelocity > 0
momentumSell = ta.crossunder(cmoSmooth, 0) and cmoVelocity < 0

// 2. REVERSAL SIGNALS - Extreme zones with bounce back
reversalBuy = cmoSmooth[1] < oversold and ta.crossover(cmoSmooth, oversold) and cmoVelocity > 0
reversalSell = cmoSmooth[1] > overbought and ta.crossunder(cmoSmooth, overbought) and cmoVelocity < 0

// 3. STRONG SIGNALS - When momentum + acceleration align
strongBuy = (momentumBuy or reversalBuy) and cmoAcceleration > 0
strongSell = (momentumSell or reversalSell) and cmoAcceleration < 0

// Combine signals based on mode
rawBuySignal = signalMode == "Momentum Only" ? momentumBuy : signalMode == "Reversal Only" ? reversalBuy : (momentumBuy or reversalBuy)
rawSellSignal = signalMode == "Momentum Only" ? momentumSell : signalMode == "Reversal Only" ? reversalSell : (momentumSell or reversalSell)

// Cooldown logic
var int lastSignalBar = na

signalAllowed = not useCooldown or na(lastSignalBar) or (bar_index - lastSignalBar) >= cooldownBars

// Apply cooldown filter
buySignal = rawBuySignal and signalAllowed
sellSignal = rawSellSignal and signalAllowed

// Update last signal bar
if buySignal or sellSignal
    lastSignalBar := bar_index

// Plot signals
plotshape(showSignals and buySignal, title="Buy", style=shape.triangleup, 
          location=location.belowbar, color=color.new(color.lime, 0), size=size.small, force_overlay=true)

plotshape(showSignals and sellSignal, title="Sell", style=shape.triangledown, 
          location=location.abovebar, color=color.new(color.red, 0), size=size.small, force_overlay=true)

plotshape(showSignals and strongBuy and buySignal, title="Strong Buy", style=shape.diamond, 
          location=location.belowbar, color=color.new(color.aqua, 0), size=size.tiny, force_overlay=true)

plotshape(showSignals and strongSell and sellSignal, title="Strong Sell", style=shape.diamond, 
          location=location.abovebar, color=color.new(color.orange, 0), size=size.tiny, force_overlay=true)

// ============================================================================
// Alerts
// ============================================================================
alertcondition(buySignal, title="Buy Signal", message="CMO Buy Signal")
alertcondition(sellSignal, title="Sell Signal", message="CMO Sell Signal")
alertcondition(strongBuy and buySignal, title="Strong Buy", message="CMO Strong Buy - High Conviction")
alertcondition(strongSell and sellSignal, title="Strong Sell", message="CMO Strong Sell - High Conviction")

// ============================================================================
// Visual Enhancements
// ============================================================================

// Candle coloring based on settings
candleColor = greyCandles ? color.gray : (colorCandles ? lineColor : na)
barcolor(candleColor, title="Momentum Candle Color")
