// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © daniel_lee7395

//@version=6
indicator(title="Bollinger Bands + Session VWAP + MACD Background", shorttitle="BBVWAPMACD", overlay=true, timeframe="", timeframe_gaps=true)

// ========== BOLLINGER BANDS INPUTS ==========
length = input.int(20, minval=1)
maType = input.string("SMA", "Basis MA Type", options = ["SMA", "EMA", "SMMA (RMA)", "WMA", "VWMA"])
src = input(close, title="Source")
mult = input.float(2.0, minval=0.001, maxval=50, title="StdDev")

// ========== VWAP INPUTS ==========
showVWAP = input.bool(true, "Show Session VWAP", group="VWAP")
vwapSource = input(hlc3, title="VWAP Source", group="VWAP")
vwapColor = input.color(color.orange, "VWAP Color", group="VWAP")
vwapWidth = input.int(2, "VWAP Line Width", minval=1, maxval=5, group="VWAP")

// ========== MACD INPUTS ==========
showMACDBackground = input.bool(true, "Show MACD Background", group="MACD")
fastLength = input.int(12, "MACD Fast Length", minval=1, group="MACD")
slowLength = input.int(26, "MACD Slow Length", minval=1, group="MACD")
signalLength = input.int(9, "MACD Signal Length", minval=1, group="MACD")
macdSource = input(close, "MACD Source", group="MACD")
strongBullishColor = input.color(color.new(color.green, 85), "Strong Bullish", group="MACD")
weakBullishColor = input.color(color.new(color.green, 95), "Weak Bullish", group="MACD")
strongBearishColor = input.color(color.new(color.red, 85), "Strong Bearish", group="MACD")
weakBearishColor = input.color(color.new(color.red, 95), "Weak Bearish", group="MACD")

// ========== BOLLINGER BANDS CALCULATION ==========
ma(source, length, _type) =>
    switch _type
        "SMA" => ta.sma(source, length)
        "EMA" => ta.ema(source, length)
        "SMMA (RMA)" => ta.rma(source, length)
        "WMA" => ta.wma(source, length)
        "VWMA" => ta.vwma(source, length)

basis = ma(src, length, maType)
dev = mult * ta.stdev(src, length)
upper = basis + dev
lower = basis - dev
offset = input.int(0, "Offset", minval = -500, maxval = 500, display = display.data_window)

// ========== SESSION VWAP CALCULATION ==========
// Detect new session (daily reset)
newSession = ta.change(time("D")) != 0

// Calculate cumulative values for VWAP
var float sumPV = 0.0
var float sumV = 0.0

if newSession
    sumPV := vwapSource * volume
    sumV := volume
else
    sumPV += vwapSource * volume
    sumV += volume

sessionVWAP = sumPV / sumV

// ========== MACD CALCULATION ==========
fastMA = ta.ema(macdSource, fastLength)
slowMA = ta.ema(macdSource, slowLength)
macdLine = fastMA - slowMA
signalLine = ta.ema(macdLine, signalLength)
histogram = macdLine - signalLine

// Determine histogram momentum (rising or falling)
histogramRising = histogram > histogram[1]
histogramFalling = histogram < histogram[1]

// Four-state MACD background logic
isStrongBullish = macdLine > signalLine and histogramRising
isWeakBullish = macdLine > signalLine and histogramFalling
isStrongBearish = macdLine < signalLine and histogramFalling
isWeakBearish = macdLine < signalLine and histogramRising

// Determine background color
bgColor = showMACDBackground ? 
     (isStrongBullish ? strongBullishColor : 
      isWeakBullish ? weakBullishColor : 
      isStrongBearish ? strongBearishColor : 
      isWeakBearish ? weakBearishColor : na) : na

// ========== PLOTTING ==========
plot(basis, "Basis", color=#2962FF, offset = offset)
p1 = plot(upper, "Upper", color=#F23645, offset = offset)
p2 = plot(lower, "Lower", color=#089981, offset = offset)
fill(p1, p2, title = "Background", color=color.rgb(33, 150, 243, 95))

// Plot VWAP
plot(showVWAP ? sessionVWAP : na, "Session VWAP", color=vwapColor, linewidth=vwapWidth)

// Plot MACD background
bgcolor(bgColor, title="MACD Background")
