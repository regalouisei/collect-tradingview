//@version=6
indicator(title="CCI Pro [Hash Capital Research]", shorttitle="CCI Pro", format=format.price, precision=2)

// Company Information - Info icon only, no text box
_ = input.bool(true, "ℹ️ About Hash Capital Research", tooltip="Hash Capital Partners\nwww.hashadaptive.com\n\nFollow us on TradingView for exclusive premium indicators and cutting-edge quantitative research.", group="Company Information")

// Core Settings
length = input.int(20, "CCI Period", minval=1, tooltip="Number of bars for CCI calculation. Lower values (10-14) = more sensitive to price changes. Higher values (20-30) = smoother but slower signals.")
src = input(hlc3, "Source", tooltip="Price data used for calculations. HLC3 (default) uses average of High, Low, Close. Close only uses closing prices for less noise.")
smoothing = input.int(5, "Smoothing", minval=1, maxval=10, tooltip="Additional smoothing applied to CCI. Lower values (1-3) = more responsive. Higher values (5-8) = smoother waves with less noise.")
calculateDivergence = input.bool(false, title="Calculate Divergence", group="CCI Settings", display=display.data_window, tooltip="Calculating divergences is needed for divergence alerts to fire and display divergence signals.")

// Visual Settings
colorIntensity = input.float(7.0, "Color Intensity", minval=1.0, maxval=10.0, step=1.0, group="Visual", tooltip="Controls color vibrancy. 1-3 = subtle colors, 4-6 = balanced, 7-10 = very bright and vibrant colors.")
showGlowEffect = input.bool(true, "Glow Effect", group="Visual", tooltip="Adds luminous glow around the CCI line. Creates a more dramatic visual effect, especially during extreme market conditions.")
glowIntensity = input.float(5.0, "Glow Intensity", minval=1.0, maxval=10.0, step=1.0, group="Visual", tooltip="Controls glow brightness. 1-3 = subtle glow, 4-6 = moderate glow, 7-10 = intense glow effect.")

// Signal Settings
signalSensitivity = input.float(6.0, "Signal Sensitivity", minval=1.0, maxval=10, step=1.0, group="Signal Settings", tooltip="Controls signal trigger sensitivity. Lower values (1-4) = more frequent signals. Higher values (6-10) = fewer but stronger signals.")

// Enhanced CCI Calculation
ma = ta.sma(src, length)
deviation = ta.dev(src, length)
rawCCI = (src - ma) / (0.015 * deviation)

// Multi-layer smoothing for precision
cci1 = ta.ema(rawCCI, smoothing)
cci = ta.ema(cci1, 2)

// Momentum and velocity
momentum = ta.change(cci, 1)
velocity = ta.change(momentum, 1)

// Adaptive levels based on volatility
volatility = ta.stdev(cci, 30)
upperLevel = 100 + (volatility * 0.3)
lowerLevel = -100 - (volatility * 0.3)

// Extreme levels
extremeUpper = upperLevel * 1.3
extremeLower = lowerLevel * 1.3

// Continuous Wave-like Color System - eliminates gaps
getAdaptiveColor() =>
    // Convert 1-10 scale to 0-1 for calculations
    colorScale = colorIntensity / 10.0
    
    // Ensure continuous color output - no na values
    normalizedCCI = math.max(-1.0, math.min(1.0, cci / 150))
    
    // Create smooth continuous transitions
    if normalizedCCI >= 0
        // Green spectrum for positive values
        intensity = math.pow(normalizedCCI, 0.5) * colorScale
        redVal = math.round(100 * (1 - intensity))
        greenVal = 255
        blueVal = math.round(100 * (1 - intensity * 0.7))
        alpha = math.max(0, math.round(30 * (1 - intensity)))
        color.rgb(redVal, greenVal, blueVal, alpha)
    else
        // Red spectrum for negative values  
        intensity = math.pow(math.abs(normalizedCCI), 0.5) * colorScale
        redVal = 255
        greenVal = math.round(100 * (1 - intensity))
        blueVal = math.round(100 * (1 - intensity * 0.7))
        alpha = math.max(0, math.round(30 * (1 - intensity)))
        color.rgb(redVal, greenVal, blueVal, alpha)

// Enhanced Glow effect - brighter when past extreme levels
getGlowColor() =>
    if showGlowEffect
        // Convert 1-10 scale to usable range
        glowScale = glowIntensity / 10.0
        baseIntensity = math.abs(cci) / 120
        
        // Boost glow intensity when past extreme levels
        isExtreme = cci > 100 or cci < -100
        intensityBoost = isExtreme ? 1.5 : 1.0
        glowAlpha = math.round(100 - (baseIntensity * 60 * glowScale * intensityBoost))
        
        if cci >= 0
            // Green glow for positive
            color.new(#00FF00, math.max(30, glowAlpha))
        else
            // Red glow for negative
            color.new(#FF0000, math.max(30, glowAlpha))
    else
        na

// Calculate crossovers
momentumCrossUp = ta.crossover(momentum, 0)
momentumCrossDown = ta.crossunder(momentum, 0)

// Signal detection with adjusted sensitivity
signalMultiplier = signalSensitivity / 10.0
oversoldReversal = cci < (lowerLevel * signalMultiplier) and momentum > 0 and velocity > 0
overboughtReversal = cci > (upperLevel * signalMultiplier) and momentum < 0 and velocity < 0

// Extreme signals
extremeOversoldReversal = cci < (extremeLower * 0.8) and momentumCrossUp
extremeOverboughtReversal = cci > (extremeUpper * 0.8) and momentumCrossDown

// CCI plots with clear identifiable labels
cciMainLine = plot(cci, "CCI Main Line", color=getAdaptiveColor(), linewidth=2, display=display.all)
cciGlowLine = plot(cci, "CCI Glow Effect", color=getGlowColor(), linewidth=5, display=display.all)

// Area fill to zero line - makes CCI display as area by default
zeroLinePlot = plot(0, "Zero Reference", color=color.new(color.white, 100))
fill(cciMainLine, zeroLinePlot, color=color.new(getAdaptiveColor(), 85), title="CCI Area Fill")

// Enhanced extreme level lines - 50% transparency, dotted style
hline(0, "Zero", color=color.new(color.white, 50), linestyle=hline.style_solid, linewidth=1)
extremeUpperLine = hline(100, "Extreme Overbought", color=color.new(color.white, 50), linestyle=hline.style_dotted, linewidth=2)
extremeLowerLine = hline(-100, "Extreme Oversold", color=color.new(color.white, 50), linestyle=hline.style_dotted, linewidth=2)

// Shade areas beyond extreme levels
upperExtremePlot = plot(cci > 100 ? cci : 100, "Upper Extreme Area", color=color.new(color.white, 100), display=display.none)
lowerExtremePlot = plot(cci < -100 ? cci : -100, "Lower Extreme Area", color=color.new(color.white, 100), display=display.none)

fill(cciMainLine, upperExtremePlot, color=cci > 100 ? color.new(#00FF00, 90) : na, title="Overbought Extreme Zone")
fill(cciMainLine, lowerExtremePlot, color=cci < -100 ? color.new(#FF0000, 90) : na, title="Oversold Extreme Zone")

// Divergence Detection
lookbackRight = 5
lookbackLeft = 5
rangeUpper = 60
rangeLower = 5

// Bright fluorescent colors for divergence signals
bearColor = color.new(#FF0000, 0)  // Bright red
bullColor = color.new(#00FF00, 0)  // Bright green
textColor = color.white
noneColor = color.new(color.white, 100)

_inRange(bool cond) =>
    bars = ta.barssince(cond)
    rangeLower <= bars and bars <= rangeUpper

plFound = false
phFound = false

bullCond = false
bearCond = false

cciLBR = cci[lookbackRight]

if calculateDivergence
    // Regular Bullish Divergence
    // CCI: Higher Low
    plFound := not na(ta.pivotlow(cci, lookbackLeft, lookbackRight))
    
    // Check range first, then use result
    plFoundPrev = plFound[1]
    inRangeBull = _inRange(plFoundPrev)
    
    cciHL = cciLBR > ta.valuewhen(plFound, cciLBR, 1) and inRangeBull
    // Price: Lower Low
    lowLBR = low[lookbackRight]
    priceLL = lowLBR < ta.valuewhen(plFound, lowLBR, 1)
    bullCond := priceLL and cciHL and plFound

    // Regular Bearish Divergence
    // CCI: Lower High
    phFound := not na(ta.pivothigh(cci, lookbackLeft, lookbackRight))
    
    // Check range first, then use result
    phFoundPrev = phFound[1]
    inRangeBear = _inRange(phFoundPrev)
    
    cciLH = cciLBR < ta.valuewhen(phFound, cciLBR, 1) and inRangeBear
    // Price: Higher High
    highLBR = high[lookbackRight]
    priceHH = highLBR > ta.valuewhen(phFound, highLBR, 1)
    bearCond := priceHH and cciLH and phFound

// Divergence plots with bright fluorescent colors
plot(
     plFound ? cciLBR : na,
     offset=-lookbackRight,
     title="Regular Bullish",
     linewidth=2,
     color=(bullCond ? bullColor : noneColor),
     display=display.pane,
     editable=calculateDivergence)

plotshape(
     bullCond ? cciLBR : na,
     offset=-lookbackRight,
     title="Regular Bullish Label",
     text=" Bull ",
     style=shape.labelup,
     location=location.absolute,
     color=bullColor,
     textcolor=color.black,
     display=display.pane,
     editable=calculateDivergence)

plot(
     phFound ? cciLBR : na,
     offset=-lookbackRight,
     title="Regular Bearish",
     linewidth=2,
     color=(bearCond ? bearColor : noneColor),
     display=display.pane,
     editable=calculateDivergence)

plotshape(
     bearCond ? cciLBR : na,
     offset=-lookbackRight,
     title="Regular Bearish Label",
     text=" Bear ",
     style=shape.labeldown,
     location=location.absolute,
     color=bearColor,
     textcolor=textColor,
     display=display.pane,
     editable=calculateDivergence)

// Comprehensive Alert System - Professional, No Emojis
alertcondition(extremeOversoldReversal, "Strong Buy", "Extreme oversold reversal signal")
alertcondition(extremeOverboughtReversal, "Strong Sell", "Extreme overbought reversal signal")
alertcondition(oversoldReversal, "Buy Signal", "Oversold reversal detected")
alertcondition(overboughtReversal, "Sell Signal", "Overbought reversal detected")
alertcondition(bullCond, title="Bullish Divergence", message="Bullish Divergence detected on CCI - Potential reversal UP")
alertcondition(bearCond, title="Bearish Divergence", message="Bearish Divergence detected on CCI - Potential reversal DOWN")
