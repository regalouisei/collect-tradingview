//@version=5
indicator("RSI + MFI (3-step gradients + separate backgrounds + RSI divergences)", shorttitle="RSI+MFI x3 + BG + Div", overlay=false)

// === USTAWIENIA PODSTAWOWE ===
rsiLen  = input.int(14, "RSI length", minval=2)
rsiSrc  = input.source(close, "RSI source")
mfiLen  = input.int(14, "MFI length", minval=2)

obRSI = input.float(70.0, "RSI Overbought", minval=50, maxval=100)
osRSI = input.float(30.0, "RSI Oversold",  minval=0,  maxval=50)

obMFI = input.float(80.0, "MFI Overbought", minval=50, maxval=100)
osMFI = input.float(20.0, "MFI Oversold",  minval=0,  maxval=50)

showMid = input.bool(true, "Pokaż linię 50")

// === KOLORY I GRUBOŚĆ LINI GŁÓWNYCH ===
rsiLineColor = input.color(color.purple, "Kolor linii RSI")
rsiLineWidth = input.int(2, "Grubość linii RSI", minval=1, maxval=5)
mfiLineColor = input.color(color.blue,   "Kolor linii MFI")
mfiLineWidth = input.int(2, "Grubość linii MFI", minval=1, maxval=5)

// === WSPÓLNE USTAWIENIA GRADIENTU (dla RSI i MFI) ===
gradObColor = input.color(#26A69A, "Gradient OB – kolor (oba)")
gradOsColor = input.color(#EF5350, "Gradient OS – kolor (oba)")
tNearLevel  = input.int(96, "Gradient: jaśniej przy poziomie", minval=60, maxval=100)
tNearLine   = input.int(55, "Gradient: ciemniej przy linii",   minval=0,  maxval=95)

// Stopnie przezroczystości (3)
trG1 = tNearLevel
trG2 = int(math.round(tNearLevel*0.5 + tNearLine*0.5))
trG3 = tNearLine

// === OSOBNE TŁA (oddzielne ustawienia) ===
// RSI 30–70
bgRsiOn = input.bool(true,  "Tło RSI 30–70")
bgRsiCol= input.color(color.purple, "Tło RSI – kolor")
bgRsiTr = input.int(94, "Tło RSI – transp %", minval=0, maxval=100)

// MFI 70–OB_MFI
bgMfiTopOn  = input.bool(true,  "Tło MFI 70–OB_MFI")
bgMfiTopCol = input.color(#26A69A, "Tło MFI góra – kolor")
bgMfiTopTr  = input.int(92, "Tło MFI góra – transp %", minval=0, maxval=100)

// MFI OS_MFI–30
bgMfiBotOn  = input.bool(true,  "Tło MFI OS_MFI–30")
bgMfiBotCol = input.color(#EF5350, "Tło MFI dół – kolor")
bgMfiBotTr  = input.int(92, "Tło MFI dół – transp %", minval=0, maxval=100)

// === MARKER: kropka pod MFI, gdy RSI & MFI < OS (zamiast kolorowania) ===
showOsDot   = input.bool(true,  "Kropka pod MFI, gdy RSI&MFI < OS")
osDotColor  = input.color(color.new(color.red, 0), "Kolor kropki")
osDotGap    = input.float(1.0, "Odstęp kropki od MFI (p.p.)", minval=0.0, maxval=10.0)
osDotWidth  = input.int(2, "Rozmiar kropki (linewidth)", minval=1, maxval=5)

// === USTAWIENIA DYWERGENCJI RSI (KNOTY) ===
leftBars       = input.int(5,  "Dywergencje: left bars",  minval=1, maxval=20)
rightBarsFast  = input.int(2,  "Dywergencje: right bars #1", minval=1, maxval=30)
rightBarsSlow  = input.int(10, "Dywergencje: right bars #2", minval=1, maxval=60)

showDivWicksFast = input.bool(true,  "Pokaż dywergencje KNOTY: Fast")
showDivWicksSlow = input.bool(true,  "Pokaż dywergencje KNOTY: Slow")

divBullColor   = input.color(color.lime, "Kolor dywergencji Bullish (knoty)")
divBearColor   = input.color(color.red,  "Kolor dywergencji Bearish (knoty)")
divWidth       = input.int(2, "Grubość linii (knoty)", minval=1, maxval=5)

// === USTAWIENIA DYWERGENCJI RSI (CIAŁA) ===
showDivBodiesFast = input.bool(true,  "Pokaż dywergencje CIAŁA: Fast")
showDivBodiesSlow = input.bool(true,  "Pokaż dywergencje CIAŁA: Slow")

divBodyBullColor  = input.color(color.new(color.lime, 0), "Kolor dywergencji Bullish (ciała)")
divBodyBearColor  = input.color(color.new(color.red,  0), "Kolor dywergencji Bearish (ciała)")
divBodyWidth      = input.int(2, "Grubość linii (ciała)", minval=1, maxval=5)

// === OBLICZENIA ===
rsi = ta.rsi(rsiSrc, rsiLen)
mfi = ta.mfi(hlc3, mfiLen)

// Linie główne
pRSI = plot(rsi, "RSI", color=color.new(rsiLineColor, 0), linewidth=rsiLineWidth, editable=false)
pMFI = plot(mfi, "MFI", color=color.new(mfiLineColor, 0), linewidth=mfiLineWidth, editable=false)
plot(showMid ? 50 : na, "50", color=color.new(color.gray, 85), editable=false)

// Poziomy (nieedytowalne)
pOB_RSI = plot(obRSI, "OB RSI", color=color.new(color.gray, 70), editable=false)
pOS_RSI = plot(osRSI, "OS RSI", color=color.new(color.gray, 70), editable=false)
pOB_MFI = plot(obMFI, "OB MFI", color=color.new(color.gray, 70), editable=false)
pOS_MFI = plot(osMFI, "OS MFI", color=color.new(color.gray, 70), editable=false)

// === TŁA STAŁE ===
fill(pOB_RSI, pOS_RSI, color = bgRsiOn    ? color.new(bgRsiCol,   bgRsiTr)   : na) // 30–70
fill(pOB_RSI, pOB_MFI, color = bgMfiTopOn ? color.new(bgMfiTopCol,bgMfiTopTr): na) // 70–OB_MFI
fill(pOS_RSI, pOS_MFI, color = bgMfiBotOn ? color.new(bgMfiBotCol,bgMfiBotTr): na) // OS_MFI–30

// === GRADIENT RSI (3 warstwy) ===
rsi_u1 = rsi > obRSI ? obRSI + (rsi - obRSI) * (1.0/3.0) : na
rsi_u2 = rsi > obRSI ? obRSI + (rsi - obRSI) * (2.0/3.0) : na
prsi_u1 = plot(rsi_u1, display=display.none, editable=false)
prsi_u2 = plot(rsi_u2, display=display.none, editable=false)

rsi_d1 = rsi < osRSI ? osRSI + (rsi - osRSI) * (1.0/3.0) : na
rsi_d2 = rsi < osRSI ? osRSI + (rsi - osRSI) * (2.0/3.0) : na
prsi_d1 = plot(rsi_d1, display=display.none, editable=false)
prsi_d2 = plot(rsi_d2, display=display.none, editable=false)

fill(pOB_RSI, prsi_u1, color=color.new(gradObColor, trG1))
fill(prsi_u1, prsi_u2, color=color.new(gradObColor, trG2))
fill(prsi_u2, pRSI,    color=color.new(gradObColor, trG3))
fill(pOS_RSI, prsi_d1, color=color.new(gradOsColor, trG1))
fill(prsi_d1, prsi_d2, color=color.new(gradOsColor, trG2))
fill(prsi_d2, pRSI,    color=color.new(gradOsColor, trG3))

// === GRADIENT MFI (3 warstwy) ===
mfi_u1 = mfi > obMFI ? obMFI + (mfi - obMFI) * (1.0/3.0) : na
mfi_u2 = mfi > obMFI ? obMFI + (mfi - obMFI) * (2.0/3.0) : na
pmfi_u1 = plot(mfi_u1, display=display.none, editable=false)
pmfi_u2 = plot(mfi_u2, display=display.none, editable=false)

mfi_d1 = mfi < osMFI ? osMFI + (mfi - osMFI) * (1.0/3.0) : na
mfi_d2 = mfi < osMFI ? osMFI + (mfi - osMFI) * (2.0/3.0) : na
pmfi_d1 = plot(mfi_d1, display=display.none, editable=false)
pmfi_d2 = plot(mfi_d2, display=display.none, editable=false)

fill(pOB_MFI, pmfi_u1, color=color.new(gradObColor, trG1))
fill(pmfi_u1, pmfi_u2, color=color.new(gradObColor, trG2))
fill(pmfi_u2, pMFI,    color=color.new(gradObColor, trG3))
fill(pOS_MFI, pmfi_d1, color=color.new(gradOsColor, trG1))
fill(pmfi_d1, pmfi_d2, color=color.new(gradOsColor, trG2))
fill(pmfi_d2, pMFI,    color=color.new(gradOsColor, trG3))

// === KROPKA POD MFI: RSI & MFI poniżej OS ===
bothOS = (rsi < osRSI) and (mfi < osMFI)
plot(showOsDot ? (bothOS ? (mfi - osDotGap) : na) : na,
     title="Dot MFI < OS & RSI < OS",
     style=plot.style_circles, color=osDotColor, linewidth=osDotWidth)

// === DYWERGENCJE RSI (KNOTY) — oryginalne ================================
// Zestaw #1: rightBarsFast
rsiPH_f = ta.pivothigh(rsi, leftBars, rightBarsFast)
rsiPL_f = ta.pivotlow(rsi,  leftBars, rightBarsFast)

var float prevRsiH_f = na
var float prevPriceAtRsiH_f = na
var int   prevRsiHBar_f = na

var float prevRsiL_f = na
var float prevPriceAtRsiL_f = na
var int   prevRsiLBar_f = na

if showDivWicksFast
    if not na(rsiPH_f) and bar_index > rightBarsFast
        float curRsiH_f    = rsiPH_f
        int   curRsiHBar_f = bar_index - rightBarsFast
        float curPriceH_f  = high[rightBarsFast]
        if not na(prevRsiH_f) and not na(prevPriceAtRsiH_f)
            bool priceHH_f = curPriceH_f > prevPriceAtRsiH_f
            bool rsiLH_f   = curRsiH_f   < prevRsiH_f
            bool firstInOB_f = prevRsiH_f > obRSI
            if priceHH_f and rsiLH_f and firstInOB_f
                line.new(prevRsiHBar_f, prevRsiH_f, curRsiHBar_f, curRsiH_f, xloc=xloc.bar_index, extend=extend.none, color=divBearColor, width=divWidth)
        prevRsiH_f        := curRsiH_f
        prevRsiHBar_f     := curRsiHBar_f
        prevPriceAtRsiH_f := curPriceH_f

    if not na(rsiPL_f) and bar_index > rightBarsFast
        float curRsiL_f    = rsiPL_f
        int   curRsiLBar_f = bar_index - rightBarsFast
        float curPriceL_f  = low[rightBarsFast]
        if not na(prevRsiL_f) and not na(prevPriceAtRsiL_f)
            bool priceLL_f = curPriceL_f < prevPriceAtRsiL_f
            bool rsiHL_f   = curRsiL_f   > prevRsiL_f
            bool firstInOS_f = prevRsiL_f < osRSI
            if priceLL_f and rsiHL_f and firstInOS_f
                line.new(prevRsiLBar_f, prevRsiL_f, curRsiLBar_f, curRsiL_f, xloc=xloc.bar_index, extend=extend.none, color=divBullColor, width=divWidth)
        prevRsiL_f        := curRsiL_f
        prevRsiLBar_f     := curRsiLBar_f
        prevPriceAtRsiL_f := curPriceL_f

// Zestaw #2: rightBarsSlow
rsiPH_s = ta.pivothigh(rsi, leftBars, rightBarsSlow)
rsiPL_s = ta.pivotlow(rsi,  leftBars, rightBarsSlow)

var float prevRsiH_s = na
var float prevPriceAtRsiH_s = na
var int   prevRsiHBar_s = na

var float prevRsiL_s = na
var float prevPriceAtRsiL_s = na
var int   prevRsiLBar_s = na

if showDivWicksSlow
    if not na(rsiPH_s) and bar_index > rightBarsSlow
        float curRsiH_s    = rsiPH_s
        int   curRsiHBar_s = bar_index - rightBarsSlow
        float curPriceH_s  = high[rightBarsSlow]
        if not na(prevRsiH_s) and not na(prevPriceAtRsiH_s)
            bool priceHH_s = curPriceH_s > prevPriceAtRsiH_s
            bool rsiLH_s   = curRsiH_s   < prevRsiH_s
            bool firstInOB_s = prevRsiH_s > obRSI
            if priceHH_s and rsiLH_s and firstInOB_s
                line.new(prevRsiHBar_s, prevRsiH_s, curRsiHBar_s, curRsiH_s, xloc=xloc.bar_index, extend=extend.none, color=divBearColor, width=divWidth)
        prevRsiH_s        := curRsiH_s
        prevRsiHBar_s     := curRsiHBar_s
        prevPriceAtRsiH_s := curPriceH_s

    if not na(rsiPL_s) and bar_index > rightBarsSlow
        float curRsiL_s    = rsiPL_s
        int   curRsiLBar_s = bar_index - rightBarsSlow
        float curPriceL_s  = low[rightBarsSlow]
        if not na(prevRsiL_s) and not na(prevPriceAtRsiL_s)
            bool priceLL_s = curPriceL_s < prevPriceAtRsiL_s
            bool rsiHL_s   = curRsiL_s   > prevRsiL_s
            bool firstInOS_s = prevRsiL_s < osRSI
            if priceLL_s and rsiHL_s and firstInOS_s
                line.new(prevRsiLBar_s, prevRsiL_s, curRsiLBar_s, curRsiL_s, xloc=xloc.bar_index, extend=extend.none, color=divBullColor, width=divWidth)
        prevRsiL_s        := curRsiL_s
        prevRsiLBar_s     := curRsiLBar_s
        prevPriceAtRsiL_s := curPriceL_s

// === DYWERGENCJE RSI (CIAŁA) ==============================================
bodyHighAt(idx) => math.max(open[idx], close[idx])
bodyLowAt(idx)  => math.min(open[idx],  close[idx])

// --- FAST (ciała)
var float prevRsiH_fb = na
var float prevPriceAtRsiH_fb = na
var int   prevRsiHBar_fb = na

var float prevRsiL_fb = na
var float prevPriceAtRsiL_fb = na
var int   prevRsiLBar_fb = na

if showDivBodiesFast
    if not na(rsiPH_f) and bar_index > rightBarsFast
        float curRsiH_fb    = rsiPH_f
        int   curRsiHBar_fb = bar_index - rightBarsFast
        float curPriceH_fb  = bodyHighAt(rightBarsFast)
        if not na(prevRsiH_fb) and not na(prevPriceAtRsiH_fb)
            bool priceHH_fb = curPriceH_fb > prevPriceAtRsiH_fb
            bool rsiLH_fb   = curRsiH_fb   < prevRsiH_fb
            bool firstInOB_fb = prevRsiH_fb > obRSI
            if priceHH_fb and rsiLH_fb and firstInOB_fb
                line.new(prevRsiHBar_fb, prevRsiH_fb, curRsiHBar_fb, curRsiH_fb, xloc=xloc.bar_index, extend=extend.none, color=divBodyBearColor, width=divBodyWidth)
        prevRsiH_fb        := curRsiH_fb
        prevRsiHBar_fb     := curRsiHBar_fb
        prevPriceAtRsiH_fb := curPriceH_fb

    if not na(rsiPL_f) and bar_index > rightBarsFast
        float curRsiL_fb    = rsiPL_f
        int   curRsiLBar_fb = bar_index - rightBarsFast
        float curPriceL_fb  = bodyLowAt(rightBarsFast)
        if not na(prevRsiL_fb) and not na(prevPriceAtRsiL_fb)
            bool priceLL_fb = curPriceL_fb < prevPriceAtRsiL_fb
            bool rsiHL_fb   = curRsiL_fb   > prevRsiL_fb
            bool firstInOS_fb = prevRsiL_fb < osRSI
            if priceLL_fb and rsiHL_fb and firstInOS_fb
                line.new(prevRsiLBar_fb, prevRsiL_fb, curRsiLBar_fb, curRsiL_fb, xloc=xloc.bar_index, extend=extend.none, color=divBodyBullColor, width=divBodyWidth)
        prevRsiL_fb        := curRsiL_fb
        prevRsiLBar_fb     := curRsiLBar_fb
        prevPriceAtRsiL_fb := curPriceL_fb

// --- SLOW (ciała)
var float prevRsiH_sb = na
var float prevPriceAtRsiH_sb = na
var int   prevRsiHBar_sb = na

var float prevRsiL_sb = na
var float prevPriceAtRsiL_sb = na
var int   prevRsiLBar_sb = na

if showDivBodiesSlow
    if not na(rsiPH_s) and bar_index > rightBarsSlow
        float curRsiH_sb    = rsiPH_s
        int   curRsiHBar_sb = bar_index - rightBarsSlow
        float curPriceH_sb  = bodyHighAt(rightBarsSlow)
        if not na(prevRsiH_sb) and not na(prevPriceAtRsiH_sb)
            bool priceHH_sb = curPriceH_sb > prevPriceAtRsiH_sb
            bool rsiLH_sb   = curRsiH_sb   < prevRsiH_sb
            bool firstInOB_sb = prevRsiH_sb > obRSI
            if priceHH_sb and rsiLH_sb and firstInOB_sb
                line.new(prevRsiHBar_sb, prevRsiH_sb, curRsiHBar_sb, curRsiH_sb, xloc=xloc.bar_index, extend=extend.none, color=divBodyBearColor, width=divBodyWidth)
        prevRsiH_sb        := curRsiH_sb
        prevRsiHBar_sb     := curRsiHBar_sb
        prevPriceAtRsiH_sb := curPriceH_sb

    if not na(rsiPL_s) and bar_index > rightBarsSlow
        float curRsiL_sb    = rsiPL_s
        int   curRsiLBar_sb = bar_index - rightBarsSlow
        float curPriceL_sb  = bodyLowAt(rightBarsSlow)
        if not na(prevRsiL_sb) and not na(prevPriceAtRsiL_sb)
            bool priceLL_sb = curPriceL_sb < prevPriceAtRsiL_sb
            bool rsiHL_sb   = curRsiL_sb   > prevRsiL_sb
            bool firstInOS_sb = prevRsiL_sb < osRSI
            if priceLL_sb and rsiHL_sb and firstInOS_sb
                line.new(prevRsiLBar_sb, prevRsiL_sb, curRsiLBar_sb, curRsiL_sb, xloc=xloc.bar_index, extend=extend.none, color=divBodyBullColor, width=divBodyWidth)
        prevRsiL_sb        := curRsiL_sb
        prevRsiLBar_sb     := curRsiLBar_sb
        prevPriceAtRsiL_sb := curPriceL_sb
