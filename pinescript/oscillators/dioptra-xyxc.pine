//@version=5
indicator('Dioptra ~XYXC', shorttitle="Dioptra", overlay=false)

// Mode selector with explanation tooltip
mode = input.string(    defval="Mode 1", title="Mode", options=["Mode 1", "Mode 2"], group="Mode",   tooltip="Disclaimer: This indicator is currently being refined and tailored to the price action of the Nasdaq Futures Mini contract (N1!) on the 1‑minute timeframe. It is provided for informational and educational purposes only and does not constitute financial, investment, or trading advice. Trading involves risk; past performance is not indicative of future results.\n\nMode Explanation:\nMode 1 was developed from semi-historical observations correlating favorable long setups when the oscillator’s columns rise through the −0.31 level after having been significantly lower—ideally at an extreme—for a non-brief period.\n\nMode 2 has been introduced based on favorable long and short opportunities observed when the oscillator—now displayed as a line—breaks, or is about to break, ascending or descending triangles at extreme levels.")

// Source
src = input.source(close, "Source", group="Source")

// Define input parameters
fast_period = input.int(title='Fast Period', defval=7, minval=1)
slow_period = input.int(title='Slow Period', defval=19, minval=1)
er_period   = input.int(title='Efficiency Ratio Period', defval=8, minval=1)
norm_period = input.int(title='Normalization lookback', defval=50, minval=1, group="Normalized Settings")
norm        = input.bool(defval=true, title="Use normalization", group="Normalized Settings")

col_up = input.color(#22ab94)
col_dn = input.color(#f75361)

// Calculate ER
change     = math.abs(src - src[er_period])
volatility = math.sum(math.abs(src - src[1]), er_period)
er         = change / volatility

// Smoothing constant and KAMA
sc   = er * (2 / (fast_period + 1) - 2 / (slow_period + 1)) + 2 / (slow_period + 1)
kama = ta.ema(src, fast_period) + sc * (src - ta.ema(src, fast_period))

// Normalize with divide-by-zero guard
lowest     = ta.lowest(kama, norm_period)
highest    = ta.highest(kama, norm_period)
normalized = (highest != lowest ? (kama - lowest) / (highest - lowest) - 0.5 : 0)

// Dynamic coloring based on slope
col_wn      = normalized < 0 ? (normalized < normalized[1] ? color.new(col_dn, 50) : color.new(col_dn, 75)) : (normalized > normalized[1] ? color.new(col_up, 50) : color.new(col_up, 75))
col_wn_line = normalized < 0 ? (normalized < normalized[1] ? color.new(col_dn, 0)  : color.new(col_dn, 40)) : (normalized > normalized[1] ? color.new(col_up, 0)  : color.new(col_up, 40))

// Plots (single-line statements)
plot(norm ? normalized : na, style=(mode == "Mode 2") ? plot.style_line : plot.style_columns, color=(mode == "Mode 2") ? col_wn_line : col_wn, linewidth=(mode == "Mode 2") ? 3 : 1, title="KAMA Oscillator Normalized")
plot(not norm ? kama : na, style=plot.style_columns, color=(kama < 0 ? (kama < kama[1] ? color.new(col_dn, 50) : color.new(col_dn, 75)) : (kama > kama[1] ? color.new(col_up, 50) : color.new(col_up, 75))), title="KAMA Oscillator")

// Threshold Line inputs — stays visible in both modes unless user hides it
showLine      = input.bool(true, "Show Threshold Line", group="Threshold Line")
lineDefault   = input.float(-0.31, "Initial Line Value", step=0.01, group="Threshold Line")
lineColor     = input.color(color.rgb(255, 255, 255), "Line Color", group="Threshold Line")
lineWidth     = input.int(1, "Line Width", minval=1, maxval=5, group="Threshold Line")
lineStyle     = input.string(line.style_solid, "Line Style", options=[line.style_solid, line.style_dotted, line.style_dashed], group="Threshold Line")

// Second threshold line inputs
lineDefault2  = input.float(0.31, "Initial Line Value 2", step=0.01, group="Threshold Line")
lineColor2    = input.color(color.rgb(255, 215, 255), "Line Color 2", group="Threshold Line") // gold by default to differentiate
lineWidth2    = input.int(1, "Line Width 2", minval=1, maxval=5, group="Threshold Line")
lineStyle2    = input.string(line.style_solid, "Line Style 2", options=[line.style_solid, line.style_dotted, line.style_dashed], group="Threshold Line")

// Movable horizontal lines
var line hlineMov  = na
var line hlineMov2 = na

if na(hlineMov)
    hlineMov := line.new(x1=bar_index - 1, y1=lineDefault,  x2=bar_index + 1, y2=lineDefault,  extend=extend.both, color=lineColor,  width=lineWidth,  style=lineStyle)
if na(hlineMov2)
    hlineMov2 := line.new(x1=bar_index - 1, y1=lineDefault2, x2=bar_index + 1, y2=lineDefault2, extend=extend.both, color=lineColor2, width=lineWidth2, style=lineStyle2)

if showLine
    // Line 1 updates
    line.set_color(hlineMov,  lineColor)
    line.set_width(hlineMov,  lineWidth)
    line.set_style(hlineMov,  lineStyle)
    line.set_extend(hlineMov, extend.both)
    // Line 2 updates
    line.set_color(hlineMov2, lineColor2)
    line.set_width(hlineMov2, lineWidth2)
    line.set_style(hlineMov2, lineStyle2)
    line.set_extend(hlineMov2, extend.both)
else
    // Hide both by collapsing to current bar and NaN y
    line.set_extend(hlineMov,  extend.none)
    line.set_x1(hlineMov,     bar_index)
    line.set_x2(hlineMov,     bar_index)
    line.set_y1(hlineMov,     na)
    line.set_y2(hlineMov,     na)

    line.set_extend(hlineMov2, extend.none)
    line.set_x1(hlineMov2,    bar_index)
    line.set_x2(hlineMov2,    bar_index)
    line.set_y1(hlineMov2,    na)
    line.set_y2(hlineMov2,    na)

// Fixed horizontal lines at -0.5 and 0.5
fixedLineColor = color.new(color.gray, 0)
fixedLineWidth = 1
fixedLineStyle = hline.style_dotted
hline(-0.5, 'Lower -0.5', color=fixedLineColor, linestyle=fixedLineStyle, linewidth=fixedLineWidth)
hline(0.5,  'Upper  0.5', color=fixedLineColor, linestyle=fixedLineStyle, linewidth=fixedLineWidth)
