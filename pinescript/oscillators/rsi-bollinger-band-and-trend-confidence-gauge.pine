//@version=6
indicator("RSI BB Trend Confidence Gauge", "RSIBB-Trend", overlay=false, max_bars_back=3000)

// ====================================================================
// RSI BB Trend Confidence Gauge
// ====================================================================

// ---------------------
// Helpers
// ---------------------
hma(src, len) =>
    ta.wma(2 * ta.wma(src, math.round(len / 2)) - ta.wma(src, len), math.round(math.sqrt(len)))

sec(tf, expr) =>
    request.security(syminfo.tickerid, tf, expr, gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)

rsiColor(v) =>
    isExtreme = (v > 70.0) or (v < 30.0)
    isExtreme ? color.orange : v > 50.0 ? color.green : v < 50.0 ? color.red : color.blue

// ---------------------
// Inputs
// ---------------------
adx_min = input.float(22.0, "Action ADX Minimum", minval=0, maxval=100, step=0.5)

// ---------------------
// Core Series (chart TF)
// ---------------------
price     = close
short_hma = hma(price, 13)
long_hma  = hma(price, 34)

hma_up   = short_hma > long_hma
hma_down = short_hma < long_hma

rsi_ct = ta.rsi(price, 14)
[dmiP_ct, dmiM_ct, adx_ct] = ta.dmi(14, 14)

// Alignment logic (trend)
trendUpAlign_CT = hma_up   and rsi_ct >= 50
trendDnAlign_CT = hma_down and rsi_ct < 50

// Ribbon color (lighter gray for conflict)
ribbon_color = trendUpAlign_CT ? color.lime : trendDnAlign_CT ? color.red : color.new(color.gray, 80)


// Absolute band anchors
plot(1,  title="DMV Bounds High", display=display.none)
plot(-1, title="DMV Bounds Low",  display=display.none)
plot(0,  title="Trend Ribbon", color=ribbon_color, style=plot.style_line, linewidth=60,
     display=display.all - display.price_scale - display.status_line)

// Direction (only alignment)
dirUp_CT = trendUpAlign_CT
dirDn_CT = trendDnAlign_CT

// Action (GO)
go_up_CT = dirUp_CT and (dmiP_ct > dmiM_ct) and (adx_ct >= adx_min)
go_dn_CT = dirDn_CT and (dmiM_ct > dmiP_ct) and (adx_ct >= adx_min)
go_CT    = go_up_CT or go_dn_CT

// ---------------------
// Orange Triangles (RSI & BB)
// ---------------------
rsi_os_cross = ta.crossunder(rsi_ct, 30)
rsi_ob_cross = ta.crossover(rsi_ct, 70)
plotshape(rsi_os_cross ? 0.0 : na, title="RSI OS", style=shape.triangleup,   location=location.absolute,
          color=color.orange, size=size.small, text="R", textcolor=color.black)
plotshape(rsi_ob_cross ? 0.0 : na, title="RSI OB", style=shape.triangledown, location=location.absolute,
          color=color.orange, size=size.small, text="R", textcolor=color.black)

bb_len = 20
bb_dev = 2.0
bb_basis = ta.sma(price, bb_len)
bb_std   = ta.stdev(price, bb_len)
bb_upper = bb_basis + bb_dev * bb_std
bb_lower = bb_basis - bb_dev * bb_std

bb_lower_cross = ta.crossunder(price, bb_lower)
bb_upper_cross = ta.crossover(price, bb_upper)

plotshape(bb_lower_cross ? 0.0 : na, title="BB Lower", style=shape.triangleup,   location=location.absolute,
          color=color.orange, size=size.small, text="B", textcolor=color.black)
plotshape(bb_upper_cross ? 0.0 : na, title="BB Upper", style=shape.triangledown, location=location.absolute,
          color=color.orange, size=size.small, text="B", textcolor=color.black)

// ---------------------
// DMV101T â€” 1 timeframe only
// ---------------------
var table dmv101t = na

if barstate.islastconfirmedhistory
    if na(dmv101t)
        dmv101t := table.new(position.bottom_center, 5, 2)

    // Header
    table.cell(dmv101t, 0, 0, "Time ",   bgcolor=color.black, text_color=color.white)
    table.cell(dmv101t, 1, 0, "RSI ",    bgcolor=color.black, text_color=color.white)
    table.cell(dmv101t, 2, 0, "Direction ",  bgcolor=color.black, text_color=color.white)
    table.cell(dmv101t, 3, 0, "Alignment ", bgcolor=color.black, text_color=color.white)
    table.cell(dmv101t, 4, 0, "Confidence",  bgcolor=color.black, text_color=color.white)

    // --- Current TF Row ---
    // Time
    table.cell(dmv101t, 0, 1, timeframe.period, bgcolor=color.black, text_color=color.white)

    // RSI
    table.cell(dmv101t, 1, 1, str.tostring(rsi_ct, "#.0"), bgcolor=rsiColor(rsi_ct), text_color=color.white)

    // Trend (aligned or conflict)
    trend_text =
         trendUpAlign_CT ? "UP" :
         trendDnAlign_CT ? "DOWN" :
         "Conflict"
    trend_bg =
         trendUpAlign_CT ? color.green :
         trendDnAlign_CT ? color.red :
         color.new(color.gray, 40)

    table.cell(dmv101t, 2, 1, trend_text, bgcolor=trend_bg, text_color=color.white)

    // ----- ACTION BOX (requested update) -----
    action_text = go_CT ? "VERIFIED" : ""
    action_bg = go_up_CT ? color.green : go_dn_CT ? color.red : color.new(color.gray, 70)

    table.cell(dmv101t, 3, 1, action_text, bgcolor=action_bg, text_color=color.white)

    // Confidence column (simple ADX tier)
    conf_text =
         adx_ct < 20 ? "Low" :
         adx_ct < 25 ? "Medium" :
         "High"
    conf_bg =
         adx_ct < 20 ? color.new(color.red, 10) :
         adx_ct < 25 ? color.new(color.orange, 10) :
         color.new(color.green, 10)

    table.cell(dmv101t, 4, 1, conf_text, bgcolor=conf_bg, text_color=color.black)
