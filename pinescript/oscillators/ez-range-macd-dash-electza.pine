//@version=5
indicator("EZ Range MACD + DASH - ELECTZA")

//-----------------------------------------------------
// INPUTS
//-----------------------------------------------------
fastLen     = input.int(12, "Fast Length")
slowLen     = input.int(26, "Slow Length")
signalLen   = input.int(9,  "Signal Length")
rangeLen    = input.int(20, "Range ATR Length")
rangeThresh = input.float(0.85, "Range Threshold")

//-----------------------------------------------------
// MACD CALCULATION
//-----------------------------------------------------
fastMA   = ta.ema(close, fastLen)
slowMA   = ta.ema(close, slowLen)
macdLine = fastMA - slowMA
signal   = ta.ema(macdLine, signalLen)
hist     = macdLine - signal

//-----------------------------------------------------
// RANGE DETECTOR
//-----------------------------------------------------
atrVal  = ta.atr(1)
atrAvg  = ta.sma(atrVal, rangeLen)
inRange = atrVal < atrAvg * rangeThresh

//-----------------------------------------------------
// SIGNAL ARROWS
//-----------------------------------------------------
buySignal  = not inRange and ta.crossover(macdLine, signal)
sellSignal = not inRange and ta.crossunder(macdLine, signal)

plotshape(buySignal,  title="BUY",  color=color.lime, style=shape.triangleup,   size=size.small, location=location.bottom)
plotshape(sellSignal, title="SELL", color=color.red,  style=shape.triangledown, size=size.small, location=location.top)

//-----------------------------------------------------
// IMPROVED OVERALL TREND (NOW RANGING SHOWS CORRECTLY)
//-----------------------------------------------------
// Trend conditions
bullCond = macdLine > signal and hist > 0
bearCond = macdLine < signal and hist < 0

// MACD compression = ranging/weak market
flatMACD = math.abs(macdLine - signal) < close * 0.0003
flatHist = math.abs(hist)      < close * 0.0002

// Final range logic
rangeLogic = inRange or (flatMACD and flatHist)

// Final overall output
overall =
     bullCond and not rangeLogic ? "BULLISH" :
     bearCond and not rangeLogic ? "BEARISH" :
     "RANGING"

overallCol =
     overall == "BULLISH" ? color.lime :
     overall == "BEARISH" ? color.red :
     color.orange

//-----------------------------------------------------
// FINAL SIGNAL
//-----------------------------------------------------
rec =
     inRange ? "WAIT" :
     overall == "BULLISH" ? "BUY" :
     overall == "BEARISH" ? "SELL" :
     "WAIT"

recCol =
     rec == "BUY" ? color.lime :
     rec == "SELL" ? color.red :
     color.orange

//-----------------------------------------------------
// FORCE PANEL TO RENDER
//-----------------------------------------------------
plot(0, display=display.none)

//-----------------------------------------------------
// MACD PLOTS
//-----------------------------------------------------
histColor = inRange ? color.new(color.gray, 75) :
             hist > 0 ? color.lime : color.red

plot(hist,   "Histogram", style=plot.style_histogram, color=histColor, linewidth=3)
plot(macdLine, "MACD", color=color.aqua, linewidth=2)
plot(signal,   "Signal", color=color.new(color.white, 20), linewidth=1)

//-----------------------------------------------------
// CLEAN DASHBOARD â€” ONLY OVERALL + SIGNAL
//-----------------------------------------------------
var table dash = table.new(position.bottom_right, 2, 3, border_width=1, frame_color=color.new(color.white,80))

white = color.white

// Header
table.cell(dash, 0, 0, "Metric", text_color=white, bgcolor=color.new(color.black,60))
table.cell(dash, 1, 0, "Value",  text_color=white, bgcolor=color.new(color.black,60))

// Overall Trend
table.cell(dash, 0, 1, "Overall", text_color=white)
table.cell(dash, 1, 1, overall, text_color=overallCol)

// Final Signal
table.cell(dash, 0, 2, "Signal", text_color=white)
table.cell(dash, 1, 2, rec, text_color=recCol)
