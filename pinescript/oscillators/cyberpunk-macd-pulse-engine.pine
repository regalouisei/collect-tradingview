//@version=5
indicator("Cyberpunk MACD Pulse Engine", overlay=false, precision=4, scale=scale.right)

// --- Settings (パラメーター設定) ---
grp_mode = "Tactical Mode / タクティカル・モード選択"
mode_select = input.string("Standard", "Preset Mode / プリセット・モード", 
     options=["Standard", "Fast (Scalp)", "Slow (Swing)", "Neural Spike", "Custom"], group=grp_mode)

// モード設定の定義
var int m_f = 12
var int m_s = 26
var int m_sig = 9

if mode_select == "Fast (Scalp)"
    m_f := 8, m_s := 21, m_sig := 5
else if mode_select == "Slow (Swing)"
    m_f := 24, m_s := 52, m_sig := 18
else if mode_select == "Neural Spike"
    m_f := 3, m_s := 10, m_sig := 2

grp_macd = "Engine Core / エンジンコア設定"
fast_len = input.int(12, "Fast Length / 短期期間 (Custom時のみ)", minval=1, group=grp_macd)
slow_len = input.int(26, "Slow Length / 長期期間 (Custom時のみ)", minval=1, group=grp_macd)
sig_len  = input.int(9, "Signal Smoothing / シグナル平滑化", minval=1, group=grp_macd)

calc_fast = mode_select == "Custom" ? fast_len : m_f
calc_slow = mode_select == "Custom" ? slow_len : m_s
calc_sig  = mode_select == "Custom" ? sig_len : m_sig

grp_div = "Anomaly Detection / ダイバージェンス検知"
show_div = input.bool(true, "Show Divergence / ダイバージェンスを表示", group=grp_div)
div_lookback = input.int(5, "Pivot Lookback / 参照期間", minval=2, group=grp_div)

grp_vis  = "Visual Effects / ビジュアル演出"
show_labels = input.bool(true, "Signal Labels (Triangles) / 売買予兆ラベル表示", group=grp_vis)
show_glow = input.bool(true, "Pulse Glow (Histogram) / ヒストグラム発光演出", group=grp_vis)

// --- Color Palette ---
color C_CYAN    = #00f2ff
color C_MAGENTA = #ff00ff
color C_GOLD    = #ffcc00
color C_WHITE   = #ffffff
color C_VOID    = color.new(#000000, 100)

// --- Calculations ---
[macd_line, signal_line, hist] = ta.macd(close, calc_fast, calc_slow, calc_sig)

// --- Divergence Logic ---
pl = ta.pivotlow(macd_line, div_lookback, div_lookback)
ph = ta.pivothigh(macd_line, div_lookback, div_lookback)

// Bullish Divergence
var float last_pl_price = na
var float last_pl_macd = na
var int last_pl_index = na
bull_div = false
if not na(pl)
    if low[div_lookback] < last_pl_price and macd_line[div_lookback] > last_pl_macd
        bull_div := true
    last_pl_price := low[div_lookback]
    last_pl_macd := macd_line[div_lookback]
    last_pl_index := bar_index[div_lookback]

// Bearish Divergence
var float last_ph_price = na
var float last_ph_macd = na
var int last_ph_index = na
bear_div = false
if not na(ph)
    if high[div_lookback] > last_ph_price and macd_line[div_lookback] < last_ph_macd
        bear_div := true
    last_ph_price := high[div_lookback]
    last_ph_macd := macd_line[div_lookback]
    last_ph_index := bar_index[div_lookback]

// --- Rendering ---
// MACD Lines
plot(macd_line, color=color.new(C_CYAN, 70), linewidth=3, title="MACD Glow")
plot(macd_line, color=C_CYAN, linewidth=1, title="MACD Core")
plot(signal_line, color=color.new(C_MAGENTA, 70), linewidth=3, title="Signal Glow")
plot(signal_line, color=C_MAGENTA, linewidth=1, title="Signal Core")

// Histogram
hist_col = hist >= 0 ? (hist > hist[1] ? color.new(C_CYAN, 20) : color.new(C_CYAN, 60)) : (hist < hist[1] ? color.new(C_MAGENTA, 20) : color.new(C_MAGENTA, 60))
plot(hist, title="Pulse Histogram", style=plot.style_columns, color=hist_col)
bgcolor(show_glow ? color.new(hist_col, 95) : na, title="Reactor Glow")

// Divergence Visuals (レーザーリンクとラベル)
if show_div and bull_div
    line.new(last_pl_index, last_pl_macd, bar_index[div_lookback], macd_line[div_lookback], color=C_CYAN, width=2, style=line.style_dashed)
    label.new(bar_index[div_lookback], macd_line[div_lookback], "ANOMALY: BULL", color=C_VOID, textcolor=C_CYAN, style=label.style_label_up, size=size.small)

if show_div and bear_div
    line.new(last_ph_index, last_ph_macd, bar_index[div_lookback], macd_line[div_lookback], color=C_MAGENTA, width=2, style=line.style_dashed)
    label.new(bar_index[div_lookback], macd_line[div_lookback], "ANOMALY: BEAR", color=C_VOID, textcolor=C_MAGENTA, style=label.style_label_down, size=size.small)

// Signal Icons (Crossover) - 正確に描画されるように修正
cross_up = ta.crossover(macd_line, signal_line)
cross_dn = ta.crossunder(macd_line, signal_line)
plotshape(show_labels ? (cross_up ? macd_line : na) : na, "System Reboot", shape.triangleup, location.absolute, color.new(C_CYAN, 0), size=size.tiny)
plotshape(show_labels ? (cross_dn ? macd_line : na) : na, "System Critical", shape.triangledown, location.absolute, color.new(C_MAGENTA, 0), size=size.tiny)

// --- HUD Table (統合されたデータフィードバック) ---
var table hud = table.new(position.top_right, 2, 4, bgcolor=C_VOID)
if barstate.islast
    string macd_status = hist >= 0 ? "POSITIVE" : "NEGATIVE"
    color macd_st_col = hist >= 0 ? C_CYAN : C_MAGENTA
    string scan_status = show_div ? "ACTIVE" : "OFFLINE"
    color scan_st_col = show_div ? C_CYAN : color.gray

    // 1. Tactical Mode
    table.cell(hud, 0, 0, "TACTICAL MODE:", text_color=color.new(C_WHITE, 50), text_size=size.tiny, text_halign=text.align_right)
    table.cell(hud, 1, 0, mode_select, text_color=C_GOLD, text_size=size.small, text_halign=text.align_left)
    // 2. MACD System Status (復元)
    table.cell(hud, 0, 1, "SYSTEM STATUS:", text_color=color.new(C_WHITE, 50), text_size=size.tiny, text_halign=text.align_right)
    table.cell(hud, 1, 1, macd_status, text_color=macd_st_col, text_size=size.small, text_halign=text.align_left)
    // 3. Scanner Status (連動)
    table.cell(hud, 0, 2, "SCANNER:", text_color=color.new(C_WHITE, 50), text_size=size.tiny, text_halign=text.align_right)
    table.cell(hud, 1, 2, scan_status, text_color=scan_st_col, text_size=size.small, text_halign=text.align_left)
