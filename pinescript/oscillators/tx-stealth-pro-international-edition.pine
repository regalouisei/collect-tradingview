//@version=6
indicator("TX Stealth Pro: International Edition", overlay=true)

// ==========================================
// --- 1. UI DECORATION FUNCTIONS ---
// ==========================
f_draw_cell(_tab, _col, _row, _text, _t_clr, _bg_clr, _t_size) =>
    table.cell(_tab, _col, _row, _text, text_color=_t_clr, bgcolor=_bg_clr, text_size=_t_size, text_halign=text.align_center, text_valign=text.align_center)

// ==========================================
// --- 2. CONFIGURATION & COLORS ---
// ==========================================
grp_ma    = "Trend Settings (Custom MA)"
ma_type   = input.string("EMA", "Method", options=["SMA", "EMA"], group=grp_ma)
ma_len    = input.int(12, "Length", minval=1, group=grp_ma)

// Deep Orange & Light Peach (Optimized contrast)
C_UP_DEEP = #C14A1C 
C_DN_NEON = #FFDFA6 

grp_ui    = "Visual Interface"
C_PURP    = #E040FB // Daily Open: Electric Purple
C_Y_HI    = #FF5252 // Night High: Neon Red
C_Y_LO    = #00FFCC // Night Low: Aurora Green
table_pos = input.string("Middle Right", "Panel Position", options=["Top Right", "Middle Right", "Bottom Right"], group=grp_ui)

// Stealth Dashboard Theme
C_BG_DASH  = color.new(#09090b, 10)  
C_BG_HEAD  = color.new(#18181b, 0)   
C_BORDER   = color.new(#3f3f46, 40)  
C_TEXT_DIM = #a1a1aa                

// ==========================================
// --- 3. CORE LOGIC (Session Data) ---
// ==========================================
is_day_start   = (hour == 8 and minute == 45)
is_day_session = (hour == 8 and minute >= 45) or (hour > 8 and hour < 13) or (hour == 13 and minute <= 45)
is_nit_session = (hour >= 15) or (hour < 5)

var float d_op = na, var float d_hi = na, var float d_lo = na
var float n_hi = na, var float n_lo = na
var float t_n_hi = na, var float t_n_lo = na

var line l_op = na, var label lb_op = na
var line l_nh = na, var label lb_nh = na
var line l_nl = na, var label lb_nl = na

if is_nit_session
    t_n_hi := math.max(nz(t_n_hi, high), high)
    t_n_lo := math.min(nz(t_n_lo, low), low)

if is_day_start
    d_op := open, d_hi := high, d_lo := low
    n_hi := t_n_hi, n_lo := t_n_lo
    t_n_hi := na, t_n_lo := na 

    line.delete(l_op), label.delete(lb_op)
    line.delete(l_nh), label.delete(lb_nh)
    line.delete(l_nl), label.delete(lb_nl)
    
    // Day Open
    l_op := line.new(bar_index, d_op, bar_index + 1, d_op, color=C_PURP, width=2, extend=extend.right)
    lb_op := label.new(bar_index, d_op, "⚡ OPEN: " + str.tostring(d_op, "#"), color=color.new(color.white, 100), textcolor=C_PURP, style=label.style_label_lower_left, size=size.small)

    if not na(n_hi)
        l_nh := line.new(bar_index, n_hi, bar_index + 1, n_hi, color=C_Y_HI, width=1, style=line.style_dotted, extend=extend.right)
        lb_nh := label.new(bar_index, n_hi, "NIGHT HI: " + str.tostring(n_hi, "#"), color=color.new(color.white, 100), textcolor=C_Y_HI, style=label.style_label_lower_left, size=size.small)
        
        l_nl := line.new(bar_index, n_lo, bar_index + 1, n_lo, color=C_Y_LO, width=1, style=line.style_dotted, extend=extend.right)
        lb_nl := label.new(bar_index, n_lo, "NIGHT LO: " + str.tostring(n_lo, "#"), color=color.new(color.white, 100), textcolor=C_Y_LO, style=label.style_label_upper_left, size=size.small)

else if is_day_session
    d_hi := math.max(nz(d_hi, high), high)
    d_lo := math.min(nz(d_lo, low), low)
    label.set_x(lb_op, bar_index + 2)
    label.set_x(lb_nh, bar_index + 2)
    label.set_x(lb_nl, bar_index + 2)

// --- Trend Calculation ---
float ma = switch ma_type
    "SMA" => ta.sma(close, ma_len)
    "EMA" => ta.ema(close, ma_len)
up = ma > ma[1]
c_ma = up ? C_UP_DEEP : C_DN_NEON
rng = (not na(d_hi) and not na(d_lo)) ? (d_hi - d_lo) : 0

// ==========================================
// --- 4. PLOTTING ---
// ==========================================
barcolor(is_day_start ? C_PURP : na, title="Open Bar")
plot(ma, "Trend Shadow", color=color.new(c_ma, 80), linewidth=6)
plot(ma, "Trend Line", color=c_ma, linewidth=2)

// ==========================================
// --- 5. DASHBOARD UI (Refined Size) ---
// ==========================================
pos = table_pos == "Top Right" ? position.top_right : table_pos == "Bottom Right" ? position.bottom_right : position.middle_right
var table dash = table.new(pos, 2, 6, bgcolor=C_BG_DASH, border_width=1, border_color=C_BORDER)

if barstate.islast
    // Header
    f_draw_cell(dash, 0, 0, "TERMINAL", color.white, C_BG_HEAD, size.small)
    f_draw_cell(dash, 1, 0, "TX PRO V1", color.white, C_BG_HEAD, size.small)
    
    // Stats Rows - Reduced Font Size for Compact Look
    f_draw_cell(dash, 0, 1, "RANGE", C_TEXT_DIM, color.new(color.white, 100), size.small)
    f_draw_cell(dash, 1, 1, str.tostring(rng, "#") + " PT", #F59E0B, color.new(color.white, 100), size.normal)
    
    f_draw_cell(dash, 0, 2, "OPEN", C_TEXT_DIM, color.new(color.white, 100), size.small)
    f_draw_cell(dash, 1, 2, str.tostring(d_op, "#"), C_PURP, color.new(color.white, 100), size.normal)
    
    f_draw_cell(dash, 0, 3, "NIT HI", C_TEXT_DIM, color.new(color.white, 100), size.small)
    f_draw_cell(dash, 1, 3, str.tostring(n_hi, "#"), C_Y_HI, color.new(color.white, 100), size.normal)
    
    f_draw_cell(dash, 0, 4, "NIT LO", C_TEXT_DIM, color.new(color.white, 100), size.small)
    f_draw_cell(dash, 1, 4, str.tostring(n_lo, "#"), C_Y_LO, color.new(color.white, 100), size.normal)
    
    // Trend Status
    ma_label = ma_type + "(" + str.tostring(ma_len) + ")"
    f_draw_cell(dash, 0, 5, ma_label, C_TEXT_DIM, color.new(color.white, 100), size.small)
    f_draw_cell(dash, 1, 5, up ? "▲ BUY" : "▼ SELL", c_ma, color.new(color.white, 100), size.normal)
