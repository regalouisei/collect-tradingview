// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © dunesisland

//@version=6
indicator('Earnings Day - Price Predictor [DunesIsland]', overlay = true)

lookback_years = input.int(10, title = 'Lookback Years', minval = 1)

// Fetch earnings data using request.earnings
earnings_eps = request.earnings(syminfo.tickerid, field = earnings.actual, gaps = barmerge.gaps_on)
is_earnings_day = not na(earnings_eps) and na(earnings_eps[1])

// Calculate percentage change on the bar
pct_change = (close - close[1]) / close[1] * 100

// Arrays to store historical data (var persists across bars)
var array<float> earnings_pcts = array.new<float>()
var array<int> earnings_times = array.new<int>()
var array<int> earnings_bars = array.new<int>()
var array<int> earnings_quarters = array.new<int>()

// Collect data on earnings days
if is_earnings_day
    array.push(earnings_pcts, pct_change)
    array.push(earnings_times, time)
    array.push(earnings_bars, bar_index)
    report_month = month(time)
    report_q = math.floor((report_month - 1) / 3) + 1
    reported_q = report_q == 1 ? 4 : report_q - 1
    array.push(earnings_quarters, reported_q)

// On the last bar, process and display
if barstate.islast
    // Calculate cutoff time (approximate milliseconds in 10 years)
    days_in_year = 365.25
    lookback_ms = lookback_years * days_in_year * 86400 * 1000
    cutoff_time = time - lookback_ms

    // Variables for overall calculations
    var float overall_pos_sum = 0.0
    var int overall_pos_count = 0
    var float overall_neg_sum = 0.0
    var int overall_neg_count = 0
    var int latest_time = na
    var int latest_q = na

    // First pass: collect overall positives/negatives and find latest
    for i = 0 to array.size(earnings_times) - 1 by 1
        t = array.get(earnings_times, i)
        if t >= cutoff_time
            pct = array.get(earnings_pcts, i)
            if pct >= 0
                overall_pos_sum := overall_pos_sum + pct
                overall_pos_count := overall_pos_count + 1
                overall_pos_count
            else
                overall_neg_sum := overall_neg_sum + pct
                overall_neg_count := overall_neg_count + 1
                overall_neg_count

            if na(latest_time) or t > latest_time
                latest_time := t
                latest_q := array.get(earnings_quarters, i)
                latest_q

    // Calculate next quarter
    var int next_q = na
    if not na(latest_q)
        next_q := latest_q == 4 ? 1 : latest_q + 1
        next_q

    // Variables for seasonal calculations
    var float seasonal_pos_sum = 0.0
    var int seasonal_pos_count = 0
    var float seasonal_neg_sum = 0.0
    var int seasonal_neg_count = 0

    // Second pass: collect seasonal positives/negatives for next_q
    if not na(next_q)
        for i = 0 to array.size(earnings_times) - 1 by 1
            t = array.get(earnings_times, i)
            if t >= cutoff_time and t < latest_time
                q = array.get(earnings_quarters, i)
                if q == next_q
                    pct = array.get(earnings_pcts, i)
                    if pct >= 0
                        seasonal_pos_sum := seasonal_pos_sum + pct
                        seasonal_pos_count := seasonal_pos_count + 1
                        seasonal_pos_count
                    else
                        seasonal_neg_sum := seasonal_neg_sum + pct
                        seasonal_neg_count := seasonal_neg_count + 1
                        seasonal_neg_count

    // Calculate averages
    overall_pos_avg = overall_pos_count > 0 ? overall_pos_sum / overall_pos_count : na
    overall_neg_avg = overall_neg_count > 0 ? overall_neg_sum / overall_neg_count : na
    seasonal_pos_avg = seasonal_pos_count > 0 ? seasonal_pos_sum / seasonal_pos_count : na
    seasonal_neg_avg = seasonal_neg_count > 0 ? seasonal_neg_sum / seasonal_neg_count : na

    overall_total = overall_pos_count + overall_neg_count
    seasonal_total = seasonal_pos_count + seasonal_neg_count

    // Create table for display
    var table display_table = table.new(position = position.bottom_right, columns = 2, rows = 5, border_width = 1, frame_width = 1)

    // Lookback row
    table.cell(display_table, 0, 0, 'Lookback:', text_color = color.white, bgcolor = color.gray)
    table.cell(display_table, 1, 0, str.tostring(lookback_years) + ' Years', text_color = color.white, bgcolor = color.gray)

    // Average Change (Green)
    table.cell(display_table, 0, 1, 'Average Change (Green):', text_color = color.white, bgcolor = color.gray)
    overall_pos_str = na(overall_pos_avg) ? 'N/A' : str.format('{0,number,#.##}% ({1}/{2})', overall_pos_avg, overall_pos_count, overall_total)
    table.cell(display_table, 1, 1, overall_pos_str, text_color = color.green, bgcolor = color.gray)

    // Average Change (Red)
    table.cell(display_table, 0, 2, 'Average Change (Red):', text_color = color.white, bgcolor = color.gray)
    overall_neg_str = na(overall_neg_avg) ? 'N/A' : str.format('{0,number,#.##}% ({1}/{2})', overall_neg_avg, overall_neg_count, overall_total)
    table.cell(display_table, 1, 2, overall_neg_str, text_color = color.red, bgcolor = color.gray)

    // Seasonality Change (Green)
    table.cell(display_table, 0, 3, 'Seasonality Change (Green):', text_color = color.white, bgcolor = color.gray)
    seasonal_pos_str = na(seasonal_pos_avg) ? 'N/A' : str.format('{0,number,#.##}% ({2}/{3})', seasonal_pos_avg, next_q, seasonal_pos_count, seasonal_total)
    table.cell(display_table, 1, 3, seasonal_pos_str, text_color = color.green, bgcolor = color.gray)

    // Seasonality Change (Red)
    table.cell(display_table, 0, 4, 'Seasonality Change (Red):', text_color = color.white, bgcolor = color.gray)
    seasonal_neg_str = na(seasonal_neg_avg) ? 'N/A' : str.format('{0,number,#.##}% ({2}/{3})', seasonal_neg_avg, next_q, seasonal_neg_count, seasonal_total)
    table.cell(display_table, 1, 4, seasonal_neg_str, text_color = color.red, bgcolor = color.gray)

    // Display labels for recent earnings
    for i = 0 to array.size(earnings_times) - 1 by 1
        t = array.get(earnings_times, i)
        if t >= cutoff_time
            pct = array.get(earnings_pcts, i)
            bi = array.get(earnings_bars, i)
            pct_str = str.format('{0,number,#.##}%', pct)
            col = pct >= 0 ? color.green : color.red
            styl = label.style_label_center
            ylocv = yloc.price
            label.new(x = bi, y = 0, text = pct_str, yloc = ylocv, color = col, style = styl, textcolor = color.white, size = size.small)
