//@version=5
// ADX（平均方向性指数）はトレンドの強さを測るオシレーターです。
indicator("Wilder's ADX/DI", shorttitle="ADX/DI", overlay=false)

// パラメーター（期間N）の設定
length = input.int(14, title="ADX期間", minval=1)

// -----------------------------------------------------------------------------
// 1. Directional Movement (DM) と True Range (TR) の計算
// -----------------------------------------------------------------------------

// 前の足のデータ
prevHigh = high[1]
prevLow = low[1]
prevClose = close[1]

// 現在の価格差
upMove = high - prevHigh
downMove = prevLow - low

// +DM と -DM の決定
plusDM = upMove > downMove and upMove > 0 ? upMove : 0
minusDM = downMove > upMove and downMove > 0 ? downMove : 0

// True Range (TR) の計算
tr = math.max(math.abs(high - low), math.abs(high - prevClose), math.abs(low - prevClose))

// -----------------------------------------------------------------------------
// 2. DM と TR の平滑化（ワイルダーの移動平均 - SMMA）
// -----------------------------------------------------------------------------

// ワイルダーの移動平均（SMMA）関数を定義
// SMMAは、最初のN期間の単純平均を使用し、その後は以下の式で平滑化します。
wilders_smoothing(src, len) =>
    // 最初の平滑化値はSMA（単純移動平均）を使用
    smma = 0.0
    smma := na(smma[1]) ? ta.sma(src, len) : (smma[1] * (len - 1) + src) / len

// 平滑化の実行
smoothPlusDM = wilders_smoothing(plusDM, length)
smoothMinusDM = wilders_smoothing(minusDM, length)
smoothTR = wilders_smoothing(tr, length)

// -----------------------------------------------------------------------------
// 3. Directional Indicator (DI) の計算
// -----------------------------------------------------------------------------

// 平滑化されたTRがゼロでない場合のみDIを計算
plusDI = smoothTR != 0 ? smoothPlusDM / smoothTR * 100 : 0
minusDI = smoothTR != 0 ? smoothMinusDM / smoothTR * 100 : 0

// -----------------------------------------------------------------------------
// 4. Directional Movement Index (DX) と Average Directional Index (ADX) の計算
// -----------------------------------------------------------------------------

// DXの計算
dx = smoothTR != 0 ? math.abs(plusDI - minusDI) / (plusDI + minusDI) * 100 : 0

// ADXの計算（DXのSMMA）
adx = wilders_smoothing(dx, length)

// -----------------------------------------------------------------------------
// 5. プロット（描画）
// -----------------------------------------------------------------------------

// ADXをプロット
plot(adx, title="ADX", color=color.rgb(102, 153, 255), linewidth=2)

// +DIをプロット（上昇トレンドの方向性）
plot(plusDI, title="+DI", color=color.green, linewidth=1)

// -DIをプロット（下降トレンドの方向性）
plot(minusDI, title="-DI", color=color.red, linewidth=1)

// ADXの参考となる水平ライン（例: 25, 50）
hline(25, "トレンドライン", color=color.gray, linestyle=hline.style_dotted)
hline(50, "強いトレンド", color=color.gray, linestyle=hline.style_dotted)
