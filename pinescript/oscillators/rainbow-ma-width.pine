//@version=6
indicator("Rainbow MA Width", overlay=false)

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë                       RAINBOW MA WIDTH                                       ‚ïë
// ‚ïë              Ribbon Width Analysis for Rainbow MA Cloud                      ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
//
// üìè Description:
// Companion indicator for Rainbow MA Cloud. Displays ribbon width as Z-Score
// to visualize trend momentum expansion and contraction relative to recent history.
//
// üéØ Z-Score Interpretation:
// ‚Ä¢ 0 = Average width (ÌèâÍ∑†)
// ‚Ä¢ +1 to +2 = Expanding (ÌôïÏû• Ï§ë, Í∞ïÌïú Ï∂îÏÑ∏)
// ‚Ä¢ -1 to -2 = Contracting (ÏàòÏ∂ï Ï§ë, Ï∂îÏÑ∏ ÏïΩÌôî)
// ‚Ä¢ Beyond ¬±2 = Extreme (Í∑πÎã®Í∞í, Î∞òÏ†Ñ Í∞ÄÎä•ÏÑ±)

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñê‚ñà‚ñå INPUTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

grp_ma = "üìä MA LENGTHS"
ma1Len = input.int(8, "MA 1 (Fastest)", minval=2, maxval=50, group=grp_ma)
ma2Len = input.int(13, "MA 2", minval=5, maxval=100, group=grp_ma)
ma3Len = input.int(21, "MA 3", minval=10, maxval=150, group=grp_ma)
ma4Len = input.int(34, "MA 4", minval=15, maxval=200, group=grp_ma)
ma5Len = input.int(55, "MA 5", minval=20, maxval=300, group=grp_ma)
ma6Len = input.int(89, "MA 6", minval=30, maxval=400, group=grp_ma)
ma7Len = input.int(144, "MA 7", minval=50, maxval=500, group=grp_ma)
ma8Len = input.int(233, "MA 8 (Slowest)", minval=100, maxval=600, group=grp_ma)

grp_type = "‚öôÔ∏è MA TYPE"
maType = input.string("EMA", "MA Type", options=["EMA", "SMA", "WMA", "VWMA", "HMA"], group=grp_type)

grp_width = "üìè WIDTH SETTINGS"
widthMode = input.string("Outer", "Width Mode", options=["Outer", "Average Gap", "Total Gap"], tooltip="Outer: |MA1 - MA8|\nAverage Gap: Average of adjacent MA gaps\nTotal Gap: Sum of adjacent MA gaps", group=grp_width)
zScoreLen = input.int(20, "Z-Score Period", minval=10, maxval=200, tooltip="Period for calculating mean and standard deviation.", group=grp_width)
showZoneFill = input.bool(true, "Show Zone Fill", group=grp_width)
showRawWidth = input.bool(false, "Show Raw Width (secondary)", tooltip="Show original width % as secondary line.", group=grp_width)

grp_viz = "üé® VISUALIZATION"
zScoreColor = input.color(#2196F3, "Z-Score Line Color", group=grp_viz)
expandColor = input.color(#00BCD4, "Expanding Color", group=grp_viz)
contractColor = input.color(#FF9800, "Contracting Color", group=grp_viz)
extremeColor = input.color(#FFEB3B, "Extreme Warning Color", group=grp_viz)
showAlignmentBg = input.bool(true, "Show Alignment Background", group=grp_viz)

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñê‚ñà‚ñå MA CALCULATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

calcMA(src, len, matype) =>
    switch matype
        "EMA" => ta.ema(src, len)
        "SMA" => ta.sma(src, len)
        "WMA" => ta.wma(src, len)
        "VWMA" => ta.vwma(src, len)
        "HMA" => ta.hma(src, len)
        => ta.ema(src, len)

ma1 = calcMA(close, ma1Len, maType)
ma2 = calcMA(close, ma2Len, maType)
ma3 = calcMA(close, ma3Len, maType)
ma4 = calcMA(close, ma4Len, maType)
ma5 = calcMA(close, ma5Len, maType)
ma6 = calcMA(close, ma6Len, maType)
ma7 = calcMA(close, ma7Len, maType)
ma8 = calcMA(close, ma8Len, maType)

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñê‚ñà‚ñå WIDTH CALCULATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Check alignment
bool bullishAlignment = ma1 > ma2 and ma2 > ma3 and ma3 > ma4 and ma4 > ma5 and ma5 > ma6 and ma6 > ma7 and ma7 > ma8
bool bearishAlignment = ma1 < ma2 and ma2 < ma3 and ma3 < ma4 and ma4 < ma5 and ma5 < ma6 and ma6 < ma7 and ma7 < ma8

// Calculate width based on mode
float ribbonWidth = 0.0

switch widthMode
    "Outer" =>
        ribbonWidth := math.abs(ma1 - ma8) / close * 100
    "Average Gap" =>
        float gap1 = math.abs(ma1 - ma2)
        float gap2 = math.abs(ma2 - ma3)
        float gap3 = math.abs(ma3 - ma4)
        float gap4 = math.abs(ma4 - ma5)
        float gap5 = math.abs(ma5 - ma6)
        float gap6 = math.abs(ma6 - ma7)
        float gap7 = math.abs(ma7 - ma8)
        ribbonWidth := ((gap1 + gap2 + gap3 + gap4 + gap5 + gap6 + gap7) / 7) / close * 100
    "Total Gap" =>
        float gap1 = math.abs(ma1 - ma2)
        float gap2 = math.abs(ma2 - ma3)
        float gap3 = math.abs(ma3 - ma4)
        float gap4 = math.abs(ma4 - ma5)
        float gap5 = math.abs(ma5 - ma6)
        float gap6 = math.abs(ma6 - ma7)
        float gap7 = math.abs(ma7 - ma8)
        ribbonWidth := (gap1 + gap2 + gap3 + gap4 + gap5 + gap6 + gap7) / close * 100

// Z-Score calculation
float widthMean = ta.sma(ribbonWidth, zScoreLen)
float widthStdev = ta.stdev(ribbonWidth, zScoreLen)
float zScore = widthStdev > 0 ? (ribbonWidth - widthMean) / widthStdev : 0

// Z-Score status
bool isExpanding = zScore > 0
bool isExtremeHigh = zScore > 2
bool isExtremeLow = zScore < -2

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñê‚ñà‚ñå VISUALIZATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Alignment background (Ï†ïÎ∞∞Ïó¥: green, Ïó≠Î∞∞Ïó¥: red)
color alignBgColor = bullishAlignment ? color.new(#00E676, 92) : bearishAlignment ? color.new(#FF5252, 92) : na
bgcolor(showAlignmentBg ? alignBgColor : na, title="Alignment Background")

// Reference lines
hline(0, "Zero (Mean)", color=color.new(#FFFFFF, 50), linestyle=hline.style_solid, linewidth=1)
hline(2, "+2œÉ (Extreme)", color=color.new(extremeColor, 60), linestyle=hline.style_dashed)
hline(-2, "-2œÉ (Extreme)", color=color.new(extremeColor, 60), linestyle=hline.style_dashed)
hline(1, "+1œÉ", color=color.new(#666666, 70), linestyle=hline.style_dotted)
hline(-1, "-1œÉ", color=color.new(#666666, 70), linestyle=hline.style_dotted)

// Z-Score line
plot(zScore, "Z-Score", color=zScoreColor, linewidth=2)

// Raw width (optional secondary axis)
plot(showRawWidth ? ribbonWidth : na, "Raw Width %", color=color.new(#888888, 50), linewidth=1, display=display.all)

// Fill zones
p_zscore = plot(zScore, display=display.none)
p_zero = plot(0, display=display.none)
bool isExtreme = isExtremeHigh or isExtremeLow
fillColor = isExtreme ? color.new(extremeColor, 80) : isExpanding ? color.new(expandColor, 85) : color.new(contractColor, 85)
fill(p_zscore, p_zero, color=showZoneFill ? fillColor : na, title="Z-Score Fill")

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñê‚ñà‚ñå ALERTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

alertcondition(ta.crossover(zScore, 0), title="Z-Score Cross Above Zero", message="üìà Rainbow Width: Z-Score crossed ABOVE zero on {{ticker}} - Expanding")
alertcondition(ta.crossunder(zScore, 0), title="Z-Score Cross Below Zero", message="üìâ Rainbow Width: Z-Score crossed BELOW zero on {{ticker}} - Contracting")
alertcondition(ta.crossover(zScore, 2), title="Z-Score Extreme High", message="‚ö†Ô∏è Rainbow Width: Z-Score > +2œÉ on {{ticker}} - Extreme expansion")
alertcondition(ta.crossunder(zScore, -2), title="Z-Score Extreme Low", message="‚ö†Ô∏è Rainbow Width: Z-Score < -2œÉ on {{ticker}} - Extreme contraction")
