//@version=6
indicator("Percentile-Based BB% Trend - Mattes", shorttitle="PBB% Trend", overlay=false, max_bars_back=500)

// Inputs
length = input.int(36, title="Lookback Length", minval=1)
mult = input.float(0.15, title="MAD Multiplier", minval=0.05, step=0.05)
source = input.source(close, title="Source")

// Calculate 25th and 75th percentiles
p25 = ta.percentile_linear_interpolation(source, length, 25)
p75 = ta.percentile_linear_interpolation(source, length, 75)

// Basis = midpoint of percentiles
basis = (p25 + p75) / 2

// Median Absolute Deviation for robust volatility
mad = ta.median(math.abs(source - ta.median(source, length)), length)
dev = mult * mad

// Upper and lower bands
upper = basis + dev
lower = basis - dev

// Percentile-Based Bollinger %B equivalent
// Measures where price is within the percentile bands (0 = at lower band, 1 = at upper band)
pb_percent = (source - lower) / (upper - lower)

// Smoothed version for trend signals (optional light smoothing to reduce noise)
smoothLength = input.int(9, title="EMA Smoothing Length for Trend Line", minval=1)
pb_trend = ta.ema(pb_percent, smoothLength)

// Plots
hline(0, "Midline", color=color.new(color.white, 60), linestyle=hline.style_dotted)

// Bar coloring on price chart (your brand long/short style)
// Bullish when price is in upper half of bands (>0.5), Bearish when in lower half (<0.5)
bullColor = color.rgb(45, 162, 252)
bearColor = color.rgb(113, 59, 249)
syscol = pb_trend > 0 ? color.rgb(45, 162, 252) : color.rgb(113, 59, 249)
neutralColor = color.new(color.gray, 60)

PositiveChange = pb_trend > pb_trend[1]
NegativeChange = pb_trend < pb_trend[1]
var color col = #4caf50
if pb_trend > 0 and PositiveChange
    col := color.rgb(45, 162, 252)
if pb_trend > 0 and NegativeChange
    col := #1095fa
if pb_trend < 0 and NegativeChange
    col := color.rgb(113, 59, 249)
if pb_trend < 0 and PositiveChange
    col := #5418eb



// Plot the oscillator as columns
plot(
 pb_trend, 
 'pb_trend', 
 color = col, 
 style = plot.style_columns)

plotcandle(open, high, low, close, 'BarColor', color = syscol, bordercolor = syscol, wickcolor = syscol,force_overlay = true)

// Alerts
alertcondition(ta.crossover(pb_trend, 0), title="Bullish Trend Shift", message="PBB% Trend crossing above midline")
alertcondition(ta.crossunder(pb_trend, 0), title="Bearish Trend Shift", message="PBB% Trend crossing below midline")
