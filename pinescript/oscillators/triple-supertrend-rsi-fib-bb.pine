//@version=5
indicator("Triple SuperTrend + RSI + Fib BB", overlay=true, max_labels_count=500)

// ========================
// INPUT PARAMETERS
// ========================

// SuperTrend Parameters
st1_period = 10
st1_mult = 1.0
st2_period = 11
st2_mult = 2.0
st3_period = 12
st3_mult = 3.0

// RSI Parameters
rsi_length = 7
rsi_source = close

// Fibonacci Bollinger Bands Parameters
bb_length = 200
bb_mult = 2.618

// ========================
// SUPERTREND CALCULATION
// ========================

// SuperTrend Function
f_supertrend(atr_period, multiplier) =>
    atr = ta.atr(atr_period)
    hl2_val = hl2
    
    upper_band = hl2_val + (multiplier * atr)
    lower_band = hl2_val - (multiplier * atr)
    
    var float final_upper = na
    var float final_lower = na
    var int trend = 1
    
    final_upper := na(final_upper[1]) ? upper_band : upper_band < final_upper[1] or close[1] > final_upper[1] ? upper_band : final_upper[1]
    final_lower := na(final_lower[1]) ? lower_band : lower_band > final_lower[1] or close[1] < final_lower[1] ? lower_band : final_lower[1]
    
    trend := close > final_upper[1] ? 1 : close < final_lower[1] ? -1 : nz(trend[1], 1)
    
    supertrend = trend == 1 ? final_lower : final_upper
    [supertrend, trend]

// Calculate three SuperTrends
[st1, trend1] = f_supertrend(st1_period, st1_mult)
[st2, trend2] = f_supertrend(st2_period, st2_mult)
[st3, trend3] = f_supertrend(st3_period, st3_mult)

// ========================
// RSI CALCULATION
// ========================

rsi = ta.rsi(rsi_source, rsi_length)

// ========================
// FIBONACCI BOLLINGER BANDS
// ========================

bb_basis = ta.sma(close, bb_length)
bb_dev = ta.stdev(close, bb_length)
bb_upper = bb_basis + (bb_mult * bb_dev)
bb_lower = bb_basis - (bb_mult * bb_dev)

// ========================
// SIGNAL LOGIC
// ========================

// All SuperTrends bullish/bearish
all_bullish = trend1 == 1 and trend2 == 1 and trend3 == 1
all_bearish = trend1 == -1 and trend2 == -1 and trend3 == -1

// Previous bar status
all_bullish_prev = trend1[1] == 1 and trend2[1] == 1 and trend3[1] == 1
all_bearish_prev = trend1[1] == -1 and trend2[1] == -1 and trend3[1] == -1

// BUY Signal: All three SuperTrends turn green AND RSI > 50
buy_signal = all_bullish and not all_bullish_prev and rsi > 50

// SELL Signal: All three SuperTrends turn red AND RSI < 50
sell_signal = all_bearish and not all_bearish_prev and rsi < 50

// EXIT Logic
// Exit when any SuperTrend changes color OR price touches Fib BB
any_st_change = (trend1 != trend1[1]) or (trend2 != trend2[1]) or (trend3 != trend3[1])
bb_touch = close >= bb_upper or close <= bb_lower

// Track if we're in a position
var bool in_position = false
var bool was_buy = false
var int entry_bar = 0

// Update position status
if buy_signal
    in_position := true
    was_buy := true
    entry_bar := bar_index
else if sell_signal
    in_position := true
    was_buy := false
    entry_bar := bar_index

// Exit condition (only when in position, not on entry bar, and conditions met)
exit_condition = (any_st_change or bb_touch)
exit_signal = in_position and exit_condition and bar_index > entry_bar

if exit_signal
    in_position := false
    entry_bar := 0

// ========================
// PLOTTING
// ========================

// Plot SuperTrends with different opacities
plot(st1, "SuperTrend 1", color=trend1 == 1 ? color.new(color.green, 0) : color.new(color.red, 0), linewidth=1)
plot(st2, "SuperTrend 2", color=trend2 == 1 ? color.new(color.green, 40) : color.new(color.red, 40), linewidth=1)
plot(st3, "SuperTrend 3", color=trend3 == 1 ? color.new(color.green, 70) : color.new(color.red, 70), linewidth=1)

// Plot Fibonacci Bollinger Bands
plot(bb_upper, "Fib BB Upper", color=color.new(color.purple, 50), linewidth=1)
plot(bb_basis, "Fib BB Basis", color=color.new(color.gray, 50), linewidth=1, style=plot.style_cross)
plot(bb_lower, "Fib BB Lower", color=color.new(color.purple, 50), linewidth=1)

// Fill between bands
fill_color = color.new(color.purple, 95)
bb_upper_plot = plot(bb_upper, display=display.none)
bb_lower_plot = plot(bb_lower, display=display.none)
fill(bb_upper_plot, bb_lower_plot, color=fill_color)

// Background tint
bgcolor(all_bullish ? color.new(color.green, 95) : all_bearish ? color.new(color.red, 95) : na, title="Trend Background")

// ========================
// LABELS
// ========================

// BUY Label
if buy_signal
    label.new(bar_index, low, "BUY", style=label.style_triangleup, color=color.new(color.green, 0), textcolor=color.white, size=size.normal, yloc=yloc.belowbar)

// SELL Label
if sell_signal
    label.new(bar_index, high, "SELL", style=label.style_triangledown, color=color.new(color.red, 0), textcolor=color.white, size=size.normal, yloc=yloc.abovebar)

// EXIT Label
if exit_signal
    label.new(bar_index, high, "X", style=label.style_triangledown, color=color.new(color.yellow, 0), textcolor=color.black, size=size.small, yloc=yloc.abovebar)

// ========================
// ALERTS
// ========================

alertcondition(buy_signal, title="BUY Signal", message="Triple SuperTrend BUY Signal - All 3 ST Bullish + RSI > 50")
alertcondition(sell_signal, title="SELL Signal", message="Triple SuperTrend SELL Signal - All 3 ST Bearish + RSI < 50")
alertcondition(exit_signal, title="EXIT Signal", message="EXIT Signal - SuperTrend Change or Fib BB Touch")

// ========================
// DASHBOARD (Optional Info)
// ========================

// Create info table
var table info_table = table.new(position.top_right, 2, 6, bgcolor=color.new(color.black, 80), border_width=1)

if barstate.islast
    table.cell(info_table, 0, 0, "Indicator", text_color=color.white, bgcolor=color.new(color.blue, 70))
    table.cell(info_table, 1, 0, "Status", text_color=color.white, bgcolor=color.new(color.blue, 70))
    
    table.cell(info_table, 0, 1, "ST1 (10,1)", text_color=color.white)
    table.cell(info_table, 1, 1, trend1 == 1 ? "ðŸŸ¢ UP" : "ðŸ”´ DOWN", text_color=trend1 == 1 ? color.lime : color.red)
    
    table.cell(info_table, 0, 2, "ST2 (11,2)", text_color=color.white)
    table.cell(info_table, 1, 2, trend2 == 1 ? "ðŸŸ¢ UP" : "ðŸ”´ DOWN", text_color=trend2 == 1 ? color.lime : color.red)
    
    table.cell(info_table, 0, 3, "ST3 (12,3)", text_color=color.white)
    table.cell(info_table, 1, 3, trend3 == 1 ? "ðŸŸ¢ UP" : "ðŸ”´ DOWN", text_color=trend3 == 1 ? color.lime : color.red)
    
    table.cell(info_table, 0, 4, "RSI(7)", text_color=color.white)
    table.cell(info_table, 1, 4, str.tostring(math.round(rsi, 2)), text_color=rsi > 50 ? color.lime : color.red)
    
    table.cell(info_table, 0, 5, "Position", text_color=color.white)
    table.cell(info_table, 1, 5, in_position ? (was_buy ? "LONG" : "SHORT") : "NONE", 
               text_color=in_position ? (was_buy ? color.lime : color.red) : color.gray)
