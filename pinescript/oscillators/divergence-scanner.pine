//@version=5
indicator("Precise Divergence Strategy", overlay=true, max_lines_count=50, max_labels_count=20)

// ============================================
// ุฅุนุฏุงุฏุงุช ุงููุคุดุฑุงุช - ููุง ูู ุงูููุฏูู
// ============================================

// MACD
macd_fast = input.int(12, "MACD Fast Length", group="MACD Settings")
macd_slow = input.int(26, "MACD Slow Length", group="MACD Settings")
macd_signal = input.int(9, "MACD Signal Length", group="MACD Settings")

// Stochastic RSI
rsi_length = input.int(8, "RSI Length", group="Stochastic RSI Settings")
stoch_length = input.int(5, "Stochastic Length", group="Stochastic RSI Settings")
stoch_k = input.int(5, "K Smoothing", group="Stochastic RSI Settings")
stoch_d = input.int(5, "D Smoothing", group="Stochastic RSI Settings")

// ุฅุนุฏุงุฏุงุช ุงููุดู ุงูุฏููู
pivot_strength = input.int(5, "Pivot Strength (Left & Right)", minval=3, maxval=10, group="Divergence Detection")
max_lookback = input.int(50, "Maximum Lookback Range", minval=20, maxval=100, group="Divergence Detection")
min_pivot_distance = input.int(10, "Minimum Distance Between Pivots", minval=5, maxval=30, group="Divergence Detection")

// ููุงุชุฑ ุงูุฌูุฏุฉ
min_stoch_divergence = input.float(5.0, "Min Stochastic Divergence %", minval=3.0, maxval=20.0, group="Quality Filters")
require_strong_uptrend = input.bool(true, "Require Strong Uptrend (Daily + Current)", group="Quality Filters")
min_bars_since_signal = input.int(20, "Min Bars Since Last Signal", minval=10, maxval=50, group="Quality Filters")

// ============================================
// ุญุณุงุจ ุงููุคุดุฑุงุช
// ============================================

// MACD
[macdLine, macdSignal, macdHist] = ta.macd(close, macd_fast, macd_slow, macd_signal)

// Stochastic RSI
rsi = ta.rsi(close, rsi_length)
stochRSI = ta.stoch(rsi, rsi, rsi, stoch_length)
stochK = ta.sma(stochRSI, stoch_k)
stochD = ta.sma(stochK, stoch_d)

// ุงูุงุชุฌุงู - ุงููุฑูู ุงูุญุงูู
ema50_current = ta.ema(close, 50)
ema200_current = ta.ema(close, 200)
uptrend_current = ema50_current > ema200_current

// ุงูุงุชุฌุงู - ุงููููู
ema50_daily = request.security(syminfo.tickerid, "D", ta.ema(close, 50), lookahead=barmerge.lookahead_off)
ema200_daily = request.security(syminfo.tickerid, "D", ta.ema(close, 200), lookahead=barmerge.lookahead_off)
uptrend_daily = ema50_daily > ema200_daily

// ุงูููุชุฑ ุงูููุงุฆู ููุงุชุฌุงู
strong_uptrend = require_strong_uptrend ? (uptrend_current and uptrend_daily) : uptrend_current

// ============================================
// ูุดู ุงูููุนุงู ุงููุคูุฏุฉ ุจุฏูุฉ ุนุงููุฉ
// ============================================

// ุงุณุชุฎุฏุงู ta.pivotlow ููุญุตูู ุนูู ููุนุงู ูุคูุฏุฉ ููุท
pricePivotLow = ta.pivotlow(low, pivot_strength, pivot_strength)
macdPivotLow = ta.pivotlow(macdLine, pivot_strength, pivot_strength)
stochPivotLow = ta.pivotlow(stochK, pivot_strength, pivot_strength)

// ============================================
// ุชุฎุฒูู ุงูููุนุงู ุงููุคูุฏุฉ ุงูุซูุงุซุฉ ูุนุงู ููุท
// ============================================

var array<float> confirmed_price_lows = array.new<float>()
var array<int> confirmed_bars = array.new<int>()
var array<float> confirmed_macd_lows = array.new<float>()
var array<float> confirmed_stoch_lows = array.new<float>()

// ุนูุฏูุง ูุชู ุชุฃููุฏ ูุงุน ุนูู ุงูุณุนุฑุ ูุชุญูู ูู ูุฌูุฏ ููุนุงู ูุคูุฏุฉ ุนูู ุงููุคุดุฑุงุช ูู ููุณ ุงูููุทูุฉ
if not na(pricePivotLow)
    
    pivot_bar = bar_index - pivot_strength
    pivot_price = low[pivot_strength]
    
    // ุงูุจุญุซ ุนู ูุงุน MACD ูู ููุณ ุงูููุทูุฉ (ยฑ3 ุดููุน)
    var float matched_macd = na
    var float matched_stoch = na
    
    for i = 0 to 6
        offset = i - 3
        check_bar = pivot_bar + offset
        
        if check_bar >= 0 and check_bar < bar_index
            bar_diff = bar_index - check_bar
            
            // ุชุญูู ูู ูุฌูุฏ ูุงุน MACD
            if not na(ta.pivotlow(macdLine, pivot_strength, pivot_strength)[bar_diff])
                matched_macd := macdLine[bar_diff]
            
            // ุชุญูู ูู ูุฌูุฏ ูุงุน Stochastic
            if not na(ta.pivotlow(stochK, pivot_strength, pivot_strength)[bar_diff])
                matched_stoch := stochK[bar_diff]
    
    // ููุท ุฅุฐุง ูุฌุฏูุง ุงูููุนุงู ุงูุซูุงุซุฉ ูุชุทุงุจูุฉ
    if not na(matched_macd) and not na(matched_stoch)
        array.push(confirmed_price_lows, pivot_price)
        array.push(confirmed_bars, pivot_bar)
        array.push(confirmed_macd_lows, matched_macd)
        array.push(confirmed_stoch_lows, matched_stoch)
        
        // ุงูุงุญุชูุงุธ ุจุขุฎุฑ 15 ูุงุน ููุท
        if array.size(confirmed_price_lows) > 15
            array.shift(confirmed_price_lows)
            array.shift(confirmed_bars)
            array.shift(confirmed_macd_lows)
            array.shift(confirmed_stoch_lows)

// ============================================
// ูุญุต ุงูุฏููุฑุฌูุณ ุจุดุฑูุท ุตุงุฑูุฉ ุฌุฏุงู
// ============================================

var int last_divergence_bar = 0
divergence_detected = false

if array.size(confirmed_price_lows) >= 2 and strong_uptrend
    
    array_size = array.size(confirmed_price_lows)
    
    // ุงููุงุน ุงูุฃุญุฏุซ
    current_price = array.get(confirmed_price_lows, array_size - 1)
    current_bar = array.get(confirmed_bars, array_size - 1)
    current_macd = array.get(confirmed_macd_lows, array_size - 1)
    current_stoch = array.get(confirmed_stoch_lows, array_size - 1)
    
    // ูุญุต ููุงุจู ุงูููุนุงู ุงูุณุงุจูุฉ
    for i = array_size - 2 to math.max(0, array_size - 8)
        
        previous_price = array.get(confirmed_price_lows, i)
        previous_bar = array.get(confirmed_bars, i)
        previous_macd = array.get(confirmed_macd_lows, i)
        previous_stoch = array.get(confirmed_stoch_lows, i)
        
        bars_between = current_bar - previous_bar
        bars_since_last = bar_index - last_divergence_bar
        
        // ุงูุชุญูู ูู ุงููุณุงูุฉ ุงูุฒูููุฉ
        if bars_between >= min_pivot_distance and bars_between <= max_lookback and bars_since_last >= min_bars_since_signal
            
            // ============================================
            // ุงูุดุฑูุท ุงูุฏูููุฉ ููุฏููุฑุฌูุณ (ูู ุงูููุฏูู):
            // 
            // 1. ุงูุณุนุฑ: ุงููุงุน ุงูุญุงูู ุฃุฏูู ูู ุงููุงุน ุงูุณุงุจู (ูุฒูู)
            // 2. MACD: ุงููุงุน ุงูุญุงูู ุฃุฏูู ูู ุงููุงุน ุงูุณุงุจู (ูุฒูู - ูุชุทุงุจู ูุน ุงูุณุนุฑ)
            // 3. Stochastic: ุงููุงุน ุงูุญุงูู ุฃุนูู ูู ุงููุงุน ุงูุณุงุจู (ุตุนูุฏ - ุฏููุฑุฌูุณ!)
            // 4. ูุฌุจ ุฃู ูููู ูุฑู Stochastic ูุงุถุญ ูููู
            // ============================================
            
            condition_price_lower = current_price < previous_price
            condition_macd_lower = current_macd < previous_macd
            condition_stoch_higher = current_stoch > previous_stoch
            
            // ุญุณุงุจ ููุฉ ุงูุฏููุฑุฌูุณ
            stoch_divergence_strength = ((current_stoch - previous_stoch) / previous_stoch) * 100
            
            // ููุชุฑ ุฅุถุงูู: ูุฌุจ ุฃู ูููู ุงูุณุนุฑ ูุฏ ุงูุฎูุถ ุจุดูู ูุงุถุญ
            price_drop_percent = ((current_price - previous_price) / previous_price) * 100
            
            // ุฌููุน ุงูุดุฑูุท ูุฌุจ ุฃู ุชุชุญูู
            if condition_price_lower and condition_macd_lower and condition_stoch_higher
                
                // ุงูุฏููุฑุฌูุณ ูุฌุจ ุฃู ูููู ููู ุจูุง ูููู
                if stoch_divergence_strength >= min_stoch_divergence and price_drop_percent < -1.0
                    
                    divergence_detected := true
                    last_divergence_bar := bar_index
                    
                    // ุฑุณู ุฎุท ุงูุณุนุฑ
                    line.new(previous_bar, previous_price, current_bar, current_price, 
                             color=color.new(color.red, 0), 
                             width=4, 
                             style=line.style_solid)
                    
                    // ุชุณููุฉ ููุตูุฉ
                    label_text = "๐ฅ BUY SIGNAL\n" + 
                                 "โโโโโโโโโโโโโโ\n" +
                                 "DIVERGENCE CONFIRMED\n\n" +
                                 "๐ Price: " + str.tostring(price_drop_percent, "#.##") + "%\n" +
                                 str.tostring(previous_price, format.mintick) + " โ " + str.tostring(current_price, format.mintick) + "\n\n" +
                                 "๐ MACD: Lower Low โฌ\n" +
                                 str.tostring(previous_macd, "#.####") + " โ " + str.tostring(current_macd, "#.####") + "\n\n" +
                                 "๐ Stoch RSI: +" + str.tostring(stoch_divergence_strength, "#.##") + "% โฌ\n" +
                                 str.tostring(previous_stoch, "#.##") + " โ " + str.tostring(current_stoch, "#.##") + "\n\n" +
                                 "โ Uptrend: Active\n" +
                                 "Bars between: " + str.tostring(bars_between)
                    
                    label.new(current_bar, current_price, 
                             text=label_text,
                             style=label.style_label_up, 
                             color=color.new(color.green, 0), 
                             textcolor=color.white, 
                             size=size.large,
                             textalign=text.align_left)
                    
                    // ุฅุดุงุฑุฉ ุตูุชูุฉ
                    break

// ============================================
// ุงูุฑุณููุงุช
// ============================================

// ุฅุดุงุฑุฉ ุงูุดุฑุงุก
plotshape(divergence_detected, "Buy Signal", 
          shape.triangleup, 
          location.belowbar, 
          color=color.new(color.lime, 0), 
          size=size.large,
          offset=-pivot_strength)

// ุฎุทูุท EMA
plot(ema50_current, "EMA 50", color=color.new(color.blue, 30), linewidth=2)
plot(ema200_current, "EMA 200", color=color.new(color.orange, 30), linewidth=2)

// ุฎูููุฉ ุงูุงุชุฌุงู
bgcolor(strong_uptrend ? color.new(color.green, 97) : color.new(color.red, 97), title="Trend")

// ุนูุงูุฉ ุนูู ุงูููุนุงู ุงููุคูุฏุฉ
plotshape(not na(pricePivotLow) and not na(macdPivotLow) and not na(stochPivotLow), 
          "Confirmed Pivot", 
          shape.circle, 
          location.belowbar, 
          color=color.new(color.yellow, 40), 
          size=size.tiny,
          offset=-pivot_strength)

// ============================================
// ุชูุจููุงุช
// ============================================

alertcondition(divergence_detected, "High Quality Divergence", "๐ฅ HIGH QUALITY DIVERGENCE SIGNAL!")
