//@version=6
indicator(title="Advanced Dynamic RSI Pro", shorttitle="RSI Dynamic", format=format.price, precision=2, timeframe="", timeframe_gaps=true)

// --- RSI Settings ---
rsiLengthInput = input.int(14, minval=1, title="RSI Length", group="RSI Settings")
rsiSourceInput = input.source(close, "Source", group="RSI Settings")
calculateDivergence = input.bool(false, title="Calculate Divergence", group="RSI Settings")

// RSI Calculation
change = ta.change(rsiSourceInput)
up = ta.rma(math.max(change, 0), rsiLengthInput)
down = ta.rma(-math.min(change, 0), rsiLengthInput)
rsi = down == 0 ? 100 : up == 0 ? 0 : 100 - (100 / (1 + up / down))

// --- Visual Bands & Levels ---
// Default RSI Plot: Hidden by default, Thin line
rsiPlot = plot(rsi, "RSI", color=#7E57C2, linewidth=1, display=display.none)

// Precisely Configured Horizontal Lines
// 80, 60, 40, 20: Solid, Medium Width (2)
// 70, 30: Dashed, Medium Width (2)
// 50: Solid, Thin Width (1)
level80 = hline(80, "80 Level", color=color.new(#ff5252, 0),  linestyle=hline.style_solid,  linewidth=2)
level70 = hline(70, "70 Level", color=color.new(#ff5252, 40), linestyle=hline.style_dashed, linewidth=2)
level60 = hline(60, "60 Level", color=color.new(#64ffda, 60), linestyle=hline.style_solid,  linewidth=2)
level50 = hline(50, "50 Level", color=color.new(#ffeb3b, 0),  linestyle=hline.style_solid,  linewidth=1)
level40 = hline(40, "40 Level", color=color.new(#ff5252, 60), linestyle=hline.style_solid,  linewidth=2)
level30 = hline(30, "30 Level", color=color.new(#64ffda, 40), linestyle=hline.style_dashed, linewidth=2)
level20 = hline(20, "20 Level", color=color.new(#64ffda, 0),  linestyle=hline.style_solid,  linewidth=2)

// Default Range Fill: Hidden by default
fill(level70, level30, color=color.rgb(126, 87, 194, 90), title="RSI Range Fill", display=display.none)

// --- Moving Average Settings ---
GRP_MA = "MA Smoothing & Colors"
maTypeInput = input.string("SMA", "MA Type", options = ["None", "SMA", "EMA", "SMMA (RMA)", "WMA", "VWMA"], group = GRP_MA)
maLengthInput = input.int(14, "MA Length", group = GRP_MA)

// MA Color Inputs
c70p   = input.color(color.red, "70+ Color", group=GRP_MA)
c60_70 = input.color(color.green, "60-70 Color", group=GRP_MA)
c40_60 = input.color(color.yellow, "40-60 Color", group=GRP_MA)
c30_40 = input.color(color.red, "30-40 Color", group=GRP_MA)
c_u30  = input.color(color.green, "30- Color", group=GRP_MA)

// MA Calculation
ma_calc(src, len, type) =>
    switch type
        "SMA"        => ta.sma(src, len)
        "EMA"        => ta.ema(src, len)
        "SMMA (RMA)" => ta.rma(src, len)
        "WMA"        => ta.wma(src, len)
        "VWMA"       => ta.vwma(src, len)
        => na

smoothingMA = maTypeInput != "None" ? ma_calc(rsi, maLengthInput, maTypeInput) : na

// Dynamic MA Coloring Logic
maDynamicColor = if smoothingMA > 70
    c70p
else if smoothingMA >= 60
    c60_70
else if smoothingMA >= 40
    c40_60
else if smoothingMA >= 30
    c30_40
else
    c_u30

// RSI-based MA: Fixed to Thin linewidth (1)
plot(smoothingMA, "RSI-based MA", color=maDynamicColor, linewidth=1, display = maTypeInput != "None" ? display.all : display.none)

// --- Divergence Logic ---
lookbackRight = 5
lookbackLeft = 5
rangeUpper = 60
rangeLower = 5

plFound = not na(ta.pivotlow(rsi, lookbackLeft, lookbackRight))
phFound = not na(ta.pivothigh(rsi, lookbackLeft, lookbackRight))

barsSincePL = ta.barssince(plFound)
barsSincePH = ta.barssince(phFound)

rsiLBR = rsi[lookbackRight]
lowLBR = low[lookbackRight]
highLBR = high[lookbackRight]

valWhenPL_rsi  = ta.valuewhen(plFound, rsiLBR, 1)
valWhenPL_low  = ta.valuewhen(plFound, lowLBR, 1)
valWhenPH_rsi  = ta.valuewhen(phFound, rsiLBR, 1)
valWhenPH_high = ta.valuewhen(phFound, highLBR, 1)

inRangePL = barsSincePL[1] >= rangeLower and barsSincePL[1] <= rangeUpper
inRangePH = barsSincePH[1] >= rangeLower and barsSincePH[1] <= rangeUpper

bullCond = calculateDivergence and plFound and rsiLBR > valWhenPL_rsi and lowLBR < valWhenPL_low and inRangePL
bearCond = calculateDivergence and phFound and rsiLBR < valWhenPH_rsi and highLBR > valWhenPH_high and inRangePH

// Plots for Divergence
plot(bullCond ? rsiLBR : na, offset = -lookbackRight, title = "Bull Pivot", color = color.green, linewidth = 2, style = plot.style_linebr)
plotshape(bullCond ? rsiLBR : na, offset = -lookbackRight, title = "Bull Label", text = "BULL", style = shape.labelup, location = location.absolute, color = color.green, textcolor = color.white, display=display.none)
plot(bearCond ? rsiLBR : na, offset = -lookbackRight, title = "Bear Pivot", color = color.red, linewidth = 2, style = plot.style_linebr)
plotshape(bearCond ? rsiLBR : na, offset = -lookbackRight, title = "Bear Label", text = "BEAR", style = shape.labeldown, location = location.absolute, color = color.red, textcolor = color.white, display=display.none)
