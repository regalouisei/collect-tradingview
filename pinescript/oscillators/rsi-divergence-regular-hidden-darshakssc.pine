//@version=6
indicator("RSI Divergence Pro (Regular + Hidden, Dashboard, @darshakssc)", 
     overlay = true, max_lines_count = 500, max_labels_count = 500)

//----------------------------------------------------
// INPUTS
//----------------------------------------------------
src         = input.source(close, "RSI Source")
rsiLength   = input.int(14, "RSI Length")

leftBars    = input.int(2, "Left Swing Bars")
rightBars   = input.int(2, "Right Swing Bars")
minDistBars = input.int(5, "Min Bars Between Swings")
minRsiDiff  = input.float(2.0, "Min RSI Difference")

showRegular = input.bool(true, "Show Regular Divergence")
showHidden  = input.bool(true, "Show Hidden Divergence")
showLines   = input.bool(true, "Show Divergence Lines")
showLabels  = input.bool(true, "Show Divergence Labels")

enableAlerts = input.bool(true, "Enable Alerts")
singleFire   = input.bool(true, "Single Alert per Pivot")

showDashboard = input.bool(true, "Show Dashboard")
dashLocation  = input.string("Top Right", "Dashboard Position", options = ["Top Right","Top Left","Bottom Right","Bottom Left"])

//----------------------------------------------------
// POSITION MAP
//----------------------------------------------------
f_dashPos(str) =>
    str == "Top Left"     ? position.top_left : str == "Top Right"    ? position.top_right : str == "Bottom Left"  ? position.bottom_left : position.bottom_right

//----------------------------------------------------
// RSI
//----------------------------------------------------
rsi = ta.rsi(src, rsiLength)

//----------------------------------------------------
// SWING PIVOTS
//----------------------------------------------------
pricePivotHigh = ta.pivothigh(high, leftBars, rightBars)
pricePivotLow  = ta.pivotlow(low,  leftBars, rightBars)

rsiPivotHigh = ta.pivothigh(rsi, leftBars, rightBars)
rsiPivotLow  = ta.pivotlow(rsi,  leftBars, rightBars)

//----------------------------------------------------
// TRACK LAST 2 PIVOTS (FIXED VAR DECLARATIONS)
//----------------------------------------------------

// Lows
var int   lowBar1    = na
var int   lowBar2    = na
var float lowPrice1  = na
var float lowPrice2  = na
var float lowRsi1    = na
var float lowRsi2    = na

// Highs
var int   highBar1   = na
var int   highBar2   = na
var float highPrice1 = na
var float highPrice2 = na
var float highRsi1   = na
var float highRsi2   = na

// Update low pivots
if not na(pricePivotLow) and not na(rsiPivotLow)
    pivotBarLow = bar_index - rightBars

    lowBar2   := lowBar1
    lowPrice2 := lowPrice1
    lowRsi2   := lowRsi1

    lowBar1   := pivotBarLow
    lowPrice1 := low[rightBars]
    lowRsi1   := rsi[rightBars]

// Update high pivots
if not na(pricePivotHigh) and not na(rsiPivotHigh)
    pivotBarHigh = bar_index - rightBars

    highBar2   := highBar1
    highPrice2 := highPrice1
    highRsi2   := highRsi1

    highBar1   := pivotBarHigh
    highPrice1 := high[rightBars]
    highRsi1   := rsi[rightBars]

//----------------------------------------------------
// MIN DIST
//----------------------------------------------------
f_distOK(b1, b2, dist) =>
    not na(b1) and not na(b2) and (b1 - b2 >= dist)

//----------------------------------------------------
// DIVERGENCE CONDITIONS
//----------------------------------------------------
regBull = showRegular and f_distOK(lowBar1, lowBar2, minDistBars) and 
          not na(lowPrice1) and not na(lowPrice2) and not na(lowRsi1) and not na(lowRsi2) and
          lowPrice1 < lowPrice2 and lowRsi1 > lowRsi2 and 
          math.abs(lowRsi1 - lowRsi2) >= minRsiDiff

regBear = showRegular and f_distOK(highBar1, highBar2, minDistBars) and 
          not na(highPrice1) and not na(highPrice2) and not na(highRsi1) and not na(highRsi2) and
          highPrice1 > highPrice2 and highRsi1 < highRsi2 and 
          math.abs(highRsi1 - highRsi2) >= minRsiDiff

hidBull = showHidden and f_distOK(lowBar1, lowBar2, minDistBars) and 
          not na(lowPrice1) and not na(lowPrice2) and not na(lowRsi1) and not na(lowRsi2) and
          lowPrice1 > lowPrice2 and lowRsi1 < lowRsi2 and 
          math.abs(lowRsi1 - lowRsi2) >= minRsiDiff

hidBear = showHidden and f_distOK(highBar1, highBar2, minDistBars) and 
          not na(highPrice1) and not na(highPrice2) and not na(highRsi1) and not na(highRsi2) and
          highPrice1 < highPrice2 and highRsi1 > highRsi2 and 
          math.abs(highRsi1 - highRsi2) >= minRsiDiff

//----------------------------------------------------
// FINAL CONFIRMED SIGNAL
//----------------------------------------------------
regBullSig = regBull and barstate.isconfirmed
regBearSig = regBear and barstate.isconfirmed
hidBullSig = hidBull and barstate.isconfirmed
hidBearSig = hidBear and barstate.isconfirmed

//----------------------------------------------------
// DRAWING
//----------------------------------------------------
f_draw(b1, p1, b2, p2, col, txt, isLow) =>
    if showLines
        line.new(b2, p2, b1, p1, color = col, width = 2)
    if showLabels
        y        = isLow ? math.min(p1, p2) : math.max(p1, p2)
        lblStyle = isLow ? label.style_label_up : label.style_label_down
        label.new(b2, y, txt, style = lblStyle, color = col, textcolor = color.white, size = size.small)

if regBullSig
    f_draw(lowBar2, lowPrice2, lowBar1, lowPrice1, color.new(color.green, 0), "Regular Bullish", true)

if regBearSig
    f_draw(highBar2, highPrice2, highBar1, highPrice1, color.new(color.red, 0), "Regular Bearish", false)

if hidBullSig
    f_draw(lowBar2, lowPrice2, lowBar1, lowPrice1, color.new(color.teal, 0), "Hidden Bullish", true)

if hidBearSig
    f_draw(highBar2, highPrice2, highBar1, highPrice1, color.new(color.orange, 0), "Hidden Bearish", false)

//----------------------------------------------------
// ALERT LOGIC (SINGLE-FIRE PER PIVOT)
//----------------------------------------------------
var int lastAlertBar = na

newRegBull = regBullSig and not na(lowBar1)  and lowBar1  != lastAlertBar
newRegBear = regBearSig and not na(highBar1) and highBar1 != lastAlertBar
newHidBull = hidBullSig and not na(lowBar1)  and lowBar1  != lastAlertBar
newHidBear = hidBearSig and not na(highBar1) and highBar1 != lastAlertBar

if singleFire
    if newRegBull
        lastAlertBar := lowBar1
    else if newRegBear
        lastAlertBar := highBar1
    else if newHidBull
        lastAlertBar := lowBar1
    else if newHidBear
        lastAlertBar := highBar1

alertcondition(enableAlerts and newRegBull, "Regular Bullish Divergence",
               "Regular Bullish RSI Divergence detected (informational only).")
alertcondition(enableAlerts and newRegBear, "Regular Bearish Divergence",
               "Regular Bearish RSI Divergence detected (informational only).")
alertcondition(enableAlerts and newHidBull, "Hidden Bullish Divergence",
               "Hidden Bullish RSI Divergence detected (informational only).")
alertcondition(enableAlerts and newHidBear, "Hidden Bearish Divergence",
               "Hidden Bearish RSI Divergence detected (informational only).")

//----------------------------------------------------
// DASHBOARD (CLEAN, NO table.clear ISSUES)
//----------------------------------------------------
var table dash = na

if showDashboard
    if na(dash)
        dash := table.new(f_dashPos(dashLocation), 1, 4)

    table.cell(dash, 0, 0, "RSI Divergence Dashboard", text_size = size.normal)
    table.cell(dash, 0, 1, "Last Alert Pivot Bar: " + (na(lastAlertBar) ? "N/A" : str.tostring(lastAlertBar)), text_size = size.normal)
    table.cell(dash, 0, 2, "Regular: Bull/Bear = " + (regBullSig ? "Yes/" : "No/") + (regBearSig ? "Yes" : "No"), text_size = size.normal)
    table.cell(dash, 0, 3, "Hidden: Bull/Bear = " + (hidBullSig ? "Yes/" : "No/") + (hidBearSig ? "Yes" : "No"), text_size = size.normal)

// If dashboard is turned off, we just stop updating it; no clear/remove needed to avoid API issues

//----------------------------------------------------
// DISCLAIMER
//----------------------------------------------------
var label warning = na
if barstate.islast
    txt = "Informational use only â€” not financial advice."
    if na(warning)
        warning := label.new(bar_index, high, txt, 
                             style = label.style_label_left,
                             color = color.new(color.black, 80), 
                             textcolor = color.white, size = size.small)
    else
        label.set_x(warning, bar_index)
        label.set_y(warning, high)
        label.set_text(warning, txt)
