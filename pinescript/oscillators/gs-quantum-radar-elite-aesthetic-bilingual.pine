//@version=6
indicator("GS Quantum Radar [Elite Aesthetic - Bilingual]", shorttitle="GS Quantum Radar量子雷達", overlay=false)

// ==========================================
// 1. Parameters & Aesthetics / 參數與美學設定
// ==========================================
group_asset = "ENTANGLED PARTICLE / 糾纏對象"
symB_input = input.symbol("NASDAQ:TAIEX", title="Particle B / 對標資產", group=group_asset)

group_calc = "QUANTUM PARAMS / 量子參數"
length = input.int(20, title="Window / 觀測窗口", minval=5, group=group_calc)
z_threshold = input.float(2.0, title="Tension / 張力臨界", step=0.1, group=group_calc)
corr_filter = input.float(0.5, title="Filter / 過濾門檻", minval=0.0, maxval=1.0, group=group_calc)

// Neo-Tokyo Palette / 霓虹配色 (TW Standard: Red Up, Green Down)
color_neon_red   = #FF3131 // Red Up / 紅漲
color_neon_green = color.rgb(0, 92, 85, 31) // Green Down / 綠跌
color_neon_blue  = #00D2FF // Tech Blue / 科技藍
color_bg_dark    = color.new(#0D1117, 20)

// ==========================================
// 2. Data Logic / 數據運算
// ==========================================
srcA = close
srcB = request.security(symB_input, timeframe.period, close)

// Correlation / 相關性
correlation = ta.correlation(srcA, srcB, length)

// Z-Score Calculation / 張力運算
ratio = srcA / srcB
meanRatio = ta.sma(ratio, length)
stdRatio = ta.stdev(ratio, length)
zScore = (ratio - meanRatio) / stdRatio

// ==========================================
// 3. UI Component Functions / 視覺化組件函數
// ==========================================
// Merged Value & Scale / 合併數值與比例尺
f_render_bar(val, max_val) =>
    abs_val = math.min(math.abs(val), max_val)
    percent = (abs_val / max_val)
    bar_len = 10
    fill_n = math.round(percent * bar_len)
    
    char_fill = "▣"
    char_empty = "▢"
    bar_str = str.repeat(char_fill, int(fill_n)) + str.repeat(char_empty, int(bar_len - fill_n))
    
    // Format: Value + Scale / 格式：數值 + 比例尺
    str.tostring(val, "#.##") + "  " + bar_str

// ==========================================
// 4. Main Plot / 主圖表繪製
// ==========================================
// Gradient Columns / 漸層柱狀圖
z_col = zScore >= 0 ? color.new(color_neon_red, 10) : color.new(color_neon_green, 10)
plot(zScore, title="Quantum Tension", color=z_col, style=plot.style_columns, linewidth=2)

// Threshold Lines / 臨界線
h_top = hline(z_threshold, color=color.new(color_neon_red, 50), linestyle=hline.style_dotted)
h_bot = hline(-z_threshold, color=color.new(color_neon_green, 50), linestyle=hline.style_dotted)
fill(h_top, hline(0), color.new(color_neon_red, 95), title="Bullish Zone")
fill(h_bot, hline(0), color.new(color_neon_green, 95), title="Bearish Zone")

// Signal Markers / 訊號標記
is_entangled = correlation > corr_filter
sig_buy  = zScore < -z_threshold and is_entangled 
sig_sell = zScore > z_threshold and is_entangled

plotshape(sig_buy,  title="Buy",  location=location.bottom, color=color_neon_red,   style=shape.labelup,   size=size.tiny, text="$",   textcolor=color.white)
plotshape(sig_sell, title="Sell", location=location.top,    color=color_neon_green, style=shape.labeldown, size=size.tiny, text="x",  textcolor=color.white)

// ==========================================
// 5. Aesthetic Dashboard / 精英儀表板
// ==========================================
var table dash = table.new(position.top_right, 2, 5, border_width=0)

if barstate.islast
    corr_display = f_render_bar(correlation, 1.0)
    z_display    = f_render_bar(zScore, 3.0)

    // Table Styling / 儀表板樣式
    table.cell(dash, 0, 0, "NETWORK STATUS / 量子糾纏", bgcolor=color_bg_dark, text_color=color_neon_blue, text_size=size.small, text_halign=text.align_left)
    table.cell(dash, 1, 0, str.tostring(symB_input), bgcolor=color_bg_dark, text_color=color.white, text_size=size.small, text_halign=text.align_right)

    table.cell(dash, 0, 1, "ENTANGLEMENT / 糾纏強度", bgcolor=color_bg_dark, text_color=color.gray, text_size=size.small, text_halign=text.align_left)
    table.cell(dash, 1, 1, corr_display,   bgcolor=color_bg_dark, text_color=correlation > corr_filter ? color_neon_red : color.gray, text_size=size.small, text_halign=text.align_right)

    table.cell(dash, 0, 2, "QUANTUM TENSION / 量子張力", bgcolor=color_bg_dark, text_color=color.gray, text_size=size.small, text_halign=text.align_left)
    table.cell(dash, 1, 2, z_display,          bgcolor=color_bg_dark, text_color=zScore >= 0 ? color_neon_red : color_neon_green, text_size=size.small, text_halign=text.align_right)

    // Strategy Advisory / 策略建議
    status_msg = "STABLE / 穩定"
    status_col = color.gray
    if sig_buy
        status_msg := "STRONG BUY / 強力買進"
        status_col := color_neon_red
    if sig_sell
        status_msg := "TAKE PROFIT / 獲利了結"
        status_col := color_neon_green
    
    table.cell(dash, 0, 3, "ADVISORY / 建議", bgcolor=color_bg_dark, text_color=color.white, text_size=size.small, text_halign=text.align_left)
    table.cell(dash, 1, 3, status_msg,     bgcolor=status_col,    text_color=color.white, text_size=size.small, text_halign=text.align_center)
