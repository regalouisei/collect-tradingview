//@version=5
indicator("TEMA 9 RSI Return + Trend + Impulse Filter", overlay=true, max_labels_count=500)

//━━━━━━━━━━ INPUTS ━━━━━━━━━━
temaLen   = input.int(9, "TEMA Length")
normLen   = input.int(100, "Normalization Lookback")
upperBand = input.int(90, "Upper Band")
lowerBand = input.int(10, "Lower Band")

slopeLen  = input.int(3, "TEMA Slope Lookback")
atrLen    = input.int(14, "ATR Length")
impMult   = input.float(1.2, "Impulse ATR Multiplier", step=0.1)

labelOffset = input.float(0.0, "Label Offset", step=0.1)

//━━━━━━━━━━ TEMA 9 ━━━━━━━━━━
ema1 = ta.ema(close, temaLen)
ema2 = ta.ema(ema1, temaLen)
ema3 = ta.ema(ema2, temaLen)
tema = 3 * (ema1 - ema2) + ema3

//━━━━━━━━━━ TREND FILTER ━━━━━━━━━━
temaSlope = tema - tema[slopeLen]
upTrend   = close > tema and temaSlope > 0
downTrend = close < tema and temaSlope < 0

//━━━━━━━━━━ IMPULSE FILTER ━━━━━━━━━━
atr = ta.atr(atrLen)
candleRange = high - low
hasImpulse = candleRange >= atr * impMult

//━━━━━━━━━━ NORMALIZE TEMA → RSI SCALE ━━━━━━━━━━
temaHigh = ta.highest(tema, normLen)
temaLow  = ta.lowest(tema, normLen)
temaOsc = temaHigh != temaLow ? 100 * (tema - temaLow) / (temaHigh - temaLow) : 50

//━━━━━━━━━━ STATE LOGIC ━━━━━━━━━━
var bool buyArmed  = false
var bool sellArmed = false

if barstate.isconfirmed and temaOsc < lowerBand
    buyArmed := true

if barstate.isconfirmed and temaOsc > upperBand
    sellArmed := true

//━━━━━━━━━━ FINAL SIGNALS ━━━━━━━━━━
buySignal  = barstate.isconfirmed and buyArmed  and temaOsc > lowerBand and upTrend   and hasImpulse
sellSignal = barstate.isconfirmed and sellArmed and temaOsc < upperBand and downTrend and hasImpulse

if buySignal
    buyArmed := false

if sellSignal
    sellArmed := false

//━━━━━━━━━━ LABELS (SINGLE LINE = 100% SAFE) ━━━━━━━━━━
if buySignal
    label.new(x=bar_index, y=low - labelOffset, text="BUY", style=label.style_label_up, color=color.green, textcolor=color.white, size=size.small)

if sellSignal
    label.new(x=bar_index, y=high + labelOffset, text="SELL", style=label.style_label_down, color=color.red, textcolor=color.white, size=size.small)

//━━━━━━━━━━ ALERTS ━━━━━━━━━━
alertcondition(buySignal,  title="BUY Alert",  message="BUY: Trend + impulse confirmed")
alertcondition(sellSignal, title="SELL Alert", message="SELL: Trend + impulse confirmed")
