//@version=5
indicator("[CT] Kurutoga MTF Histogram", overlay=false)

//──────────────────── INPUTS ────────────────────//
baseLength = input.int(14, title="Base Length", minval=1)
higherTF   = input.timeframe("D", title="Higher Time Frame")

// Show / hide
groupShow  = "Show / Hide"
showX1_LTF = input.bool(true,  "Show Kurutoga Lead",      group=groupShow)
showX2_LTF = input.bool(true,  "Show Kurutoga Lead 2x",   group=groupShow)
showX4_LTF = input.bool(true,  "Show Kurutoga Lead 4x",   group=groupShow)

showX1_HTF = input.bool(true,  "Show HTF Lead",           group=groupShow)
showX2_HTF = input.bool(true,  "Show HTF Lead 2x",        group=groupShow)
showX4_HTF = input.bool(true,  "Show HTF Lead 4x",        group=groupShow)

// Shared 4-color palette (same hues for all leads)
groupColors   = "Color Scheme (4-color Kurutoga)"
upLightBase   = input.color(color.rgb(180, 255, 230), "Up Light",   group=groupColors)
upDarkBase    = input.color(color.rgb( 90, 210, 190), "Up Dark",    group=groupColors)
downLightBase = input.color(color.rgb(255, 190, 200), "Down Light", group=groupColors)
downDarkBase  = input.color(color.rgb(210, 100, 130), "Down Dark",  group=groupColors)

// Different transparency per lead
lead1Transp = input.int( 0, "Lead opacity (x1 strongest)", minval=0, maxval=100, group=groupColors)
lead2Transp = input.int(35, "Lead 2x opacity",             minval=0, maxval=100, group=groupColors)
lead3Transp = input.int(70, "Lead 4x opacity (faintest)",  minval=0, maxval=100, group=groupColors)

// Extra transparency for HTF areas
htfExtraTransp = input.int(15, "Extra transparency for HTF areas", minval=0, maxval=100, group=groupColors)

//──────────────────── HELPERS ────────────────────//
calc_midpoint(h, l) =>
    (h + l) / 2

// return LTF & HTF divergence for a given lookback
kurutoga_divergence(len) =>
    // LTF
    curHigh = ta.highest(high, len)
    curLow  = ta.lowest(low, len)
    curMid  = calc_midpoint(curHigh, curLow)
    ltfDiv  = close - curMid

    // HTF
    htfHigh = request.security(syminfo.tickerid, higherTF, ta.highest(high, len))
    htfLow  = request.security(syminfo.tickerid, higherTF, ta.lowest(low, len))
    htfMid  = calc_midpoint(htfHigh, htfLow)
    htfDiv  = close - htfMid

    [ltfDiv, htfDiv]

// 4-color MACD-style logic for a histogram
kurutoga_color(div, upLight, upDark, downLight, downDark) =>
    rising  = div > div[1]
    falling = div < div[1]
    isAbove = div >= 0
    isBelow = div < 0
    isAbove and rising ? upLight :
      isAbove and falling ? upDark :
      isBelow and falling ? downLight :
      downDark

//──────────────────── CORE SERIES (x1, 2x, 4x) ────────────────────//
len1 = baseLength
len2 = baseLength * 2
len3 = baseLength * 4

[div1_ltf, div1_htf] = kurutoga_divergence(len1)
[div2_ltf, div2_htf] = kurutoga_divergence(len2)
[div3_ltf, div3_htf] = kurutoga_divergence(len3)

// Lead-specific color sets (same hues, different transparency)
upLight1   = color.new(upLightBase,   lead1Transp)
upDark1    = color.new(upDarkBase,    lead1Transp)
downLight1 = color.new(downLightBase, lead1Transp)
downDark1  = color.new(downDarkBase,  lead1Transp)

upLight2   = color.new(upLightBase,   lead2Transp)
upDark2    = color.new(upDarkBase,    lead2Transp)
downLight2 = color.new(downLightBase, lead2Transp)
downDark2  = color.new(downDarkBase,  lead2Transp)

upLight3   = color.new(upLightBase,   lead3Transp)
upDark3    = color.new(upDarkBase,    lead3Transp)
downLight3 = color.new(downLightBase, lead3Transp)
downDark3  = color.new(downDarkBase,  lead3Transp)

// HTF colors: same palette but more transparent
htfUp1   = color.new(upLightBase,   math.min(100, lead1Transp + htfExtraTransp))
htfDown1 = color.new(downLightBase, math.min(100, lead1Transp + htfExtraTransp))

htfUp2   = color.new(upLightBase,   math.min(100, lead2Transp + htfExtraTransp))
htfDown2 = color.new(downLightBase, math.min(100, lead2Transp + htfExtraTransp))

htfUp3   = color.new(upLightBase,   math.min(100, lead3Transp + htfExtraTransp))
htfDown3 = color.new(downLightBase, math.min(100, lead3Transp + htfExtraTransp))

//──────────────────── PLOTS ────────────────────//
// LTF histograms (4-color each)

// x1
plot(
     showX1_LTF ? div1_ltf : na,
     title     = "Kurutoga Lead",
     style     = plot.style_histogram,
     linewidth = 3,
     color     = kurutoga_color(div1_ltf, upLight1, upDark1, downLight1, downDark1)
     )

// 2x
plot(
     showX2_LTF ? div2_ltf : na,
     title     = "Kurutoga Lead 2x",
     style     = plot.style_histogram,
     linewidth = 3,
     color     = kurutoga_color(div2_ltf, upLight2, upDark2, downLight2, downDark2)
     )

// 4x
plot(
     showX4_LTF ? div3_ltf : na,
     title     = "Kurutoga Lead 4x",
     style     = plot.style_histogram,
     linewidth = 3,
     color     = kurutoga_color(div3_ltf, upLight3, upDark3, downLight3, downDark3)
     )

// HTF areas (sign-based; same hues, more transparent)
plot(
     showX1_HTF ? div1_htf : na,
     title     = "HTF Lead",
     style     = plot.style_area,
     linewidth = 1,
     color     = div1_htf >= 0 ? htfUp1 : htfDown1
     )

plot(
     showX2_HTF ? div2_htf : na,
     title     = "HTF Lead 2x",
     style     = plot.style_area,
     linewidth = 1,
     color     = div2_htf >= 0 ? htfUp2 : htfDown2
     )

plot(
     showX4_HTF ? div3_htf : na,
     title     = "HTF Lead 4x",
     style     = plot.style_area,
     linewidth = 1,
     color     = div3_htf >= 0 ? htfUp3 : htfDown3
     )

// Zero line
hline(0, "Zero Line", color=color.gray)
