//@version=5
indicator("Regime Switching [Pointalgo]", shorttitle="Vatic_Regime", overlay=true)

// --- FEATURES (AI Inputs) ---
atr_len = input.int(14, "ATR Length")
adx_len = input.int(14, "ADX Length")

// 1. Trend Strength (ADX)
[di_plus, di_minus, adx] = ta.dmi(adx_len, adx_len)

// 2. Efficiency (Kaufman Ratio)
// Measures if price is moving straight (Trend) or chopping (Range)
change_abs = math.abs(close - close[1])
sum_change = math.sum(change_abs, 10)
net_change = math.abs(close - close[10])
efficiency = sum_change != 0 ? net_change / sum_change : 0

// --- REGIME CLASSIFICATION ---
// State 1: TRENDING (Strong ADX + Efficient Move)
is_trending = adx > 25 and efficiency > 0.3

// State 2: MEAN REVERSION (Weak ADX + Inefficient Move)
is_ranging = adx < 20 and efficiency < 0.2

// --- VISUALIZATIONS ---

// 1. Plot Donchian Channels (Trend Mode)
upper_ch = ta.highest(high, 20)
lower_ch = ta.lowest(low, 20)
// Only show Donchian lines when we are in TREND mode
plot(is_trending ? upper_ch : na, "Trend Resistance", color=color.green, style=plot.style_stepline)
plot(is_trending ? lower_ch : na, "Trend Support", color=color.red, style=plot.style_stepline)

// 2. Plot Bollinger Bands (Range Mode)
bb_mid = ta.sma(close, 20)
bb_dev = ta.stdev(close, 20) * 2
bb_upper = bb_mid + bb_dev
bb_lower = bb_mid - bb_dev
// Only show Bands when we are in RANGE mode
p1 = plot(is_ranging ? bb_upper : na, "Fade Resistance", color=color.blue)
p2 = plot(is_ranging ? bb_lower : na, "Fade Support", color=color.blue)
fill(p1, p2, color=is_ranging ? color.new(color.blue, 90) : na)

// 3. Background Color (The "State")
bgcolor(is_trending ? color.new(color.green, 90) : is_ranging ? color.new(color.blue, 90) : color.new(color.gray, 95))

// --- SIGNALS ---
// Trend Signals (Breakouts)
trend_buy = is_trending and ta.crossover(close, upper_ch[1])
trend_sell = is_trending and ta.crossunder(close, lower_ch[1])

// Range Signals (Fades)
range_buy = is_ranging and ta.crossover(close, bb_lower)
range_sell = is_ranging and ta.crossunder(close, bb_upper)

plotshape(trend_buy, "Trend Breakout", shape.labelup, location.belowbar, color.green, text="BREAK", textcolor=color.white, size=size.tiny)
plotshape(trend_sell, "Trend Breakdown", shape.labeldown, location.abovebar, color.red, text="BREAK", textcolor=color.white, size=size.tiny)

plotshape(range_buy, "Range Fade Buy", shape.triangleup, location.belowbar, color.blue, text="FADE", size=size.tiny)
plotshape(range_sell, "Range Fade Sell", shape.triangledown, location.abovebar, color.blue, text="FADE", size=size.tiny)

// --- DASHBOARD ---
var table dash = table.new(position.top_right, 2, 3, bgcolor=color.black)
if barstate.islast
    table.cell(dash, 0, 0, "Vatic AI State", text_color=color.white)
    
    table.cell(dash, 0, 1, "Regime", text_color=color.white)
    string reg_txt = is_trending ? "TRENDING" : is_ranging ? "RANGING" : "NOISE"
    color reg_col = is_trending ? color.green : is_ranging ? color.blue : color.gray
    table.cell(dash, 1, 1, reg_txt, text_color=reg_col)
    
    table.cell(dash, 0, 2, "Efficiency", text_color=color.white)
    table.cell(dash, 1, 2, str.tostring(efficiency, "#.##"), text_color=color.yellow)
