//@version=6
indicator("MTF RSI — Centered at Zero", overlay=false, max_labels_count=500)

//------------------------------------------------------
// Inputs
//------------------------------------------------------
rsiLength      = input.int(14, "RSI Length")
htfTf          = input.timeframe("240", "HTF RSI (例: 240=4H)")
enableAlerts   = input.bool(true, "Enable Buy/Sell Alerts?")
showHistory    = input.bool(true, "Show past vertical stripes? (OFF = only current bar)")

//------------------------------------------------------
// RSI values（すべて50を引いて0中心に）
//------------------------------------------------------
rsiCur = ta.rsi(close, rsiLength) - 50  // 現在の時間足（15分足）のRSI
rsiHtf = request.security(syminfo.tickerid, htfTf, ta.rsi(close, rsiLength), lookahead=barmerge.lookahead_off) - 50  // 4時間足のRSI

//------------------------------------------------------
// HTF Regime（4時間足ベース）※元の値で判定
//------------------------------------------------------
rsiHtfOriginal = rsiHtf + 50
rsiCurOriginal = rsiCur + 50

isBuyOnly_HTF  = (rsiHtfOriginal >= 55 and rsiHtfOriginal <= 68)
isSellOnly_HTF = (rsiHtfOriginal <= 45 and rsiHtfOriginal >= 32)

// Extreme判定
isHtfOversold = (rsiHtfOriginal < 30)
isHtfOverbought = (rsiHtfOriginal > 70)

isCurOversold = (rsiCurOriginal < 30)
isCurOverbought = (rsiCurOriginal > 70)

//------------------------------------------------------
// ★ 縦ストライプ色の決定（段階的な色分け）
//------------------------------------------------------
var color stripeColor = na

// 買われすぎ側（RSI 70超 = Centered 20超）
if isCurOverbought
    if isHtfOverbought
        // 15分足も4時間足も70超 → 濃い赤/ピンク
        stripeColor := color.new(#ff6b9d, 75)
    else
        // 15分足だけ70超 → 薄い赤/ピンク
        stripeColor := color.new(#ff6b9d, 90)
// 売られすぎ側（RSI 30未満 = Centered -20未満）
else if isCurOversold
    if isHtfOversold
        // 15分足も4時間足も30未満 → 濃い青
        stripeColor := color.new(#2962ff, 75)
    else
        // 15分足だけ30未満 → 薄い青
        stripeColor := color.new(#2962ff, 90)
else
    // RSI 30-70の範囲内 → 色なし
    stripeColor := na

//------------------------------------------------------
// ★ 歴史を塗る or 現在バーだけ塗る
//------------------------------------------------------
bgcolor(showHistory ? stripeColor : (barstate.islast ? stripeColor : na))

//------------------------------------------------------
// RSI Plot（0中心）- 青いラインと影
//------------------------------------------------------
plot(rsiCur, "RSI Shadow", color=color.new(#2962ff, 85), linewidth=8)
plot(rsiCur, "RSI (15m)", color=#2962ff, linewidth=2)

//------------------------------------------------------
// HTF RSI ヒストグラム（0中心）- 半透明の赤/青
//------------------------------------------------------
var color histColor = na

if rsiHtf > 0
    // 0より上（買い優勢）→ 赤/ピンク系
    histColor := color.new(#ff6b9d, 70)
else if rsiHtf < 0
    // 0より下（売り優勢）→ 青系
    histColor := color.new(#2962ff, 70)
else
    histColor := na

plot(rsiHtf, "HTF RSI (4H)", color=histColor, linewidth=4, style=plot.style_columns)

//------------------------------------------------------
// ★ 初動シグナル（4Hフィルタ統合済み）
//------------------------------------------------------
// クロス判定を事前計算（元の値ベース）
crossAbove41 = ta.crossover(rsiCurOriginal, 33)
crossBelow59 = ta.crossunder(rsiCurOriginal, 67)

buySignal  = enableAlerts and isBuyOnly_HTF and crossAbove41
sellSignal = enableAlerts and isSellOnly_HTF and crossBelow59

plotshape(buySignal, title="Buy Signal", color=#ffa726, style=shape.circle, size=size.small, location=location.bottom)
plotshape(sellSignal, title="Sell Signal", color=#ef5350, style=shape.circle, size=size.small, location=location.top)

alertcondition(buySignal, title="RSI Buy Signal", message="RSI rising from 40 zone (4H BUY ONLY)")
alertcondition(sellSignal, title="RSI Sell Signal", message="RSI dropping from 60 zone (4H SELL ONLY)")

//------------------------------------------------------
// Guide lines（0中心の新しい基準線）
//------------------------------------------------------
hline(0, "0 (= RSI 50)", color=color.new(color.gray, 60), linewidth=1, linestyle=hline.style_dashed)
hline(20, "20 (= RSI 70)", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(-20, "-20 (= RSI 30)", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
