//@version=5
indicator("Custom Timeframe 2 randomness", overlay=true, max_boxes_count=500, max_labels_count=500, dynamic_requests=true)

//------------------------------------------------------------------------------
// Settings
//------------------------------------------------------------------------------
bg_transp = input.float(90, 'Box Transparency', group='Box Settings')
box_color_custom = input.color(color.orange, 'Custom Minute Box Color', group='Box Settings')
box_color_daily = input.color(color.blue, 'Daily Box Color', group='Box Settings')
box_color_weekly = input.color(color.green, 'Weekly Box Color', group='Box Settings')
box_color_monthly = input.color(color.red, 'Monthly Box Color', group='Box Settings')
box_color_random = input.color(color.purple, 'Random Minutes Box Color', group='Box Settings')
show_outline = input(true, 'Show Box Outline', group='Box Settings')
outline_color = input.color(color.black, 'Outline Color', group='Box Settings')
outline_style = input.string("Solid", "Outline Style", options=["Solid", "Dotted", "Dashed"], group='Box Settings')
show_open_line = input(true, 'Show Opening Price Line', group='Box Settings')
open_line_color = input.color(color.blue, 'Opening Price Line Color', group='Box Settings')
open_line_width = input.int(2, 'Opening Price Line Width', group='Box Settings')

// Timeframe selection
timeframe_option = input.string("Daily", "Select Timeframe", options=["Custom Minutes", "Daily", "Weekly", "Monthly", "Random Minutes"], group='Timeframe Selection')
custom_minutes = input.int(60, "Custom Minutes Interval (max 1440)", minval=1, maxval=1440, group='Timeframe Selection')
min_random_minutes = input.int(30, "Min Random Minutes Interval", minval=1, group='Timeframe Selection')
max_random_minutes = input.int(120, "Max Random Minutes Interval", minval=1, group='Timeframe Selection')

// Convert outline style input to Pine Script line style
outline_style_value = outline_style == "Solid" ? line.style_solid : outline_style == "Dotted" ? line.style_dotted : line.style_dashed

// Define timeframe based on timeframe_option
string timeframe = na
if timeframe_option == "Custom Minutes"
    timeframe := str.tostring(math.min(custom_minutes, 1440))
else if timeframe_option == "Daily"
    timeframe := "D"
else if timeframe_option == "Weekly"
    timeframe := "W"
else if timeframe_option == "Monthly"
    timeframe := "M"

// Define box color based on timeframe_option
color box_color = timeframe_option == "Custom Minutes" ? box_color_custom : timeframe_option == "Daily" ? box_color_daily : timeframe_option == "Weekly" ? box_color_weekly : timeframe_option == "Monthly" ? box_color_monthly : box_color_random

//------------------------------------------------------------------------------
// Function Definition
//------------------------------------------------------------------------------
f_loopLabel(_label, _x, _y, _text) =>
    label.set_xy(_label, _x, _y)
    label.set_text(_label, _text)

//------------------------------------------------------------------------------
// Variables
//------------------------------------------------------------------------------
var box current_box = na
var float current_high = na
var float current_low = na
var float current_open = na
var label current_label_high = na
var label current_label_low = na
var line current_open_line = na
var int box_left_bar_index = na
var int box_right_bar_index = na
var float rand_state = 1.0
var int next_period_time = na

bool is_random = timeframe_option == "Random Minutes"

// Fetch data at the specified timeframe if not random
float tf_open = na
float tf_high = na
float tf_low = na
int tf_time = na
if not is_random
    [tf_open, tf_high, tf_low, tf_time] = request.security(syminfo.tickerid, timeframe, [open, high, low, time], lookahead=barmerge.lookahead_on)

//------------------------------------------------------------------------------
// Period Change Logic
//------------------------------------------------------------------------------
bool period_change = false
if is_random
    if na(next_period_time)
        rand_state := float(time) % 4294967296.0
        float new_state = (rand_state * 1664525.0 + 1013904223.0) % 4294967296.0
        float r = new_state / 4294967296.0
        rand_state := new_state
        int interval = math.round(r * (max_random_minutes - min_random_minutes) + min_random_minutes) * 60000
        next_period_time := time + interval
        period_change := true
    else
        if time >= next_period_time
            float new_state = (rand_state * 1664525.0 + 1013904223.0) % 4294967296.0
            float r = new_state / 4294967296.0
            rand_state := new_state
            int interval = math.round(r * (max_random_minutes - min_random_minutes) + min_random_minutes) * 60000
            next_period_time := time + interval
            period_change := true
        else
            period_change := false
else
    period_change := na(current_box) or ta.change(tf_time)

//------------------------------------------------------------------------------
// Box Logic
//------------------------------------------------------------------------------
if period_change
    // Start a new box when the timeframe interval changes
    if not is_random
        current_high := tf_high
        current_low := tf_low
        current_open := tf_open
    else
        current_high := high
        current_low := low
        current_open := open
    box_left_bar_index := bar_index
    box_right_bar_index := bar_index
    current_box := box.new(left=box_left_bar_index, top=current_high, right=box_right_bar_index, bottom=current_low, bgcolor=color.new(box_color, bg_transp), border_color=show_outline ? outline_color : na, border_style=outline_style_value)
    if show_open_line
        current_open_line := line.new(x1=box_left_bar_index, y1=current_open, x2=box_right_bar_index, y2=current_open, color=open_line_color, width=open_line_width, style=line.style_solid)
    current_label_high := label.new(bar_index, current_high, "", style=label.style_label_down, color=color.white, textcolor=color.black, size=size.small)
    current_label_low := label.new(bar_index, current_low, "", style=label.style_label_up, color=color.white, textcolor=color.black, size=size.small)
else
    // Update the existing boxâ€™s right edge
    if is_random
        current_high := math.max(current_high, high)
        current_low := math.min(current_low, low)
        box.set_top(current_box, current_high)
        box.set_bottom(current_box, current_low)
    box_right_bar_index := bar_index
    box.set_right(current_box, box_right_bar_index)
    if show_open_line
        line.set_xy2(current_open_line, box_right_bar_index, current_open)
    // Update label positions and text
    midpoint_x = (box_left_bar_index + box_right_bar_index) / 2
    price_diff_high = current_high - current_open
    percent_change_high = (price_diff_high / current_open) * 100
    price_diff_low = current_open - current_low
    percent_change_low = (price_diff_low / current_open) * 100
    f_loopLabel(current_label_high, midpoint_x, current_high, "High: " + str.tostring(price_diff_high, "#.##") + " (" + str.tostring(percent_change_high, "#.##") + "%)")
    f_loopLabel(current_label_low, midpoint_x, current_low, "Low: " + str.tostring(price_diff_low, "#.##") + " (" + str.tostring(percent_change_low, "#.##") + "%)")

// Warning label for custom minutes exceeding 1440
if timeframe_option == "Custom Minutes" and custom_minutes > 1440
    label.new(bar_index, high, "Custom minutes capped at 1440", color=color.red, textcolor=color.white, style=label.style_label_down)
