// This work is licensed under a Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0) https://creativecommons.org/licenses/by-nc-sa/4.0/
// © LuxAlgo

//@version=6
indicator("Liquidity Clusters Magnitude [LuxAlgo]", "LuxAlgo - Liquidity Clusters Magnitude")

//---------------------------------------------------------------------------------------------------------------------}
// Constants
//---------------------------------------------------------------------------------------------------------------------{
DATA                    = #DBDBDB
HEADERS                 = #808080
BACKGROUND              = #161616
BORDERS                 = #2E2E2E

TOP_RIGHT               = 'Top Right'
BOTTOM_RIGHT            = 'Bottom Right'
BOTTOM_LEFT             = 'Bottom Left'

TINY                    = 'Tiny'
SMALL                   = 'Small'
NORMAL                  = 'Normal'
LARGE                   = 'Large'
HUGE                    = 'Huge'

BULL_COLOR              = #089981
BEAR_COLOR              = #f23645
TREND_COLOR             = #5b9cf6

// Tooltips
lengthTooltip           = "Number of bars used for the rolling calculation and counting."
smoothTooltip           = "Apply a moving average to smooth the magnitude metrics."
thresholdTooltip        = "Threshold for identifying significant liquidity clusters."
dashboardTooltip        = 'Enable or disable the dashboard.'
dashboardPositionTooltip= 'Select the dashboard location.'
dashboardSizeTooltip    = 'Select the dashboard size.'

//---------------------------------------------------------------------------------------------------------------------}
// Settings
//---------------------------------------------------------------------------------------------------------------------{
lengthInput             = input.int(20, "Window Size", minval = 2, group = "Settings", tooltip = lengthTooltip)
smoothInput             = input.int(3, "Smoothing", minval = 1, group = "Settings", tooltip = smoothTooltip)
thresholdInput          = input.int(5, "Magnitude Threshold", minval = 1, group = "Settings", tooltip = thresholdTooltip)

bullColorInput          = input.color(BULL_COLOR, "Bullish Clusters", inline = "Bull", group = "Visuals")
bearColorInput          = input.color(BEAR_COLOR, "Bearish Clusters", inline = "Bear", group = "Visuals")
trendColorInput         = input.color(TREND_COLOR, "Trend Metric", group = "Visuals")
showSignalsInput        = input.bool(true, "Show Signal Dots", group = "Visuals")

dashboardInput          = input.bool(true, 'Dashboard', group = 'Dashboard', tooltip = dashboardTooltip)
dashboardPositionInput  = input.string(TOP_RIGHT, 'Position', group = 'Dashboard', tooltip = dashboardPositionTooltip, options = [TOP_RIGHT, BOTTOM_RIGHT, BOTTOM_LEFT])
dashboardSizeInput      = input.string(SMALL, 'Size', group = 'Dashboard', tooltip = dashboardSizeTooltip, options = [TINY, SMALL, NORMAL, LARGE, HUGE])

//---------------------------------------------------------------------------------------------------------------------}
// Logic
//---------------------------------------------------------------------------------------------------------------------{
// Define body boundaries
bodyHigh = math.max(open, close)
bodyLow  = math.min(open, close)

// Identify the highest body high and lowest body low within the rolling window.
maxBodyHigh = ta.highest(bodyHigh, lengthInput)
minBodyLow  = ta.lowest(bodyLow, lengthInput)

float upperLevel = na
float lowerLevel = na

// First pass: Find the anchor levels
for i = 0 to lengthInput - 1
    float h = high[i]
    float l = low[i]
    
    // Find the minimum high that is above all bodies in the window
    if h >= maxBodyHigh
        if na(upperLevel) or h < upperLevel
            upperLevel := h
            
    // Find the maximum low that is below all bodies in the window
    if l <= minBodyLow
        if na(lowerLevel) or l > lowerLevel
            lowerLevel := l

// Second pass: Count how many wicks are "touched" or "crossed" by these levels
int bullCount = 0
int bearCount = 0

if not na(upperLevel) and not na(lowerLevel)
    for i = 0 to lengthInput - 1
        // Bearish Cluster: Upper wicks touched by the upperLevel
        if high[i] >= upperLevel
            bearCount += 1
            
        // Bullish Cluster: Lower wicks touched by the lowerLevel
        if low[i] <= lowerLevel
            bullCount += 1

// Smoothing
float rawBullMetric = float(bullCount)
float rawBearMetric = float(bearCount)

float smoothedBull = ta.sma(rawBullMetric, smoothInput)
float smoothedBear = -ta.sma(rawBearMetric, smoothInput)

// Trend Metric (Average between the two areas)
float trendMetric = smoothedBull + smoothedBear

// Threshold Crossings
bool bullSignal = ta.crossover(rawBullMetric, thresholdInput)
bool bearSignal = ta.crossover(rawBearMetric, thresholdInput)

// Dashboard Logic
var parsedDashboardPosition = switch dashboardPositionInput
    TOP_RIGHT       => position.top_right
    BOTTOM_RIGHT    => position.bottom_right
    BOTTOM_LEFT     => position.bottom_left

var parsedDashboardSize = switch dashboardSizeInput
    TINY            => size.tiny
    SMALL           => size.small
    NORMAL          => size.normal
    LARGE           => size.large
    HUGE            => size.huge

cell(table t_able, int column, int row, string data, color = #FFFFFF, align = text.align_right, color background = na, float height = 0) => 
    t_able.cell(column, row, data, text_color = color, text_size = parsedDashboardSize, text_halign = align, bgcolor = background, height = height)

divider(table t_able, int row, int lastColumn) =>    
    string rowDivider = '━━━━━━━━━━'
    t_able.merge_cells(0, row, lastColumn, row)
    cell(t_able, 0, row, rowDivider, align = text.align_center, height = 0.5, color = BORDERS)

//---------------------------------------------------------------------------------------------------------------------}
// Visuals
//---------------------------------------------------------------------------------------------------------------------{
hline(0, "Zero Line", color = chart.fg_color, linestyle = hline.style_dotted)
hline(thresholdInput, "Bullish Threshold", color = color.new(bullColorInput, 50), linestyle = hline.style_dashed)
hline(-thresholdInput, "Bearish Threshold", color = color.new(bearColorInput, 50), linestyle = hline.style_dashed)

// Plot the smoothed metrics
pBull = plot(smoothedBull, "Bullish Magnitude", color = bullColorInput, linewidth = 2)
pBear = plot(smoothedBear, "Bearish Magnitude", color = bearColorInput, linewidth = 2)

// Trend Plot
plot(trendMetric, "Trend Metric", color = trendColorInput)

// Zero plot for fills
pZero = plot(0, display = display.none)

// Advanced Fills: Gradient fade to zero
fill(pBull, pZero, smoothedBull, 0, bullColorInput, color.new(bullColorInput, 100), "Bullish Fill")
fill(pBear, pZero, 0, smoothedBear, color.new(bearColorInput, 100), bearColorInput, "Bearish Fill")

// Signal Dots
plot(showSignalsInput and bullSignal ? smoothedBull : na, "Bull Signal Dot", color = bullColorInput, style = plot.style_circles, linewidth = 4)
plot(showSignalsInput and bearSignal ? smoothedBear : na, "Bear Signal Dot", color = bearColorInput, style = plot.style_circles, linewidth = 4)
plot(showSignalsInput and bullSignal ? smoothedBull : na, "Bull Signal Dot", color = chart.fg_color, style = plot.style_circles, linewidth = 3)
plot(showSignalsInput and bearSignal ? smoothedBear : na, "Bear Signal Dot", color = chart.fg_color, style = plot.style_circles, linewidth = 3)

// Dashboard Rendering
if dashboardInput and barstate.islast
    var table t_able = table.new(parsedDashboardPosition, 2, 7, bgcolor = BACKGROUND, border_width = 0, frame_color = BORDERS, frame_width = 1)
    
    t_able.merge_cells(0, 0, 1, 0)
    cell(t_able, 0, 0, "Liquidity Cluster Status", color = DATA, align = text.align_center)
    
    divider(t_able, 1, 1)
    
    cell(t_able, 0, 2, "Bullish Magnitude", color = HEADERS, align = text.align_left)
    cell(t_able, 1, 2, str.format("{0,number,#.##}", rawBullMetric), color = bullColorInput)
    
    cell(t_able, 0, 3, "Bearish Magnitude", color = HEADERS, align = text.align_left)
    cell(t_able, 1, 3, str.format("{0,number,#.##}", rawBearMetric), color = bearColorInput)
    
    divider(t_able, 4, 1)
    
    cell(t_able, 0, 5, "Trend State", color = HEADERS, align = text.align_left)
    cell(t_able, 1, 5, rawBullMetric > rawBearMetric ? "Bullish" : rawBearMetric > rawBullMetric ? "Bearish" : "Neutral", color = rawBullMetric > rawBearMetric ? bullColorInput : rawBearMetric > rawBullMetric ? bearColorInput : DATA)

//---------------------------------------------------------------------------------------------------------------------}
