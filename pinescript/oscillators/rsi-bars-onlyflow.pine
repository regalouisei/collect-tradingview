//@version=6
indicator("RSI Bars - OnlyFlow", overlay=true, max_lines_count=500)

src        = input.source(close, "RSI Source")
len        = input.int(14, "RSI Length", minval=1)
ob         = input.float(70, "Overbought", minval=50, maxval=100)
os         = input.float(30, "Oversold",   minval=0,  maxval=50)
useSmooth  = input.bool(true, "Gradient mode (off = 3-step)")
colorByDir = input.bool(true, "Neutral color follows bar direction")

colSellMin = input.color(color.rgb(255,181,218), "Overbought Min")
colSellMed = input.color(color.rgb(255,  0,  0), "Overbought Mid")
colSellMax = input.color(color.rgb(128,  0,  0), "Overbought Max")

colBuyMin  = input.color(color.rgb( 64,224,208), "Oversold Min")
colBuyMed  = input.color(color.rgb(  0,128,128), "Oversold Mid")
colBuyMax  = input.color(color.rgb(  0, 64, 64), "Oversold Max")

colNeutralUp   = input.color(color.rgb(50, 54, 69), "Neutral Up")
colNeutralDown = input.color(color.rgb(67, 73, 84), "Neutral Down")

useCustomCandles = input.bool(true, "Fully color body + wicks + borders")
candleOpacityPct = input.int(0, "Extra transparency (0=solid, 100=invisible)", minval=0, maxval=100)

f_clamp01(x) =>
    x < 0 ? 0.0 : x > 1 ? 1.0 : x

f_lerpColor(c1, c2, t) =>
    tt = f_clamp01(t)
    r = math.round(color.r(c1) + (color.r(c2) - color.r(c1)) * tt)
    g = math.round(color.g(c1) + (color.g(c2) - color.g(c1)) * tt)
    b = math.round(color.b(c1) + (color.b(c2) - color.b(c1)) * tt)
    color.rgb(r, g, b)

f_palette3(t, cMin, cMed, cMax) =>
    x = f_clamp01(t) * 2.0
    x <= 1.0 ? f_lerpColor(cMin, cMed, x) : f_lerpColor(cMed, cMax, x - 1.0)

rsi = ta.rsi(src, len)

obInt = rsi >= ob ? (rsi - ob) / math.max(0.0001, (100 - ob)) : 0.0
osInt = rsi <= os ? (os - rsi) / math.max(0.0001, os)         : 0.0

isUp      = close >= open
baseColor = colorByDir ? (isUp ? colNeutralUp : colNeutralDown) : color.new(color.gray, 70)

sellSmooth = f_palette3(obInt, colSellMin, colSellMed, colSellMax)
buySmooth  = f_palette3(osInt, colBuyMin,  colBuyMed,  colBuyMax)

sellStep =
     rsi >= math.min(100, ob + 20) ? colSellMax :
     rsi >= math.min(100, ob + 10) ? colSellMed :
     rsi >= ob ? colSellMin : na

buyStep  =
     rsi <= math.max(0, os - 20) ? colBuyMax  :
     rsi <= math.max(0, os - 10) ? colBuyMed  :
     rsi <= os ? colBuyMin : na

finalColor = rsi >= ob ? (useSmooth ? sellSmooth : nz(sellStep, baseColor)) :
             rsi <= os ? (useSmooth ? buySmooth  : nz(buyStep,  baseColor)) :
             baseColor

fullCol = color.new(finalColor, candleOpacityPct)

// keep call on one line to avoid the newline parsing bug
plotcandle(open, high, low, close, title="RSI Colored Candles", color=fullCol, wickcolor=fullCol, bordercolor=fullCol, display=useCustomCandles ? display.all : display.none)

barcolor(useCustomCandles ? na : fullCol, title="RSI Gradient Bars")

showPane = input.bool(false, "Show RSI pane")
plot(showPane ? rsi : na, "RSI", display=display.pane)
hline(ob,  "OB",  color = showPane ? color.new(color.red, 70)  : na)
hline(os,  "OS",  color = showPane ? color.new(color.teal, 70) : na)
hline(50,  "Mid", color = showPane ? color.new(color.gray, 80) : na)
