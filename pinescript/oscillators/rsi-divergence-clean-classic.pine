//@version=5
indicator("RSI Divergence • Clean & Classic", overlay=false, max_lines_count=200)

// ── Inputs
rsiLen   = input.int(14, "RSI Length")
pivotLen = input.int(5, "Pivot Strength")

// ── RSI
rsi = ta.rsi(close, rsiLen)
plot(rsi, color=color.white, linewidth=2)
hline(70, "Overbought", color=color.red)
hline(50, "Mid", color=color.gray)
hline(30, "Oversold", color=color.green)

// ── RSI pivots
rsiLow  = ta.pivotlow(rsi, pivotLen, pivotLen)
rsiHigh = ta.pivothigh(rsi, pivotLen, pivotLen)

// ── Price pivots
priceLow  = ta.pivotlow(low, pivotLen, pivotLen)
priceHigh = ta.pivothigh(high, pivotLen, pivotLen)

// ── Regular divergence
bullReg = not na(rsiLow) and not na(priceLow) and priceLow < priceLow[pivotLen] and rsiLow > rsiLow[pivotLen]
bearReg = not na(rsiHigh) and not na(priceHigh) and priceHigh > priceHigh[pivotLen] and rsiHigh < rsiHigh[pivotLen]

// ── Hidden divergence
bullHid = not na(rsiLow) and not na(priceLow) and priceLow > priceLow[pivotLen] and rsiLow < rsiLow[pivotLen]
bearHid = not na(rsiHigh) and not na(priceHigh) and priceHigh < priceHigh[pivotLen] and rsiHigh > rsiHigh[pivotLen]

// ── Draw RSI divergence lines
if bullReg
    line.new(bar_index[pivotLen], rsiLow[pivotLen], bar_index, rsiLow, color=color.lime, width=2)

if bearReg
    line.new(bar_index[pivotLen], rsiHigh[pivotLen], bar_index, rsiHigh, color=color.red, width=2)

if bullHid
    line.new(bar_index[pivotLen], rsiLow[pivotLen], bar_index, rsiLow, color=color.green, width=2, style=line.style_dashed)

if bearHid
    line.new(bar_index[pivotLen], rsiHigh[pivotLen], bar_index, rsiHigh, color=color.maroon, width=2, style=line.style_dashed)
