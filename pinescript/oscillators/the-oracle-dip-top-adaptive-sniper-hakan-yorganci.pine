// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © hknyrgnc

//@version=6
// This script is an enhanced version of the original strategy.
// Developer: Hakan Yorganci
// Strategy Name: The Yorganci Protocol

strategy("The Oracle: Dip & Top Adaptive Sniper [Hakan Yorganci]", 
     overlay           = true, 
     initial_capital   = 1000, 
     pyramiding        = 0, 
     default_qty_type  = strategy.percent_of_equity, 
     default_qty_value = 100)

//=== INPUTS (SETTINGS) ===//
// SMA Settings
smaLenShort  = input.int(50,  "Support SMA (50)", group="Moving Averages")
smaLenLong   = input.int(200, "Main Trend SMA (200)", group="Moving Averages")

// NEW: Trend Filter Switch
useTrendFilter = input.bool(true, "Only Buy Above SMA 200?", group="Filters", tooltip="Uncheck this to trade RSI dips even in a downtrend.")

// RSI Settings
rsiLen       = input.int(14,  "RSI Length", group="Oscillators")
rsiMaLen     = input.int(9,   "RSI Moving Average", group="Oscillators")

// Sniper Entry/Exit Settings
buyRsiDipLvl   = input.float(45.0, "Sniper Buy Level (RSI MA)", tooltip="Buys when RSI MA crosses over this level.")
sellRsiPeakLvl = input.float(75.0, "Profit Take Level (RSI MA)", tooltip="Takes profit when RSI MA reaches this level.")

// ADX Settings (Sideways Market Filter)
useAdx       = input.bool(true, "Use ADX Power Filter?", group="Filters")
adxThreshold = input.int(20, "ADX Threshold (Min Strength)", group="Filters")

//=== CALCULATIONS ===//
// SMA
sma50  = ta.sma(close, smaLenShort)
sma200 = ta.sma(close, smaLenLong)

// RSI and RSI MA
rsiVal   = ta.rsi(close, rsiLen)
rsiMaVal = ta.sma(rsiVal, rsiMaLen)

// ADX
[diplus, diminus, adxVal] = ta.dmi(14, 14)
adxCondition = useAdx ? (adxVal > adxThreshold) : true

//=== POSITION CHECK ===//
inLong = strategy.position_size > 0

//=== STRATEGY LOGIC ===//

// FIX: Calculate crossover independently
rsiCrossUp = ta.crossover(rsiMaVal, buyRsiDipLvl)

// 1. LONG ENTRY (SNIPER ENTRY)
// Condition A: Trend Filter (Optional). If unchecked, we ignore the SMA 200 rule.
trendCondition = useTrendFilter ? (close > sma200) : true

// Full Entry Logic
longEntryCond = trendCondition and adxCondition and rsiCrossUp and not inLong

// 2. EXIT CONDITIONS
// Scenario A: TAKE PROFIT
takeProfitCond = rsiMaVal > sellRsiPeakLvl

// Scenario B: STOP LOSS
stopLossCond = close < sma50

// Exit Trigger
longExitCond = (takeProfitCond or stopLossCond) and inLong

//=== ORDER EXECUTION ===//
if longEntryCond
    strategy.entry("HY Sniper", strategy.long, comment="Sniper Entry")

if longExitCond
    exitReason = takeProfitCond ? "Profit (Peak)" : "Stop (SMA 50)"
    strategy.close("HY Sniper", comment=exitReason)

//=== VISUALIZATION ===//
// Plotting the SMAs
plot(sma50,  title = "Support Line (50)",    color = color.orange,   linewidth = 2)
plot(sma200, title = "Trend Line (200)",     color = color.blue, linewidth = 3)

// Visual Signals
plotshape(longEntryCond, title="Sniper Signal", style=shape.labelup, location=location.belowbar, color=color.green, text="BUY", textcolor=color.white)
plotshape(takeProfitCond and inLong, title="Take Profit", style=shape.labeldown, location=location.abovebar, color=color.purple, text="TP", textcolor=color.white)
plotshape(stopLossCond and inLong and not takeProfitCond, title="Stop Loss", style=shape.labeldown, location=location.abovebar, color=color.red, text="SELL", textcolor=color.white)
