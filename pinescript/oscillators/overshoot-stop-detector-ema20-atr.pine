//@version=5
indicator("Overshoot Stop Detector (EMA20 + ATR)", overlay=true)

// Inputs
emaLen = input.int(20, "EMA length")
atrLen = input.int(14, "ATR length")
osMult = input.float(2.0, "Overshoot distance (ATR x)", step=0.25)
shrinkMult = input.float(0.70, "Next-bar range shrink (x of overshoot bar)", step=0.05)
useVolume = input.bool(true, "Use volume filter")
volLen = input.int(20, "Volume MA length")
volMult = input.float(1.5, "Overshoot volume spike (x)", step=0.1)

// Core series
ema20 = ta.ema(close, emaLen)
atr = ta.atr(atrLen)
volMA = ta.sma(volume, volLen)

// 1) Overshoot bar (previous bar)
prevRange = high[1] - low[1]
prevDist = math.abs(close[1] - ema20[1])
prevRed = close[1] < open[1]

overshoot = prevRed and (prevDist > osMult * atr[1])

// Optional: volume spike on overshoot day
volOK = not useVolume or (volume[1] > volMult * volMA[1])

// 2) Stop bar (current bar): volatility contraction / not making a fresh low
curRange = high - low
rangeShrinks = curRange < shrinkMult * prevRange
notLowerLow = low >= low[1]

// close strength (helps avoid dead-cat bounces that still close weak)
closeAboveMidPrev = close > (low[1] + prevRange * 0.5)

// Stop signal
stopSignal = overshoot and volOK and rangeShrinks and notLowerLow and closeAboveMidPrev

plotshape(overshoot, title="Overshoot", style=shape.triangledown, location=location.abovebar, size=size.tiny, text="OS")
plotshape(stopSignal, title="Stop", style=shape.circle, location=location.belowbar, size=size.small, text="STOP")

plot(ema20, title="EMA20")
