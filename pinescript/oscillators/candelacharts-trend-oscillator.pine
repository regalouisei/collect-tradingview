// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © CandelaCharts

//@version=6
indicator(title = "CandelaCharts - Trend Oscillator", shorttitle = "CandelaCharts - Trend Oscillator", overlay=false)












// # ========================================================================= #
// # |   Colors   |
// # ========================================================================= #

//#region

// Core
colors_white          = color.white
colors_black          = color.black
colors_gray           = color.gray
colors_blue           = color.blue
colors_orange         = color.orange
colors_green          = color.green
colors_red            = color.red
color_transparent     = #00000000

//#endregion

// # ========================================================================= #
// # |   End   |
// # ========================================================================= #












// # ========================================================================= #
// # |   Inputs   |
// # ========================================================================= #

//#region

// # General ----------------------------------------------------------------- #

general_font            = input.string("Monospace", "Text                    ", options=["Default", "Monospace"], inline="1.0", group="General")
general_text            = input.string("Tiny", "", options=["Tiny", "Small", "Normal", "Large", "Huge", "Auto"], inline="1.0", group="General", tooltip="Text size")
general_brand_show      = input.bool(false, "Hide Brand", group="General")

to_fast_len             = input.int(9,  "Fast EMA Length  ", minval=1, inline = "1.0", group = "Settings")
to_slow_len             = input.int(21, "Slow EMA Length ", minval=1, inline = "2.0", group = "Settings")
to_bias_factor          = input.float(1.001, "Bias Multiplier      ", step=0.001, inline = "3.0", group = "Settings")
to_smooth_len           = input.int(5,  "Smoothing Length", minval=1, inline = "4.0", group = "Settings")
to_color_bull           = input.color(color.lime, "Colors                 ", inline = "5.0", group = "Settings")
to_color_bear           = input.color(color.red, "", inline = "5.0", group = "Settings")
to_color_bars           = input.bool(true, "Color Price Bars", inline = "6.0", group = "Settings")

//#endregion

// # ========================================================================= #
// # |   End   |
// # ========================================================================= #












// # ========================================================================= #
// # |   Functions   |
// # ========================================================================= #

//#region

text_size(size) =>
    switch size
        "Tiny"   => size.tiny
        "Small"  => size.small
        "Normal" => size.normal
        "Large"  => size.large
        "Huge"   => size.huge
        => size.auto

font_family(font) =>
    switch font
        "Default"   => font.family_default
        "Monospace" => font.family_monospace

//#endregion

// # ========================================================================= #
// # |   End   |
// # ========================================================================= #












// # ========================================================================= #
// # |   Algorithm   |
// # ========================================================================= #

//#region

// Core calcs
fast_ema     = ta.ema(close, to_fast_len)
slow_ema     = ta.ema(close, to_slow_len)
raw_spread   = (fast_ema - slow_ema) * to_bias_factor
spread_smth  = ta.ema(raw_spread, to_smooth_len)  // smoothed line

// Colors
the_color   = spread_smth > 0 ? to_color_bull : to_color_bear

// Plots (global only)
hline(0, "Zero", color=color.gray, linewidth=2, linestyle = hline.style_solid)
plot(spread_smth, "Trend Oscillator", color=the_color, linewidth=2)

// Price bar coloring
barcolor(to_color_bars ? the_color : na)

//#endregion

// # ========================================================================= #
// # |   End   |
// # ========================================================================= #












// # ========================================================================= #
// # |   Brand Label   |
// # ========================================================================= #

//#region

if barstate.isfirst and not general_brand_show
    var table brand_table = table.new(position.bottom_right, 1, 1, bgcolor=chart.bg_color)
    table.cell(brand_table, 0, 0, "© CandelaCharts", text_color=color.new(colors_gray, 30),
               text_halign=text.align_center, text_size=text_size(general_text),
               text_font_family=font_family(general_font))
//#endregion

// # ========================================================================= #
// # |   End   |
// # ========================================================================= #
