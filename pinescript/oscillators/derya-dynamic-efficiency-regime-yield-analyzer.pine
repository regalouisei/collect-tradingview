//@version=5
indicator("DERYA Dynamic Efficiency Regime Yield Analyzer", shorttitle="DERYA ", overlay=false)

// --- 1. CALCULATION ENGINE (AS PER RESEARCH PAPER) ---
span = input.int(14, title="Smoothing Period", minval=1)
lookback = input.int(200, title="Normalization Window", minval=1)

// Intrabar Proxy Method
delta_c = math.abs(close - close[1])
hl_range = high - low
epsilon = 1e-9
E = delta_c / (hl_range + epsilon)

// Smoothing & Normalization
raw_metric = ta.ema(E, span) * 100
roll_min = ta.lowest(raw_metric, lookback)
roll_max = ta.highest(raw_metric, lookback)

denominator = roll_max - roll_min
derya = 0.0
if denominator > epsilon
    derya := 100 * (raw_metric - roll_min) / denominator
else
    derya := 50

// --- 2. VISUALIZATION (VISUAL INNOVATION) ---

// Color Palette (Heatmap Logic)
// Above 60: Robust Structure (Green)
// Below 40: Structural Collapse (Red)
col_derya = derya > 60 ? #00b500 : derya < 40 ? color.new(#ff0000, 0) : color.new(color.gray, 20)

// A) Dynamic Area Plot (Seismographic Aesthetic)
// Using line style with an area feel for visual density
plot(derya, title="DERYA Signal", color=col_derya, linewidth=2, style=plot.style_line)

// Shading below the signal to represent "Market Energy"
p1 = plot(derya, display=display.none)
p2 = plot(0, display=display.none)
fill(p1, p2, color=color.new(col_derya, 80), title="Energy Fill")

// B) Regime Thresholds (Defined regions, not just lines)
h_band = hline(60, "Efficiency Threshold", color=color.gray, linestyle=hline.style_dotted)
l_band = hline(40, "Collapse Threshold", color=color.gray, linestyle=hline.style_dotted)

// Background shading for extreme regimes
bgcolor(derya < 20 ? color.new(color.red, 90) : na, title="Extreme Collapse Zone")

// --- 3. BAR COLORING ---
// This feature integrates the microstructural health directly onto the price chart.
// If DERYA < 30 (Severe Inefficiency), the bar is colored dark.
// This serves as a warning: "Price is moving, but the internal engine is broken."
barcolor(derya < 30 ? color.black : na, title="Inefficient Bars (Black)")

// --- 4. ALERT SYSTEM ---
alertcondition(derya < 40, title="Structural Break Warning", message="DERYA Alert: Market Structure is Collapsing (<40)")
alertcondition(derya > 60, title="High Efficiency Pulse", message="DERYA Alert: High Efficiency Trend (>60)")
