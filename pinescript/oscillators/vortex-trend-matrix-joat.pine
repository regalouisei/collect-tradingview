// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © officialjackofalltrades

//@version=6
indicator("Vortex Trend Matrix", shorttitle="VTM", overlay=true, max_labels_count=200)

// ══════════════════════════════════════════════════════════════════════════════
// VORTEX TREND MATRIX - Multi-Timeframe Trend Analysis Dashboard
// Combines Ichimoku-style equilibrium with vortex indicator for trend confluence
// ══════════════════════════════════════════════════════════════════════════════

// ─────────────────────────────────────────────────────────────────────────────
// INPUTS
// ─────────────────────────────────────────────────────────────────────────────

var grpEquilibrium = "Equilibrium Lines"
int conversionPeriod = input.int(9, "Conversion Period", minval=1, maxval=50, group=grpEquilibrium)
int basePeriod = input.int(26, "Base Period", minval=1, maxval=100, group=grpEquilibrium)
int leadSpanPeriod = input.int(52, "Lead Span Period", minval=1, maxval=200, group=grpEquilibrium)
int displacement = input.int(26, "Displacement", minval=1, maxval=100, group=grpEquilibrium)

var grpVortex = "Vortex Settings"
int vortexPeriod = input.int(14, "Vortex Period", minval=2, maxval=50, group=grpVortex)
float viUpperBand = input.float(1.10, "VI+ Strength", minval=1.0, maxval=1.5, step=0.05, group=grpVortex)
float viLowerBand = input.float(0.90, "VI- Strength", minval=0.5, maxval=1.0, step=0.05, group=grpVortex)

var grpDisplay = " Display Settings"
bool showCloud = input.bool(true, "Show Trend Cloud", group=grpDisplay)
bool showEquilibrium = input.bool(true, "Show Equilibrium Lines", group=grpDisplay)
bool showLaggingSpan = input.bool(true, "Show Lagging Span", group=grpDisplay)
bool showCrossovers = input.bool(true, "Show Crossover Signals", group=grpDisplay)
bool showVortexArrows = input.bool(true, "Show Vortex Arrows", group=grpDisplay)
bool showDashboard = input.bool(true, "Show Analysis Dashboard", group=grpDisplay)

var grpColors = " Color Theme"
color conversionColor = input.color(color.rgb(255, 102, 146), "Conversion Line", group=grpColors)
color baseColor = input.color(color.rgb(80, 164, 255), "Base Line", group=grpColors)
color leadAColor = input.color(color.rgb(18, 64, 104), "Lead Span A", group=grpColors)
color leadBColor = input.color(color.rgb(64, 24, 46), "Lead Span B", group=grpColors)
color laggingColor = input.color(color.rgb(170, 190, 205), "Lagging Span", group=grpColors)
color bullCloudColor = input.color(color.new(color.rgb(10, 60, 92), 65), "Bull Cloud", group=grpColors)
color bearCloudColor = input.color(color.new(color.rgb(70, 18, 34), 65), "Bear Cloud", group=grpColors)
color crossUpColor = input.color(color.rgb(0, 220, 200), "Cross Up", group=grpColors)
color crossDnColor = input.color(color.rgb(255, 110, 110), "Cross Down", group=grpColors)

// ─────────────────────────────────────────────────────────────────────────────
// EQUILIBRIUM CALCULATIONS (Ichimoku-style)
// ─────────────────────────────────────────────────────────────────────────────

// Donchian Channel Midpoint function
getMidpoint(int len) =>
    math.avg(ta.lowest(len), ta.highest(len))

// Core lines
float conversionLine = getMidpoint(conversionPeriod)
float baseLine = getMidpoint(basePeriod)
float leadSpanA = math.avg(conversionLine, baseLine)
float leadSpanB = getMidpoint(leadSpanPeriod)

// Displaced cloud values (for current position analysis)
float cloudTop = math.max(leadSpanA[displacement], leadSpanB[displacement])
float cloudBottom = math.min(leadSpanA[displacement], leadSpanB[displacement])

// ─────────────────────────────────────────────────────────────────────────────
// VORTEX INDICATOR CALCULATIONS
// ─────────────────────────────────────────────────────────────────────────────

float vmPlus = math.sum(math.abs(high - low[1]), vortexPeriod)
float vmMinus = math.sum(math.abs(low - high[1]), vortexPeriod)
float sumTR = math.sum(ta.atr(1), vortexPeriod)

float viPlus = vmPlus / sumTR
float viMinus = vmMinus / sumTR

// Vortex trend states
bool vortexBull = viPlus > viMinus and viPlus > viUpperBand
bool vortexBear = viMinus > viPlus and viMinus > viLowerBand

// ─────────────────────────────────────────────────────────────────────────────
// TREND ANALYSIS
// ─────────────────────────────────────────────────────────────────────────────

// Base line direction (key trend indicator)
int baseDirection = baseLine > baseLine[1] ? 1 : baseLine < baseLine[1] ? -1 : 0
var int prevBaseDirection = 0
int baseDirectionChange = 0

if baseDirection != prevBaseDirection and baseDirection != 0
    baseDirectionChange := baseDirection
    prevBaseDirection := baseDirection

// Lagging span confirmation
bool laggingBull = close > close[displacement]
bool laggingBear = close < close[displacement]

// Cloud position
bool aboveCloud = close > cloudTop
bool belowCloud = close < cloudBottom
bool insideCloud = close >= cloudBottom and close <= cloudTop

// TK Cross detection
bool tkCrossUp = ta.crossover(conversionLine, baseLine)
bool tkCrossDn = ta.crossunder(conversionLine, baseLine)

// Track consecutive TK signals
var int tkSignalCount = 0
var int tkDirection = 0

if tkCrossUp
    if tkDirection == 1
        tkSignalCount += 1
    else
        tkSignalCount := 1
        tkDirection := 1
else if tkCrossDn
    if tkDirection == -1
        tkSignalCount -= 1
    else
        tkSignalCount := -1
        tkDirection := -1

// ─────────────────────────────────────────────────────────────────────────────
// COMPOSITE TREND SCORE
// ─────────────────────────────────────────────────────────────────────────────

float trendScore = 0.0

// Cloud position score
trendScore += aboveCloud ? 2.0 : belowCloud ? -2.0 : 0.0

// TK relationship score
trendScore += conversionLine > baseLine ? 1.0 : conversionLine < baseLine ? -1.0 : 0.0

// Lagging span score
trendScore += laggingBull ? 1.0 : laggingBear ? -1.0 : 0.0

// Vortex score
trendScore += vortexBull ? 1.5 : vortexBear ? -1.5 : 0.0

// Base direction score
trendScore += baseDirection * 0.5

// Trend classification
string trendStatus = trendScore >= 4 ? " STRONG BULL" : 
                      trendScore >= 2 ? " BULL" : 
                      trendScore <= -4 ? " STRONG BEAR" : 
                      trendScore <= -2 ? " BEAR" : "NEUTRAL"

color trendColor = trendScore >= 2 ? crossUpColor : trendScore <= -2 ? crossDnColor : color.gray

// ─────────────────────────────────────────────────────────────────────────────
// VISUALIZATION - EQUILIBRIUM LINES
// ─────────────────────────────────────────────────────────────────────────────

plot(showEquilibrium ? conversionLine : na, "Conversion", color=conversionColor, linewidth=2, style=plot.style_line)
plot(showEquilibrium ? baseLine : na, "Base", color=baseColor, linewidth=3, style=plot.style_line)
plot(showLaggingSpan ? close : na, "Lagging Span", offset=-displacement, color=laggingColor, linewidth=2, style=plot.style_line)

// ─────────────────────────────────────────────────────────────────────────────
// VISUALIZATION - CLOUD
// ─────────────────────────────────────────────────────────────────────────────

pLeadA = plot(showCloud ? leadSpanA : na, "Lead Span A", offset=displacement, color=leadAColor, linewidth=1)
pLeadB = plot(showCloud ? leadSpanB : na, "Lead Span B", offset=displacement, color=leadBColor, linewidth=1)
fill(pLeadA, pLeadB, color=leadSpanA > leadSpanB ? bullCloudColor : bearCloudColor, title="Trend Cloud")

// ─────────────────────────────────────────────────────────────────────────────
// VISUALIZATION - SIGNALS
// ─────────────────────────────────────────────────────────────────────────────

// TK Cross signals
plotshape(showCrossovers and tkCrossUp ? conversionLine : na, "TK Cross Up", shape.arrowup, location.absolute, crossUpColor, size=size.small)
plotshape(showCrossovers and tkCrossDn ? conversionLine : na, "TK Cross Down", shape.arrowdown, location.absolute, crossDnColor, size=size.small)

// Base direction arrows
plotshape(showVortexArrows and baseDirectionChange == 1 ? baseLine : na, "Base Up", shape.triangleup, location.absolute, color.new(#00BCD4, 0), size=size.tiny)
plotshape(showVortexArrows and baseDirectionChange == -1 ? baseLine : na, "Base Down", shape.triangledown, location.absolute, color.new(#FF9800, 0), size=size.tiny)

// ─────────────────────────────────────────────────────────────────────────────
// MULTI-TIMEFRAME LABELS (for Base Line levels)
// ─────────────────────────────────────────────────────────────────────────────

var label baseLabel = na

if barstate.islast and showEquilibrium
    label.delete(baseLabel)
    baseLabel := label.new(bar_index + 3, baseLine, "Base", color=color.new(baseColor, 80), textcolor=baseColor, style=label.style_label_left, size=size.tiny)

// ─────────────────────────────────────────────────────────────────────────────
// ANALYSIS DASHBOARD
// ─────────────────────────────────────────────────────────────────────────────

var table dashboard = table.new(position.top_right, 3, 8, bgcolor=color.new(#05050A, 12), border_width=2, border_color=color.new(#5E2E91, 40))

if barstate.islast and showDashboard
    color headerBg = color.new(#6366F1, 10)
    color metricBg = color.new(#0A101C, 70)
    color stateBg = color.new(#08121F, 60)
    color detailBg = color.new(#040910, 80)

    // Header row labeling top/second/third boxes
    table.cell(dashboard, 0, 0, "VORTEX MATRIX", text_color=color.white, text_size=size.large, bgcolor=headerBg)
    table.cell(dashboard, 1, 0, "Signal", text_color=color.white, text_size=size.small, bgcolor=color.new(#2A3B7C, 40))
    table.cell(dashboard, 2, 0, "Detail", text_color=color.white, text_size=size.small, bgcolor=color.new(#2A3B7C, 40))
    
    // Trend Status
    table.cell(dashboard, 0, 1, "Trend", text_color=color.gray, text_size=size.small, bgcolor=metricBg)
    table.cell(dashboard, 1, 1, trendStatus, text_color=trendColor, text_size=size.normal, bgcolor=stateBg)
    table.cell(dashboard, 2, 1, str.tostring(trendScore, "#.#"), text_color=trendColor, text_size=size.small, bgcolor=detailBg)
    
    // Cloud Position
    string cloudPos = aboveCloud ? "ABOVE" : belowCloud ? "BELOW" : "INSIDE"
    color cloudPosColor = aboveCloud ? crossUpColor : belowCloud ? crossDnColor : color.orange
    table.cell(dashboard, 0, 2, "Cloud", text_color=color.gray, text_size=size.small, bgcolor=metricBg)
    table.cell(dashboard, 1, 2, cloudPos, text_color=cloudPosColor, text_size=size.normal, bgcolor=stateBg)
    table.cell(dashboard, 2, 2, insideCloud ? "Equilibrium" : cloudPos == "ABOVE" ? "Momentum" : "Weakness", text_color=cloudPosColor, text_size=size.small, bgcolor=detailBg)
    
    // TK Status
    string tkStatus = conversionLine > baseLine ? "BULL" : conversionLine < baseLine ? "BEAR" : "FLAT"
    color tkColor = conversionLine > baseLine ? crossUpColor : conversionLine < baseLine ? crossDnColor : color.gray
    table.cell(dashboard, 0, 3, "TK Cross", text_color=color.gray, text_size=size.small, bgcolor=metricBg)
    table.cell(dashboard, 1, 3, tkStatus, text_color=tkColor, text_size=size.normal, bgcolor=stateBg)
    table.cell(dashboard, 2, 3, str.tostring(tkSignalCount), text_color=tkColor, text_size=size.small, bgcolor=detailBg)
    
    // Lagging Span
    string lagStatus = laggingBull ? "BULL" : laggingBear ? "BEAR" : "NEUTRAL"
    color lagColor = laggingBull ? crossUpColor : laggingBear ? crossDnColor : color.gray
    table.cell(dashboard, 0, 4, "Lagging", text_color=color.gray, text_size=size.small, bgcolor=metricBg)
    table.cell(dashboard, 1, 4, lagStatus, text_color=lagColor, text_size=size.normal, bgcolor=stateBg)
    table.cell(dashboard, 2, 4, not na(close[displacement]) ? str.tostring(close - close[displacement], "#.##") : "-", text_color=lagColor, text_size=size.small, bgcolor=detailBg)
    
    // Vortex
    string vxStatus = vortexBull ? "BULL" : vortexBear ? "BEAR" : "NEUTRAL"
    color vxColor = vortexBull ? crossUpColor : vortexBear ? crossDnColor : color.gray
    table.cell(dashboard, 0, 5, "Vortex", text_color=color.gray, text_size=size.small, bgcolor=metricBg)
    table.cell(dashboard, 1, 5, vxStatus, text_color=vxColor, text_size=size.normal, bgcolor=stateBg)
    table.cell(dashboard, 2, 5, str.tostring(viPlus - viMinus, "#.##"), text_color=vxColor, text_size=size.small, bgcolor=detailBg)
    
    // VI Values
    table.cell(dashboard, 0, 6, "VI+", text_color=crossUpColor, text_size=size.small, bgcolor=metricBg)
    table.cell(dashboard, 1, 6, str.tostring(viPlus, "#.##"), text_color=color.white, text_size=size.normal, bgcolor=stateBg)
    table.cell(dashboard, 2, 6, "Band " + str.tostring(viUpperBand, "#.##"), text_color=crossUpColor, text_size=size.small, bgcolor=detailBg)
    
    table.cell(dashboard, 0, 7, "VI-", text_color=crossDnColor, text_size=size.small, bgcolor=metricBg)
    table.cell(dashboard, 1, 7, str.tostring(viMinus, "#.##"), text_color=color.white, text_size=size.normal, bgcolor=stateBg)
    table.cell(dashboard, 2, 7, "Band " + str.tostring(viLowerBand, "#.##"), text_color=crossDnColor, text_size=size.small, bgcolor=detailBg)

// ─────────────────────────────────────────────────────────────────────────────
// ALERTS
// ─────────────────────────────────────────────────────────────────────────────

alertcondition(tkCrossUp, "TK Cross Up", "Vortex Matrix: Bullish TK Cross!")
alertcondition(tkCrossDn, "TK Cross Down", "Vortex Matrix: Bearish TK Cross!")
alertcondition(baseDirectionChange == 1, "Base Turns Up", "Vortex Matrix: Base line turning bullish!")
alertcondition(baseDirectionChange == -1, "Base Turns Down", "Vortex Matrix: Base line turning bearish!")
alertcondition(trendScore >= 4, "Strong Bull Trend", "Vortex Matrix: Strong bullish confluence!")
alertcondition(trendScore <= -4, "Strong Bear Trend", "Vortex Matrix: Strong bearish confluence!")
