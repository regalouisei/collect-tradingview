//@version=5
indicator("RSI Zones + Swing Divergences + OB/OS zones By Happy", overlay=false, max_lines_count=500, max_labels_count=500)

// ================= RSI
rLen   = input.int(14, "RSI Length", minval=2)
rSrc   = input.source(close, "RSI Source")
rW     = input.int(1, "RSI line width", minval=1)
rClr   = input.color(color.white, "RSI color")
emaClr = input.color(color.gray,  "EMA color")

r  = ta.rsi(rSrc, rLen)
re = ta.ema(r, math.max(2, rLen/2))

// ================= Levels
up80 = input.int(80, "Upper 80")
up70 = input.int(70, "Upper 70")
mid  = input.int(50, "Middle 50")
lo30 = input.int(30, "Lower 30")
lo20 = input.int(20, "Lower 20")

// --- постоянная серая зона 70–30 на всю ширину (через hline + fill)
band7030 = input.color(color.new(color.gray,85), "70–30 band color")
h70 = hline(up70, "70", color=color.new(color.gray, 100), display=display.all)
h30 = hline(lo30, "30", color=color.new(color.gray, 100), display=display.all)
fill(h70, h30, color=band7030, title="70–30 band (full width)")

// --- линии уровней
h80 = hline(up80, "80", color=color.new(color.gray,40))
h50 = hline(mid,  "50", color=color.new(color.gray,85))
h20 = hline(lo20, "20", color=color.new(color.gray,40))

// ================= OS/OB Background (история, как в оригинале)
show7030 = input.bool(true,  "OS/OB BG 70/30")
show8020 = input.bool(true,  "OS/OB BG 80/20")

bg70col  = input.color(color.new(color.rgb(255, 80,  80), 88), "BG >70")
bg30col  = input.color(color.new(color.rgb(  0,160, 150), 88), "BG <30")
bg80col  = input.color(color.new(color.rgb(150, 30,  30),  84), "BG ≥80")
bg20col  = input.color(color.new(color.rgb(  0,120, 140),  84), "BG ≤20")

// вертикальные блоки на всю высоту панели
bgcolor(show7030 and r >  up70 ? bg70col : na)
bgcolor(show7030 and r <  lo30 ? bg30col : na)
bgcolor(show8020 and r >= up80 ? bg80col : na)
bgcolor(show8020 and r <= lo20 ? bg20col : na)

// --- RSI линии
plot(r,  "RSI",     color=rClr,  linewidth=rW)
plot(re, "RSI EMA", color=emaClr, linewidth=rW)

// ================= Divergences (по свингам цены)
bullPriceSrc = input.string("close", "Bull price source", options=["open","high","low","close","hl2","hlc3","ohlc4"])
bearPriceSrc = input.string("close", "Bear price source", options=["open","high","low","close","hl2","hlc3","ohlc4"])

L = input.int(3, "Pivot left bars",  minval=1)
R = input.int(3, "Pivot right bars", minval=1)
maxSpan   = input.int(60, "Max bars between swings", minval=5)
minRsiGap = input.float(0.5, "Min RSI gap", step=0.1)
minPxGap  = input.float(0.0, "Min Price gap", step=0.1)

showRegBull = input.bool(true,  "Show regular bull")
showHidBull = input.bool(true,  "Show hidden bull")
showRegBear = input.bool(true,  "Show regular bear")
showHidBear = input.bool(true,  "Show hidden bear")

colRegBull  = input.color(color.lime,   "Reg bull color")
colHidBull  = input.color(color.teal,   "Hidden bull color")
colRegBear  = input.color(color.red,    "Reg bear color")
colHidBear  = input.color(color.orange, "Hidden bear color")
divW        = input.int(2, "Divergence line width", minval=1)

// helper: выбрать ценовой источник
priceFrom(srcName) =>
    float out = na
    if srcName == "open"
        out := open
    else if srcName == "high"
        out := high
    else if srcName == "low"
        out := low
    else if srcName == "close"
        out := close
    else if srcName == "hl2"
        out := (high + low) / 2.0
    else if srcName == "hlc3"
        out := (high + low + close) / 3.0
    else
        out := (open + high + low + close) / 4.0
    out

bullP = priceFrom(bullPriceSrc)
bearP = priceFrom(bearPriceSrc)

ph = ta.pivothigh(bearP, L, R)
pl = ta.pivotlow (bullP, L, R)

var int   lastTopIdx = na
var float lastTopPx  = na
var float lastTopRsi = na
var int   lastBotIdx = na
var float lastBotPx  = na
var float lastBotRsi = na

draw(x0,y0,x1,y1,col,dotted)=>
    line.new(x0,y0,x1,y1, xloc=xloc.bar_index, extend=extend.none,
             color=col, width=divW, style=dotted?line.style_dotted:line.style_solid)

// Bear: свинг-хаи
if not na(ph)
    int   idx = bar_index - R
    float px  = nz(bearP[R])
    float rs  = nz(r[R])
    if not na(lastTopIdx) and idx - lastTopIdx <= maxSpan
        bool regular = showRegBear and (px > lastTopPx + minPxGap) and (rs < lastTopRsi - minRsiGap) // Price HH, RSI LH
        bool hidden  = showHidBear and (px < lastTopPx - minPxGap) and (rs > lastTopRsi + minRsiGap) // Price LH, RSI HH
        if regular
            draw(lastTopIdx,lastTopRsi, idx,rs, colRegBear, false)
        if hidden
            draw(lastTopIdx,lastTopRsi, idx,rs, colHidBear, true)
    lastTopIdx := idx
    lastTopPx  := px
    lastTopRsi := rs

// Bull: свинг-лои
if not na(pl)
    int   idx2 = bar_index - R
    float px2  = nz(bullP[R])
    float rs2  = nz(r[R])
    if not na(lastBotIdx) and idx2 - lastBotIdx <= maxSpan
        bool regular2 = showRegBull and (px2 < lastBotPx - minPxGap) and (rs2 > lastBotRsi + minRsiGap) // Price LL, RSI HL
        bool hidden2  = showHidBull and (px2 > lastBotPx + minPxGap) and (rs2 < lastBotRsi - minRsiGap) // Price HL, RSI LL
        if regular2
            draw(lastBotIdx,lastBotRsi, idx2,rs2, colRegBull, false)
        if hidden2
            draw(lastBotIdx,lastBotRsi, idx2,rs2, colHidBull, true)
    lastBotIdx := idx2
    lastBotPx  := px2
    lastBotRsi := rs2
