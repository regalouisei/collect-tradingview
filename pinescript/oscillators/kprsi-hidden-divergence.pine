//@version=6
indicator("KPRSI – EMA20 + RSI Divergence (One-Time Signals + Flat Detection) ⚡", overlay=true, max_lines_count=500, max_labels_count=500)

// === INPUTS ===
emaLen     = input.int(20, "EMA Length", minval=1)
rsiLen     = input.int(14, "RSI Length", minval=2)
pivLeft    = input.int(5, "Pivot Left", minval=1)
pivRight   = input.int(5, "Pivot Right", minval=1)
slopeSens  = input.float(0.05, "EMA Slope Threshold (%)", step=0.01)
tolerance  = input.float(0.2, "Price Equality Tolerance (%)", step=0.05)  // NEW

// === CORE SERIES ===
ema20   = ta.ema(close, emaLen)
rsi     = ta.rsi(close, rsiLen)
emaSlope = (ema20 - ema20[1]) / ema20[1] * 100
emaUp    = emaSlope >  slopeSens
emaDown  = emaSlope < -slopeSens

// === PIVOTS ===
ph = ta.pivothigh(high, pivLeft, pivRight)
pl = ta.pivotlow(low,  pivLeft, pivRight)

// === STORE LAST TWO PRICE & RSI PIVOTS ===
var float prevPriceHigh = na
var float lastPriceHigh = na
var float prevRsiHigh   = na
var float lastRsiHigh   = na
var int   prevHighBar   = na
var int   lastHighBar   = na

var float prevPriceLow  = na
var float lastPriceLow  = na
var float prevRsiLow    = na
var float lastRsiLow    = na
var int   prevLowBar    = na
var int   lastLowBar    = na

// === RECORD PIVOTS ===
if not na(ph)
    prevPriceHigh := lastPriceHigh
    prevRsiHigh   := lastRsiHigh
    prevHighBar   := lastHighBar
    lastPriceHigh := high[pivRight]
    lastRsiHigh   := rsi[pivRight]
    lastHighBar   := bar_index - pivRight

if not na(pl)
    prevPriceLow  := lastPriceLow
    prevRsiLow    := lastRsiLow
    prevLowBar    := lastLowBar
    lastPriceLow  := low[pivRight]
    lastRsiLow    := rsi[pivRight]
    lastLowBar    := bar_index - pivRight

// === DIVERGENCE DETECTION (with tolerance) ===
priceDiffLow  = math.abs((lastPriceLow  - prevPriceLow)  / prevPriceLow)  * 100
priceDiffHigh = math.abs((lastPriceHigh - prevPriceHigh) / prevPriceHigh) * 100

bullDiv = not na(lastPriceLow)  and not na(prevPriceLow)  and not na(lastRsiLow)  and not na(prevRsiLow)  and
          ((lastPriceLow  < prevPriceLow) or priceDiffLow <= tolerance)  and (lastRsiLow  > prevRsiLow)

bearDiv = not na(lastPriceHigh) and not na(prevPriceHigh) and not na(lastRsiHigh) and not na(prevRsiHigh) and
          ((lastPriceHigh > prevPriceHigh) or priceDiffHigh <= tolerance) and (lastRsiHigh < prevRsiHigh)

// === SIGNAL CONDITIONS ===
divSell = bearDiv and emaDown and close < ema20
divBuy  = bullDiv and emaUp   and close > ema20

// === TRACK LAST PIVOT USED TO FIRE SIGNAL ===
var int lastSellPivotBar = na
var int lastBuyPivotBar  = na

newSellSignal = divSell and (na(lastSellPivotBar) or lastSellPivotBar != lastHighBar)
newBuySignal  = divBuy  and (na(lastBuyPivotBar)  or lastBuyPivotBar  != lastLowBar)

if newSellSignal
    lastSellPivotBar := lastHighBar
if newBuySignal
    lastBuyPivotBar  := lastLowBar

// === PLOTS ===
plot(ema20, "EMA 20", color=color.new(color.orange, 0), linewidth=2)
plotshape(newBuySignal,  title="DivBuy",  location=location.belowbar, style=shape.labelup,
          color=color.new(color.teal, 0), text="DivBuy",  textcolor=color.white, size=size.normal)
plotshape(newSellSignal, title="DivSell", location=location.abovebar, style=shape.labeldown,
          color=color.new(color.red,  0), text="DivSell", textcolor=color.white, size=size.normal)

// === DRAW DIVERGENCE LINES + LABELS ===
if bullDiv and not na(prevLowBar)
    line.new(prevLowBar, prevPriceLow, lastLowBar, lastPriceLow, color=color.new(color.fuchsia, 0), width=2)
    label.new(lastLowBar + 1, lastPriceLow, "Bullish Divergence ⚡",
              style=label.style_label_up, color=color.new(color.teal, 0),
              textcolor=color.white, yloc=yloc.belowbar)

if bearDiv and not na(prevHighBar)
    line.new(prevHighBar, prevPriceHigh, lastHighBar, lastPriceHigh, color=color.new(color.fuchsia, 0), width=2)
    label.new(lastHighBar + 1, lastPriceHigh, "Bearish Divergence ⚡",
              style=label.style_label_down, color=color.new(color.orange, 0),
              textcolor=color.white, yloc=yloc.abovebar)
