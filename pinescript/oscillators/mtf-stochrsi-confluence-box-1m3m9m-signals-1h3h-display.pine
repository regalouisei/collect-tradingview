//@version=6
indicator("MTF 3-9 StochRSI Confluence (3m+9m) + Box", overlay=true)

// ===== Inputs =====
rsiLen     = input.int(14, "RSI Length", minval=1)
stochLen   = input.int(14, "Stoch Length (on RSI)", minval=1)
smoothK    = input.int(3, "Smooth K", minval=1)
smoothD    = input.int(3, "Smooth D", minval=1)
useD       = input.bool(false, "Use %D instead of %K")

buyLevel   = input.float(10.0, "Buy Level (<=)")
sellLevel  = input.float(90.0, "Sell Level (>=)")

onlyOnFlip = input.bool(true, "Only plot on flip")
showBox    = input.bool(true, "Show box")

// Signal TFs (CONFLUENCE ONLY)
tf3 = "3"
tf9 = "9"

// Info TFs (extra display + status line)
tf1  = "1"
tf27 = "27"
tf1h = "60"
tf3h = "180"
tf9h = "540"

// ===== Compact high-contrast styling =====
txtColor = color.white
bgBody   = color.new(color.black, 25)
bgHeader = color.new(color.gray, 20)
bgBuy    = color.new(color.lime, 20)
bgSell   = color.new(color.red, 20)

// ===== StochRSI =====
stochRsi() =>
    r = ta.rsi(close, rsiLen)
    lo = ta.lowest(r, stochLen)
    hi = ta.highest(r, stochLen)
    denom = hi - lo
    v = denom == 0 ? 0 : 100 * (r - lo) / denom
    k = ta.sma(v, smoothK)
    d = ta.sma(k, smoothD)
    useD ? d : k

// ===== MTF values (non-repainting with lookahead_off) =====
s1  = request.security(syminfo.tickerid, tf1,  stochRsi(), barmerge.gaps_off, barmerge.lookahead_off)  // INFO ONLY
s3  = request.security(syminfo.tickerid, tf3,  stochRsi(), barmerge.gaps_off, barmerge.lookahead_off)
s9  = request.security(syminfo.tickerid, tf9,  stochRsi(), barmerge.gaps_off, barmerge.lookahead_off)

s27 = request.security(syminfo.tickerid, tf27, stochRsi(), barmerge.gaps_off, barmerge.lookahead_off)
s1h = request.security(syminfo.tickerid, tf1h, stochRsi(), barmerge.gaps_off, barmerge.lookahead_off)
s3h = request.security(syminfo.tickerid, tf3h, stochRsi(), barmerge.gaps_off, barmerge.lookahead_off)
s9h = request.security(syminfo.tickerid, tf9h, stochRsi(), barmerge.gaps_off, barmerge.lookahead_off)

// ===== Confluence conditions (STRICTLY 3/9) =====
b3 = s3 <= buyLevel
x3 = s3 >= sellLevel

// 9m modified: buy only at 5, sell only at 95
b9 = s9 <= 5
x9 = s9 >= 95

buyCount  = (b3 ? 1 : 0) + (b9 ? 1 : 0)
sellCount = (x3 ? 1 : 0) + (x9 ? 1 : 0)

buyCond  = buyCount == 2
sellCond = sellCount == 2

buySignal  = onlyOnFlip ? (buyCond  and not buyCond[1])  : buyCond
sellSignal = onlyOnFlip ? (sellCond and not sellCond[1]) : sellCond

buyPlot  = buySignal  and not sellSignal
sellPlot = sellSignal and not buySignal

plotshape(buyPlot,  style=shape.labelup,   text="BUY",  location=location.belowbar, color=color.green, textcolor=color.white)
plotshape(sellPlot, style=shape.labeldown, text="SELL", location=location.abovebar, color=color.red,   textcolor=color.white)

alertcondition(buyPlot,  title="BUY: MTF StochRSI Confluence (3/9)",  message="BUY: 3m <= 10 and 9m <= 5")
alertcondition(sellPlot, title="SELL: MTF StochRSI Confluence (3/9)", message="SELL: 3m >= 90 and 9m >= 95")

// ===== Status line numbers (actual stoch values) =====
plot(s1,  "1m",  display=display.status_line) // INFO ONLY (no confluence)
plot(s3,  "3m",  display=display.status_line)
plot(s9,  "9m",  display=display.status_line)
plot(s27, "27m", display=display.status_line)
plot(s1h, "1H",  display=display.status_line)
plot(s3h, "3H",  display=display.status_line)
plot(s9h, "9H",  display=display.status_line)

// ===== Table =====
var table t = table.new(position.top_right, 2, 9, border_width=1)

dotBuySell(v) =>
    v <= buyLevel ? "ðŸŸ¢" : v >= sellLevel ? "ðŸ”´" : "âšª"

fmt(v) => str.tostring(v, "#.0")

if showBox and barstate.islast
    statusBg = buyCond ? bgBuy : sellCond ? bgSell : bgBody

    table.cell(t, 0, 0, "TF", text_color=txtColor, bgcolor=bgHeader, text_size=size.small)
    table.cell(t, 1, 0, timeframe.period, text_color=txtColor, bgcolor=bgHeader, text_size=size.small)

    table.cell(t, 0, 1, "BUY (3/9)", text_color=txtColor, bgcolor=bgBody, text_size=size.small)
    table.cell(t, 1, 1, str.tostring(buyCount) + "/2", text_color=txtColor, bgcolor=bgBody, text_size=size.small)

    table.cell(t, 0, 2, "SELL (3/9)", text_color=txtColor, bgcolor=bgBody, text_size=size.small)
    table.cell(t, 1, 2, str.tostring(sellCount) + "/2", text_color=txtColor, bgcolor=bgBody, text_size=size.small)

    table.cell(t, 0, 3, "STATUS", text_color=txtColor, bgcolor=statusBg, text_size=size.small)
    table.cell(t, 1, 3,
        buyCond ? "BUY confluence" :
        sellCond ? "SELL confluence" :
        "No signal",
        text_color=txtColor, bgcolor=statusBg, text_size=size.small)

    table.cell(t, 0, 4, "Values 1/3/9", text_color=txtColor, bgcolor=bgBody, text_size=size.small)
    table.cell(t, 1, 4,
        "1m " + fmt(s1) + "  3m " + fmt(s3) + "  9m " + fmt(s9),
        text_color=txtColor, bgcolor=bgBody, text_size=size.small)

    table.cell(t, 0, 5, "Info dots 1/3/9", text_color=txtColor, bgcolor=bgBody, text_size=size.small)
    table.cell(t, 1, 5,
        "1m " + dotBuySell(s1) + "  3m " + dotBuySell(s3) + "  9m " + dotBuySell(s9),
        text_color=txtColor, bgcolor=bgBody, text_size=size.small)

    table.cell(t, 0, 6, "Values 27/1H/3H/9H", text_color=txtColor, bgcolor=bgBody, text_size=size.small)
    table.cell(t, 1, 6,
        "27m " + fmt(s27) + "  1H " + fmt(s1h) + "  3H " + fmt(s3h) + "  9H " + fmt(s9h),
        text_color=txtColor, bgcolor=bgBody, text_size=size.small)

    table.cell(t, 0, 7, "Info dots 27/1H/3H", text_color=txtColor, bgcolor=bgBody, text_size=size.small)
    table.cell(t, 1, 7,
        "27m " + dotBuySell(s27) + "  1H " + dotBuySell(s1h) + "  3H " + dotBuySell(s3h) + "  9H " + dotBuySell(s9h),
        text_color=txtColor, bgcolor=bgBody, text_size=size.small)

else if not showBox and barstate.islast
    for r = 0 to 8
        table.cell(t, 0, r, "")
        table.cell(t, 1, r, "")
