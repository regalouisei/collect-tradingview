//@version=5
indicator("Trend & Pullback Cycle [Replica]", shorttitle="Volatility Cycle", overlay=false)

// --- Settings ---
group_set = "Cycle Settings"
src = input(close, title="Source", group=group_set)
length = input.int(100, title="Cycle Lookback Length", minval=1, group=group_set, tooltip="The period over which the cycle is normalized (e.g. 100)")
smooth_len = input.int(3, title="Smoothing Length", minval=1, group=group_set)
signal_len = input.int(7, title="Signal Line Length", minval=1, group=group_set)

// --- Volatility / Momentum Logic ---
// We use a MACD-like momentum calculation but normalize it to a 0-100 scale (Stochastic method)
// This creates the "Cycle" effect that oscillates around 50.

// 1. Core Momentum (MACD style)
fast_ma = ta.ema(src, 12)
slow_ma = ta.ema(src, 26)
macd_raw = fast_ma - slow_ma

// 2. Normalize to 0-100 (The "Cycle")
// We calculate where the current momentum sits relative to the highest/lowest momentum of the last X bars.
lowest_macd = ta.lowest(macd_raw, length)
highest_macd = ta.highest(macd_raw, length)
normalized_cycle = 100 * (macd_raw - lowest_macd) / (highest_macd - lowest_macd)

// 3. Smoothing
cycle_smooth = ta.ema(normalized_cycle, smooth_len)

// 4. Signal Line
signal_line = ta.sma(cycle_smooth, signal_len)

// --- Color Logic ---
// Green when > 50 (Bullish), Red when < 50 (Bearish)
// We also darken the color if it's a "Pullback" (value is decreasing while green, or increasing while red)
midline = 50.0
is_bullish = cycle_smooth >= midline
is_pullback = (is_bullish and cycle_smooth < cycle_smooth[1]) or (not is_bullish and cycle_smooth > cycle_smooth[1])

col_bull = color.new(#00e676, 0)       // Bright Green
col_bull_pull = color.new(#006433, 0) // Dark Green (Pullback)
col_bear = color.new(#ff5252, 0)       // Bright Red
col_bear_pull = color.new(#8b0000, 0) // Dark Red (Pullback)

final_color = is_bullish ? (is_pullback ? col_bull_pull : col_bull) : (is_pullback ? col_bear_pull : col_bear)

// --- Plotting ---
// Plot the Midline
hline(midline, "Zero Line", color=color.gray, linestyle=hline.style_dotted)

// Plot the Histogram (The Cycle)
plot(cycle_smooth, title="Cycle Oscillator", style=plot.style_columns, color=final_color, histbase=50)

// Plot the Signal Line (Yellow)
plot(signal_line, title="Signal Line", color=color.yellow, linewidth=2)

// --- Visual Aids ---
// Optional: Highlights top/bottom zones like the screenshot
h_top = hline(90, "Overbought", color=color.new(color.gray, 100))
h_bot = hline(10, "Oversold", color=color.new(color.gray, 100))
fill(h_top, h_bot, color=color.new(color.blue, 95))
