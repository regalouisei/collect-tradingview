//@version=6
indicator("3 Lines RCI + Psy Signal + RSI Background", overlay=false, max_lines_count=500)

//=== „Éë„É©„É°„Éº„Çø ===//
rciShortLen = input.int(9, "RCI Áü≠Êúü")
rciMidLen   = input.int(26, "RCI ‰∏≠Êúü")
rciLongLen  = input.int(52, "RCI Èï∑Êúü")
psyLen      = input.int(12, "„Çµ„Ç§„Ç≥„É≠„Ç∏„Ç´„É´ÊúüÈñì")
psyOverbought = input.int(70, "„Çµ„Ç§„Ç≥„É≠„Ç∏„Ç´„É´Ë≤∑„Çè„Çå„Åô„Åé")
psyOversold   = input.int(30, "„Çµ„Ç§„Ç≥„É≠„Ç∏„Ç´„É´Â£≤„Çâ„Çå„Åô„Åé")
rciOverHeat   = input.int(80, "RCI ÈÅéÁÜ±„É©„Ç§„É≥")

// ADX „Éë„É©„É°„Éº„Çø
adxLen = input.int(14, "ADXÊúüÈñì")
adxWeak = input.int(20, "ADXÂº±„ÅÑ„Éà„É¨„É≥„ÉâÈñæÂÄ§")
adxMid  = input.int(30, "ADX‰∏≠Èñì„Éà„É¨„É≥„ÉâÈñæÂÄ§")

//=== RSI Ë®≠ÂÆö ===//
rsiLen       = input.int(14, "RSI Èï∑„Åï")
rsiOB        = input.int(68, "RSI Ë≤∑„Çè„Çå„Åô„Åé„É©„Ç§„É≥")
rsiOS        = input.int(32, "RSI Â£≤„Çâ„Çå„Åô„Åé„É©„Ç§„É≥")
rsi = ta.rsi(close, rsiLen)  // ÈùûË°®Á§∫Áî®

//=== RCI Ë®àÁÆóÈñ¢Êï∞ ===//
rci(src, length) =>
    if bar_index < length
        na
    else
        arr = array.new_float(length, 0)
        for i = 0 to length - 1
            array.set(arr, i, src[i])
        ranks = array.new_float(length, 0)
        for i = 0 to length - 1
            rank = 1.0
            val_i = array.get(arr, i)
            for j = 0 to length - 1
                val_j = array.get(arr, j)
                if val_j > val_i
                    rank += 1
            array.set(ranks, i, rank)
        sum_d = 0.0
        for i = 0 to length - 1
            d = i - (array.get(ranks, i)-1)
            sum_d += d * d
        rci_val = 100 * (1 - 6 * sum_d / (length * (length*length -1)))
        math.max(-100, math.min(100, rci_val))

//=== RCI Ë®àÁÆó ===//
rciShort = rci(close, rciShortLen)
rciMid   = rci(close, rciMidLen)
rciLong  = rci(close, rciLongLen)

//=== „Çµ„Ç§„Ç≥„É≠„Ç∏„Ç´„É´Ë®àÁÆó ===//
psyCount = 0
for i = 0 to psyLen - 1
    if close[i] > close[i+1]
        psyCount += 1
psy = 100.0 * psyCount / psyLen

// „Çµ„Ç§„Ç≥„É≠„Ç∏„Ç´„É´Ê£í„Ç∞„É©„Éï
float psySignal = na
color psyColor = color.new(color.gray, 0)
if psy > psyOverbought
    psySignal := (psy - psyOverbought) / (100 - psyOverbought) * 100
    psyColor := color.new(color.red, 0)
else if psy < psyOversold
    psySignal := (psy - psyOversold) / psyOversold * 100
    psyColor := color.new(color.green, 0)
else
    psySignal := na

//=== RCI„É©„Ç§„É≥Ë°®Á§∫ ===//
plot(rciShort, "RCI Áü≠Êúü", color=color.new(color.red, 0))
plot(rciMid,   "RCI ‰∏≠Êúü", color=color.new(color.blue, 0))
plot(rciLong,  "RCI Èï∑Êúü", color=color.new(color.green, 0))

// Âõ∫ÂÆö„Çæ„Éº„É≥Ë°®Á§∫Ôºà+80ÔΩû+100 Ëµ§„ÄÅ-80ÔΩû-100 Á∑ëÔºâ
topZoneLine1 = hline(rciOverHeat, "", color=color.new(color.red, 0))
topZoneLine2 = hline(100, "", color=color.new(color.red, 0))
fill(topZoneLine1, topZoneLine2, color=color.new(color.red, 80))

bottomZoneLine1 = hline(-rciOverHeat, "", color=color.new(color.green, 0))
bottomZoneLine2 = hline(-100, "", color=color.new(color.green, 0))
fill(bottomZoneLine1, bottomZoneLine2, color=color.new(color.green, 80))

// ÈÅéÁÜ±„É©„Ç§„É≥
hline(rciOverHeat, "RCI +80„É©„Ç§„É≥", color=color.red, linestyle=hline.style_dotted)
hline(-rciOverHeat, "RCI -80„É©„Ç§„É≥", color=color.green, linestyle=hline.style_dotted)
hline(0, "„Çº„É≠„É©„Ç§„É≥", color=color.gray)

// „Çµ„Ç§„Ç≥„É≠„Ç∏„Ç´„É´Ê£í„Ç∞„É©„Éï
plot(psySignal, "„Çµ„Ç§„Ç≥„É≠„Ç∏„Ç´„É´„Ç∑„Ç∞„Éä„É´", style=plot.style_columns, color=psyColor, linewidth=3)

//=== üåà RSIËÉåÊôØËâ≤ ===//
bgcolor(rsi > rsiOB ? color.new(color.red, 87) : na)
bgcolor(rsi < rsiOS ? color.new(color.green, 87) : na)

//=== ADXË®àÁÆó (DI+/DI-„Åã„ÇâÁÆóÂá∫) ===//
upMove = high - high[1]
downMove = low[1] - low
plusDM = (upMove > downMove and upMove > 0) ? upMove : 0
minusDM = (downMove > upMove and downMove > 0) ? downMove : 0

// True Range Ë®àÁÆó
tr1 = high - low
tr2 = math.abs(high - close[1])
tr3 = math.abs(low - close[1])
tr = math.max(tr1, math.max(tr2, tr3))
smTR = ta.rma(tr, adxLen)

smPlusDM = ta.rma(plusDM, adxLen)
smMinusDM = ta.rma(minusDM, adxLen)

plusDI = 100 * smPlusDM / smTR
minusDI = 100 * smMinusDM / smTR

dx = 100 * math.abs(plusDI - minusDI) / (plusDI + minusDI)
adxVal = ta.rma(dx, adxLen)

// ADXÊÆµÈöéËâ≤ÂàÜ„Åë
adxColor = adxVal < adxWeak ? color.blue : adxVal < adxMid ? color.yellow : color.red

plot(adxVal, "ADX", color=adxColor, linewidth=2)
hline(adxMid, "‰∏≠ÈñìÈñæÂÄ§", color=color.gray, linestyle=hline.style_dotted)
