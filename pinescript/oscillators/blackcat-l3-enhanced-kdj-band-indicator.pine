//@version=6
indicator("[blackcat] L3 Enhanced KDJ Band Indicator", "L3 Enhanced KDJ Band", overlay=false, max_bars_back=5000)

//**
// 【Enhanced KDJ Band Indicator】
// Indicator Name: Enhanced KDJ Band with Visual Signals
// Indicator Type: Sub-chart Indicator
// Core Function: Multi-period KDJ indicator with enhanced visualization and buy/sell signals
// 
// 【Enhanced Features】
// - Complete KDJ lines (K, D, J) for multiple periods
// - Color-coded zones (overbought/oversold/neutral)
// - Enhanced buy/sell signal markers with different shapes and colors
// - KDJ crossover signals (golden cross and death cross)
// - Visual alerts for key signals
// - Background color zones for different market conditions
// - Signal strength indicators
// - Real-time status table showing current market conditions and KDJ values
// 
// 【Signal Interpretation】
// - Strong Buy Signal (Green Triangle): All KDJ lines in oversold with golden cross
// - Buy Signal (Blue Circle): KDJ in oversold zone
// - Strong Sell Signal (Red Triangle): All KDJ lines in overbought with death cross
// - Sell Signal (Orange Circle): KDJ in overbought zone
// - Golden Cross (Yellow Diamond): K line crosses above D line
// - Death Cross (Purple Diamond): K line crosses below D line
// - Status Table: Real-time display of market status, KDJ values, signal strength, and cross signals
//*/

// ======== INPUT PARAMETERS ========
// Group for KDJ periods
kdjGroup = "KDJ Parameters"
period13 = input.int(13, "13-Day Period", group=kdjGroup)
period21 = input.int(21, "21-Day Period", group=kdjGroup)
period34 = input.int(34, "34-Day Period", group=kdjGroup)
period55 = input.int(55, "55-Day Period", group=kdjGroup)
smoothK = input.int(3, "K-Line Smoothing", group=kdjGroup)
smoothD = input.int(3, "D-Line Smoothing", group=kdjGroup)

// Group for visualization
visualGroup = "Visualization"
showBackground = input.bool(true, "Show Background Zones", group=visualGroup)
showSignals = input.bool(true, "Show Signal Markers", group=visualGroup)
showHistogram = input.bool(true, "Show Signal Strength Histogram", group=visualGroup)
showStatusTable = input.bool(true, "Show Status Table", group=visualGroup)

// ======== KDJ CALCULATIONS ========
// Calculate 13-day period KDJ
rsv13Day = (close - ta.lowest(low, period13)) / (ta.highest(high, period13) - ta.lowest(low, period13)) * 100
k13Day = ta.sma(rsv13Day, smoothK)
d13Day = ta.sma(k13Day, smoothD)
j13Day = 3 * k13Day - 2 * d13Day

// Calculate 21-day period KDJ
rsv21Day = (close - ta.lowest(low, period21)) / (ta.highest(high, period21) - ta.lowest(low, period21)) * 100
k21Day = ta.sma(rsv21Day, smoothK)
d21Day = ta.sma(k21Day, smoothD)
j21Day = 3 * k21Day - 2 * d21Day

// Calculate 34-day period KDJ
rsv34Day = (close - ta.lowest(low, period34)) / (ta.highest(high, period34) - ta.lowest(low, period34)) * 100
k34Day = ta.sma(rsv34Day, smoothK)
d34Day = ta.sma(k34Day, smoothD)
j34Day = 3 * k34Day - 2 * d34Day

// Calculate 55-day period KDJ
rsv55Day = (close - ta.lowest(low, period55)) / (ta.highest(high, period55) - ta.lowest(low, period55)) * 100
k55Day = ta.sma(rsv55Day, smoothK)
d55Day = ta.sma(k55Day, smoothD)
j55Day = 3 * k55Day - 2 * d55Day

// ======== SIGNAL CALCULATIONS ========
// Calculate crossover signals
goldenCross13 = ta.crossover(k13Day, d13Day)
deathCross13 = ta.crossunder(k13Day, d13Day)
goldenCross21 = ta.crossover(k21Day, d21Day)
deathCross21 = ta.crossunder(k21Day, d21Day)
goldenCross34 = ta.crossover(k34Day, d34Day)
deathCross34 = ta.crossunder(k34Day, d34Day)

// Calculate overbought/oversold conditions
overbought13 = k13Day > 80 and d13Day > 80
overbought21 = k21Day > 80 and d21Day > 80
overbought34 = k34Day > 80 and d34Day > 80
overbought55 = k55Day > 80 and d55Day > 80

oversold13 = k13Day < 20 and d13Day < 20
oversold21 = k21Day < 20 and d21Day < 20
oversold34 = k34Day < 20 and d34Day < 20
oversold55 = k55Day < 20 and d55Day < 20

// Calculate strong signals
strongBuySignal = oversold13 and oversold21 and oversold34 and (goldenCross13 or goldenCross21 or goldenCross34)
strongSellSignal = overbought13 and overbought21 and overbought34 and (deathCross13 or deathCross21 or deathCross34)

// Calculate regular signals
buySignal = (oversold13 and oversold21) or (oversold21 and oversold34)
sellSignal = (overbought13 and overbought21) or (overbought21 and overbought34)

// Calculate signal strength
signalStrength = 0
signalStrength := strongBuySignal ? 100 : buySignal and not strongBuySignal ? 75 : signalStrength
signalStrength := strongSellSignal ? -100 : sellSignal and not strongSellSignal ? -75 : signalStrength

// ======== VISUALIZATION ========
// Background zones for market conditions
overboughtColor = showBackground ? color.new(color.red, 80) : na
oversoldColor = showBackground ? color.new(color.green, 80) : na
bgcolor(overboughtColor, title="Overbought Zone")
bgcolor(oversoldColor, title="Oversold Zone")

// Draw K lines with different colors
plot(k13Day, "K13", color.new(color.aqua, 0), 2)
plot(k21Day, "K21", color.blue, 2)
plot(k34Day, "K34", color.orange, 2)
plot(k55Day, "K55", color.fuchsia, 1, plot.style_line)

// Draw D lines with different colors
plot(d13Day, "D13", color.white, 2)
plot(d21Day, "D21", color.yellow, 2)
plot(d34Day, "D34", color.new(color.orange, 25), 2)
plot(d55Day, "D55", color.new(color.fuchsia, 25), 1, plot.style_line)

// Draw J lines with different colors
plot(j13Day, "J13", color.fuchsia, 1)
plot(j21Day, "J21", color.new(color.fuchsia, 25), 1)
plot(j34Day, "J34", color.new(color.orange, 50), 1)
plot(j55Day, "J55", color.new(color.purple, 50), 1, plot.style_line)

// Draw signal strength histogram
plot(showHistogram and signalStrength > 0 ? signalStrength : na, "Buy Strength", color.green, 2, plot.style_columns)
plot(showHistogram and signalStrength < 0 ? signalStrength : na, "Sell Strength", color.red, 2, plot.style_columns)

// Draw reference lines
hline(80, "Overbought Line", color.red, hline.style_dashed)
hline(20, "Oversold Line", color.green, hline.style_dashed)
hline(50, "Neutral Line", color.gray, hline.style_dotted)

// Draw signal markers
// Strong buy signals (green triangles with B label)
plotshape(showSignals and strongBuySignal, "Strong Buy", shape.triangleup, location.bottom, color.green, 3, text="B")

// Regular buy signals (blue circles with B label)
plotshape(showSignals and buySignal and not strongBuySignal, "Buy", shape.circle, location.bottom, color.blue, 2, text="B")

// Strong sell signals (red triangles with S label)
plotshape(showSignals and strongSellSignal, "Strong Sell", shape.triangledown, location.top, color.red, 3, text="S")

// Regular sell signals (orange circles with S label)
plotshape(showSignals and sellSignal and not strongSellSignal, "Sell", shape.circle, location.top, color.orange, 2, text="S")

// Golden cross signals (yellow diamonds)
plotshape(showSignals and (goldenCross13 or goldenCross21 or goldenCross34), "Golden Cross", shape.diamond, location.absolute, color.yellow, 2)

// Death cross signals (purple diamonds)
plotshape(showSignals and (deathCross13 or deathCross21 or deathCross34), "Death Cross", shape.diamond, location.absolute, color.purple, 2)

// ======== STATUS TABLE ========
if showStatusTable
    // Determine current market status
    marketStatus = strongBuySignal ? "STRONG BUY" : buySignal ? "BUY" : strongSellSignal ? "STRONG SELL" : sellSignal ? "SELL" : "NEUTRAL"
    statusColor = strongBuySignal ? color.green : buySignal ? color.new(color.green, 50) : strongSellSignal ? color.red : sellSignal ? color.new(color.red, 50) : color.gray
    
    // Create table
    var table statusTable = table.new(position.top_right, 2, 7, bgcolor=color.white, border_width=1)
    
    // Table headers
    table.cell(statusTable, 0, 0, "Indicator", bgcolor=color.new(color.blue, 70), text_color=color.black, text_size=size.small)
    table.cell(statusTable, 1, 0, "Status", bgcolor=color.new(color.blue, 70), text_color=color.black, text_size=size.small)
    
    // Market status row
    table.cell(statusTable, 0, 1, "Market", bgcolor=color.new(color.gray, 90), text_color=color.black, text_size=size.small)
    table.cell(statusTable, 1, 1, marketStatus, bgcolor=statusColor, text_color=color.white, text_size=size.small)
    
    // KDJ values for 13-day period
    table.cell(statusTable, 0, 2, "K13/D13", bgcolor=color.new(color.gray, 90), text_color=color.black, text_size=size.small)
    table.cell(statusTable, 1, 2, str.tostring(math.round(k13Day, 2)) + "/" + str.tostring(math.round(d13Day, 2)), text_color=color.black, text_size=size.small)
    
    // KDJ values for 21-day period
    table.cell(statusTable, 0, 3, "K21/D21", bgcolor=color.new(color.gray, 90), text_color=color.black, text_size=size.small)
    table.cell(statusTable, 1, 3, str.tostring(math.round(k21Day, 2)) + "/" + str.tostring(math.round(d21Day, 2)), text_color=color.black, text_size=size.small)
    
    // KDJ values for 34-day period
    table.cell(statusTable, 0, 4, "K34/D34", bgcolor=color.new(color.gray, 90), text_color=color.black, text_size=size.small)
    table.cell(statusTable, 1, 4, str.tostring(math.round(k34Day, 2)) + "/" + str.tostring(math.round(d34Day, 2)), text_color=color.black, text_size=size.small)
    
    // Signal strength
    table.cell(statusTable, 0, 5, "Strength", bgcolor=color.new(color.gray, 90), text_color=color.black, text_size=size.small)
    strengthText = signalStrength > 0 ? "+" + str.tostring(signalStrength) : str.tostring(signalStrength)
    strengthColor = signalStrength > 50 ? color.green : signalStrength > 0 ? color.new(color.green, 50) : signalStrength < -50 ? color.red : color.new(color.red, 50)
    table.cell(statusTable, 1, 5, strengthText, bgcolor=strengthColor, text_color=color.white, text_size=size.small)
    
    // Cross signals
    crossStatus = (goldenCross13 or goldenCross21 or goldenCross34) ? "GOLDEN" : (deathCross13 or deathCross21 or deathCross34) ? "DEATH" : "NONE"
    crossColor = (goldenCross13 or goldenCross21 or goldenCross34) ? color.yellow : (deathCross13 or deathCross21 or deathCross34) ? color.purple : color.gray
    table.cell(statusTable, 0, 6, "Cross", bgcolor=color.new(color.gray, 90), text_color=color.black, text_size=size.small)
    table.cell(statusTable, 1, 6, crossStatus, bgcolor=crossColor, text_color=color.white, text_size=size.small)

// ======== ALERT CONDITIONS ========
alertcondition(strongBuySignal, "Strong Buy Signal", "Strong KDJ buy signal detected")
alertcondition(buySignal, "Buy Signal", "KDJ buy signal detected")
alertcondition(strongSellSignal, "Strong Sell Signal", "Strong KDJ sell signal detected")
alertcondition(sellSignal, "Sell Signal", "KDJ sell signal detected")
alertcondition(goldenCross13 or goldenCross21 or goldenCross34, "Golden Cross", "KDJ golden cross detected")
alertcondition(deathCross13 or deathCross21 or deathCross34, "Death Cross", "KDJ death cross detected")
