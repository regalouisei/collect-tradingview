//@version=5
indicator("Mega Cap Dashboard + RSI (True TV Daily %)", overlay=true)

// ===== INPUT =====
rsiLength = input.int(14, "RSI Length")

// ===== SYMBOLS =====
sym1 = "NASDAQ:NVDA"
sym2 = "NASDAQ:MSFT"
sym3 = "NASDAQ:AAPL"
sym4 = "NASDAQ:META"

// ===== INTRADAY CLOSE =====
nvda_close = request.security(sym1, timeframe.period, close)
msft_close = request.security(sym2, timeframe.period, close)
aapl_close = request.security(sym3, timeframe.period, close)
meta_close = request.security(sym4, timeframe.period, close)

// ===== PREVIOUS DAILY CLOSE (KEY FIX) =====
nvda_prev_close = request.security(sym1, "D", close[1])
msft_prev_close = request.security(sym2, "D", close[1])
aapl_prev_close = request.security(sym3, "D", close[1])
meta_prev_close = request.security(sym4, "D", close[1])

// ===== TRUE DAILY % CHANGE (Matches TV) =====
nvda_change = ((nvda_close - nvda_prev_close) / nvda_prev_close) * 100
msft_change = ((msft_close - msft_prev_close) / msft_prev_close) * 100
aapl_change = ((aapl_close - aapl_prev_close) / aapl_prev_close) * 100
meta_change = ((meta_close - meta_prev_close) / meta_prev_close) * 100

// ===== RSI =====
nvda_rsi = request.security(sym1, timeframe.period, ta.rsi(close, rsiLength))
msft_rsi = request.security(sym2, timeframe.period, ta.rsi(close, rsiLength))
aapl_rsi = request.security(sym3, timeframe.period, ta.rsi(close, rsiLength))
meta_rsi = request.security(sym4, timeframe.period, ta.rsi(close, rsiLength))

// ===== COLOR FUNCTIONS =====
priceColor(change) =>
    change >= 0 ? color.green : color.red

rsiColor(rsi) =>
    if rsi > 70
        color.red
    else if rsi < 30
        color.lime
    else
        color.white

// ===== TABLE =====
var table dashboard = table.new(position.top_right, 4, 5, border_width=1)

if barstate.isfirst
    table.cell(dashboard, 0, 0, "Ticker", bgcolor=color.gray, text_color=color.white)
    table.cell(dashboard, 1, 0, "Price", bgcolor=color.gray, text_color=color.white)
    table.cell(dashboard, 2, 0, "Day %", bgcolor=color.gray, text_color=color.white)
    table.cell(dashboard, 3, 0, "RSI", bgcolor=color.gray, text_color=color.white)

// ===== NVDA =====
table.cell(dashboard, 0, 1, "NVDA")
table.cell(dashboard, 1, 1, str.tostring(nvda_close, format.mintick))
table.cell(dashboard, 2, 1, str.tostring(nvda_change, "#.##") + "%", text_color=priceColor(nvda_change))
table.cell(dashboard, 3, 1, str.tostring(nvda_rsi, "#.##"), text_color=rsiColor(nvda_rsi))

// ===== MSFT =====
table.cell(dashboard, 0, 2, "MSFT")
table.cell(dashboard, 1, 2, str.tostring(msft_close, format.mintick))
table.cell(dashboard, 2, 2, str.tostring(msft_change, "#.##") + "%", text_color=priceColor(msft_change))
table.cell(dashboard, 3, 2, str.tostring(msft_rsi, "#.##"), text_color=rsiColor(msft_rsi))

// ===== AAPL =====
table.cell(dashboard, 0, 3, "AAPL")
table.cell(dashboard, 1, 3, str.tostring(aapl_close, format.mintick))
table.cell(dashboard, 2, 3, str.tostring(aapl_change, "#.##") + "%", text_color=priceColor(aapl_change))
table.cell(dashboard, 3, 3, str.tostring(aapl_rsi, "#.##"), text_color=rsiColor(aapl_rsi))

// ===== META =====
table.cell(dashboard, 0, 4, "META")
table.cell(dashboard, 1, 4, str.tostring(meta_close, format.mintick))
table.cell(dashboard, 2, 4, str.tostring(meta_change, "#.##") + "%", text_color=priceColor(meta_change))
table.cell(dashboard, 3, 4, str.tostring(meta_rsi, "#.##"), text_color=rsiColor(meta_rsi))
