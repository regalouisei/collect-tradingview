// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Created by Eric Pipkorn

//@version=6
indicator("Linear Regression R² (0–1)", shorttitle="Linear Reg R²", overlay=false)

// ----------------------
// Inputs
// ----------------------
len = input.int(30, "Lookback Length", minval=2)

srcChoice = input.string(
     "Close",
     "Price Source",
     options=["Open", "High", "Low", "Close", "HLC3 (H+L+C)/3"]
)

plotWidth = input.int(2, "Plot Width", minval=1, maxval=5)

// Color controls
useAutoColor = input.bool(true, "Auto Color by Level")
manualColor  = input.color(color.aqua, "Manual Plot Color")
aboveColor   = input.color(color.lime, "Auto Color (At/Above Level)")
belowColor   = input.color(color.red,  "Auto Color (Below Level)")

// Reference lines
showBands = input.bool(true, "Show 0 / 0.5 / 1 Lines")

// Custom level line + alerts
showLevelLine = input.bool(true, "Show Custom Level Line", inline="lvl1")
levelValue    = input.float(0.80, "Level", minval=0.0, maxval=1.0, step=0.01, inline="lvl1")
levelColor    = input.color(color.orange, "Level Color", inline="lvl2")

// Zone lines
showZoneLines = input.bool(true, "Show Zone Lines (Low/High)")
zoneLow       = input.float(0.30, "Zone Low", minval=0.0, maxval=1.0, step=0.01, inline="z")
zoneHigh      = input.float(0.70, "Zone High", minval=0.0, maxval=1.0, step=0.01, inline="z")
zoneColor     = input.color(color.gray, "Zone Line Color")

// Label
showValue = input.bool(true, "Show Last Value Label")

// ----------------------
// Source selection
// ----------------------
float src = switch srcChoice
    "Open"           => open
    "High"           => high
    "Low"            => low
    "Close"          => close
    "HLC3 (H+L+C)/3" => (high + low + close) / 3.0

// ----------------------
// R² (coefficient of determination)
// ----------------------
float r  = ta.correlation(src, bar_index, len)
float r2 = math.pow(r, 2)

// Clamp r2 to [0, 1] without math.clamp()
float r2safe = na(r2) ? na : math.max(0.0, math.min(1.0, r2))

// ----------------------
// Plot color logic (STRICT THRESHOLD)
// - aboveColor ONLY when r2safe >= levelValue
// - belowColor ONLY when r2safe <  levelValue
// ----------------------
color plotCol = useAutoColor ? (r2safe >= levelValue ? aboveColor : belowColor) : manualColor

// ----------------------
// Plot
// ----------------------
plot(r2safe, title="R²", linewidth=plotWidth, color=plotCol)

// ----------------------
// Horizontal lines (toggle with display=)
// ----------------------
hline(0.0, "0.0", linestyle=hline.style_dotted, display=showBands ? display.all : display.none)
hline(0.5, "0.5", linestyle=hline.style_dotted, display=showBands ? display.all : display.none)
hline(1.0, "1.0", linestyle=hline.style_dotted, display=showBands ? display.all : display.none)

hline(levelValue, "Custom Level", color=levelColor, linestyle=hline.style_dashed, linewidth=2,
     display=showLevelLine ? display.all : display.none)

hline(zoneLow, "Zone Low", color=zoneColor, linestyle=hline.style_dotted,
     display=showZoneLines ? display.all : display.none)

hline(zoneHigh, "Zone High", color=zoneColor, linestyle=hline.style_dotted,
     display=showZoneLines ? display.all : display.none)

// ----------------------
// Last value label (single label, updated)
// ----------------------
var label lastLbl = na
if barstate.islast
    if showValue and not na(r2safe)
        if na(lastLbl)
            lastLbl := label.new(bar_index, r2safe, "", style=label.style_label_left, textcolor=color.white, color=color.new(color.black, 0))
        label.set_x(lastLbl, bar_index)
        label.set_y(lastLbl, r2safe)
        label.set_text(lastLbl, "R²: " + str.tostring(r2safe, format.mintick))
    else
        if not na(lastLbl)
            label.delete(lastLbl)
            lastLbl := na

// ----------------------
// Alerts
// ----------------------
bool crossUp   = ta.crossover(r2safe, levelValue)
bool crossDown = ta.crossunder(r2safe, levelValue)

alertcondition(crossUp,   title="R² Crossed Above Level", message="R² crossed ABOVE your level.")
alertcondition(crossDown, title="R² Crossed Below Level", message="R² crossed BELOW your level.")

bool zoneUp   = ta.crossover(r2safe, zoneHigh)
bool zoneDown = ta.crossunder(r2safe, zoneLow)

alertcondition(zoneUp,   title="R² Crossed Above Zone High", message="R² crossed ABOVE Zone High.")
alertcondition(zoneDown, title="R² Crossed Below Zone Low",  message="R² crossed BELOW Zone Low.")
