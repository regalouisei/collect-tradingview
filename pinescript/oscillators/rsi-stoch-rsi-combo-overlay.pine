//@version=6
// updated with alert options
indicator(title="RSI + Stoch RSI Overlay", shorttitle="RSI+StochRSI", format=format.price, precision=2, timeframe="", timeframe_gaps=true)

//──────────────────────────────────────────────────────────────────────────────
// RSI (from TradingView "Relative Strength Index" source)
//──────────────────────────────────────────────────────────────────────────────
rsiLengthInput      = input.int(14, minval=1, title="RSI Length", group="RSI Settings")
rsiSourceInput      = input.source(close, "Source", group="RSI Settings")
calculateDivergence = input.bool(false, title="Calculate Divergence", group="RSI Settings", display=display.none,
     tooltip="Calculating divergences is needed in order for divergence alerts to fire.")

ch   = ta.change(rsiSourceInput)
up   = ta.rma(math.max(ch, 0), rsiLengthInput)
down = ta.rma(-math.min(ch, 0), rsiLengthInput)
rsi  = down == 0 ? 100 : up == 0 ? 0 : 100 - (100 / (1 + up / down))

//──────────────────────────────────────────────────────────────────────────────
// Stoch RSI (from TradingView "Stochastic RSI" source, using the RSI above)
//──────────────────────────────────────────────────────────────────────────────
smoothK     = input.int(3, "K", minval=1, group="Stoch RSI Settings")
smoothD     = input.int(3, "D", minval=1, group="Stoch RSI Settings")
lengthStoch = input.int(14, "Stochastic Length", minval=1, group="Stoch RSI Settings")

k = ta.sma(ta.stoch(rsi, rsi, rsi, lengthStoch), smoothK)
d = ta.sma(k, smoothD)

//──────────────────────────────────────────────────────────────────────────────
// Display toggles
//──────────────────────────────────────────────────────────────────────────────
showRSI         = input.bool(true,  "Show RSI", group="Display")
showStoch       = input.bool(true,  "Show Stoch RSI (K/D)", group="Display")
showRSIBands    = input.bool(true,  "Show RSI Bands (70/30)", group="Display")
showStochBands  = input.bool(true,  "Show Stoch Bands (80/20)", group="Display")
showRSIGradient = input.bool(true,  "RSI Overbought/Oversold Gradient", group="Display")
showStochFill   = input.bool(false, "Stoch RSI Background Fill (80↔20)", group="Display")

//──────────────────────────────────────────────────────────────────────────────
// Plots: RSI + Stoch RSI overlay
//──────────────────────────────────────────────────────────────────────────────
rsiPlot = plot(showRSI ? rsi : na, "RSI", color=#7E57C2)
plotK   = plot(showStoch ? k : na, "Stoch RSI K", color=#2962FF)
plotD   = plot(showStoch ? d : na, "Stoch RSI D", color=#FF6D00)

// RSI Bands + Fill (from RSI source)
rsiUpperBand = hline(70, "RSI Upper Band", color=#787B86, display=showRSIBands ? display.all : display.none)
hline(50, "Middle Band", color=color.new(#787B86, 50))
rsiLowerBand = hline(30, "RSI Lower Band", color=#787B86, display=showRSIBands ? display.all : display.none)

fill(rsiUpperBand, rsiLowerBand,
     color=(showRSI and showRSIBands) ? color.rgb(126, 87, 194, 90) : na,
     title="RSI Background Fill")

midLinePlot = plot(50, color=na, editable=false, display=display.none)
fill(rsiPlot, midLinePlot, 100, 70,
     top_color    = showRSIGradient ? color.new(color.green, 0)   : na,
     bottom_color = showRSIGradient ? color.new(color.green, 100) : na,
     title="Overbought Gradient Fill")
fill(rsiPlot, midLinePlot, 30, 0,
     top_color    = showRSIGradient ? color.new(color.red, 100) : na,
     bottom_color = showRSIGradient ? color.new(color.red, 0)   : na,
     title="Oversold Gradient Fill")

// Stoch RSI Bands + Fill (from Stoch RSI source)
stochUpper = hline(80, "Stoch Upper Band", color=#787B86, display=showStochBands ? display.all : display.none)
hline(50, "Stoch Middle Band", color=color.new(#787B86, 50), display=showStochBands ? display.all : display.none)
stochLower = hline(20, "Stoch Lower Band", color=#787B86, display=showStochBands ? display.all : display.none)

fill(stochUpper, stochLower,
     color=showStochFill ? color.rgb(33, 150, 243, 90) : na,
     title="Stoch RSI Background")

//──────────────────────────────────────────────────────────────────────────────
// RSI Smoothing (MA + optional Bollinger Bands) — from RSI source
//──────────────────────────────────────────────────────────────────────────────
GRP   = "Smoothing"
TT_BB = "Only applies when 'SMA + Bollinger Bands' is selected. Determines the distance between the SMA and the bands."

maTypeInput   = input.string("SMA", "Type",
     options=["None", "SMA", "SMA + Bollinger Bands", "EMA", "SMMA (RMA)", "WMA", "VWMA"],
     group=GRP, display=display.none)
isBB          = maTypeInput == "SMA + Bollinger Bands"
maLengthInput = input.int(14, "Length", group=GRP, display=display.none, active=maTypeInput != "None")
bbMultInput   = input.float(2.0, "BB StdDev", minval=0.001, maxval=50, step=0.5, tooltip=TT_BB,
     group=GRP, display=display.none, active=isBB)
enableMA      = maTypeInput != "None"

ma(source, length, MAtype) =>
    switch MAtype
        "SMA"                   => ta.sma(source, length)
        "SMA + Bollinger Bands" => ta.sma(source, length)
        "EMA"                   => ta.ema(source, length)
        "SMMA (RMA)"            => ta.rma(source, length)
        "WMA"                   => ta.wma(source, length)
        "VWMA"                  => ta.vwma(source, length)
        => na

smoothingMA    = enableMA ? ma(rsi, maLengthInput, maTypeInput) : na
smoothingStDev = isBB ? ta.stdev(rsi, maLengthInput) * bbMultInput : na

plot(smoothingMA, "RSI-based MA", color=color.yellow, display=enableMA ? display.all : display.none, editable=enableMA)
bbUpperBand = plot(smoothingMA + smoothingStDev, title="Upper Bollinger Band", color=color.green, display=isBB ? display.all : display.none, editable=isBB)
bbLowerBand = plot(smoothingMA - smoothingStDev, title="Lower Bollinger Band", color=color.green, display=isBB ? display.all : display.none, editable=isBB)
fill(bbUpperBand, bbLowerBand, color=isBB ? color.new(color.green, 90) : na, title="Bollinger Bands Background Fill", display=isBB ? display.all : display.none, editable=isBB)

//──────────────────────────────────────────────────────────────────────────────
// Divergence (from RSI source)
//──────────────────────────────────────────────────────────────────────────────
lookbackRight = 5
lookbackLeft  = 5
rangeUpper    = 60
rangeLower    = 5
bearColor     = color.red
bullColor     = color.green
textColor     = color.white
noneColor     = color.new(color.white, 100)

_inRange(bool cond) =>
    bars = ta.barssince(cond)
    rangeLower <= bars and bars <= rangeUpper

plFound  = false
phFound  = false
bullCond = false
bearCond = false

rsiLBR = rsi[lookbackRight]

if calculateDivergence
    // Regular Bullish
    plFound := not na(ta.pivotlow(rsi, lookbackLeft, lookbackRight))
    rsiHL   = rsiLBR > ta.valuewhen(plFound, rsiLBR, 1) and _inRange(plFound[1])
    lowLBR  = low[lookbackRight]
    priceLL = lowLBR < ta.valuewhen(plFound, lowLBR, 1)
    bullCond := priceLL and rsiHL and plFound

    // Regular Bearish
    phFound := not na(ta.pivothigh(rsi, lookbackLeft, lookbackRight))
    rsiLH   = rsiLBR < ta.valuewhen(phFound, rsiLBR, 1) and _inRange(phFound[1])
    highLBR = high[lookbackRight]
    priceHH = highLBR > ta.valuewhen(phFound, highLBR, 1)
    bearCond := priceHH and rsiLH and phFound

plot(plFound ? rsiLBR : na,
     offset=-lookbackRight,
     title="Regular Bullish",
     linewidth=2,
     color=(bullCond ? bullColor : noneColor),
     display=display.pane,
     editable=calculateDivergence)

plotshape(bullCond ? rsiLBR : na,
     offset=-lookbackRight,
     title="Regular Bullish Label",
     text=" Bull ",
     style=shape.labelup,
     location=location.absolute,
     color=bullColor,
     textcolor=textColor,
     display=display.pane,
     editable=calculateDivergence)

plot(phFound ? rsiLBR : na,
     offset=-lookbackRight,
     title="Regular Bearish",
     linewidth=2,
     color=(bearCond ? bearColor : noneColor),
     display=display.pane,
     editable=calculateDivergence)

plotshape(bearCond ? rsiLBR : na,
     offset=-lookbackRight,
     title="Regular Bearish Label",
     text=" Bear ",
     style=shape.labeldown,
     location=location.absolute,
     color=bearColor,
     textcolor=textColor,
     display=display.pane,
     editable=calculateDivergence)

alertcondition(bullCond, title="Regular Bullish Divergence",
     message="RSI Regular Bullish Divergence detected.")
alertcondition(bearCond, title="Regular Bearish Divergence",
     message="RSI Regular Bearish Divergence detected.")

//──────────────────────────────────────────────────────────────────────────────
// RSI ALERTS (dedicated alertconditions for the RSI line)
//──────────────────────────────────────────────────────────────────────────────
grpAlerts = "Alerts"
rsiOB  = input.int(70, "RSI Overbought Level", group=grpAlerts)
rsiOS  = input.int(30, "RSI Oversold Level",  group=grpAlerts)
rsiMID = input.int(50, "RSI Mid Level",      group=grpAlerts)

alertcondition(ta.crossover(rsi, rsiOB),   title="RSI Cross Up Overbought",    message="RSI crossed UP above Overbought level {{input:rsiOB}}")
alertcondition(ta.crossunder(rsi, rsiOB),  title="RSI Cross Down Overbought",  message="RSI crossed DOWN below Overbought level {{input:rsiOB}}")

alertcondition(ta.crossunder(rsi, rsiOS),  title="RSI Cross Down Oversold",    message="RSI crossed DOWN below Oversold level {{input:rsiOS}}")
alertcondition(ta.crossover(rsi, rsiOS),   title="RSI Cross Up Oversold",      message="RSI crossed UP above Oversold level {{input:rsiOS}}")

alertcondition(ta.crossover(rsi, rsiMID),  title="RSI Cross Up Mid (50)",      message="RSI crossed UP above Mid level {{input:rsiMID}}")
alertcondition(ta.crossunder(rsi, rsiMID), title="RSI Cross Down Mid (50)",    message="RSI crossed DOWN below Mid level {{input:rsiMID}}")

alertcondition(ta.rising(rsi, 1),          title="RSI Rising",                 message="RSI is rising")
alertcondition(ta.falling(rsi, 1),         title="RSI Falling",                message="RSI is falling")
