// Rolling Trend R² Indicator

//@version=6
indicator("Rolling Trend R²", overlay=false)

// Inputs
window = input.int(20, "Window Length", minval=5)

// Use log of close price
log_close = math.log(close)


n = float(window)
sum_x = n * (n - 1.0) / 2.0
sum_x2 = n * (n - 1.0) * (2.0 * n - 1.0) / 6.0

sum_y = ta.sma(log_close, window) * n
var_x = sum_x2 / n - math.pow(sum_x / n, 2)
sum_y2 = ta.sma(math.pow(log_close, 2), window) * n
mean_y = sum_y / n
var_y = sum_y2 / n - math.pow(mean_y, 2)

wma_sum_weights = n * (n + 1.0) / 2.0
wma_weighted_sum = ta.wma(log_close, window) * wma_sum_weights

sum_xy = wma_weighted_sum - sum_y

mean_x = sum_x / n
cov_xy = sum_xy / n - mean_x * mean_y


slope = var_x != 0 ? cov_xy / var_x : 0.0

intercept = mean_y - slope * mean_x
r2_raw = (var_x > 0 and var_y > 0) ? math.pow(cov_xy, 2) / (var_x * var_y) : 0.0

min_periods = math.max(10, math.floor(window / 2))
r2 = bar_index >= min_periods ? r2_raw : na

// Clamp to [0, 1] 
r2_final = na(r2) ? na : math.max(0.0, math.min(1.0, r2))

plot(r2_final, "R²", color=color.purple, linewidth=2)


hline(0.8, "Strong Trend", color=color.green, linestyle=hline.style_dotted)
hline(0.5, "Mixed", color=color.gray, linestyle=hline.style_dashed)
hline(0.2, "No Trend", color=color.red, linestyle=hline.style_dotted)


bgcolor_color = r2_final > 0.7 ? color.new(color.green, 90) : r2_final < 0.3 ? color.new(color.red, 90) : na
bgcolor(bgcolor_color, title="Regime Background")

// Info table
var table info_table = table.new(position.top_right, 2, 3, bgcolor=color.new(color.gray, 80))
if barstate.islast
    table.cell(info_table, 0, 0, "R²", text_color=color.white)
    table.cell(info_table, 1, 0, str.tostring(r2_final, "#.###"), text_color=color.white)
    table.cell(info_table, 0, 1, "Regime", text_color=color.white)
    regime_text = r2_final > 0.7 ? "Strong Trend" : r2_final < 0.3 ? "Choppy/MR" : "Mixed"
    regime_color = r2_final > 0.7 ? color.green : r2_final < 0.3 ? color.red : color.yellow
    table.cell(info_table, 1, 1, regime_text, text_color=regime_color)
    table.cell(info_table, 0, 2, "Window", text_color=color.white)
    table.cell(info_table, 1, 2, str.tostring(window), text_color=color.white)
