//@version=6
indicator("[CT] Adaptive Trend Pressure (Percentile)", shorttitle="[CT] ATP-PCT", overlay=false, precision=2)

//────────────────────────────────────────────────────────────────────
// Inputs (same engine as the Adaptive Percentile Trend Oscillator)
//────────────────────────────────────────────────────────────────────
groupCore = "Core (Percentile Engine)"
len       = input.int(100, "Trend Length", minval=10, step=4, group=groupCore)
sens      = input.int(95, "Sensitivity", minval=50, maxval=98, step=1, group=groupCore)
src       = input.source(close, "Source", group=groupCore)

groupBand = "Band Model"
bandLen   = input.int(2, "Volatility Window", minval=1, group=groupBand, tooltip="StDev lookback used to build adaptive band series.")
bandMult  = input.float(1.0, "Volatility Multiplier", minval=0.1, step=0.1, group=groupBand)

groupSig  = "Signal & Zones"
sigLen    = input.int(20, "Signal Length", minval=1, maxval=200, group=groupSig)
zoneHi    = input.float(25.0, "Upper Zone (Centered)", step=0.5, group=groupSig, tooltip="25 = same as 75 on a 0–100 scale.")
zoneLo    = input.float(-25.0, "Lower Zone (Centered)", step=0.5, group=groupSig, tooltip="-25 = same as 25 on a 0–100 scale.")

groupStyle = "Style"
showSignal = input.bool(true, "Show Signal Line", group=groupStyle)
showZones  = input.bool(true, "Show Zone Fill", group=groupStyle)
histColors = input.bool(true, "Histogram Colors", group=groupStyle)
useLine    = input.bool(false, "Show Line Instead of Histogram", group=groupStyle)

// NEW: Bar coloring option
groupBars  = "Price Bars"
colorBars  = input.bool(false, "Color Price Bars to Match Histogram?", group=groupBars)
bullBarCol = input.color(color.new(color.green, 0), "Bull Bar Color", group=groupBars)
bearBarCol = input.color(color.new(color.red,   0), "Bear Bar Color", group=groupBars)

//────────────────────────────────────────────────────────────────────
// Percentile Engine (matches the previous Adaptive Percentile Trend Osc)
//────────────────────────────────────────────────────────────────────
vol         = ta.stdev(src, bandLen) * bandMult
upperSeries = src + vol
lowerSeries = src - vol

upperPct = ta.percentile_linear_interpolation(upperSeries, len, sens)
lowerPct = ta.percentile_linear_interpolation(lowerSeries, len, 100 - sens)

denom = math.max(upperPct - lowerPct, syminfo.mintick)

// Same 0–100 oscillator behavior as the prior indicator
rawOsc = 100.0 * (src - lowerPct) / denom
osc    = math.min(math.max(rawOsc, 0.0), 100.0)

// Centered pressure (so visuals differ from RTI)
pressure = osc - 50.0

// Signal on the centered pressure
signal = ta.ema(pressure, sigLen)

//────────────────────────────────────────────────────────────────────
// Plots
//────────────────────────────────────────────────────────────────────
histCol = histColors ? (pressure >= 0 ? color.new(color.green, 0) : color.new(color.red, 0)) : color.new(color.gray, 0)

h0 = hline(0, "Zero", color=color.new(color.gray, 60))
hU = hline(zoneHi, "Upper Zone", color=color.new(color.gray, 70), linestyle=hline.style_dashed)
hL = hline(zoneLo, "Lower Zone", color=color.new(color.gray, 70), linestyle=hline.style_dashed)

// Main plot (histogram by default)
plot(useLine ? pressure : na, "Trend Pressure (Line)", color=color.new(color.teal, 0), linewidth=2)
plot(useLine ? na : pressure, "Trend Pressure (Hist)", style=plot.style_histogram, linewidth=2, color=histCol)

// Signal
plot(showSignal ? signal : na, "Signal", color=color.new(color.aqua, 0), linewidth=2)

// Zone background fill (must be global scope)
zoneFillColor = showZones ? color.new(color.teal, 88) : na
fill(hU, hL, color=zoneFillColor, title="Zone Background")

//────────────────────────────────────────────────────────────────────
// Bar coloring (matches histogram direction)
// NOTE: If another script also uses barcolor(), the last one loaded can override.
//────────────────────────────────────────────────────────────────────
barcolor(colorBars ? (pressure >= 0 ? bullBarCol : bearBarCol) : na)

//────────────────────────────────────────────────────────────────────
// Alerts
//────────────────────────────────────────────────────────────────────
alertcondition(ta.crossover(pressure, 0),        "Pressure Cross Up 0",        "Trend Pressure crossed above 0")
alertcondition(ta.crossunder(pressure, 0),       "Pressure Cross Down 0",      "Trend Pressure crossed below 0")
alertcondition(ta.crossover(pressure, signal),   "Pressure Cross Up Signal",   "Trend Pressure crossed above Signal")
alertcondition(ta.crossunder(pressure, signal),  "Pressure Cross Down Signal", "Trend Pressure crossed below Signal")
alertcondition(ta.crossover(pressure, zoneHi),   "Pressure Enter Upper Zone",  "Trend Pressure crossed into Upper Zone")
alertcondition(ta.crossunder(pressure, zoneLo),  "Pressure Enter Lower Zone",  "Trend Pressure crossed into Lower Zone")
