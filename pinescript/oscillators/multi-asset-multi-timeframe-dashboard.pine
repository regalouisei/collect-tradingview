//@version=5
indicator("Multi Asset + Multi Timeframe Dashboard", overlay=false, max_labels_count=500)

//━━━━━━━━━━━━━━━━━━━
// SYMBOL INPUTS
//━━━━━━━━━━━━━━━━━━━
sym1 = input.symbol("BTCUSDT", "Symbol 1")
sym2 = input.symbol("ETHUSDT", "Symbol 2")
sym3 = input.symbol("US30", "Symbol 3")
sym4 = input.symbol("US100", "Symbol 4")
sym5 = input.symbol("EURUSD", "Symbol 5")

//━━━━━━━━━━━━━━━━━━━
// TIMEFRAME INPUTS
//━━━━━━━━━━━━━━━━━━━
tf1 = input.string("15", "Timeframe 1", options=["5","15","30","60","120","240","480","D","W","M","Y"])
tf2 = input.string("60", "Timeframe 2", options=["5","15","30","60","120","240","480","D","W","M","Y"])
tf3 = input.string("240", "Timeframe 3", options=["5","15","30","60","120","240","480","D","W","M","Y"])
tf4 = input.string("D", "Timeframe 4", options=["5","15","30","60","120","240","480","D","W","M","Y"])

//━━━━━━━━━━━━━━━━━━━
// HELPER: Display label for Table Header
//━━━━━━━━━━━━━━━━━━━
f_tf_label(tf) =>
    array5_480 = array.from("5","15","30","60","120","240","480")
    array.includes(array5_480, tf) ? tf + "m" : tf

var array<string> timeframe_labels = array.new_string()
if barstate.isfirst
    array.push(timeframe_labels, f_tf_label(tf1))
    array.push(timeframe_labels, f_tf_label(tf2))
    array.push(timeframe_labels, f_tf_label(tf3))
    array.push(timeframe_labels, f_tf_label(tf4))

//━━━━━━━━━━━━━━━━━━━
// INDICATOR SCORE FUNCTION
//━━━━━━━━━━━━━━━━━━━
f_indicators() =>
    var array<float> indicators = array.new_float(10, 0.0)
    ema20  = ta.ema(close, 20)
    ema50  = ta.ema(close, 50)
    ema200 = ta.ema(close, 200)
    array.set(indicators, 0, ema20 > ema50 ? 1.0 : ema20 < ema50 ? -1.0 : 0.0)
    array.set(indicators, 1, ema50 > ema200 ? 1.0 : ema50 < ema200 ? -1.0 : 0.0)
    array.set(indicators, 2, close > ema200 ? 1.0 : close < ema200 ? -1.0 : 0.0)
    macdLine   = ta.ema(close, 12) - ta.ema(close, 26)
    macdSignal = ta.ema(macdLine, 9)
    macdHist   = macdLine - macdSignal
    array.set(indicators, 3, macdLine > macdSignal ? 1.0 : macdLine < macdSignal ? -1.0 : 0.0)
    array.set(indicators, 4, macdHist > 0 ? 1.0 : macdHist < 0 ? -1.0 : 0.0)
    rsi   = ta.rsi(close, 14)
    rsiMA = ta.sma(rsi, 14)
    array.set(indicators, 5, rsi > rsiMA ? 1.0 : rsi < rsiMA ? -1.0 : 0.0)
    array.set(indicators, 6, rsi > 50 ? 1.0 : rsi < 50 ? -1.0 : 0.0)
    stochK = ta.stoch(close, high, low, 14)
    stochD = ta.sma(stochK, 3)
    array.set(indicators, 7, stochK > stochD ? 1.0 : stochK < stochD ? -1.0 : 0.0)
    cci = ta.cci(close, 20)
    array.set(indicators, 8, cci > 0 ? 1.0 : cci < 0 ? -1.0 : 0.0)
    ao = ta.sma(hl2, 5) - ta.sma(hl2, 34)
    array.set(indicators, 9, ao > 0 ? 1.0 : ao < 0 ? -1.0 : 0.0)
    indicators

//━━━━━━━━━━━━━━━━━━━
// TABLE SETUP (ONLY FOR 1–3 MIN CHARTS)
//━━━━━━━━━━━━━━━━━━━
showTable = timeframe.isintraday and timeframe.multiplier <= 3
var table t = na
if showTable and na(t)
    t := table.new(position.top_left, 49, 6, border_width=1)
    table.cell(t, 0, 0, "Symbol", bgcolor=color.black, text_color=color.white)
    for i = 0 to 3
        table.cell(t, 1 + i*11, 0, f_tf_label(array.get(timeframe_labels, i)), bgcolor=color.black, text_color=color.white)
    table.cell(t, 45, 0, "Overall", bgcolor=color.black, text_color=color.white)
    table.cell(t, 46, 0, "1 min", bgcolor=color.black, text_color=color.white)
    table.cell(t, 47, 0, "3 min", bgcolor=color.black, text_color=color.white)
    table.cell(t, 48, 0, "5 min", bgcolor=color.black, text_color=color.white)

//━━━━━━━━━━━━━━━━━━━
// HINT TEXT BELOW TABLE (ONCE)
//━━━━━━━━━━━━━━━━━━━
var label hintLabel = na
if showTable and na(hintLabel)
    hintLabel := label.new(bar_index, low, 
     "indicator shows up on 1m, 2m, 3m and 5m-timeframe due to table-" +
     "limitations in higher timeframes", 
     yloc=yloc.belowbar, 
     color=color.new(color.black, 0), 
     textcolor=color.white, 
     style=label.style_label_left, 
     size=size.tiny)

//━━━━━━━━━━━━━━━━━━━
// DRAW INDICATORS FUNCTION
//━━━━━━━━━━━━━━━━━━━
draw_indicators(_table, _row, baseCol, indArray) =>
    string[] indicator_names = array.from("EMA20>50","EMA50>200","Close>EMA200",
                                         "MACD Line","MACD Hist",
                                         "RSI>MA","RSI>50",
                                         "Stoch K>D","CCI>0","AO")
    int sum = 0
    for i = 0 to array.size(indArray)-1
        float val = array.get(indArray, i)
        color c = val == 1.0 ? color.green : val == -1.0 ? color.red : color.gray
        if val == 1.0
            sum += 1
        else if val == -1.0
            sum -= 1
        if not na(_table)
            table.cell(_table, baseCol + i, _row, "■", text_color=c, tooltip=array.get(indicator_names,i))
    string arrow = sum > 0 ? "▲" : sum < 0 ? "▼" : "✖"
    color arrowColor = sum > 0 ? color.green : sum < 0 ? color.red : color.gray
    if not na(_table)
        table.cell(_table, baseCol + 10, _row, arrow, text_color=arrowColor, tooltip="Majority")
    arrow

//━━━━━━━━━━━━━━━━━━━
// OVERALL ARROW FUNCTIONS
//━━━━━━━━━━━━━━━━━━━
f_overall_arrow_4tf(arr1, arr2, arr3, arr4) =>
    int sum = 0
    for i = 0 to array.size(arr1)-1
        sum += array.get(arr1,i) == 1.0 ? 1 : array.get(arr1,i) == -1.0 ? -1 : 0
        sum += array.get(arr2,i) == 1.0 ? 1 : array.get(arr2,i) == -1.0 ? -1 : 0
        sum += array.get(arr3,i) == 1.0 ? 1 : array.get(arr3,i) == -1.0 ? -1 : 0
        sum += array.get(arr4,i) == 1.0 ? 1 : array.get(arr4,i) == -1.0 ? -1 : 0
    string arrow = sum > 0 ? "▲" : sum < 0 ? "▼" : "✖"
    color arrowColor = sum > 0 ? color.green : sum < 0 ? color.red : color.gray
    [arrow, arrowColor]

f_overall_arrow_minis(indArray) =>
    int sum = 0
    for i = 0 to array.size(indArray)-1
        sum += array.get(indArray,i) == 1.0 ? 1 : array.get(indArray,i) == -1.0 ? -1 : 0
    string arrow = sum > 0 ? "▲" : sum < 0 ? "▼" : "✖"
    color arrowColor = sum > 0 ? color.green : sum < 0 ? color.red : color.gray
    [arrow, arrowColor]

//━━━━━━━━━━━━━━━━━━━
// REQUEST SECURITY FOR ALL SYMBOLS + TIMEFRAMES
//━━━━━━━━━━━━━━━━━━━
indicators1_1 = request.security(sym1, tf1, f_indicators())
indicators1_2 = request.security(sym1, tf2, f_indicators())
indicators1_3 = request.security(sym1, tf3, f_indicators())
indicators1_4 = request.security(sym1, tf4, f_indicators())
indicators1_1min = request.security(sym1, "1", f_indicators())
indicators1_3min = request.security(sym1, "3", f_indicators())
indicators1_5min = request.security(sym1, "5", f_indicators())

indicators2_1 = request.security(sym2, tf1, f_indicators())
indicators2_2 = request.security(sym2, tf2, f_indicators())
indicators2_3 = request.security(sym2, tf3, f_indicators())
indicators2_4 = request.security(sym2, tf4, f_indicators())
indicators2_1min = request.security(sym2, "1", f_indicators())
indicators2_3min = request.security(sym2, "3", f_indicators())
indicators2_5min = request.security(sym2, "5", f_indicators())

indicators3_1 = request.security(sym3, tf1, f_indicators())
indicators3_2 = request.security(sym3, tf2, f_indicators())
indicators3_3 = request.security(sym3, tf3, f_indicators())
indicators3_4 = request.security(sym3, tf4, f_indicators())
indicators3_1min = request.security(sym3, "1", f_indicators())
indicators3_3min = request.security(sym3, "3", f_indicators())
indicators3_5min = request.security(sym3, "5", f_indicators())

indicators4_1 = request.security(sym4, tf1, f_indicators())
indicators4_2 = request.security(sym4, tf2, f_indicators())
indicators4_3 = request.security(sym4, tf3, f_indicators())
indicators4_4 = request.security(sym4, tf4, f_indicators())
indicators4_1min = request.security(sym4, "1", f_indicators())
indicators4_3min = request.security(sym4, "3", f_indicators())
indicators4_5min = request.security(sym4, "5", f_indicators())

indicators5_1 = request.security(sym5, tf1, f_indicators())
indicators5_2 = request.security(sym5, tf2, f_indicators())
indicators5_3 = request.security(sym5, tf3, f_indicators())
indicators5_4 = request.security(sym5, tf4, f_indicators())
indicators5_1min = request.security(sym5, "1", f_indicators())
indicators5_3min = request.security(sym5, "3", f_indicators())
indicators5_5min = request.security(sym5, "5", f_indicators())

//━━━━━━━━━━━━━━━━━━━
// GLOBAL VARIABLES FOR LAST OVERALL ARROWS
//━━━━━━━━━━━━━━━━━━━
var string lastArrow1 = ""
var string lastArrow2 = ""
var string lastArrow3 = ""
var string lastArrow4 = ""
var string lastArrow5 = ""

//━━━━━━━━━━━━━━━━━━━
// DRAW SYMBOL FUNCTION (returns overall arrow)
//━━━━━━━━━━━━━━━━━━━
f_draw_symbol(_table, _row, _sym, ind_1, ind_2, ind_3, ind_4, ind_1m, ind_3m, ind_5m) =>
    if not na(_table)
        table.cell(_table, 0, _row, _sym, bgcolor=color.black, text_color=color.white)
        draw_indicators(_table, _row, 1, ind_1)
        draw_indicators(_table, _row, 12, ind_2)
        draw_indicators(_table, _row, 23, ind_3)
        draw_indicators(_table, _row, 34, ind_4)
    [overallArrow, overallColor] = f_overall_arrow_4tf(ind_1, ind_2, ind_3, ind_4)
    if not na(_table)
        table.cell(_table, 45, _row, overallArrow, text_color=overallColor, tooltip="Overall")
        [arrow1, color1] = f_overall_arrow_minis(ind_1m)
        [arrow3, color3] = f_overall_arrow_minis(ind_3m)
        [arrow5, color5] = f_overall_arrow_minis(ind_5m)
        table.cell(_table, 46, _row, arrow1, text_color=color1, tooltip="1 min Overall")
        table.cell(_table, 47, _row, arrow3, text_color=color3, tooltip="3 min Overall")
        table.cell(_table, 48, _row, arrow5, text_color=color5, tooltip="5 min Overall")
    overallArrow

//━━━━━━━━━━━━━━━━━━━
// DRAW ALL SYMBOLS AND ALERTS
//━━━━━━━━━━━━━━━━━━━
newArrow1 = f_draw_symbol(t, 1, sym1, indicators1_1, indicators1_2, indicators1_3, indicators1_4,
                          indicators1_1min, indicators1_3min, indicators1_5min)
if newArrow1 != lastArrow1
    alert(sym1 + " Overall indicator changed: " + lastArrow1 + " → " + newArrow1, alert.freq_once_per_bar)
lastArrow1 := newArrow1

newArrow2 = f_draw_symbol(t, 2, sym2, indicators2_1, indicators2_2, indicators2_3, indicators2_4,
                          indicators2_1min, indicators2_3min, indicators2_5min)
if newArrow2 != lastArrow2
    alert(sym2 + " Overall indicator changed: " + lastArrow2 + " → " + newArrow2, alert.freq_once_per_bar)
lastArrow2 := newArrow2

newArrow3 = f_draw_symbol(t, 3, sym3, indicators3_1, indicators3_2, indicators3_3, indicators3_4,
                          indicators3_1min, indicators3_3min, indicators3_5min)
if newArrow3 != lastArrow3
    alert(sym3 + " Overall indicator changed: " + lastArrow3 + " → " + newArrow3, alert.freq_once_per_bar)
lastArrow3 := newArrow3

newArrow4 = f_draw_symbol(t, 4, sym4, indicators4_1, indicators4_2, indicators4_3, indicators4_4,
                          indicators4_1min, indicators4_3min, indicators4_5min)
if newArrow4 != lastArrow4
    alert(sym4 + " Overall indicator changed: " + lastArrow4 + " → " + newArrow4, alert.freq_once_per_bar)
lastArrow4 := newArrow4

newArrow5 = f_draw_symbol(t, 5, sym5, indicators5_1, indicators5_2, indicators5_3, indicators5_4,
                          indicators5_1min, indicators5_3min, indicators5_5min)
if newArrow5 != lastArrow5
    alert(sym5 + " Overall indicator changed: " + lastArrow5 + " → " + newArrow5, alert.freq_once_per_bar)
lastArrow5 := newArrow5
