//@version=6
indicator("Dav1zoN Scalp", overlay=true, format=format.price, precision=2, max_labels_count=500)

// ────────────── SuperTrend Inputs ──────────────
Periods      = input.int(10, title="ATR Period")
src          = input.source(hl2, title="Source")
Multiplier   = input.float(3.0, title="ATR Multiplier", step=0.1)
changeATR    = input.bool(true, title="Change ATR Calculation Method ?")
showsignals  = input.bool(true, title="Show Buy/Sell Signals ?")

// ────────────── 15m SMA200 Confirmation ──────────────
useHTFSMA = input.bool(true, title="Confirm with 15m SMA200 (filter signals)")
htfTF     = input.timeframe("15", title="HTF for SMA200")
smaLen    = input.int(200, title="SMA Length")

// Sideways/neutral zone around SMA200 (for color)
neutralType = input.string("Percent", "SMA200 sideways zone type", options=["Percent", "ATR"])
neutralPct  = input.float(0.20, "Sideways zone % (0.10–0.50)", step=0.05)
neutralAtr  = input.float(0.25, "Sideways zone ATR mult (0.10–0.60)", step=0.05)

// ────────────── HTF data ──────────────
htfClose = request.security(syminfo.tickerid, htfTF, close)
htfSMA   = request.security(syminfo.tickerid, htfTF, ta.sma(close, smaLen))

// Sideways band size
atrLocal = ta.atr(Periods)
band = neutralType == "Percent" ? htfSMA * (neutralPct / 100.0) : (atrLocal * neutralAtr)

// SMA regime for color
smaUp   = htfClose > (htfSMA + band)
smaDown = htfClose < (htfSMA - band)
smaSide = not smaUp and not smaDown

smaColor = smaUp ? color.new(color.green, 0) : smaDown ? color.new(color.red, 0) : color.new(color.gray, 0)

// Plot SMA200 (colored)
plot(htfSMA, title="15m SMA 200 (colored)", color=smaColor, linewidth=2)

// Confirmation rule (same as before)
buyAllowed  = not useHTFSMA or smaUp
sellAllowed = not useHTFSMA or smaDown

// ────────────── ATR Calculation (same as your script) ──────────────
atr2 = ta.sma(ta.tr(true), Periods)
atr  = changeATR ? ta.atr(Periods) : atr2

// ────────────── SuperTrend Logic (UNCHANGED) ──────────────
up  = src - (Multiplier * atr)
up1 = nz(up[1], up)
up  := close[1] > up1 ? math.max(up, up1) : up

dn  = src + (Multiplier * atr)
dn1 = nz(dn[1], dn)
dn  := close[1] < dn1 ? math.min(dn, dn1) : dn

var int trend = 1
trend := nz(trend[1], trend)
trend := trend == -1 and close > dn1 ? 1 :
         trend == 1 and close < up1 ? -1 : trend

// ────────────── ONE SINGLE SuperTrend LINE (no fill, candles visible) ──────────────
stLine  = trend == 1 ? up : dn
stColor = trend == 1 ? color.new(color.green, 0) : color.new(color.red, 0)

plot(stLine, title="SuperTrend (single line)", style=plot.style_linebr, linewidth=2, color=stColor)

// ────────────── Signals ──────────────
buyFlip  = trend == 1 and trend[1] == -1
sellFlip = trend == -1 and trend[1] == 1

buySignal  = buyFlip  and buyAllowed
sellSignal = sellFlip and sellAllowed

plotshape(buySignal ? stLine : na, title="Buy Dot", location=location.absolute,
     style=shape.circle, size=size.tiny, color=color.new(color.green, 0))

plotshape(buySignal and showsignals ? stLine : na, title="Buy Label", text="Buy",
     location=location.absolute, style=shape.labelup, size=size.tiny,
     color=color.new(color.green, 0), textcolor=color.white)

plotshape(sellSignal ? stLine : na, title="Sell Dot", location=location.absolute,
     style=shape.circle, size=size.tiny, color=color.new(color.red, 0))

plotshape(sellSignal and showsignals ? stLine : na, title="Sell Label", text="Sell",
     location=location.absolute, style=shape.labeldown, size=size.tiny,
     color=color.new(color.red, 0), textcolor=color.white)

// ────────────── Alerts ──────────────
alertcondition(buySignal,  title="Dav1zoN Scalp Buy",  message="Dav1zoN Scalp BUY (5m ST + 15m SMA200)")
alertcondition(sellSignal, title="Dav1zoN Scalp Sell", message="Dav1zoN Scalp SELL (5m ST + 15m SMA200)")
alertcondition(trend != trend[1], title="Trend Change", message="Dav1zoN Scalp trend changed")
