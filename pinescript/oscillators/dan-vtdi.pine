// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© danicpheh

//@version=5
// TDI Code
indicator('TDI+DMA', shorttitle='TDI+DMA')
rsiPeriod = input.int(13, minval=1, title='RSI Period')
bandLength = input.int(34, minval=1, title='Band Length')
lengthrsipl = input.int(2, minval=0, title='Fast MA on RSI')
lengthtradesl = input.int(7, minval=1, title='Slow MA on RSI')

src = close  // Source of Calculations (Close of Bar)
r = ta.rsi(src, rsiPeriod)  // RSI of Close
ma = ta.sma(r, bandLength)  // Moving Average of RSI [current]
offs = 1.6185 * ta.stdev(r, bandLength)  // Offset
up = ma + offs  // Upper Bands
dn = ma - offs  // Lower Bands
mid = (up + dn) / 2  // Average of Upper and Lower Bands
fastMA = ta.sma(r, lengthrsipl)  // Moving Average of RSI 2 bars back
slowMA = ta.sma(r, lengthtradesl)  // Moving Average of RSI 7 bars back

// Constants colours that include fully non-transparent option.
blue = #5084DE
green = #4CAF50
red = #FF5252
orange = #FF9800
navy = #311B92

hline(32)  // Oversold
hline(50)  // Midline
hline(68)  // Overbought

upl = plot(up, 'Upper Band', color=color.new(green, 0))  // Upper Band
dnl = plot(dn, 'Lower Band', color=color.new(green, 0))  // Lower Band
midl = plot(mid, 'Middle of Bands', color=color.new(red, 0), linewidth=2)  // Middle of Bands

plot(slowMA, 'Slow MA', color=color.new(orange, 0), linewidth=2)  // Plot Slow MA
plot(fastMA, 'Fast MA', color=color.new(blue, 0), linewidth=2)  // Plot Fast MA

//EMA code
FMA = ta.ema(close, 10)
SMA = ta.ema(close, 20)

ECR = ta.crossover(FMA, SMA)

// ## Input TF ##
TF1 = input.string(title='HTF', defval='60', options=['1', '3', '5', '15', '30', '45', '60', '120', '180', '240', '1D', '1W', '1M'])
TF2 = input.string(title='MTF', defval='15', options=['1', '3', '5', '15', '30', '45', '60', '120', '180', '240', '1D', '1W', '1M'])
TF3 = input.string(title='LTF', defval='5', options=['1', '3', '5', '15', '30', '45', '60', '120', '180', '240', '1D', '1W', '1M'])

//## logic section

//tabulate terms

RXS = ta.cross(fastMA, slowMA)
SXBcross = ta.cross(slowMA, mid)
RXB = ta.cross(fastMA, mid)
topband = ta.cross(fastMA, up)
lowband = ta.cross(fastMA, dn)

bullTDI = slowMA > mid
bearTDI = slowMA < mid
bullSXB = slowMA > mid
bearSXB = slowMA < mid

//bullEMA = DMA > WMA
//bearEMA = DMA < WMA

//MACD
// Getting inputs
fast_length = input(title='Fast Length', defval=40)
slow_length = input(title='Slow Length', defval=80)
src2 = input(title='Source', defval=close)
signal_length = input.int(title='Signal Smoothing', minval=1, maxval=50, defval=10)
sma_source = input(title='Simple MA(Oscillator)', defval=false)
sma_signal = input(title='Simple MA(Signal Line)', defval=false)

// Calculating
fast_ma = sma_source ? ta.sma(src2, fast_length) : ta.ema(src2, fast_length)
slow_ma = sma_source ? ta.sma(src2, slow_length) : ta.ema(src2, slow_length)
macd = fast_ma - slow_ma
signal = sma_signal ? ta.sma(macd, signal_length) : ta.ema(macd, signal_length)
hist = macd - signal

// M15 trend, M5 induction
//bullHTF = security(syminfo.tickerid, TF1, bullTDI, barmerge.gaps_off, barmerge.lookahead_off)
//bearLTF = security(syminfo.tickerid, TF2, lowband, barmerge.gaps_off, barmerge.lookahead_off)

//bearHTF = security(syminfo.tickerid, TF1, bearTDI, barmerge.gaps_off, barmerge.lookahead_off)
//bullLTF = security(syminfo.tickerid, TF2, topband, barmerge.gaps_off, barmerge.lookahead_off)

// Safety trade. H1 and M15 induction
//stbearHTF = security(syminfo.tickerid, TF1, lowband, barmerge.gaps_off, barmerge.lookahead_off)
//stbullHTF = security(syminfo.tickerid, TF1, topband, barmerge.gaps_off, barmerge.lookahead_off)

//BullAlert = bullHTF and bearLTF 
//BearAlert = bearHTF and bullLTF 

//STBullAlert = bearHTF 
//STBearAlert = bullHTF 

//bullRSI = fastMA > slowMA
//bullTDI = slowMA > mid

//bearRSI = fastMA < slowMA
//bearTDI = slowMA < mid

bearmacd = macd < 0
bullmacd = macd > 0
bullhist = hist > 0
bearhist = hist < 0
bullsig = signal > 0
bearsig = signal < 0

MCS = ta.crossover(macd, signal)

alertcondition(SXBcross, title='1.SXB', message='SXB for {{ticker}}')
alertcondition(RXS, title='2.RXS', message='RXS for {{ticker}}.')
alertcondition(RXB, title='3.RXB', message='RXB for {{ticker}}.')
alertcondition(SXBcross, title='M15 ASXB', message='M15 ASXB for {{ticker}}')

//alertcondition(bearhist, title = "1.Induction Histo < 0", message = "Induction Histo \n1. Draw Divergence Trend Line for {{ticker}}. \n2. Draw Zone \n3. Set Alert for MACD Induction")
//alertcondition(bullhist, title = "1.Induction Histo > 0", message = "Induction Histo \n1. Draw Divergence Trend Line for {{ticker}}. \n2. Draw Zone \n3. Set Alert for MACD Induction")

alertcondition(bearmacd, title='Induction MACD < 0', message='Induction MACD \n1. Check if M15 Divergence. \n2. Set Alert for MACD entry')
alertcondition(bullmacd, title='Induction MACD > 0', message='Induction MACD \n1. Check if M15 Divergence. \n2. Set Alert for MACD entry')

alertcondition(bearmacd, title='Entry MACD < 0', message='Potential Sells for {{ticker}}. \n1. Check HTF SXB \n4. SET ALERT Price to EMA 10 \n ##Take this Probability with Confidence.')
alertcondition(bullmacd, title='Entry MACD > 0', message='Potential Buys for {{ticker}}. \n1. Check HTF SXB \n4. SET ALERT Price to EMA 10 \n ##Take this Probability with Confidence.')

//alertcondition(bearmacd, title = "4.Exit MACD < 0", message = "Potential Long Exit.")
//alertcondition(bullmacd, title = "4.Exit MACD > 0", message = "Potential Short Exit.")

alertcondition(topband, title='Top Band', message='M15 Top Band. \nCheck H1 Histo \nSet Alert M5 MACD < 0')
alertcondition(lowband, title='Low Band', message='M15 Low Band. \nCheck H1 Histo \nSet Alert M5 MACD > 0')

//alertcondition(bullsig, title = "Signal > 0", message = "Signal > 0 \nInduction for {{ticker}}. \nSet MACD < 0 for entry")
//alertcondition(bearsig, title = "Signal < 0", message = "Signal < 0 \nInduction for {{ticker}}. \nSet MACD > 0 for entry")

alertcondition(bullhist, title='Entry Histo > 0', message='Histo > 0 \nPotential Buys. \n#1. Check HTF SXB \n#Take this Probability with Confidence!')
alertcondition(bearhist, title='Entry Histo < 0', message='Histo < 0 \nPotential Sells. \n#1. Check HTF SXB \n #Take this Probability with Confidence.')
alertcondition(bullhist, title='Bullish Histo > 0', message='M15 Histo > 0')
alertcondition(bearhist, title='Bearish Histo < 0', message='M15 Histo < 0')



//alertcondition(ECR, title = "2.ECR Induction", message = "ECR Induction. \nSet RXB M15 alert")
//alertcondition(ECR, title = "EMA cross", message = "EMA Cross for {{ticker}} \nCheck if OB touch")

//MACD + TDI alert
