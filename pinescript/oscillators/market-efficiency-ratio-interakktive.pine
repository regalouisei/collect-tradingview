// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Interakktive

//@version=6
indicator("Market Efficiency Ratio [Interakktive]", shorttitle = "MER", overlay = false, precision = 2, max_labels_count = 0, max_lines_count = 0, max_boxes_count = 0)

//==============================================================================
// SECTION 1: INPUTS
//==============================================================================

GRP_MAIN = "Interakktive — Market Efficiency Ratio"
GRP_VISUAL = "Visual Settings"
GRP_EXPORT = "Data Window"

len = input.int(14, "Lookback Length", minval = 5, maxval = 200, group = GRP_MAIN, tooltip = "Bars used to measure efficiency. Higher = smoother, slower response.")
smoothLen = input.int(5, "Smoothing Length", minval = 1, maxval = 100, group = GRP_MAIN, tooltip = "EMA smoothing length for the plotted output.")
useSmoothing = input.bool(true, "Apply Smoothing", group = GRP_MAIN, tooltip = "Enable/disable EMA smoothing.")
scaleMode = input.string("0–100", "Scale Mode", options = ["0–100", "0–1"], group = GRP_MAIN, tooltip = "Display as 0–100 or 0–1 ratio.")

showBands = input.bool(true, "Show Reference Bands", group = GRP_VISUAL, tooltip = "Plot low/high reference levels.")
lowBand = input.float(30.0, "Low Efficiency Level", minval = 0.0, maxval = 100.0, group = GRP_VISUAL, tooltip = "Below = choppy/inefficient movement.")
highBand = input.float(70.0, "High Efficiency Level", minval = 0.0, maxval = 100.0, group = GRP_VISUAL, tooltip = "Above = efficient directional movement.")

showDataExports = input.bool(true, "Show Data Window Values", group = GRP_EXPORT, tooltip = "Export calculated values to the data window.")

//==============================================================================
// SECTION 2: CONSTANTS & HELPERS (compute-only)
//==============================================================================

// Brand Colors (Interakktive Visual Style Guide v1.0)
colorEffHigh = color.new(#26A69A, 0)      // Teal — high efficiency (clean movement)
colorEffMid = color.new(#8A8A8A, 0)       // Neutral grey — mid efficiency
colorEffLow = color.new(#EF5350, 0)       // Magenta — low efficiency (noisy movement)
colorBand = color.new(#8A8A8A, 60)        // Neutral grey — reference lines

clamp100(val) => val < 0.0 ? 0.0 : (val > 100.0 ? 100.0 : val)
clamp01(val) => val < 0.0 ? 0.0 : (val > 1.0 ? 1.0 : val)

calcPathLength(length) =>
    pathSum = 0.0
    maxI = math.max(length - 2, 0)
    safeMax = math.min(maxI, math.max(bar_index - 1, 0))
    if safeMax >= 0
        for i = 0 to safeMax
            curr = close[i]
            prev = close[i + 1]
            delta = (na(curr) or na(prev)) ? 0.0 : math.abs(curr - prev)
            pathSum += delta
    pathSum

//==============================================================================
// SECTION 3: CORE COMPUTATION
//==============================================================================

closeAtLen = not na(close[len]) ? close[len] : na
netMove = na(closeAtLen) ? 0.0 : math.abs(close - closeAtLen)

pathLen = calcPathLength(len)

effRatioRaw = pathLen > 0.0 ? netMove / pathLen : 0.0
effRatio = clamp01(effRatioRaw)

eff100 = clamp100(effRatio * 100.0)

chopCostRaw = pathLen - netMove
chopCost = chopCostRaw < 0.0 ? 0.0 : chopCostRaw

chopPctRaw = pathLen > 0.0 ? chopCost / pathLen : 0.0
chopPct = clamp01(chopPctRaw)

effRaw = scaleMode == "0–100" ? eff100 : effRatio
effPlot = useSmoothing ? ta.ema(effRaw, smoothLen) : effRaw

//==============================================================================
// SECTION 4: VISUAL OUTPUT (global scope only)
//==============================================================================

effForColor = scaleMode == "0–100" ? effPlot : effPlot * 100.0
effColor = effForColor >= highBand ? colorEffHigh : (effForColor >= lowBand ? colorEffMid : colorEffLow)

plot(effPlot, "Efficiency", color = effColor, linewidth = 2)

lowBandPlot = scaleMode == "0–100" ? lowBand : lowBand / 100.0
highBandPlot = scaleMode == "0–100" ? highBand : highBand / 100.0
midBandPlot = scaleMode == "0–100" ? 50.0 : 0.5

bandHigh = plot(showBands ? highBandPlot : na, "Efficiency High Band", color = colorBand, linewidth = 1, style = plot.style_line)
bandLow = plot(showBands ? lowBandPlot : na, "Efficiency Low Band", color = colorBand, linewidth = 1, style = plot.style_line)
bandMid = plot(showBands and scaleMode == "0–100" ? midBandPlot : na, "Efficiency Mid Band", color = color.new(#8A8A8A, 75), linewidth = 1, style = plot.style_line)

topLevel = scaleMode == "0–100" ? 100.0 : 1.0
baseLevel = 0.0

pTop = plot(showBands ? topLevel : na, "Top", color = na, display = display.none)
pZero = plot(showBands ? baseLevel : na, "Zero", color = na, display = display.none)

fill(bandHigh, pTop, color = showBands ? color.new(colorEffHigh, 90) : na, title = "High Zone")
fill(bandLow, pZero, color = showBands ? color.new(colorEffLow, 90) : na, title = "Low Zone")

//==============================================================================
// SECTION 5: DATA WINDOW EXPORTS
//==============================================================================

plot(showDataExports ? netMove : na, "Net Displacement", display = display.data_window)
plot(showDataExports ? pathLen : na, "Path Length", display = display.data_window)
plot(showDataExports ? effRatio : na, "Efficiency Ratio (0–1)", display = display.data_window)
plot(showDataExports ? eff100 : na, "Efficiency (0–100)", display = display.data_window)
plot(showDataExports ? chopCost : na, "Chop Cost", display = display.data_window)
plot(showDataExports ? chopPct : na, "Chop % (0–1)", display = display.data_window)

//==============================================================================
// END OF SCRIPT
//==============================================================================
