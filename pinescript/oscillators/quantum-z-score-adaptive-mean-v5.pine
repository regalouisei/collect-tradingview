//@version=6
indicator("Quantum Z-Score [Adaptive Mean] v5", shorttitle="Quant_Z_Adapt_v5", overlay=false)

// =============================================================================
// 1. SETTINGS
// =============================================================================
group_main = "Z-Score Settings"
len     = input.int(14, "Length", group=group_main)
sens    = input.float(0.5, "Adaptive Sensitivity", minval=0.01, maxval=5.0, step=0.1, group=group_main)
src     = input.source(close, "Source", group=group_main)

group_sig   = "Trailing Signal"
show_sig    = input.bool(true, "Show Trailing MA?", group=group_sig)
sig_len     = input.int(9, "Signal Length", group=group_sig)
sig_sens    = input.float(1.0, "Signal Sensitivity", group=group_sig)

// --- NEW: Custom Color Inputs ---
group_col   = "Line & Fill Colors"
c_bull      = input.color(#00FFFF, "Overbought (> +2 SD)", group=group_col)
c_bear      = input.color(#FF00FF, "Oversold (< -2 SD)", group=group_col)
c_neu       = input.color(#FFFF00, "Neutral Zone", group=group_col)
c_sig       = input.color(color.new(color.gray, 30), "Trailing MA Line", group=group_col)

group_div       = "Divergences"
show_reg        = input.bool(true, "Show Regular?", group=group_div)
show_hid        = input.bool(true, "Show Hidden?", group=group_div)
c_div_bull_reg  = input.color(#00FFFF, "Regular Bullish Color", group=group_div)
c_div_bull_hid  = input.color(color.gray, "Hidden Bullish Color", group=group_div)
c_div_bear_reg  = input.color(#FF00FF, "Regular Bearish Color", group=group_div)
c_div_bear_hid  = input.color(color.gray, "Hidden Bearish Color", group=group_div)

// =============================================================================
// 2. ADAPTIVE ENGINE
// =============================================================================
get_ama(float src, int len, float s) =>
    float change = math.abs(src - src[10])
    float volatility = ta.sma(math.abs(src - src[10]), 10) // Fixed historical volatility lookup
    float er = volatility != 0 ? change / (volatility * 10) : 0
    float alpha = math.pow(er * (2.0 / (len + 1)), s)
    var float ama = src
    ama := alpha * src + (1 - alpha) * nz(ama[1])
    ama

// =============================================================================
// 3. CALCULATIONS
// =============================================================================
float mean_val = get_ama(src, len, sens)
float stdev_val = ta.stdev(src, len)
float z_score = (src - mean_val) / math.max(stdev_val, 0.0001) // Added failsafe against division by zero
float z_signal = get_ama(z_score, sig_len, sig_sens)

// =============================================================================
// 4. PLOTS
// =============================================================================
// Z-Score Line (Dynamic Color)
color z_col = z_score > 2 ? c_bull : z_score < -2 ? c_bear : c_neu
plot(z_score, "Z-Score", color=z_col, linewidth=2)

// Trailing Signal Line
plot(show_sig ? z_signal : na, "Trailing MA", color=c_sig, linewidth=1)

// Fill to show momentum gap
fill(plot(z_score), plot(show_sig ? z_signal : na), color=color.new(z_col, 85), title="Momentum Cloud")

// Levels
hline(2.0, "+2 SD", color=color.gray, linestyle=hline.style_dashed)
hline(0.0, "Zero", color=color.gray, linestyle=hline.style_dotted)
hline(-2.0, "-2 SD", color=color.gray, linestyle=hline.style_dashed)

// =============================================================================
// 5. DIVERGENCE ENGINE
// =============================================================================
int lb = 5
float pl = ta.pivotlow(z_score, lb, lb)
float ph = ta.pivothigh(z_score, lb, lb)

// Global lookups
float prev_pl_price = ta.valuewhen(not na(pl), low[lb], 1)
float prev_pl_z     = ta.valuewhen(not na(pl), z_score[lb], 1)
float prev_ph_price = ta.valuewhen(not na(ph), high[lb], 1)
float prev_ph_z     = ta.valuewhen(not na(ph), z_score[lb], 1)

// Regular Bullish: Price Lower Low, Z-Score Higher Low
bool reg_bull = not na(pl) and (low[lb] < prev_pl_price) and (z_score[lb] > prev_pl_z)

// Hidden Bullish: Price Higher Low, Z-Score Lower Low
bool hid_bull = not na(pl) and (low[lb] > prev_pl_price) and (z_score[lb] < prev_pl_z)

// Regular Bearish: Price Higher High, Z-Score Lower High
bool reg_bear = not na(ph) and (high[lb] > prev_ph_price) and (z_score[lb] < prev_ph_z)

// Hidden Bearish: Price Lower High, Z-Score Higher High
bool hid_bear = not na(ph) and (high[lb] < prev_ph_price) and (z_score[lb] > prev_ph_z)

plotshape(show_reg and reg_bull, "Reg Bull", shape.triangleup, location.bottom, c_div_bull_reg, size=size.tiny, offset=-lb)
plotshape(show_hid and hid_bull, "Hid Bull", shape.triangleup, location.bottom, c_div_bull_hid, size=size.tiny, offset=-lb)
plotshape(show_reg and reg_bear, "Reg Bear", shape.triangledown, location.top, c_div_bear_reg, size=size.tiny, offset=-lb)
plotshape(show_hid and hid_bear, "Hid Bear", shape.triangledown, location.top, c_div_bear_hid, size=size.tiny, offset=-lb)
