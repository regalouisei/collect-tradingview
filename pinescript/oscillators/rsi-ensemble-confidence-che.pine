// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
//  _______           _______  _______           _______  _       _________ _        _______ 
// (  ____ \|\     /|(  ____ \(  ____ )|\     /|(  ___  )( \      \__   __/( (    /|(  ___  )
// | (    \/| )   ( || (    \/| (    )|| )   ( || (   ) || (         ) (   |  \  ( || (   ) |
// | |      | (___) || (__    | (____)|| |   | || |   | || |         | |   |   \ | || |   | |
// | |      |  ___  ||  __)   |     __)( (   ) )| |   | || |         | |   | (\ \) || |   | |
// | |      | (   ) || (      | (\ (    \ \_/ / | |   | || |         | |   | | \   || |   | |
// | (____/\| )   ( || (____/\| ) \ \__  \   /  | (___) || (____/\___) (___| )  \  || (___) |
// (_______/|/     \|(_______/|/   \__/   \_/   (_______)(_______/\_______/|/    )_)(_______)
// © chervolino
//@version=6
indicator(title="RSI Ensemble Confidence [CHE]", shorttitle="RSI Ens", overlay=false, max_bars_back=500, scale=scale.right, max_lines_count=500, max_labels_count=500)

// ——— SECTION: Constants & Enums
color GREEN = #089981
color RED = #F23645
color ORANGE = #FF8C00
color AQUA = #00FFFF
color FUCHSIA = #FF00FF
color WHITE = #FFFFFF

string GRP_LEN = "Ensemble Lengths"
string GRP_SRC = "Price Sources"
string GRP_CONF = "Confidence Settings"

// ——— SECTION: Inputs (grouped; tooltips; one-row via inline)
len1_input = input.int(8, "Length 1", minval=2, group=GRP_LEN, tooltip="First RSI period")
len2_input = input.int(14, "Length 2", minval=2, group=GRP_LEN, tooltip="Second RSI period")
len3_input = input.int(21, "Length 3", minval=2, group=GRP_LEN, tooltip="Third RSI period")
len4_input = input.int(34, "Length 4", minval=2, group=GRP_LEN, tooltip="Fourth RSI period")

use_close_input = input.bool(true, "Close", group=GRP_SRC, inline="src1", tooltip="Include close price RSI")
use_open_input = input.bool(true, "Open", group=GRP_SRC, inline="src2", tooltip="Include open price RSI")
use_high_input = input.bool(true, "High", group=GRP_SRC, inline="src3", tooltip="Include high price RSI")
use_low_input = input.bool(true, "Low", group=GRP_SRC, inline="src4", tooltip="Include low price RSI")
use_hl2_input = input.bool(true, "HL2", group=GRP_SRC, inline="src5", tooltip="Include hl2 price RSI")
use_ohlc4_input = input.bool(false, "OHLC4", group=GRP_SRC, inline="src5", tooltip="Include ohlc4 price RSI")

max_std_input = input.float(20.0, "Max expected StdDev (normalization)", minval=1.0, step=0.5, group=GRP_CONF, tooltip="Higher value = lower confidence sensitivity")
show_band_input = input.bool(true, "Show Mean ±1 StdDev Band", group=GRP_CONF, tooltip="Display dispersion band around ensemble mean")
show_hist_input = input.bool(true, "Show StdDev Histogram", group=GRP_CONF, tooltip="Show raw standard deviation as columns")

// ——— SECTION: Helpers (pure)
calc_rsi(src_input, len_input) => ta.rsi(src_input, len_input)

// ——— SECTION: Persistent Vars → Runtime Vars
var float[] rsi_ensemble_values = array.new_float()

// ——— SECTION: Core Calculations
array.clear(rsi_ensemble_values)

if use_close_input
    array.push(rsi_ensemble_values, calc_rsi(close, len1_input))
    array.push(rsi_ensemble_values, calc_rsi(close, len2_input))
    array.push(rsi_ensemble_values, calc_rsi(close, len3_input))
    array.push(rsi_ensemble_values, calc_rsi(close, len4_input))
if use_open_input
    array.push(rsi_ensemble_values, calc_rsi(open, len1_input))
    array.push(rsi_ensemble_values, calc_rsi(open, len2_input))
    array.push(rsi_ensemble_values, calc_rsi(open, len3_input))
    array.push(rsi_ensemble_values, calc_rsi(open, len4_input))
if use_high_input
    array.push(rsi_ensemble_values, calc_rsi(high, len1_input))
    array.push(rsi_ensemble_values, calc_rsi(high, len2_input))
    array.push(rsi_ensemble_values, calc_rsi(high, len3_input))
    array.push(rsi_ensemble_values, calc_rsi(high, len4_input))
if use_low_input
    array.push(rsi_ensemble_values, calc_rsi(low, len1_input))
    array.push(rsi_ensemble_values, calc_rsi(low, len2_input))
    array.push(rsi_ensemble_values, calc_rsi(low, len3_input))
    array.push(rsi_ensemble_values, calc_rsi(low, len4_input))
if use_hl2_input
    array.push(rsi_ensemble_values, calc_rsi(hl2, len1_input))
    array.push(rsi_ensemble_values, calc_rsi(hl2, len2_input))
    array.push(rsi_ensemble_values, calc_rsi(hl2, len3_input))
    array.push(rsi_ensemble_values, calc_rsi(hl2, len4_input))
if use_ohlc4_input
    array.push(rsi_ensemble_values, calc_rsi(ohlc4, len1_input))
    array.push(rsi_ensemble_values, calc_rsi(ohlc4, len2_input))
    array.push(rsi_ensemble_values, calc_rsi(ohlc4, len3_input))
    array.push(rsi_ensemble_values, calc_rsi(ohlc4, len4_input))

rsi_ensemble_size = array.size(rsi_ensemble_values)
rsi_ensemble_mean = rsi_ensemble_size > 0 ? array.avg(rsi_ensemble_values) : na
rsi_ensemble_std = rsi_ensemble_size > 1 ? array.stdev(rsi_ensemble_values) : na

rsi_ensemble_confidence = rsi_ensemble_size > 1 and not na(rsi_ensemble_std) ? math.max(0.0, 100.0 - (rsi_ensemble_std / max_std_input * 100.0)) : rsi_ensemble_size == 1 ? 80.0 : na

rsi_reference_close_len2 = ta.rsi(close, len2_input)

is_dispersion_band_active = show_band_input and rsi_ensemble_size > 1 and not na(rsi_ensemble_mean) and not na(rsi_ensemble_std)

rsi_ensemble_std_sma = ta.sma(rsi_ensemble_std, 14)

is_confidence_cross_over_high = ta.crossover(rsi_ensemble_confidence, 80)
is_confidence_cross_under_low = ta.crossunder(rsi_ensemble_confidence, 40)

// ——— SECTION: Rendering/UI (GLOBAL ONLY; single-line calls)
hline(70, "Overbought", color=color.new(color.red, 60))
hline(30, "Oversold", color=color.new(color.green, 60))
hline(50, "Midline", color=color.gray)

plot(rsi_reference_close_len2, "RSI Reference (Close 14)", color=color.blue, linewidth=2)

plot_rsi_ensemble_mean = plot(rsi_ensemble_mean, "Ensemble Mean", color=ORANGE, linewidth=2)

plot_rsi_ensemble_upper = plot(is_dispersion_band_active ? rsi_ensemble_mean + rsi_ensemble_std : na, "Mean + StdDev", color=color.new(ORANGE, 100))
plot_rsi_ensemble_lower = plot(is_dispersion_band_active ? rsi_ensemble_mean - rsi_ensemble_std : na, "Mean - StdDev", color=color.new(ORANGE, 100))

fill(plot_rsi_ensemble_upper, plot_rsi_ensemble_lower, color=color.new(ORANGE, 90), title="±1 StdDev Band")

plot(rsi_ensemble_confidence, "Confidence (0–100)", color=AQUA, linewidth=3)

plot(show_hist_input and rsi_ensemble_size > 1 ? rsi_ensemble_std : na, "StdDev (Dispersion)", color=rsi_ensemble_std_sma > rsi_ensemble_std ? WHITE : FUCHSIA, style=plot.style_columns, linewidth=3)

plot(rsi_ensemble_std_sma, "StdDev SMA", color=WHITE, linewidth=1)

bgcolor(rsi_ensemble_confidence >= 80 ? color.new(GREEN, 90) : rsi_ensemble_confidence >= 60 ? color.new(ORANGE, 92) : rsi_ensemble_confidence >= 40 ? color.new(RED, 90) : na, title="Confidence Background")

alertcondition(barstate.isconfirmed and is_confidence_cross_over_high, "High Confidence", "Ensemble RSI shows HIGH agreement")
alertcondition(barstate.isconfirmed and is_confidence_cross_under_low, "Low Confidence", "Ensemble RSI shows strong disagreement")
