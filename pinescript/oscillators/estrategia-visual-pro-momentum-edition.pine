//@version=6
indicator("Estrategia Visual PRO: Momentum Edition", overlay=true, max_lines_count=100)

// ==============================================
// --- 1. CONFIGURACIÓN DEL SISTEMA DE CRUCE (EMAs) ---
// ==============================================
grpEma = "Sistema de Cruce (EMAs)"
lenPrincipal = input.int(10, minval=1, title="Longitud EMA Principal (Rápida)", group=grpEma)
srcPrincipal = input.source(close, title="Fuente EMA Principal", group=grpEma)

lenSecundaria = input.int(50, minval=1, title="Longitud EMA Secundaria (Lenta)", group=grpEma)
srcSecundaria = input.source(close, title="Fuente EMA Secundaria", group=grpEma)

// ==============================================
// --- 2. CONFIGURACIÓN DE VELAS DE MOMENTUM (NUEVO) ---
// ==============================================
grpCol = "Coloreado de Velas (Limpieza Visual)"
useBarColor = input.bool(true, "Colorear Velas por Fuerza?", group=grpCol, tooltip="Gris = Rango/Sin Fuerza. Colores Vivos = Tendencia Fuerte.")
// Filtro adicional para definir fuerza (RSI > 50 o solo EMAs)
useRsiFilter = input.bool(false, "Usar RSI para confirmar fuerza?", group=grpCol)

// ==============================================
// --- 3. CONFIGURACIÓN DE SMAs ADICIONALES ---
// ==============================================
grpSma = "SMAs de Referencia (Adicionales)"
showSMA1 = input.bool(true, "Mostrar SMA 1", group=grpSma, inline="sma1")
lenSMA1 = input.int(50, "Longitud", group=grpSma, inline="sma1")
colSMA1 = input.color(color.purple, "", group=grpSma, inline="sma1")

showSMA2 = input.bool(true, "Mostrar SMA 2", group=grpSma, inline="sma2")
lenSMA2 = input.int(100, "Longitud", group=grpSma, inline="sma2")
colSMA2 = input.color(color.yellow, "", group=grpSma, inline="sma2")

showSMA3 = input.bool(true, "Mostrar SMA 3", group=grpSma, inline="sma3")
lenSMA3 = input.int(200, "Longitud", group=grpSma, inline="sma3")
colSMA3 = input.color(color.white, "", group=grpSma, inline="sma3")

// ==============================================
// --- 4. DETECTOR DE VOLUMEN (VSA) ---
// ==============================================
grpVol = "Detector de Volumen en Mechas"
volLength = input.int(20, "Promedio de Volumen (SMA)", group=grpVol)
factorMecha = input.float(2.0, "Factor de Tamaño de Mecha", minval=1.0, step=0.1, group=grpVol)

// ==============================================
// --- 5. SOPORTES Y RESISTENCIAS ---
// ==============================================
grpSR = "Soportes y Resistencias Dinámicos"
showSR = input.bool(true, "Mostrar Niveles S/R", group=grpSR)
srLen = input.int(20, "Importancia del Nivel", minval=5, group=grpSR)
maxLines = input.int(6, "Máximo de Líneas", minval=1, maxval=20, group=grpSR)

// ==============================================
// --- CÁLCULOS TÉCNICOS ---
// ==============================================
// EMAs
emaPrincipal = ta.ema(srcPrincipal, lenPrincipal)
emaSecundaria = ta.ema(srcSecundaria, lenSecundaria)

// SMAs
smaVal1 = ta.sma(close, lenSMA1)
smaVal2 = ta.sma(close, lenSMA2)
smaVal3 = ta.sma(close, lenSMA3)

// RSI (para filtro de color opcional)
rsiVal = ta.rsi(close, 14)

// ==============================================
// --- LÓGICA DE MOMENTUM (COLOREADO) ---
// ==============================================
// Definimos condiciones de fuerza
bullTrend = close > emaPrincipal and close > emaSecundaria and (useRsiFilter ? rsiVal > 50 : true)
bearTrend = close < emaPrincipal and close < emaSecundaria and (useRsiFilter ? rsiVal < 50 : true)

// Asignamos color a la barra
var color barColor = na
if bullTrend
    barColor := color.lime // Tendencia Alcista Fuerte
else if bearTrend
    barColor := color.red  // Tendencia Bajista Fuerte
else
    barColor := color.gray // Zona Muerta / Rango (¡NO OPERAR!)

// Aplicar color
barcolor(useBarColor ? barColor : na)

// ==============================================
// --- CÁLCULOS DE VOLUMEN (VSA) ---
// ==============================================
cuerpo = math.abs(close - open)
mechaSup = high - math.max(open, close)
mechaInf = math.min(open, close) - low
volMedio = ta.sma(volume, volLength)
volAlto = volume > volMedio 
presionVenta = volAlto and (mechaSup > (cuerpo * factorMecha)) and (mechaSup > mechaInf)
presionCompra = volAlto and (mechaInf > (cuerpo * factorMecha)) and (mechaInf > mechaSup)

// ==============================================
// --- MOTOR DE SOPORTES Y RESISTENCIAS ---
// ==============================================
ph = ta.pivothigh(high, srLen, srLen)
pl = ta.pivotlow(low, srLen, srLen)
var line[] resLines = array.new_line()
var line[] supLines = array.new_line()

if showSR
    if not na(ph)
        l = line.new(bar_index[srLen], ph, bar_index, ph, color=color.new(color.red, 30), width=1)
        line.set_extend(l, extend.right)
        array.push(resLines, l)
        if array.size(resLines) > maxLines
            line.delete(array.shift(resLines))
    if not na(pl)
        l = line.new(bar_index[srLen], pl, bar_index, pl, color=color.new(color.green, 30), width=1)
        line.set_extend(l, extend.right)
        array.push(supLines, l)
        if array.size(supLines) > maxLines
            line.delete(array.shift(supLines))

// ==============================================
// --- VISUALIZACIÓN ---
// ==============================================
p1 = plot(emaPrincipal, color=color.new(color.blue, 0), linewidth=2, title="EMA Principal")
p2 = plot(emaSecundaria, color=color.new(color.orange, 0), linewidth=2, title="EMA Secundaria")
fill(p1, p2, color=emaPrincipal > emaSecundaria ? color.new(color.green, 90) : color.new(color.red, 90))

plot(showSMA1 ? smaVal1 : na, color=colSMA1, linewidth=1, title="SMA 1")
plot(showSMA2 ? smaVal2 : na, color=colSMA2, linewidth=2, title="SMA 2")
plot(showSMA3 ? smaVal3 : na, color=colSMA3, linewidth=2, title="SMA 3")

plotshape(presionVenta, style=shape.cross, location=location.abovebar, color=color.red, size=size.small, title="VSA Venta")
plotshape(presionCompra, style=shape.cross, location=location.belowbar, color=color.lime, size=size.small, title="VSA Compra")

cruceArriba = ta.crossover(emaPrincipal, emaSecundaria)
cruceAbajo = ta.crossunder(emaPrincipal, emaSecundaria)
plotshape(cruceArriba, style=shape.labelup, location=location.belowbar, color=color.green, text="BUY", textcolor=color.white, size=size.small)
plotshape(cruceAbajo, style=shape.labeldown, location=location.abovebar, color=color.red, text="SELL", textcolor=color.white, size=size.small)
