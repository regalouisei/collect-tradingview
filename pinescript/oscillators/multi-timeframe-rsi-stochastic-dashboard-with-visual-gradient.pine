// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © XRayTrade

//@version=6
indicator("MTF RSI + Stochastic Dashboard", overlay=true, max_boxes_count=500, max_labels_count=500)

// ══════════════════════════════════════════════════════════════════════════════
//                    MULTI-TIMEFRAME RSI + STOCHASTIC DASHBOARD
// ══════════════════════════════════════════════════════════════════════════════

// ─────────────────────────────────────────────────────────────────────────────
// INPUTS
// ─────────────────────────────────────────────────────────────────────────────

group_rsi = "RSI Settings"
rsiLength = input.int(14, "RSI Length", minval=2, group=group_rsi)
rsiSource = input.source(close, "RSI Source", group=group_rsi)
rsiOBLevel = input.int(70, "RSI Overbought Level", minval=50, maxval=100, group=group_rsi)
rsiOSLevel = input.int(30, "RSI Oversold Level", minval=0, maxval=50, group=group_rsi)

group_stoch = "Stochastic Settings"
stochKLength = input.int(14, "%K Length", minval=1, group=group_stoch)
stochKSmooth = input.int(3, "%K Smoothing", minval=1, group=group_stoch)
stochDSmooth = input.int(3, "%D Smoothing", minval=1, group=group_stoch)
stochUseK = input.bool(true, "Use %K for Fill (false = %D)", group=group_stoch)
stochOBLevel = input.int(80, "Stoch Overbought Level", minval=50, maxval=100, group=group_stoch)
stochOSLevel = input.int(-20, "Stoch Oversold Level", minval=-50, maxval=50, group=group_stoch)
stochMidLevel = input.int(50, "Stoch Middle Level", minval=0, maxval=100, group=group_stoch)
stochZeroLevel = input.int(0, "Stoch Zero Level", minval=-50, maxval=50, group=group_stoch)

group_tf = "Timeframes (6 Slots)"
tf1 = input.timeframe("1", "Timeframe 1", group=group_tf)
tf2 = input.timeframe("5", "Timeframe 2", group=group_tf)
tf3 = input.timeframe("15", "Timeframe 3", group=group_tf)
tf4 = input.timeframe("60", "Timeframe 4", group=group_tf)
tf5 = input.timeframe("240", "Timeframe 5", group=group_tf)
tf6 = input.timeframe("D", "Timeframe 6", group=group_tf)

group_layout = "Layout Settings"
xOffset = input.int(5, "Horizontal Offset (bars from right)", minval=1, maxval=50, group=group_layout)
yOffset = input.float(50.0, "Vertical Offset (% above high)", minval=0.1, maxval=100.0, step=0.5, group=group_layout)
overallScale = input.float(2.0, "Overall Scale Size", minval=0.5, maxval=5.0, step=0.1, group=group_layout)
textVerticalOffset = input.float(0.8, "Text Vertical Offset (-1=top, 0=center, 1=bottom)", minval=-1.0, maxval=1.0, step=0.1, group=group_layout)
boxWidth = input.int(6, "Box Width (bars)", minval=2, maxval=20, group=group_layout)
boxSpacing = input.int(0, "Box Spacing (bars)", minval=0, maxval=5, group=group_layout)
boxHeightPct = input.float(10.0, "Box Height (% of visible range)", minval=0.5, maxval=20.0, step=0.5, group=group_layout)
gradientHeightPct = input.float(25.0, "Gradient Height (% of visible range)", minval=2.0, maxval=50.0, step=0.5, group=group_layout)
gradientSegments = input.int(20, "Gradient Segments", minval=5, maxval=50, group=group_layout)
biasPaddingPct = input.float(2.0, "Bias Bar Top Padding (%)", minval=0.0, maxval=10.0, step=0.5, group=group_layout)
outerPadding = input.int(3, "Outer Border Padding (bars)", minval=1, maxval=10, group=group_layout)
outerPadPct = input.float(1.0, "Outer Border Vertical Padding (%)", minval=0.5, maxval=5.0, step=0.5, group=group_layout)

group_colors = "Colors"
bullColor = input.color(color.new(#00c853, 0), "Bullish", group=group_colors)
bearColor = input.color(color.new(#ff1744, 0), "Bearish", group=group_colors)
obColor = input.color(color.new(#aa00ff, 0), "Overbought", group=group_colors)
osColor = input.color(color.new(#00bcd4, 0), "Oversold", group=group_colors)
neutralColor = input.color(color.new(#9e9e9e, 0), "Neutral", group=group_colors)
boxBgColor = input.color(color.new(#1a1a1a, 0), "Box Background", group=group_colors)
boxBorderColor = input.color(color.new(#444444, 0), "Box Border", group=group_colors)
outerBorderColor = input.color(color.new(#666666, 0), "Outer Border Color", group=group_colors)
textColor = input.color(color.new(#ffffff, 0), "Text Color", group=group_colors)
scaleTitleColor = input.color(color.new(#ffff00, 0), "Scale Title Color", group=group_colors)

// ─────────────────────────────────────────────────────────────────────────────
// FUNCTIONS
// ─────────────────────────────────────────────────────────────────────────────

getRsiColor(float rsiVal) =>
    if na(rsiVal)
        neutralColor
    else if rsiVal >= rsiOBLevel
        obColor
    else if rsiVal <= rsiOSLevel
        osColor
    else if rsiVal > 50
        bullColor
    else if rsiVal < 50
        bearColor
    else
        neutralColor

getRsiStatus(float rsiVal) =>
    if na(rsiVal)
        "-"
    else if rsiVal >= rsiOBLevel
        "OB"
    else if rsiVal <= rsiOSLevel
        "OS"
    else if rsiVal > 55
        "Bull"
    else if rsiVal < 45
        "Bear"
    else
        "Neut"

// Get stochastic status
getStochStatus(float stochVal) =>
    if na(stochVal)
        "-"
    else if stochVal >= 80
        "OB"
    else if stochVal <= 20
        "OS"
    else if stochVal > 55
        "Bull"
    else if stochVal < 45
        "Bear"
    else
        "Neut"

// Combined status based on RSI and Stochastic agreement
getCombinedStatus(float rsiVal, float stochVal) =>
    string rsiStatus = getRsiStatus(rsiVal)
    string stochStatus = getStochStatus(stochVal)
    
    if na(rsiVal) or na(stochVal)
        "-"
    else if rsiStatus == "OB" and stochStatus == "OB"
        "OB"
    else if rsiStatus == "OS" and stochStatus == "OS"
        "OS"
    else if rsiStatus == "Bull" and stochStatus == "OB"
        "S.Bull"
    else if rsiStatus == "Bear" and stochStatus == "OS"
        "S.Bear"
    else if rsiStatus == "Bull" and stochStatus == "Bull"
        "Bull"
    else if rsiStatus == "Bear" and stochStatus == "Bear"
        "Bear"
    else if (rsiStatus == "OB" and stochStatus == "Bull") or (rsiStatus == "Bull" and stochStatus == "OB")
        "S.Bull"
    else if (rsiStatus == "OS" and stochStatus == "Bear") or (rsiStatus == "Bear" and stochStatus == "OS")
        "S.Bear"
    else
        "Mixed"

// Get color for combined status
getCombinedColor(float rsiVal, float stochVal) =>
    string status = getCombinedStatus(rsiVal, stochVal)
    if status == "OB" or status == "S.Bull"
        obColor
    else if status == "OS" or status == "S.Bear"
        osColor
    else if status == "Bull"
        bullColor
    else if status == "Bear"
        bearColor
    else
        neutralColor

formatTf(simple string tf) =>
    switch tf
        "1" => "1m"
        "3" => "3m"
        "5" => "5m"
        "15" => "15m"
        "30" => "30m"
        "45" => "45m"
        "60" => "1H"
        "120" => "2H"
        "180" => "3H"
        "240" => "4H"
        "D" => "D"
        "1D" => "D"
        "W" => "W"
        "1W" => "W"
        "M" => "M"
        "1M" => "M"
        => tf

// Gradient color based on position (0.0 = bottom, 1.0 = top)
getGradientColor(float pos) =>
    color result = boxBgColor
    if pos > 0.95
        result := color.rgb(170, 0, 255)
    else if pos > 0.90
        result := color.rgb(175, 25, 240)
    else if pos > 0.85
        result := color.rgb(180, 50, 220)
    else if pos > 0.80
        result := color.rgb(170, 65, 210)
    else if pos > 0.75
        result := color.rgb(160, 80, 200)
    else if pos > 0.70
        result := color.rgb(80, 140, 160)
    else if pos > 0.65
        result := color.rgb(0, 200, 83)
    else if pos > 0.60
        result := color.rgb(50, 190, 80)
    else if pos > 0.55
        result := color.rgb(100, 175, 80)
    else if pos > 0.50
        result := color.rgb(150, 165, 70)
    else if pos > 0.45
        result := color.rgb(200, 160, 60)
    else if pos > 0.40
        result := color.rgb(220, 140, 50)
    else if pos > 0.35
        result := color.rgb(240, 120, 45)
    else if pos > 0.30
        result := color.rgb(255, 100, 40)
    else if pos > 0.25
        result := color.rgb(255, 60, 50)
    else if pos > 0.20
        result := color.rgb(255, 23, 68)
    else if pos > 0.15
        result := color.rgb(200, 60, 100)
    else if pos > 0.10
        result := color.rgb(150, 100, 150)
    else if pos > 0.05
        result := color.rgb(100, 150, 190)
    else
        result := color.rgb(0, 188, 212)
    result

// Calculate stochastic
calcStoch(float src, int kLen, int kSmooth, int dSmooth) =>
    float rawK = ta.stoch(src, high, low, kLen)
    float k = ta.sma(rawK, kSmooth)
    float d = ta.sma(k, dSmooth)
    [k, d]

// ─────────────────────────────────────────────────────────────────────────────
// RSI CALCULATIONS
// ─────────────────────────────────────────────────────────────────────────────

rsi1 = request.security(syminfo.tickerid, tf1, ta.rsi(rsiSource, rsiLength), lookahead=barmerge.lookahead_off)
rsi2 = request.security(syminfo.tickerid, tf2, ta.rsi(rsiSource, rsiLength), lookahead=barmerge.lookahead_off)
rsi3 = request.security(syminfo.tickerid, tf3, ta.rsi(rsiSource, rsiLength), lookahead=barmerge.lookahead_off)
rsi4 = request.security(syminfo.tickerid, tf4, ta.rsi(rsiSource, rsiLength), lookahead=barmerge.lookahead_off)
rsi5 = request.security(syminfo.tickerid, tf5, ta.rsi(rsiSource, rsiLength), lookahead=barmerge.lookahead_off)
rsi6 = request.security(syminfo.tickerid, tf6, ta.rsi(rsiSource, rsiLength), lookahead=barmerge.lookahead_off)

// ─────────────────────────────────────────────────────────────────────────────
// STOCHASTIC CALCULATIONS
// ─────────────────────────────────────────────────────────────────────────────

[stochK1, stochD1] = request.security(syminfo.tickerid, tf1, calcStoch(close, stochKLength, stochKSmooth, stochDSmooth), lookahead=barmerge.lookahead_off)
[stochK2, stochD2] = request.security(syminfo.tickerid, tf2, calcStoch(close, stochKLength, stochKSmooth, stochDSmooth), lookahead=barmerge.lookahead_off)
[stochK3, stochD3] = request.security(syminfo.tickerid, tf3, calcStoch(close, stochKLength, stochKSmooth, stochDSmooth), lookahead=barmerge.lookahead_off)
[stochK4, stochD4] = request.security(syminfo.tickerid, tf4, calcStoch(close, stochKLength, stochKSmooth, stochDSmooth), lookahead=barmerge.lookahead_off)
[stochK5, stochD5] = request.security(syminfo.tickerid, tf5, calcStoch(close, stochKLength, stochKSmooth, stochDSmooth), lookahead=barmerge.lookahead_off)
[stochK6, stochD6] = request.security(syminfo.tickerid, tf6, calcStoch(close, stochKLength, stochKSmooth, stochDSmooth), lookahead=barmerge.lookahead_off)

// Get stochastic values based on user preference (K or D)
stoch1 = stochUseK ? stochK1 : stochD1
stoch2 = stochUseK ? stochK2 : stochD2
stoch3 = stochUseK ? stochK3 : stochD3
stoch4 = stochUseK ? stochK4 : stochD4
stoch5 = stochUseK ? stochK5 : stochD5
stoch6 = stochUseK ? stochK6 : stochD6

// ─────────────────────────────────────────────────────────────────────────────
// TREND BIAS CALCULATION
// ─────────────────────────────────────────────────────────────────────────────

// Combined bias using average of RSI and Stochastic for each timeframe
// Use [1] to reference previous confirmed bar and prevent repainting
float combined1 = (rsi1[1] + stoch1[1]) / 2
float combined2 = (rsi2[1] + stoch2[1]) / 2
float combined3 = (rsi3[1] + stoch3[1]) / 2
float combined4 = (rsi4[1] + stoch4[1]) / 2
float combined5 = (rsi5[1] + stoch5[1]) / 2
float combined6 = (rsi6[1] + stoch6[1]) / 2

int bullCount = 0
int bearCount = 0
bullCount += combined1 > 50 ? 1 : 0
bearCount += combined1 < 50 ? 1 : 0
bullCount += combined2 > 50 ? 1 : 0
bearCount += combined2 < 50 ? 1 : 0
bullCount += combined3 > 50 ? 1 : 0
bearCount += combined3 < 50 ? 1 : 0
bullCount += combined4 > 50 ? 1 : 0
bearCount += combined4 < 50 ? 1 : 0
bullCount += combined5 > 50 ? 1 : 0
bearCount += combined5 < 50 ? 1 : 0
bullCount += combined6 > 50 ? 1 : 0
bearCount += combined6 < 50 ? 1 : 0

float bullPct = (bullCount / 6.0) * 100
float bearPct = (bearCount / 6.0) * 100
string trendBias = bullPct >= 70 ? "STRONG BULL" : bullPct >= 55 ? "BULL" : bearPct >= 70 ? "STRONG BEAR" : bearPct >= 55 ? "BEAR" : "MIXED"
color trendColor = bullPct >= 70 ? bullColor : bullPct >= 55 ? color.new(bullColor, 30) : bearPct >= 70 ? bearColor : bearPct >= 55 ? color.new(bearColor, 30) : neutralColor

// ─────────────────────────────────────────────────────────────────────────────
// POSITIONING CALCULATIONS
// ─────────────────────────────────────────────────────────────────────────────

// Use visible range for consistent sizing regardless of zoom
float visibleHigh = ta.highest(high, 50)
float visibleLow = ta.lowest(low, 50)
float visibleRange = visibleHigh - visibleLow

// Heights based on percentage of visible range (stays consistent with zoom)
float rowH = (visibleRange * boxHeightPct / 100) * overallScale
float gradH = (visibleRange * gradientHeightPct / 100) * overallScale
float outerPadH = (visibleRange * outerPadPct / 100) * overallScale
float biasPadHCalc = (visibleRange * biasPaddingPct / 100) * overallScale

// Position outer box bottom-left at current bar's high + offset (like XRayTrade)
float outerBottom = high + (visibleRange * yOffset / 100)

// Calculate total height needed: 3 rows + gradient + bias padding + bias row + 2x outer padding
float totalContentHeight = (3 * rowH) + gradH + biasPadHCalc + rowH  // 3 data rows + gradient + bias padding + bias
float outerTop = outerBottom + totalContentHeight + (2 * outerPadH)

// baseY is top of first row (inside outer padding)
float baseY = outerTop - outerPadH

int baseX = bar_index + xOffset
int colWidth = boxWidth + boxSpacing

// Stochastic range mapping: -20 to 80 (100 point range, same as RSI 0-100)
float stochRangeMin = stochOSLevel  // -20
float stochRangeMax = stochOBLevel  // 80
float stochRange = stochRangeMax - stochRangeMin  // 100

// ─────────────────────────────────────────────────────────────────────────────
// STORAGE FOR BOXES AND LABELS
// ─────────────────────────────────────────────────────────────────────────────

var box[] tfBoxes = array.new_box(6)
var label[] tfLabels = array.new_label(6)
var box[] rsiBoxes = array.new_box(6)
var label[] rsiLabels = array.new_label(6)
var box[] statusBoxes = array.new_box(6)
var label[] statusLabels = array.new_label(6)
var box[] gradientContainers = array.new_box(6)

// Gradient fill boxes - now doubled for left (stoch) and right (rsi) halves
var box[] stochGradientFills = array.new_box(0)
var box[] rsiGradientFills = array.new_box(0)

// Outer border box
var box outerBorderBox = na

// Scale labels - RSI on right, Stoch on left
var label[] rsiScaleLabels = array.new_label(5)
var label[] stochScaleLabels = array.new_label(4)

// Scale title labels
var label rsiScaleTitle = na
var label stochScaleTitle = na

var box biasBox = na
var box biasBgBox = na
var box biasBullBox = na
var box biasBearBox = na
var label biasLabel = na

// Initialize gradient fill arrays
if barstate.isfirst
    for i = 0 to 6 * gradientSegments - 1
        array.push(stochGradientFills, box(na))
        array.push(rsiGradientFills, box(na))

// ─────────────────────────────────────────────────────────────────────────────
// DRAW BOXES AND LABELS
// ─────────────────────────────────────────────────────────────────────────────

if barstate.islast
    // Delete old objects
    for i = 0 to 5
        box.delete(array.get(tfBoxes, i))
        label.delete(array.get(tfLabels, i))
        box.delete(array.get(rsiBoxes, i))
        label.delete(array.get(rsiLabels, i))
        box.delete(array.get(statusBoxes, i))
        label.delete(array.get(statusLabels, i))
        box.delete(array.get(gradientContainers, i))
    
    for i = 0 to array.size(stochGradientFills) - 1
        box.delete(array.get(stochGradientFills, i))
        box.delete(array.get(rsiGradientFills, i))
    
    for i = 0 to 4
        label.delete(array.get(rsiScaleLabels, i))
    
    for i = 0 to 3
        label.delete(array.get(stochScaleLabels, i))
    
    label.delete(rsiScaleTitle)
    label.delete(stochScaleTitle)
    
    box.delete(outerBorderBox)
    box.delete(biasBox)
    box.delete(biasBgBox)
    box.delete(biasBullBox)
    box.delete(biasBearBox)
    label.delete(biasLabel)
    
    // Data arrays
    float[] rsiArr = array.from(rsi1, rsi2, rsi3, rsi4, rsi5, rsi6)
    float[] stochArr = array.from(stoch1, stoch2, stoch3, stoch4, stoch5, stoch6)
    string[] tfArr = array.from(formatTf(tf1), formatTf(tf2), formatTf(tf3), formatTf(tf4), formatTf(tf5), formatTf(tf6))
    
    // Y positions for each row
    float y1Top = baseY
    float y1Bot = baseY - rowH
    float y2Top = y1Bot
    float y2Bot = y2Top - rowH
    float y3Top = y2Bot
    float y3Bot = y3Top - rowH
    float y4Top = y3Bot
    float y4Bot = y4Top - gradH
    
    // Add padding between gradient and bias bar
    float biasPadH = (visibleRange * biasPaddingPct / 100) * overallScale
    float y5Top = y4Bot - biasPadH
    float y5Bot = y5Top - rowH
    
    // Draw 6 columns
    for i = 0 to 5
        int xLeft = baseX + (i * colWidth)
        int xRight = xLeft + boxWidth
        int xMid = xLeft + boxWidth / 2
        
        float rsiVal = array.get(rsiArr, i)
        float stochVal = array.get(stochArr, i)
        
        // Combined values
        float combinedPct = na(rsiVal) or na(stochVal) ? na : (rsiVal + stochVal) / 2.0
        string combinedStatus = getCombinedStatus(rsiVal, stochVal)
        color combinedCol = getCombinedColor(rsiVal, stochVal)
        string combinedText = na(combinedPct) ? "-" : str.tostring(combinedPct, "0.0")
        
        // Calculate text Y positions with offset (0=center, positive=lower, negative=higher)
        float textY1 = (y1Top + y1Bot)/2 - (textVerticalOffset * rowH * 0.3)
        float textY2 = (y2Top + y2Bot)/2 - (textVerticalOffset * rowH * 0.3)
        float textY3 = (y3Top + y3Bot)/2 - (textVerticalOffset * rowH * 0.3)
        
        // Row 1: TF Label box
        array.set(tfBoxes, i, box.new(xLeft, y1Top, xRight, y1Bot, border_color=boxBorderColor, border_width=1, bgcolor=boxBgColor, xloc=xloc.bar_index))
        array.set(tfLabels, i, label.new(xLeft + boxWidth/2, textY1, array.get(tfArr, i), xloc=xloc.bar_index, yloc=yloc.price, style=label.style_none, textcolor=textColor, size=size.normal))
        
        // Row 2: Combined % Value box (average of RSI + Stoch)
        array.set(rsiBoxes, i, box.new(xLeft, y2Top, xRight, y2Bot, border_color=boxBorderColor, border_width=1, bgcolor=boxBgColor, xloc=xloc.bar_index))
        array.set(rsiLabels, i, label.new(xLeft + boxWidth/2, textY2, combinedText, xloc=xloc.bar_index, yloc=yloc.price, style=label.style_none, textcolor=combinedCol, size=size.normal))
        
        // Row 3: Combined Status box
        array.set(statusBoxes, i, box.new(xLeft, y3Top, xRight, y3Bot, border_color=boxBorderColor, border_width=1, bgcolor=color.new(combinedCol, 85), xloc=xloc.bar_index))
        array.set(statusLabels, i, label.new(xLeft + boxWidth/2, textY3, combinedStatus, xloc=xloc.bar_index, yloc=yloc.price, style=label.style_none, textcolor=combinedCol, size=size.normal))
        
        // Row 4: Gradient container box (border only)
        array.set(gradientContainers, i, box.new(xLeft, y4Top, xRight, y4Bot, border_color=boxBorderColor, border_width=1, bgcolor=boxBgColor, xloc=xloc.bar_index))
        
        // Gradient fill segments
        float segmentH = gradH / gradientSegments
        
        // RSI intensity (0-100 mapped to 0.0-1.0)
        float rsiIntensity = na(rsiVal) ? 0.0 : rsiVal / 100.0
        
        // Stochastic intensity mapped to -20 to 80 scale
        float stochMapped = na(stochVal) ? 0.0 : (stochVal - float(stochOSLevel)) / (float(stochOBLevel) - float(stochOSLevel))
        float stochIntensity = math.max(0.0, math.min(1.0, stochMapped))  // Clamp to 0-1
        
        for j = 0 to gradientSegments - 1
            float segBot = y4Bot + (j * segmentH)
            float segTop = math.min(segBot + segmentH, y4Top)  // Clamp to not exceed container top
            
            // Skip if segment is outside container bounds
            if segBot >= y4Top
                continue
                
            float segPos = (float(j) + 0.5) / float(gradientSegments)
            float segThreshold = float(j) / float(gradientSegments)
            
            int stochIdx = i * gradientSegments + j
            int rsiIdx = i * gradientSegments + j
            
            // LEFT HALF: Stochastic fill - only draw if filled
            bool stochFilled = stochIntensity >= segThreshold
            if stochFilled
                array.set(stochGradientFills, stochIdx, box.new(xLeft + 1, segTop, xMid, segBot, border_color=color(na), border_width=0, bgcolor=getGradientColor(segPos), xloc=xloc.bar_index))
            
            // RIGHT HALF: RSI fill - only draw if filled
            bool rsiFilled = rsiIntensity >= segThreshold
            if rsiFilled
                array.set(rsiGradientFills, rsiIdx, box.new(xMid, segTop, xRight - 1, segBot, border_color=color(na), border_width=0, bgcolor=getGradientColor(segPos), xloc=xloc.bar_index))
    
    // RSI Scale labels (right side) - padding from right edge of last gradient box
    // Last box right edge is at: baseX + 5*colWidth + boxWidth
    int lastBoxRight = baseX + 5 * colWidth + boxWidth
    int rsiScaleX = lastBoxRight + 2
    array.set(rsiScaleLabels, 0, label.new(rsiScaleX, y4Top, "100", xloc=xloc.bar_index, yloc=yloc.price, style=label.style_none, textcolor=obColor, size=size.small, textalign=text.align_left))
    array.set(rsiScaleLabels, 1, label.new(rsiScaleX, y4Bot + (gradH * 0.7), "70", xloc=xloc.bar_index, yloc=yloc.price, style=label.style_none, textcolor=obColor, size=size.small, textalign=text.align_left))
    array.set(rsiScaleLabels, 2, label.new(rsiScaleX, y4Bot + (gradH * 0.5), "50", xloc=xloc.bar_index, yloc=yloc.price, style=label.style_none, textcolor=neutralColor, size=size.small, textalign=text.align_left))
    array.set(rsiScaleLabels, 3, label.new(rsiScaleX, y4Bot + (gradH * 0.3), "30", xloc=xloc.bar_index, yloc=yloc.price, style=label.style_none, textcolor=osColor, size=size.small, textalign=text.align_left))
    array.set(rsiScaleLabels, 4, label.new(rsiScaleX, y4Bot, "0", xloc=xloc.bar_index, yloc=yloc.price, style=label.style_none, textcolor=osColor, size=size.small, textalign=text.align_left))
    
    // Stochastic Scale labels (left side) - padding from left edge of first gradient box
    // First box left edge is at: baseX
    int stochScaleX = baseX - 2
    float stoch80Pos = (float(stochOBLevel) - stochRangeMin) / stochRange  // 80 -> 1.0
    float stoch50Pos = (float(stochMidLevel) - stochRangeMin) / stochRange  // 50 -> 0.7
    float stoch0Pos = (float(stochZeroLevel) - stochRangeMin) / stochRange   // 0 -> 0.2
    float stochNeg20Pos = 0.0  // -20 -> 0.0
    
    array.set(stochScaleLabels, 0, label.new(stochScaleX, y4Bot + (gradH * stoch80Pos), str.tostring(stochOBLevel), xloc=xloc.bar_index, yloc=yloc.price, style=label.style_none, textcolor=obColor, size=size.small, textalign=text.align_right))
    array.set(stochScaleLabels, 1, label.new(stochScaleX, y4Bot + (gradH * stoch50Pos), str.tostring(stochMidLevel), xloc=xloc.bar_index, yloc=yloc.price, style=label.style_none, textcolor=neutralColor, size=size.small, textalign=text.align_right))
    array.set(stochScaleLabels, 2, label.new(stochScaleX, y4Bot + (gradH * stoch0Pos), str.tostring(stochZeroLevel), xloc=xloc.bar_index, yloc=yloc.price, style=label.style_none, textcolor=osColor, size=size.small, textalign=text.align_right))
    array.set(stochScaleLabels, 3, label.new(stochScaleX, y4Bot, str.tostring(stochOSLevel), xloc=xloc.bar_index, yloc=yloc.price, style=label.style_none, textcolor=osColor, size=size.small, textalign=text.align_right))
    
    // Scale title labels - positioned above the scales (same X as scale numbers)
    rsiScaleTitle := label.new(rsiScaleX, y4Top + rowH * 0.5, "RSI", xloc=xloc.bar_index, yloc=yloc.price, style=label.style_none, textcolor=scaleTitleColor, size=size.small, textalign=text.align_right)
    stochScaleTitle := label.new(stochScaleX - 2, y4Top + rowH * 0.5, "STOCH", xloc=xloc.bar_index, yloc=yloc.price, style=label.style_none, textcolor=scaleTitleColor, size=size.small, textalign=text.align_right)
    
    // Bias bar (spans all columns) - horizontal gradient
    int biasLeft = baseX
    int biasRight = baseX + (6 * colWidth) - boxSpacing
    int biasWidth = biasRight - biasLeft
    
    // Draw solid background first
    biasBgBox := box.new(biasLeft, y5Top, biasRight, y5Bot, border_color=color(na), border_width=0, bgcolor=boxBgColor, xloc=xloc.bar_index)
    
    // Calculate bull fill width based on percentage
    int bullFillWidth = math.round((bullPct / 100.0) * biasWidth)
    int bullFillRight = biasLeft + bullFillWidth
    
    // Draw bull (green) portion on left
    if bullFillWidth > 0
        biasBullBox := box.new(biasLeft, y5Top, bullFillRight, y5Bot, border_color=color(na), border_width=0, bgcolor=color.new(bullColor, 50), xloc=xloc.bar_index)
    
    // Draw bear (red) portion on right
    if bullFillRight < biasRight
        biasBearBox := box.new(bullFillRight, y5Top, biasRight, y5Bot, border_color=color(na), border_width=0, bgcolor=color.new(bearColor, 50), xloc=xloc.bar_index)
    
    // Draw border on top
    biasBox := box.new(biasLeft, y5Top, biasRight, y5Bot, border_color=boxBorderColor, border_width=1, bgcolor=color(na), xloc=xloc.bar_index)
    
    // Label with text
    float biasTextY = (y5Top + y5Bot)/2 - (textVerticalOffset * rowH * 0.3)
    biasLabel := label.new((biasLeft + biasRight)/2, biasTextY, trendBias + " " + str.tostring(bullPct, "#") + "%", xloc=xloc.bar_index, yloc=yloc.price, style=label.style_none, textcolor=textColor, size=size.normal)
    
    // Outer border box - encompasses all components with equal padding
    int outerLeft = stochScaleX - outerPadding - 3  // Extra space for STOCH text
    int outerRight = rsiScaleX + outerPadding + 2   // Extra space for RSI text
    float outerTopY = y1Top + outerPadH
    float outerBottomY = y5Bot - outerPadH
    outerBorderBox := box.new(outerLeft, outerTopY, outerRight, outerBottomY, border_color=outerBorderColor, border_width=2, bgcolor=color(na), xloc=xloc.bar_index)

// ─────────────────────────────────────────────────────────────────────────────
// ALERTS
// ─────────────────────────────────────────────────────────────────────────────

alertcondition(bullPct == 100, title="All Timeframes Bullish", message="MTF RSI: All 6 timeframes bullish")
alertcondition(bearPct == 100, title="All Timeframes Bearish", message="MTF RSI: All 6 timeframes bearish")
alertcondition(bullPct >= 80, title="Strong Bullish Alignment", message="MTF RSI: 80%+ bullish")
alertcondition(bearPct >= 80, title="Strong Bearish Alignment", message="MTF RSI: 80%+ bearish")
