//@version=5
indicator("Maor Beniash | Pro Dashboard", shorttitle = 'MB-PRO', overlay = true)

// --- הגדרות עיצוב ומיקום ---
grp_loc     = "הגדרות מיקום"
grp_style   = "הגדרות עיצוב"
grp_data    = "בחירת נתונים להצגה"

pos_v       = input.string("Top", "מיקום אנכי", options = ["Top", "Middle", "Bottom"], inline = 'p', group = grp_loc)
pos_h       = input.string("Left", "מיקום אופקי", options = ["Left", "Center", "Right"], inline = 'p', group = grp_loc)
num_spaces  = input.int(2, "מספר שורות רווח בהתחלה", minval=0, maxval=3, group = grp_loc)

c_text      = input.color(color.white, 'צבע טקסט', group = grp_style)
s_text      = input.string('רגיל', 'גודל פונט', options = ['ענק', 'גדול', 'רגיל', 'קטן'], group = grp_style)

// --- בחירת נתונים ---
show_name   = input.bool(true, 'שם חברה ושווי שוק', group = grp_data)
show_sym    = input.bool(true, 'סימבול וזמן', group = grp_data)
show_sec    = input.bool(true, 'סקטור ותעשייה', group = grp_data)
show_atr    = input.bool(true, 'ATR (14)', group = grp_data)
show_earn   = input.bool(true, 'תאריך דוחות קרוב', group = grp_data)
// שינוי: הבהרה שזה משנה צבע לכתום
warn_days   = input.int(21, "צבע באזהרה כתומה (ימים לפני דוח)", minval=1, group = grp_data)

// --- לוגיקה וחישובים ---

// המרת גודל פונט
f_getSize(sz) =>
    switch sz
        'ענק'   => size.huge
        'גדול'  => size.large
        'רגיל'  => size.normal
        'קטן'   => size.small
        => size.normal

txt_size = f_getSize(s_text)

// פירמוט מספרים גדולים (Market Cap)
f_formatCap(val) =>
    if val >= 1000000000000
        str.tostring(math.round(val / 1000000000000, 2)) + "T"
    else if val >= 1000000000
        str.tostring(math.round(val / 1000000000, 2)) + "B"
    else 
        str.tostring(math.round(val / 1000000, 2)) + "M"

// נתונים כלליים
float shares    = syminfo.shares_outstanding_total
float mkt_cap   = shares * close 
string cap_str  = f_formatCap(mkt_cap)
string d_sect   = syminfo.sector
string d_ind    = syminfo.industry
string d_tick   = syminfo.ticker
string d_desc   = syminfo.description

// זמן
string d_tf = timeframe.period == 'D' ? '1D' : timeframe.period == 'W' ? '1W' : timeframe.period == '60' ? '1H' : 
              timeframe.period == '120' ? '2H' : timeframe.period == '180' ? '3H' : timeframe.period == '240' ? '4H' : timeframe.period

// חישוב ATR
float atr_val = ta.atr(14)
float atr_pct = (atr_val / close) * 100 

// חישוב דוחות (Earnings)
int e_time = earnings.future_time
string e_str = ""
color e_col = c_text

if not na(e_time)
    string date_fmt = str.format("{0,date,d MMM}", e_time)
    int t_now = timestamp(year(timenow), month(timenow), dayofmonth(timenow), 0, 0)
    int t_earn = timestamp(year(e_time), month(e_time), dayofmonth(e_time), 0, 0)
    float diff = (t_earn - t_now) / 86400000 
    int days_left = math.max(int(math.round(diff)), 0)
    
    if days_left <= warn_days
        e_col := color.orange
        
    e_str := date_fmt + " (" + str.tostring(days_left) + " days)"

// --- בניית הלוח (Dashboard) ---
string p_str = str.lower(pos_v) + '_' + str.lower(pos_h)
var table dashboard = table.new(p_str, 1, 20, border_width=0)

// פונקציה פנימית להוספת שורה
f_addRow(tbl, r_idx, txt, t_col, t_sz) =>
    table.cell(tbl, 0, r_idx, txt, text_color=t_col, text_size=t_sz, text_halign=text.align_left, bgcolor=color.new(color.black, 100))

if barstate.islast
    int r = 0
    
    // לולאה להוספת שורות רווח
    if num_spaces > 0
        for i = 1 to num_spaces
            f_addRow(dashboard, r, " ", c_text, txt_size)
            r := r + 1

    // שם חברה
    if show_name
        string n_txt = d_desc
        if not na(mkt_cap)
            n_txt := n_txt + " (" + cap_str + ")"
        f_addRow(dashboard, r, n_txt, c_text, txt_size)
        r := r + 1
    
    // סימבול
    if show_sym
        f_addRow(dashboard, r, d_tick + " [" + d_tf + "]", c_text, txt_size)
        r := r + 1

    // סקטור
    if show_sec
        string s_txt = not na(d_sect) ? d_sect + " / " + d_ind : ""
        if s_txt != ""
            f_addRow(dashboard, r, s_txt, c_text, txt_size)
            r := r + 1
    
    // ATR
    if show_atr
        string a_txt = "ATR (14): " + str.tostring(atr_val, "#.####") + " (" + str.tostring(atr_pct, "#.##") + "%)"
        f_addRow(dashboard, r, a_txt, c_text, txt_size)
        r := r + 1
    
    // דוחות
    if show_earn and e_str != ""
        f_addRow(dashboard, r, "Earnings: " + e_str, e_col, txt_size)
        r := r + 1
