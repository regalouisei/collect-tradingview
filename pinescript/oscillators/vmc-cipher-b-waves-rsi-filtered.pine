//@version=6
indicator(title = 'VMC Cipher_B + Waves- RSI Filtered', shorttitle = 'VMC with Rsi', overlay = false)

// ==========================================
// --- ORIJINAL WAVE TREND SETTINGS ---
// ==========================================
wtShow = input.bool(true, title = 'Show WaveTrend', group = 'WaveTrend Settings')
wtBuyShow = input.bool(true, title = 'Show Buy dots', group = 'WaveTrend Settings')
wtGoldShow = input.bool(true, title = 'Show Gold dots', group = 'WaveTrend Settings')
wtSellShow = input.bool(true, title = 'Show Sell dots', group = 'WaveTrend Settings')
wtDivShow = input.bool(true, title = 'Show Div. dots', group = 'WaveTrend Settings')
vwapShow = input.bool(true, title = 'Show Fast WT', group = 'WaveTrend Settings')

// Overkill Default Ayarları (10-21)
wtChannelLen = input.int(10, title = 'WT Channel Length', group = 'WaveTrend Settings')
wtAverageLen = input.int(21, title = 'WT Average Length', group = 'WaveTrend Settings')
wtMASource = input.source(hlc3, title = 'WT MA Source', group = 'WaveTrend Settings')
wtMALen = input.int(3, title = 'WT MA Length', group = 'WaveTrend Settings')

obLevel = input.int(60, title = 'WT Overbought Level 1', group = 'WaveTrend Settings')
obLevel2 = input.int(53, title = 'WT Overbought Level 2', group = 'WaveTrend Settings')
obLevel3 = input.int(100, title = 'WT Overbought Level 3', group = 'WaveTrend Settings')
osLevel = input.int(-60, title = 'WT Oversold Level 1', group = 'WaveTrend Settings')
osLevel2 = input.int(-53, title = 'WT Oversold Level 2', group = 'WaveTrend Settings')
osLevel3 = input.int(-75, title = 'WT Oversold Level 3', group = 'WaveTrend Settings')

wtShowDiv = input.bool(true, title = 'Show WT Regular Divergences', group = 'WaveTrend Settings')
wtShowHiddenDiv = input.bool(false, title = 'Show WT Hidden Divergences', group = 'WaveTrend Settings')
showHiddenDiv_nl = input.bool(true, title = 'Not apply OB/OS Limits on Hidden Divergences', group = 'WaveTrend Settings')
wtDivOBLevel = input.int(45, title = 'WT Bearish Divergence min', group = 'WaveTrend Settings')
wtDivOSLevel = input.int(-65, title = 'WT Bullish Divergence min', group = 'WaveTrend Settings')
wtDivOBLevel_addshow = input.bool(true, title = 'Show 2nd WT Regular Divergences', group = 'WaveTrend Settings')
wtDivOBLevel_add = input.int(15, title = 'WT 2nd Bearish Divergence', group = 'WaveTrend Settings')
wtDivOSLevel_add = input.int(-40, title = 'WT 2nd Bullish Divergence 15 min', group = 'WaveTrend Settings')

// ==========================================
// --- YENİ: DIVERGENCE RSI FİLTRE AYARLARI ---
// ==========================================
useRsiFilter = input.bool(true, title = "Uyumsuzluk Noktaları İçin RSI Filtresini Aktif Et", group = "RSI Filter Settings")
rsiSellFilter = input.int(60, title = "Kırmızı Nokta İçin RSI Üst Sınırı (>?)", group = "RSI Filter Settings")
rsiBuyFilter = input.int(40, title = "Yeşil Nokta İçin RSI Alt Sınırı (<?)", group = "RSI Filter Settings")

// ==========================================
// --- ORIJINAL MFI/RSI/STOCH SETTINGS ---
// ==========================================
rsiMFIShow = input.bool(true, title = 'Show MFI', group = 'MFI Settings')
rsiMFIperiod = input.int(60, title = 'MFI Period', group = 'MFI Settings')
rsiMFIMultiplier = input.float(150, title = 'MFI Area multiplier', group = 'MFI Settings')
rsiMFIPosY = input.float(2.5, title = 'MFI Area Y Pos', group = 'MFI Settings')

rsiShow = input.bool(true, title = 'Show RSI', group = 'RSI Settings')
rsiSRC = input.source(close, title = 'RSI Source', group = 'RSI Settings')
rsiLen = input.int(14, title = 'RSI Length', group = 'RSI Settings')
rsiOversold = input.int(30, title = 'RSI Oversold', minval = 0, maxval = 50, group = 'RSI Settings')
rsiOverbought = input.int(60, title = 'RSI Overbought', minval = 50, maxval = 100, group = 'RSI Settings')

stochShow = input.bool(true, title = 'Show Stochastic RSI', group = 'Stoch Settings')
stochUseLog = input.bool(true, title = ' Use Log?', group = 'Stoch Settings')
stochAvg = input.bool(false, title = 'Use Average of both K & D', group = 'Stoch Settings')
stochSRC = input.source(close, title = 'Stochastic RSI Source', group = 'Stoch Settings')
stochLen = input.int(14, title = 'Stochastic RSI Length', group = 'Stoch Settings')
stochRsiLen = input.int(14, title = 'RSI Length ', group = 'Stoch Settings')
stochKSmooth = input.int(3, title = 'Stochastic RSI K Smooth', group = 'Stoch Settings')
stochDSmooth = input.int(3, title = 'Stochastic RSI D Smooth', group = 'Stoch Settings')

// ==========================================
// --- EKSTRA: SQUEEZE & TDI SETTINGS ---
// ==========================================
sqzShow = input.bool(true, title = 'Show Squeeze Dots (0 Line)', group = 'Overkill Extra')
sqzOnColor  = input.color(color.black, title = "Squeeze On Color (Sıkışma)", group = "Overkill Extra")
sqzOffColor = input.color(color.gray, title = "Squeeze Off Color (Normal)", group = "Overkill Extra")
tdiShow = input.bool(true, title = 'Show TDI Lines (G/R)', group = 'Overkill Extra')

darkMode = input.bool(false, title = 'Dark mode', group = 'Mode Settings')

// Colors
colorRed = #ff0000
colorGreen = #3fff00
colorOrange = #e2a400
colorWhite = #ffffff

// Color Settings
rsiobcolor = input.color(color.new(#e13e3e, 0), 'RSI OverBought', group = 'Color Settings')
rsioscolor = input.color(color.new(#3ee145, 0), 'RSI OverSold', group = 'Color Settings')
rsinacolor = input.color(color.new(#c33ee1, 0), 'RSI InBetween', group = 'Color Settings')
rsiMFIColorAbove = input.color(color.new(#3ee145, 0), 'MFI Color > 0', group = 'Color Settings')
rsiMFIColorBelow = input.color(color.new(#ff3d2e, 0), 'MFI Color < 0', group = 'Color Settings')
WTBearDivColor = input.color(color.new(#e60000, 0), 'WT Bear Div', group = 'Color Settings')
wtBullDivColor = input.color(color.new(#00e676, 0), 'WT Bull Div', group = 'Color Settings')
signalcolorup = input.color(color.new(#00e676, 0), 'WT Buy Dot', group = 'Color Settings')
signalcolordown = input.color(color.new(#ff5252, 0), 'WT Sell Dot', group = 'Color Settings')
colorWT1blue = input.color(color.new(#4994ec, 0), "WT1 Fill", group = 'Color Settings')
colorWT2purple = input.color(color.new(#1f1559, 0), 'WT2 Fill', group = 'Color Settings')
VWAPColor = input.color(color.new(#ffffff, 50), "VWAP", group = 'Color Settings')
stochkcolor = input.color(color.new(#21baf3, 70), "Stoch K", group = 'Color Settings')
stochdcolor = input.color(color.new(#673ab7, 90), "Stoch D", group = 'Color Settings')

// --- FUNCTIONS (ORIJINAL) ---
f_top_fractal(src) => src[4] < src[2] and src[3] < src[2] and src[2] > src[1] and src[2] > src[0]
f_bot_fractal(src) => src[4] > src[2] and src[3] > src[2] and src[2] < src[1] and src[2] < src[0]
f_fractalize(src) => f_top_fractal(src) ? 1 : f_bot_fractal(src) ? -1 : 0

f_findDivs(src, topLimit, botLimit, useLimits) =>
    isTop = f_fractalize(src) > 0 and (useLimits ? src[2] >= topLimit : true)
    isBot = f_fractalize(src) < 0 and (useLimits ? src[2] <= botLimit : true)
    highPrev = ta.valuewhen(isTop, src[2], 0)[2]
    highPrice = ta.valuewhen(isTop, high[2], 0)[2]
    lowPrev = ta.valuewhen(isBot, src[2], 0)[2]
    lowPrice = ta.valuewhen(isBot, low[2], 0)[2]
    bearSignal = isTop and high[2] > highPrice and src[2] < highPrev
    bullSignal = isBot and low[2] < lowPrice and src[2] > lowPrev
    bearDivHidden = isTop and high[2] < highPrice and src[2] > highPrev
    bullDivHidden = isBot and low[2] > lowPrice and src[2] < lowPrev
    [isTop, isBot, lowPrev, bearSignal, bullSignal, bearDivHidden, bullDivHidden]

f_rsimfi(_period, _multiplier, _tf) => request.security(syminfo.tickerid, _tf, ta.sma(((close - open) / (high - low)) * _multiplier, _period) - rsiMFIPosY)

f_wavetrend(src, chlen, avg, malen, tf) =>
    tfsrc = request.security(syminfo.tickerid, tf, src)
    esa = ta.ema(tfsrc, chlen)
    de = ta.ema(math.abs(tfsrc - esa), chlen)
    ci = (tfsrc - esa) / (0.015 * de)
    wt1 = request.security(syminfo.tickerid, tf, ta.ema(ci, avg))
    wt2 = request.security(syminfo.tickerid, tf, ta.sma(wt1, malen))
    wtVwap = wt1 - wt2
    wtOversold = wt2 <= osLevel
    wtOverbought = wt2 >= obLevel
    wtCross = ta.cross(wt1, wt2)
    wtCrossUp = wt2 - wt1 <= 0
    wtCrossDown = wt2 - wt1 >= 0
    [wt1, wt2, wtOversold, wtOverbought, wtCross, wtCrossUp, wtCrossDown, wtVwap]

f_stochrsi(_src, _stochlen, _rsilen, _smoothk, _smoothd, _log, _avg) =>
    src = _log ? math.log(_src) : _src
    rsi = ta.rsi(src, _rsilen)
    kk = ta.sma(ta.stoch(rsi, rsi, rsi, _stochlen), _smoothk)
    d1 = ta.sma(kk, _smoothd)
    avg_1 = math.avg(kk, d1)
    k = _avg ? avg_1 : kk
    [k, d1]

// --- CALCULATE (ORIJINAL) ---
rsi = ta.rsi(rsiSRC, rsiLen)
rsiColor = rsi <= rsiOversold ? rsioscolor : rsi >= rsiOverbought ? rsiobcolor : rsinacolor
rsiMFI = f_rsimfi(rsiMFIperiod, rsiMFIMultiplier, timeframe.period)
rsiMFIColor = rsiMFI > 0 ? rsiMFIColorAbove : rsiMFIColorBelow

[wt1, wt2, wtOversold, wtOverbought, wtCross, wtCrossUp, wtCrossDown, wtVwap] = f_wavetrend(wtMASource, wtChannelLen, wtAverageLen, wtMALen, timeframe.period)
[stochK, stochD] = f_stochrsi(stochSRC, stochLen, stochRsiLen, stochKSmooth, stochDSmooth, stochUseLog, stochAvg)

[wtIsTop, wtIsBot, wtLow_prev, wtBearDiv, wtBullDiv, wtBearDivHidden, wtBullDivHidden] = f_findDivs(wt2, wtDivOBLevel, wtDivOSLevel, true)
[wtIsTop_add, wtIsBot_add, wtLow_prev_add, wtBearDiv_add, wtBullDiv_add, wtBearDivHidden_add, wtBullDivHidden_add] = f_findDivs(wt2, wtDivOBLevel_add, wtDivOSLevel_add, true)

wtBearDivHidden_ = showHiddenDiv_nl ? wtBearDivHidden : wtBearDivHidden
wtBullDivHidden_ = showHiddenDiv_nl ? wtBullDivHidden : wtBullDivHidden

wtBearDivColorPlot = (wtShowDiv and wtBearDiv) or (wtShowHiddenDiv and wtBearDivHidden_) ? WTBearDivColor : na
wtBullDivColorPlot = (wtShowDiv and wtBullDiv) or (wtShowHiddenDiv and wtBullDivHidden_) ? wtBullDivColor : na
wtBearDivColor_add = (wtShowDiv and wtDivOBLevel_addshow and wtBearDiv_add) ? WTBearDivColor : na
wtBullDivColor_add = (wtShowDiv and wtDivOBLevel_addshow and wtBullDiv_add) ? wtBullDivColor : na

signalColor = wt2 - wt1 > 0 ? signalcolordown : signalcolorup
buySignal = wtCross and wtCrossUp and wtOversold
sellSignal = wtCross and wtCrossDown and wtOverbought

// --- FILTRELENMIŞ UYUMSUZLUK SİNYALLERİ ---
buySignalDiv = (wtShowDiv and wtBullDiv and (useRsiFilter ? rsi < rsiBuyFilter : true)) or (wtShowDiv and wtBullDiv_add and (useRsiFilter ? rsi < rsiBuyFilter : true))
sellSignalDiv = (wtShowDiv and wtBearDiv and (useRsiFilter ? rsi > rsiSellFilter : true)) or (wtShowDiv and wtBearDiv_add and (useRsiFilter ? rsi > rsiSellFilter : true))

buySignalDiv_color = wtBullDiv ? colorGreen : (wtBullDiv_add ? color.new(colorGreen, 60) : colorGreen)
sellSignalDiv_color = wtBearDiv ? colorRed : (wtBearDiv_add ? color.new(colorRed, 60) : colorRed)

lastRsi = ta.valuewhen(wtIsBot, rsi[2], 0)[2]
wtGoldBuy = wtShowDiv and wtBullDiv and wtLow_prev <= osLevel3 and wt2 > osLevel3 and wtLow_prev - wt2 <= -5 and lastRsi < 30

// --- YENI HESAPLAMALAR: SQUEEZE & TDI ---
[kBasis, kUp, kLow] = ta.kc(close, 20, 1.5)
bbB = ta.sma(close, 20), bbD = 2.0 * ta.stdev(close, 20)
sqzOn = (bbB - bbD > kLow) and (bbB + bbD < kUp)
tdiG = ta.sma(ta.rsi(close, 13), 2) - 50
tdiR = ta.sma(ta.rsi(close, 13), 7) - 50

// --- DRAW (HICBIR SEY SILINMEDI) ---
zLine = plot(0, color = color.new(colorWhite, 50), display = display.pane)

// Squeeze & TDI (Seçilebilir Renkli)
plot(sqzShow ? 0 : na, title = 'Squeeze Dots', color = sqzOn ? sqzOnColor : sqzOffColor, style = plot.style_circles, linewidth = 2)
plot(tdiShow ? tdiG : na, title = 'TDI G', color = color.green, linewidth = 2)
plot(tdiShow ? tdiR : na, title = 'TDI R', color = color.red, linewidth = 2)

rsiMfiBarTopLine = plot(rsiMFIShow ? -95 : na, title = 'MFI Bar TOP', display = display.none)
rsiMfiBarBottomLine = plot(rsiMFIShow ? -99 : na, title = 'MFI Bar BOTTOM', display = display.none)
fill(rsiMfiBarTopLine, rsiMfiBarBottomLine, title = 'MFI Bar', color = color.new(rsiMFIColor, 75))

plot(wtShow ? wt1 : na, style = plot.style_area, title = 'WT Wave 1', color = color.new(colorWT1blue, 30))
plot(wtShow ? wt2 : na, style = plot.style_area, title = 'WT Wave 2', color = color.new(colorWT2purple, 25))
plot(vwapShow ? wtVwap : na, title = 'VWAP', color = VWAPColor, style = plot.style_line, linewidth = 2)
plot(rsiMFIShow ? rsiMFI : na, style = plot.style_area, title = 'rsiMFI', color = color.new(rsiMFIColor, 50))

plot(series = wtIsTop ? wt2[2] : na, title = 'WT Bearish Div', color = wtBearDivColorPlot, linewidth = 2, offset = -2)
plot(series = wtIsBot ? wt2[2] : na, title = 'WT Bullish Div', color = wtBullDivColorPlot, linewidth = 2, offset = -2)
plot(series = wtIsTop_add ? wt2[2] : na, title = 'WT 2nd Bear Div', color = wtBearDivColor_add, linewidth = 2, offset = -2)
plot(series = wtIsBot_add ? wt2[2] : na, title = 'WT 2nd Bull Div', color = wtBullDivColor_add, linewidth = 2, offset = -2)

plot(rsiShow ? rsi : na, title = 'RSI', color = color.new(rsiColor, 25), linewidth = 2)

stochKplot = plot(stochShow ? stochK : na, title = 'Stoch K', color = stochkcolor, linewidth = 2)
stochDplot = plot(stochShow ? stochD : na, title = 'Stoch D', color = stochdcolor, linewidth = 1)
fill(stochKplot, stochDplot, title = 'KD Fill', color = stochK >= stochD ? color.new(#21baf3, 95) : color.new(#673ab7, 90))

plot(obLevel2, title = 'OB Level 2', color = color.new(#fd4545, 85), linewidth = 1, style = plot.style_stepline)
plot(obLevel3, title = 'OB Level 3', color = color.new(#ec4e4e, 95), linewidth = 1, style = plot.style_circles)
plot(osLevel2, title = 'OS Level 2', color = color.new(#3ee145, 85), linewidth = 1, style = plot.style_stepline)

plot(wtCross ? wt2 : na, title = 'WT Cross', color = color.new(signalColor, 15), style = plot.style_circles, linewidth = 3)

plotchar(wtBuyShow and buySignal ? -107 : na, title = 'Buy', char = '·', color = color.new(colorGreen, 50), location = location.absolute, size = size.small)
plotchar(wtSellShow and sellSignal ? 105 : na, title = 'Sell', char = '·', color = color.new(colorRed, 50), location = location.absolute, size = size.small)
plotchar(wtDivShow and buySignalDiv ? -106 : na, title = 'Div Buy', char = '•', color = color.new(buySignalDiv_color, 15), location = location.absolute, size = size.normal, offset = -2)
plotchar(wtDivShow and sellSignalDiv ? 106 : na, title = 'Div Sell', char = '•', color = color.new(sellSignalDiv_color, 15), location = location.absolute, size = size.normal, offset = -2)
plotchar(wtGoldBuy and wtGoldShow ? -106 : na, title = 'Gold Buy', char = '•', color = color.new(colorOrange, 15), location = location.absolute, size = size.huge, offset = -2)

// --- PANEL (ORIJINAL) ---
var table wavePanel = table.new(position.top_left, 2, 5, color.new(#000000, 70), color.new(#363636, 0), 1, color.new(#363636, 0), 1)
if barstate.islast
    momDir = wtVwap > 0 ? "▲ UP" : "▼ DOWN"
    table.cell(wavePanel, 0, 0, "MOMENTUM", 0, 0, color.white, text_size = size.normal)
    table.cell(wavePanel, 1, 0, momDir, 0, 0, wtVwap > 0 ? color.green : color.red, text_size = size.normal)
