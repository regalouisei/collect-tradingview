//@version=5
indicator("ATRP Multi-Timeframe & Multi-Symbol", overlay=false, precision=2)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

grp_main = "âš™ï¸ ConfiguraciÃ³n Principal"
atrLength = input.int(14, "PerÃ­odo ATR", minval=1, group=grp_main)
maType = input.string("RMA (Wilder)", "Tipo de Media", options=["RMA (Wilder)", "SMA", "EMA"], group=grp_main)

grp_mtf = "ðŸ• Multi-Timeframe"
useCustomTF = input.bool(false, "Usar Timeframe Personalizado", group=grp_mtf)
customTF = input.timeframe("30", "Timeframe", group=grp_mtf)

grp_filter = "ðŸŽ¯ Filtros de Volatilidad"
showHighFilter = input.bool(true, "Mostrar Umbral Alto", group=grp_filter)
highThreshold = input.float(3.0, "Umbral Alto (%)", minval=0.1, step=0.1, group=grp_filter)
showLowFilter = input.bool(true, "Mostrar Umbral Bajo", group=grp_filter)
lowThreshold = input.float(1.0, "Umbral Bajo (%)", minval=0.1, step=0.1, group=grp_filter)

grp_colors = "ðŸŽ¨ Colores"
colorNormal = input.color(color.new(color.blue, 0), "ATRP Normal", group=grp_colors)
colorHigh = input.color(color.new(color.red, 0), "ATRP Alto", group=grp_colors)
colorLow = input.color(color.new(color.green, 0), "ATRP Bajo", group=grp_colors)
colorHighLine = input.color(color.new(color.red, 50), "LÃ­nea Umbral Alto", group=grp_colors)
colorLowLine = input.color(color.new(color.green, 50), "LÃ­nea Umbral Bajo", group=grp_colors)

grp_symbols = "ðŸ“Š ComparaciÃ³n Multi-Activo"
showSymbol2 = input.bool(false, "Mostrar SÃ­mbolo 2", group=grp_symbols)
symbol2 = input.symbol("BTCUSDT", "SÃ­mbolo 2", group=grp_symbols)
colorSymbol2 = input.color(color.new(color.orange, 0), "Color SÃ­mbolo 2", group=grp_symbols)

showSymbol3 = input.bool(false, "Mostrar SÃ­mbolo 3", group=grp_symbols)
symbol3 = input.symbol("ETHUSDT", "SÃ­mbolo 3", group=grp_symbols)
colorSymbol3 = input.color(color.new(color.purple, 0), "Color SÃ­mbolo 3", group=grp_symbols)

showSymbol4 = input.bool(false, "Mostrar SÃ­mbolo 4", group=grp_symbols)
symbol4 = input.symbol("SOLUSDT", "SÃ­mbolo 4", group=grp_symbols)
colorSymbol4 = input.color(color.new(color.teal, 0), "Color SÃ­mbolo 4", group=grp_symbols)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUNCIONES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

calcATR(length, matype) =>
    trueRange = ta.tr(true)
    switch matype
        "RMA (Wilder)" => ta.rma(trueRange, length)
        "SMA" => ta.sma(trueRange, length)
        "EMA" => ta.ema(trueRange, length)

calcATRP(length, matype) =>
    atrValue = calcATR(length, matype)
    atrp = (atrValue / close) * 100
    atrp

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CÃLCULOS PRINCIPALES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

atrpCurrent = calcATRP(atrLength, maType)

tf = useCustomTF ? customTF : timeframe.period
atrpMTF = request.security(syminfo.tickerid, tf, calcATRP(atrLength, maType), barmerge.gaps_off, barmerge.lookahead_off)

atrpFinal = useCustomTF ? atrpMTF : atrpCurrent

atrpSym2 = showSymbol2 ? request.security(symbol2, tf, calcATRP(atrLength, maType), barmerge.gaps_off, barmerge.lookahead_off) : na
atrpSym3 = showSymbol3 ? request.security(symbol3, tf, calcATRP(atrLength, maType), barmerge.gaps_off, barmerge.lookahead_off) : na
atrpSym4 = showSymbol4 ? request.security(symbol4, tf, calcATRP(atrLength, maType), barmerge.gaps_off, barmerge.lookahead_off) : na

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COLORES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

getColor(value, high_thresh, low_thresh) =>
    value >= high_thresh ? colorHigh : value <= low_thresh ? colorLow : colorNormal

atrpColor = getColor(atrpFinal, highThreshold, lowThreshold)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLOTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

plot(atrpFinal, "ATRP", color=atrpColor, linewidth=2)

plot(showHighFilter ? highThreshold : na, "Umbral Alto", color=colorHighLine, style=plot.style_line, linewidth=1)
plot(showLowFilter ? lowThreshold : na, "Umbral Bajo", color=colorLowLine, style=plot.style_line, linewidth=1)

plot(atrpSym2, "ATRP Sym2", color=colorSymbol2, linewidth=1)
plot(atrpSym3, "ATRP Sym3", color=colorSymbol3, linewidth=1)
plot(atrpSym4, "ATRP Sym4", color=colorSymbol4, linewidth=1)

highLine = plot(showHighFilter ? highThreshold : na, display=display.none)
lowLine = plot(showLowFilter ? lowThreshold : na, display=display.none)
fill(highLine, lowLine, color=color.new(color.gray, 90), title="Zona Neutral")

bgcolor(atrpFinal >= highThreshold ? color.new(colorHigh, 90) : na, title="BG Alta Volatilidad")
bgcolor(atrpFinal <= lowThreshold ? color.new(colorLow, 90) : na, title="BG Baja Volatilidad")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABLA INFO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var table infoTable = table.new(position.top_right, 2, 6, bgcolor=color.new(color.black, 80), border_width=1)

if barstate.islast
    table.cell(infoTable, 0, 0, "SÃ­mbolo", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, "ATRP %", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 0, 1, syminfo.ticker, text_color=atrpColor, text_size=size.small)
    table.cell(infoTable, 1, 1, str.tostring(atrpFinal, "#.##"), text_color=atrpColor, text_size=size.small)
    
    if showSymbol2
        table.cell(infoTable, 0, 2, str.replace(symbol2, "BINANCE:", ""), text_color=colorSymbol2, text_size=size.small)
        table.cell(infoTable, 1, 2, str.tostring(atrpSym2, "#.##"), text_color=colorSymbol2, text_size=size.small)
    
    if showSymbol3
        table.cell(infoTable, 0, 3, str.replace(symbol3, "BINANCE:", ""), text_color=colorSymbol3, text_size=size.small)
        table.cell(infoTable, 1, 3, str.tostring(atrpSym3, "#.##"), text_color=colorSymbol3, text_size=size.small)
    
    if showSymbol4
        table.cell(infoTable, 0, 4, str.replace(symbol4, "BINANCE:", ""), text_color=colorSymbol4, text_size=size.small)
        table.cell(infoTable, 1, 4, str.tostring(atrpSym4, "#.##"), text_color=colorSymbol4, text_size=size.small)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

alertcondition(ta.crossover(atrpFinal, highThreshold), "ATRP cruza arriba umbral alto", "Alta volatilidad detectada")
alertcondition(ta.crossunder(atrpFinal, lowThreshold), "ATRP cruza abajo umbral bajo", "Baja volatilidad detectada")
alertcondition(ta.crossunder(atrpFinal, highThreshold), "ATRP vuelve de alta volatilidad", "Volatilidad normalizÃ¡ndose")
alertcondition(ta.crossover(atrpFinal, lowThreshold), "ATRP sale de baja volatilidad", "Volatilidad aumentando")
