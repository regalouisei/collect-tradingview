//@version=6
indicator("Confluence Strength Meter (Bull/Bear) [v6]", overlay=false, max_lines_count=50)

// ===== INPUTS =====
grp_mode = "Strategy Settings"
mode     = input.string("Bullish", "Strategy Mode", options=["Bullish", "Bearish"], group=grp_mode, tooltip="Select 'Bullish' to score long setups, 'Bearish' to score short setups.")

grp_ind  = "Indicator Settings"
len_ema20 = input.int(20, "Fast EMA Length", group=grp_ind)
len_ema50 = input.int(50, "Slow EMA Length", group=grp_ind)

// ===== CALCULATIONS =====
ema20_val = ta.ema(close, len_ema20)
ema50_val = ta.ema(close, len_ema50)
vwap_val  = ta.vwap(close) 

[macdLine, signalLine, histLine] = ta.macd(close, 12, 26, 9)
rsi_val = ta.rsi(close, 14)

// ===== LOGIC SWITCH =====
// We initialize variables to 0, then update based on the selected mode
int score_f1 = 0
int score_f2 = 0
int score_f3 = 0
int score_f4 = 0
int score_f5 = 0

if mode == "Bullish"
    // --- BULLISH LOGIC ---
    score_f1 := close > ema50_val ? 1 : 0          // Price above Trend
    score_f2 := ema20_val > ema50_val ? 1 : 0      // Fast EMA above Slow EMA
    score_f3 := close > vwap_val ? 1 : 0           // Price above VWAP
    score_f4 := macdLine > signalLine ? 1 : 0      // MACD Bullish Cross
    score_f5 := rsi_val > 50 and rsi_val < 70 ? 1 : 0 // RSI Bullish but not Overbought
else
    // --- BEARISH LOGIC ---
    score_f1 := close < ema50_val ? 1 : 0          // Price below Trend
    score_f2 := ema20_val < ema50_val ? 1 : 0      // Fast EMA below Slow EMA
    score_f3 := close < vwap_val ? 1 : 0           // Price below VWAP
    score_f4 := macdLine < signalLine ? 1 : 0      // MACD Bearish Cross
    score_f5 := rsi_val < 50 and rsi_val > 30 ? 1 : 0 // RSI Bearish but not Oversold

// Calculate Total Score
confluence_score = score_f1 + score_f2 + score_f3 + score_f4 + score_f5

// ===== COLOR LOGIC =====
// If Bullish Mode: High Score = Green (Strong Buy), Low = Gray
// If Bearish Mode: High Score = Red (Strong Sell), Low = Gray
color strong_col = mode == "Bullish" ? color.green : color.red
color mid_col    = color.orange
color weak_col   = color.gray

final_color = confluence_score >= 4 ? strong_col : 
              confluence_score == 3 ? mid_col : 
              weak_col

// ===== PLOTTING =====
plot(confluence_score, title="Confluence Score", color=color.new(final_color, 20), style=plot.style_columns, linewidth=2)

// Reference lines
hline(5, "Max Score", color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(3, "Moderate Threshold", color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(0, "Min Score", color.new(color.gray, 80), linestyle=hline.style_dotted)

// ===== ALERTS =====

// 1. Create separate triggers for Bullish and Bearish modes
bull_trigger = confluence_score >= 4 and mode == "Bullish"
bear_trigger = confluence_score >= 4 and mode == "Bearish"

// 2. Define two separate alert conditions
// This fixes the error because the messages are now constant text strings.
alertcondition(bull_trigger, title="High Confluence BULL", message="Strong Bullish Setup: Confluence Score is 4+")
alertcondition(bear_trigger, title="High Confluence BEAR", message="Strong Bearish Setup: Confluence Score is 4+")
