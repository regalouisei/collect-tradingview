//@version=5
indicator("Volumetric Integrity Oscillator [VIO]", shorttitle="VIO", overlay=false, precision=2, timeframe="", timeframe_gaps=true)

// --- INPUTS ---
len = input.int(20, "Period", minval=1, tooltip="Calculation window for all internal components.")
src = input.source(close, "Source")
smooth_len = input.int(3, "Smoothing", minval=1)

// --- CALCULATIONS ---

// 1. Chaikin Money Flow (CMF) Logic - Safety Check for Division by Zero
range_val = high - low
mf_multiplier = range_val == 0 ? 0 : ((close - low) - (high - close)) / range_val
mf_volume = mf_multiplier * volume
cmf_val = ta.sma(mf_volume, len) / (ta.sma(volume, len) + 1e-10) 

// 2. Normalized CCI
cci_val = ta.cci(src, len) / 250 

// 3. OBV Trend Normalization (Z-Score approach for oscillator stability)
obv_val = ta.obv
obv_sma = ta.sma(obv_val, len)
obv_stdev = ta.stdev(obv_val, len)
obv_norm = (obv_val - obv_sma) / (obv_stdev + 1e-10)
obv_final = math.max(math.min(obv_norm, 1), -1) // Clamped between -1 and 1

// 4. VWMA Deviation
vwma_val = ta.vwma(src, len)
vwma_diff = ((src - vwma_val) / vwma_val) * 5 

// --- INTEGRATED OSCILLATOR (VIO) ---
// Weighted average of all 4 components
vio_raw = (cci_val * 0.25) + (cmf_val * 0.35) + (obv_final * 0.20) + (vwma_diff * 0.20)
vio_smooth = ta.ema(vio_raw, smooth_len)

// --- VISUALIZATION ---
vio_color = vio_smooth >= 0 ? color.new(#009688, 30) : color.new(#f44336, 30)
plot(vio_smooth, title="VIO Histogram", color=vio_color, style=plot.style_columns)
plot(vio_smooth, title="VIO Line", color=vio_smooth >= 0 ? #009688 : #f44336, linewidth=2)

// Thresholds
hline(0, "Zero Line", color=color.gray, linestyle=hline.style_dashed)
top_band = hline(0.5, "Overbought", color=color.new(#ff5252, 50), linestyle=hline.style_dotted)
btm_band = hline(-0.5, "Oversold", color=color.new(#4caf50, 50), linestyle=hline.style_dotted)

// Signals
long_signal = ta.crossover(vio_smooth, 0)
short_signal = ta.crossunder(vio_smooth, 0)

plotshape(long_signal, "Long Entry", shape.triangleup, location.bottom, color.lime, size=size.small)
plotshape(short_signal, "Short Entry", shape.triangledown, location.top, color.red, size=size.small)

// Alerts
alertcondition(long_signal, "VIO Bullish Cross", "VIO Score turned Positive - Bullish Momentum")
alertcondition(short_signal, "VIO Bearish Cross", "VIO Score turned Negative - Bearish Momentum")
