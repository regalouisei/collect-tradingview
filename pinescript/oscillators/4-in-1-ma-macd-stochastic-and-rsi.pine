//@version=6
indicator(title = '4 in 1 - MA, MACD, Stochastic and RSI', shorttitle = '4 in 1', format = format.price, precision = 2, overlay = false)

// ==========================================
// 1. CONSTANTS & PALETTE
// ==========================================
c_up = #26A69A
c_dn = #FF5252
c_text = color.white
c_sep = color.new(color.white, 80)
c_bull = color.green
c_bear = color.red

// ==========================================
// 2. INPUTS
// ==========================================

// --- MOVING AVERAGES ---
grp_ma = 'Moving Averages'

// Rank 1
show_ema1 = input.bool(true, 'EMA 1', group = grp_ma, inline = 'ma1')
len_ema1 = input.int(5, '', group = grp_ma, inline = 'ma1', tooltip = 'Fast EMA')
show_sma1 = input.bool(false, 'SMA 1', group = grp_ma, inline = 'ma1')
len_sma1 = input.int(21, '', group = grp_ma, inline = 'ma1', tooltip = 'Fast SMA')

// Rank 2
show_ema2 = input.bool(true, 'EMA 2', group = grp_ma, inline = 'ma2')
len_ema2 = input.int(15, '', group = grp_ma, inline = 'ma2', tooltip = 'Medium EMA')
show_sma2 = input.bool(false, 'SMA 2', group = grp_ma, inline = 'ma2')
len_sma2 = input.int(50, '', group = grp_ma, inline = 'ma2', tooltip = 'Medium SMA')

// Rank 3
show_ema3 = input.bool(false, 'EMA 3', group = grp_ma, inline = 'ma3')
len_ema3 = input.int(35, '', group = grp_ma, inline = 'ma3', tooltip = 'Slow EMA')
show_sma3 = input.bool(false, 'SMA 3', group = grp_ma, inline = 'ma3')
len_sma3 = input.int(75, '', group = grp_ma, inline = 'ma3', tooltip = 'Slow SMA')

// Rank 4
show_ema4 = input.bool(false, 'EMA 4', group = grp_ma, inline = 'ma4')
len_ema4 = input.int(89, '', group = grp_ma, inline = 'ma4', tooltip = 'Trend EMA')
show_sma4 = input.bool(false, 'SMA 4', group = grp_ma, inline = 'ma4')
len_sma4 = input.int(100, '', group = grp_ma, inline = 'ma4', tooltip = 'Trend SMA')

// Rank 5 (EMA only generally, but keeping structure if you want to add SMA5 later)
show_ema5 = input.bool(false, 'EMA 5', group = grp_ma, inline = 'ma5')
len_ema5 = input.int(200, '', group = grp_ma, inline = 'ma5', tooltip = 'Long Term EMA')

// --- MACD (Top Pane) ---
grp_macd = 'MACD'
fastLength = input.int(12, 'Fast', minval = 1, group = grp_macd, inline = 'macd1')
slowLength = input.int(26, 'Slow', minval = 1, group = grp_macd, inline = 'macd1')
signalLength = input.int(9, 'Sig', minval = 1, group = grp_macd, inline = 'macd1')
macdSource = input(close, 'Source', group = grp_macd, inline = 'macd1')
useAutoZoom = input.bool(true, 'Auto-Zoom', group = grp_macd, inline = 'macd2')
zoomSensitivity = input.float(20.0, '', tooltip = 'Higher = smaller waves', group = grp_macd, inline = 'macd2')
macdOffset = input.int(300, 'V-Offset', group = grp_macd, inline = 'macd2')

// --- STOCHASTIC (Middle Pane) ---
grp_stoch = 'Stochastic'
periodK = input.int(14, '%K Length', minval = 1, group = grp_stoch, inline = 'stoch')
smoothK = input.int(1, '%K Smoothing', minval = 1, group = grp_stoch, inline = 'stoch')
periodD = input.int(3, '%D Smoothing', minval = 1, group = grp_stoch, inline = 'stoch')
stochOffset = input.int(120, 'V-Offset', group = grp_stoch, inline = 'stoch')

// --- RSI (Bottom Pane) ---
grp_rsi = 'RSI'
rsiLen = input.int(14, 'Length', minval = 1, group = grp_rsi, inline = 'rsi')
rsiSrc = input.source(close, 'Source', group = grp_rsi, inline = 'rsi')

// RSI Smoothing
grp_smooth = 'RSI Smoothing'
maType = input.string('SMA', 'Type', options = ['None', 'SMA', 'SMA + BB', 'EMA', 'SMMA', 'WMA', 'VWMA'], group = grp_smooth, inline = 'sm')
maLen = input.int(14, 'Len', group = grp_smooth, inline = 'sm')
bbMult = input.float(2.0, 'BB Dev', group = grp_smooth, inline = 'sm')

// ==========================================
// 3. CALCULATIONS
// ==========================================

// --- MAs ---
e1 = ta.ema(close, len_ema1)
e2 = ta.ema(close, len_ema2)
e3 = ta.ema(close, len_ema3)
e4 = ta.ema(close, len_ema4)
e5 = ta.ema(close, len_ema5)

s1 = ta.sma(close, len_sma1)
s2 = ta.sma(close, len_sma2)
s3 = ta.sma(close, len_sma3)
s4 = ta.sma(close, len_sma4)

// --- MACD ---
[macdLine, signalLine, histLine] = ta.macd(macdSource, fastLength, slowLength, signalLength)

// Dynamic Scaling
macdStDev = ta.stdev(macdLine, 300)
scaler = useAutoZoom and macdStDev != 0 ? zoomSensitivity / macdStDev : 1.0

// Apply Scaling & Offset
s_macd = macdLine * scaler + macdOffset
s_signal = signalLine * scaler + macdOffset
s_hist = histLine * scaler + macdOffset

// --- STOCHASTIC ---
// Calculating raw values
raw_k = ta.sma(ta.stoch(close, high, low, periodK), smoothK)
raw_d = ta.sma(raw_k, periodD)

// Applying Offset for "4 in 1" Stacking
k = raw_k + stochOffset
d = raw_d + stochOffset

// --- RSI ---
rsi = ta.rsi(rsiSrc, rsiLen)

// RSI Smoothing Wrapper
getMA(src, len, type) =>
    switch type
        'SMA' => ta.sma(src, len)
        'SMA + BB' => ta.sma(src, len)
        'EMA' => ta.ema(src, len)
        'SMMA' => ta.rma(src, len)
        'WMA' => ta.wma(src, len)
        'VWMA' => ta.vwma(src, len)
        => na

enableMA = maType != 'None'
isBB = maType == 'SMA + BB'
smoothRSI = enableMA ? getMA(rsi, maLen, maType) : na
bbDev = isBB ? ta.stdev(rsi, maLen) * bbMult : na

// ==========================================
// 4. PLOTTING & VISUALS
// ==========================================

// --- SEPARATORS ---
hline(240, 'Sep: Stoch/MACD', color = c_sep, linestyle = hline.style_solid)
hline(110, 'Sep: RSI/Stoch', color = c_sep, linestyle = hline.style_solid)

// --- GROUP 1: MOVING AVERAGES ---
plot(e1, 'EMA 1', color.orange, 2, force_overlay = true, display = show_ema1 ? display.all : display.none)
plot(e2, 'EMA 2', color.yellow, 2, force_overlay = true, display = show_ema2 ? display.all : display.none)
plot(e3, 'EMA 3', color.blue, 2, force_overlay = true, display = show_ema3 ? display.all : display.none)
plot(e4, 'EMA 4', color.teal, 2, force_overlay = true, display = show_ema4 ? display.all : display.none)
plot(e5, 'EMA 5', color.purple, 2, force_overlay = true, display = show_ema5 ? display.all : display.none)

plot(s1, 'SMA 1', color.olive, 2, force_overlay = true, display = show_sma1 ? display.all : display.none)
plot(s2, 'SMA 2', color.lime, 2, force_overlay = true, display = show_sma2 ? display.all : display.none)
plot(s3, 'SMA 3', color.aqua, 2, force_overlay = true, display = show_sma3 ? display.all : display.none)
plot(s4, 'SMA 4', color.navy, 2, force_overlay = true, display = show_sma4 ? display.all : display.none)

// --- GROUP 2: MACD ---
col_hist = histLine >= 0 ? histLine[1] < histLine ? #26A69A : #B2DFDB : histLine[1] < histLine ? #FFCDD2 : #FF5252
plot(s_hist, 'MACD Hist', col_hist, style = plot.style_columns, histbase = macdOffset)
plot(s_macd, 'MACD Line', color.blue)
plot(s_signal, 'MACD Sig', color.orange)
hline(macdOffset, 'MACD Zero', color.gray, linestyle = hline.style_dotted)

// --- GROUP 3: STOCHASTIC ---
plot(k, title = '%K', color = #2962FF)
plot(d, title = '%D', color = #FF6D00)
// Hlines adjusted by stochOffset to stack correctly
h0 = hline(80 + stochOffset, 'Upper Band', color = #787B86)
hline(50 + stochOffset, 'Middle Band', color = color.new(#787B86, 50))
h1 = hline(20 + stochOffset, 'Lower Band', color = #787B86)
fill(h0, h1, color = color.rgb(33, 150, 243, 90), title = 'Background')

// --- GROUP 4: RSI ---
h_rsi_u = hline(70, 'RSI Upper', color = #787B86)
h_rsi_l = hline(30, 'RSI Lower', color = #787B86)
hline(50, 'RSI Mid', color.new(#787B86, 50))
fill(h_rsi_u, h_rsi_l, color.new(#7E57C2, 90), 'RSI BG')

p_rsi = plot(rsi, 'RSI', #7E57C2, 2)
plot(smoothRSI, 'RSI MA', color.yellow, display = enableMA ? display.all : display.none)

// Bollinger Bands
p_bb_u = plot(enableMA and isBB ? smoothRSI + bbDev : na, 'BB Upper', color.green, display = display.none)
p_bb_l = plot(enableMA and isBB ? smoothRSI - bbDev : na, 'BB Lower', color.green, display = display.none)
fill(p_bb_u, p_bb_l, color.new(color.green, 90), 'BB Fill', display = isBB ? display.all : display.none)

// RSI Gradient Fills
p_mid = plot(50, display = display.none, editable = false)
fill(p_rsi, p_mid, 100, 70, top_color = color.new(c_bull, 0), bottom_color = color.new(c_bull, 100), title = 'OB Fill')
fill(p_rsi, p_mid, 30, 0, top_color = color.new(c_bear, 100), bottom_color = color.new(c_bear, 0), title = 'OS Fill')
