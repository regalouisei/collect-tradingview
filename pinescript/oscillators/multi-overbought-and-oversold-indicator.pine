// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © AdarshShrma

//@version=5
indicator("Multi Overbought and Oversold Indicator", shorttitle="OB/OS Score", overlay=false, max_bars_back=500)

// ── Inputs ──────────────────────────────────────────────────────────────────

rsi_grp      = "RSI Settings"
rsi_len      = input.int(10,     "RSI Period",            minval=2,    group=rsi_grp)
rsi_ob       = input.float(75.0, "Overbought Level",      minval=50,   maxval=99,   step=0.5, group=rsi_grp)
rsi_os       = input.float(25.0, "Oversold Level",        minval=1,    maxval=50,   step=0.5, group=rsi_grp)

srsi_grp     = "StochRSI Settings"
srsi_rsi_len = input.int(14,     "RSI Period",            minval=2,    group=srsi_grp)
srsi_stoch   = input.int(14,     "Stoch Period",          minval=2,    group=srsi_grp)
srsi_k       = input.int(3,      "%K Smooth",             minval=1,    group=srsi_grp)
srsi_d       = input.int(3,      "%D Smooth",             minval=1,    group=srsi_grp)
srsi_ob      = input.float(80.0, "Overbought Level",      minval=50,   maxval=99,   step=0.5, group=srsi_grp)
srsi_os      = input.float(20.0, "Oversold Level",        minval=1,    maxval=50,   step=0.5, group=srsi_grp)

wr_grp       = "Williams %R Settings"
wr_len       = input.int(14,      "Period",               minval=2,    group=wr_grp)
wr_ob        = input.float(-20.0, "Overbought Level",     minval=-49,  maxval=-1,   step=0.5, group=wr_grp)
wr_os        = input.float(-80.0, "Oversold Level",       minval=-99,  maxval=-51,  step=0.5, group=wr_grp)

cci_grp      = "CCI Settings"
cci_len      = input.int(20,       "Period",              minval=2,    group=cci_grp)
cci_ob       = input.float(150.0,  "Overbought Level",    minval=50,   maxval=400,  step=5.0, group=cci_grp)
cci_os       = input.float(-150.0, "Oversold Level",      minval=-400, maxval=-50,  step=5.0, group=cci_grp)

disp_grp     = "Display"
show_score   = input.bool(true,  "Show Score Line",                group=disp_grp)
show_labels  = input.bool(true,  "Show Score Labels",              group=disp_grp)
show_table   = input.bool(true,  "Show Dashboard Table",           group=disp_grp)
show_indiv   = input.bool(false, "Show Individual Indicator Lines", group=disp_grp)

// ── Calculations ─────────────────────────────────────────────────────────────

rsi_val      = ta.rsi(close, rsi_len)
rsi_norm     = rsi_val

rsi_base     = ta.rsi(close, srsi_rsi_len)
stoch_raw    = ta.stoch(rsi_base, rsi_base, rsi_base, srsi_stoch)
srsi_k_val   = ta.sma(stoch_raw, srsi_k)
srsi_d_val   = ta.sma(srsi_k_val, srsi_d)
srsi_norm    = srsi_k_val

wr_hh        = ta.highest(high, wr_len)
wr_ll        = ta.lowest(low, wr_len)
wr_val       = (wr_hh - close) / (wr_hh - wr_ll) * -100
wr_norm      = wr_val + 100

cci_val      = ta.cci(close, cci_len)
cci_norm     = math.max(0, math.min(100, (cci_val + 300) / 6))

score        = (rsi_norm + srsi_norm + wr_norm + cci_norm) / 4.0

score_exob   = 80.0
score_ob     = 70.0
score_os     = 30.0
score_exos   = 20.0

// ── Colors ───────────────────────────────────────────────────────────────────

col_exob     = color.new(#FF2D55, 0)
col_ob       = color.new(#FF9F0A, 0)
col_neut     = color.new(#30D158, 0)
col_os       = color.new(#32ADE6, 0)
col_exos     = color.new(#BF5AF2, 0)
col_grid     = color.new(#FFFFFF, 80)

score_color  = score >= score_exob ? col_exob : score >= score_ob ? col_ob : score <= score_exos ? col_exos : score <= score_os ? col_os : col_neut

// ── Status strings ───────────────────────────────────────────────────────────

rsi_status   = rsi_val    > rsi_ob  ? "OB" : rsi_val    < rsi_os  ? "OS" : "—"
srsi_status  = srsi_k_val > srsi_ob ? "OB" : srsi_k_val < srsi_os ? "OS" : "—"
wr_status    = wr_val     > wr_ob   ? "OB" : wr_val     < wr_os   ? "OS" : "—"
cci_status   = cci_val    > cci_ob  ? "OB" : cci_val    < cci_os  ? "OS" : "—"

ob_count     = (rsi_val > rsi_ob ? 1 : 0) + (srsi_k_val > srsi_ob ? 1 : 0) + (wr_val > wr_ob ? 1 : 0) + (cci_val > cci_ob ? 1 : 0)
os_count     = (rsi_val < rsi_os ? 1 : 0) + (srsi_k_val < srsi_os ? 1 : 0) + (wr_val < wr_os ? 1 : 0) + (cci_val < cci_os ? 1 : 0)

rsi_col      = rsi_status  == "OB" ? col_ob : rsi_status  == "OS" ? col_os : color.new(#AEAEB2, 0)
srsi_col     = srsi_status == "OB" ? col_ob : srsi_status == "OS" ? col_os : color.new(#AEAEB2, 0)
wr_col       = wr_status   == "OB" ? col_ob : wr_status   == "OS" ? col_os : color.new(#AEAEB2, 0)
cci_col      = cci_status  == "OB" ? col_ob : cci_status  == "OS" ? col_os : color.new(#AEAEB2, 0)

score_label  = score >= score_exob ? "EXTREME OB" : score >= score_ob ? "OVERBOUGHT" : score <= score_exos ? "EXTREME OS" : score <= score_os ? "OVERSOLD" : "NEUTRAL"

// ── Reference lines ──────────────────────────────────────────────────────────

hline(score_exob, "Extreme OB", color=col_exob, linestyle=hline.style_dashed, linewidth=1)
hline(score_ob,   "Overbought", color=col_ob,   linestyle=hline.style_dashed, linewidth=1)
hline(50,         "Midline",    color=col_grid,  linestyle=hline.style_solid,  linewidth=1)
hline(score_os,   "Oversold",   color=col_os,   linestyle=hline.style_dashed, linewidth=1)
hline(score_exos, "Extreme OS", color=col_exos, linestyle=hline.style_dashed, linewidth=1)

// ── Zone fills — must be at global scope ─────────────────────────────────────

p_exob  = plot(score_exob, display=display.none, editable=false)
p_top   = plot(100,        display=display.none, editable=false)
p_exos  = plot(score_exos, display=display.none, editable=false)
p_bot   = plot(0,          display=display.none, editable=false)

fill(p_exob, p_top,  color=color.new(#FF2D55, 88), title="Extreme OB Zone")
fill(p_bot,  p_exos, color=color.new(#BF5AF2, 88), title="Extreme OS Zone")

// ── Individual lines ─────────────────────────────────────────────────────────

plot(show_indiv ? rsi_norm  : na, "RSI",          color=color.new(#FF9F0A, 20), linewidth=1)
plot(show_indiv ? srsi_norm : na, "StochRSI",     color=color.new(#32ADE6, 20), linewidth=1)
plot(show_indiv ? wr_norm   : na, "Williams %R",  color=color.new(#30D158, 20), linewidth=1)
plot(show_indiv ? cci_norm  : na, "CCI",          color=color.new(#BF5AF2, 20), linewidth=1)

// ── Score line + fill ────────────────────────────────────────────────────────

p_score = plot(show_score ? score : na, "OB/OS Score", color=score_color, linewidth=3)
p_mid   = plot(50, display=display.none, editable=false)

fill(p_score, p_mid, color=score > 50 ? color.new(#FF2D55, 82) : color.new(#BF5AF2, 82), title="Score Fill")

// ── Score label — single persistent label, updated in place ──────────────────

var label score_lbl = na

if show_labels
    if barstate.islast
        if na(score_lbl)
            score_lbl := label.new(bar_index, score, str.tostring(math.round(score, 1)), style=label.style_label_left, color=score_color, textcolor=color.white, size=size.normal)
        else
            label.set_x(score_lbl, bar_index)
            label.set_y(score_lbl, score)
            label.set_text(score_lbl, str.tostring(math.round(score, 1)))
            label.set_color(score_lbl, score_color)

// ── Extreme marker dots ──────────────────────────────────────────────────────

plotshape(score >= score_exob, "Extreme OB Dot", shape.circle, location.absolute, col_exob, size=size.tiny)
plotshape(score <= score_exos, "Extreme OS Dot", shape.circle, location.absolute, col_exos, size=size.tiny)

// ── Background tint ──────────────────────────────────────────────────────────

bgcolor(score >= score_exob ? color.new(#FF2D55, 92) : score >= score_ob ? color.new(#FF9F0A, 92) : score <= score_exos ? color.new(#BF5AF2, 92) : score <= score_os ? color.new(#32ADE6, 92) : na, title="BG Zone")

// ── Dashboard table ──────────────────────────────────────────────────────────

var table tbl = table.new(position.top_right, 3, 7, bgcolor=color.new(#1C1C1E, 10), border_color=color.new(#3A3A3C, 0), border_width=1, frame_color=color.new(#48484A, 0), frame_width=2)

if show_table and barstate.islast
    table.cell(tbl, 0, 0, "INDICATOR",   text_color=color.new(#AEAEB2, 0), text_size=size.small, bgcolor=color.new(#2C2C2E, 0), text_halign=text.align_left)
    table.cell(tbl, 1, 0, "VALUE",       text_color=color.new(#AEAEB2, 0), text_size=size.small, bgcolor=color.new(#2C2C2E, 0))
    table.cell(tbl, 2, 0, "STATUS",      text_color=color.new(#AEAEB2, 0), text_size=size.small, bgcolor=color.new(#2C2C2E, 0))

    table.cell(tbl, 0, 1, "RSI(" + str.tostring(rsi_len) + ")",          text_color=color.new(#FF9F0A, 0), text_size=size.normal, text_halign=text.align_left)
    table.cell(tbl, 1, 1, str.tostring(math.round(rsi_val, 1)),           text_color=color.white, text_size=size.normal)
    table.cell(tbl, 2, 1, rsi_status,                                     text_color=rsi_col,     text_size=size.normal)

    table.cell(tbl, 0, 2, "StochRSI %K",                                  text_color=color.new(#32ADE6, 0), text_size=size.normal, text_halign=text.align_left)
    table.cell(tbl, 1, 2, str.tostring(math.round(srsi_k_val, 1)),        text_color=color.white, text_size=size.normal)
    table.cell(tbl, 2, 2, srsi_status,                                    text_color=srsi_col,    text_size=size.normal)

    table.cell(tbl, 0, 3, "Williams %R(" + str.tostring(wr_len) + ")",    text_color=color.new(#30D158, 0), text_size=size.normal, text_halign=text.align_left)
    table.cell(tbl, 1, 3, str.tostring(math.round(wr_val, 1)),            text_color=color.white, text_size=size.normal)
    table.cell(tbl, 2, 3, wr_status,                                      text_color=wr_col,      text_size=size.normal)

    table.cell(tbl, 0, 4, "CCI(" + str.tostring(cci_len) + ")",           text_color=color.new(#BF5AF2, 0), text_size=size.normal, text_halign=text.align_left)
    table.cell(tbl, 1, 4, str.tostring(math.round(cci_val, 1)),           text_color=color.white, text_size=size.normal)
    table.cell(tbl, 2, 4, cci_status,                                     text_color=cci_col,     text_size=size.normal)

    table.cell(tbl, 0, 5, "-------------", text_color=color.new(#3A3A3C, 0), text_size=size.small, text_halign=text.align_left)
    table.cell(tbl, 1, 5, "--------",      text_color=color.new(#3A3A3C, 0), text_size=size.small)
    table.cell(tbl, 2, 5, "------",        text_color=color.new(#3A3A3C, 0), text_size=size.small)

    table.cell(tbl, 0, 6, "SCORE",                                        text_color=score_color, text_size=size.normal, bgcolor=color.new(#2C2C2E, 0), text_halign=text.align_left)
    table.cell(tbl, 1, 6, str.tostring(math.round(score, 1)) + " / 100",  text_color=score_color, text_size=size.normal, bgcolor=color.new(#2C2C2E, 0))
    table.cell(tbl, 2, 6, score_label,                                    text_color=score_color, text_size=size.small,  bgcolor=color.new(#2C2C2E, 0))
