//@version=6
indicator("RSI + Psy + ADX", overlay=false, max_lines_count=500)

//=== パラメータ ===//
rsiShortLen = input.int(9, "RSI 短期")
rsiMidLen   = input.int(26, "RSI 中期")
rsiLongLen  = input.int(52, "RSI 長期")
psyLen        = input.int(12, "サイコロジカル期間")
psyOverbought = input.int(70, "サイコロジカル買われすぎ")
psyOversold   = input.int(30, "サイコロジカル売られすぎ")

// ADX パラメータ
adxLen = input.int(14, "ADX期間")
adxWeak = input.int(20, "ADX弱いトレンド閾値")
adxMid  = input.int(30, "ADX中間トレンド閾値")

//=== RSI 計算 ===//
rsiShort = ta.rsi(close, rsiShortLen)
rsiMid   = ta.rsi(close, rsiMidLen)
rsiLong  = ta.rsi(close, rsiLongLen)

//=== RSI 閾値色 ===//
f_rsiColor(rsi) =>
    rsi > 68 ? color.red : rsi < 32 ? color.green : color.gray

//=== RSIライン表示（動的色） ===//
plot(rsiShort, "RSI 短期", color=f_rsiColor(rsiShort))
plot(rsiMid,   "RSI 中期", color=f_rsiColor(rsiMid))
plot(rsiLong,  "RSI 長期", color=f_rsiColor(rsiLong))

// RSI固定ゾーン
hline(70, "RSI 70ライン", color=color.red, linestyle=hline.style_dotted)
hline(30, "RSI 30ライン", color=color.green, linestyle=hline.style_dotted)
hline(50, "RSI 50ライン", color=color.gray)

//=== サイコロジカル計算（上昇日数） ===//
psyCount = 0.0
for i = 1 to psyLen
    if close[i] < close[i - 1]   // ← 上昇日を正しく判定
        psyCount += 1

psy = 100.0 * psyCount / psyLen

// サイコロジカル棒（買われすぎ/売られすぎのみ表示）
float psySignal = na
color psyColor = na
if psy > psyOverbought
    psySignal := (psy - psyOverbought) / (100 - psyOverbought) * 100
    psyColor := color.new(color.red, 0)
else if psy < psyOversold
    psySignal := (psyOversold - psy) / psyOversold * 100
    psyColor := color.new(color.green, 0)

plot(psySignal, "サイコロジカルシグナル", style=plot.style_columns, color=psyColor, linewidth=3)
hline(50, "Psy ミドルライン", color=color.gray, linestyle=hline.style_dotted)

//=== ADX計算 ===//
upMove = high - high[1]
downMove = low[1] - low
plusDM = (upMove > downMove and upMove > 0) ? upMove : 0
minusDM = (downMove > upMove and downMove > 0) ? downMove : 0

tr1 = high - low
tr2 = math.abs(high - close[1])
tr3 = math.abs(low - close[1])
tr = math.max(tr1, math.max(tr2, tr3))
smTR = ta.rma(tr, adxLen)

smPlusDM = ta.rma(plusDM, adxLen)
smMinusDM = ta.rma(minusDM, adxLen)

plusDI = 100 * smPlusDM / smTR
minusDI = 100 * smMinusDM / smTR

dx = 100 * math.abs(plusDI - minusDI) / (plusDI + minusDI)
adxVal = ta.rma(dx, adxLen)

// ADX段階色分け
adxColor = adxVal < adxWeak ? color.blue : adxVal < adxMid ? color.yellow : color.red

plot(adxVal, "ADX", color=adxColor, linewidth=2)
hline(adxMid, "中間閾値", color=color.gray, linestyle=hline.style_dotted)

//=== RSI 背景強調（中期のみ） ===//
rsiExtremeBuy  = rsiMid > 68
rsiExtremeSell = rsiMid < 32

bgcolor(
     rsiExtremeBuy ? color.new(color.red, 85) : 
     rsiExtremeSell ? color.new(color.green, 85) : 
     na
)
