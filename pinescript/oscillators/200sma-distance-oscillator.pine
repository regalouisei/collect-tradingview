// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © MajorTom111

//@version=5
indicator("200SMA Distance Oscillator", shorttitle="SMA200-%", overlay=false)

// ── Eingaben ──
smaLength = input.int(200, "SMA Länge", minval=50)

// ── Berechnung ──
sma200 = ta.sma(close, smaLength)
pct    = (close - sma200) / sma200 * 100

// ── Unsichtbare Plots für große Skala (-40 bis +40) ──
plot(40,  color=na, display=display.none)
plot(-40, color=na, display=display.none)

// ── Hauptlinie ──
p = plot(pct, title="% Abstand zur SMA200", color=#000000, linewidth=1)

// ── Horizontale Referenzlinien als separate Plots (nur für Fill & Optik) ──
p0   = plot(0,   color=color.white, linewidth=2)
p10  = plot(10,  color=color.new(color.gray,   0))
p20  = plot(20,  color=color.new(color.red,    0))
p30  = plot(30,  color=color.new(color.maroon, 0))
p_10 = plot(-10, color=color.new(color.gray,   0))
p_20 = plot(-20, color=color.new(color.lime,   0))
p_30 = plot(-30, color=color.new(color.green,  0))

// ── Dynamische Fill-Farben (intensiver je weiter weg) ──
over_transp  = pct > 10  ? 95 - math.min((pct  - 10) * 4, 90) : 100
under_transp = pct < -10 ? 95 - math.min((-pct - 10) * 4, 90) : 100

over_color  = pct > 10  ? color.new(color.red,   over_transp)  : na
under_color = pct < -10 ? color.new(color.green, under_transp) : na

// ── Fill nur zwischen Grenzlinie und aktueller Linie ──
fill(p10,  p, color=over_color,  title="Überhitzung")
fill(p_10, p, color=under_color, title="Untertreibung")

// ── Zusätzliche Mittellinie (Median oder SMA des % Abstands) ──
showCenterLine = input.bool(true, "Mittellinie anzeigen (langfristiger Median)")
centerLength   = input.int(252, "Periode für Mittellinie", minval=50, tooltip="252 ≈ 1 Börsenjahr")

// Wähle hier: true = Median (robuster), false = gleitender Durchschnitt
useMedian = input.bool(true, "Median statt SMA verwenden")

centerValue = useMedian ? ta.median(pct, centerLength) : ta.sma(pct, centerLength)

plot(showCenterLine ? centerValue : na, 
     title="Langfristige Mittellinie", 
     color=#008cffc5, 
     linewidth=2, 
     style=plot.style_line)

// ── Info-Box rechts oben ──
var table t = table.new(position.top_right, 1, 2, bgcolor=#1e1e1e, border_width=1)
table.cell(t, 0, 0, "SMA200 Abstand", text_color=#ffffff, text_size=size.small)
table.cell(t, 0, 1, str.tostring(pct, "+#.##") + "%", 
     text_color = pct >= 20 ? color.red : pct >= 10 ? #ff9800 : pct <= -20 ? color.lime : pct <= -10 ? #66bb6a : #cccccc,
     text_size = size.large)

// ── Alerts ──
alertcondition(pct >= 20,  title="> +20%", message="{{ticker}} liegt +{{close}}% über der 200-SMA!")
alertcondition(pct >= 30,  title="> +30%", message="{{ticker}} extrem überdehnt: {{close}}%!")
alertcondition(pct <= -20, title="< -20%", message="{{ticker}} deutlich unter der 200-SMA!")
