//@version=6
indicator("Harmonic Liquidity Waves", "HLW [JOAT]", overlay=false, max_labels_count=500, max_boxes_count=500)

// ═══════════════════════════════════════════════════════════════════════════════
// Harmonic Liquidity Waves - Volume Profile Edition
// VWAP | CMF | MFI | Klinger | Wave Interference
// © OfficialJackOfAllTrades 2024
// ═══════════════════════════════════════════════════════════════════════════════

// ─────────────────────────── INPUTS ───────────────────────────
var GRP1 = "Wave Core Settings"
int i_wavePeriod = input.int(21, "Wave Period", minval=5, maxval=100, group=GRP1)
float i_volumeWeight = input.float(1.5, "Volume Weight", minval=0.5, maxval=3.0, step=0.1, group=GRP1)
int i_smoothing = input.int(3, "Wave Smoothing", minval=1, maxval=10, group=GRP1)
bool i_cmf = input.bool(true, "Chaikin Money Flow", group=GRP1)
bool i_mfi = input.bool(true, "Money Flow Index", group=GRP1)
bool i_klinger = input.bool(true, "Klinger Oscillator", group=GRP1)

// Pre-calculate period multipliers as simple int (required for ta.ema)
int wavePeriod2 = i_wavePeriod * 2
int wavePeriod3 = i_wavePeriod * 3
int smoothing2 = i_smoothing * 2

var GRP2 = "Visual Settings"
bool i_showWaves = input.bool(true, "Show Liquidity Waves", group=GRP2)
bool i_showHistogram = input.bool(true, "Show Volume Histogram", group=GRP2)
bool i_showDivergence = input.bool(true, "Show Divergence Signals", group=GRP2)
bool i_showInterference = input.bool(true, "Show Wave Interference", group=GRP2)
color i_waveColor1 = input.color(color.new(#00ffff, 0), "Wave Color 1", group=GRP2)
color i_waveColor2 = input.color(color.new(#ff00ff, 0), "Wave Color 2", group=GRP2)
color i_volumeUp = input.color(color.new(#00ff00, 30), "Volume Up", group=GRP2)
color i_volumeDown = input.color(color.new(#ff0000, 30), "Volume Down", group=GRP2)
color i_profileColor = input.color(color.new(#00aaff, 60), "Profile Color", group=GRP2)

var GRP3 = "Alert Settings"
bool i_alertLiquidityShift = input.bool(true, "Alert on Liquidity Shift", group=GRP3)
bool i_alertDivergence = input.bool(true, "Alert on Divergence", group=GRP3)

// ─────────────────────────── CORE CALCULATIONS ───────────────────────────

// Chaikin Money Flow - using ta.cum for rolling sum
float mfMultiplier = high != low ? ((close - low) - (high - close)) / (high - low) : 0.0
float mfVolume = mfMultiplier * volume
float cmfValue = ta.sma(mfVolume, i_wavePeriod) / ta.sma(volume, i_wavePeriod) * 100

// Money Flow Index - built-in ta.mfi
float mfiValue = ta.mfi(hlc3, i_wavePeriod)

// Klinger Volume Oscillator - simplified version
float hlc = (high + low + close) / 3
float dm = high - low
float trendDir = hlc > hlc[1] ? 1.0 : -1.0
var float cumVF = 0.0
float vf = volume * trendDir * dm
cumVF := cumVF + vf
float kvoFast = ta.ema(vf, 13)
float kvoSlow = ta.ema(vf, 34)
float kvoValue = kvoFast - kvoSlow

// Liquidity Flow Calculation
float priceChange = ta.change(close)
float volumeFlow = volume * math.sign(priceChange)
float liquidityFlow = ta.sma(volumeFlow, i_wavePeriod)
float weightedFlow = liquidityFlow * i_volumeWeight

// Harmonic Oscillator - pre-calculate EMAs at fixed periods in global scope
float ema1 = ta.ema(weightedFlow, i_wavePeriod)
float ema2 = ta.ema(weightedFlow, wavePeriod2)
float ema3 = ta.ema(weightedFlow, wavePeriod3)
float harmonicWave = (ema1 / 1 + ema2 / 2 + ema3 / 3) / 3

float smoothedWave = ta.ema(harmonicWave, i_smoothing)

// Wave Interference
float constructiveVal = (smoothedWave + cmfValue) / 2
float destructiveVal = (smoothedWave - cmfValue) / 2
float waveInterferenceValue = ta.ema(constructiveVal, i_smoothing)

float waveSignal = ta.ema(smoothedWave, smoothing2)
float waveHistogram = smoothedWave - waveSignal

// Volume Pressure
float avgVol = ta.sma(volume, i_wavePeriod)
float volRatio = avgVol > 0 ? volume / avgVol : 1.0
float volPressure = (volRatio - 1.0) * 100

// ─────────────────────────── DIVERGENCE DETECTION ───────────────────────────
// Call pivot functions in global scope for consistency
float pivotLowPrice = ta.pivotlow(close, 5, 5)
float pivotHighPrice = ta.pivothigh(close, 5, 5)

// Convert to boolean
bool isPivotLow = not na(pivotLowPrice)
bool isPivotHigh = not na(pivotHighPrice)

// Get values when pivots occur
float priceLowAtPivot = ta.valuewhen(isPivotLow, close, 0)
float prevPriceLowAtPivot = ta.valuewhen(isPivotLow, close, 1)
float priceHighAtPivot = ta.valuewhen(isPivotHigh, close, 0)
float prevPriceHighAtPivot = ta.valuewhen(isPivotHigh, close, 1)

float liqLowAtPivot = ta.valuewhen(isPivotLow, smoothedWave, 0)
float prevLiqLowAtPivot = ta.valuewhen(isPivotLow, smoothedWave, 1)
float liqHighAtPivot = ta.valuewhen(isPivotHigh, smoothedWave, 0)
float prevLiqHighAtPivot = ta.valuewhen(isPivotHigh, smoothedWave, 1)

bool bullishDiv = isPivotLow and priceLowAtPivot < prevPriceLowAtPivot and liqLowAtPivot > prevLiqLowAtPivot
bool bearishDiv = isPivotHigh and priceHighAtPivot > prevPriceHighAtPivot and liqHighAtPivot < prevLiqHighAtPivot

// Signal Detection
bool bullishShift = ta.crossover(smoothedWave, waveSignal)
bool bearishShift = ta.crossunder(smoothedWave, waveSignal)

bool strongBullShift = bullishShift and cmfValue > 0 and mfiValue > 50 and kvoValue > 0
bool strongBearShift = bearishShift and cmfValue < 0 and mfiValue < 50 and kvoValue < 0

// Colors
color waveColor = smoothedWave > waveSignal ? i_waveColor1 : i_waveColor2
color histColor = waveHistogram > 0 ? i_volumeUp : i_volumeDown

float waveStdev = ta.stdev(smoothedWave, i_wavePeriod)
float liquidityStrength = waveStdev > 0 ? math.abs(smoothedWave) / waveStdev : 0.0
float volumeConfluence = (math.abs(cmfValue) + (math.abs(mfiValue - 50) / 50) * 100 + math.abs(kvoValue) / 1000) / 3

// ─────────────────────────── PLOTTING ───────────────────────────
// Wave Interference
plot(i_showInterference ? waveInterferenceValue : na, "Wave Interference", color=color.new(i_profileColor, 40), linewidth=2, style=plot.style_area)

// CMF
plot(i_cmf ? cmfValue : na, "CMF", color=color.new(color.blue, 60), linewidth=1, style=plot.style_line)

// KVO
plot(i_klinger ? kvoValue / 100 : na, "KVO", color=color.new(color.orange, 60), linewidth=1, style=plot.style_line)

// Reference lines
hline(0, "Zero Line", color=color.new(color.gray, 50), linestyle=hline.style_solid, linewidth=2)
hline(50, "MFI Mid", color=color.new(color.gray, 80), linestyle=hline.style_dotted)

// Liquidity Waves
plot(i_showWaves ? smoothedWave : na, "Liquidity Wave", color=waveColor, linewidth=3)
plot(i_showWaves ? waveSignal : na, "Wave Signal", color=color.new(waveColor, 50), linewidth=2, style=plot.style_line)

// Histogram
plot(i_showHistogram ? waveHistogram : na, "Wave Histogram", color=histColor, style=plot.style_columns, linewidth=4)

// MFI Normalized
plot(i_mfi ? (mfiValue - 50) / 50 : na, "MFI Normalized", color=color.new(color.purple, 70), linewidth=1, style=plot.style_stepline)

// Divergence signals
plotshape(i_showDivergence and bullishDiv, "Bullish Divergence", shape.labelup, location.bottom, color=color.new(color.lime, 0), size=size.small, text="BULL DIV", textcolor=color.white)
plotshape(i_showDivergence and bearishDiv, "Bearish Divergence", shape.labeldown, location.top, color=color.new(color.red, 0), size=size.small, text="BEAR DIV", textcolor=color.white)

// Shift signals
plotshape(bullishShift, "Bullish Shift", shape.triangleup, location.bottom, color=color.new(i_waveColor1, 0), size=size.tiny)
plotshape(bearishShift, "Bearish Shift", shape.triangledown, location.top, color=color.new(i_waveColor2, 0), size=size.tiny)

// Strong signals
plotshape(strongBullShift, "Strong Bull Shift", shape.labelup, location.bottom, color=color.new(color.lime, 0), size=size.normal, text="STRONG BUY", textcolor=color.white)
plotshape(strongBearShift, "Strong Bear Shift", shape.labeldown, location.top, color=color.new(color.red, 0), size=size.normal, text="STRONG SELL", textcolor=color.white)

// ─────────────────────────── DASHBOARD ───────────────────────────
var table dashboard = table.new(position.bottom_right, 2, 10, border_width=2, border_color=color.new(color.teal, 50), frame_width=2, frame_color=color.new(color.teal, 30))

if barstate.islast
    color dashColor = waveColor
    
    table.cell(dashboard, 0, 0, "LIQUIDITY WAVES", text_color=color.white, bgcolor=color.new(dashColor, 20), text_size=size.normal)
    table.cell(dashboard, 1, 0, "", text_color=color.white, bgcolor=color.new(dashColor, 20))
    
    table.cell(dashboard, 0, 1, "Wave Strength", text_color=color.gray, bgcolor=color.new(color.black, 80), text_size=size.small)
    color strengthColor = liquidityStrength > 1.5 ? color.lime : liquidityStrength > 1.0 ? color.yellow : color.orange
    table.cell(dashboard, 1, 1, str.tostring(liquidityStrength, "#.##"), text_color=strengthColor, bgcolor=color.new(color.black, 80), text_size=size.small)
    
    table.cell(dashboard, 0, 2, "Volume Pressure", text_color=color.gray, bgcolor=color.new(color.black, 80), text_size=size.small)
    color pressureColor = volPressure > 0 ? i_volumeUp : i_volumeDown
    table.cell(dashboard, 1, 2, str.tostring(volPressure, "#.#") + "%", text_color=pressureColor, bgcolor=color.new(color.black, 80), text_size=size.small)
    
    table.cell(dashboard, 0, 3, "Flow Direction", text_color=color.gray, bgcolor=color.new(color.black, 80), text_size=size.small)
    string flowText = smoothedWave > 0 ? "BUYING" : "SELLING"
    table.cell(dashboard, 1, 3, flowText, text_color=dashColor, bgcolor=color.new(color.black, 80), text_size=size.small)
    
    table.cell(dashboard, 0, 4, "Histogram", text_color=color.gray, bgcolor=color.new(color.black, 80), text_size=size.small)
    table.cell(dashboard, 1, 4, str.tostring(waveHistogram, "#.##"), text_color=histColor, bgcolor=color.new(color.black, 80), text_size=size.small)
    
    table.cell(dashboard, 0, 5, "CMF", text_color=color.gray, bgcolor=color.new(color.black, 80), text_size=size.small)
    color cmfColor = cmfValue > 0 ? i_volumeUp : i_volumeDown
    table.cell(dashboard, 1, 5, str.tostring(cmfValue, "#.##"), text_color=cmfColor, bgcolor=color.new(color.black, 80), text_size=size.small)
    
    table.cell(dashboard, 0, 6, "MFI", text_color=color.gray, bgcolor=color.new(color.black, 80), text_size=size.small)
    color mfiColor = mfiValue > 80 ? color.red : mfiValue < 20 ? color.lime : color.yellow
    table.cell(dashboard, 1, 6, str.tostring(mfiValue, "#.#"), text_color=mfiColor, bgcolor=color.new(color.black, 80), text_size=size.small)
    
    table.cell(dashboard, 0, 7, "KVO", text_color=color.gray, bgcolor=color.new(color.black, 80), text_size=size.small)
    color kvoColor = kvoValue > 0 ? i_volumeUp : i_volumeDown
    table.cell(dashboard, 1, 7, str.tostring(kvoValue, "#"), text_color=kvoColor, bgcolor=color.new(color.black, 80), text_size=size.small)
    
    table.cell(dashboard, 0, 8, "Vol Confluence", text_color=color.gray, bgcolor=color.new(color.black, 80), text_size=size.small)
    color confColor = volumeConfluence > 60 ? color.lime : volumeConfluence > 40 ? color.yellow : color.orange
    table.cell(dashboard, 1, 8, str.tostring(volumeConfluence, "#.#"), text_color=confColor, bgcolor=color.new(color.black, 80), text_size=size.small)
    
    table.cell(dashboard, 0, 9, "Signal", text_color=color.gray, bgcolor=color.new(color.black, 80), text_size=size.small)
    string signalText = strongBullShift ? "STRONG BUY" : strongBearShift ? "STRONG SELL" : bullishDiv ? "BULL DIV" : bearishDiv ? "BEAR DIV" : bullishShift ? "BUY" : bearishShift ? "SELL" : "NEUTRAL"
    color signalColor = strongBullShift or bullishDiv or bullishShift ? color.lime : strongBearShift or bearishDiv or bearishShift ? color.red : color.gray
    table.cell(dashboard, 1, 9, signalText, text_color=signalColor, bgcolor=color.new(color.black, 80), text_size=size.small)

// ─────────────────────────── ALERTS ───────────────────────────
alertcondition(bullishShift, "Bullish Liquidity Shift", "HLW: Bullish liquidity shift detected")
alertcondition(bearishShift, "Bearish Liquidity Shift", "HLW: Bearish liquidity shift detected")
alertcondition(bullishDiv, "Bullish Divergence", "HLW: Bullish divergence detected")
alertcondition(bearishDiv, "Bearish Divergence", "HLW: Bearish divergence detected")
alertcondition(strongBullShift, "Strong Bull Signal", "HLW: Strong bullish signal")
alertcondition(strongBearShift, "Strong Bear Signal", "HLW: Strong bearish signal")
