//@version=6
indicator(title="MACD + RSI + MFI by Ismael", shorttitle="Indicator ISRS", format=format.price, precision=2, timeframe="", timeframe_gaps=true)

// ==================================================================
// ðŸ”¹ TOGGLE INDICATORS
// ==================================================================
enable_macd = input.bool(true, title="Enable MACD", group="Toggle Indicators")
enable_rsi = input.bool(true, title="Enable RSI", group="Toggle Indicators")
enable_mfi = input.bool(false, title="Enable MFI", group="Toggle Indicators")


// ==================================================================
// ðŸ”¹ MACD SECTION
// ==================================================================
fast_length = input(title = "Fast Length", defval = 12, group="MACD Settings")
slow_length = input(title = "Slow Length", defval = 26, group="MACD Settings")
src = input(title = "Source", defval = close, group="MACD Settings")
signal_length = input.int(title = "Signal Smoothing", minval = 1, maxval = 50, defval = 9, group="MACD Settings")
sma_source = input.string(title = "Oscillator MA Type", defval = "EMA", options = ["SMA", "EMA"], group="MACD Settings")
sma_signal = input.string(title = "Signal Line MA Type", defval = "EMA", options = ["SMA", "EMA"], group="MACD Settings")

// Calculating
fast_ma = sma_source == "SMA" ? ta.sma(src, fast_length) : ta.ema(src, fast_length)
slow_ma = sma_source == "SMA" ? ta.sma(src, slow_length) : ta.ema(src, slow_length)
macd = fast_ma - slow_ma
signal = sma_signal == "SMA" ? ta.sma(macd, signal_length) : ta.ema(macd, signal_length)
hist = macd - signal

// Alerts
alertcondition(hist[1] >= 0 and hist < 0, title = 'MACD: Rising to falling', message = 'The MACD histogram switched from a rising to falling state')
alertcondition(hist[1] <= 0 and hist > 0, title = 'MACD: Falling to rising', message = 'The MACD histogram switched from a falling to rising state')

// Plots
hline(enable_macd ? 0 : na, "Zero Line", color = color.new(#787B86, 50), display = enable_macd ? display.all : display.none)
plot(enable_macd ? hist : na, title = "Histogram", style = plot.style_columns, color = (hist >= 0 ? (hist[1] < hist ? #26A69A : #B2DFDB) : (hist[1] < hist ? #FFCDD2 : #FF5252)), display = enable_macd ? display.all : display.none)
plot(enable_macd ? macd : na, title = "MACD", color = #2962FF, display = enable_macd ? display.all : display.none)
plot(enable_macd ? signal : na, title = "Signal", color = #FF6D00, display = enable_macd ? display.all : display.none)

// ==================================================================
// ðŸ”¹ RSI SECTION
// ==================================================================
rsiLengthInput = input.int(14, minval=1, title="RSI Length", group="RSI Settings")
rsiSourceInput = input.source(close, "Source", group="RSI Settings")

change = ta.change(rsiSourceInput)
up = ta.rma(math.max(change, 0), rsiLengthInput)
down = ta.rma(-math.min(change, 0), rsiLengthInput)
rsi = down == 0 ? 100 : up == 0 ? 0 : 100 - (100 / (1 + up / down))

rsiPlot = plot(enable_rsi ? rsi : na, "RSI", color=color.rgb(45, 122, 255, 36), display = enable_rsi ? display.all : display.none)

rsiUpperBand = 70
rsiLowerBand = 30

upperBandPlot = plot(enable_rsi ? rsiUpperBand : na, "RSI Upper Band", color=color.new(#787b86, 100), style=plot.style_linebr, linewidth=1, display = enable_rsi ? display.all : display.none)
lowerBandPlot = plot(enable_rsi ? rsiLowerBand : na, "RSI Lower Band", color=color.new(#787b86, 100), style=plot.style_linebr, linewidth=1, display = enable_rsi ? display.all : display.none)
midlinePlot = plot(enable_rsi ? 50 : na, "RSI Middle Band", color=color.new(#787b86, 84), display = enable_rsi ? display.all : display.none)

fill(upperBandPlot, lowerBandPlot, color=color.rgb(84, 138, 255, 90), title="RSI Background Fill", display=enable_rsi ? display.all : display.none)
fill(rsiPlot, midlinePlot, color=color.new(#4caf4f, 100), title="Overbought Gradient Fill", display=enable_rsi ? display.all : display.none)
fill(rsiPlot, midlinePlot, color=color.new(#ff5252, 100), title="Oversold Gradient Fill", display=enable_rsi ? display.all : display.none)

GRP = "Smoothing"
TT_BB = "Only applies when 'SMA + Bollinger Bands' is selected. Determines the distance between the SMA and the bands."
maTypeInput = input.string("SMA + Bollinger Bands", "Type", options = ["None", "SMA", "SMA + Bollinger Bands", "EMA", "SMMA (RMA)", "WMA", "VWMA"], group = GRP, display = display.data_window)
maLengthInput = input.int(14, "Length", group = GRP, display = display.data_window)
bbMultInput = input.float(2.0, "BB StdDev", minval = 0.001, maxval = 50, step = 0.5, tooltip = TT_BB, group = GRP, display = display.data_window)

enableMA = enable_rsi and (maTypeInput != "None")
isBB = enable_rsi and (maTypeInput == "SMA + Bollinger Bands")

ma(source, length, MAtype) =>
    switch MAtype
        "SMA"                   => ta.sma(source, length)
        "SMA + Bollinger Bands" => ta.sma(source, length)
        "EMA"                   => ta.ema(source, length)
        "SMMA (RMA)"            => ta.rma(source, length)
        "WMA"                   => ta.wma(source, length)
        "VWMA"                  => ta.vwma(source, length)

smoothingMA = enableMA ? ma(rsi, maLengthInput, maTypeInput) : na
smoothingStDev = isBB ? ta.stdev(rsi, maLengthInput) * bbMultInput : na
plot(enableMA ? smoothingMA : na, "RSI-based MA", color=color.rgb(255, 235, 59, 100), display = enableMA ? display.all : display.none, editable = enableMA)
bbUpperBandPlot = plot(isBB ? smoothingMA + smoothingStDev : na, title = "Upper Bollinger Band", color=color.rgb(76, 175, 79, 100), display = isBB ? display.all : display.none, editable = isBB)
bbLowerBandPlot = plot(isBB ? smoothingMA - smoothingStDev : na, title = "Lower Bollinger Band", color=color.rgb(76, 175, 79, 100), display = isBB ? display.all : display.none, editable = isBB)
fill(bbUpperBandPlot, bbLowerBandPlot, color= isBB ? color.new(#4caf4f, 100) : na, title="Bollinger Bands Background Fill", display = isBB ? display.all : display.none, editable = isBB)

buyCondition = enable_rsi ? (rsi < smoothingMA - smoothingStDev and rsi < rsiLowerBand) : false
sellCondition = enable_rsi ? (rsi > smoothingMA + smoothingStDev and rsi > rsiUpperBand) : false

plotshape(series=buyCondition ? rsi : na, title="Buy Signal", location=location.top, color=color.rgb(0, 238, 255), style=shape.arrowdown, size=size.small, text="", display = enable_rsi ? display.all : display.none)
plotshape(series=sellCondition ? rsi : na, title="Sell Signal", location=location.bottom, color=color.rgb(0, 238, 255), style=shape.arrowup, size=size.small, text="", display = enable_rsi ? display.all : display.none)

alertcondition(buyCondition, title="RSI Buy Signal Alert", message="RSI Buy Signal Detected!")
alertcondition(sellCondition, title="RSI Sell Signal Alert", message="RSI Sell Signal Detected!")

// ==================================================================
// ðŸ”¹ MFI SECTION
// ==================================================================
mfiLengthInput = input.int(14, title="MFI Length", group="MFI Settings")
mfiSourceInput = input.source(hlc3, title="Source", group="MFI Settings")

mf = ta.mfi(mfiSourceInput, mfiLengthInput)

mfPlot = plot(enable_mfi ? mf : na, title="Money Flow Index", color=#26A69A, display = enable_mfi ? display.all : display.none)

overbought = hline(enable_mfi ? 80 : na, title="Overbought", color=#787B86, display = enable_mfi ? display.all : display.none)
midlineMFI = hline(enable_mfi ? 50 : na, title="Middle Band", color=color.new(#787B86, 50), display = enable_mfi ? display.all : display.none)
oversold = hline(enable_mfi ? 20 : na, title="Oversold", color=#787B86, display = enable_mfi ? display.all : display.none)

fill(overbought, oversold, color=color.rgb(38, 166, 154, 90), title="MFI Background Fill", display=enable_mfi ? display.all : display.none)
