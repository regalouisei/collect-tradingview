//@version=6
indicator("Magnet Force + RSI Filter V6", overlay=true)

// --- Inputs ---
length = input.int(20, "Magnet Core Period", minval=1, group="Magnet Settings")
mult = input.float(2.0, "Attraction Strength (Sigma)", minval=0.1, step=0.1, group="Magnet Settings")

rsi_length = input.int(14, "RSI Period", minval=1, group="RSI Filter")
rsi_overbought = input.int(70, "RSI Overbought Level", group="RSI Filter")
rsi_oversold = input.int(30, "RSI Oversold Level", group="RSI Filter")

// --- Calculations ---
// 1. Magnet (VWMA-based equilibrium point)
magnet_core = ta.vwma(close, length)
dev = mult * ta.stdev(close, length)
upper_attraction = magnet_core + dev
lower_attraction = magnet_core - dev

// 2. RSI Momentum
rsi_val = ta.rsi(close, rsi_length)

// --- Signal Logic ---
// Price outside the band while RSI is in extreme zones (Preparation)
is_overbought = close > upper_attraction and rsi_val >= rsi_overbought
is_oversold = close < lower_attraction and rsi_val <= rsi_oversold

// Return to inside the band (Magnet attraction power started)
sell_signal = ta.crossunder(close, upper_attraction) and rsi_val[1] >= rsi_overbought
buy_signal = ta.crossover(close, lower_attraction) and rsi_val[1] <= rsi_oversold

// --- Visualization ---
// Channels
plot(magnet_core, "Magnet Core", color=color.new(color.gray, 0), linewidth=2)
u_plot = plot(upper_attraction, "Upper Bound", color=color.new(color.red, 60))
l_plot = plot(lower_attraction, "Lower Bound", color=color.new(color.green, 60))
fill(u_plot, l_plot, color=color.new(color.purple, 92), title="Magnetic Field")

// Background Colors (Potential Reversal)
bgcolor(is_overbought ? color.new(color.red, 90) : na)
bgcolor(is_oversold ? color.new(color.green, 90) : na)

// Signal Labels
plotshape(sell_signal, "Sell Magnet", shape.labeldown, location.abovebar, color.red, text="SELL", textcolor=color.white, size=size.small)
plotshape(buy_signal, "Buy Magnet", shape.labelup, location.belowbar, color.green, text="BUY", textcolor=color.white, size=size.small)

// --- Alerts ---
if sell_signal
    alert("Magnet Pull Down: Price returning to core from Overbought", alert.freq_once_per_bar_close)
if buy_signal
    alert("Magnet Pull Up: Price returning to core from Oversold", alert.freq_once_per_bar_close)
