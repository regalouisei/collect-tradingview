// ===== 4éŠ˜æŸ„å¯¾å¿œQQE S/A/B/Cè©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ  =====
// YouTubeè§£èª¬ç”¨ãƒ»SMCä¾¡æ ¼é€£å‹•
//@version=5
indicator(title='4éŠ˜æŸ„QQEè©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ ', shorttitle='QQE-4-Grade', overlay=true)

// ===== åŸºæœ¬è¨­å®š =====
group_basic = "åŸºæœ¬è¨­å®š"
use_alerts = input.bool(true, "ã‚¢ãƒ©ãƒ¼ãƒˆæœ‰åŠ¹", group=group_basic)
enable_time_filter = input.bool(true, "æ™‚é–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æœ‰åŠ¹", group=group_basic)
start_hour = input.int(15, "é–‹å§‹æ™‚åˆ»ï¼ˆJSTï¼‰", minval=0, maxval=23, group=group_basic)
end_hour = input.int(1, "çµ‚äº†æ™‚åˆ»ï¼ˆJSTï¼‰", minval=0, maxval=23, group=group_basic)

// ===== QQEè¨­å®š =====
group_qqe = "QQEè¨­å®š"
RSI_Period = input.int(14, title='RSIæœŸé–“', group=group_qqe)
SF = input.int(5, title='RSIã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°', group=group_qqe)
use_auto_qqe = input.bool(true, "éŠ˜æŸ„åˆ¥QQEãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼è‡ªå‹•é©ç”¨", group=group_qqe)
manual_qqe = input.float(4.238, title='[æ‰‹å‹•]QQEãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼', step=0.1, group=group_qqe)

// ===== SMCä¾¡æ ¼è¨­å®šï¼ˆ4éŠ˜æŸ„ï¼‰ =====
group_smc = "SMCä¾¡æ ¼è¨­å®š"

// USD/JPY
usdjpy_resist = input.float(149.50, "ãƒ‰ãƒ«å†† ä¸Šå´ãƒ©ã‚¤ãƒ³", group=group_smc)
usdjpy_support = input.float(148.50, "ãƒ‰ãƒ«å†† ä¸‹å´ãƒ©ã‚¤ãƒ³", group=group_smc)

// GOLD
gold_resist = input.float(2650.0, "GOLD ä¸Šå´ãƒ©ã‚¤ãƒ³", group=group_smc)
gold_support = input.float(2620.0, "GOLD ä¸‹å´ãƒ©ã‚¤ãƒ³", group=group_smc)

// EUR/USD
eurusd_resist = input.float(1.1150, "ãƒ¦ãƒ¼ãƒ­ãƒ‰ãƒ« ä¸Šå´ãƒ©ã‚¤ãƒ³", group=group_smc)
eurusd_support = input.float(1.1050, "ãƒ¦ãƒ¼ãƒ­ãƒ‰ãƒ« ä¸‹å´ãƒ©ã‚¤ãƒ³", group=group_smc)

// NASDAQ
nasdaq_resist = input.float(20200, "ãƒŠã‚¹ãƒ€ãƒƒã‚¯ ä¸Šå´ãƒ©ã‚¤ãƒ³", group=group_smc)
nasdaq_support = input.float(19800, "ãƒŠã‚¹ãƒ€ãƒƒã‚¯ ä¸‹å´ãƒ©ã‚¤ãƒ³", group=group_smc)

smc_tolerance_pct = input.float(0.15, "SMCåˆ¤å®šè¨±å®¹ç¯„å›²ï¼ˆ%ï¼‰", group=group_smc, step=0.05, tooltip="ä¾¡æ ¼ã®ä½•%ä»¥å†…ã§Sè©•ä¾¡")

// ===== è¡¨ç¤ºè¨­å®š =====
group_display = "è¡¨ç¤ºè¨­å®š"
show_grade_only = input.bool(true, "è©•ä¾¡ã®ã¿è¡¨ç¤ºï¼ˆQQEãƒ©ã‚¤ãƒ³éè¡¨ç¤ºï¼‰", group=group_display)
show_smc_lines = input.bool(true, "SMCãƒ©ã‚¤ãƒ³è¡¨ç¤º", group=group_display)
show_debug = input.bool(true, "éŠ˜æŸ„åˆ¤å®šè¡¨ç¤º", group=group_display)

// ===== éŠ˜æŸ„åˆ¤å®š =====
get_asset_info() =>
    ticker_upper = str.upper(syminfo.ticker)
    
    if str.contains(ticker_upper, "USDJPY") or str.contains(ticker_upper, "USD/JPY")
        [4.238, "ãƒ‰ãƒ«å††", usdjpy_resist, usdjpy_support]
    else if str.contains(ticker_upper, "EURUSD") or str.contains(ticker_upper, "EUR/USD")
        [3.8, "ãƒ¦ãƒ¼ãƒ­ãƒ‰ãƒ«", eurusd_resist, eurusd_support]
    else if str.contains(ticker_upper, "GOLD") or str.contains(ticker_upper, "XAUUSD") or str.contains(ticker_upper, "XAU")
        [8.0, "ã‚´ãƒ¼ãƒ«ãƒ‰", gold_resist, gold_support]
    else if str.contains(ticker_upper, "NASDAQ") or str.contains(ticker_upper, "NAS100") or str.contains(ticker_upper, "US100")
        [9.0, "ãƒŠã‚¹ãƒ€ãƒƒã‚¯", nasdaq_resist, nasdaq_support]
    else
        [4.238, syminfo.ticker, na, na]

[auto_qqe, asset_name, smc_resist, smc_support] = get_asset_info()
final_qqe = use_auto_qqe ? auto_qqe : manual_qqe

// ===== ä¾¡æ ¼ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ =====
get_price_format() =>
    ticker_upper = str.upper(syminfo.ticker)
    if str.contains(ticker_upper, "NASDAQ") or str.contains(ticker_upper, "NAS100")
        "#"
    else if str.contains(ticker_upper, "GOLD") or str.contains(ticker_upper, "XAU")
        "#.##"
    else if str.contains(ticker_upper, "JPY")
        "#.###"
    else if str.contains(ticker_upper, "USD") and not str.contains(ticker_upper, "JPY")
        "#.#####"
    else
        "#.##"

price_fmt = get_price_format()

// ===== æ™‚é–“åˆ¤å®š =====
current_hour = hour(time, "GMT+9")
is_trading_hour = if enable_time_filter
    if start_hour <= end_hour
        current_hour >= start_hour and current_hour <= end_hour
    else
        current_hour >= start_hour or current_hour <= end_hour
else
    true

get_current_session() =>
    if current_hour >= 8 and current_hour < 15
        "æ±äº¬"
    else if current_hour >= 15 and current_hour < 23
        "ãƒ­ãƒ³ãƒ‰ãƒ³"
    else
        "NY"

// ===== QQEãƒ­ã‚¸ãƒƒã‚¯ =====
src = close
Wilders_Period = RSI_Period * 2 - 1
Rsi = ta.rsi(src, RSI_Period)
RsiMa = ta.ema(Rsi, SF)
AtrRsi = math.abs(RsiMa[1] - RsiMa)
MaAtrRsi = ta.ema(AtrRsi, Wilders_Period)
dar = ta.ema(MaAtrRsi, Wilders_Period) * final_qqe

var float longband = na
var float shortband = na
var int trend = na

DeltaFastAtrRsi = dar
RSIndex = RsiMa
newshortband = RSIndex + DeltaFastAtrRsi
newlongband = RSIndex - DeltaFastAtrRsi

longband := RSIndex[1] > longband[1] and RSIndex > longband[1] ? math.max(longband[1], newlongband) : newlongband
shortband := RSIndex[1] < shortband[1] and RSIndex < shortband[1] ? math.min(shortband[1], newshortband) : newshortband

cross_1 = ta.cross(longband[1], RSIndex)
trend := ta.cross(RSIndex, shortband[1]) ? 1 : cross_1 ? -1 : nz(trend[1], 1)
FastAtrRsiTL = trend == 1 ? longband : shortband

var int QQExlong = 0
var int QQExshort = 0
QQExlong := FastAtrRsiTL < RSIndex ? QQExlong + 1 : 0
QQExshort := FastAtrRsiTL > RSIndex ? QQExshort + 1 : 0

basic_long = QQExlong == 1
basic_short = QQExshort == 1

// ===== ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆå†…éƒ¨å‡¦ç†ç”¨ï¼‰ =====
atr_current = ta.atr(14)
atr_avg = ta.sma(atr_current, 20)
atr_ratio = atr_current / atr_avg

signal_base = (basic_long or basic_short) ? 25 : 0
qqe_distance = math.abs(RSIndex - 50)
qqe_strength = qqe_distance > 20 ? 20 : qqe_distance > 10 ? 15 : 10

vol_score = atr_ratio > 1.1 and atr_ratio < 2.0 ? 15 : atr_ratio < 0.8 ? -10 : 5

volume_avg = ta.sma(volume, 20)
volume_ratio = volume / volume_avg
vol_confirm = volume_ratio > 1.2 ? 10 : volume_ratio < 0.8 ? -5 : 0

session = get_current_session()
time_bonus = session == "ãƒ­ãƒ³ãƒ‰ãƒ³" or session == "NY" ? 5 : 0

raw_score = signal_base + qqe_strength + vol_score + vol_confirm + time_bonus + 20
internal_score = math.max(0, math.min(100, raw_score))

// ===== SMCä¾¡æ ¼åˆ¤å®š =====
smc_tolerance = close * smc_tolerance_pct / 100
near_resist = not na(smc_resist) and math.abs(close - smc_resist) <= smc_tolerance
near_support = not na(smc_support) and math.abs(close - smc_support) <= smc_tolerance
near_smc = near_resist or near_support

// ===== S/A/B/Cè©•ä¾¡åˆ¤å®š =====
get_grade() =>
    if not (basic_long or basic_short)
        ""
    else if near_smc and is_trading_hour
        "S"
    else if internal_score >= 70 and is_trading_hour
        "A"
    else if internal_score >= 50 and is_trading_hour
        "B"
    else
        "C"

grade = get_grade()

// æœ€çµ‚ã‚·ã‚°ãƒŠãƒ«
final_long = basic_long and grade != "" and grade != "C"
final_short = basic_short and grade != "" and grade != "C"
weak_long = basic_long and grade == "C"
weak_short = basic_short and grade == "C"

// ===== è¡¨ç¤º =====
// QQEãƒ©ã‚¤ãƒ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
qqe_color = trend == 1 ? color.blue : color.red
plot(show_grade_only ? na : RSIndex, title="QQE RSI", color=qqe_color, linewidth=2)
plot(show_grade_only ? na : FastAtrRsiTL, title="QQE Signal", color=color.orange, linewidth=1)

// SMCãƒ©ã‚¤ãƒ³è¡¨ç¤º
plot(show_smc_lines and not na(smc_resist) ? smc_resist : na, title="ä¸Šå´ãƒ©ã‚¤ãƒ³", color=color.new(color.red, 50), style=plot.style_linebr, linewidth=2)
plot(show_smc_lines and not na(smc_support) ? smc_support : na, title="ä¸‹å´ãƒ©ã‚¤ãƒ³", color=color.new(color.lime, 50), style=plot.style_linebr, linewidth=2)

// BUYã‚·ã‚°ãƒŠãƒ«è¡¨ç¤º
if final_long
    grade_color = grade == "S" ? color.new(color.yellow, 0) : 
                  grade == "A" ? color.new(color.lime, 0) : 
                  color.new(color.green, 20)
    
    label_text = "BUY\n" + grade
    label.new(bar_index, low, label_text, 
              style=label.style_label_up, 
              color=grade_color, 
              textcolor=color.black, 
              size=size.huge,
              tooltip=asset_name + " QQE BUY " + grade + "è©•ä¾¡\nã‚¹ã‚³ã‚¢:" + str.tostring(math.round(internal_score)))

// SELLã‚·ã‚°ãƒŠãƒ«è¡¨ç¤º
if final_short
    grade_color = grade == "S" ? color.new(color.orange, 0) : 
                  grade == "A" ? color.new(color.red, 0) : 
                  color.new(color.maroon, 20)
    
    label_text = "SELL\n" + grade
    label.new(bar_index, high, label_text, 
              style=label.style_label_down, 
              color=grade_color, 
              textcolor=color.white, 
              size=size.huge,
              tooltip=asset_name + " QQE SELL " + grade + "è©•ä¾¡\nã‚¹ã‚³ã‚¢:" + str.tostring(math.round(internal_score)))

// Cè©•ä¾¡ï¼ˆæ™‚é–“å¤–ãªã©ï¼‰
if weak_long
    label.new(bar_index, low, "buy\nC", 
              style=label.style_label_up, 
              color=color.new(color.gray, 30), 
              textcolor=color.white, 
              size=size.small,
              tooltip="æ™‚é–“å¤–ã¾ãŸã¯å¼±ã‚·ã‚°ãƒŠãƒ«")

if weak_short
    label.new(bar_index, high, "sell\nC", 
              style=label.style_label_down, 
              color=color.new(color.gray, 30), 
              textcolor=color.white, 
              size=size.small,
              tooltip="æ™‚é–“å¤–ã¾ãŸã¯å¼±ã‚·ã‚°ãƒŠãƒ«")

// æƒ…å ±è¡¨ç¤º
if barstate.islast
    session_name = get_current_session()
    time_status = is_trading_hour ? "âœ…å–å¼•æ™‚é–“" : "âŒæ™‚é–“å¤–"
    smc_status = near_smc ? "ğŸ¯SMCåœå†…" : "é€šå¸¸"
    mode_text = use_auto_qqe ? "è‡ªå‹•" : "æ‰‹å‹•"
    
    var table info_tbl = table.new(position.top_right, 1, 1,
         frame_color=color.orange, border_color=color.white,
         frame_width=2, border_width=1)
    table.cell(info_tbl, 0, 0, 
         asset_name + " [" + mode_text + "]\n" + session_name + "\n" + time_status + "\n" + smc_status,
         text_color=color.white, text_size=size.normal, bgcolor=color.new(color.orange, 30))

// éŠ˜æŸ„åˆ¤å®šãƒ‡ãƒãƒƒã‚°
if show_debug and barstate.islast
    var table debug_tbl = table.new(position.top_left, 2, 3,
         frame_color=color.blue, border_color=color.white,
         frame_width=2, border_width=1)
    
    table.cell(debug_tbl, 0, 0, "å…ƒãƒ†ã‚£ãƒƒã‚«ãƒ¼", text_color=color.white, text_size=size.small, bgcolor=color.blue)
    table.cell(debug_tbl, 1, 0, syminfo.ticker, text_color=color.white, text_size=size.small, bgcolor=color.blue)
    
    table.cell(debug_tbl, 0, 1, "åˆ¤å®šçµæœ", text_color=color.white, text_size=size.small, bgcolor=color.blue)
    table.cell(debug_tbl, 1, 1, asset_name, text_color=color.white, text_size=size.normal, bgcolor=color.blue)
    
    table.cell(debug_tbl, 0, 2, "QQEãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼", text_color=color.white, text_size=size.small, bgcolor=color.blue)
    table.cell(debug_tbl, 1, 2, str.tostring(final_qqe, "#.##"), text_color=color.white, text_size=size.normal, bgcolor=color.blue)

// ===== ã‚¢ãƒ©ãƒ¼ãƒˆ =====
if use_alerts and barstate.isconfirmed
    price_str = str.tostring(close, price_fmt)
    session_name = get_current_session()
    
    if final_long
        alert_msg = "ğŸš€ " + asset_name + " BUY-" + grade + " " + price_str + " | " + session_name + "ã‚¿ã‚¤ãƒ "
        alert(alert_msg, alert.freq_once_per_bar_close)
    
    if final_short
        alert_msg = "ğŸ”¥ " + asset_name + " SELL-" + grade + " " + price_str + " | " + session_name + "ã‚¿ã‚¤ãƒ "
        alert(alert_msg, alert.freq_once_per_bar_close)

alertcondition(final_long, title="QQE BUY", message="QQE BUY ã‚·ã‚°ãƒŠãƒ«")
alertcondition(final_short, title="QQE SELL", message="QQE SELL ã‚·ã‚°ãƒŠãƒ«")
