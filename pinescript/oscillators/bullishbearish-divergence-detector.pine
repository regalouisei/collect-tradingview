// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © PeterURossler
//@version=6
indicator("Bullish/Bearish Divergence Detector", overlay=true, max_lines_count=500)

// Input parameters
length = input.int(14, "RSI Length", minval=1)
pivotLength = input.int(3, "Pivot Lookback Length", minval=1, tooltip="Lower = more signals, Higher = fewer but stronger signals")
maxPivotsBack = input.int(5, "Max Pivots to Check Back", minval=1, maxval=10, tooltip="How many previous pivots to compare against")
showLines = input.bool(true, "Show Divergence Lines")

// Calculate RSI
rsi = ta.rsi(close, length)

// Detect pivot highs and lows (swing points)
pivotHigh = ta.pivothigh(high, pivotLength, pivotLength)
pivotLow = ta.pivotlow(low, pivotLength, pivotLength)

// Arrays to store pivot history
var array<float> pivotLowPrices = array.new<float>(0)
var array<float> pivotLowRSIs = array.new<float>(0)
var array<int> pivotLowBars = array.new<int>(0)

var array<float> pivotHighPrices = array.new<float>(0)
var array<float> pivotHighRSIs = array.new<float>(0)
var array<int> pivotHighBars = array.new<int>(0)

// Detect bullish divergence
bullishDiv = false
if not na(pivotLow)
    currentPivotBar = bar_index - pivotLength
    currentPivotPrice = pivotLow
    currentPivotRSI = rsi[pivotLength]
    
    // Check against previous pivots
    arraySize = array.size(pivotLowPrices)
    if arraySize > 0
        lookbackLimit = math.min(arraySize, maxPivotsBack)
        for i = 0 to lookbackLimit - 1
            prevPrice = array.get(pivotLowPrices, arraySize - 1 - i)
            prevRSI = array.get(pivotLowRSIs, arraySize - 1 - i)
            prevBar = array.get(pivotLowBars, arraySize - 1 - i)
            
            if currentPivotPrice < prevPrice and currentPivotRSI > prevRSI
                bullishDiv := true
                // Draw line connecting the two lows
                if showLines
                    line.new(x1=prevBar, y1=prevPrice, x2=currentPivotBar, y2=currentPivotPrice, color=color.green, width=2, style=line.style_solid)
                break  // Exit loop after first divergence found
    
    // Store current pivot in arrays
    array.push(pivotLowPrices, currentPivotPrice)
    array.push(pivotLowRSIs, currentPivotRSI)
    array.push(pivotLowBars, currentPivotBar)
    
    // Limit array size to prevent memory issues
    if array.size(pivotLowPrices) > maxPivotsBack * 2
        array.shift(pivotLowPrices)
        array.shift(pivotLowRSIs)
        array.shift(pivotLowBars)

// Detect bearish divergence
bearishDiv = false
if not na(pivotHigh)
    currentPivotBar = bar_index - pivotLength
    currentPivotPrice = pivotHigh
    currentPivotRSI = rsi[pivotLength]
    
    // Check against previous pivots
    arraySize = array.size(pivotHighPrices)
    if arraySize > 0
        lookbackLimit = math.min(arraySize, maxPivotsBack)
        for i = 0 to lookbackLimit - 1
            prevPrice = array.get(pivotHighPrices, arraySize - 1 - i)
            prevRSI = array.get(pivotHighRSIs, arraySize - 1 - i)
            prevBar = array.get(pivotHighBars, arraySize - 1 - i)
            
            if currentPivotPrice > prevPrice and currentPivotRSI < prevRSI
                bearishDiv := true
                // Draw line connecting the two highs
                if showLines
                    line.new(x1=prevBar, y1=prevPrice, x2=currentPivotBar, y2=currentPivotPrice, color=color.red, width=2, style=line.style_solid)
                break  // Exit loop after first divergence found
    
    // Store current pivot in arrays
    array.push(pivotHighPrices, currentPivotPrice)
    array.push(pivotHighRSIs, currentPivotRSI)
    array.push(pivotHighBars, currentPivotBar)
    
    // Limit array size to prevent memory issues
    if array.size(pivotHighPrices) > maxPivotsBack * 2
        array.shift(pivotHighPrices)
        array.shift(pivotHighRSIs)
        array.shift(pivotHighBars)

// Plot divergence signals
plotshape(bullishDiv, title="Bullish Divergence", location=location.belowbar, color=color.new(color.green, 0), style=shape.arrowup, size=size.normal, offset=-pivotLength)
plotshape(bearishDiv, title="Bearish Divergence", location=location.abovebar, color=color.new(color.red, 0), style=shape.arrowdown, size=size.normal, offset=-pivotLength)
