//@version=6
indicator("Improved ADX – Responsive & Visual (manual ADX)", shorttitle="Improved ADX+", overlay=false )

// === Inputs
len = input.int(14, "ADX Length", minval=1)
smooth = input.int(5, "Fast Smoothing (lower = more responsive)", minval=1)
show_fill = input.bool(true, "Highlight Strong Trend Area", group="Visual")
highlight_level = input.int(25, "Trend Strength Threshold", group="Visual")
show_di = input.bool(true, "Show DI+ / DI–", group="Display")
show_adx = input.bool(true, "Show ADX", group="Display")

// === Directional Movement (classic calculation)
upMove   = high - high[1]
downMove = low[1] - low

plusDM  = (upMove > downMove and upMove > 0)  ? upMove  : 0.0
minusDM = (downMove > upMove and downMove > 0) ? downMove : 0.0

// True range (manual)
tr = math.max(high - low, math.max(math.abs(high - close[1]), math.abs(low - close[1])))

// Smooth with Wilder's moving average (RMA/Wilder MA)
sm_plusDM  = ta.rma(plusDM, len)
sm_minusDM = ta.rma(minusDM, len)
sm_tr      = ta.rma(tr, len)

// Avoid division by zero
plusDI  = sm_tr != 0 ? 100.0 * (sm_plusDM  / sm_tr) : 0.0
minusDI = sm_tr != 0 ? 100.0 * (sm_minusDM / sm_tr) : 0.0

// DX and ADX
dx  = (plusDI + minusDI) != 0 ? 100.0 * math.abs((plusDI - minusDI) / (plusDI + minusDI)) : 0.0
adx = ta.rma(dx, len)

// Extra smoothing for responsiveness
adx_fast = ta.sma(adx, smooth)

// === Dynamic colors
color_adx = adx_fast >= highlight_level      ? color.new(color.green, 0) : adx_fast >= highlight_level * 0.75 ? color.new(color.yellow, 0) :color.new(color.red, 0)
color_plus  = plusDI > minusDI ? color.lime : color.new(color.lime, 60)
color_minus = minusDI > plusDI ? color.red  : color.new(color.red, 60)

// === Plots (na escala do indicador) ===
p_plus  = plot(show_di  ? plusDI  : na, title="DI+", color=color_plus, linewidth=2)
p_minus = plot(show_di  ? minusDI : na, title="DI–", color=color_minus, linewidth=2)

p_adx      = plot(show_adx ? adx_fast : na, title="ADX (fast)", color=color_adx, linewidth=3)
p_adx_orig = plot(show_adx ? adx      : na, title="ADX (orig)", color=color.new(color.blue, 60), linewidth=1)

p_thresh   = plot(show_adx ? highlight_level : na, title="Threshold", color=color.new(color.gray, 70), linewidth=1)

// === FILL — escala do indicador ===
fill_color =
     show_fill and show_adx and adx_fast >= highlight_level ? color.new(color.green, 85) :
     show_fill and show_adx ? color.new(color.red, 90) :
     na

fill(p_adx, p_thresh, color = fill_color)

// === Cross markers — na escala do indicador (v6 corrigido) ===
cross_up   = show_adx and ta.crossover(adx_fast, highlight_level)
cross_down = show_adx and ta.crossunder(adx_fast, highlight_level)

plotshape(series = cross_up ? highlight_level + 25 : na,
          title = "ADX Strengthening",
          style = shape.triangleup,
          location = location.absolute,
          color = color.green,
          size = size.tiny)

plotshape(series = cross_down ? highlight_level - 25: na,
          title = "ADX Weakening",
          style = shape.triangledown,
          location = location.absolute,
          color = color.red,
          size = size.tiny)

// === Label com valores no topo da escala do indicador (v6) ===
var label info = na
if barstate.islast
    if not na(info)
        label.delete(info)
    infoText = "ADX: " + str.tostring(adx_fast, "#.##") + 
               "   DI+: " + str.tostring(plusDI, "#.##") + 
               "   DI-: " + str.tostring(minusDI, "#.##")
    info := label.new(bar_index, 100, infoText, xloc=xloc.bar_index,
                      style=label.style_label_left, size=size.small, 
                      textcolor=color.white, color=color.new(color.black, 80))
