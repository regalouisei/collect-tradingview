//@version=6
indicator("Buy/Sell Trend Master", shorttitle="Buy/Sell", overlay=false)

// ==========================================
// 1. HYBRID SUPERTREND LOGIC
// ==========================================
grp_st = 'Hybrid Supertrend Settings'
atrP1 = input.int(1, "Fast ATR", group=grp_st)
fac1  = input.float(1.0, "Fast Factor", step=0.1, group=grp_st)
atrP2 = input.int(2, "Med ATR", group=grp_st)
fac2  = input.float(2.0, "Med Factor", step=0.1, group=grp_st)
atrP3 = input.int(3, "Slow ATR", group=grp_st)
fac3  = input.float(3.0, "Slow Factor", step=0.1, group=grp_st)

[st1, dir1] = ta.supertrend(fac1, atrP1)
[st2, dir2] = ta.supertrend(fac2, atrP2)
[st3, dir3] = ta.supertrend(fac3, atrP3)

is_hybrid_green = dir1 < 0 and dir2 < 0 and dir3 < 0
is_hybrid_red   = dir1 > 0 and dir2 > 0 and dir3 > 0

// ==========================================
// 2. HMA & EMA CHANNEL LOGIC
// ==========================================
grp_td = "Trend & Scalp Settings"
h_len   = input.int(50, "HMA Length", group=grp_td)
ema_len = input.int(20, "Scalp EMA Length", group=grp_td)

hma = ta.hma(close, h_len)
ema_high = ta.ema(high, ema_len)
ema_low  = ta.ema(low, ema_len)

// Trend Slope
is_hma_green = hma > hma[1]
is_hma_red   = hma < hma[1]

// ==========================================
// 3. THE RULES (TREND VS SCALP)
// ==========================================
// Primary Trend Logic (Confluence)
bool trend_buy_cond  = is_hybrid_green and is_hma_green
bool trend_sell_cond = is_hybrid_red and is_hma_red

// Scalp Logic (Price Breakout of 20 EMA)
bool scalp_buy_cond  = ta.crossover(close, ema_high)
bool scalp_sell_cond = ta.crossunder(close, ema_low)

// ================= =========================
// 4. VISUALIZATION
// ==========================================
atr_v   = ta.atr(14)
osc_val = (close - hma) / (atr_v > 0 ? atr_v : syminfo.mintick)

hline(0, "Neutral Line", color=color.new(color.gray, 50), linestyle=hline.style_dotted)

color col_green = color.rgb(18, 228, 158) // Green
color col_red   = color.rgb(236, 86, 16)  // Red

color hist_col = trend_buy_cond  ? col_green : 
                 trend_sell_cond ? col_red   : 
                 color.gray

plot(osc_val, "Signal Histogram", color=color.new(hist_col, 20), style=plot.style_columns)
plot(osc_val, "Momentum Line", color=color.white, linewidth=2)

// ================= =========================
// 5. SIGNALS & UPDATED ALERTS
// ==========================================

// Primary Trend Labels
plotshape(trend_buy_cond and not trend_buy_cond[1],   title="Trend Buy Label",  text="TREND BUY",  style=shape.labelup,   location=location.top,    color=col_green, textcolor=color.black, size=size.tiny)
plotshape(trend_sell_cond and not trend_sell_cond[1], title="Trend Sell Label", text="TREND SELL", style=shape.labeldown, location=location.bottom, color=col_red,   textcolor=color.white, size=size.tiny)

// Scalp Signal Markers (Small Triangles)
plotshape(scalp_buy_cond,  title="Scalp Buy Marker",  style=shape.triangleup,   location=location.top,    color=color.lime, size=size.tiny)
plotshape(scalp_sell_cond, title="Scalp Sell Marker", style=shape.triangledown, location=location.bottom, color=color.red,  size=size.tiny)

// --- RENAMED ALERTS ---
alertcondition(trend_buy_cond and not trend_buy_cond[1], "Trend Buy", "Hybrid ST + HMA are Green")
alertcondition(trend_sell_cond and not trend_sell_cond[1], "Trend Sell", "Hybrid ST + HMA are Red")

alertcondition(scalp_buy_cond, "Scalp Buy", "Price closed above the Upper EMA line!")
alertcondition(scalp_sell_cond, "Scalp Sell", "Price closed below the Lower EMA line!")
