//@version=6
indicator("MTF StochRSI + Reverse Overlay (Log-Scaled)", overlay=false, max_labels_count=500)

// === INPUT SETTINGS ===
rsiLength   = input.int(14, "RSI Length", group="Settings")
stochLength = input.int(14, "Stoch Length", group="Settings")
smoothK     = input.int(3, "Smooth K Length", group="Settings")
src         = input.source(close, "Source", group="Settings")
showZones   = input.bool(true, "Show Support/Resistance Zones", group="Visuals")

// === TIMEFRAMES ===
tf1 = input.timeframe("5", "Timeframe 1")
showTF1 = input.bool(true, "Show TF1")
tf2 = input.timeframe("15", "Timeframe 2")
showTF2 = input.bool(true, "Show TF2")
tf3 = input.timeframe("60", "Timeframe 3")
showTF3 = input.bool(true, "Show TF3")
tf4 = input.timeframe("240", "Timeframe 4")
showTF4 = input.bool(true, "Show TF4")

// === COLORS ===
col_sRSI1 = input.color(color.blue, "Original TF1 Color")
col_sRSI2 = input.color(color.green, "Original TF2 Color")
col_sRSI3 = input.color(color.orange, "Original TF3 Color")
col_sRSI4 = input.color(color.red, "Original TF4 Color")

col_revRSI1 = input.color(color.new(color.blue, 70), "Reverse TF1 Color")
col_revRSI2 = input.color(color.new(color.green, 70), "Reverse TF2 Color")
col_revRSI3 = input.color(color.new(color.orange, 70), "Reverse TF3 Color")
col_revRSI4 = input.color(color.new(color.red, 70), "Reverse TF4 Color")

// === VISUALS ===
midlineColor        = input.color(color.gray, "Midline Color")
zoneResistanceColor = input.color(color.red, "Overbought Line Color")
zoneSupportColor    = input.color(color.lime, "Oversold Line Color")

// === STOCHRSI FUNCTION ===
stochRSI(src, rsiLen, stochLen, smoothLen) =>
    r = ta.rsi(src, rsiLen)
    k = ta.stoch(r, r, r, stochLen)
    ta.sma(k, smoothLen)

// === CALCULATE ORIGINAL STOCHRSI ===
sRSI1 = request.security(syminfo.tickerid, tf1, stochRSI(src, rsiLength, stochLength, smoothK))
sRSI2 = request.security(syminfo.tickerid, tf2, stochRSI(src, rsiLength, stochLength, smoothK))
sRSI3 = request.security(syminfo.tickerid, tf3, stochRSI(src, rsiLength, stochLength, smoothK))
sRSI4 = request.security(syminfo.tickerid, tf4, stochRSI(src, rsiLength, stochLength, smoothK))

// === LOGARITHMIC SCALING FUNCTION ===
logScale(value) =>
    // normalize 0–100 to 0–1
    scaled = math.log(value + 1) / math.log(101)  // log(1) = 0, log(101) ~ 2.004
    scaled

// === SCALE ORIGINAL STOCHRSI TO LOG SCALE ===
sRSI1_scaled = logScale(sRSI1)
sRSI2_scaled = logScale(sRSI2)
sRSI3_scaled = logScale(sRSI3)
sRSI4_scaled = logScale(sRSI4)

// === SCALE REVERSE STOCHRSI USING ORIGINAL SCALE ===
revRSI1_scaled = 1 - sRSI1_scaled
revRSI2_scaled = 1 - sRSI2_scaled
revRSI3_scaled = 1 - sRSI3_scaled
revRSI4_scaled = 1 - sRSI4_scaled

// === PLOT ORIGINAL STOCHRSI (LOG-SCALED) ===
plot(showTF1 ? sRSI1_scaled : na, "StochRSI TF1", color=col_sRSI1)
plot(showTF2 ? sRSI2_scaled : na, "StochRSI TF2", color=col_sRSI2)
plot(showTF3 ? sRSI3_scaled : na, "StochRSI TF3", color=col_sRSI3)
plot(showTF4 ? sRSI4_scaled : na, "StochRSI TF4", color=col_sRSI4)

// === PLOT REVERSE STOCHRSI (LOG-SCALED) ===
plot(showTF1 ? revRSI1_scaled : na, "Rev StochRSI TF1", color=col_revRSI1)
plot(showTF2 ? revRSI2_scaled : na, "Rev StochRSI TF2", color=col_revRSI2)
plot(showTF3 ? revRSI3_scaled : na, "Rev StochRSI TF3", color=col_revRSI3)
plot(showTF4 ? revRSI4_scaled : na, "Rev StochRSI TF4", color=col_revRSI4)

// === OVERBOUGHT / OVERSOLD ZONES ON LOG SCALE ===
plot(logScale(80), "Overbought", color=zoneResistanceColor)
plot(logScale(20), "Oversold", color=zoneSupportColor)
hline(logScale(50), "Midline", color=midlineColor, linestyle=hline.style_dashed)
