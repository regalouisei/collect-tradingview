//@version=6
indicator("LBR 3-10 Oscillator – Enhanced (Linda Raschke Momentum)", shorttitle="LBR 3/10 Pro", overlay=false, max_labels_count=500)

// ────────────────────────────────────────
// Inputs
// ────────────────────────────────────────
fastLen   = input.int(3,  "Fast Length (3)",  minval=1)
slowLen   = input.int(10, "Slow Length (10)", minval=1)
signalLen = input.int(16, "Signal Length (16)", minval=1)
maType    = input.string("SMA", "MA Type", options=["SMA", "EMA", "WMA"])
showHist  = input.bool(true,  "Show Histogram")
showDiv   = input.bool(true,  "Show Divergences")
obLevel   = input.int(100, "Overbought Level")
osLevel   = input.int(-100, "Oversold Level")

// ────────────────────────────────────────
// Moving Average Function (default SMA = original LBR)
// ────────────────────────────────────────
ma(src, len, type) =>
    switch type
        "SMA" => ta.sma(src, len)
        "EMA" => ta.ema(src, len)
        "WMA" => ta.wma(src, len)

// ────────────────────────────────────────
// Calculations
// ────────────────────────────────────────
fastMA = ma(close, fastLen, maType)
slowMA = ma(close, slowLen, maType)
osc    = fastMA - slowMA                     // Fast Momentum Line (core LBR 3-10)
signal = ma(osc, signalLen, maType)          // Signal / Slow Line

// Momentum Direction & Histogram States
upTrend   = osc > osc[1]
dnTrend   = osc < osc[1]
aboveZero = osc > 0

var color histColor = color.gray

if upTrend and aboveZero
    histColor := color.new(color.lime, 20)      // Strong Bull
else if upTrend
    histColor := color.new(color.green, 50)     // Weak Bull
else if dnTrend and not aboveZero
    histColor := color.new(color.maroon, 20)    // Strong Bear
else if dnTrend
    histColor := color.new(color.red, 50)       // Weak Bear
else
    histColor := color.gray
// ────────────────────────────────────────
// Plots
// ────────────────────────────────────────
hline(0,        "Zero Line",     color=color.gray,    linestyle=hline.style_dotted)
hline(obLevel,  "OB Level",      color=color.orange,  linestyle=hline.style_dashed)
hline(osLevel,  "OS Level",      color=color.orange,  linestyle=hline.style_dashed)

// Signal Line (thicker)
plot(signal, "Signal (Slow)", color=color.new(color.red, 0), linewidth=3)

// Fast Line (colored by direction)
fastColor = upTrend ? color.new(color.blue, 0) : color.new(color.purple, 0)
plot(osc, "Fast Momentum", color=fastColor, linewidth=2, style=plot.style_line)

// Histogram (optional)
plot(showHist ? osc : na, "Histogram", color=histColor, style=plot.style_histogram, linewidth=4)

// Momentum Hooks – FIXED: now plotted at the actual oscillator value (was plotting at y=1/0)
plotchar(osc > osc[1] and osc[1] <= osc[2] ? osc : na, "Hook Up",   "•", location.absolute, color=color.new(color.green, 0), size=size.tiny)
plotchar(osc < osc[1] and osc[1] >= osc[2] ? osc : na, "Hook Down", "•", location.absolute, color=color.new(color.red,   0), size=size.tiny)

// ────────────────────────────────────────
// Divergence Detection (simple adjacent-bar version – clearly documented)
// ────────────────────────────────────────
bullDiv = showDiv and low < low[1] and osc > osc[1] and osc[1] <= osc[2]
bearDiv = showDiv and high > high[1] and osc < osc[1] and osc[1] >= osc[2]

plotshape(bullDiv, "Bull Div",  shape.labelup,   location.belowbar, color.new(color.green, 0), text="Bull Div",  textcolor=color.white, size=size.small)
plotshape(bearDiv, "Bear Div",  shape.labeldown, location.abovebar, color.new(color.red,   0), text="Bear Div",  textcolor=color.white, size=size.small)

// ────────────────────────────────────────
// Alerts
// ────────────────────────────────────────
alertcondition(ta.crossover(osc, signal), title="LBR: Fast Cross Above Signal", message="LBR 3-10: BUY momentum shift!")
alertcondition(ta.crossunder(osc, signal), title="LBR: Fast Cross Below Signal", message="LBR 3-10: SELL momentum shift!")
alertcondition(ta.crossover(osc, 0),       title="LBR: Cross Above Zero",      message="LBR 3-10: Bullish trend confirmation!")
alertcondition(ta.crossunder(osc, 0),      title="LBR: Cross Below Zero",      message="LBR 3-10: Bearish trend confirmation!")
alertcondition(osc > obLevel, title="LBR: Overbought", message="LBR 3-10: Extreme bullish – watch for reversal!")
alertcondition(osc < osLevel, title="LBR: Oversold",   message="LBR 3-10: Extreme bearish – watch for reversal!")
