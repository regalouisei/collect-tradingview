//@version=6
indicator('Cipher Reborn Scalper — BTC Edition v8', overlay=false)

mostrar_signales           = input.bool(true, title='Mostrar señales RSI tradicionales')
mostrar_RSI                = input.bool(true, title='Mostrar RSI base')
mostrar_STOCH              = input.bool(true, title='Activar Stoch RSI (K/D)')
mostrar_DIVERGENCIAS       = input.bool(true, title='Divergencias sobre Stoch RSI')
mostrar_confluencia_linea = input.bool(true, title='Línea vertical por confluencia RSI + divergencia')

// === RSI Base === //
rsi_len  = input.int(14, title='RSI - Periodo')
rsi_val  = ta.rsi(close, rsi_len)

plot(mostrar_RSI ? rsi_val : na, title='RSI', color=color.white, linewidth=1)
hline(30, 'RSI Oversold', color=color.green)
hline(70, 'RSI Overbought', color=color.red)

// === Señales RSI tradicionales === //
longSignal  = ta.crossover(rsi_val, 30) and rsi_val[1] < 30
shortSignal = ta.crossunder(rsi_val, 70) and rsi_val[1] > 70

plot(mostrar_signales and longSignal  ? rsi_val : na, title='LONG sobre RSI', style=plot.style_cross, color=color.green, linewidth=3)
plot(mostrar_signales and shortSignal ? rsi_val : na, title='SHORT sobre RSI', style=plot.style_cross, color=color.red, linewidth=3)

// === Stoch RSI escalado === //
stochLen = input.int(14, title='Stoch RSI - Length')
smoothK  = input.int(3)
smoothD  = input.int(3)

rsi_stoch = ta.rsi(close, stochLen)
k_raw     = ta.stoch(rsi_stoch, rsi_stoch, rsi_stoch, stochLen)
k         = ta.sma(k_raw, smoothK) * 100
d         = ta.sma(k, smoothD) * 100

plot(mostrar_STOCH ? k : na, title='Stoch K', color=color.green)
plot(mostrar_STOCH ? d : na, title='Stoch D', color=color.purple)

// === Divergencias sobre Stoch RSI === //
bull_div_stoch = mostrar_DIVERGENCIAS and k[2] < k and low[2] < low
bear_div_stoch = mostrar_DIVERGENCIAS and k[2] > k and high[2] > high

plot(bull_div_stoch ? k : na, title='Divergencia Alcista en Stoch', style=plot.style_circles, color=color.lime, linewidth=2)
plot(bear_div_stoch ? k : na, title='Divergencia Bajista en Stoch', style=plot.style_circles, color=color.maroon, linewidth=2)

// === Confluencia RSI + Doble Señal + Divergencia === //
cond_short = shortSignal or shortSignal[1] or shortSignal[2]
cond_long  = longSignal or longSignal[1] or longSignal[2]

rsi_div_bull = rsi_val[2] < rsi_val and low[2] > low
rsi_div_bear = rsi_val[2] > rsi_val and high[2] < high

compra_fuerte = mostrar_confluencia_linea and cond_long and rsi_div_bull
venta_fuerte  = mostrar_confluencia_linea and cond_short and rsi_div_bear

plot(compra_fuerte ? 100 : na, title='Línea Compra Fuerte', style=plot.style_columns, color=color.green, linewidth=1)
plot(venta_fuerte  ?   100 : na, title='Línea Venta Fuerte',  style=plot.style_columns, color=color.red, linewidth=1)
