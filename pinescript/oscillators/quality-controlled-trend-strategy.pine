// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © AIScripts

//@version=6
strategy(
     title = "Quality-Controlled Trend Strategy",
     overlay = true,
     initial_capital = 100000,
     default_qty_type = strategy.percent_of_equity,
     default_qty_value = 5,
     commission_type = strategy.commission.percent,
     commission_value = 0.05,
     slippage = 1
)

// ==============================
// Inputs
// ==============================

// Trend & Entry
fastEmaLen = input.int(50, "Fast EMA Length")
slowEmaLen = input.int(200, "Slow EMA Length")
rsiLen     = input.int(14, "RSI Length")
rsiMid     = input.float(50, "RSI Midline")

// Risk (isolated block)
atrLen     = input.int(14, "ATR Length")
atrSLMult  = input.float(1.5, "Stop Loss ATR Multiplier")
rrRatio    = input.float(2.0, "Risk-Reward Ratio")

// ==============================
// Indicator Calculations
// ==============================

emaFast = ta.ema(close, fastEmaLen)
emaSlow = ta.ema(close, slowEmaLen)
rsiVal  = ta.rsi(close, rsiLen)
atrVal  = ta.atr(atrLen)

// ==============================
// Trend Context
// ==============================

trendUp   = emaFast > emaSlow
trendDown = emaFast < emaSlow

// ==============================
// Entry Logic (Confirmed Bar)
// ==============================

longCondition =
     trendUp and
     close > emaFast and
     rsiVal > rsiMid

shortCondition =
     trendDown and
     close < emaFast and
     rsiVal < rsiMid

// ==============================
// Entries
// ==============================

if longCondition and strategy.position_size == 0
    strategy.entry("Long", strategy.long)

if shortCondition and strategy.position_size == 0
    strategy.entry("Short", strategy.short)

// ==============================
// Risk Management (Editable Without Touching Entries)
// ==============================

longStop  = strategy.position_avg_price - atrVal * atrSLMult
longLimit = strategy.position_avg_price + atrVal * atrSLMult * rrRatio

shortStop  = strategy.position_avg_price + atrVal * atrSLMult
shortLimit = strategy.position_avg_price - atrVal * atrSLMult * rrRatio

strategy.exit("Long Exit",  from_entry = "Long",  stop = longStop,  limit = longLimit)
strategy.exit("Short Exit", from_entry = "Short", stop = shortStop, limit = shortLimit)

// ==============================
// Visuals
// ==============================

plot(emaFast, color=color.orange)
plot(emaSlow, color=color.blue)
