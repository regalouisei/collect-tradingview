//@version=5
indicator("Tanhâ€‘Clamped Momentum Oscillator [Alpha Extract]")

f_src(string src) =>
    float x = switch src
        'open'  => open
        'high'  => high
        'low'   => low
        'close' => close
        'oc2'   => math.avg(open, close)
        'hl2'   => math.avg(high, low)
        'hlc3'  => math.avg(high, low, close)
        'ohlc4' => math.avg(open, high, low, close)
        'hlcc4' => math.avg(high, low, close, close)
    x

f_tanh(float x) =>
    float xc = math.max(math.min(x, 5.0), -5.0)
    float e = math.exp(2.0 * xc)
    (e - 1.0) / (e + 1.0)

f_flux(string src, int fast, int slow, int atrlen, int smooth, int siglen, float scale, float clamp) =>
    float x = f_src(src)

    float ema_fast = ta.ema(x, fast)
    float ema_slow = ta.ema(x, slow)
    float trend = ema_fast - ema_slow

    float atr_s = ta.atr(atrlen)
    float atr_l = ta.atr(atrlen * 2)
    float vr = atr_l == 0 ? 1.0 : atr_s / atr_l
    float vw = math.max(math.min((vr - 0.5) / 1.0, 1.0), 0.0)

    float rng = math.max(high - low, syminfo.mintick)
    float pressure = (close - open) / rng
    float pressure_scaled = pressure * 100

    float trend_norm = atr_s == 0 ? 0.0 : (trend / atr_s) * 100
    float raw = trend_norm * vw + pressure_scaled * (1 - vw)
    float sm = ta.ema(raw, smooth)
    float o = f_tanh(sm / clamp) * scale
    float s = ta.sma(o, siglen)
    float h = o - s

    [o, s, h]

const string gw = "Oscillator", const string gb = "Bands", const string gu = "UI Options"

src   = input.string(defval = 'hlc3', title = "Source", options = ['open', 'high', 'low', 'close', 'oc2', 'hl2', 'hlc3', 'ohlc4', 'hlcc4'], group = gw)
fast  = input.int(defval = 8, title = "Fast EMA Length", minval = 3, maxval = 50, step = 1, group = gw)
slow  = input.int(defval = 21, title = "Slow EMA Length", minval = 5, maxval = 120, step = 1, group = gw)
atrln = input.int(defval = 14, title = "ATR Length", minval = 5, maxval = 50, step = 1, group = gw)
smth  = input.int(defval = 9, title = "Core Smoothing", minval = 1, maxval = 50, step = 1, group = gw)
slen  = input.int(defval = 6, title = "Signal Length", minval = 2, maxval = 30, step = 1, group = gw)
lsm   = input.int(defval = 6, title = "Curve Smoothing", minval = 1, maxval = 30, step = 1, group = gw)
hsm   = input.int(defval = 4, title = "Histogram Polish", minval = 1, maxval = 30, step = 1, group = gw)
sigm  = input.string(defval = "EMA", title = "Signal Mode", options = ["EMA", "SMA"], group = gw)
scale = input.float(defval = 120.0, title = "Scale", minval = 20.0, maxval = 200.0, step = 1.0, group = gw)
clamp = input.float(defval = 100.0, title = "Clamp", minval = 20.0, maxval = 200.0, step = 1.0, group = gw)

soft = input.int(defval = 88, title = "Soft Band", minval = 20, maxval = 150, step = 1, group = gb)
hard = input.int(defval = 56, title = "Hard Band", minval = 20, maxval = 150, step = 1, group = gb)
maxb = input.int(defval = 118, title = "Max Band", minval = 30, maxval = 200, step = 1, group = gb)
pulseLen = input.int(defval = 34, title = "Pulse Length", minval = 5, maxval = 100, step = 1, group = gb)
pulseMul = input.float(defval = 0.8, title = "Pulse Width", minval = 0.2, maxval = 2.0, step = 0.1, group = gb)

revb = input.bool(defval = true, title = "", inline = '0', group = gu)
revt = input.int(defval = 100, title = "Reversion Level", minval = 20, maxval = 150, step = 1, inline = '0', group = gu)
showSig = input.bool(defval = false, title = "Show Signal Line", group = gu)
showHist = input.bool(defval = true, title = "Histogram Columns", group = gu)
showPulse = input.bool(defval = true, title = "Pulse Band", group = gu)
showRibbon = input.bool(defval = true, title = "Ribbon Fill", group = gu)
colb = input.string(defval = "None", title = "Bar Coloring", options = ["None", "Midline Cross", "Extremities", "Reversions", "Slope"], group = gu)

[o_raw, s_raw, h_raw] = f_flux(src, fast, slow, atrln, smth, slen, scale, clamp)
float o = ta.ema(o_raw, lsm)
float sig = sigm == "EMA" ? ta.ema(o, slen) : ta.sma(o, slen)
float hist = ta.ema(o - sig, hsm)

const color colup = #22d3ee
const color coldn = #fb7185
const color colhu = #a5f3fc
const color colhd = #fecdd3
var   color colnt = chart.fg_color

midline = hline(0, "Zero", color.new(colnt, 70), hline.style_dotted)
softU = hline(+soft, "Soft +", color.new(colup, 80), hline.style_dotted)
softL = hline(-soft, "Soft -", color.new(coldn, 80), hline.style_dotted)
hardU = hline(+hard, "Hard +", color.new(colup, 70), hline.style_dashed)
hardL = hline(-hard, "Hard -", color.new(coldn, 70), hline.style_dashed)

color bg = o > maxb ? color.new(coldn, 85) :
     o < -maxb ? color.new(colup, 85) :
     o > hard ? color.new(coldn, 92) :
     o < -hard ? color.new(colup, 92) :
     na
bgcolor(bg)

float pulse = ta.ema(math.abs(o), pulseLen) * pulseMul
pulseU = plot(showPulse ? pulse : na, "Pulse Upper", color.new(colnt, 100), display = display.none)
pulseL = plot(showPulse ? -pulse : na, "Pulse Lower", color.new(colnt, 100), display = display.none)
color pulseCol = showPulse ? color.new(o >= 0 ? colup : coldn, 92) : na
fill(pulseU, pulseL, pulseCol)

color histColor = hist >= 0 ?
     (hist > hist[1] ? colup : color.new(colup, 55)) :
     (hist < hist[1] ? coldn : color.new(coldn, 55))
histplot = plot(showHist ? hist : na, "Flux Columns", histColor, 2, plot.style_columns)

baseplot = plot(o, "Flux Base", color.new(o > sig ? colup : coldn, 80), 8, plot.style_line)
mainplot = plot(o, "Flux", o > sig ? colup : coldn, 2, plot.style_line)
sigplot = plot(showSig ? sig : na, "Signal", color.new(colnt, 55), 1, plot.style_line)
sigfill = plot(sig, display = display.none)

color ribbonCol = showRibbon ? color.new(o > sig ? colup : coldn, 86) : na
fill(mainplot, sigfill, ribbonCol)

bool os = ta.crossover(o, sig) and o < -revt
bool ob = ta.crossunder(o, sig) and o >  revt
bool bull = ta.crossover(o, 0)
bool bear = ta.crossunder(o, 0)
bool swingUp = ta.crossover(o, sig)
bool swingDn = ta.crossunder(o, sig)

plotchar(revb ? ob ? o + 12 : na : na, "OB", "o", location.absolute, coldn, size = size.tiny)
plotchar(revb ? os ? o - 12 : na : na, "OS", "o", location.absolute, colup, size = size.tiny)

alertcondition(ob, "Overbought", 'OB Signal')
alertcondition(os, "Oversold", 'OS Signal')
alertcondition(bull, "Midline Crossover", 'Bullish Trend')
alertcondition(bear, "Midline Crossunder", 'Bearish Trend')
alertcondition(swingUp, "Oscillator Up", 'Bullish Swing')
alertcondition(swingDn, "Oscillator Down", 'Bearish Swing')

string msg = na
if os
    msg := "OS Signal"
else if ob
    msg := "OB Signal"
else if bull
    msg := "Bullish Trend"
else if bear
    msg := "Bearish Trend"
else if swingUp
    msg := "Bullish Swing"
else if swingDn
    msg := "Bearish Swing"

if not na(msg)
    alert(msg, alert.freq_once_per_bar_close)

color col = switch colb
    "Midline Cross" => o > 0 ? colup : coldn
    "Extremities"   => o > revt ? colup : o < -revt ? coldn : colnt
    "Reversions"    => ob ? coldn : os ? colup : colnt
    "Slope"         => o > sig ? colup : coldn
    "None"          => na

barcolor(col)
