//@version=5
indicator("MACD RSI EMA AGGRESSIVE + ATR SLTP", overlay=true)

// ===== INPUT =====
fastLen   = input.int(12)
slowLen   = input.int(26)
signalLen = input.int(9)

rsiLen  = input.int(14)
rsiBuy  = input.int(52)
rsiSell = input.int(48)

emaLen = input.int(21)

volLen    = input.int(20)
volFactor = input.float(1.05)

adxLen = input.int(14)
adxMin = input.int(14)

atrLen = input.int(14)
slATR  = input.float(0.8)
tpATR  = input.float(1.2)

// ===== INDICATORS =====
[macdLine, signalLine, _] = ta.macd(close, fastLen, slowLen, signalLen)
rsiVal = ta.rsi(close, rsiLen)
emaVal = ta.ema(close, emaLen)

volOK = volume > ta.sma(volume, volLen) * volFactor

// ===== ADX MANUAL (ANTI ERROR MOBILE) =====
upMove   = high - high[1]
downMove = low[1] - low

plusDM  = upMove > downMove and upMove > 0 ? upMove : 0
minusDM = downMove > upMove and downMove > 0 ? downMove : 0

trur = ta.rma(ta.tr(true), adxLen)
plusDI  = 100 * ta.rma(plusDM, adxLen) / trur
minusDI = 100 * ta.rma(minusDM, adxLen)

dx = 100 * math.abs(plusDI - minusDI) / (plusDI + minusDI)
adxVal = ta.rma(dx, adxLen)

trendOK = adxVal > adxMin
atrVal  = ta.atr(atrLen)

// ===== CONDITIONS =====
buyCond  = ta.crossover(macdLine, signalLine) and rsiVal > rsiBuy  and close > emaVal and volOK and trendOK
sellCond = ta.crossunder(macdLine, signalLine) and rsiVal < rsiSell and close < emaVal and volOK and trendOK

// ===== VISUAL =====
plot(emaVal, color=color.yellow, linewidth=2)

plotshape(buyCond,  style=shape.triangleup,   location=location.belowbar, color=color.lime, text="BUY")
plotshape(sellCond, style=shape.triangledown, location=location.abovebar, color=color.red,  text="SELL")

plot(buyCond  ? close - atrVal*slATR : na, color=color.red)
plot(buyCond  ? close + atrVal*tpATR : na, color=color.green)

plot(sellCond ? close + atrVal*slATR : na, color=color.red)
plot(sellCond ? close - atrVal*tpATR : na, color=color.green)
