//@version=6
// ==========================================
// █▀█ █▀█ █▄▄   █▀▄▀█ ▄▀█ ▀█▀ █▄█ █▀
// █▀▄ █▄█ █▄█   █░▀░█ █▀█ ░█░ █░█ ▄█
// ==========================================
// Indicator: Institutional BTC/XAU Alpha | RM
// Purpose: Detects correlation decoupling as a lead indicator for BTC surges.
// ==========================================
indicator("Institutional BTC/XAU Alpha | RM", shorttitle="BTC-XAU Crossing", overlay=false, precision=2)

// ————— Constants
color C_ORANGE = #ff9800
color C_BLUE   = #2196f3
color C_GRAY   = #95a5a6
color C_WHITE  = #ffffff
string TT_CORR = "Institutional standard is 52 weeks (1 year). When this drops to 0, it signals a structural regime shift."
string TT_ALPH = "The window (in weeks) after a decoupling signal where we measure Bitcoin's catch-up performance."

// ————— 0. User Inputs
string btc_id      = input.symbol("INDEX:BTCUSD", "Bitcoin Ticker", tooltip="Primary index for BTC price data.")
string gold_id     = input.symbol("TVC:GOLD", "Gold Ticker", tooltip="Benchmark for precious metal correlation.")
int    corr_len    = input.int(52, "Correlation Lookback (Weeks)", minval=1, tooltip=TT_CORR)
int    alpha_weeks = input.int(12, "Alpha Window (Weeks)", minval=1, tooltip=TT_ALPH)

// ————— 1. Data Acquisition
f_get(t) => request.security(t, timeframe.period, close)

float btc_p  = f_get(btc_id)
float gold_p = f_get(gold_id)
float ratio  = btc_p / gold_p

// ————— 2. Core Alpha Logic
// Rolling correlation between Digital Gold and Physical Gold
float correlation = ta.correlation(btc_p, gold_p, corr_len)

// Signal: The "Zero-Cross" (Decoupling)
bool is_decoupled = ta.crossunder(correlation, 0)

// ————— 3. Multi-Timeframe bar calculation
// Normalizes the week-based input to current chart bars
int bars_ahead = timeframe.isweekly ? alpha_weeks : timeframe.isdaily ? alpha_weeks * 7 : alpha_weeks * 7

// ————— 4. Visual Signals: M-Markers & Background Lines
var int m_count = 0

if is_decoupled
    m_count += 1
    // M-Signal Background Line (Orange)
    line.new(bar_index, 0, bar_index, 1, xloc=xloc.bar_index, extend=extend.both, color=color.new(C_ORANGE, 70), style=line.style_dotted, width=1)
    
    // Label Marker
    label.new(bar_index, ratio, "M" + str.tostring(m_count), 
         color=C_ORANGE, 
         textcolor=C_WHITE, 
         style=label.style_label_up, 
         tooltip="Signal M" + str.tostring(m_count) + ": BTC/Gold Correlation broke. Volatility expansion likely.")

// ————— 5. Alpha Window: Performance & Statistics
// Capturing entry values at the moment of the 'M' signal
float entry_ratio = ta.valuewhen(is_decoupled, ratio, 0)
float entry_btc   = ta.valuewhen(is_decoupled, btc_p, 0)
bool  is_target   = ta.barssince(is_decoupled) == bars_ahead

if is_target
    float r_perf = ((ratio - entry_ratio) / entry_ratio) * 100
    float b_perf = ((btc_p - entry_btc) / entry_btc) * 100
    
    // Result Target Line (Blue)
    line.new(bar_index, 0, bar_index, 1, xloc=xloc.bar_index, extend=extend.both, color=color.new(C_BLUE, 75), style=line.style_dashed, width=1)
    
    // Stats Overlay
    string stats_txt = str.tostring(alpha_weeks) + "W Result:\nRatio: " + str.tostring(math.round(r_perf, 1)) + "%\nBTC: " + str.tostring(math.round(b_perf, 1)) + "%"
    label.new(bar_index, ratio, stats_txt, 
         color=color.new(C_BLUE, 15), 
         textcolor=C_WHITE, 
         style=label.style_label_left, 
         size=size.small, 
         tooltip="Performance measured " + str.tostring(alpha_weeks) + " weeks post-signal.")

// ————— 6. Global Aesthetics & Bottom Cloud
plot(ratio, "BTC/Gold Ratio", color=C_ORANGE, linewidth=3)

// Correlation Oscillator "Cloud" - Scaled to sit at the bottom of the ratio pane
plot(correlation * 5 + 20, "Correlation Area", color=color.new(C_BLUE, 85), style=plot.style_area, histbase=20)
hline(20, "Zero Level", color=C_GRAY, linestyle=hline.style_dashed)
