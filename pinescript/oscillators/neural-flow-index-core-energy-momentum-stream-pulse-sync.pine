// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © ozgurzari

//@version=6
indicator("NEURAL FLOW INDEX — Core Energy • Momentum Stream • Pulse Sync", overlay=false, max_labels_count=500)

//=========================
// PARAMETERS
//=========================
lenTrend = input.int(34, "Trend EMA Length", minval=2)
lenRSI   = input.int(14, "RSI Length", minval=2)
lenATR   = input.int(14, "ATR Length", minval=2)
multATR  = input.float(1.5, "ATR Multiplier", step=0.1)
smoothRSO = input.int(3, "RSO Smoothing", minval=1)

wtChannelLen = input.int(10, "WaveTrend Channel Length")
wtAverageLen = input.int(21, "WaveTrend Average Length")
stochLen = input.int(14, "Stoch RSI Length")
kLen     = input.int(3,  "Stoch RSI %K Smoothing")
dLen     = input.int(3,  "Stoch RSI %D Smoothing")

//=========================
// 1️⃣ CORE ENERGY CURVE (RSO)
//=========================
src = close
fastMA = ta.ema(src, lenTrend / 2)
slowMA = ta.ema(src, lenTrend)
trend  = fastMA - slowMA
trendDir = trend > 0 ? 1 : -1

rsi = ta.rsi(src, lenRSI)
rsiDir = rsi > rsi[1] ? 1 : -1

atr = ta.atr(lenATR)
upper = slowMA + atr * multATR
lower = slowMA - atr * multATR
volDir = close > upper ? 1 : close < lower ? -1 : 0

coreEnergy = ta.ema((trendDir + rsiDir + volDir) / 3, smoothRSO)

//=========================
// 2️⃣ MOMENTUM STREAM (WaveTrend)
//=========================
esa = ta.ema(src, wtChannelLen)
de  = ta.ema(math.abs(src - esa), wtChannelLen)
ci  = (src - esa) / (0.015 * de)
tci = ta.ema(ci, wtAverageLen)
momentumStream = ta.sma(tci, 4)

// Normalize to match -1..1 range
wtMin = ta.lowest(momentumStream, 100)
wtMax = ta.highest(momentumStream, 100)
momentumStreamNorm = (momentumStream - wtMin) / (wtMax - wtMin) * 2 - 1

//=========================
// 3️⃣ PULSE SYNC (Stochastic RSI)
//=========================
rsiValue = ta.rsi(src, lenRSI)
rsiMin = ta.lowest(rsiValue, stochLen)
rsiMax = ta.highest(rsiValue, stochLen)
stochRSI = (rsiValue - rsiMin) / (rsiMax - rsiMin)
pulseK = ta.sma(stochRSI, kLen)
pulseD = ta.sma(pulseK, dLen)
pulseSync = (pulseK - 0.5) * 2  // normalize to -1..1

//=========================
// VISUALS
//=========================
hline(0, "Center Line", color=color.new(color.gray, 75))

// Core Energy (RSO)
plot(coreEnergy, title="Core Energy Curve", color=coreEnergy > 0 ? color.new(color.lime, 25) : color.new(color.red, 25), style=plot.style_area)
plot(coreEnergy, color=color.new(color.white, 0), linewidth=1)

// Momentum Stream (WaveTrend)
plot(momentumStreamNorm, title="Momentum Stream", color=color.new(color.teal, 0), linewidth=2)

// Pulse Sync (Stochastic RSI)
plot(pulseSync, title="Pulse Sync", color=color.new(color.purple, 0), linewidth=1)

//=========================
// LABEL
//=========================
if barstate.islast
    label.new(bar_index, 1.5, "Neural Flow Index (NFI): Core Energy • Momentum Stream • Pulse Sync",
      style=label.style_label_left, color=color.new(color.black, 80), textcolor=color.white)
