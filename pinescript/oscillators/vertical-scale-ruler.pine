//@version=5
indicator("纵向比例尺 (Vertical Scale Ruler)", overlay=true)

// ==========================================
// 1. 用户输入设置 (Settings)
// ==========================================
grp_val   = "核心设置"
priceDist = input.float(100.0, "标尺代表的价格距离", group=grp_val, tooltip="例如：BTC输入500代表500U的高度，外汇输入0.0050代表50点")
pos_x     = input.int(10, "水平位置 (向右偏移K线数)", group=grp_val, tooltip="数字越大，标尺越靠右")
pos_y     = input.float(0.0, "垂直微调 (价格单位)", group=grp_val, tooltip="正数向上移动，负数向下移动。默认0是以当前价格为中心")

grp_style = "外观样式"
lineColor = input.color(color.rgb(33, 150, 243, 0), "标尺颜色", group=grp_style)
lineWidth = input.int(2, "线条粗细", minval=1, group=grp_style)
showText  = input.bool(true, "显示数值标签", group=grp_style)
textColor = input.color(color.white, "文字颜色", group=grp_style)
textSize  = input.string(size.small, "文字大小", options=[size.tiny, size.small, size.normal, size.large], group=grp_style)

// ==========================================
// 2. 变量初始化 (Initialization)
// ==========================================
// 使用 var 关键字声明对象，确保只创建一次，后续只更新坐标，节省资源
var line mainLine   = line.new(na, na, na, na, style=line.style_solid)
var line topCap     = line.new(na, na, na, na, style=line.style_solid)
var line btmCap     = line.new(na, na, na, na, style=line.style_solid)
var label distLabel = label.new(na, na, text="", style=label.style_label_left)

// ==========================================
// 3. 逻辑计算与绘图 (Logic & Drawing)
// ==========================================
// 只在最后一个实时K线上更新位置
if barstate.islast
    // --- 1. 计算坐标 ---
    // 基础中心点：默认为当前收盘价，加上用户的垂直偏移
    float centerPrice = close + pos_y
    
    // 计算顶部和底部的价格位置
    float topPrice    = centerPrice + (priceDist / 2)
    float bottomPrice = centerPrice - (priceDist / 2)
    
    // 计算X轴位置：当前K线索引 + 用户设定的向右偏移量
    int xPosition = bar_index + pos_x
    
    // --- 2. 更新主标尺线 ---
    line.set_xy1(mainLine, xPosition, topPrice)
    line.set_xy2(mainLine, xPosition, bottomPrice)
    line.set_color(mainLine, lineColor)
    line.set_width(mainLine, lineWidth)
    
    // --- 3. 更新顶部和底部短横线 (模拟卡尺效果) ---
    // 横线的宽度设为大概3根K线的距离，让它看起来像个"工"字
    int capWidth = 3 
    
    // 顶部横线
    line.set_xy1(topCap, xPosition - 1, topPrice) // 左一点
    line.set_xy2(topCap, xPosition + 1, topPrice) // 右一点
    line.set_color(topCap, lineColor)
    line.set_width(topCap, lineWidth)
    
    // 底部横线
    line.set_xy1(btmCap, xPosition - 1, bottomPrice)
    line.set_xy2(btmCap, xPosition + 1, bottomPrice)
    line.set_color(btmCap, lineColor)
    line.set_width(btmCap, lineWidth)
    
    // --- 4. 更新标签文字 ---
    if showText
        // 将标签放在标尺的右侧中心
        label.set_xy(distLabel, xPosition + 2, centerPrice)
        // 格式化显示的文字，保留合适的精度（去除多余的0）
        label.set_text(distLabel, str.tostring(priceDist, format.mintick) + " dist")
        label.set_color(distLabel, color.new(color.black, 100)) // 背景透明
        label.set_textcolor(distLabel, textColor)
        label.set_size(distLabel, textSize)
    else
        label.set_text(distLabel, "")
