//@version=5
indicator("Crypto Swing Pro [All-in-One] v2 [R2D2]", overlay=true, shorttitle="CSP [Pro] v2")

// ==========================================
// 1. INPUTS & CONFIGURATION
// ==========================================
grp_ema = "--- EMA Settings ---"
show_ema20  = input.bool(true, "Show EMA 20 (Momentum)", group=grp_ema)
show_ema50  = input.bool(true, "Show EMA 50 (Trend)", group=grp_ema)
show_ema200 = input.bool(true, "Show EMA 200 (Macro)", group=grp_ema)

grp_bb  = "--- Bollinger Bands ---"
show_bb = input.bool(true, "Show Bollinger Bands", group=grp_bb)
bb_len  = input.int(20, "BB Length", group=grp_bb)
bb_mult = input.float(2.0, "BB StdDev", group=grp_bb)

grp_osc = "--- Oscillator Signals (Visuals) ---"
show_rsi_bg  = input.bool(true, "Color Background on RSI Extremes", group=grp_osc)
show_macd_lbl = input.bool(true, "Show MACD Buy/Sell Labels", group=grp_osc)
show_obv_col  = input.bool(false, "Color Bars based on OBV Trend", group=grp_osc)

grp_dash = "--- Data Dashboard ---"
show_dash = input.bool(true, "Show Dashboard", group=grp_dash)
dash_pos  = input.string("Top Right", "Position", options=["Top Right", "Bottom Right", "Top Left", "Bottom Left"], group=grp_dash)
dash_size = input.string("Small", "Size", options=["Tiny", "Small", "Normal"], group=grp_dash)

// ==========================================
// 2. CALCULATIONS
// ==========================================
// --- EMA ---
ema20  = ta.ema(close, 20)
ema50  = ta.ema(close, 50)
ema200 = ta.ema(close, 200)

// --- Bollinger Bands ---
[bb_middle, bb_upper, bb_lower] = ta.bb(close, bb_len, bb_mult)
bb_squeeze = (bb_upper - bb_lower) / bb_middle // Bandwidth
// Logic: If current bandwidth is lowest in last 20 bars, it's a squeeze
is_squeeze = bb_squeeze < ta.lowest(bb_squeeze, 20)[1]

// --- RSI ---
rsi_len = 14
rsi = ta.rsi(close, rsi_len)
rsi_ob = 70
rsi_os = 30
is_rsi_ob = rsi >= rsi_ob
is_rsi_os = rsi <= rsi_os

// --- MACD ---
[macd_line, signal_line, _] = ta.macd(close, 12, 26, 9)
macd_cross_up = ta.crossover(macd_line, signal_line)
macd_cross_dn = ta.crossunder(macd_line, signal_line)

// --- OBV ---
obv = ta.obv
obv_ma = ta.sma(obv, 20)
obv_trending_up = obv > obv_ma
obv_trending_dn = obv < obv_ma

// ==========================================
// 3. PLOTTING (OVERLAY)
// ==========================================

// EMAs
plot(show_ema20 ? ema20 : na, "EMA 20", color=color.new(color.yellow, 0), linewidth=2)
plot(show_ema50 ? ema50 : na, "EMA 50", color=color.new(color.orange, 0), linewidth=2)
plot(show_ema200 ? ema200 : na, "EMA 200", color=color.new(color.white, 0), linewidth=3)

// Bollinger Bands
p_upper = plot(show_bb ? bb_upper : na, "BB Upper", color=color.new(color.blue, 50))
p_lower = plot(show_bb ? bb_lower : na, "BB Lower", color=color.new(color.blue, 50))
fill(p_upper, p_lower, color=show_bb ? color.new(color.blue, 95) : na)

// RSI Background Highlights
bgcolor(show_rsi_bg and is_rsi_os ? color.new(color.green, 85) : na, title="RSI Oversold BG")
bgcolor(show_rsi_bg and is_rsi_ob ? color.new(color.red, 85) : na, title="RSI Overbought BG")

// MACD Signals (Labels)
plotshape(show_macd_lbl and macd_cross_up, title="MACD Buy", location=location.belowbar, color=color.green, style=shape.labelup, text="MACD", textcolor=color.white, size=size.tiny)
plotshape(show_macd_lbl and macd_cross_dn, title="MACD Sell", location=location.abovebar, color=color.red, style=shape.labeldown, text="MACD", textcolor=color.white, size=size.tiny)

// OBV Bar Coloring
barcolor(show_obv_col ? (obv_trending_up ? color.lime : color.red) : na)

// ==========================================
// 4. PROFESSIONAL DASHBOARD
// ==========================================

var table_pos = position.top_right
if dash_pos == "Bottom Right"
    table_pos := position.bottom_right
else if dash_pos == "Top Left"
    table_pos := position.top_left
else if dash_pos == "Bottom Left"
    table_pos := position.bottom_left

var table_size = size.small
if dash_size == "Tiny"
    table_size := size.tiny
else if dash_size == "Normal"
    table_size := size.normal

var tbl = table.new(table_pos, 2, 6, bgcolor=color.new(color.black, 40), border_width=1, border_color=color.gray, frame_color=color.gray, frame_width=1)

if show_dash and barstate.islast
    // Header
    table.cell(tbl, 0, 0, "INDICATOR", text_color=color.white, bgcolor=color.new(color.blue, 60), text_size=table_size)
    table.cell(tbl, 1, 0, "STATUS", text_color=color.white, bgcolor=color.new(color.blue, 60), text_size=table_size)

    // RSI Row
    rsi_col = rsi > 50 ? color.green : color.red
    if is_rsi_ob 
        rsi_col := color.red
    if is_rsi_os 
        rsi_col := color.green
    table.cell(tbl, 0, 1, "RSI (14)", text_color=color.white, text_size=table_size)
    table.cell(tbl, 1, 1, str.tostring(rsi, "#.##"), text_color=rsi_col, text_size=table_size, bgcolor=color.new(rsi_col, 90))

    // MACD Row
    macd_txt = macd_line > signal_line ? "BULLISH" : "BEARISH"
    macd_col = macd_line > signal_line ? color.green : color.red
    table.cell(tbl, 0, 2, "MACD", text_color=color.white, text_size=table_size)
    table.cell(tbl, 1, 2, macd_txt, text_color=macd_col, text_size=table_size, bgcolor=color.new(macd_col, 90))

    // Trend Row
    trend_txt = close > ema200 ? "UPTREND" : "DOWNTREND"
    trend_col = close > ema200 ? color.green : color.red
    table.cell(tbl, 0, 3, "TREND (200 EMA)", text_color=color.white, text_size=table_size)
    table.cell(tbl, 1, 3, trend_txt, text_color=trend_col, text_size=table_size, bgcolor=color.new(trend_col, 90))

    // Volatility Row
    bb_txt = "NORMAL"
    bb_col_txt = color.white
    if is_squeeze
        bb_txt := "SQUEEZE"
        bb_col_txt := color.yellow
    table.cell(tbl, 0, 4, "VOLATILITY", text_color=color.white, text_size=table_size)
    table.cell(tbl, 1, 4, bb_txt, text_color=bb_col_txt, text_size=table_size)

    // OBV Row
    obv_txt = obv_trending_up ? "ACCUMULATION" : "DISTRIBUTION"
    obv_col_dash = obv_trending_up ? color.green : color.red
    table.cell(tbl, 0, 5, "VOLUME (OBV)", text_color=color.white, text_size=table_size)
    table.cell(tbl, 1, 5, obv_txt, text_color=obv_col_dash, text_size=table_size, bgcolor=color.new(obv_col_dash, 90))

// ==========================================
// 5. ALERTS
// ==========================================

alertcondition(macd_cross_up, title="[CSP] MACD Buy Signal", message="CSP Alert: MACD Bullish Crossover")
alertcondition(macd_cross_dn, title="[CSP] MACD Sell Signal", message="CSP Alert: MACD Bearish Crossover")
alertcondition(is_rsi_os, title="[CSP] RSI Oversold (<30)", message="CSP Alert: RSI is Oversold (Buy Zone)")
alertcondition(is_rsi_ob, title="[CSP] RSI Overbought (>70)", message="CSP Alert: RSI is Overbought (Sell Zone)")
alertcondition(is_squeeze, title="[CSP] Volatility Squeeze", message="CSP Alert: Bollinger Bands Squeeze Detected (Get Ready)")
alertcondition(ta.crossover(close, ema200), title="[CSP] Price Cross Over 200 EMA", message="CSP Alert: Bullish Trend Change (Above 200 EMA)")
