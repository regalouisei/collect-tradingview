//@version=6
indicator("Improved Scalping Consolidation and Squeeze Indicator", shorttitle="ScalpSQZ", overlay=true)

//─────────────────────
// Inputs
//─────────────────────
rsi_period      = input.int(7,   title="RSI Period",                 minval=1)
macd_short      = input.int(5,   title="MACD Short Period",          minval=1)
macd_long       = input.int(13,  title="MACD Long Period",           minval=1)
macd_signal     = input.int(5,   title="MACD Signal Period",         minval=1)

bb_period       = input.int(10,  title="Bollinger Bands Period",     minval=1)
bb_stddev       = input.float(2, title="Bollinger Bands Std Dev",    minval=0.1)

kc_period       = input.int(10,  title="Keltner Channel Period",     minval=1)
kc_multiplier   = input.float(1.0, title="Keltner Channel Multiplier", minval=0.1)

roc_period      = input.int(6,   title="Rate of Change Period",      minval=1)

use_strength_filters   = input.bool(true, title="Require N Bars in a Row?")
consolidation_strength = input.int(3, title="Consolidation Strength (bars in a row)", minval=1)
squeeze_strength       = input.int(3, title="Squeeze Strength (bars in a row)",       minval=1)

//─────────────────────
// Core Calculations
//─────────────────────
rsi_val = ta.rsi(close, rsi_period)

// MACD
fast_ema    = ta.ema(close, macd_short)
slow_ema    = ta.ema(close, macd_long)
macd_line   = fast_ema - slow_ema
signal_line = ta.ema(macd_line, macd_signal)
histogram   = macd_line - signal_line

// ROC
roc = close / close[roc_period] - 1.0

// Bollinger Bands
bb_basis = ta.sma(close, bb_period)
bb_dev   = ta.stdev(close, bb_period)
upper_bb = bb_basis + bb_stddev * bb_dev
lower_bb = bb_basis - bb_stddev * bb_dev

// Keltner Channels
kc_basis = ta.sma(close, kc_period)
kc_atr   = ta.atr(kc_period)
upper_kc = kc_basis + kc_multiplier * kc_atr
lower_kc = kc_basis - kc_multiplier * kc_atr

//─────────────────────
// Raw Conditions (single-bar)
//─────────────────────
consolidation_raw   = (rsi_val > 45 and rsi_val < 55) and (math.abs(histogram) < 0.001 * close) and (math.abs(roc) < 0.015)
squeeze_raw         = (lower_bb > lower_kc) and (upper_bb < upper_kc)
momentum_exhaustion = rsi_val > 70 and (histogram < histogram[1])

// NEW: selling exhaustion (bottom signal → purple candle)
selling_exhaustion = (
    rsi_val < 32 and                // oversold RSI
    histogram > histogram[1] and    // momentum improving
    close > low[1]                  // buyers defending prior low
)

// track consecutive bars of improving momentum in oversold
var float seCount = 0.0
seCount := selling_exhaustion ? seCount[1] + 1 : 0

// only mark purple when we’ve had 2–3 bars of improvement
strong_selling_exhaustion = seCount >= 3

//─────────────────────
// N-bar strength counts
//─────────────────────
var float consCount    = 0.0
var float squeezeCount = 0.0

consCount    := consolidation_raw ? consCount[1] + 1 : 0
squeezeCount := squeeze_raw       ? squeezeCount[1] + 1 : 0

strong_consolidation = consCount    >= consolidation_strength
strong_squeeze       = squeezeCount >= squeeze_strength

// choose whether to use N-bar filter or raw
cond_consolidation = use_strength_filters ? strong_consolidation : consolidation_raw
cond_squeeze       = use_strength_filters ? strong_squeeze       : squeeze_raw

//─────────────────────
// Bar Colors (priority: Squeeze → Consolidation → Top Exhaustion → Bottom Exhaustion)
//─────────────────────
bar_col = (
     cond_squeeze        ? color.orange :
     cond_consolidation  ? color.yellow :
     momentum_exhaustion ? color.white  :
     strong_selling_exhaustion ? color.purple :
     na
)

barcolor(bar_col)
