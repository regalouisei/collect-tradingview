//@lfu
//DO YOUR OWN RESEARCH
//@version=6
indicator("AJFFRSI+QQEROC", overlay=true, max_lines_count=500, max_labels_count=500)

// ============================
// Inputs
rsi_len    = input.int(14, "AJFFRSI Length")
qqe_src    = input.source(close, "QQE Source")
qqe_len    = input.int(14, "QQE Length")
qqe_factor = input.float(4.236, "QQE Factor")
qqe_smooth = input.int(5, "QQE Smooth")
qqe_weight = input.float(2, "QQE Weight")
colorbars  = input.bool(true, "Color bars?")

// ============================
// AJFFRSI (RSX) Layer
_rsx_rsi(src,len)=>
    src_out = 100 * src
    mom0 = ta.change(src_out)
    moa0 = math.abs(mom0)
    Kg = 3 / (len + 2)
    Hg = 1 - Kg
    f28 = 0.0, f30 = 0.0
    f28 := Kg * mom0 + Hg * nz(f28[1])
    f30 := Hg * nz(f30[1]) + Kg * f28
    mom1 = f28 * 1.5 - f30 * 0.5
    f38 = 0.0, f40 = 0.0
    f38 := Hg * nz(f38[1]) + Kg * mom1
    f40 := Kg * f38 + Hg * nz(f40[1])
    mom2 = f38 * 1.5 - f40 * 0.5
    f48 = 0.0, f50 = 0.0
    f48 := Hg * nz(f48[1]) + Kg * mom2
    f50 := Kg * f48 + Hg * nz(f50[1])
    mom_out = f48 * 1.5 - f50 * 0.5
    f58 = 0.0, f60 = 0.0
    f58 := Hg * nz(f58[1]) + Kg * moa0
    f60 := Kg * f58 + Hg * nz(f60[1])
    moa1 = f58 * 1.5 - f60 * 0.5
    f68 = 0.0, f70 = 0.0
    f68 := Hg * nz(f68[1]) + Kg * moa1
    f70 := Kg * f68 + Hg * nz(f70[1])
    moa2 = f68 * 1.5 - f70 * 0.5
    f78 = 0.0, f80 = 0.0
    f78 := Hg * nz(f78[1]) + Kg * moa2
    f80 := Kg * f78 + Hg * nz(f80[1])
    moa_out = f78 * 1.5 - f80 * 0.5
    math.max(math.min((mom_out / moa_out + 1.0) * 50.0, 100.0), 0.0)

ajf_rsi = _rsx_rsi(close, rsi_len)
plot(ajf_rsi, color=color.white, linewidth=2, title="AJFFRSI")

// ============================
// QQE Layer
var float ts = 0.0
var float rsi_qqe = 0.0
delta = qqe_src - qqe_src[1]
w = nz((delta * (ajf_rsi - ts) > 0) ? qqe_weight : 1, 1)
num = ta.rma(delta * w, qqe_len)
den = ta.rma(math.abs(delta * w), qqe_len)
rsi_qqe := 50 * ta.ema(num / den, qqe_smooth) + 50
diff = ta.rma(math.abs(rsi_qqe - rsi_qqe[1]), qqe_len)

crossover_cond  = rsi_qqe > ts and rsi_qqe[1] <= ts[1]
crossunder_cond = rsi_qqe < ts and rsi_qqe[1] >= ts[1]

ts := nz(crossover_cond ? rsi_qqe - diff * qqe_factor :
         crossunder_cond ? rsi_qqe + diff * qqe_factor :
         rsi_qqe > ts ? math.max(rsi_qqe - diff * qqe_factor, ts) :
         math.min(rsi_qqe + diff * qqe_factor, ts), rsi_qqe)

qqe_color = rsi_qqe > ts ? color.teal : color.red
plot(rsi_qqe, color=color.blue, title="QQE RSI")
plot(ts, color=qqe_color, title="QQE Trailing Stop")
fill(plot(rsi_qqe), plot(ts), color=color.new(color.blue, 90))

// ============================
// Sniper signals: RSI crosses QQE trailing stop
bull_cross = ajf_rsi > ts and ajf_rsi[1] <= ts[1]
bear_cross = ajf_rsi < ts and ajf_rsi[1] >= ts[1]

plotshape(bull_cross, style=shape.triangleup, location=location.belowbar, color=color.green, size=size.large, title="Bull Cross")
plotshape(bear_cross, style=shape.triangledown, location=location.abovebar, color=color.red, size=size.large, title="Bear Cross")
barcolor(colorbars ? (bull_cross ? color.new(color.green,0) : bear_cross ? color.new(color.red,0) : na) : na)

// ============================
// Threshold Inputs
upper_threshold = input.float(70, "Upper Threshold")
lower_threshold = input.float(30, "Lower Threshold")

// ============================
// Plot Threshold Lines
plot(upper_threshold, title="Upper Threshold", color=color.new(color.red, 50), style=plot.style_linebr, linewidth=1)
plot(lower_threshold, title="Lower Threshold", color=color.new(color.green, 50), style=plot.style_linebr, linewidth=1)


// ============================
// Alerts for Bull/Bear Cross
alertcondition(bull_cross, title="Bull Cross Alert", message="AJFFRSI crossed above QQE trailing stop – Bullish Signal")
alertcondition(bear_cross, title="Bear Cross Alert", message="AJFFRSI crossed below QQE trailing stop – Bearish Signal")
