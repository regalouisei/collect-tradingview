// MDZ Strategy v4.2 - Final Optimized Version

//@version=6
strategy("MDZ Strategy v4.2", shorttitle="MDZ v4.2", overlay=true,
     default_qty_type=strategy.percent_of_equity, default_qty_value=100,
     initial_capital=10000, commission_type=strategy.commission.percent,
     commission_value=0.02, slippage=1, pyramiding=0,
     calc_on_every_tick=false, max_bars_back=500)

// ══════════════════════════════════════════════════════════════════════════════
// PRESETS - Based on extensive backtesting
// ══════════════════════════════════════════════════════════════════════════════

preset = input.string("3H Optimized", "Preset", 
     options=["Custom", "1H Standard", "2H Low DD", "3H Optimized", "4H Swing"],
     group="═══ STRATEGY ═══",
     tooltip="3H Optimized: Best overall (66% WR, 2.2 PF). 2H Low DD: Lowest drawdown.")

// Preset configurations based on QQQ backtests
p_emaFast = switch preset
    "1H Standard" => 20
    "2H Low DD" => 20
    "3H Optimized" => 20
    "4H Swing" => 20
    => 20

p_emaSlow = switch preset
    "1H Standard" => 50
    "2H Low DD" => 50
    "3H Optimized" => 50
    "4H Swing" => 50
    => 50

p_emaTrend = switch preset
    "1H Standard" => 200
    "2H Low DD" => 200
    "3H Optimized" => 200
    "4H Swing" => 200
    => 200

p_slATR = switch preset
    "1H Standard" => 2.5
    "2H Low DD" => 2.5
    "3H Optimized" => 2.5
    "4H Swing" => 3.0
    => 2.5

p_tpATR = switch preset
    "1H Standard" => 6.0
    "2H Low DD" => 6.0
    "3H Optimized" => 6.0
    "4H Swing" => 7.5
    => 6.0

p_trailATR = switch preset
    "1H Standard" => 2.0
    "2H Low DD" => 2.0
    "3H Optimized" => 2.0
    "4H Swing" => 2.5
    => 2.0

// ══════════════════════════════════════════════════════════════════════════════
// INPUTS
// ══════════════════════════════════════════════════════════════════════════════

emaFastLen = input.int(20, "Fast EMA", minval=5, maxval=50, group="EMAs")
emaSlowLen = input.int(50, "Slow EMA", minval=10, maxval=100, group="EMAs")
emaTrendLen = input.int(200, "Trend EMA", minval=50, maxval=300, group="EMAs")

rsiLen = input.int(14, "RSI Length", minval=5, maxval=21, group="RSI")
rsiMin = input.int(45, "RSI Min", minval=30, maxval=60, group="RSI",
     tooltip="Only enter when RSI above this (confirms momentum)")
rsiMax = input.int(75, "RSI Max", minval=60, maxval=85, group="RSI",
     tooltip="Don't enter when RSI above this (avoids overbought)")

adxMin = input.int(20, "Min ADX", minval=15, maxval=35, group="ADX",
     tooltip="Minimum trend strength to enter")

slATRInput = input.float(2.5, "Stop Loss ATR", minval=1.0, maxval=5.0, step=0.5, group="Risk")
tpATRInput = input.float(6.0, "Take Profit ATR", minval=2.0, maxval=12.0, step=0.5, group="Risk")
useTrailing = input.bool(true, "Use Trailing Stop", group="Risk")
trailATRInput = input.float(2.0, "Trail ATR", minval=0.5, maxval=4.0, step=0.5, group="Risk")

useSession = input.bool(false, "Session Filter", group="Session",
     tooltip="Disable for 3H+ timeframes")
sessionStart = input.int(1000, "Start (HHMM)", group="Session")
sessionEnd = input.int(1600, "End (HHMM)", group="Session")

// Apply presets
emaFast = preset == "Custom" ? emaFastLen : p_emaFast
emaSlow = preset == "Custom" ? emaSlowLen : p_emaSlow
emaTrend = preset == "Custom" ? emaTrendLen : p_emaTrend
slATR = preset == "Custom" ? slATRInput : p_slATR
tpATR = preset == "Custom" ? tpATRInput : p_tpATR
trailATRVal = preset == "Custom" ? trailATRInput : p_trailATR

// ══════════════════════════════════════════════════════════════════════════════
// INDICATORS
// ══════════════════════════════════════════════════════════════════════════════

ema20 = ta.ema(close, emaFast)
ema50 = ta.ema(close, emaSlow)
ema200 = ta.ema(close, emaTrend)

rsi = ta.rsi(close, rsiLen)

macdLine = ta.ema(close, 12) - ta.ema(close, 26)
signalLine = ta.ema(macdLine, 9)
histLine = macdLine - signalLine

// ADX
adxLength = 14
up = ta.change(high)
down = -ta.change(low)
plusDM = na(up) ? na : (up > down and up > 0 ? up : 0)
minusDM = na(down) ? na : (down > up and down > 0 ? down : 0)
trur = ta.rma(ta.tr, adxLength)
plusDI = 100 * ta.rma(plusDM, adxLength) / trur
minusDI = 100 * ta.rma(minusDM, adxLength) / trur
adxValue = 100 * ta.rma(math.abs(plusDI - minusDI) / (plusDI + minusDI), adxLength)

atr = ta.atr(14)

// ══════════════════════════════════════════════════════════════════════════════
// CONDITIONS
// ══════════════════════════════════════════════════════════════════════════════

// Strong uptrend: EMAs stacked bullish
strongUptrend = close > ema20 and ema20 > ema50 and ema50 > ema200
trendStrong = adxValue > adxMin

// Entry: Trend + Momentum confirmed
longSignal = strongUptrend and 
             rsi > rsiMin and rsi < rsiMax and 
             macdLine > signalLine and 
             histLine > histLine[1] and 
             trendStrong and
             plusDI > minusDI

// Session (optional)
currentTime = hour * 100 + minute
inSession = useSession == false or (currentTime >= sessionStart and currentTime <= sessionEnd)

// Entry
enterLong = longSignal and inSession and strategy.position_size == 0

// ══════════════════════════════════════════════════════════════════════════════
// EXECUTION
// ══════════════════════════════════════════════════════════════════════════════

if enterLong
    strategy.entry("Long", strategy.long)

if strategy.position_size > 0
    entryPrice = strategy.position_avg_price
    stopPrice = entryPrice - atr * slATR
    limitPrice = entryPrice + atr * tpATR
    
    if useTrailing
        strategy.exit("Exit", "Long", stop=stopPrice, limit=limitPrice, 
             trail_points=atr * trailATRVal / syminfo.mintick, 
             trail_offset=atr * trailATRVal / syminfo.mintick)
    else
        strategy.exit("Exit", "Long", stop=stopPrice, limit=limitPrice)

// ══════════════════════════════════════════════════════════════════════════════
// PLOTTING
// ══════════════════════════════════════════════════════════════════════════════

bullColor = #00C853
bearColor = #FF1744

plot(ema20, "EMA 20", color=color.new(color.blue, 30))
plot(ema50, "EMA 50", color=color.new(color.orange, 30))
plot(ema200, "EMA 200", color=color.new(color.purple, 30), linewidth=2)

bgcolor(strongUptrend ? color.new(bullColor, 92) : na)
plotshape(enterLong, "Long", shape.triangleup, location.belowbar, color.new(bullColor, 0), size=size.normal)

// ══════════════════════════════════════════════════════════════════════════════
// INFO PANEL
// ══════════════════════════════════════════════════════════════════════════════

var table panel = table.new(position.top_right, 2, 8, bgcolor=color.new(#1a1a2e, 10), border_width=1, border_color=color.new(color.gray, 50))

if barstate.islast
    table.cell(panel, 0, 0, "MDZ v4.2", text_color=color.white, text_size=size.small, bgcolor=color.new(color.blue, 40))
    table.cell(panel, 1, 0, preset, text_color=color.yellow, text_size=size.small, bgcolor=color.new(color.blue, 40))
    
    table.cell(panel, 0, 1, "Trend", text_color=color.gray, text_size=size.tiny)
    table.cell(panel, 1, 1, strongUptrend ? "STRONG ↑" : "WAIT", text_color=strongUptrend ? color.new(bullColor, 0) : color.gray, text_size=size.tiny)
    
    table.cell(panel, 0, 2, "ADX", text_color=color.gray, text_size=size.tiny)
    table.cell(panel, 1, 2, str.tostring(adxValue, "#.#"), text_color=adxValue > adxMin ? color.new(bullColor, 0) : color.new(bearColor, 0), text_size=size.tiny)
    
    table.cell(panel, 0, 3, "RSI", text_color=color.gray, text_size=size.tiny)
    rsiOK = rsi > rsiMin and rsi < rsiMax
    table.cell(panel, 1, 3, str.tostring(rsi, "#.#"), text_color=rsiOK ? color.new(bullColor, 0) : color.gray, text_size=size.tiny)
    
    table.cell(panel, 0, 4, "MACD", text_color=color.gray, text_size=size.tiny)
    table.cell(panel, 1, 4, macdLine > signalLine ? "BULL ↑" : "BEAR", text_color=macdLine > signalLine ? color.new(bullColor, 0) : color.new(bearColor, 0), text_size=size.tiny)
    
    table.cell(panel, 0, 5, "DI+/DI-", text_color=color.gray, text_size=size.tiny)
    table.cell(panel, 1, 5, plusDI > minusDI ? "BULL" : "BEAR", text_color=plusDI > minusDI ? color.new(bullColor, 0) : color.new(bearColor, 0), text_size=size.tiny)
    
    posText = strategy.position_size > 0 ? "LONG" : "FLAT"
    table.cell(panel, 0, 6, "Position", text_color=color.gray, text_size=size.tiny)
    table.cell(panel, 1, 6, posText, text_color=strategy.position_size > 0 ? color.new(bullColor, 0) : color.gray, text_size=size.tiny)
    
    table.cell(panel, 0, 7, "R:R", text_color=color.gray, text_size=size.tiny)
    table.cell(panel, 1, 7, "1:" + str.tostring(tpATR/slATR, "#.#"), text_color=color.white, text_size=size.tiny)

// ══════════════════════════════════════════════════════════════════════════════
// STATS PANEL
// ══════════════════════════════════════════════════════════════════════════════

var table stats = table.new(position.top_left, 2, 6, bgcolor=color.new(#1a1a2e, 10), border_width=1, border_color=color.new(color.gray, 50))

if barstate.islast
    table.cell(stats, 0, 0, "PERFORMANCE", text_color=color.white, text_size=size.small, bgcolor=color.new(color.gray, 40))
    table.cell(stats, 1, 0, "", bgcolor=color.new(color.gray, 40))
    
    netPct = strategy.initial_capital > 0 ? (strategy.netprofit / strategy.initial_capital) * 100 : 0
    table.cell(stats, 0, 1, "Net P&L", text_color=color.gray, text_size=size.tiny)
    table.cell(stats, 1, 1, str.tostring(netPct, "#.##") + "%", text_color=strategy.netprofit >= 0 ? color.new(bullColor, 0) : color.new(bearColor, 0), text_size=size.tiny)
    
    table.cell(stats, 0, 2, "Trades", text_color=color.gray, text_size=size.tiny)
    table.cell(stats, 1, 2, str.tostring(strategy.closedtrades), text_color=color.white, text_size=size.tiny)
    
    wr = strategy.closedtrades > 0 ? (strategy.wintrades / strategy.closedtrades) * 100 : 0
    table.cell(stats, 0, 3, "Win Rate", text_color=color.gray, text_size=size.tiny)
    table.cell(stats, 1, 3, str.tostring(wr, "#.#") + "%", text_color=wr >= 55 ? color.new(bullColor, 0) : wr >= 45 ? color.yellow : color.new(bearColor, 0), text_size=size.tiny)
    
    pf = strategy.grossloss != 0 ? math.abs(strategy.grossprofit / strategy.grossloss) : 0
    table.cell(stats, 0, 4, "Profit Factor", text_color=color.gray, text_size=size.tiny)
    table.cell(stats, 1, 4, str.tostring(pf, "#.##"), text_color=pf >= 1.5 ? color.new(bullColor, 0) : pf >= 1 ? color.yellow : color.new(bearColor, 0), text_size=size.tiny)
    
    maxDD = strategy.initial_capital > 0 ? (strategy.max_drawdown / strategy.initial_capital) * 100 : 0
    table.cell(stats, 0, 5, "Max DD", text_color=color.gray, text_size=size.tiny)
    table.cell(stats, 1, 5, str.tostring(maxDD, "#.#") + "%", text_color=maxDD < 20 ? color.new(bullColor, 0) : maxDD < 30 ? color.yellow : color.new(bearColor, 0), text_size=size.tiny)

// ══════════════════════════════════════════════════════════════════════════════
// ALERTS
// ══════════════════════════════════════════════════════════════════════════════

alertcondition(enterLong, "MDZ Long Entry", "MDZ v4.2: Long entry signal")
alertcondition(strongUptrend and not strongUptrend[1], "Uptrend Started", "MDZ v4.2: Strong uptrend detected")
