//@version=5
indicator("Custom Candle Boxes with Opening and Price Differences + Random", overlay=true, max_boxes_count=500, max_labels_count=500)

//------------------------------------------------------------------------------
// Settings
//------------------------------------------------------------------------------
bg_transp = input.float(90, 'Box Transparency', group='Box Settings')
box_color_custom = input.color(color.orange, 'Custom Minute Box Color', group='Box Settings')
box_color_daily = input.color(color.blue, 'Daily Box Color', group='Box Settings')
box_color_weekly = input.color(color.green, 'Weekly Box Color', group='Box Settings')
box_color_monthly = input.color(color.red, 'Monthly Box Color', group='Box Settings')
box_color_random = input.color(color.purple, 'Random Box Color', group='Box Settings')

show_outline = input(true, 'Show Box Outline', group='Box Settings')
outline_color = input.color(color.black, 'Outline Color', group='Box Settings')
outline_style = input.string("Solid", "Outline Style", options=["Solid", "Dotted", "Dashed"], group='Box Settings')
show_open_line = input(true, 'Show Opening Price Line', group='Box Settings')
open_line_color = input.color(color.blue, 'Opening Price Line Color', group='Box Settings')
open_line_width = input.int(2, 'Opening Price Line Width', group='Box Settings')

// Timeframe selection
timeframe_option = input.string("Daily", "Select Timeframe", options=["Custom Minutes", "Daily", "Weekly", "Monthly", "Random"], group='Timeframe Selection')
custom_minutes = input.int(60, "Custom Minutes Interval", group='Timeframe Selection')

// Random box settings
rand_interval = input.int(50, "Random Interval (bars)", group="Random Box Settings")
rand_height = input.float(1.0, "Random Height (multiplier)", group="Random Box Settings")

// Convert outline style input to Pine Script line style
outline_style_value = outline_style == "Solid" ? line.style_solid : outline_style == "Dotted" ? line.style_dotted : line.style_dashed

//------------------------------------------------------------------------------
// Variables
//------------------------------------------------------------------------------
var box random_box = na
var float random_high = na
var float random_low = na
var float random_open = na
var int   random_start_bar = na
var line  random_open_line = na
var label random_label_high = na
var label random_label_low = na

//------------------------------------------------------------------------------
// Function for updating labels
//------------------------------------------------------------------------------
update_labels(_label_high, _label_low, _high, _low, _open, _box) =>
    midpoint_x = (box.get_left(_box) + box.get_right(_box)) / 2

    price_diff_high = _high - _open
    percent_change_high = (price_diff_high / _open) * 100

    price_diff_low = _open - _low
    percent_change_low = (price_diff_low / _open) * 100

    label.set_xy(_label_high, midpoint_x, _high)
    label.set_text(_label_high, "High: " + str.tostring(price_diff_high, "#.##") + " (" + str.tostring(percent_change_high, "#.##") + "%)")

    label.set_xy(_label_low, midpoint_x, _low)
    label.set_text(_label_low, "Low: " + str.tostring(price_diff_low, "#.##") + " (" + str.tostring(percent_change_low, "#.##") + "%)")

//------------------------------------------------------------------------------
// Random Box Logic (works like Daily/Weekly/Monthly)
//------------------------------------------------------------------------------
if timeframe_option == "Random"
    // Start a new random box every rand_interval bars
    if (na(random_start_bar) or (bar_index - random_start_bar >= rand_interval))
        random_high := high + math.abs(math.sin(bar_index * 12.345)) * rand_height
        random_low := low - math.abs(math.sin(bar_index * 7.89)) * rand_height
        random_open := open
        random_start_bar := bar_index

        random_box := box.new(bar_index, random_high, bar_index, random_low,
                              bgcolor=color.new(box_color_random, bg_transp),
                              border_color=show_outline ? outline_color : na,
                              border_style=outline_style_value)

        if show_open_line
            random_open_line := line.new(bar_index, random_open, bar_index, random_open, color=open_line_color, width=open_line_width, style=line.style_solid)

        random_label_high := label.new(bar_index, random_high, "", style=label.style_label_down, color=color.white, textcolor=color.black, size=size.small)
        random_label_low := label.new(bar_index, random_low, "", style=label.style_label_up, color=color.white, textcolor=color.black, size=size.small)

    else
        // Update ongoing random box
        random_high := math.max(high, random_high)
        random_low := math.min(low, random_low)

        box.set_top(random_box, random_high)
        box.set_rightbottom(random_box, bar_index, random_low)

        if show_open_line
            line.set_xy2(random_open_line, bar_index, random_open)

        update_labels(random_label_high, random_label_low, random_high, random_low, random_open, random_box)
