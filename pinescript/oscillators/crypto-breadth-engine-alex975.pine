//@version=5
indicator("Crypto Breadth Engine [alex975] - Top 40", overlay=false)

// ---------------------------
// TIMEFRAME DI RIFERIMENTO
// ---------------------------
timeFrame = input.timeframe("1D", "Timeframe di riferimento")

// ---------------------------
// MASCHERINA INPUT (40 CRYPTO)
// ---------------------------
s1  = input.symbol("BTCUSDT",  "Ticker 1")
s2  = input.symbol("ETHUSDT",  "Ticker 2")
s3  = input.symbol("XRPUSDT",  "Ticker 3")
s4  = input.symbol("BNBUSDT",  "Ticker 4")
s5  = input.symbol("SOLUSDT",  "Ticker 5")
s6  = input.symbol("TRXUSDT",  "Ticker 6")
s7  = input.symbol("DOGEUSDT", "Ticker 7")
s8  = input.symbol("ADAUSDT",  "Ticker 8")
s9  = input.symbol("HYPEUSDT", "Ticker 9")
s10 = input.symbol("LINKUSDT", "Ticker 10")
s11 = input.symbol("BCHUSDT",  "Ticker 11")
s12 = input.symbol("XLMUSDT",  "Ticker 12")
s13 = input.symbol("LEOUSDT",  "Ticker 13")
s14 = input.symbol("SUIUSDT",  "Ticker 14")
s15 = input.symbol("HBARUSDT", "Ticker 15")
s16 = input.symbol("AVAXUSDT", "Ticker 16")
s17 = input.symbol("LTCUSDT",  "Ticker 17")
s18 = input.symbol("XMRUSDT",  "Ticker 18")
s19 = input.symbol("ZECUSDT",  "Ticker 19")
s20 = input.symbol("SHIBUSDT", "Ticker 20")
s21 = input.symbol("TONUSDT",  "Ticker 21")
s22 = input.symbol("CROUSDT",  "Ticker 22")
s23 = input.symbol("TAOUSDT",  "Ticker 23")
s24 = input.symbol("DOTUSDT",  "Ticker 24")
s25 = input.symbol("MNTUSDT",  "Ticker 25")
s26 = input.symbol("UNIUSDT",  "Ticker 26")
s27 = input.symbol("AAVEUSDT", "Ticker 27")
s28 = input.symbol("WLFIUSDT", "Ticker 28")
s29 = input.symbol("BGBUSDT",  "Ticker 29")
s30 = input.symbol("OKBUSDT",  "Ticker 30")
s31 = input.symbol("PEPEUSDT", "Ticker 31")
s32 = input.symbol("NEARUSDT", "Ticker 32")
s33 = input.symbol("ENAUSDT",  "Ticker 33")
s34 = input.symbol("ETCUSDT",  "Ticker 34")
s35 = input.symbol("ASTERUSDT","Ticker 35")
s36 = input.symbol("MUSDT",    "Ticker 36")
s37 = input.symbol("APTUSDT",  "Ticker 37")
s38 = input.symbol("ONDOUSDT", "Ticker 38")
s39 = input.symbol("ICPUSDT",  "Ticker 39")
s40 = input.symbol("POLUSDT",  "Ticker 40")

// ---------------------------
// FUNZIONE DIREZIONE (+1, -1, 0)
// ---------------------------
getDir(sym) =>
    change = request.security(sym, timeFrame, close - close[1])
    na(change) ? 0 : change > 0 ? 1 : change < 0 ? -1 : 0

// ---------------------------
// CALCOLO COMPLESSIVO
// ---------------------------
sumChange =
     getDir(s1)+getDir(s2)+getDir(s3)+getDir(s4)+getDir(s5)+
     getDir(s6)+getDir(s7)+getDir(s8)+getDir(s9)+getDir(s10)+
     getDir(s11)+getDir(s12)+getDir(s13)+getDir(s14)+getDir(s15)+
     getDir(s16)+getDir(s17)+getDir(s18)+getDir(s19)+getDir(s20)+
     getDir(s21)+getDir(s22)+getDir(s23)+getDir(s24)+getDir(s25)+
     getDir(s26)+getDir(s27)+getDir(s28)+getDir(s29)+getDir(s30)+
     getDir(s31)+getDir(s32)+getDir(s33)+getDir(s34)+getDir(s35)+
     getDir(s36)+getDir(s37)+getDir(s38)+getDir(s39)+getDir(s40)

// ---------------------------
// CONTA COIN POSITIVE / NEGATIVE
// ---------------------------
positive =
     (getDir(s1) > 0 ? 1 : 0)+(getDir(s2) > 0 ? 1 : 0)+(getDir(s3) > 0 ? 1 : 0)+(getDir(s4) > 0 ? 1 : 0)+(getDir(s5) > 0 ? 1 : 0)+
     (getDir(s6) > 0 ? 1 : 0)+(getDir(s7) > 0 ? 1 : 0)+(getDir(s8) > 0 ? 1 : 0)+(getDir(s9) > 0 ? 1 : 0)+(getDir(s10) > 0 ? 1 : 0)+
     (getDir(s11) > 0 ? 1 : 0)+(getDir(s12) > 0 ? 1 : 0)+(getDir(s13) > 0 ? 1 : 0)+(getDir(s14) > 0 ? 1 : 0)+(getDir(s15) > 0 ? 1 : 0)+
     (getDir(s16) > 0 ? 1 : 0)+(getDir(s17) > 0 ? 1 : 0)+(getDir(s18) > 0 ? 1 : 0)+(getDir(s19) > 0 ? 1 : 0)+(getDir(s20) > 0 ? 1 : 0)+
     (getDir(s21) > 0 ? 1 : 0)+(getDir(s22) > 0 ? 1 : 0)+(getDir(s23) > 0 ? 1 : 0)+(getDir(s24) > 0 ? 1 : 0)+(getDir(s25) > 0 ? 1 : 0)+
     (getDir(s26) > 0 ? 1 : 0)+(getDir(s27) > 0 ? 1 : 0)+(getDir(s28) > 0 ? 1 : 0)+(getDir(s29) > 0 ? 1 : 0)+(getDir(s30) > 0 ? 1 : 0)+
     (getDir(s31) > 0 ? 1 : 0)+(getDir(s32) > 0 ? 1 : 0)+(getDir(s33) > 0 ? 1 : 0)+(getDir(s34) > 0 ? 1 : 0)+(getDir(s35) > 0 ? 1 : 0)+
     (getDir(s36) > 0 ? 1 : 0)+(getDir(s37) > 0 ? 1 : 0)+(getDir(s38) > 0 ? 1 : 0)+(getDir(s39) > 0 ? 1 : 0)+(getDir(s40) > 0 ? 1 : 0)

negative = 40 - positive
participation = (positive / 40) * 100

// ---------------------------
// BREADTH E NORMALIZZAZIONE
// ---------------------------
adl = ta.cum(sumChange)
adlNorm = ta.sma(adl, 3) / ta.stdev(adl, 20) * 100

maFast = ta.sma(adlNorm, 10)
maMid  = ta.sma(adlNorm, 20)
maSlow = ta.sma(adlNorm, 50)

// Trend Bias realistico
trendBias = adlNorm > maMid and maMid > maSlow ? "Bullish" : adlNorm < maMid and maMid < maSlow ? "Bearish" : "Neutral"

// ---------------------------
// GRAFICO PRINCIPALE
// ---------------------------
hline(0, "Equilibrio", color=color.gray)
plot(adlNorm, color=color.new(color.black, 0), linewidth=2, title="Breadth Line")
plot(maFast, color=color.new(color.blue, 0), title="SMA(10)")   // MEDIA A 10 BLU
plot(maMid,  color=color.new(color.orange, 0), title="SMA(20)")
plot(maSlow, color=color.new(color.red, 0), title="SMA(50)")
bgcolor(adlNorm > maMid ? color.new(color.green, 92) : color.new(color.red, 92))

// ---------------------------
// TABELLINA COMPATTA (in basso a destra, font medio-piccolo)
// ---------------------------
var table dash = table.new(position.bottom_right, 1, 5)
boxColor = participation >= 50 ? color.new(color.teal, 0) : color.new(color.red, 0)

table.cell(dash, 0, 0, "Breadth", text_color=color.white, bgcolor=boxColor, text_size=size.small)
table.cell(dash, 0, 1, "Pos: " + str.tostring(positive) + "/40", text_color=color.white, bgcolor=color.new(color.black, 0), text_size=size.small)
table.cell(dash, 0, 2, "Part: " + str.tostring(math.round(participation, 1)) + "%", text_color=color.white, bgcolor=color.new(color.black, 0), text_size=size.small)
table.cell(dash, 0, 3, "Neg: " + str.tostring(negative) + "/40", text_color=color.white, bgcolor=color.new(color.black, 0), text_size=size.small)
table.cell(dash, 0, 4, "Trend: " + trendBias, text_color=color.white, bgcolor=color.new(color.black, 0), text_size=size.small)
