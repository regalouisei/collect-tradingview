// © YourTradingViewUsername
//@version=6
strategy("Game Theory EMA Strategy",
     overlay=true,
     initial_capital=10000,
     commission_type=strategy.commission.percent,
     commission_value=0.05,
     slippage=1,
     pyramiding=0)

// ───────── INPUTS ─────────
emaFast   = input.int(9, "Fast EMA")
emaSlow   = input.int(21, "Slow EMA")
emaTrend  = input.int(50, "Trend EMA")
atrPeriod = input.int(14, "ATR Period")
atrMult   = input.float(1.5, "ATR Stop Multiplier")
rr        = input.float(1.8, "Risk : Reward")
adxLen    = input.int(14, "ADX Length")
adxThresh = input.int(20, "ADX Threshold")
useADX    = input.bool(true, "Use ADX Filter")

// ───────── CORE INDICATORS ─────────
ema_fast  = ta.ema(close, emaFast)
ema_slow  = ta.ema(close, emaSlow)
ema_trend = ta.ema(close, emaTrend)

atr = ta.atr(atrPeriod)
[_, _, adx] = ta.dmi(adxLen, adxLen)

rsi = ta.rsi(close, 14)
volMA = ta.sma(volume, 20)

// ───────── GAME THEORY MODEL (UTILITY EDGE) ─────────
// Utility difference = directional momentum probability proxy
utility_edge = (rsi - 50) / 50

buyer_edge  = utility_edge > 0
seller_edge = utility_edge < 0

equilibrium = math.abs(utility_edge) < 0.1

// ───────── TREND & MOMENTUM CONDITIONS ─────────
emaCrossUp   = ta.crossover(ema_fast, ema_slow)
emaCrossDown = ta.crossunder(ema_fast, ema_slow)

uptrend   = close > ema_trend
downtrend = close < ema_trend

strongTrend = adx > adxThresh

longCond  = emaCrossUp and uptrend and buyer_edge and not equilibrium and (not useADX or strongTrend)
shortCond = emaCrossDown and downtrend and seller_edge and not equilibrium and (not useADX or strongTrend)

// ───────── RISK MODEL (2% PER TRADE) ─────────
riskPercent = 2.0
capitalRisk = strategy.equity * (riskPercent / 100)

longStop  = close - atr * atrMult
shortStop = close + atr * atrMult

longRisk  = close - longStop
shortRisk = shortStop - close

longQty  = capitalRisk / longRisk
shortQty = capitalRisk / shortRisk

// ───────── EXECUTION ─────────
if longCond and strategy.position_size == 0
    strategy.entry("Long", strategy.long, qty=longQty)

if shortCond and strategy.position_size == 0
    strategy.entry("Short", strategy.short, qty=shortQty)

if strategy.position_size > 0
    stopLevel = strategy.position_avg_price - atr * atrMult
    takeLevel = strategy.position_avg_price + (atr * atrMult * rr)
    strategy.exit("Long Exit", "Long", stop=stopLevel, limit=takeLevel)

if strategy.position_size < 0
    stopLevel = strategy.position_avg_price + atr * atrMult
    takeLevel = strategy.position_avg_price - (atr * atrMult * rr)
    strategy.exit("Short Exit", "Short", stop=stopLevel, limit=takeLevel)

// ───────── VISUALS (CLEAN) ─────────
plot(ema_fast, color=color.blue, title="Fast EMA")
plot(ema_slow, color=color.red, title="Slow EMA")
plot(ema_trend, color=color.orange, title="Trend EMA")

plotshape(longCond, style=shape.triangleup, location=location.belowbar, color=color.green, size=size.small)
plotshape(shortCond, style=shape.triangledown, location=location.abovebar, color=color.red, size=size.small)
