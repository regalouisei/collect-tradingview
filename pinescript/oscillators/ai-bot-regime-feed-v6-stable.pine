//@version=6
indicator("AI Bot Regime Feed (v6) â€” stable", overlay=true)

// --- Core indicators ---
emaFast  = ta.ema(close, 12)
emaSlow  = ta.ema(close, 35)
rsiValue = ta.rsi(close, 14)
atrValue = ta.atr(14)
volPct   = atrValue / close

// --- Manual ADX calculation (no ta.adx/ta.dx dependencies) ---
lenADX   = 14
upMove   = ta.change(high)
downMove = -ta.change(low)
plusDM   = na(upMove) or upMove <= 0 or upMove <= downMove ? 0.0 : upMove
minusDM  = na(downMove) or downMove <= 0 or downMove <= upMove ? 0.0 : downMove
trur     = ta.rma(ta.tr, lenADX)
plusDI   = 100 * ta.rma(plusDM, lenADX)  / trur
minusDI  = 100 * ta.rma(minusDM, lenADX) / trur
dx       = (plusDI + minusDI == 0) ? 0.0 : 100 * math.abs(plusDI - minusDI) / (plusDI + minusDI)
adxValue = ta.rma(dx, lenADX)

// --- Regime labeling ---
bullish = emaFast > emaSlow and rsiValue > 45
bearish = emaFast < emaSlow and rsiValue < 55
regime  = bullish ? "bullish" : bearish ? "bearish" : "choppy"

// --- Signals (example gates) ---
buySignal  = ta.crossover(emaFast, emaSlow) and rsiValue < 40
sellSignal = ta.crossunder(emaFast, emaSlow) and rsiValue > 60

// --- clamp helper (replaces math.clamp) ---
clamp(x, lo, hi) =>
    math.min(math.max(x, lo), hi)

// --- Confidence (simple demo) ---
confBase   = 0.85
confAdj    = ((adxValue - 20.0) * 0.005) - ((volPct - 0.01) * 2.0)
confidence = clamp(confBase + confAdj, 0.50, 0.99)

// --- Plots (use named arguments to avoid order issues) ---
plot(emaFast, title="EMA 12", color=color.new(color.green, 0))
plot(emaSlow, title="EMA 35", color=color.new(color.red,   0))
plot(adxValue, title="ADX",   color=color.new(color.yellow, 0))

plotshape(buySignal,  title="BUY",
     style=shape.triangleup,  location=location.belowbar, color=color.green, size=size.tiny)
plotshape(sellSignal, title="SELL",
     style=shape.triangledown, location=location.abovebar, color=color.red,   size=size.tiny)

// --- JSON builder (single assignment to avoid continuation issues) ---
json(side) =>
    payload = '{"source":"tradingview","symbol":"' + syminfo.ticker +
      '","side":"' + side +
      '","timeframe":"' + timeframe.period +
      '","confidence":' + str.tostring(confidence) +
      ',"indicators":{"ema_fast":' + str.tostring(emaFast) +
      ',"ema_slow":' + str.tostring(emaSlow) +
      ',"rsi":' + str.tostring(rsiValue) +
      ',"adx":' + str.tostring(adxValue) +
      ',"atr":' + str.tostring(atrValue) +
      ',"volatility":' + str.tostring(volPct) +
      '},"regime":"' + regime + '","note":"ema crossover + rsi gate","ts":' +
      str.tostring(time) + '}'
    payload

// --- Alerts (set alert to "Any alert() function call") ---
if buySignal
    alert(json("buy"), alert.freq_once_per_bar_close)
if sellSignal
    alert(json("sell"), alert.freq_once_per_bar_close)

// Optional labels for UI
alertcondition(buySignal,  title="BUY Alert",  message="BUY Triggered")
alertcondition(sellSignal, title="SELL Alert", message="SELL Triggered")
