// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Mattes

//@version=6
indicator(title="Hull DMI - Mattes", overlay=false, timeframe="", timeframe_gaps=true)
import TradingView/ta/7 as ta


len_hull = input.int(15,"Hull len", minval=1, group = "smoothing")
hullh = ta.wma(2*ta.wma(high, len_hull/2)-ta.wma(high, len_hull), math.floor(math.sqrt(len_hull)))
hulll = ta.wma(2*ta.wma(low, len_hull/2)-ta.wma(low, len_hull), math.floor(math.sqrt(len_hull)))

adx_smoothing_len = input.int(18,"adx len", minval=1, group = "Hull DMI - Mattes")
di_len = input.int(18,"dmi len", minval=1, group = "Hull DMI - Mattes")
UseADX = input.bool(true, title="Use ADX as confirmation?")

u = ta.change(hullh)
d = -ta.change(hulll)
p = na(u) ? na : (u > d and u > 0 ? u : 0)
m = na(d) ? na : (d > u and d > 0 ? d : 0)
t = ta.rma(ta.tr, di_len)
plus = fixnan(100 * ta.rma(p, di_len) / t)
minus = fixnan(100 * ta.rma(m, di_len) / t)
sum = plus + minus
adx = 100 * ta.rma(math.abs(plus - minus) / (sum == 0 ? 1 : sum), adx_smoothing_len)

x = adx > adx[1]
X_bool = not UseADX or x
dmil = plus > minus and X_bool
dmis = minus > plus

L = dmil
S = dmis

var Mattes = 0

if L and not S 
    Mattes := 1

if S 
    Mattes := -1

plot(plus-minus, "dif", color = Mattes ==  1 ? color.rgb(45, 162, 252) : Mattes ==  -1 ? color.rgb(113, 59, 249) : color.gray, linewidth = 2)
hline(0, color = color.white)


syscol = Mattes ==  1 ? color.rgb(45, 162, 252) : color.rgb(113, 59, 249)
plotcandle(open, high, low, close, 'BarColor', color = syscol, bordercolor = syscol, wickcolor = syscol,force_overlay = true)
alertcondition(L, title="Dema DMI Long", message="Dema DMI Long {{exchange}}:{{ticker}}")
alertcondition(S, title="Dema DMI Short", message="Dema DMI Short {{exchange}}:{{ticker}}")
