// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Rob_Maths

//@version=6
// -----------------------------------------------------------------------------
// SCRIPT: BTC - ALSI: Altcoin Season Index [Dynamic Eras] | RM
// AUTHOR: Rob_Maths
// SHORT:  BTC - ALSI | RM
// METHODOLOGY: Tracks the % of Top 20 coins outperforming Bitcoin over a rolling window.
//              Uses Dynamic Eras to adjust the coin basket based on historical snapshots,
//              preventing survivor bias and ensuring modern relevance (e.g., TAO in 2025).
// -----------------------------------------------------------------------------

indicator("BTC - ALSI: Altcoin Season Index [Dynamic Eras] | RM", shorttitle="BTC - ALSI | RM", overlay=false, precision=0)

// ==========================================
// 1. INPUTS & CONFIGURATION
// ==========================================
grp_model   = "Model Settings"
win         = input.int(90,   "Lookback Period (Days)", minval=10, tooltip="The rolling window used to compare Altcoin performance vs Bitcoin.", group=grp_model)

grp_zones   = "Regime Thresholds"
th_seas     = input.int(75,   "Altcoin Season Threshold", minval=50, maxval=100, tooltip="Values above this level indicate strong Altcoin dominance.", group=grp_zones)
th_btc      = input.int(25,   "Bitcoin Season Threshold", minval=0,  maxval=50,  tooltip="Values below this level indicate strong Bitcoin dominance.", group=grp_zones)

grp_vis     = "Visual Settings"
show_zone   = input.bool(true, "Show Background Zones", group=grp_vis)
show_table  = input.bool(true, "Show Data Status Table", group=grp_vis)

// ==========================================
// 2. DATA SOURCES
// ==========================================
// -----------------------------------------------------------------------------
// NOTE ON COIN SELECTION & ERAS:
// This script uses a "Curated" Top 20 approach rather than a raw snapshot.
// 1. Anti-Fragile: Deliberately excluded failed projects (e.g., LUNA, FTT) and dead forks (BSV)
//    from historical eras. Including them would break the index during their collapse events,
//    distorting the signal with "false" Bitcoin Seasons caused by idiosyncratic failures.
// 2. Narrative Focused: For Era T5 (2024+), swapped stagnant assets (e.g., IMX) for current
//    narrative leaders like TAO (Bittensor) to capture the AI/Meme capital rotation.
// 3. Open Source: Users are free to adjust the ticker lists in the source code to test their own baskets.
// -----------------------------------------------------------------------------
// -----------------------------------------------------------------------------
req(sym) => request.security(sym, "D", close, ignore_invalid_symbol=true)

s_btc   = req("BINANCE:BTCUSDT")
s_eth   = req("BINANCE:ETHUSDT"), s_bnb   = req("BINANCE:BNBUSDT"), s_xrp   = req("BINANCE:XRPUSDT")
s_sol   = req("BINANCE:SOLUSDT"), s_ada   = req("BINANCE:ADAUSDT"), s_doge  = req("BINANCE:DOGEUSDT")
s_trx   = req("BINANCE:TRXUSDT"), s_ton   = req("OKX:TONUSDT"),     s_avax  = req("BINANCE:AVAXUSDT")
s_shib  = req("BINANCE:SHIBUSDT"),s_dot   = req("BINANCE:DOTUSDT"), s_link  = req("BINANCE:LINKUSDT")
s_bch   = req("BINANCE:BCHUSDT"), s_ltc   = req("BINANCE:LTCUSDT"), s_near  = req("BINANCE:NEARUSDT")
s_matic = req("BINANCE:POLUSDT"), s_uni   = req("BINANCE:UNIUSDT"), s_xlm   = req("BINANCE:XLMUSDT")
s_atom  = req("BINANCE:ATOMUSDT"),s_fil   = req("BINANCE:FILUSDT"), s_vet   = req("BINANCE:VETUSDT")
s_algo  = req("BINANCE:ALGOUSDT"),s_icp   = req("BINANCE:ICPUSDT"), s_apt   = req("BINANCE:APTUSDT")
s_rndr  = req("BINANCE:RENDERUSDT"),s_pepe= req("BINANCE:PEPEUSDT"),s_arb   = req("BINANCE:ARBUSDT")
s_etc   = req("BINANCE:ETCUSDT"), s_eos   = req("BITFINEX:EOSUSD"), s_neo   = req("BINANCE:NEOUSDT")
s_xtz   = req("BINANCE:XTZUSDT"), s_sui   = req("BINANCE:SUIUSDT"), s_tao   = req("BINANCE:TAOUSDT") 

// ==========================================
// 3. MATHEMATICAL CORE
// ==========================================

// A. Performance Calculation
// --------------------------
f_perf(_src) => 
    val = (_src - _src[win]) / _src[win] * 100
    na(val) ? -9999.0 : val // Handle non-existing coins (pre-listing)

p_btc   = f_perf(s_btc)
p_eth   = f_perf(s_eth),  p_bnb   = f_perf(s_bnb),  p_xrp   = f_perf(s_xrp)
p_sol   = f_perf(s_sol),  p_ada   = f_perf(s_ada),  p_doge  = f_perf(s_doge)
p_trx   = f_perf(s_trx),  p_ton   = f_perf(s_ton),  p_avax  = f_perf(s_avax)
p_shib  = f_perf(s_shib), p_dot   = f_perf(s_dot),  p_link  = f_perf(s_link)
p_bch   = f_perf(s_bch),  p_ltc   = f_perf(s_ltc),  p_near  = f_perf(s_near)
p_matic = f_perf(s_matic),p_uni   = f_perf(s_uni),  p_xlm   = f_perf(s_xlm)
p_atom  = f_perf(s_atom), p_fil   = f_perf(s_fil),  p_vet   = f_perf(s_vet)
p_algo  = f_perf(s_algo), p_icp   = f_perf(s_icp),  p_apt   = f_perf(s_apt)
p_rndr  = f_perf(s_rndr), p_pepe  = f_perf(s_pepe), p_arb   = f_perf(s_arb)
p_etc   = f_perf(s_etc),  p_eos   = f_perf(s_eos),  p_neo   = f_perf(s_neo)
p_xtz   = f_perf(s_xtz),  p_sui   = f_perf(s_sui),  p_tao   = f_perf(s_tao)

// B. Define Time Eras (Snapshots)
// -------------------------------
t1 = timestamp(2020, 10, 1, 0, 0) // Oct 2020
t2 = timestamp(2021, 10, 1, 0, 0) // Oct 2021
t3 = timestamp(2022, 10, 1, 0, 0) // Oct 2022
t4 = timestamp(2023, 10, 1, 0, 0) // Oct 2023
t5 = timestamp(2024, 10, 1, 0, 0) // Oct 2024

// C. Count Winners (Dynamic Basket)
// ---------------------------------
float wins = 0.0
check(p) => p > p_btc ? 1.0 : 0.0

if time < t2 // ERA T1: 2020-2021 (DeFi Summer Legacy)
    wins := check(p_eth) + check(p_xrp) + check(p_bch) + check(p_bnb) + check(p_dot) + check(p_link) + check(p_ltc) + check(p_ada) + check(p_xlm) + check(p_eos) + check(p_trx) + check(p_atom) + check(p_neo) + check(p_xtz) + check(p_vet) + check(p_uni) + check(p_fil) + check(p_doge) + check(p_algo) + check(p_etc)

else if time >= t2 and time < t3 // ERA T2: 2021-2022 (The Bull Run)
    wins := check(p_eth) + check(p_ada) + check(p_bnb) + check(p_xrp) + check(p_sol) + check(p_dot) + check(p_doge) + check(p_uni) + check(p_avax) + check(p_link) + check(p_ltc) + check(p_algo) + check(p_bch) + check(p_matic) + check(p_xlm) + check(p_vet) + check(p_icp) + check(p_fil) + check(p_atom) + check(p_trx)

else if time >= t3 and time < t4 // ERA T3: 2022-2023 (Bear Market Survivors)
    wins := check(p_eth) + check(p_bnb) + check(p_xrp) + check(p_ada) + check(p_sol) + check(p_doge) + check(p_dot) + check(p_matic) + check(p_shib) + check(p_trx) + check(p_avax) + check(p_uni) + check(p_ltc) + check(p_link) + check(p_atom) + check(p_etc) + check(p_xlm) + check(p_algo) + check(p_icp) + check(p_fil)

else if time >= t4 and time < t5 // ERA T4: 2023-2024 (Pre-Halving)
    wins := check(p_eth) + check(p_bnb) + check(p_xrp) + check(p_sol) + check(p_ada) + check(p_doge) + check(p_trx) + check(p_ton) + check(p_matic) + check(p_dot) + check(p_ltc) + check(p_bch) + check(p_shib) + check(p_link) + check(p_avax) + check(p_xlm) + check(p_atom) + check(p_icp) + check(p_apt) + check(p_arb)

else // ERA T5: 2024-Current (AI & Meme Era)
    // Note: IMX removed, TAO added.
    wins := check(p_eth) + check(p_bnb) + check(p_sol) + check(p_xrp) + check(p_doge) + check(p_ton) + check(p_trx) + check(p_ada) + check(p_avax) + check(p_shib) + check(p_link) + check(p_bch) + check(p_dot) + check(p_near) + check(p_uni) + check(p_sui) + check(p_pepe) + check(p_apt) + check(p_tao) + check(p_rndr)

index = (wins / 20.0) * 100

// ==========================================
// 4. PLOTTING & VISUALS
// ==========================================
// Colors 
co_main = color.rgb(26, 24, 168)                // Deep Blue Line
co_low  = color.new(color.rgb(26, 24, 168), 85) // BTC Zone Fill
co_high = color.new(color.rgb(220, 38, 38), 85) // Alt Zone Fill
co_text = color.white

// Main Plot
plot(index, "Alt Season Index", color=co_main, linewidth=2)

// Thresholds
h_top = hline(th_seas, "Season Threshold",  color.gray, hline.style_dotted)
h_bot = hline(th_btc,  "Bitcoin Threshold", color.gray, hline.style_dotted)

// Background Fills
fill(h_top, hline(100), color=show_zone ? co_high : na, title="Alt Season Zone")
fill(h_bot, hline(0),   color=show_zone ? co_low  : na, title="BTC Season Zone")

// ==========================================
// 5. STATUS TABLE
// ==========================================
var table infoTable = table.new(position.bottom_right, 2, 4, border_width=1)

if barstate.islast and show_table
    // Define Regime
    regime_txt = index >= th_seas ? "ALT SEASON" : index <= th_btc ? "BTC SEASON" : "NEUTRAL"
    regime_col = index >= th_seas ? color.rgb(220, 38, 38) : index <= th_btc ? color.rgb(26, 24, 168) : color.gray
    
    // Header
    table.cell(infoTable, 0, 0, "ALSI | RM", bgcolor=color.gray, text_color=co_text, text_size=size.small)
    table.cell(infoTable, 1, 0, "Status",    bgcolor=color.gray, text_color=co_text, text_size=size.small)
    
    // Index Value
    table.cell(infoTable, 0, 1, "Index Value", bgcolor=color.black, text_color=co_text, text_size=size.small, text_halign=text.align_left)
    table.cell(infoTable, 1, 1, str.tostring(index, "#"), bgcolor=regime_col, text_color=co_text, text_size=size.small)
    
    // Regime
    table.cell(infoTable, 0, 2, "Regime", bgcolor=color.black, text_color=co_text, text_size=size.small, text_halign=text.align_left)
    table.cell(infoTable, 1, 2, regime_txt, bgcolor=color.black, text_color=regime_col, text_size=size.small)
    
    // System Check (Data Integrity)
    is_live = not na(s_btc) and not na(s_eth)
    table.cell(infoTable, 0, 3, "System", bgcolor=color.black, text_color=co_text, text_size=size.small, text_halign=text.align_left)
    table.cell(infoTable, 1, 3, is_live ? "LIVE" : "WAIT", bgcolor=is_live ? color.green : color.red, text_color=co_text, text_size=size.small)
