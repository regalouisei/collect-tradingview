// This work is licensed under a Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0) https://creativecommons.org/licenses/by-nc-sa/4.0/
// © LuxAlgo

//@version=6
indicator("Correlated Sine Oscillator [LuxAlgo]", "LuxAlgo - Correlated Sine Oscillator", overlay = false, max_labels_count = 500)

//---------------------------------------------------------------------------------------------------------------------}
// Inputs
//---------------------------------------------------------------------------------------------------------------------{
int periodInput       = input.int(20, "Cycle Period", minval = 2, tooltip = "The period of the sinusoid in bars.")
float smoothMultInput = input.float(1.0, "Phase Multiplier", minval = 0.1, step = 0.1, tooltip = "Multiplier of the Cycle Period used for phase smoothing. 1.0 means the smoothing length equals the period.")

color bullColorInput  = input.color(#089981, "Bullish Color", group = "Style")
color bearColorInput  = input.color(#f23645, "Bearish Color", group = "Style")

//---------------------------------------------------------------------------------------------------------------------}
// Logic
//---------------------------------------------------------------------------------------------------------------------{
int smoothLength = math.max(1, math.round(periodInput * smoothMultInput))

// 1. Detrend price to isolate cycles
// Subtracting an SMA of the same period effectively detrends the data for that specific frequency
float detrended = close - ta.sma(close, periodInput)

// 2. Calculate the angular frequency components
float omega = 2 * math.pi / periodInput
float angle = omega * bar_index

// 3. Project detrended price onto Sine and Cosine (Quadrature components)
// This identifies how much of the "Sine" and "Cosine" flavor is in the current price action
float instReal = detrended * math.cos(angle)
float instImag = detrended * math.sin(angle)

// 4. Average these components to get a stable phase estimate
// Using a multiplier allows the smoothing to scale relative to the cycle period
float real = ta.sma(instReal, smoothLength)
float imag = ta.sma(instImag, smoothLength)

// 5. Calculate the dynamic phase using quadrant logic
float phase = real != 0 ? math.atan(imag / real) : (imag >= 0 ? math.pi / 2 : -math.pi / 2)
if real < 0
    phase := phase + math.pi

// 6. Generate the correlated sinusoid
float osc = math.cos(angle - phase)

// Signal Logic
bool isBullCross = ta.crossover(osc, 0)
bool isBearCross = ta.crossunder(osc, 0)

//---------------------------------------------------------------------------------------------------------------------}
// Visuals
//---------------------------------------------------------------------------------------------------------------------{
// Main oscillator plot
plotId = plot(osc, "Sine Oscillator", color = osc > 0 ? bullColorInput : bearColorInput, linewidth = 2)
zeroId = plot(0, "Zero Line", color = chart.fg_color, linestyle = plot.linestyle_dashed)

// Centered Oscillator Gradient Fill
fill(plotId, zeroId, 
     top_value    = math.max(osc, 0), 
     bottom_value = 0, 
     top_color    = osc > 0 ? color.new(bullColorInput, 50) : color.new(bullColorInput, 100), 
     bottom_color = osc > 0 ? color.new(bullColorInput, 100) : color.new(bullColorInput, 100),
     title        = "Bullish Gradient")

fill(plotId, zeroId, 
     top_value    = 0, 
     bottom_value = math.min(osc, 0), 
     top_color    = osc < 0 ? color.new(bearColorInput, 100) : color.new(bearColorInput, 100), 
     bottom_color = osc < 0 ? color.new(bearColorInput, 50) : color.new(bearColorInput, 100),
     title        = "Bearish Gradient")

// Direction Change Signals (on chart overlay)
if isBearCross
    label.new(bar_index, high, text = "▼", color = #00000000, textcolor = bearColorInput, style = label.style_label_down, size = size.small, force_overlay = true)

if isBullCross
    label.new(bar_index, low, text = "▲", color = #00000000, textcolor = bullColorInput, style = label.style_label_up, size = size.small, force_overlay = true)

//---------------------------------------------------------------------------------------------------------------------}
