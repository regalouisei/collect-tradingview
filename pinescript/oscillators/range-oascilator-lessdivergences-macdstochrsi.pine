//@version=5
indicator("Unified Indicator: Range + Divergences + MACD+StochRSI", overlay=true)

// === Inputs ===
length     = input.int(14, "Range Period", minval=1)
src        = input(close, "Source")
emaLen     = input.int(50, "EMA length", minval=1)
oversold   = input.float(20.0, "Oversold level", minval=0, maxval=100)
overbought = input.float(80.0, "Overbought level", minval=0, maxval=100)
lookback   = input.int(10, "Divergence Lookback Bars", minval=5)
minDiff    = input.float(0.5, "Min % Price Difference", minval=0.1)

// === Range Oscillator ===
highestHigh = ta.highest(high, length)
lowestLow   = ta.lowest(low, length)
rng         = highestHigh - lowestLow
osc         = rng != 0 ? (src - lowestLow) / rng * 100 : 50

// === EMA Trend Filter ===
ema = ta.ema(close, emaLen)

// === MACD (3-10-16 EMA) ===
macdFast   = ta.ema(close, 3)
macdSlow   = ta.ema(close, 10)
macdLine   = macdFast - macdSlow
macdSignal = ta.ema(macdLine, 16)
macdHist   = macdLine - macdSignal

bullMacd = ta.crossover(macdLine, macdSignal)
bearMacd = ta.crossunder(macdLine, macdSignal)

// === RSI ===
rsi = ta.rsi(close, 14)

// === Stochastic RSI ===
stRsi = ta.stoch(rsi, rsi, rsi, 14)
k     = ta.sma(stRsi, 3)
d     = ta.sma(k, 3)

// Zones (Stoch RSI)
inLowZone  = (k < 20 and d < 20)
inHighZone = (k > 80 and d > 80)

// === Range Oscillator Signals ===
buyOsc  = ta.crossover(osc, oversold) and close > ema
sellOsc = ta.crossunder(osc, overbought) and close < ema

// === Pivot-based divergence storage ===
left  = 2
right = 2
pl = ta.pivotlow(low, left, right)
ph = ta.pivothigh(high, left, right)

var float prevLowPrice  = na
var float prevLowRsi    = na
var float prevLowMacd   = na
var float prevHighPrice = na
var float prevHighRsi   = na
var float prevHighMacd  = na

var float currLowPrice  = na
var float currLowRsi    = na
var float currLowMacd   = na
var float currHighPrice = na
var float currHighRsi   = na
var float currHighMacd  = na

// One-time flags
var bool rsiBullFlag   = false
var bool rsiBearFlag   = false
var bool macdBullFlag  = false
var bool macdBearFlag  = false
var bool stochBullFlag = false
var bool stochBearFlag = false

// Divergence signals (initialize false each bar)
bullDivRSI    = false
bearDivRSI    = false
bullDivMACD   = false
bearDivMACD   = false
bullDivStoch  = false
bearDivStoch  = false

// === Update lows when a new pivot low is confirmed ===
if not na(pl)
    currLowPrice := low[right]
    currLowRsi   := rsi[right]
    currLowMacd  := macdHist[right]
    // Bullish RSI divergence
    if not na(prevLowPrice)
        if (currLowPrice < prevLowPrice * (1 - minDiff/100)) and (currLowRsi > prevLowRsi) and (rsi < 40) and (not rsiBullFlag)
            bullDivRSI := true
            rsiBullFlag := true
        // Bullish MACD histogram divergence
        if (currLowPrice < prevLowPrice * (1 - minDiff/100)) and (currLowMacd > prevLowMacd) and (macdHist < 0) and (not macdBullFlag)
            bullDivMACD := true
            macdBullFlag := true
    prevLowPrice := currLowPrice
    prevLowRsi   := currLowRsi
    prevLowMacd  := currLowMacd

// Reset bullish flags on structural upside break
if close > ta.highest(high, lookback)
    rsiBullFlag  := false
    macdBullFlag := false

// === Update highs when a new pivot high is confirmed ===
if not na(ph)
    currHighPrice := high[right]
    currHighRsi   := rsi[right]
    currHighMacd  := macdHist[right]
    // Bearish RSI divergence
    if not na(prevHighPrice)
        if (currHighPrice > prevHighPrice * (1 + minDiff/100)) and (currHighRsi < prevHighRsi) and (rsi > 60) and (not rsiBearFlag)
            bearDivRSI := true
            rsiBearFlag := true
        // Bearish MACD histogram divergence
        if (currHighPrice > prevHighPrice * (1 + minDiff/100)) and (currHighMacd < prevHighMacd) and (macdHist > 0) and (not macdBearFlag)
            bearDivMACD := true
            macdBearFlag := true
    prevHighPrice := currHighPrice
    prevHighRsi   := currHighRsi
    prevHighMacd  := currHighMacd

// Reset bearish flags on structural downside break
if close < ta.lowest(low, lookback)
    rsiBearFlag  := false
    macdBearFlag := false

// === Stoch RSI Divergences (same thresholds) ===
stLowNow   = ta.lowest(close, lookback)
stLowPrev  = ta.lowest(close[lookback], lookback)
stHighNow  = ta.highest(close, lookback)
stHighPrev = ta.highest(close[lookback], lookback)

if (stLowNow < stLowPrev * (1 - minDiff/100)) and (ta.lowest(k, lookback) > ta.lowest(k[lookback], lookback)) and (k < 20) and (not stochBullFlag)
    bullDivStoch := true
    stochBullFlag := true
if (stHighNow > stHighPrev * (1 + minDiff/100)) and (ta.highest(k, lookback) < ta.highest(k[lookback], lookback)) and (k > 80) and (not stochBearFlag)
    bearDivStoch := true
    stochBearFlag := true
if close > ta.highest(high, lookback)
    stochBullFlag := false
if close < ta.lowest(low, lookback)
    stochBearFlag := false

// === MACD + Stoch RSI zone-matched signals (single-condition) ===
buyMacdUnified  = bullMacd and inLowZone
sellMacdUnified = bearMacd and inHighZone

// === Plot ===
plot(series=ema, title="EMA", color=color.gray, linewidth=2)

// Range Oscillator
plotshape(series=buyOsc,  title="BUY Osc",  style=shape.triangleup,   location=location.belowbar, color=color.green,                size=size.small, text="BUY Osc")
plotshape(series=sellOsc, title="SELL Osc", style=shape.triangledown, location=location.abovebar, color=color.red,                  size=size.small, text="SELL Osc")

// Divergences (RSI / MACD Hist / Stoch RSI)
plotshape(series=bullDivRSI,   title="Bullish RSI Div",   style=shape.labelup,   location=location.belowbar, color=color.new(color.green,0), text="RSI BullDiv")
plotshape(series=bearDivRSI,   title="Bearish RSI Div",   style=shape.labeldown, location=location.abovebar, color=color.new(color.red,0),   text="RSI BearDiv")
plotshape(series=bullDivMACD,  title="Bullish MACD Div",  style=shape.labelup,   location=location.belowbar, color=color.new(color.green,0), text="MACD BullDiv")
plotshape(series=bearDivMACD,  title="Bearish MACD Div",  style=shape.labeldown, location=location.abovebar, color=color.new(color.red,0),   text="MACD BearDiv")
plotshape(series=bullDivStoch, title="Bullish Stoch Div", style=shape.labelup,   location=location.belowbar, color=color.new(color.green,0), text="Stoch BullDiv")
plotshape(series=bearDivStoch, title="Bearish Stoch Div", style=shape.labeldown, location=location.abovebar, color=color.new(color.red,0),   text="Stoch BearDiv")

// Unified MACD+Stoch RSI signals (tek koÅŸul)
plotshape(series=buyMacdUnified,  title="BUY MACD+StochRSI",  style=shape.triangleup,   location=location.belowbar, color=color.new(color.lime,0),  size=size.small, text="BUY M+S")
plotshape(series=sellMacdUnified, title="SELL MACD+StochRSI", style=shape.triangledown, location=location.abovebar, color=color.new(color.orange,0), size=size.small, text="SELL M+S")

// === Alerts (single-line strings) ===
alertcondition(buyOsc,         "BUY Osc",                 "Range Oscillator BUY")
alertcondition(sellOsc,        "SELL Osc",                "Range Oscillator SELL")
alertcondition(bullDivRSI,     "Bullish RSI Divergence",  "RSI Bullish Divergence")
alertcondition(bearDivRSI,     "Bearish RSI Divergence",  "RSI Bearish Divergence")
alertcondition(bullDivMACD,    "Bullish MACD Divergence", "MACD Bullish Divergence")
alertcondition(bearDivMACD,    "Bearish MACD Divergence", "MACD Bearish Divergence")
alertcondition(bullDivStoch,   "Bullish Stoch Divergence","Stoch RSI Bullish Divergence")
alertcondition(bearDivStoch,   "Bearish Stoch Divergence","Stoch RSI Bearish Divergence")
alertcondition(buyMacdUnified, "BUY MACD+StochRSI",       "MACD bullish crossover with Stoch RSI low zone")
alertcondition(sellMacdUnified,"SELL MACD+StochRSI",      "MACD bearish crossover with Stoch RSI high zone")
