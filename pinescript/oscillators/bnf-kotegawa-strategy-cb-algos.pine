//@version=5
// -----------------------------------------------------------------------------
// STRATEGY: BNF (Kotegawa) Mean Reversion Strategy
// DEVELOPED BY: CB Algos
//
// DESCRIPTION:
// This indicator replicates the trading style of Takashi Kotegawa (BNF).
// It calculates the percentage deviation of the price from the 25-period SMA.
//
// HOW TO USE:
// 1. Look for 'Lime' bars (Extreme Buy) or 'Teal' bars (Moderate Buy).
//    These indicate the price has dropped significantly below the average.
// 2. Look for 'Red' bars (Extreme Sell) as profit-taking zones.
// 3. Use the Info Panel to see the exact current deviation %.
// -----------------------------------------------------------------------------
indicator("BNF (Kotegawa) Strategy [CB Algos]", overlay=true)

// --- INPUTS ---
maLength = input.int(25, title="Moving Average Length", minval=1)

// Adjust these based on the volatility of the asset you are trading
devThreshold1 = input.float(3.0, title="Moderate Deviation %", minval=0.1)
devThreshold2 = input.float(6.0, title="Extreme Deviation %", minval=0.1)

// --- CALCULATIONS ---
smaValue = ta.sma(close, maLength)

// Formula: ((Close - SMA) / SMA) * 100
// Negative result = Price is BELOW MA (Oversold/Buy)
pctDeviation = ((close - smaValue) / smaValue) * 100

// --- PLOT MA ---
plot(smaValue, color=color.white, title="25 SMA", linewidth=2)

// --- SIGNAL LOGIC ---
isBuyModerate = pctDeviation <= (devThreshold1 * -1)
isBuyExtreme  = pctDeviation <= (devThreshold2 * -1)
isSellModerate = pctDeviation >= devThreshold1
isSellExtreme  = pctDeviation >= devThreshold2

// --- VISUALS: BAR COLORING ---
// Lime = Extreme Buy, Teal = Moderate Buy
// Red = Extreme Sell, Maroon = Moderate Sell
barColor = isBuyExtreme ? color.new(color.lime, 0) : isBuyModerate ? color.new(color.teal, 0) : isSellExtreme ? color.new(color.red, 0) : isSellModerate ? color.new(color.maroon, 0) : na
barcolor(barColor)

// --- VISUALS: BACKGROUND HIGHLIGHTS ---
bgcolor(isBuyExtreme ? color.new(color.lime, 85) : na, title="Buy Zone Background")
bgcolor(isSellExtreme ? color.new(color.red, 85) : na, title="Sell Zone Background")

// --- DASHBOARD / INFO PANEL ---
var table dashboard = table.new(position.top_right, 2, 2, border_width = 1)
if barstate.islast
    // Text color logic
    valColor = pctDeviation < 0 ? color.lime : color.red
    
    table.cell(dashboard, 0, 0, "Current Deviation", bgcolor=color.gray, text_color=color.white)
    table.cell(dashboard, 1, 0, str.tostring(pctDeviation, "#.##") + "%", bgcolor=valColor, text_color=color.black)
    
    table.cell(dashboard, 0, 1, "Target Threshold", bgcolor=color.gray, text_color=color.white)
    table.cell(dashboard, 1, 1, str.tostring(devThreshold1) + "%", bgcolor=color.black, text_color=color.white)
