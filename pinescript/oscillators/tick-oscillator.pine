//@version=6
indicator("NYSE TICK Oscillator", shorttitle="Tick Osc", overlay=false)

// --- Inputs
tickSymbol    = input.symbol("USI:TICK", "NYSE TICK Symbol")
sourceTf      = input.timeframe("", "Source Timeframe", tooltip="Leave blank to use the chart timeframe.")
smoothingLen  = input.int(1, "Smoothing Length", minval=1, tooltip="Apply a simple moving average to the TICK values.")
extremeLevel  = input.int(600, "Conviction Threshold", minval=1, tooltip="Levels that mark strong buying and selling conviction.")
highlightFill = input.bool(true, "Highlight Extremes", inline="bg")
highlightBg   = input.bool(true, "Tint Background", inline="bg")
colorThreshold = input.int(400, "Color Threshold", minval=0, tooltip="Levels where the line color switches between positive/negative/neutral.")

structureGroup   = "Structure & Divergence"
structureLen     = input.int(5, "Pivot Length", minval=1, group=structureGroup, tooltip="Number of bars on each side used to confirm swing highs and lows.")
showStructure    = input.bool(true, "Show Structure Labels", group=structureGroup)
showDivergence   = input.bool(true, "Show Divergences vs Index", group=structureGroup)
referenceSymbol  = input.symbol("SP:SPX", "Reference Index Symbol", group=structureGroup, tooltip="Index used when checking for breadth divergences (e.g., SP:SPX, NASDAQ:NDX).")

// --- Data
defaultTf     = "5"  // Pull 1-minute TICK data by default for responsiveness on intraday charts.
requestTf     = sourceTf == "" ? defaultTf : sourceTf
tickSeries  = request.security(tickSymbol, requestTf, close, gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
tickValueRaw = nz(tickSeries, nz(tickSeries[1], 0))
tickValue   = smoothingLen > 1 ? ta.sma(tickValueRaw, smoothingLen) : tickValueRaw

indexSeriesRaw = request.security(referenceSymbol, requestTf, close, gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
indexSeries    = nz(indexSeriesRaw, nz(indexSeriesRaw[1], 0))

// --- Bounds
upperConviction = extremeLevel
lowerConviction = -extremeLevel

// --- Plots & Styling
neutralColor = color.new(color.orange, 0)
positiveColor = color.new(color.lime, 0)
negativeColor = color.new(color.red, 0)
extremeColorHi = positiveColor
extremeColorLo = negativeColor

tickColor = tickValue > colorThreshold ? positiveColor : tickValue < -colorThreshold ? negativeColor : neutralColor

tickPlot = plot(tickValue, "NYSE TICK", color=tickColor, linewidth=2)
zeroPlot = plot(0, "Zero Line", color=color.new(color.gray, 75))

// Visible conviction bands
hline(upperConviction, "Upper Conviction", color=color.new(color.gray, 55), linestyle=hline.style_dashed)
hline(lowerConviction, "Lower Conviction", color=color.new(color.gray, 55), linestyle=hline.style_dashed)

// Hidden plots for fill effects
upperBandPlot = plot(upperConviction, "Upper Bound (Fill)", display=display.none)
lowerBandPlot = plot(lowerConviction, "Lower Bound (Fill)", display=display.none)
extremeHighPlot = plot(tickValue > upperConviction ? tickValue : na, "Extreme High", color=extremeColorHi, linewidth=3, style=plot.style_linebr)
extremeLowPlot  = plot(tickValue < lowerConviction ? tickValue : na, "Extreme Low", color=extremeColorLo, linewidth=3, style=plot.style_linebr)

fill(extremeHighPlot, upperBandPlot, color=highlightFill ? color.new(extremeColorHi, 80) : na)
fill(extremeLowPlot, lowerBandPlot, color=highlightFill ? color.new(extremeColorLo, 80) : na)

bgcolor(highlightBg ? (tickValue > upperConviction ? color.new(extremeColorHi, 85) : tickValue < lowerConviction ? color.new(extremeColorLo, 85) : na) : na, title="Extreme Background")

// --- Alerts
alertcondition(tickValue > upperConviction, "TICK Breaks Above +Threshold", "NYSE TICK has moved above the positive conviction threshold.")
alertcondition(tickValue < lowerConviction, "TICK Breaks Below -Threshold", "NYSE TICK has moved below the negative conviction threshold.")
