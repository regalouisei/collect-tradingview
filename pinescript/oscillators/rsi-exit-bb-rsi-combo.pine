//@version=5
indicator("RSI Exit + BB-RSI Combo", overlay=true)

// ───────────────────────────
// 1) RSI 과열/과매도 → 일반구간 마감 표시
//    - 15m, 30m, 1h, 4h, 1D 에서만 표시
//    - 과열 해제: 캔들 위 빨간 'RSI'
//    - 과매도 해제: 캔들 아래 초록 'RSI'
// ───────────────────────────
rsiLen = input.int(14, "RSI 기간", group="RSI Exit")
ob     = input.float(70.0, "과열선(위)", group="RSI Exit")
os     = input.float(30.0, "과매도선(아래)", group="RSI Exit")

rsi = ta.rsi(close, rsiLen)

// 허용 타임프레임 체크
curTf = timeframe.period
isRsiTf =
     (curTf == "15" or curTf == "15m") or
     (curTf == "30" or curTf == "30m") or
     (curTf == "60" or curTf == "1H" or curTf == "1h") or
     (curTf == "240" or curTf == "4H" or curTf == "4h") or
     (curTf == "1D" or curTf == "D")

// 과열 → 일반
rsiExitOverbought = rsi[1] > ob and rsi < ob
// 과매도 → 일반
rsiExitOversold   = rsi[1] < os and rsi > os

// 표시
plotchar(isRsiTf and rsiExitOverbought,
     title="RSI 과열 해제",
     char="RSI",
     location=location.abovebar,
     color=color.new(color.red, 0),
     size=size.tiny)

plotchar(isRsiTf and rsiExitOversold,
     title="RSI 과매도 해제",
     char="RSI",
     location=location.belowbar,
     color=color.new(color.lime, 0),
     size=size.tiny)

// 알림
alertcondition(isRsiTf and rsiExitOverbought, "RSI 과열→일반", "RSI가 과열권에서 일반구간으로 내려왔습니다.")
alertcondition(isRsiTf and rsiExitOversold,   "RSI 과매도→일반", "RSI가 과매도권에서 일반구간으로 올라왔습니다.")


// ───────────────────────────
// 2) RSI 다이버전스(과열→일반 / 과매도→일반) + 볼밴 재진입 콤보
//    - 1시간봉 이상에서만
//    - 둘 다 맞을 때만 다이아몬드 시그널
// ───────────────────────────
curTfSec = timeframe.in_seconds(timeframe.period)
is1hUp   = curTfSec >= 60 * 60

bbLen  = input.int(20, "BB Length", group="BB-RSI Combo")
bbMult = input.float(2.0, "BB Mult", group="BB-RSI Combo")

bbBasis = ta.sma(close, bbLen)
bbDev   = ta.stdev(close, bbLen) * bbMult
bbUpper = bbBasis + bbDev
bbLower = bbBasis - bbDev

plot(bbBasis, "BB Basis", color=color.new(color.white, 80))
plot(bbUpper, "BB Upper", color=color.new(color.red, 80))
plot(bbLower, "BB Lower", color=color.new(color.green, 80))

// RSI 다이버전스용 기준
divExitOB  = rsi[1] > ob and rsi < ob
barsFromOB = ta.barssince(rsi > ob)

hasOB = not na(barsFromOB)
prevHighOB = hasOB and barsFromOB > 0 ? high[barsFromOB] : na
prevRsiOB  = hasOB and barsFromOB > 0 ? rsi[barsFromOB]  : na

bearDiv = divExitOB and hasOB and barsFromOB > 0 and not na(prevHighOB) and not na(prevRsiOB) and high > prevHighOB and rsi < prevRsiOB

divExitOS  = rsi[1] < os and rsi > os
barsFromOS = ta.barssince(rsi < os)

hasOS = not na(barsFromOS)
prevLowOS = hasOS and barsFromOS > 0 ? low[barsFromOS] : na
prevRsiOS = hasOS and barsFromOS > 0 ? rsi[barsFromOS] : na

bullDiv = divExitOS and hasOS and barsFromOS > 0 and not na(prevLowOS) and not na(prevRsiOS) and low < prevLowOS and rsi > prevRsiOS

// 볼밴 재진입 (몸통 기준)
bbReBuy  = is1hUp and close[1] < bbLower[1] and close > bbLower
bbReSell = is1hUp and close[1] > bbUpper[1] and close < bbUpper

// 콤보
comboBuy  = is1hUp and bullDiv and bbReBuy
comboSell = is1hUp and bearDiv and bbReSell

// 콤보 시그널 (작게)
plotshape(comboBuy,
     title="COMBO BUY",
     style=shape.diamond,
     location=location.belowbar,
     color=color.new(color.lime, 0),
     size=size.small)

plotshape(comboSell,
     title="COMBO SELL",
     style=shape.diamond,
     location=location.abovebar,
     color=color.new(color.red, 0),
     size=size.small)

// 알림
alertcondition(comboBuy,  "COMBO BUY",  "RSI 다이버전스 + 볼밴 재진입 매수")
alertcondition(comboSell, "COMBO SELL", "RSI 다이버전스 + 볼밴 재진입 매도")
