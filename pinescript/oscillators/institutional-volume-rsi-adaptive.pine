//@version=6
indicator("Institutional Volume RSI [Adaptive]", shorttitle="IV-RSI [Adaptive]", format=format.price, precision=2)

// -----------------------------------------------------------------------------
// 1. SETTINGS
// -----------------------------------------------------------------------------
grp_rsi = "RSI Settings"
rsi_len = input.int(14, "RSI Length", minval=1, group=grp_rsi)
src_type = input.string("VWMA (Volume Weighted)", "Source Type", options=["VWMA (Volume Weighted)", "Close (Standard)"], group=grp_rsi, tooltip="VWMA weights the RSI by volume. 'Close' is standard RSI.")

grp_bands = "Adaptive Bands (Volatility)"
bb_len  = input.int(20, "Bands Length", minval=1, group=grp_bands)
bb_mult = input.float(2.0, "Bands Multiplier", minval=0.1, step=0.1, group=grp_bands, tooltip="Standard Deviation for the bands. 2.0 is standard.")

// -----------------------------------------------------------------------------
// 2. CALCULATIONS
// -----------------------------------------------------------------------------

// 1. Determine the Source
// If "VWMA", we use the Volume Weighted Moving Average of the price.
// This filters out "fake" price moves on low volume.
rsi_src = src_type == "VWMA (Volume Weighted)" ? ta.vwma(close, rsi_len) : close

// 2. Calculate the RSI
rsi_val = ta.rsi(rsi_src, rsi_len)

// 3. Calculate the Adaptive Bands (Bollinger on RSI)
basis = ta.sma(rsi_val, bb_len)
dev   = ta.stdev(rsi_val, bb_len)
upper = basis + (dev * bb_mult)
lower = basis - (dev * bb_mult)

// -----------------------------------------------------------------------------
// 3. VISUALS & COLORS
// -----------------------------------------------------------------------------

// Dynamic Color for RSI Line
// Green if above the middle line (Bullish Momentum), Red if below (Bearish)
rsi_color = rsi_val > basis ? #00E676 : #FF5252

// Plot the Adaptive Bands
p_upper = plot(upper, "Upper Band", color=color.new(color.gray, 50))
p_lower = plot(lower, "Lower Band", color=color.new(color.gray, 50))
fill(p_upper, p_lower, color=color.new(color.blue, 95), title="Volatility Zone")

// Plot the Middle Line (Baseline)
plot(basis, "Baseline", color=color.new(color.white, 70), style=plot.style_circles)

// Plot the Main RSI Line
plot(rsi_val, "Institutional RSI", color=rsi_color, linewidth=2)

// -----------------------------------------------------------------------------
// 4. SIGNALS (BREAKOUTS)
// -----------------------------------------------------------------------------

// Signal: RSI breaks OUT of the volatility bands
// This indicates an "Extreme" move that is statistically significant
cross_up = ta.crossover(rsi_val, upper)
cross_dn = ta.crossunder(rsi_val, lower)

// Plot "Extreme" dots
plot(cross_up ? rsi_val : na, "Bullish Extreme", color=color.white, style=plot.style_circles, linewidth=3, offset=0)
plot(cross_dn ? rsi_val : na, "Bearish Extreme", color=color.white, style=plot.style_circles, linewidth=3, offset=0)

// Alerts
alertcondition(cross_up, title="Bullish Volatility Breakout", message="IV-RSI broke above Upper Band")
alertcondition(cross_dn, title="Bearish Volatility Breakout", message="IV-RSI broke below Lower Band")
