//@version=5
indicator("Smart Signals [Vdubus]", shorttitle="Smart Signals", overlay=false)

// --- 1. SETTINGS ---
// Trend
hmaLen  = input.int(200, "Trend Length (HMA)", group="Trend Filter")
// Momentum
fastLen = input.int(21, "MACD Fast", group="Momentum")
slowLen = input.int(34, "MACD Slow", group="Momentum")
sigLen  = input.int(7,  "MACD Signal", group="Momentum")
// Trigger
kLen    = input.int(14, "Stoch Length", group="Trigger")

// --- 2. TREND FILTER (The Sheriff) ---
src = close
// Formula: wmaHalf = hmaLen / 1 (Difference Weighted)
wmaFull = ta.wma(src, hmaLen)
wmaHalf = ta.wma(src, hmaLen / 1) 
diff    = 2 * wmaHalf - wmaFull
hmaValue = ta.wma(diff, math.floor(math.sqrt(hmaLen)))

// Trend Direction
isTrendUp   = (hmaValue - hmaValue[1]) > 0
isTrendDown = (hmaValue - hmaValue[1]) < 0

// --- 3. MOMENTUM (MACD) ---
[macdLine, signalLine, hist] = ta.macd(src, fastLen, slowLen, sigLen)

// --- 4. STANDARD SIGNALS (Diamonds) ---
k = ta.sma(ta.stoch(close, high, low, kLen), 3)

stdBuy = isTrendUp and ta.crossover(k, 20)
stdSell = isTrendDown and ta.crossunder(k, 80)

// --- 5. HIDDEN DIVERGENCE SIGNALS (Gold Crosses) ---
lbL = 5
lbR = 2

// Bullish Div
plFound = not na(ta.pivotlow(hist, lbL, lbR))
var float lastPlHist = na
var float lastPlPrice = na
bool isBullDiv = false

if plFound
    if isTrendUp and hist[lbR] < lastPlHist and low[lbR] > lastPlPrice
        isBullDiv := true
    lastPlHist := hist[lbR]
    lastPlPrice := low[lbR]

// Bearish Div
phFound = not na(ta.pivothigh(hist, lbL, lbR))
var float lastPhHist = na
var float lastPhPrice = na
bool isBearDiv = false

if phFound
    if isTrendDown and hist[lbR] > lastPhHist and high[lbR] < lastPhPrice
        isBearDiv := true
    lastPhHist := hist[lbR]
    lastPhPrice := high[lbR]

divBuy = plFound and isBullDiv
divSell = phFound and isBearDiv

// --- 6. VISUALS ---

// Colors
c_gold = #FFD700            // Gold (Div)
c_blue = #2962FF            // Blue (Standard Buy)
c_red  = color.new(#FF5252, 20) // Red (Standard Sell)
c_gray = color.new(color.gray, 95)

// Bar Coloring
var color col_bar = na

if isTrendUp
    if hist < 0
        if divBuy
            col_bar := c_gold
        else if stdBuy
            col_bar := color.new(c_blue, 0)
        else
            col_bar := color.new(c_blue, 40)
    else
        col_bar := c_gray
else if isTrendDown
    if hist > 0
        if divSell
            col_bar := c_gold
        else if stdSell
            col_bar := color.new(c_red, 0)
        else
            col_bar := c_red
    else
        col_bar := c_gray
else
    col_bar := c_gray

// Plot Histogram
plot(hist, title="Smart Momentum", color=col_bar, style=plot.style_columns, linewidth=1)
hline(0, "Zero", color=color.gray)

// Plot Shapes
plotshape(stdBuy, title="Standard Buy", style=shape.diamond, location=location.bottom, color=c_blue, size=size.tiny)
plotshape(stdSell, title="Standard Sell", style=shape.diamond, location=location.top, color=c_red, size=size.tiny)

plotshape(divBuy ? 0 : na, title="Div Buy", style=shape.cross, location=location.absolute, color=c_gold, size=size.small)
plotshape(divSell ? 0 : na, title="Div Sell", style=shape.cross, location=location.absolute, color=c_gold, size=size.small)

// --- 7. ALERTS (The "TV" Request) ---

// Specific Alerts (User selects "Gold Buy" in the dropdown)
alertcondition(divBuy, "Gold Buy (Sniper)", "Hidden Divergence Buy Detected")
alertcondition(divSell, "Gold Sell (Sniper)", "Hidden Divergence Sell Detected")
alertcondition(stdBuy, "Standard Buy (Trend)", "Standard Pullback Buy Detected")
alertcondition(stdSell, "Standard Sell (Trend)", "Standard Pullback Sell Detected")

// Combined Alerts (For users who just want "Any Buy")
alertcondition(divBuy or stdBuy, "ANY BUY Signal", "Buy Signal Detected (Gold or Standard)")
alertcondition(divSell or stdSell, "ANY SELL Signal", "Sell Signal Detected (Gold or Standard)")
