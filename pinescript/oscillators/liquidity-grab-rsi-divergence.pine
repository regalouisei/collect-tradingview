//@version=5
indicator("Liquidity Grab + RSI Divergence", overlay=true)

// Input parameters
lookback = input.int(20, "Lookback Period", minval=5, maxval=100)
rsiLength = input.int(14, "RSI Length", minval=5, maxval=50)
rsiDivergenceLookback = input.int(5, "RSI Divergence Lookback", minval=3, maxval=20)
showLabels = input.bool(true, "Show Labels")

// Calculate RSI
rsi = ta.rsi(close, rsiLength)

// Calculate previous highs and lows
var float prevHigh = na
var float prevLow = na

// Track the highest high and lowest low over lookback period
highestHigh = ta.highest(high, lookback)
lowestLow = ta.lowest(low, lookback)

// Update previous high/low on bar completion
if ta.change(time)
    prevHigh := highestHigh[1]
    prevLow := lowestLow[1]

// Detect liquidity grab conditions
// Price takes out previous low then closes above it
liquidityGrabLow = low < prevLow and close > prevLow

// Price takes out previous high then closes below it
liquidityGrabHigh = high > prevHigh and close < prevHigh

// Detect RSI Divergence
// Bullish divergence: Price makes lower low, RSI makes higher low
var float prevPriceLow = na
var float prevRSILow = na
var int prevLowBar = na

if ta.pivotlow(low, rsiDivergenceLookback, rsiDivergenceLookback)
    prevPriceLow := low[rsiDivergenceLookback]
    prevRSILow := rsi[rsiDivergenceLookback]
    prevLowBar := bar_index - rsiDivergenceLookback

bullishDivergence = false
if not na(prevPriceLow) and not na(prevRSILow)
    // Current low is lower than previous low (lower low in price)
    // But RSI low is higher than previous RSI low (higher low in RSI)
    if low < prevPriceLow and rsi > prevRSILow
        bullishDivergence := true

// Bearish divergence: Price makes higher high, RSI makes lower high
var float prevPriceHigh = na
var float prevRSIHigh = na
var int prevHighBar = na

if ta.pivothigh(high, rsiDivergenceLookback, rsiDivergenceLookback)
    prevPriceHigh := high[rsiDivergenceLookback]
    prevRSIHigh := rsi[rsiDivergenceLookback]
    prevHighBar := bar_index - rsiDivergenceLookback

bearishDivergence = false
if not na(prevPriceHigh) and not na(prevRSIHigh)
    // Current high is higher than previous high (higher high in price)
    // But RSI high is lower than previous RSI high (lower high in RSI)
    if high > prevPriceHigh and rsi < prevRSIHigh
        bearishDivergence := true

// Combined signals: Liquidity grab + RSI divergence
buySignal = liquidityGrabLow and bullishDivergence
sellSignal = liquidityGrabHigh and bearishDivergence

// Plot signals
plotshape(buySignal, title="BUY", location=location.belowbar, 
          color=color.green, style=shape.triangleup, size=size.normal)

plotshape(sellSignal, title="SELL", location=location.abovebar, 
          color=color.red, style=shape.triangledown, size=size.normal)

// Add text labels
if buySignal and showLabels
    label.new(bar_index, low, "BUY\nLiq + Div", 
              style=label.style_label_up, 
              color=color.green, 
              textcolor=color.white, 
              size=size.normal)

if sellSignal and showLabels
    label.new(bar_index, high, "SELL\nLiq + Div", 
              style=label.style_label_down, 
              color=color.red, 
              textcolor=color.white, 
              size=size.normal)

// Plot previous high/low levels for reference
plot(prevHigh, "Previous High", color=color.new(color.red, 70), linewidth=1, style=plot.style_linebr)
plot(prevLow, "Previous Low", color=color.new(color.green, 70), linewidth=1, style=plot.style_linebr)

// Optional: Show individual components (for debugging/visualization)
plotshape(liquidityGrabLow and not buySignal, title="Liq Grab Low Only", 
          location=location.belowbar, color=color.new(color.green, 70), 
          style=shape.circle, size=size.tiny)
          
plotshape(liquidityGrabHigh and not sellSignal, title="Liq Grab High Only", 
          location=location.abovebar, color=color.new(color.red, 70), 
          style=shape.circle, size=size.tiny)

plotshape(bullishDivergence and not buySignal, title="Bullish Div Only", 
          location=location.belowbar, color=color.new(color.blue, 50), 
          style=shape.xcross, size=size.tiny)
          
plotshape(bearishDivergence and not sellSignal, title="Bearish Div Only", 
          location=location.abovebar, color=color.new(color.orange, 50), 
          style=shape.xcross, size=size.tiny)

// Alert conditions
alertcondition(buySignal, title="BUY Signal", 
               message="BUY: Liquidity Grab + Bullish RSI Divergence")
alertcondition(sellSignal, title="SELL Signal", 
               message="SELL: Liquidity Grab + Bearish RSI Divergence")
