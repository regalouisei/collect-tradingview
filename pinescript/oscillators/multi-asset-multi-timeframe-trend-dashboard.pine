//@version=5
indicator("Multi Asset & Multi Timeframe Trend Dashboard", overlay=false, max_labels_count=500)

// ━━━━━━━━━━━━━━━━━━━
// INPUTS
// ━━━━━━━━━━━━━━━━━━━
is_mobile = input.bool(false, "Enable Mobile Compact View")
vol_threshold = input.float(1.2, "Volatility Factor", step=0.1)

sym1 = input.symbol("BTCUSDT", "Symbol 1"), sym2 = input.symbol("ETHUSDT", "Symbol 2")
sym3 = input.symbol("US30", "Symbol 3"), sym4 = input.symbol("US100", "Symbol 4")
sym5 = input.symbol("EURUSD", "Symbol 5")

// Timeframe Dropdown Menus
tf1 = input.string("15", "Timeframe 1", options=["5", "15", "30", "60", "120", "240", "480", "D", "W", "M", "12M"])
tf2 = input.string("60", "Timeframe 2", options=["5", "15", "30", "60", "120", "240", "480", "D", "W", "M", "12M"])
tf3 = input.string("240", "Timeframe 3", options=["5", "15", "30", "60", "120", "240", "480", "D", "W", "M", "12M"])
tf4 = input.string("D", "Timeframe 4", options=["5", "15", "30", "60", "120", "240", "480", "D", "W", "M", "12M"])

// Helper function with correct Pine Script v5 syntax
f_tf_label(tf) => 
    result = ""
    if tf == "60"
        result := "1h"
    else if tf == "120"
        result := "2h"
    else if tf == "240"
        result := "4h"
    else if tf == "480"
        result := "8h"
    else if tf == "12M"
        result := "Y"
    else if tf == "D" or tf == "W" or tf == "M"
        result := tf
    else
        result := tf + " min."
    result

// ━━━━━━━━━━━━━━━━━━━
// BUNDLED LOGIC FUNCTION
// ━━━━━━━━━━━━━━━━━━━
f_check_market() =>
    not na(time("1", syminfo.session)) and last_bar_time > (timenow - 900000) ? 1.0 : 0.0

f_all_inds() =>
    ema20 = ta.ema(close, 20), ema50 = ta.ema(close, 50), ema200 = ta.ema(close, 200)
    mLine = ta.ema(close, 12) - ta.ema(close, 26), mSig = ta.ema(mLine, 9)
    r = ta.rsi(close, 14), rMA = ta.sma(r, 14)
    sK = ta.stoch(close, high, low, 14), sD = ta.sma(sK, 3)
    cci = ta.cci(close, 20), ao = ta.sma(hl2, 5) - ta.sma(hl2, 34)
    array.from(ema20 > ema50 ? 1.0 : -1.0, ema50 > ema200 ? 1.0 : -1.0, close > ema200 ? 1.0 : -1.0, mLine > mSig ? 1.0 : -1.0, (mLine - mSig) > 0 ? 1.0 : -1.0, r > rMA ? 1.0 : -1.0, r > 50 ? 1.0 : -1.0, sK > sD ? 1.0 : -1.0, cci > 0 ? 1.0 : -1.0, ao > 0 ? 1.0 : -1.0, f_check_market())

f_volatility() =>
    ta.atr(14) > ta.sma(ta.atr(14), 20) * vol_threshold ? 1.0 : 0.0

// ━━━━━━━━━━━━━━━━━━━
// HELPERS & DRAWING
// ━━━━━━━━━━━━━━━━━━━
f_sum_arr(arr) =>
    s = 0.0
    for i = 0 to 9
        s += array.get(arr, i)
    s

f_get_signal_assets(score) =>
    string char = score > 0 ? "▲" : score < 0 ? "▼" : "✖"
    color  col  = score > 0 ? #006400 : score < 0 ? #8B0000 : color.gray
    [char, col]

f_draw_dots(t, row, startCol, arr, mob) =>
    var string[] name_list = array.from("EMA 20 > 50", "EMA 50 > 200", "Price > EMA 200", "MACD Signal", "MACD Hist", "RSI > Signal", "RSI > 50", "Stoch K > D", "CCI > 0", "Awesome Osc")
    score = 0.0
    for i = 0 to 9
        v = array.get(arr, i)
        if not mob
            table.cell(t, startCol + i, row, "■", text_color=(v == 1.0 ? #006400 : #8B0000), text_size=size.tiny, tooltip=array.get(name_list, i))
        score += v
    
    [txt, clr] = f_get_signal_assets(score)
    int arrowCol = mob ? (startCol == 1 ? 1 : startCol == 12 ? 2 : startCol == 23 ? 3 : 4) : startCol + 10
    table.cell(t, arrowCol, row, txt, text_color=clr, tooltip="Score: " + str.tostring(score))
    score

// ━━━━━━━━━━━━━━━━━━━
// RENDER ROW
// ━━━━━━━━━━━━━━━━━━━
f_render_row(t, row, s_name, i1, i2, i3, i4, m1, m3, m5, vol, mob) =>
    market_open = array.get(i1, 10) == 1.0
    table.cell(t, 0, row, s_name + (vol == 1.0 ? " •" : ""), bgcolor=(market_open ? color.new(color.green, 50) : color.new(color.red, 50)), text_color=color.white, text_size=mob ? size.small : size.normal)
    
    s1 = f_draw_dots(t, row, 1, i1, mob), s2 = f_draw_dots(t, row, 12, i2, mob)
    s3 = f_draw_dots(t, row, 23, i3, mob), s4 = f_draw_dots(t, row, 34, i4, mob)
    
    total = s1 + s2 + s3 + s4
    string tot_txt = total > 0 ? "▲" : total < 0 ? "▼" : "✖"
    color tot_clr = total >= 30 ? #00FF00 : total > 0 ? #006400 : total <= -30 ? #FF0000 : total < 0 ? #8B0000 : color.gray
    
    table.cell(t, mob ? 5 : 45, row, tot_txt, text_color=tot_clr, text_size=mob ? size.small : size.normal, tooltip="Total Score: " + str.tostring(total))
    table.cell(t, mob ? 6 : 46, row, " ", bgcolor=color.new(color.black, 100))
    
    m1_s = f_sum_arr(m1), m3_s = f_sum_arr(m3), m5_s = f_sum_arr(m5)
    [m1_t, m1_c] = f_get_signal_assets(m1_s), [m3_t, m3_c] = f_get_signal_assets(m3_s), [m5_t, m5_c] = f_get_signal_assets(m5_s)
    
    table.cell(t, mob ? 7 : 47, row, m1_t, text_color=m1_c, tooltip="Score: " + str.tostring(m1_s))
    table.cell(t, mob ? 8 : 48, row, m3_t, text_color=m3_c, tooltip="Score: " + str.tostring(m3_s))
    table.cell(t, mob ? 9 : 49, row, m5_t, text_color=m5_c, tooltip="Score: " + str.tostring(m5_s))

// ━━━━━━━━━━━━━━━━━━━
// DATA COLLECTION
// ━━━━━━━━━━━━━━━━━━━
f_get_symbol_data(s) =>
    d1 = request.security(s, tf1, f_all_inds()), d2 = request.security(s, tf2, f_all_inds())
    d3 = request.security(s, tf3, f_all_inds()), d4 = request.security(s, tf4, f_all_inds())
    m1 = request.security(s, "1", f_all_inds()), m3 = request.security(s, "3", f_all_inds())
    m5 = request.security(s, "5", f_all_inds()), v  = request.security(s, "D", f_volatility())
    [d1, d2, d3, d4, m1, m3, m5, v]

[i1_1, i1_2, i1_3, i1_4, i1_m1, i1_m3, i1_m5, v1] = f_get_symbol_data(sym1)
[i2_1, i2_2, i2_3, i2_4, i2_m1, i2_m3, i2_m5, v2] = f_get_symbol_data(sym2)
[i3_1, i3_2, i3_3, i3_4, i3_m1, i3_m3, i3_m5, v3] = f_get_symbol_data(sym3)
[i4_1, i4_2, i4_3, i4_4, i4_m1, i4_m3, i4_m5, v4] = f_get_symbol_data(sym4)
[i5_1, i5_2, i5_3, i5_4, i5_m1, i5_m3, i5_m5, v5] = f_get_symbol_data(sym5)

// ━━━━━━━━━━━━━━━━━━━
// TABLE SETUP
// ━━━━━━━━━━━━━━━━━━━
var table dash = table.new(position.top_left, 55, 6, border_width=1)

if barstate.islast
    color h_bg = color.black, color h_tx = color.white
    table.cell(dash, 0, 0, "Symbol", bgcolor=h_bg, text_color=h_tx)
    h1 = f_tf_label(tf1), h2 = f_tf_label(tf2), h3 = f_tf_label(tf3), h4 = f_tf_label(tf4)
    
    if not is_mobile
        table.cell(dash, 1, 0, h1, bgcolor=h_bg, text_color=h_tx), table.cell(dash, 12, 0, h2, bgcolor=h_bg, text_color=h_tx)
        table.cell(dash, 23, 0, h3, bgcolor=h_bg, text_color=h_tx), table.cell(dash, 34, 0, h4, bgcolor=h_bg, text_color=h_tx)
        table.cell(dash, 45, 0, "ALL", bgcolor=h_bg, text_color=h_tx)
        table.cell(dash, 47, 0, "1 min.", bgcolor=h_bg, text_color=h_tx), table.cell(dash, 48, 0, "3 min.", bgcolor=h_bg, text_color=h_tx), table.cell(dash, 49, 0, "5 min.", bgcolor=h_bg, text_color=h_tx)
    else
        table.cell(dash, 1, 0, h1, bgcolor=h_bg, text_color=h_tx), table.cell(dash, 2, 0, h2, bgcolor=h_bg, text_color=h_tx)
        table.cell(dash, 3, 0, h3, bgcolor=h_bg, text_color=h_tx), table.cell(dash, 4, 0, h4, bgcolor=h_bg, text_color=h_tx)
        table.cell(dash, 5, 0, "ALL", bgcolor=h_bg, text_color=h_tx), table.cell(dash, 7, 0, "1 min.", bgcolor=h_bg, text_color=h_tx), table.cell(dash, 8, 0, "3 min.", bgcolor=h_bg, text_color=h_tx), table.cell(dash, 9, 0, "5 min.", bgcolor=h_bg, text_color=h_tx)

    f_render_row(dash, 1, sym1, i1_1, i1_2, i1_3, i1_4, i1_m1, i1_m3, i1_m5, v1, is_mobile)
    f_render_row(dash, 2, sym2, i2_1, i2_2, i2_3, i2_4, i2_m1, i2_m3, i2_m5, v2, is_mobile)
    f_render_row(dash, 3, sym3, i3_1, i3_2, i3_3, i3_4, i3_m1, i3_m3, i3_m5, v3, is_mobile)
    f_render_row(dash, 4, sym4, i4_1, i4_2, i4_3, i4_4, i4_m1, i4_m3, i4_m5, v4, is_mobile)
    f_render_row(dash, 5, sym5, i5_1, i5_2, i5_3, i5_4, i5_m1, i5_m3, i5_m5, v5, is_mobile)
