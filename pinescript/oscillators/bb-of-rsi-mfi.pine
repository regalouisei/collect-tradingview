//@version=6
indicator("BB% of RSI + MFI", shorttitle="BB&RSI+MFI[BJ]", overlay=false)

source   = hlc3
length   = input.int(14, minval=1)
mult     = input.float(2.0, minval=0.001, maxval=50)
bblength = input.int(50, minval=1, title="BB Period")

DrawRSI_f = input.bool(true)
HighlightBreaches = input.bool(true)

// === MFI 表示切替 ===
ShowMFI = input.bool(true, "Show MFI")

// === RSI ===
rsi_s = DrawRSI_f ? ta.rsi(source, length) : na
plot(DrawRSI_f ? rsi_s : na, color=color.maroon, linewidth=2)

// === MFI（表示のみ・切替対応） ===
mfi = ShowMFI ? ta.mfi(source, length) : na
plot(mfi, color=color.rgb(4, 4, 4), linewidth=1, title="MFI")

// === Bollinger Bands on RSI ===
bb_s = rsi_s

basis = ta.sma(bb_s, length)
dev   = mult * ta.stdev(bb_s, bblength)

upper = basis + dev
lower = basis - dev

plot(basis, color=color.red)
p1 = plot(upper, color=color.blue)
p2 = plot(lower, color=color.blue)
fill(p1, p2, color=color.rgb(33, 149, 243, 80))

// === Background Highlight ===
b_color = bb_s > upper ? color.rgb(255, 82, 82, 30) :
          bb_s < lower ? color.rgb(255, 82, 82, 30) : na
bgcolor(HighlightBreaches ? b_color : na)

// === Visual Guide Bands ===
hline(80, "Upper Band", color=color.gray, linestyle=hline.style_dotted)
hline(20, "Lower Band", color=color.gray, linestyle=hline.style_dotted)
