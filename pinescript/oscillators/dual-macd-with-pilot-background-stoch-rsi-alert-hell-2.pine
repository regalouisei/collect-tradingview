//@version=5
indicator("Dual MACD With Pilot Background + 4-Color MACD2 Histogram + Stoch RSI Alerts", overlay=false)

//------------------------------
// COLOR DEFINITIONS (HEX â†’ RGB)
//------------------------------
macd1_bull = color.rgb(0, 0, 255)        // #0000FF
macd1_bear = color.rgb(245, 127, 23)     // #F57F17

macd2_bull = color.rgb(11, 248, 20)      // #0BF814
macd2_bear = color.rgb(255, 11, 11)      // #FF0B0B

// Histogram 4 Colors
hist_bull_up    = color.rgb(11, 248, 20)     // #0BF814
hist_bull_down  = color.rgb(255,205,210)     // #FFCDD2
hist_bear_down  = color.rgb(255, 11, 11)     // #FF0B0B
hist_bear_up    = color.rgb(178,223,219)     // #B2DFDB

//--------------------------------
// MACD 1 (12, 26, 9)
//--------------------------------
macd1_fast   = 12
macd1_slow   = 26
macd1_signal = 9

macd1 = ta.ema(close, macd1_fast) - ta.ema(close, macd1_slow)
sig1  = ta.ema(macd1, macd1_signal)

// Bull or bear color theme
macd1_color = macd1 >= sig1 ? macd1_bull : macd1_bear

p1  = plot(macd1, "MACD 1", color=macd1_color, linewidth=2)
p1s = plot(sig1,  "Signal 1", color=macd1_color, linewidth=2)
fill(p1, p1s, color=color.new(macd1_color, 80))

//--------------------------------
// MACD 2 (48, 104, 36)
//--------------------------------
macd2_fast   = 48
macd2_slow   = 104
macd2_signal = 36

macd2 = ta.ema(close, macd2_fast) - ta.ema(close, macd2_slow)
sig2  = ta.ema(macd2, macd2_signal)
hist2 = macd2 - sig2

macd2_color = macd2 >= sig2 ? macd2_bull : macd2_bear

p2  = plot(macd2, "MACD 2", color=macd2_color, linewidth=2)
p2s = plot(sig2,  "Signal 2", color=macd2_color, linewidth=2)
fill(p2, p2s, color=color.new(macd2_color, 80))

//--------------------------------
// MACD 2 HISTOGRAM (4-COLOR LOGIC)
//--------------------------------
hist_color =
     hist2 >= 0 and hist2 > hist2[1] ? hist_bull_up :
     hist2 >= 0 and hist2 <= hist2[1] ? hist_bull_down :
     hist2 < 0  and hist2 < hist2[1] ? hist_bear_down :
                                      hist_bear_up

plot(hist2, "MACD2 Histogram", style=plot.style_columns, color=hist_color)

//--------------------------------
// ZERO LINE
//--------------------------------
hline(0, "Zero Line", color=color.gray)

//--------------------------------
// STOCH RSI ZERO-LINE ALERTS
//--------------------------------
smoothK     = input.int(3, title="Stoch RSI K Smoothing")
lengthRSI   = input.int(14, title="Stoch RSI RSI Length")
lengthStoch = input.int(14, title="Stoch RSI Length")
rsiSrc      = input.source(close, "RSI Source")
upperLevel  = input.float(99.9, title="Upper Level")
lowerLevel  = input.float(0.2, title="Lower Level")
showStochLabels = input.bool(true, "Show Stoch RSI Alert Labels?")

// ALERT COLORS UPDATED
labelColorUp   = color.new(#0BF814, 0)   // Bright lime
labelColorDown = color.new(#FF0B0B, 0)   // Bright red

rsiValue = ta.rsi(rsiSrc, lengthRSI)
kLine    = ta.sma(ta.stoch(rsiValue, rsiValue, rsiValue, lengthStoch), smoothK)

var bool wasAboveUpper = false
var bool wasBelowLower = false

if kLine > upperLevel
    wasAboveUpper := true
if kLine < lowerLevel
    wasBelowLower := true

crossBackDown = wasAboveUpper and kLine < upperLevel
crossBackUp   = wasBelowLower and kLine > lowerLevel

if crossBackDown
    wasAboveUpper := false
if crossBackUp
    wasBelowLower := false

if showStochLabels and crossBackDown
    label.new(bar_index, 0, "", style=label.style_label_center, color=labelColorDown, textcolor=labelColorDown, size=size.normal)
if showStochLabels and crossBackUp
    label.new(bar_index, 0, "", style=label.style_label_center, color=labelColorUp, textcolor=labelColorUp, size=size.normal)

//--------------------------------
// ALERTS
//--------------------------------
alertcondition(crossBackDown, title="Stoch RSI Cross Back Down", message="Stoch RSI %K crossed back down from Upper Level")
alertcondition(crossBackUp, title="Stoch RSI Cross Back Up", message="Stoch RSI %K crossed back up from Lower Level")
