// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © AlphaNatt

//@version=6
indicator(title = 'Velocity Pressure Index | AlphaNatt', overlay = false, timeframe = '', timeframe_gaps = true)

import TradingView/ta/7 as ta

// Color definitions
bullColor = #00F1FF
bearColor = #FF019A

// Velocity Pressure Index | AlphaNatt
// Measures price velocity with volume pressure analysis

// Input Parameters
velocity_len = input.int(14, 'Velocity Period', minval = 5, maxval = 50, group = 'Velocity Settings')
pressure_len = input.int(21, 'Pressure Period', minval = 10, maxval = 100, group = 'Velocity Settings')
smooth_factor = input.int(3, 'Smoothing Factor', minval = 1, maxval = 10, group = 'Velocity Settings')

// Source Selection
src_high = input.source(high, 'High Source', group = 'Source Configuration')
src_low = input.source(low, 'Low Source', group = 'Source Configuration')
src_close = input.source(close, 'Close Source', group = 'Source Configuration')

// Calculate Price Velocity
typical_price = (src_high + src_low + src_close) / 3
price_change = typical_price - typical_price[1]
velocity = ta.linreg(price_change, velocity_len, 0)

// Volume Pressure Analysis
vol_avg = ta.sma(volume, pressure_len)
bull_pressure = volume * (close > open ? 1 : 0.3)
bear_pressure = volume * (close < open ? 1 : 0.3)

bull_ratio = ta.sma(bull_pressure, pressure_len) / vol_avg
bear_ratio = ta.sma(bear_pressure, pressure_len) / vol_avg
pressure_diff = bull_ratio - bear_ratio

// Combine Velocity and Pressure
raw_index = velocity * (1 + pressure_diff)
smoothed_index = ta.ema(raw_index, smooth_factor)

// Oscillator Normalization
norm_len = input.int(50, 'Normalization Period', minval = 20, maxval = 200, group = 'Normalization')
highest = ta.highest(smoothed_index, norm_len)
lowest = ta.lowest(smoothed_index, norm_len)
range_val = highest - lowest

normalized = range_val != 0 ? ((smoothed_index - lowest) / range_val - 0.5) * 200 : 0

// Signal Line
signal_type = input.string('DEMA', 'Signal Type', options = ['SMA', 'EMA', 'DEMA'], group = 'Signal Line')
signal_len = input.int(9, 'Signal Length', minval = 3, maxval = 20, group = 'Signal Line')

signal = switch signal_type
    'SMA' => ta.sma(normalized, signal_len)
    'EMA' => ta.ema(normalized, signal_len)
    'DEMA' => ta.dema(normalized, signal_len)
    => ta.ema(normalized, signal_len)

// Dynamic Zones
zone_len = input.int(100, 'Zone Lookback', minval = 50, maxval = 500, group = 'Dynamic Zones')
overbought = ta.percentile_nearest_rank(normalized, zone_len, 80)
oversold = ta.percentile_nearest_rank(normalized, zone_len, 20)

// Momentum Analysis
momentum = normalized - signal
mom_accel = momentum - momentum[1]

// Signal Conditions
strong_bull = normalized > signal and momentum > 0 and mom_accel > 0
strong_bear = normalized < signal and momentum < 0 and mom_accel < 0

cross_bull = ta.crossover(normalized, signal) and normalized > oversold
cross_bear = ta.crossunder(normalized, signal) and normalized < overbought

L = strong_bull or cross_bull
S = strong_bear or cross_bear

// State Tracking
var vii = 0
if L and not S
    vii := 1
    vii
if S
    vii := -1
    vii

// Color Logic
main_color = normalized > signal ? bullColor : bearColor
state_color = vii == 1 ? bullColor : vii == -1 ? bearColor : color.gray

// Main Oscillator Plot
plot(normalized, 'VPI', color = state_color, linewidth = 2)
plot(signal, 'Signal', color = color.new(color.white, 60), linewidth = 1)

// Dynamic Zones
ob_line = plot(overbought, 'Overbought', color = color.new(bearColor, 70), style = plot.style_line)
os_line = plot(oversold, 'Oversold', color = color.new(bullColor, 70), style = plot.style_line)

// Zone Fills
fill(ob_line, os_line, color = color.new(color.gray, 96))

// Zero Line
hline(0, 'Zero', color = color.new(color.white, 50), linewidth = 1)

// Momentum Histogram
hist_color = momentum > 0 ? color.new(bullColor, 60) : color.new(bearColor, 60)
plot(momentum * 0.5, 'Momentum', style = plot.style_histogram, color = hist_color)

// Extreme Zones
hline(50, 'Extreme High', color = color.new(bearColor, 85), linestyle = hline.style_dotted)
hline(-50, 'Extreme Low', color = color.new(bullColor, 85), linestyle = hline.style_dotted)

// Cloud between oscillator and signal
p1 = plot(normalized, color = color.new(main_color, 100))
p2 = plot(signal, color = color.new(main_color, 100))
fill(p1, p2, color = color.new(main_color, 85))

// Background Zones
bgcolor(normalized > overbought ? color.new(bearColor, 95) : na)
bgcolor(normalized < oversold ? color.new(bullColor, 95) : na)

// Alert Conditions
alertcondition(L, title = 'VPI Long Signal', message = 'VPI Long Signal {{exchange}}:{{ticker}}')
alertcondition(S, title = 'VPI Short Signal', message = 'VPI Short Signal {{exchange}}:{{ticker}}')
alertcondition(cross_bull, title = 'VPI Bullish Cross', message = 'VPI Bullish Cross {{exchange}}:{{ticker}}')
alertcondition(cross_bear, title = 'VPI Bearish Cross', message = 'VPI Bearish Cross {{exchange}}:{{ticker}}')

// Extreme Alerts
extreme_ob = normalized > 75
extreme_os = normalized < -75
alertcondition(extreme_ob, title = 'VPI Extreme Overbought', message = 'VPI Extreme Overbought {{exchange}}:{{ticker}}')
alertcondition(extreme_os, title = 'VPI Extreme Oversold', message = 'VPI Extreme Oversold {{exchange}}:{{ticker}}')
