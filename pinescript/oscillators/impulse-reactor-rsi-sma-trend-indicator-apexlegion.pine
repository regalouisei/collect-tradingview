//@version=6
indicator("Impulse Reactor RSI-SMA Trend Indicator [ApexLegion]", 
         shorttitle="Impulse Reactor [ApexLegion]", 
         overlay=false, 
         max_labels_count=500, 
         max_lines_count=500, 
         max_boxes_count=500)

// ============================================================================
// üåê Language Settings
// ============================================================================
g_lang = "üåê Language Settings"
lang_opt = input.string("English", "Select Language", options=["English", "Korean", "Chinese", "Spanish"], group=g_lang)

// Helper function for multi-lingual conversion
t(en, kr, cn, es) => 
    if lang_opt == "Korean"
        kr
    else if lang_opt == "Chinese"
        cn
    else if lang_opt == "Spanish"
        es
    else
        en

// ============================================================================
// üé® Color Settings
// ============================================================================
g1 = "üé® Color Settings"
c_bull      = input.color(#00d5ff, "Bull Color", group=g1, inline="c1")
c_bear      = input.color(#ff00b3, "Bear Color", group=g1, inline="c1")
c_long_lbl  = input.color(#00ff7b, "Long Label", group=g1, inline="c2")
c_short_lbl = input.color(#ff0073, "Short Label", group=g1, inline="c2")
c_tp_long   = input.color(#07deff, "Long TP", group=g1, inline="c3")
c_sl_long   = input.color(#7b00ff, "Long SL", group=g1, inline="c3")
c_tp_short  = input.color(#ff00aa, "Short TP", group=g1, inline="c4")
c_sl_short  = input.color(#fdc84d, "Short SL", group=g1, inline="c4")
c_bg        = input.color(#363a4500, "Panel Background", group=g1)

// ============================================================================
// ‚ö° Impulse Core Settings
// ============================================================================
g2 = "‚ö° Impulse Core Settings"
devLen  = input.int(30, "Deviation Lookback", minval=5, maxval=200, group=g2)
fastLen = input.int(10, "Fast Pulse Length", minval=2, maxval=100, group=g2)
slowLen = input.int(30, "Slow Pulse Length", minval=5, maxval=200, group=g2)

// ============================================================================
// üéØ TP/SL Settings
// ============================================================================
g3 = "üéØ TP/SL Settings"
sl_fib      = input.float(0.786, "SL Fibonacci", options=[0.382, 0.5, 0.618, 0.786], group=g3)
sl_mult     = input.float(1.5, "SL Multiplier", minval=0.1, maxval=10.0, step=0.1, group=g3)
tp_fib      = input.float(1.618, "TP Fibonacci", options=[1.272, 1.618, 2.0, 2.618], group=g3)
tp_mult     = input.float(2.0, "TP Multiplier", minval=0.1, maxval=10.0, step=0.1, group=g3)
atr_len     = input.int(14, "ATR Length", minval=1, maxval=100, group=g3)
use_soft_sl = input.bool(true, "Use Soft Stop (Close Basis)", tooltip="If enabled, SL triggers only when candle closes beyond the line.", group=g3)

// ============================================================================
// üîä Ribbon Settings
// ============================================================================
g4 = "üîä Ribbon Settings"
show_ribbon  = input.bool(true, "Show SMA Ribbon", group=g4)
ribbon_cnt   = input.int(15, "Ribbon Line Count", minval=2, maxval=15, group=g4)
ribbon_start = input.int(2, "Ribbon Start Length", minval=1, maxval=50, group=g4)
ribbon_step  = input.int(1, "Ribbon Length Step", minval=1, maxval=10, group=g4)

// ============================================================================
// üìé Display Options
// ============================================================================
g5 = "üìé Display Options"
show_entry    = input.bool(true, "Show Entry Lines", group=g5)
show_tpsl_box = input.bool(true, "Show TP/SL Box", group=g5)
show_label    = input.bool(true, "Show Position Labels", group=g5)
show_sr       = input.bool(true, "Show S/R Levels", group=g5)
show_sar_glow = input.bool(true, "Show SAR+MACD Glow", group=g5)
show_dashboard= input.bool(true, "Show Dashboard", group=g5)

// ============================================================================
// üåÄ SAR Settings
// ============================================================================
g6 = "üåÄ SAR Settings"
sar_start    = input.float(0.02, "SAR Start", minval=0.001, maxval=1.0, step=0.001, group=g6)
sar_inc      = input.float(0.02, "SAR Increment", minval=0.001, maxval=1.0, step=0.001, group=g6)
sar_max      = input.float(0.2, "SAR Maximum", minval=0.01, maxval=5.0, step=0.01, group=g6)
sar_atr_scale= input.float(4.0, "SAR Score Scaling (ATR)", minval=0.1, maxval=50.0, step=0.1, group=g6)
sar_inf_sens = input.float(0.05, "SAR Inflection Sensitivity", minval=0.0, maxval=5.0, step=0.01, group=g6)

// ============================================================================
// üìä MACD Settings
// ============================================================================
g7 = "üìä MACD Settings"
macd_fast = input.int(12, "MACD Fast Length", minval=1, maxval=200, group=g7)
macd_slow = input.int(26, "MACD Slow Length", minval=1, maxval=200, group=g7)
macd_sig  = input.int(9, "MACD Signal Length", minval=1, maxval=100, group=g7)

// ============================================================================
// üìà Trend Baseline Settings
// ============================================================================
g8 = "üìà Trend Baseline"
st_factor           = input.float(12, "Supertrend Factor", minval=1.0, maxval=100.0, step=0.5, group=g8)
st_atr_period       = input.int(90, "Supertrend ATR Period", minval=1, maxval=500, group=g8)
wma_length          = input.int(40, "WMA Length", minval=1, maxval=500, group=g8)
baseline_ema_length = input.int(14, "EMA Length", minval=1, maxval=200, group=g8)
show_baseline       = input.bool(true, "Show Baseline", group=g8)
min_trend_duration  = input.int(10, "Min Trend Duration", minval=1, maxval=100, group=g8)

// ============================================================================
// üß† Smart Exit Settings
// ============================================================================
g9 = "üß† Smart Exit"
use_smart_exit      = input.bool(true, "Use Smart Exit", group=g9)
conf_exit_threshold = input.float(3.0, "Exit Threshold Score", minval=0.0, maxval=10.0, step=0.5, group=g9)
conf_ma_period      = input.int(168, "Average Period (Hours)", minval=1, maxval=500, group=g9)
min_hold_bars       = input.int(5, "Min Hold Bars", minval=0, maxval=50, group=g9)

// ============================================================================
// üìê Baseline Slope Logic
// ============================================================================
g10 = "üìê Slope Trigger Logic"
use_slope_entry     = input.bool(true, "Force Entry on Steep Slope", group=g10)
slope_len           = input.int(20, "Slope Avg Length", minval=2, maxval=100, group=g10)
slope_mult          = input.float(1.5, "Slope Sensitivity", minval=0.1, maxval=10.0, step=0.1, group=g10)
use_slope_obos_bypass = input.bool(true, "Bypass OB/OS on Trigger", group=g10)

// ============================================================================
// üõë Flat Market Filter
// ============================================================================
g11 = "üõë Flat Market Filter (ADX & ATR)"
use_adx_filter      = input.bool(true, "Use ADX Filter", group=g11)
adx_threshold       = input.int(20, "ADX Threshold", minval=1, maxval=50, group=g11)
use_flat_filter     = input.bool(true, "Use ATR Flat Filter", group=g11)
flat_atr_mult       = input.float(0.15, "ATR Flat Sensitivity", minval=0.01, maxval=2.0, step=0.01, group=g11)

// ============================================================================
// üîÅ Consecutive Win Logic
// ============================================================================
g12 = "üîÅ Anti-Greed Logic"
use_consecutive_filter = input.bool(true, "Strict Entry after Win", group=g12)
consecutive_strict_mult = input.float(1.1, "Strict Multiplier", minval=1.0, maxval=5.0, step=0.1, group=g12)

// ============================================================================
// üåç HTF Filter (Auto-Adaptive)
// ============================================================================
g13 = "üåç HTF Filter"
use_htf_filter      = input.bool(true, "Use Auto-Adaptive HTF Filter", tooltip="Automatically selects the Higher Timeframe based on current chart TF.", group=g13)
use_slope_htf_bypass= input.bool(true, "Bypass HTF on Steep Trigger", group=g13)

// ============================================================================
// üìâ RSI Peak Exit & Choppiness
// ============================================================================
g14 = "üìâ RSI Peak & Choppiness"
use_div_exit        = input.bool(true, "RSI Peak Exit (Instant)", group=g14)
div_lookback        = input.int(5, "Pivot Lookback", minval=2, maxval=50, group=g14)
use_chop_filter     = input.bool(true, "Choppiness Filter", group=g14)
chop_len            = input.int(14, "Choppiness Length", minval=2, maxval=100, group=g14)
chop_threshold      = input.float(60.0, "Choppiness Threshold", minval=10.0, maxval=90.0, group=g14)

// ============================================================================
// üõ°Ô∏è Trailing Stop
// ============================================================================
g15 = "üõ°Ô∏è Trailing Stop (Step)"
use_trail_stop      = input.bool(true, "Use Trailing Stop", group=g15)
trail_arm_pct1      = input.float(0.5, "Step 1: Activation %", minval=0.1, maxval=100.0, step=0.1, group=g15)
trail_offset_pct1   = input.float(0.5, "Step 1: Offset %", minval=0.1, maxval=100.0, step=0.1, group=g15)
trail_arm_pct2      = input.float(1.0, "Step 2: Activation %", minval=0.1, maxval=100.0, step=0.1, group=g15)
trail_offset_pct2   = input.float(0.2, "Step 2: Offset %", minval=0.1, maxval=100.0, step=0.1, group=g15)

// ============================================================================
// üìÑ Position Variables
// ============================================================================
var string pos = "NONE"
var float entry_px = na
var float tp_px = na
var float sl_px = na
var int entry_bar = na
var bool last_exit_profit = true
var string last_closed_dir = "NONE" 
var float pos_high = na
var float pos_low = na
var int total_trades = 0
var int total_wins = 0

// Offset settings for Smart Labeling
OFFSET_SLOT_1 = 0.5  // Level 1 (Close)
OFFSET_SLOT_2 = 1.3  // Level 2 (Far)

var bool long_was_below_neutral = false
var bool long_was_above_neutral = false
var bool short_was_above_neutral = false
var bool short_was_below_neutral = false
var bool impulse_bull_ready = false
var bool impulse_bear_ready = false
var bool flip_up_ready = false
var bool flip_down_ready = false

// ============================================================================
// üìà Impulse Core Calculation
// ============================================================================
f_impulse() =>
    atr_f = ta.atr(fastLen)
    atr_s = ta.atr(slowLen)
    std_f = ta.stdev(atr_f, devLen)
    (atr_f - atr_s) / (std_f + 1e-6)

impulse = f_impulse()
dev = ta.stdev(impulse, devLen)
fastDEV = ta.sma(dev, fastLen)
slowDEV = ta.sma(dev, slowLen)

bullCross = ta.crossover(fastDEV[1], slowDEV[1]) and barstate.isconfirmed
bearCross = ta.crossunder(fastDEV[1], slowDEV[1]) and barstate.isconfirmed

// ============================================================================
// üìà Trend Baseline & Accuracy
// ============================================================================
pine_supertrend(factor, atrPeriod) =>
    src = hl2
    atr = ta.atr(atrPeriod)
    up = src + factor * atr
    dn = src - factor * atr
    prevDn = nz(dn[1])
    prevUp = nz(up[1])
    newDn = dn > prevDn or close[1] < prevDn ? dn : prevDn
    newUp = up < prevUp or close[1] > prevUp ? up : prevUp
    [newDn, newUp]

[lwr, upr] = pine_supertrend(st_factor, st_atr_period)
baseline = ta.ema(ta.wma(math.avg(lwr, upr), wma_length), baseline_ema_length)

[di_plus, di_minus, adx] = ta.dmi(14, 14)
is_trending = not use_adx_filter or (adx > adx_threshold)

atr_val = ta.atr(atr_len)
bl_delta = baseline - baseline[1]
avg_bl_slope = ta.sma(math.abs(bl_delta), slope_len)

is_flat_atr = use_flat_filter and (math.abs(bl_delta) < (atr_val * flat_atr_mult))

is_strict_long = use_consecutive_filter and last_exit_profit and last_closed_dir == "LONG"
is_strict_short = use_consecutive_filter and last_exit_profit and last_closed_dir == "SHORT"

applied_mult_long = is_strict_long ? slope_mult * consecutive_strict_mult : slope_mult
applied_mult_short = is_strict_short ? slope_mult * consecutive_strict_mult : slope_mult

is_slope_steep_long = math.abs(bl_delta) > (avg_bl_slope * applied_mult_long)
is_slope_steep_short = math.abs(bl_delta) > (avg_bl_slope * applied_mult_short)

chop_atr_sum = math.sum(ta.atr(1), chop_len)
chop_high = ta.highest(chop_len)
chop_low = ta.lowest(chop_len)
choppiness = 100 * math.log10(chop_atr_sum / (chop_high - chop_low)) / math.log10(chop_len)
is_choppy = use_chop_filter and (choppiness > chop_threshold)

var int baseline_trend = 1
var int bullish_duration = 0
var int bearish_duration = 0
var int prev_trend_duration = 0
var int tr_wins = 0
var int tr_total = 0
var float tr_entry_price = na

if barstate.isfirst
    tr_entry_price := close

if ta.crossover(baseline, baseline[1])
    baseline_trend := 1
if ta.crossunder(baseline, baseline[1])
    baseline_trend := -1

if barstate.isconfirmed and baseline_trend != baseline_trend[1]
    if not na(tr_entry_price)
        tr_total := tr_total + 1
        is_win = (baseline_trend[1] == 1 and close > tr_entry_price) or (baseline_trend[1] == -1 and close < tr_entry_price)
        if is_win
            tr_wins := tr_wins + 1
    tr_entry_price := close

tr_accuracy = tr_total > 0 ? (float(tr_wins) / float(tr_total) * 100) : 0.0

if baseline_trend == 1
    if baseline_trend[1] == -1
        prev_trend_duration := bearish_duration
        bullish_duration := 1
    else
        bullish_duration += 1
else if baseline_trend == -1
    if baseline_trend[1] == 1
        prev_trend_duration := bullish_duration
        bearish_duration := 1
    else
        bearish_duration += 1

// ============================================================================
// üß† Auto-Adaptive Timeframe Logic
// ============================================================================
f_get_auto_tf() =>
    min_val = timeframe.in_seconds() / 60
    t_s = "5", t_m = "15", t_l = "60", t_label = "1H"
    if min_val >= 5 // 5m ~ 14m
        t_s := "15", t_m := "60", t_l := "240", t_label := "4H"
    if min_val >= 15 // 15m ~ 59m
        t_s := "60", t_m := "240", t_l := "D", t_label := "1D"
    if min_val >= 60 // 1H ~ 3H
        t_s := "240", t_m := "D", t_l := "W", t_label := "1W"
    if min_val >= 240 // 4H+
        t_s := "D", t_m := "W", t_l := "M", t_label := "1M"
    [t_s, t_m, t_l, t_label]

[tf_small, tf_mid, tf_large, tf_htf_label] = f_get_auto_tf()

// Adaptive HTF Request
htf_baseline_trend = request.security(syminfo.tickerid, tf_mid, baseline_trend)

// ============================================================================
// üìä Oscillator Calculation
// ============================================================================
rsi = ta.rsi(close, 14)
volatility = ta.stdev(close, 20) / ta.sma(close, 20) * 100
vol_factor = 1 + (volatility / 100) * 0.5

rsi_stoch = ta.stoch(rsi, rsi, rsi, 14)
k_line = ta.sma(rsi_stoch, 5)
combined = (rsi + k_line) / 2 * vol_factor
osc_color = color.from_gradient(combined, 0, 100, c_bear, c_bull)

// Ribbon SMAs
sma1 = ta.sma(combined, ribbon_start + ribbon_step * 0)
sma2 = ta.sma(combined, ribbon_start + ribbon_step * 1)
sma3 = ta.sma(combined, ribbon_start + ribbon_step * 2)
sma4 = ta.sma(combined, ribbon_start + ribbon_step * 3)
sma5 = ta.sma(combined, ribbon_start + ribbon_step * 4)
sma6 = ta.sma(combined, ribbon_start + ribbon_step * 5)
sma7 = ta.sma(combined, ribbon_start + ribbon_step * 6)
sma8 = ta.sma(combined, ribbon_start + ribbon_step * 7)
sma9 = ta.sma(combined, ribbon_start + ribbon_step * 8)
sma10 = ta.sma(combined, ribbon_start + ribbon_step * 9)
sma11 = ta.sma(combined, ribbon_start + ribbon_step * 10)
sma12 = ta.sma(combined, ribbon_start + ribbon_step * 11)
sma13 = ta.sma(combined, ribbon_start + ribbon_step * 12)
sma14 = ta.sma(combined, ribbon_start + ribbon_step * 13)
sma15 = ta.sma(combined, ribbon_start + ribbon_step * 14)

// ============================================================================
// üìâ RSI Peak Exit (Real-time Reversal)
// ============================================================================
rsi_src = rsi
piv_h = ta.pivothigh(rsi_src, div_lookback, div_lookback)
piv_l = ta.pivotlow(rsi_src, div_lookback, div_lookback)

bearish_div_alert = use_div_exit and (rsi_src[1] >= 70 and rsi_src < rsi_src[1])
bullish_div_alert = use_div_exit and (rsi_src[1] <= 30 and rsi_src > rsi_src[1])

// ============================================================================
// üìä Confluence Score Function
// ============================================================================
f_calc_score(imp, fdev, sdev, s1, s4, bl_tr) =>
    score = 0.0
    if fdev > sdev
        score += 3
    if s1 > s4
        score += 2
    if bl_tr == 1
        score += 2
    if s1 > 70
        score += 1.5
    else if s1 < 30
        score += 1.5
    score

// Multi-Timeframe Confluence (Using Adaptive TFs)
[imp_5m, dev_5m, fast_5m, slow_5m, s1_5m, s4_5m, bl_5m] = request.security(syminfo.tickerid, tf_small, [impulse, dev, fastDEV, slowDEV, sma1, sma4, baseline_trend])
[imp_15m, dev_15m, fast_15m, slow_15m, s1_15m, s4_15m, bl_15m] = request.security(syminfo.tickerid, tf_mid, [impulse, dev, fastDEV, slowDEV, sma1, sma4, baseline_trend])
[imp_60m, dev_60m, fast_60m, slow_60m, s1_60m, s4_60m, bl_60m] = request.security(syminfo.tickerid, tf_large, [impulse, dev, fastDEV, slowDEV, sma1, sma4, baseline_trend])

score_5m = f_calc_score(imp_5m, fast_5m, slow_5m, s1_5m, s4_5m, bl_5m)
score_15m = f_calc_score(imp_15m, fast_15m, slow_15m, s1_15m, s4_15m, bl_15m)
score_60m = f_calc_score(imp_60m, fast_60m, slow_60m, s1_60m, s4_60m, bl_60m)

confluence_score = (score_5m * 0.3) + (score_15m * 0.4) + (score_60m * 0.3)

var float[] conf_history = array.new_float(0)
array.push(conf_history, confluence_score)
if array.size(conf_history) > conf_ma_period
    array.shift(conf_history)

avg_conf_7d = array.size(conf_history) > 0 ? array.avg(conf_history) : confluence_score
conf_strength = confluence_score / 10 * 100

mean_rev_bb = ta.stdev(close, 20)
mean_rev_sd = (close - ta.sma(close, 20)) / mean_rev_bb

atr_level = atr_val / ta.sma(atr_val, 100)
atr_status = atr_level > 1.5 ? "High" : atr_level > 1.0 ? "Mid" : "Low"

// ============================================================================
// üìä Exit Conditions
// ============================================================================
ob_level = 85, os_level = 15, neutral_level = 50
cross_into_ob = ta.crossover(sma1[1], ob_level) and barstate.isconfirmed
cross_into_os = ta.crossunder(sma1[1], os_level) and barstate.isconfirmed

ribbon_flip_up = ta.crossover(sma1[1], sma4[1]) and barstate.isconfirmed
ribbon_flip_down = ta.crossunder(sma1[1], sma4[1]) and barstate.isconfirmed

is_ob = sma1 >= ob_level
is_os = sma1 <= os_level

// Smart Exit Logic
smart_exit_strong = use_smart_exit and confluence_score[1] >= 8.0 and pos != "NONE"
smart_exit_medium = use_smart_exit and confluence_score[1] >= 5.0 and confluence_score[1] < 8.0 and pos != "NONE"
smart_exit_weak = use_smart_exit and confluence_score[1] < conf_exit_threshold and pos != "NONE"

long_touch_baseline = low <= baseline
short_touch_baseline = high >= baseline
is_hold_period = not na(entry_bar) and (bar_index - entry_bar < min_hold_bars)

smart_long_exit = use_smart_exit and pos == "LONG" and ((bearish_div_alert) or (long_touch_baseline and not is_hold_period and ((smart_exit_strong and confluence_score[1] < avg_conf_7d[1] - 2) or (smart_exit_medium and baseline_trend[1] == -1 and mean_rev_sd[1] > 2) or (smart_exit_weak and sma1[1] < 20))))
smart_short_exit = use_smart_exit and pos == "SHORT" and ((bullish_div_alert) or (short_touch_baseline and not is_hold_period and ((smart_exit_strong and confluence_score[1] < avg_conf_7d[1] - 2) or (smart_exit_medium and baseline_trend[1] == 1 and mean_rev_sd[1] < -2) or (smart_exit_weak and sma1[1] > 80))))

// ============================================================================
// üìÑ Position Logic & Triggers
// ============================================================================
if pos == "LONG"
    if combined < neutral_level
        long_was_below_neutral := true
    if combined > neutral_level
        long_was_above_neutral := true
    pos_high := math.max(nz(pos_high, high), high)

if pos == "SHORT"
    if combined > neutral_level
        short_was_above_neutral := true
    if combined < neutral_level
        short_was_below_neutral := true
    pos_low := math.min(nz(pos_low, low), low)

if bullCross
    impulse_bull_ready := true
if bearCross
    impulse_bear_ready := true
if is_ob
    impulse_bull_ready := false
if is_os
    impulse_bear_ready := false
if ribbon_flip_up
    flip_up_ready := true
if ribbon_flip_down
    flip_down_ready := true

bars_since_entry = not na(entry_bar) ? bar_index - entry_bar : 999
entry_cooldown = bars_since_entry >= 5

prev_high = high[1], prev_low = low[1], prev_open = open[1], prev_close = close[1]
prev_range = prev_high - prev_low
prev_body = math.abs(prev_close - prev_open)
is_small_body = prev_body <= (prev_range * 0.20)
prev_upper_wick = prev_high - math.max(prev_open, prev_close)
prev_lower_wick = math.min(prev_open, prev_close) - prev_low
is_wick_trap_bear = is_small_body and (prev_upper_wick > prev_lower_wick)
is_wick_trap_bull = is_small_body and (prev_lower_wick > prev_upper_wick)

long_htf_pass = not use_htf_filter or (htf_baseline_trend == 1)
short_htf_pass = not use_htf_filter or (htf_baseline_trend == -1)

normal_long = impulse_bull_ready and flip_up_ready and baseline_trend == 1 and not is_flat_atr and is_trending and not is_choppy
normal_short = impulse_bear_ready and flip_down_ready and baseline_trend == -1 and not is_flat_atr and is_trending and not is_choppy

slope_long_trigger = use_slope_entry and (baseline_trend == 1) and (bl_delta > 0 and is_slope_steep_long) and (close > open)
slope_short_trigger = use_slope_entry and (baseline_trend == -1) and (bl_delta < 0 and is_slope_steep_short) and (close < open)

long_trigger_cond = slope_long_trigger and (long_htf_pass or use_slope_htf_bypass) and (not is_ob or use_slope_obos_bypass)
short_trigger_cond = slope_short_trigger and (short_htf_pass or use_slope_htf_bypass) and (not is_os or use_slope_obos_bypass)

long_cond = ((normal_long and long_htf_pass and not is_ob) or long_trigger_cond) and entry_cooldown and pos != "LONG" and not is_wick_trap_bear
short_cond = ((normal_short and short_htf_pass and not is_os) or short_trigger_cond) and entry_cooldown and pos != "SHORT" and not is_wick_trap_bull

long_emergency_tp = pos == "LONG" and cross_into_ob and not na(entry_px)
short_emergency_tp = pos == "SHORT" and cross_into_os and not na(entry_px)

baseline_flip_down = ta.crossunder(baseline[1], baseline[2]) and barstate.isconfirmed and prev_trend_duration >= min_trend_duration
baseline_flip_up = ta.crossover(baseline[1], baseline[2]) and barstate.isconfirmed and prev_trend_duration >= min_trend_duration

long_exit = baseline_flip_down and pos == "LONG" and not na(entry_px)
short_exit = baseline_flip_up and pos == "SHORT" and not na(entry_px)

long_tp_hit = pos == "LONG" and high >= tp_px and not na(tp_px)
short_tp_hit = pos == "SHORT" and low <= tp_px and not na(tp_px)

long_sl_condition = use_soft_sl ? (close[1] <= sl_px) : (low <= sl_px)
short_sl_condition = use_soft_sl ? (close[1] >= sl_px) : (high >= sl_px)

long_sl_hit = pos == "LONG" and long_sl_condition and not na(sl_px)
short_sl_hit = pos == "SHORT" and short_sl_condition and not na(sl_px)

long_profit_pct = pos == "LONG" and not na(entry_px) ? (pos_high - entry_px) / entry_px * 100 : 0
short_profit_pct = pos == "SHORT" and not na(entry_px) ? (entry_px - pos_low) / entry_px * 100 : 0

cur_trail_offset_l = long_profit_pct >= trail_arm_pct2 ? trail_offset_pct2 : trail_offset_pct1
cur_trail_offset_s = short_profit_pct >= trail_arm_pct2 ? trail_offset_pct2 : trail_offset_pct1

ts_long_cond = use_trail_stop and pos == "LONG" and (long_profit_pct >= trail_arm_pct1) and ((pos_high - close) / pos_high * 100 >= cur_trail_offset_l)
ts_short_cond = use_trail_stop and pos == "SHORT" and (short_profit_pct >= trail_arm_pct1) and ((close - pos_low) / pos_low * 100 >= cur_trail_offset_s)

// ============================================================================
// ‚ö†Ô∏è Helper for Label (Smart Layering)
// ============================================================================
f_draw_label(_x, _y, _txt, _col, _style) =>
    if show_label
        label.new(_x, _y, _txt, xloc=xloc.bar_index, yloc=yloc.price, color=color.new(_col, 30), textcolor=color.white, style=_style, size=size.normal, force_overlay=true)

// ============================================================================
// ‚ö†Ô∏è Execution & Update Logic (With 4-Language Support)
// ============================================================================
has_entry_signal = long_cond or short_cond

// TP Execution (Restored 'Bubble' Style: lower_left/upper_left)
if long_tp_hit and pos == "LONG"
    is_profit = true, last_exit_profit := true, last_closed_dir := "LONG"
    total_trades += 1, total_wins += 1
    offset_mult = has_entry_signal ? OFFSET_SLOT_2 : OFFSET_SLOT_1
    // [LANG] EN/KR/CN/ES
    f_draw_label(bar_index, high + atr_val * offset_mult, t("Long TP", "Î°± ÏùµÏ†à", "Â§öÂçïÊ≠¢Áõà", "TP Largo"), c_tp_long, label.style_label_lower_left)
    pos := "NONE", entry_px := na, tp_px := na, sl_px := na, entry_bar := na, pos_high := na

if short_tp_hit and pos == "SHORT"
    is_profit = true, last_exit_profit := true, last_closed_dir := "SHORT"
    total_trades += 1, total_wins += 1
    offset_mult = has_entry_signal ? OFFSET_SLOT_2 : OFFSET_SLOT_1
    // [LANG] EN/KR/CN/ES
    f_draw_label(bar_index, low - atr_val * offset_mult, t("Short TP", "Ïàè ÏùµÏ†à", "Á©∫ÂçïÊ≠¢Áõà", "TP Corto"), c_tp_short, label.style_label_upper_left)
    pos := "NONE", entry_px := na, tp_px := na, sl_px := na, entry_bar := na, pos_low := na

// TS Execution (Restored 'Bubble' Style)
if ts_long_cond and pos == "LONG"
    is_profit = true, last_exit_profit := true, last_closed_dir := "LONG"
    total_trades += 1, total_wins += 1
    offset_mult = has_entry_signal ? OFFSET_SLOT_2 : OFFSET_SLOT_1
    // [LANG] EN/KR/CN/ES
    f_draw_label(bar_index, high + atr_val * offset_mult, t("TS Win", "TS ÏùµÏ†à", "TSÊ≠¢Áõà", "TS Ganancia"), c_tp_long, label.style_label_lower_left)
    pos := "NONE", entry_px := na, tp_px := na, sl_px := na, entry_bar := na, pos_high := na

if ts_short_cond and pos == "SHORT"
    is_profit = true, last_exit_profit := true, last_closed_dir := "SHORT"
    total_trades += 1, total_wins += 1
    offset_mult = has_entry_signal ? OFFSET_SLOT_2 : OFFSET_SLOT_1
    // [LANG] EN/KR/CN/ES
    f_draw_label(bar_index, low - atr_val * offset_mult, t("TS Win", "TS ÏùµÏ†à", "TSÊ≠¢Áõà", "TS Ganancia"), c_tp_short, label.style_label_upper_left)
    pos := "NONE", entry_px := na, tp_px := na, sl_px := na, entry_bar := na, pos_low := na

// SL Execution (Restored 'Bubble' Style)
if long_sl_hit and pos == "LONG"
    is_profit = false, last_exit_profit := false, last_closed_dir := "LONG"
    total_trades += 1
    target_bar = use_soft_sl ? bar_index - 1 : bar_index
    target_has_entry = use_soft_sl ? (long_cond[1] or short_cond[1]) : has_entry_signal
    offset_mult = target_has_entry ? OFFSET_SLOT_2 : OFFSET_SLOT_1
    ref_y = use_soft_sl ? low[1] : low
    ref_atr = use_soft_sl ? atr_val[1] : atr_val
    // [LANG] EN/KR/CN/ES
    f_draw_label(target_bar, ref_y - ref_atr * offset_mult, t("Long SL", "Î°± ÏÜêÏ†à", "Â§öÂçïÊ≠¢Êçü", "SL Largo"), c_sl_long, label.style_label_upper_left)
    pos := "NONE", entry_px := na, tp_px := na, sl_px := na, entry_bar := na, pos_high := na

if short_sl_hit and pos == "SHORT"
    is_profit = false, last_exit_profit := false, last_closed_dir := "SHORT"
    total_trades += 1
    target_bar = use_soft_sl ? bar_index - 1 : bar_index
    target_has_entry = use_soft_sl ? (long_cond[1] or short_cond[1]) : has_entry_signal
    offset_mult = target_has_entry ? OFFSET_SLOT_2 : OFFSET_SLOT_1
    ref_y = use_soft_sl ? high[1] : high
    ref_atr = use_soft_sl ? atr_val[1] : atr_val
    // [LANG] EN/KR/CN/ES
    f_draw_label(target_bar, ref_y + ref_atr * offset_mult, t("Short SL", "Ïàè ÏÜêÏ†à", "Á©∫ÂçïÊ≠¢Êçü", "SL Corto"), c_sl_short, label.style_label_lower_left)
    pos := "NONE", entry_px := na, tp_px := na, sl_px := na, entry_bar := na, pos_low := na

// Smart/Emergency Exits (Kept as down/up to distinguish)
if long_emergency_tp and pos == "LONG"
    is_profit = close[1] > entry_px, last_exit_profit := is_profit, last_closed_dir := "LONG"
    total_trades += 1
    if is_profit 
        total_wins += 1
    target_has_entry = long_cond[1] or short_cond[1]
    offset_mult = target_has_entry ? OFFSET_SLOT_2 : OFFSET_SLOT_1
    
    float y_pos = is_profit ? high[1] + atr_val[1] * offset_mult : low[1] - atr_val[1] * offset_mult
    string lbl_style = is_profit ? label.style_label_down : label.style_label_up
    
    // [LANG] EN/KR/CN/ES
    string txt_win = t("Long TP", "Î°± ÏùµÏ†à", "Â§öÂçïÊ≠¢Áõà", "TP Largo")
    string txt_loss = t("Long SL", "Î°± ÏÜêÏ†à", "Â§öÂçïÊ≠¢Êçü", "SL Largo")
    
    f_draw_label(bar_index - 1, y_pos, is_profit ? txt_win : txt_loss, is_profit ? c_tp_long : c_sl_long, lbl_style)
    pos := "NONE", entry_px := na, tp_px := na, sl_px := na, entry_bar := na, pos_high := na

if short_emergency_tp and pos == "SHORT"
    is_profit = close[1] < entry_px, last_exit_profit := is_profit, last_closed_dir := "SHORT"
    total_trades += 1
    if is_profit 
        total_wins += 1
    target_has_entry = long_cond[1] or short_cond[1]
    offset_mult = target_has_entry ? OFFSET_SLOT_2 : OFFSET_SLOT_1
    
    float y_pos = is_profit ? low[1] - atr_val[1] * offset_mult : high[1] + atr_val[1] * offset_mult
    string lbl_style = is_profit ? label.style_label_up : label.style_label_down

    // [LANG] EN/KR/CN/ES
    string txt_win = t("Short TP", "Ïàè ÏùµÏ†à", "Á©∫ÂçïÊ≠¢Áõà", "TP Corto")
    string txt_loss = t("Short SL", "Ïàè ÏÜêÏ†à", "Á©∫ÂçïÊ≠¢Êçü", "SL Corto")

    f_draw_label(bar_index - 1, y_pos, is_profit ? txt_win : txt_loss, is_profit ? c_tp_short : c_sl_short, lbl_style)
    pos := "NONE", entry_px := na, tp_px := na, sl_px := na, entry_bar := na, pos_low := na

if smart_long_exit and pos == "LONG" and not na(entry_px)
    is_profit = close > entry_px, last_exit_profit := is_profit, last_closed_dir := "LONG"
    total_trades += 1
    if is_profit
        total_wins += 1
    target_has_entry = long_cond[1] or short_cond[1]
    offset_mult = target_has_entry ? OFFSET_SLOT_2 : OFFSET_SLOT_1
    
    float y_pos = is_profit ? high[1] + atr_val[1] * offset_mult : low[1] - atr_val[1] * offset_mult
    string lbl_style = is_profit ? label.style_label_down : label.style_label_up

    // [LANG] EN/KR/CN/ES - Peak/Smart Exit
    string txt_peak = t("Peak Exit", "Í≥†Ï†ê ÌÉàÏ∂ú", "ÈÄÉÈ°∂", "Salida Pico") 
    string txt_smart = t("Smart Exit", "Ïä§ÎßàÌä∏ ÌÉàÏ∂ú", "Êô∫ËÉΩÁ¶ªÂú∫", "Salida Smart")

    f_draw_label(bar_index - 1, y_pos, bearish_div_alert ? txt_peak : txt_smart, is_profit ? c_tp_long : c_sl_long, lbl_style)
    pos := "NONE", entry_px := na, tp_px := na, sl_px := na, entry_bar := na, pos_high := na

if smart_short_exit and pos == "SHORT" and not na(entry_px)
    is_profit = close < entry_px, last_exit_profit := is_profit, last_closed_dir := "SHORT"
    total_trades += 1
    if is_profit
        total_wins += 1
    target_has_entry = long_cond[1] or short_cond[1]
    offset_mult = target_has_entry ? OFFSET_SLOT_2 : OFFSET_SLOT_1
    
    float y_pos = is_profit ? low[1] - atr_val[1] * offset_mult : high[1] + atr_val[1] * offset_mult
    string lbl_style = is_profit ? label.style_label_up : label.style_label_down

    // [LANG] EN/KR/CN/ES - Peak/Smart Exit (Short Side)
    string txt_peak = t("Peak Exit", "Ï†ÄÏ†ê ÌÉàÏ∂ú", "ÊäÑÂ∫ï", "Salida Pico") 
    string txt_smart = t("Smart Exit", "Ïä§ÎßàÌä∏ ÌÉàÏ∂ú", "Êô∫ËÉΩÁ¶ªÂú∫", "Salida Smart")

    f_draw_label(bar_index - 1, y_pos, bullish_div_alert ? txt_peak : txt_smart, is_profit ? c_tp_short : c_sl_short, lbl_style)
    pos := "NONE", entry_px := na, tp_px := na, sl_px := na, entry_bar := na, pos_low := na

if short_exit and not long_cond and pos == "SHORT"
    is_profit = close[1] < entry_px, last_exit_profit := is_profit, last_closed_dir := "SHORT"
    total_trades += 1
    if is_profit
        total_wins += 1
    target_has_entry = long_cond[1] or short_cond[1]
    offset_mult = target_has_entry ? OFFSET_SLOT_2 : OFFSET_SLOT_1
    
    float y_pos = is_profit ? low[1] - atr_val[1] * offset_mult : high[1] + atr_val[1] * offset_mult
    string lbl_style = is_profit ? label.style_label_up : label.style_label_down

    string txt_win = t("Short TP", "Ïàè ÏùµÏ†à", "Á©∫ÂçïÊ≠¢Áõà", "TP Corto")
    string txt_loss = t("Short SL", "Ïàè ÏÜêÏ†à", "Á©∫ÂçïÊ≠¢Êçü", "SL Corto")

    f_draw_label(bar_index - 1, y_pos, is_profit ? txt_win : txt_loss, is_profit ? c_tp_short : c_sl_short, lbl_style)
    pos_low := na, pos := "NONE", entry_px := na

if long_exit and not short_cond and pos == "LONG"
    is_profit = close[1] > entry_px, last_exit_profit := is_profit, last_closed_dir := "LONG"
    total_trades += 1
    if is_profit
        total_wins += 1
    target_has_entry = long_cond[1] or short_cond[1]
    offset_mult = target_has_entry ? OFFSET_SLOT_2 : OFFSET_SLOT_1
    
    float y_pos = is_profit ? high[1] + atr_val[1] * offset_mult : low[1] - atr_val[1] * offset_mult
    string lbl_style = is_profit ? label.style_label_down : label.style_label_up

    string txt_win = t("Long TP", "Î°± ÏùµÏ†à", "Â§öÂçïÊ≠¢Áõà", "TP Largo")
    string txt_loss = t("Long SL", "Î°± ÏÜêÏ†à", "Â§öÂçïÊ≠¢Êçü", "SL Largo")

    f_draw_label(bar_index - 1, y_pos, is_profit ? txt_win : txt_loss, is_profit ? c_tp_long : c_sl_long, lbl_style)
    pos_high := na, pos := "NONE", entry_px := na

// Entry Updates
if long_cond
    pos := "LONG", entry_px := open, entry_bar := bar_index
    sl_px := open - atr_val * sl_fib * sl_mult
    tp_px := open + atr_val * tp_fib * tp_mult
    pos_high := high 
    long_was_below_neutral := combined < neutral_level
    long_was_above_neutral := combined > neutral_level
    impulse_bull_ready := false, impulse_bear_ready := false, flip_up_ready := false, flip_down_ready := false
    // [LANG] EN/KR/CN/ES
    f_draw_label(bar_index, low - atr_val * OFFSET_SLOT_1, t("Long", "Î°± ÏßÑÏûÖ", "Â§öÂçï", "Largo"), c_long_lbl, label.style_label_up)

if short_cond
    pos := "SHORT", entry_px := open, entry_bar := bar_index
    sl_px := open + atr_val * sl_fib * sl_mult
    tp_px := open - atr_val * tp_fib * tp_mult
    pos_low := low
    short_was_above_neutral := combined > neutral_level
    short_was_below_neutral := combined < neutral_level
    impulse_bull_ready := false, impulse_bear_ready := false, flip_up_ready := false, flip_down_ready := false
    // [LANG] EN/KR/CN/ES
    f_draw_label(bar_index, high + atr_val * OFFSET_SLOT_1, t("Short", "Ïàè ÏßÑÏûÖ", "Á©∫Âçï", "Corto"), c_short_lbl, label.style_label_down)


// ============================================================================
// üìä Main Chart TP/SL Lines & Box (Visuals)
// ============================================================================
pos_changed = long_cond or short_cond
c_tp_cur = pos == "LONG" ? c_tp_long : c_tp_short
c_sl_cur = pos == "LONG" ? c_sl_long : c_sl_short

// [LANG] Dynamic TP/SL Text
tp_txt = pos == "LONG" ? t("Long TP ", "Î°± ÏùµÏ†à ", "Â§öÂçïÊ≠¢Áõà ", "TP Largo ") : t("Short TP ", "Ïàè ÏùµÏ†à ", "Á©∫ÂçïÊ≠¢Áõà ", "TP Corto ")
sl_txt = pos == "LONG" ? t("Long SL ", "Î°± ÏÜêÏ†à ", "Â§öÂçïÊ≠¢Êçü ", "SL Largo ") : t("Short SL ", "Ïàè ÏÜêÏ†à ", "Á©∫ÂçïÊ≠¢Êçü ", "SL Corto ")

var line tp_ln = na, var line sl_ln = na
var label tp_lbl = na, var label sl_lbl = na

if show_entry and pos != "NONE" and not na(tp_px) and not na(sl_px) and not na(entry_bar)
    if pos_changed
        line.delete(tp_ln), line.delete(sl_ln)
        label.delete(tp_lbl), label.delete(sl_lbl)
        
        tp_ln := line.new(entry_bar, tp_px, bar_index, tp_px, color=color.new(c_tp_cur, 30), force_overlay=true)
        sl_ln := line.new(entry_bar, sl_px, bar_index, sl_px, color=color.new(c_sl_cur, 30), force_overlay=true)
        tp_lbl := label.new(bar_index, tp_px, tp_txt + str.tostring(tp_px, format.mintick), color=color.new(c_tp_cur, 70), textcolor=color.white, style=label.style_label_left, force_overlay=true)
        sl_lbl := label.new(bar_index, sl_px, sl_txt + str.tostring(sl_px, format.mintick), color=color.new(c_sl_cur, 70), textcolor=color.white, style=label.style_label_left, force_overlay=true)
    else if not na(tp_ln) and not na(sl_ln)
        line.set_xy2(tp_ln, bar_index, tp_px)
        line.set_xy2(sl_ln, bar_index, sl_px)
        label.set_xy(tp_lbl, bar_index, tp_px)
        label.set_xy(sl_lbl, bar_index, sl_px)
else
    line.delete(tp_ln), line.delete(sl_ln)
    label.delete(tp_lbl), label.delete(sl_lbl)

// TP/SL Box Fills
tp_top_l = pos == "LONG" ? tp_px : na
tp_bot_l = pos == "LONG" ? entry_px : na
sl_top_l = pos == "LONG" ? entry_px : na
sl_bot_l = pos == "LONG" ? sl_px : na

p1 = plot(show_tpsl_box ? tp_top_l : na, display=display.none, force_overlay=true)
p2 = plot(show_tpsl_box ? tp_bot_l : na, display=display.none, force_overlay=true)
fill(p1, p2, color=color.new(c_tp_long, 85), title="TP Fill Long")

p3 = plot(show_tpsl_box ? sl_top_l : na, display=display.none, force_overlay=true)
p4 = plot(show_tpsl_box ? sl_bot_l : na, display=display.none, force_overlay=true)
fill(p3, p4, color=color.new(c_sl_long, 85), title="SL Fill Long")

tp_top_s = pos == "SHORT" ? entry_px : na
tp_bot_s = pos == "SHORT" ? tp_px : na
sl_top_s = pos == "SHORT" ? sl_px : na
sl_bot_s = pos == "SHORT" ? entry_px : na

p5 = plot(show_tpsl_box ? tp_top_s : na, display=display.none, force_overlay=true)
p6 = plot(show_tpsl_box ? tp_bot_s : na, display=display.none, force_overlay=true)
fill(p5, p6, color=color.new(c_tp_short, 85), title="TP Fill Short")

p7 = plot(show_tpsl_box ? sl_top_s : na, display=display.none, force_overlay=true)
p8 = plot(show_tpsl_box ? sl_bot_s : na, display=display.none, force_overlay=true)
fill(p7, p8, color=color.new(c_sl_short, 85), title="SL Fill Short")


// ============================================================================
// üìä Bottom Panel Ribbon (Visuals Restored - 15 Lines)
// ============================================================================
r1 = show_ribbon and ribbon_cnt >= 1 ? sma1 : na
r1_rising = sma1 > sma1[1]
r1_color = r1_rising ? color.new(c_bull, 10) : color.new(c_bear, 10)

r2 = show_ribbon and ribbon_cnt >= 2 ? sma2 : na
r3 = show_ribbon and ribbon_cnt >= 3 ? sma3 : na
r4 = show_ribbon and ribbon_cnt >= 4 ? sma4 : na
r5 = show_ribbon and ribbon_cnt >= 5 ? sma5 : na
r6 = show_ribbon and ribbon_cnt >= 6 ? sma6 : na
r7 = show_ribbon and ribbon_cnt >= 7 ? sma7 : na
r8 = show_ribbon and ribbon_cnt >= 8 ? sma8 : na
r9 = show_ribbon and ribbon_cnt >= 9 ? sma9 : na
r10 = show_ribbon and ribbon_cnt >= 10 ? sma10 : na
r11 = show_ribbon and ribbon_cnt >= 11 ? sma11 : na
r12 = show_ribbon and ribbon_cnt >= 12 ? sma12 : na
r13 = show_ribbon and ribbon_cnt >= 13 ? sma13 : na
r14 = show_ribbon and ribbon_cnt >= 14 ? sma14 : na
r15 = show_ribbon and ribbon_cnt >= 15 ? sma15 : na

plot(r15, "Ribbon 15", color=color.new(osc_color, 88), linewidth=1)
plot(r14, "Ribbon 14", color=color.new(osc_color, 86), linewidth=1)
plot(r13, "Ribbon 13", color=color.new(osc_color, 84), linewidth=1)
plot(r12, "Ribbon 12", color=color.new(osc_color, 82), linewidth=1)
plot(r11, "Ribbon 11", color=color.new(osc_color, 80), linewidth=1)
plot(r10, "Ribbon 10", color=color.new(osc_color, 78), linewidth=1)
plot(r9, "Ribbon 9", color=color.new(osc_color, 76), linewidth=1)
plot(r8, "Ribbon 8", color=color.new(osc_color, 74), linewidth=2)
plot(r7, "Ribbon 7", color=color.new(osc_color, 72), linewidth=2)
plot(r6, "Ribbon 6", color=color.new(osc_color, 70), linewidth=2)
plot(r5, "Ribbon 5", color=color.new(osc_color, 68), linewidth=2)
plot(r4, "Ribbon 4", color=color.new(osc_color, 66), linewidth=2)
plot(r3, "Ribbon 3", color=color.new(osc_color, 64), linewidth=2)
plot(r2, "Ribbon 2", color=color.new(osc_color, 62), linewidth=2)
plot(r1, "Ribbon 1", color=r1_color, linewidth=3)

hline(85, "Overbought", color=color.new(c_bear, 20), linestyle=hline.style_dotted)
hline(15, "Oversold", color=color.new(c_bull, 20), linestyle=hline.style_dotted)
hline(50, "Neutral", color=color.new(color.gray, 20), linestyle=hline.style_dotted)

// ============================================================================
// üåÄ SAR + MACD Glow (Visuals)
// ============================================================================
sar = ta.sar(sar_start, sar_inc, sar_max)
sar_dist_abs = math.abs(close - sar)
sar_dist_atr_ratio = sar_dist_abs / atr_val
sar_strength = math.min((sar_dist_atr_ratio / sar_atr_scale) * 100, 100)
sar_strong = sar_strength >= 75
sar_momentum = ta.roc(sar, 5)
sar_mom_change = sar_momentum - sar_momentum[1]
sar_inf_up = sar_momentum > 0 and sar_momentum[1] < 0 and math.abs(sar_mom_change) > sar_inf_sens
sar_inf_dn = sar_momentum < 0 and sar_momentum[1] > 0 and math.abs(sar_mom_change) > sar_inf_sens

macd_line = ta.ema(close, macd_fast) - ta.ema(close, macd_slow)
macd_signal = ta.ema(macd_line, macd_sig)
macd_hist = macd_line - macd_signal
macd_strong_bull = macd_hist > 0 and macd_hist > macd_hist[1] and macd_hist > macd_hist[2]
macd_strong_bear = macd_hist < 0 and macd_hist < macd_hist[1] and macd_hist < macd_hist[2]
macd_cross_up = ta.crossover(macd_hist, 0)
macd_cross_dn = ta.crossunder(macd_hist, 0)

combo_bull = sar_inf_up and sar_strong and (macd_strong_bull or macd_cross_up)
combo_bear = sar_inf_dn and sar_strong and (macd_strong_bear or macd_cross_dn)

atr_offset = atr_val * 0.5
glow_pos_up = combo_bull ? low - atr_offset : na
glow_pos_dn = combo_bear ? high + atr_offset : na

plotshape(show_sar_glow and combo_bull ? glow_pos_up : na, "SAR+MACD Up Core", location=location.absolute, color=color.new(c_bull, 0), style=shape.triangleup, size=size.tiny, force_overlay=true)
plotshape(show_sar_glow and combo_bull ? glow_pos_up : na, "SAR+MACD Up Glow", location=location.absolute, color=color.new(c_bull, 65), style=shape.circle, size=size.small, force_overlay=true)
plotshape(show_sar_glow and combo_bear ? glow_pos_dn : na, "SAR+MACD Down Core", location=location.absolute, color=color.new(c_bear, 0), style=shape.triangledown, size=size.tiny, force_overlay=true)
plotshape(show_sar_glow and combo_bear ? glow_pos_dn : na, "SAR+MACD Down Glow", location=location.absolute, color=color.new(c_bear, 65), style=shape.circle, size=size.small, force_overlay=true)

// ============================================================================
// üìà Baseline (Clean Line)
// ============================================================================
baseline_color = baseline_trend == 1 ? color.new(c_bull, 50) : color.new(c_bear, 50)
plot(show_baseline ? baseline : na, "Baseline", color=baseline_color, linewidth=2, force_overlay=true)

// ============================================================================
// üîä Support/Resistance Table (Dynamic Language)
// ============================================================================
var float support = na
var float resist = na

pvt_h = ta.pivothigh(high, 10, 10)
pvt_l = ta.pivotlow(low, 10, 10)
if not na(pvt_h)
    resist := pvt_h
if not na(pvt_l)
    support := pvt_l

var table sr_tbl = table.new(position.bottom_right, 2, 4, bgcolor=color.new(c_bg, 100), border_width=0, force_overlay=true)

if show_sr
    r_txt = na(resist) ? "---" : str.tostring(resist, format.mintick)
    s_txt = na(support) ? "---" : str.tostring(support, format.mintick)
    
    // [LANG] Resistance / Ï†ÄÌï≠ / ÈòªÂäõ / Resistencia
    table.cell(sr_tbl, 0, 0, t("Resistance", "Ï†ÄÌï≠", "ÈòªÂäõ", "Resistencia"), text_color=color.new(c_bear, 20), text_halign=text.align_right, text_size=size.normal)
    table.cell(sr_tbl, 1, 0, r_txt, text_color=c_bear, text_halign=text.align_left, text_size=size.normal)
    // [LANG] Support / ÏßÄÏßÄ / ÊîØÊíë / Soporte
    table.cell(sr_tbl, 0, 1, t("Support", "ÏßÄÏßÄ", "ÊîØÊíë", "Soporte"), text_color=color.new(c_bull, 20), text_halign=text.align_right, text_size=size.normal)
    table.cell(sr_tbl, 1, 1, s_txt, text_color=c_bull, text_halign=text.align_left, text_size=size.normal)

// ============================================================================
// üìä Main Dashboard (Dynamic Language)
// ============================================================================
price_12h_ago = request.security(syminfo.tickerid, "60", close[12])
is_12h_bull = close > price_12h_ago
trend_12h_change = (close - price_12h_ago) / price_12h_ago * 100

change_txt = (trend_12h_change >= 0 ? "+" : "") + str.tostring(trend_12h_change, "#.##") + "%"
// [LANG] Bullish/Bearish
trend_12h_txt = is_12h_bull ? t("Bullish", "ÏÉÅÏäπÏÑ∏", "ÁúãÊ∂®", "Alcista") : t("Bearish", "ÌïòÎùΩÏÑ∏", "ÁúãË∑å", "Bajista")
trend_12h_col = is_12h_bull ? c_bull : c_bear

// [LANG] Bullish/Bearish (HTF Context)
htf_status_txt = use_htf_filter ? (htf_baseline_trend == 1 ? t("Bullish", "ÏÉÅÏäπÏû•", "ÁúãÊ∂®", "Alcista") : t("Bearish", "ÌïòÎùΩÏû•", "ÁúãË∑å", "Bajista")) : t("Filter OFF", "ÌïÑÌÑ∞ Í∫ºÏßê", "ËøáÊª§Âô®ÂÖ≥Èó≠", "Filtro OFF")
htf_status_col = use_htf_filter ? (htf_baseline_trend == 1 ? c_bull : c_bear) : color.gray

// [LANG] Confluence Score
conf_signal = confluence_score > 7 ? t("Strong Buy", "Í∞ïÌïú Îß§Ïàò", "Âº∫Âäõ‰π∞ÂÖ•", "Compra Fuerte") : confluence_score > 5 ? t("Buy", "Îß§Ïàò", "‰π∞ÂÖ•", "Compra") : confluence_score > 3 ? t("Neutral", "Ï§ëÎ¶Ω", "‰∏≠Á´ã", "Neutral") : t("Sell", "Îß§ÎèÑ", "ÂçñÂá∫", "Venta")
conf_col = confluence_score > 5 ? c_bull : confluence_score < 3 ? c_bear : color.gray

// [LANG] SAR Status
sar_stat_txt = close > sar ? t("Up Trend", "ÏÉÅÏäπ Ï∂îÏÑ∏", "‰∏äÂçáË∂ãÂäø", "Tendencia Alcista") : t("Down Trend", "ÌïòÎùΩ Ï∂îÏÑ∏", "‰∏ãÈôçË∂ãÂäø", "Tendencia Bajista")
sar_stat_col = close > sar ? c_bull : c_bear
sar_disp_score = math.min(sar_strength, 100)

win_rate = total_trades > 0 ? (float(total_wins) / float(total_trades) * 100) : 0
win_rate_txt = str.tostring(win_rate, "#.0") + "%"
win_rate_col = win_rate >= 50 ? c_bull : c_bear 

// [LANG] Position Status
pos_txt = pos == "LONG" ? t("Long", "Î°±", "Â§öÂçï", "Largo") : pos == "SHORT" ? t("Short", "Ïàè", "Á©∫Âçï", "Corto") : t("Wait", "ÎåÄÍ∏∞", "ËßÇÊúõ", "Espera")
pos_col = pos == "LONG" ? c_bull : pos == "SHORT" ? c_bear : color.gray
pnl = pos != "NONE" and not na(entry_px) ? ((close - entry_px) / entry_px * 100 * (pos == "SHORT" ? -1 : 1)) : 0
pnl_txt = pos != "NONE" ? (pnl >= 0 ? "+" : "") + str.tostring(pnl, "#.##") + "%" : "---"
pnl_col = pnl >= 0 ? color.new(c_bull, 20) : color.new(c_bear, 20)

// [LANG] Mean Reversion
mr_status = mean_rev_sd > 2 ? t("Overbought", "Í≥ºÎß§Ïàò", "Ë∂Ö‰π∞", "Sobrecompra") : mean_rev_sd < -2 ? t("Oversold", "Í≥ºÎß§ÎèÑ", "Ë∂ÖÂçñ", "Sobreventa") : t("Normal", "Ï†ïÏÉÅ", "Ê≠£Â∏∏", "Normal")
mr_col = mean_rev_sd > 2 ? c_bear : mean_rev_sd < -2 ? c_bull : color.gray

// [LANG] Volatility Levels
txt_vol_high = t("High", "ÎÜíÏùå", "È´ò", "Alto")
txt_vol_mid = t("Mid", "Ï§ëÍ∞Ñ", "‰∏≠", "Medio")
txt_vol_low = t("Low", "ÎÇÆÏùå", "‰Ωé", "Bajo")
txt_vol_lvl = atr_level > 1.5 ? txt_vol_high : atr_level > 1.0 ? txt_vol_mid : txt_vol_low

c_header_bg = color.new(#1e222d, 70)
c_cell_bg = color.new(#131722, 80)
c_text_muted = color.new(#ffffff, 31)
c_text_bright = color.new(#ffffff, 0)

var table chart_dash_tbl = na
if barstate.isfirst and show_dashboard
    chart_dash_tbl := table.new(position.top_right, 3, 9, bgcolor=c_cell_bg, border_width=0, frame_width=1, frame_color=color.new(#363a45, 50), force_overlay=true)

if show_dashboard and not na(chart_dash_tbl)
    table.cell(chart_dash_tbl, 0, 0, "IMPULSE REACTOR", text_color=c_text_bright, bgcolor=c_header_bg, text_size=size.normal, text_halign=text.align_center)
    table.merge_cells(chart_dash_tbl, 0, 0, 2, 0)

    // [LANG] 12H Trend
    table.cell(chart_dash_tbl, 0, 1, t("12H Trend", "12ÏãúÍ∞Ñ Ï∂îÏÑ∏", "12HË∂ãÂäø", "12H Tendencia"), text_color=c_text_muted, text_halign=text.align_left, text_size=size.normal)
    table.cell(chart_dash_tbl, 1, 1, trend_12h_txt, text_color=trend_12h_col, text_halign=text.align_right, text_size=size.normal)
    table.cell(chart_dash_tbl, 2, 1, change_txt, text_color=c_text_muted, text_halign=text.align_right, text_size=size.normal)

    // [LANG] HTF Trend
    table.cell(chart_dash_tbl, 0, 2, tf_htf_label + t(" Trend", " Ï∂îÏÑ∏", "Ë∂ãÂäø", " Tendencia"), text_color=c_text_muted, text_halign=text.align_left, text_size=size.normal)
    table.cell(chart_dash_tbl, 1, 2, htf_status_txt, text_color=htf_status_col, text_halign=text.align_right, text_size=size.normal)
    table.cell(chart_dash_tbl, 2, 2, t("Adaptive", "ÏûêÎèô Ï†ÅÏùëÌòï", "Ëá™ÈÄÇÂ∫î", "Adaptativo"), text_color=c_text_muted, text_halign=text.align_right, text_size=size.normal)

    // [LANG] Confluence
    table.cell(chart_dash_tbl, 0, 3, t("Confluence", "Ïª®ÌîåÎ£®Ïñ∏Ïä§", "ÂÖ±ÊåØ", "Confluencia"), text_color=c_text_muted, text_halign=text.align_left, text_size=size.normal)
    table.cell(chart_dash_tbl, 1, 3, conf_signal, text_color=conf_col, text_halign=text.align_right, text_size=size.normal)
    table.cell(chart_dash_tbl, 2, 3, str.tostring(conf_strength, "##.#") + "%", text_color=c_text_muted, text_halign=text.align_right, text_size=size.normal)

    // [LANG] SAR Status
    table.cell(chart_dash_tbl, 0, 4, t("SAR Status", "SAR ÏÉÅÌÉú", "SARÁä∂ÊÄÅ", "Estado SAR"), text_color=c_text_muted, text_halign=text.align_left, text_size=size.normal)
    table.cell(chart_dash_tbl, 1, 4, sar_stat_txt, text_color=sar_stat_col, text_halign=text.align_right, text_size=size.normal)
    table.cell(chart_dash_tbl, 2, 4, str.tostring(sar_disp_score, "#.0") + t(" pts", "Ï†ê", "ÂàÜ", " pts"), text_color=c_text_muted, text_halign=text.align_right, text_size=size.normal)

    // [LANG] Mean Reversion
    table.cell(chart_dash_tbl, 0, 5, t("Mean Rev", "ÌèâÍ∑†ÌöåÍ∑Ä", "ÂùáÂÄºÂõûÂΩí", "Regresi√≥n Media"), text_color=c_text_muted, text_halign=text.align_left, text_size=size.normal)
    table.cell(chart_dash_tbl, 1, 5, mr_status, text_color=mr_col, text_halign=text.align_right, text_size=size.normal)
    table.cell(chart_dash_tbl, 2, 5, str.tostring(mean_rev_sd, "#.#") + " SD", text_color=c_text_muted, text_halign=text.align_right, text_size=size.normal)

    // [LANG] Volatility
    table.cell(chart_dash_tbl, 0, 6, t("Volatility", "Î≥ÄÎèôÏÑ± Î†àÎ≤®", "Ê≥¢Âä®Áéá", "Volatilidad"), text_color=c_text_muted, text_halign=text.align_left, text_size=size.normal)
    table.cell(chart_dash_tbl, 1, 6, txt_vol_lvl, text_color=c_text_muted, text_halign=text.align_right, text_size=size.normal)
    table.cell(chart_dash_tbl, 2, 6, t("Lvl ", "Î†àÎ≤® ", "Á≠âÁ∫ß ", "Nvl ") + str.tostring(atr_level, "#.#"), text_color=c_text_muted, text_halign=text.align_right, text_size=size.normal)

    // [LANG] Position
    table.cell(chart_dash_tbl, 0, 7, t("Position", "Ìè¨ÏßÄÏÖò", "ÊåÅ‰ªì", "Posici√≥n"), text_color=c_text_muted, text_halign=text.align_left, text_size=size.normal)
    table.cell(chart_dash_tbl, 1, 7, pos_txt, text_color=pos_col, text_halign=text.align_right, text_size=size.normal)
    table.cell(chart_dash_tbl, 2, 7, pnl_txt, text_color=pnl_col, text_halign=text.align_right, text_size=size.normal)

    // [LANG] Win Rate
    table.cell(chart_dash_tbl, 0, 8, t("Win Rate", "Ï†ÑÏ≤¥ ÏäπÎ•†", "ËÉúÁéá", "Tasa de Ganancia"), text_color=c_text_muted, text_halign=text.align_left, text_size=size.normal)
    table.cell(chart_dash_tbl, 1, 8, win_rate_txt, text_color=win_rate_col, text_halign=text.align_right, text_size=size.normal)
    table.cell(chart_dash_tbl, 2, 8, "(" + str.tostring(total_wins) + "/" + str.tostring(total_trades) + ")", text_color=c_text_muted, text_halign=text.align_right, text_size=size.normal)
 
bgcolor(c_bg)

// ============================================================================
// üîî Alerts
// ============================================================================
alertcondition(long_cond, "Long Entry", "LONG Entry")
alertcondition(short_cond, "Short Entry", "SHORT Entry")
alertcondition(long_tp_hit, "Long TP", "Long Take Profit")
alertcondition(short_tp_hit, "Short TP", "Short Take Profit")
alertcondition(combo_bull, "SAR+MACD Bullish", "SAR+MACD Bullish Momentum")
alertcondition(combo_bear, "SAR+MACD Bearish", "SAR+MACD Bearish Momentum")
alertcondition(cross_into_ob, "Overbought", "Overbought Warning!")
alertcondition(cross_into_os, "Oversold", "Oversold Warning!") 
alertcondition(smart_long_exit or smart_short_exit, "Smart Exit", "Smart Exit")
