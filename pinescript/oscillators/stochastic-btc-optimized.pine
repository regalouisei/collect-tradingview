//@version=6
indicator(title="Stochastic BTC Optimized", shorttitle="Stoch BTC+", format=format.price, precision=2)
//by indexrate

// ——————————————————————————————————————————————————————————————————————
// ОПТИМИЗИРОВАННЫЕ ПАРАМЕТРЫ ДЛЯ BTC/USD (1D)
// ——————————————————————————————————————————————————————————————————————
periodK     = input.int(21,  title="K Period", minval=1)
periodD     = input.int(3,   title="D Period", minval=1)
smoothK     = input.int(3,   title="Smooth K", minval=1)
upTHR       = input.int(85,  title="Overbought Level", minval=0, maxval=100)
downTHR     = input.int(15,  title="Oversold Level", minval=0, maxval=100)

// Стиль отображения
showThick   = input.bool(true, title="Выделять линии в зонах")
lineWidthThin = input.int(1, title="Тонкая линия", minval=1, maxval=5)
lineWidthThick = input.int(3, title="Толстая линия", minval=1, maxval=10)

colKThin    = input.color(#2196f3, title="%K (обычный)")
colKThick   = input.color(#0d47a1, title="%K (в зоне)")
colDThin    = input.color(#ff9800, title="%D (обычный)")
colDThick   = input.color(#e65100, title="%D (в зоне)")

fillTransparency = input.int(90, title="Прозрачность фона", minval=0, maxval=100)
showArrows  = input.bool(true, title="Показывать стрелки сигналов")

// ——————————————————————————————————————————————————————————————————————
// РАСЧЁТЫ
// ——————————————————————————————————————————————————————————————————————
k = ta.sma(ta.stoch(close, high, low, periodK), smoothK)
d = ta.sma(k, periodD)

// Сигналы ТОЛЬКО при пересечении ВНУТРИ зон
longCondition  = ta.crossover(k, d) and (k <= downTHR) and (d <= downTHR)
shortCondition = ta.crossunder(k, d) and (k >= upTHR) and (d >= upTHR)

// Только первое появление сигнала (фильтр повторов)
longSignal = longCondition and not longCondition[1]
shortSignal = shortCondition and not shortCondition[1]

// ——————————————————————————————————————————————————————————————————————
// ОТОБРАЖЕНИЕ
// ——————————————————————————————————————————————————————————————————————
hline(upTHR, "Overbought", color=color.gray)
hline(downTHR, "Oversold", color=color.gray)
hline(50, "Mid", color=color.silver, linestyle=hline.style_dotted)

// %K
plot(showThick and (k >= upTHR or k <= downTHR) ? k : na, title="%K (thick)", color=colKThick, linewidth=lineWidthThick)
plot(showThick and (k > downTHR and k < upTHR) ? k : na, title="%K (thin)", color=colKThin, linewidth=lineWidthThin)
plot(not showThick ? k : na, title="%K", color=colKThin, linewidth=lineWidthThin)

// %D
plot(showThick and (d >= upTHR or d <= downTHR) ? d : na, title="%D (thick)", color=colDThick, linewidth=lineWidthThick)
plot(showThick and (d > downTHR and d < upTHR) ? d : na, title="%D (thin)", color=colDThin, linewidth=lineWidthThin)
plot(not showThick ? d : na, title="%D", color=colDThin, linewidth=lineWidthThin)

// Фон между зонами
fill(hline(upTHR), hline(downTHR), color=color.new(color.purple, fillTransparency))

// Фон при сигналах
bgcolor(longSignal ? color.new(color.green, 85) : na)
bgcolor(shortSignal ? color.new(color.red, 85) : na)

// Стрелки сигналов
plotshape(showArrows and longSignal, title="Buy Signal", location=location.belowbar, color=color.green, style=shape.triangleup, size=size.small)
plotshape(showArrows and shortSignal, title="Sell Signal", location=location.abovebar, color=color.red, style=shape.triangledown, size=size.small)

// ——————————————————————————————————————————————————————————————————————
// MPL 2.0 NOTICE (обязательно по лицензии)
// ——————————————————————————————————————————————————————————————————————
// This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0.
// You can obtain a copy of the MPL at https://mozilla.org/MPL/2.0/.
