//@version=6
strategy("LBR 3-10-16 Anti Strategy", overlay=true, initial_capital=10000, default_qty_type=strategy.percent_of_equity, default_qty_value=10)

// =============================================================================
// DESCRIPTION
// =============================================================================
// A mechanical MACD-based strategy inspired by Linda Raschke's "310 oscillator" (3-10-16 settings).
// Targets the "Anti" setup: the first meaningful pullback after a sharp counter-trend move / potential trend exhaustion.
// Works on any instrument and timeframe with proper risk management.

// LONG logic summary:
// • Signal line sloping up (bullish context)
// • MACD > 0 (prior bullish momentum)
// • Recent MACD pullback down, now turning up
// • Histogram contracting (MACD reverting toward signal)
// • Entry on MACD hook up (MACD above signal while both aligned bullishly)

// Similar inverted logic for SHORT.

// Includes:
// • Optional ATR-based or fixed % SL/TP (ATR recommended)
// • Visual entry labels + background trend bias
// • Alerts using alert() function (correct for strategies)

// =============================================================================
// INPUTS
// =============================================================================
group_ind = "Indicator Settings"
fastLength   = input.int(3,  "Fast MA Length",   minval=1, group=group_ind)
slowLength   = input.int(10, "Slow MA Length",   minval=1, group=group_ind)
signalLength = input.int(16, "Signal Line Length", minval=1, group=group_ind)

group_risk = "Risk Management"
useATRStops     = input.bool(true, "Use ATR for SL/TP?", group=group_risk)
atrLength       = input.int(14, "ATR Length", group=group_risk)
slMultiplier     = input.float(2.0, "Stop Loss Multiplier", step=0.1, group=group_risk)
tpMultiplier     = input.float(3.0, "Take Profit Multiplier", step=0.1, group=group_risk)
fixedSLPercent  = input.float(1.0, "Fixed SL %", step=0.1, group=group_risk) / 100
fixedTPPercent  = input.float(2.0, "Fixed TP %", step=0.1, group=group_risk) / 100

// =============================================================================
// CALCULATIONS
// =============================================================================
[macdLine, signalLine, histLine] = ta.macd(close, fastLength, slowLength, signalLength)
atrValue = ta.atr(atrLength)

// =============================================================================
// CONDITIONS
// =============================================================================
// LONG
bullishSignalSlope = signalLine > signalLine[1]
bullishMomentum    = macdLine > 0
macdWasDropping    = macdLine[1] < macdLine[2]
macdNowRising      = macdLine > macdLine[1]
histContracting    = histLine < histLine[2]   // pullback / reversion toward signal

longTrigger = bullishSignalSlope and bullishMomentum and macdNowRising and macdWasDropping and (macdLine > signalLine)

// SHORT
bearishSignalSlope = signalLine < signalLine[1]
bearishMomentum    = macdLine < 0
macdWasRising      = macdLine[1] > macdLine[2]
macdNowDropping    = macdLine < macdLine[1]

shortTrigger = bearishSignalSlope and bearishMomentum and macdNowDropping and macdWasRising and (macdLine < signalLine)

// =============================================================================
// RISK LEVELS (calculated on entry bar)
// =============================================================================
var float longSL  = na
var float longTP  = na
var float shortSL = na
var float shortTP = na

if useATRStops
    longSL  := close - atrValue * slMultiplier
    longTP  := close + atrValue * tpMultiplier
    shortSL := close + atrValue * slMultiplier
    shortTP := close - atrValue * tpMultiplier
else
    longSL  := close * (1 - fixedSLPercent)
    longTP  := close * (1 + fixedTPPercent)
    shortSL := close * (1 + fixedSLPercent)
    shortTP := close * (1 - fixedTPPercent)

// =============================================================================
// ENTRIES & EXITS
// =============================================================================
if longTrigger
    strategy.entry("Long Anti", strategy.long)
    strategy.exit("Exit Long", from_entry="Long Anti", stop=longSL, limit=longTP)

if shortTrigger
    strategy.entry("Short Anti", strategy.short)
    strategy.exit("Exit Short", from_entry="Short Anti", stop=shortSL, limit=shortTP)

// =============================================================================
// VISUALS
// =============================================================================
plotshape(longTrigger,  "Long Anti Signal",  style=shape.labelup,   location=location.belowbar, color=color.green, text="ANTI\nLONG",  textcolor=color.white, size=size.small)
plotshape(shortTrigger, "Short Anti Signal", style=shape.labeldown, location=location.abovebar, color=color.red,   text="ANTI\nSHORT", textcolor=color.white, size=size.small)

// Background trend bias
bgcolor(bullishSignalSlope ? color.new(color.green, 90) : bearishSignalSlope ? color.new(color.red, 90) : na)

// =============================================================================
// ALERTS (using alert() – correct method for strategies)
// =============================================================================
if longTrigger
    alert("LBR 3-10-16 Anti → LONG Setup Detected", alert.freq_once_per_bar_close)

if shortTrigger
    alert("LBR 3-10-16 Anti → SHORT Setup Detected", alert.freq_once_per_bar_close)
