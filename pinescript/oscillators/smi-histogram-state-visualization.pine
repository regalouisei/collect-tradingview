//@version=6
indicator("SMI Histogram â€“ State Visualization", "SMI States", timeframe="", timeframe_gaps=true)

lengthK   = input.int(10, "%K Length", minval=1)
lengthD   = input.int(3,  "%D Length", minval=1)
lengthEMA = input.int(3,  "EMA Length", minval=1)

// Double EMA helper
emaEma(src, len) =>
    ta.ema(ta.ema(src, len), len)

// SMI calculation
hh = ta.highest(lengthK)
ll = ta.lowest(lengthK)

rangeHL = hh - ll
rel     = close - (hh + ll) / 2

smi = 200 * emaEma(rel, lengthD) / emaEma(rangeHL, lengthD)
smiEma = ta.ema(smi, lengthEMA)

// --- STATE CONDITIONS ---
oversold   = smi < -40
overbought = smi > 40

aboveEma = smi >= smiEma
belowEma = smi <  smiEma

// --- HISTOGRAM COLOR LOGIC (FIXED) ---
histColor = (
    oversold   and belowEma ? color.new(color.red,    0) :
    oversold   and aboveEma ? color.new(color.orange, 0) :
    overbought and aboveEma ? color.new(color.green,  0) :
    overbought and belowEma ? color.new(color.yellow, 0) :
    smi >= 0                ? color.new(color.green, 60) :
                              color.new(color.red,   60)
)

// --- PLOTS ---
plot(
    smi,
    title="SMI Histogram",
    style=plot.style_histogram,
    color=histColor,
    linewidth=2
)

plot(
    smiEma,
    title="SMI EMA",
    color=color.white,
    linewidth=2
)

// --- REFERENCE LINES ---
hline(40,  "Overbought", color=color.new(color.green, 70))
hline(-40, "Oversold",   color=color.new(color.red,   70))
hline(0,   "Zero Line",  color=color.new(color.gray,  60))
