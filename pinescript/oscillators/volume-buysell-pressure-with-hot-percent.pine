// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © NPR21

//@version=6
indicator("Volume Buy/Sell Pressure with Hot Percent", shorttitle="Vol B/S Pressure", overlay=false)

// ═══════════════════════════════════════════════════════════════════════════════
// DESCRIPTION
// ═══════════════════════════════════════════════════════════════════════════════
// Advanced volume analysis indicator that reveals real-time buying and selling 
// pressure with hot volume detection and customizable alerts.
//
// KEY FEATURES:
// • Three-layer histogram: total volume (gray), buying (green), selling (red)
// • Real-time metrics: buying/selling %, current bar, daily totals, averages
// • Hot volume detection with automatic alerts and visual markers
// • Fully customizable labels: 4 sizes, 9 positions, toggle metrics on/off
// • Smart color coding for instant insight
//
// PERFECT FOR:
// Day traders, scalpers, breakout traders - optimized for futures (MNQ, MES, MYM)
// but works on all instruments and timeframes.
//
// ALERTS: Hot volume, unusual 30-bar volume, unusual 30-day volume
//
// No repainting. Efficient code. Professional volume analysis.
// ═══════════════════════════════════════════════════════════════════════════════

// ═══════════════════════════════════════════════════════════════════════════════
// INPUTS
// ═══════════════════════════════════════════════════════════════════════════════

var g1 = "═══ Display Settings ═══"
show30DayAvg = input.bool(false, "Show 30 Day Average", group=g1)
showTodayVolume = input.bool(true, "Show Today Volume", group=g1)
showPercentOf30DayAvg = input.bool(false, "Show % of 30 Day Avg", group=g1)
show30BarAvg = input.bool(false, "Show 30 Bar Average", group=g1)
showCurrentBar = input.bool(true, "Show Current Bar", group=g1)
showPercentOf30BarAvg = input.bool(false, "Show % of 30 Bar Avg", group=g1)
showSellVolumePercent = input.bool(true, "Show Sell/Buy Volume %", group=g1)
showAsVolume = input.bool(false, "Show Buy/Sell as Volume Count", group=g1, tooltip="When enabled, shows actual volume counts instead of percentages")
labelSize = input.string("Large", "Label Size", options=["Small", "Normal", "Large", "Huge"], group=g1)
labelPosition = input.string("Top Left", "Label Position", options=["Top Left", "Top Center", "Top Right", "Middle Left", "Middle Center", "Middle Right", "Bottom Left", "Bottom Center", "Bottom Right"], group=g1)

var g2 = "═══ Volume Settings ═══"
unusualVolumePercent = input.int(200, "Unusual Volume %", minval=100, group=g2)
volAvgLength = input.int(21, "Volume Average Length", minval=1, group=g2)

var g3 = "═══ Hot Volume Settings ═══"
typeHV = input.string("SMP", "Average Type", options=["SMP", "EXP"], group=g3)
lengthHV = input.int(20, "Hot Volume Length", minval=1, group=g3)
hotPct = input.float(100.0, "Hot Volume %", minval=0, group=g3)

// ═══════════════════════════════════════════════════════════════════════════════
// CALCULATIONS
// ═══════════════════════════════════════════════════════════════════════════════

// Buy/Sell Volume Calculation
barRange = high - low
buying = barRange != 0 ? volume * (close - low) / barRange : 0
selling = barRange != 0 ? volume * (high - close) / barRange : 0

// Volume Data - 30 Day Average
volLast30DayAvg = request.security(syminfo.tickerid, "D", 
    (volume[1] + volume[2] + volume[3] + volume[4] + volume[5] + 
     volume[6] + volume[7] + volume[8] + volume[9] + volume[10] +
     volume[11] + volume[12] + volume[13] + volume[14] + volume[15] +
     volume[16] + volume[17] + volume[18] + volume[19] + volume[20] +
     volume[21] + volume[22] + volume[23] + volume[24] + volume[25] +
     volume[26] + volume[27] + volume[28] + volume[29] + volume[30]) / 30)

todayVol = request.security(syminfo.tickerid, "D", volume, barmerge.gaps_off, barmerge.lookahead_on)
percentOf30Day = volLast30DayAvg != 0 ? math.round((todayVol / volLast30DayAvg) * 100) : 0

// 30 Bar Average
avg30Bars = (volume[1] + volume[2] + volume[3] + volume[4] + volume[5] +
             volume[6] + volume[7] + volume[8] + volume[9] + volume[10] +
             volume[11] + volume[12] + volume[13] + volume[14] + volume[15] +
             volume[16] + volume[17] + volume[18] + volume[19] + volume[20] +
             volume[21] + volume[22] + volume[23] + volume[24] + volume[25] +
             volume[26] + volume[27] + volume[28] + volume[29] + volume[30]) / 30

curVolume = volume
percentOf30Bar = avg30Bars != 0 ? math.round((curVolume / avg30Bars) * 100) : 0

// Sell/Buy Volume Percentages
sellVolPercent = volume != 0 ? math.round((selling / volume) * 100) : 0
buyVolPercent = volume != 0 ? math.round((buying / volume) * 100) : 0

// Volume Average
volAvg = ta.sma(volume, volAvgLength)

// Hot Volume
ma = typeHV == "SMP" ? ta.sma(volume, lengthHV) : ta.ema(volume, lengthHV)
hvCondition = ma != 0 and (100 * ((volume / ma) - 1) >= hotPct)

// ═══════════════════════════════════════════════════════════════════════════════
// HELPER FUNCTIONS
// ═══════════════════════════════════════════════════════════════════════════════

// Function to format numbers with commas
formatNumber(num) =>
    string result = ""
    string numStr = str.tostring(math.round(num))
    int len = str.length(numStr)
    int commaCount = 0
    
    for i = len - 1 to 0
        if commaCount == 3
            result := "," + result
            commaCount := 0
        result := str.substring(numStr, i, i + 1) + result
        commaCount += 1
    
    result

// Function to get label size based on user selection
getLabelSize() =>
    labelSize == "Small" ? size.small : labelSize == "Normal" ? size.normal : labelSize == "Large" ? size.large : size.huge

// Function to get label position based on user selection
getLabelPosition() =>
    switch labelPosition
        "Top Left" => position.top_left
        "Top Center" => position.top_center
        "Top Right" => position.top_right
        "Middle Left" => position.middle_left
        "Middle Center" => position.middle_center
        "Middle Right" => position.middle_right
        "Bottom Left" => position.bottom_left
        "Bottom Center" => position.bottom_center
        => position.bottom_right

// ═══════════════════════════════════════════════════════════════════════════════
// PLOTS
// ═══════════════════════════════════════════════════════════════════════════════

// LAYER 1: Buy Volume (BRIGHT GREEN) - THICKEST, shows around edges
plot(buying, "Buy Volume", color=color.new(#00FF00, 0), style=plot.style_histogram, linewidth=14)

// LAYER 2: Total Volume (gray) - Base layer, plotted SECOND
plot(volume, "Total Volume", color=color.new(color.gray, 0), style=plot.style_histogram, linewidth=10)

// LAYER 3: Sell Volume (BRIGHT RED) - SAME SIZE as gray, overlaid ON TOP of gray
plot(selling, "Sell Volume", color=color.new(#FF3333, 0), style=plot.style_histogram, linewidth=10)

// Volume Average (light gray/silver - matches TradingView default)
plot(volAvg, "Volume Average", color=color.new(color.silver, 0), linewidth=2)

// Hot Volume (bright white triangles for maximum visibility)
plotshape(hvCondition ? volAvg : na, "Hot Volume", style=shape.triangleup, location=location.absolute, color=color.rgb(255, 255, 255), size=size.tiny)

// ═══════════════════════════════════════════════════════════════════════════════
// LABELS
// ═══════════════════════════════════════════════════════════════════════════════

// Vibrant color definitions - BRIGHT colors for maximum impact
brightGreen = color.rgb(0, 255, 0)
brightRed = color.rgb(255, 0, 0)
goldenOrange = color.rgb(255, 180, 0)
mediumGray = color.rgb(128, 128, 128)
brightWhite = color.rgb(255, 255, 255)
brightBlack = color.rgb(0, 0, 0)

// Color functions for labels
getVolumeBgColor(pct) =>
    pct >= unusualVolumePercent ? brightGreen : pct >= 100 ? goldenOrange : mediumGray

getSellPressureBgColor(sellPct, buyPct) =>
    sellPct > buyPct ? brightRed : goldenOrange

getBuyPressureBgColor(buyPct, sellPct) =>
    buyPct > sellPct ? brightGreen : goldenOrange

// Helper function to get current bar background color based on pressure
getCurrentBarBgColor() =>
    buyVolPercent > sellVolPercent ? brightGreen : sellVolPercent > buyVolPercent ? brightRed : goldenOrange

// Helper function to get text color - white on gray, black on all colored backgrounds
getTextColor(bgColor) =>
    bgColor == mediumGray ? brightWhite : brightBlack

// Get the selected label size and position
textSize = getLabelSize()
tablePosition = getLabelPosition()

// Volume Labels - positioned based on user selection
var table volTable = table.new(tablePosition, 8, 1, border_width=1, border_color=color.gray)

if barstate.islast
    col = 0
    
    // Today Volume
    if showTodayVolume
        bgColor = getVolumeBgColor(percentOf30Day)
        table.cell(volTable, col, 0, "Today: " + formatNumber(todayVol), 
                  text_color=getTextColor(bgColor), bgcolor=bgColor, text_size=textSize, text_font_family=font.family_default)
        col += 1
    
    // Current Bar - aligned with buying/selling pressure
    if showCurrentBar
        bgColor = getCurrentBarBgColor()
        table.cell(volTable, col, 0, "Current Bar: " + formatNumber(curVolume), 
                  text_color=getTextColor(bgColor), bgcolor=bgColor, text_size=textSize, text_font_family=font.family_default)
        col += 1
    
    // Selling Pressure - show as volume count or percentage
    if showSellVolumePercent
        sellText = showAsVolume ? "Selling: " + formatNumber(selling) : "Selling Pressure: " + str.tostring(sellVolPercent) + "%"
        bgColor = getSellPressureBgColor(sellVolPercent, buyVolPercent)
        table.cell(volTable, col, 0, sellText, 
                  text_color=getTextColor(bgColor), bgcolor=bgColor, text_size=textSize, text_font_family=font.family_default)
        col += 1
    
    // Buying Pressure - show as volume count or percentage
    if showSellVolumePercent
        buyText = showAsVolume ? "Buying: " + formatNumber(buying) : "Buying Pressure: " + str.tostring(buyVolPercent) + "%"
        bgColor = getBuyPressureBgColor(buyVolPercent, sellVolPercent)
        table.cell(volTable, col, 0, buyText, 
                  text_color=getTextColor(bgColor), bgcolor=bgColor, text_size=textSize, text_font_family=font.family_default)
        col += 1
    
    // 30 Bar %
    if showPercentOf30BarAvg
        bgColor = getVolumeBgColor(percentOf30Bar)
        table.cell(volTable, col, 0, "30 Bar: " + str.tostring(percentOf30Bar) + "%", 
                  text_color=getTextColor(bgColor), bgcolor=bgColor, text_size=textSize, text_font_family=font.family_default)
        col += 1
    
    // 30 Day %
    if showPercentOf30DayAvg
        bgColor = getVolumeBgColor(percentOf30Day)
        table.cell(volTable, col, 0, "30 Day: " + str.tostring(percentOf30Day) + "%", 
                  text_color=getTextColor(bgColor), bgcolor=bgColor, text_size=textSize, text_font_family=font.family_default)
        col += 1
    
    // 30 Bar Average
    if show30BarAvg
        table.cell(volTable, col, 0, "Avg 30 Bars: " + formatNumber(avg30Bars), 
                  text_color=brightWhite, bgcolor=mediumGray, text_size=textSize, text_font_family=font.family_default)
        col += 1
    
    // 30 Day Average
    if show30DayAvg
        table.cell(volTable, col, 0, "Avg 30 Days: " + formatNumber(volLast30DayAvg), 
                  text_color=brightWhite, bgcolor=mediumGray, text_size=textSize, text_font_family=font.family_default)
        col += 1

// ═══════════════════════════════════════════════════════════════════════════════
// ALERTS
// ═══════════════════════════════════════════════════════════════════════════════

alertcondition(hvCondition, "Hot Volume Alert", "Volume is {{plot_0}}% above average")
alertcondition(percentOf30Bar >= unusualVolumePercent, "Unusual Volume (30 Bar)", "Current bar volume is {{plot_0}}% of 30-bar average")
alertcondition(percentOf30Day >= unusualVolumePercent, "Unusual Volume (30 Day)", "Today's volume is {{plot_0}}% of 30-day average")
