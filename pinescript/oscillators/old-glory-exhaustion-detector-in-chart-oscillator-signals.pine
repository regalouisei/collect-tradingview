//@version=6
indicator("Old Glory Exhaustion Detector", overlay=true)

// ── INPUTS ─────────────────────────────────────
showOscDiamonds   = input.bool(true,  "Show Oscillator Diamonds on Chart", group="Oscillator Diamonds")
showOverextBodies = input.bool(true,  "Highlight Candle Bodies on Overextended Osc", group="Oscillator Diamonds")

oscLength      = input.int(34, "Oscillator Main Length", group="Oscillator Diamonds")
oscSmoothLength= input.int(5,  "Smoothing Length", group="Oscillator Diamonds")
overextThresh  = input.int(80, "Overextended Threshold (±80 to ±100)", minval=50, maxval=100, group="Oscillator Diamonds")
pivotLength    = input.int(5,  "Pivot Lookback Length (for Divergence)", minval=3, maxval=10, group="Oscillator Diamonds")

// ── COLOR INPUTS ─────────────────────
buyDiamondColor   = input.color(color.red,    "Buy Diamond Color",          group="Colors")
sellDiamondColor  = input.color(color.blue,   "Sell Diamond Color",         group="Colors")
regBullDivColor   = input.color(color.yellow, "Regular Bullish Div Color",  group="Colors")
regBearDivColor   = input.color(color.yellow, "Regular Bearish Div Color",  group="Colors")
hidBullDivColor   = input.color(color.silver, "Hidden Bullish Div Color",   group="Colors")
hidBearDivColor   = input.color(color.silver, "Hidden Bearish Div Color",   group="Colors")
overextBodyColor  = input.color(#b09600,      "Overextended Body Color",    group="Colors")

// ── OSCILLATOR LOGIC ─────────────────────
fastMA  = ta.sma(hl2, oscSmoothLength)
slowMA  = ta.sma(hl2, oscLength)
rawOsc  = fastMA - slowMA

oscRange = ta.stdev(rawOsc, oscLength * 2)
osc = (rawOsc / math.max(oscRange, 1e-10)) * 50   // safer zero-division handling

overext = math.abs(osc) > overextThresh

buySignal  = osc < -overextThresh and osc > osc[1] and osc[1] <= osc[2]
sellSignal = osc >  overextThresh and osc < osc[1] and osc[1] >= osc[2]

plotshape(showOscDiamonds and buySignal,  location=location.belowbar, color=buyDiamondColor,   style=shape.diamond, size=size.small, title="Buy Diamond")
plotshape(showOscDiamonds and sellSignal, location=location.abovebar, color=sellDiamondColor,  style=shape.diamond, size=size.small, title="Sell Diamond")

priceLowPivot  = ta.pivotlow(low,  pivotLength, pivotLength)
priceHighPivot = ta.pivothigh(high, pivotLength, pivotLength)
oscLowPivot    = ta.pivotlow(osc,  pivotLength, pivotLength)
oscHighPivot   = ta.pivothigh(osc, pivotLength, pivotLength)

bullRegDiv = not na(priceLowPivot) and not na(oscLowPivot[pivotLength]) and 
             low < low[pivotLength * 2] and osc > osc[pivotLength * 2] and osc < -overextThresh

bearRegDiv = not na(priceHighPivot) and not na(oscHighPivot[pivotLength]) and 
             high > high[pivotLength * 2] and osc < osc[pivotLength * 2] and osc > overextThresh

bullHidDiv = not na(priceLowPivot) and not na(oscLowPivot[pivotLength]) and 
             low > low[pivotLength * 2] and osc < osc[pivotLength * 2]

bearHidDiv = not na(priceHighPivot) and not na(oscHighPivot[pivotLength]) and 
             high < high[pivotLength * 2] and osc > osc[pivotLength * 2]

plotshape(showOscDiamonds and bullRegDiv, location=location.belowbar, color=regBullDivColor, style=shape.diamond, size=size.tiny, title="Regular Bullish Div")
plotshape(showOscDiamonds and bearRegDiv, location=location.abovebar, color=regBearDivColor, style=shape.diamond, size=size.tiny, title="Regular Bearish Div")
plotshape(showOscDiamonds and bullHidDiv, location=location.belowbar, color=hidBullDivColor, style=shape.diamond, size=size.tiny, title="Hidden Bullish Div")
plotshape(showOscDiamonds and bearHidDiv, location=location.abovebar, color=hidBearDivColor, style=shape.diamond, size=size.tiny, title="Hidden Bearish Div")

// ── OVEREXTENDED CANDLE BODIES ─────────────────────
barcolor(showOverextBodies and overext ? overextBodyColor : na)
