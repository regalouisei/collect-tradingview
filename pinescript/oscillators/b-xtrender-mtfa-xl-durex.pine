//@version=5
indicator('B-Xtrender MTFA', overlay=false)

// ============ TIMEFRAME INPUTS ============
tf1 = input.timeframe('D', title='Timeframe 1', tooltip='Default: Daily')
tf2 = input.timeframe('W', title='Timeframe 2', tooltip='Default: Weekly')
tf3 = input.timeframe('M', title='Timeframe 3', tooltip='Default: Monthly')

show_tf1 = input(true, title='Show Timeframe 1')
show_tf2 = input(false, title='Show Timeframe 2')
show_tf3 = input(false, title='Show Timeframe 3')

// ============ INDICATOR PARAMETERS ============
short_l1 = input(5, title='Short - L1')
short_l2 = input(20, title='Short - L2')
short_l3 = input(5, title='Short - L3')

long_l1 = input(20, title='Long - L1')
long_l2 = input(5, title='Long - L2')

// ============ CALCULATION FUNCTION ============
calcXtrender() =>
    shortTermXtrender = ta.rsi(ta.ema(close, short_l1) - ta.ema(close, short_l2), short_l3) - 50
    shortTermXtrender

// Calculation function that includes previous bar
calcXtrenderWithPrev() =>
    shortTermXtrender = ta.rsi(ta.ema(close, short_l1) - ta.ema(close, short_l2), short_l3) - 50
    shortTermXtrender_prev = ta.rsi(ta.ema(close[1], short_l1) - ta.ema(close[1], short_l2), short_l3) - 50
    [shortTermXtrender, shortTermXtrender_prev]

// ============ MULTI-TIMEFRAME CALCULATIONS ============
// For TF1
short1 = request.security(syminfo.tickerid, tf1 == '' ? timeframe.period : tf1, calcXtrender())

// For TF2
[short2, short2_prev] = request.security(syminfo.tickerid, tf2, calcXtrenderWithPrev(), barmerge.gaps_off, barmerge.lookahead_on)

// For TF3
[short3, short3_prev] = request.security(syminfo.tickerid, tf3, calcXtrenderWithPrev(), barmerge.gaps_off, barmerge.lookahead_on)

// ============ TIMEFRAME 1 HISTOGRAM ============
shortXtrenderCol1 = short1 > 0 ? short1 > short1[1] ? color.lime : #228B22 : short1 > short1[1] ? color.red : #8B0000
plot(show_tf1 ? short1 : na, color=shortXtrenderCol1, style=plot.style_columns, linewidth=1, title='TF1 - Histogram')

// ============ TIMEFRAME 2 HISTOGRAM ============
shortXtrenderCol2 = short2 > 0 ? short2 > short2_prev ? color.lime : #228B22 : short2 > short2_prev ? color.red : #8B0000
plot(show_tf2 and tf2 != '' ? short2 : na, color=shortXtrenderCol2, style=plot.style_columns, linewidth=1, title='TF2 - Histogram')

// ============ TIMEFRAME 3 HISTOGRAM ============
shortXtrenderCol3 = short3 > 0 ? short3 > short3_prev ? color.lime : #228B22 : short3 > short3_prev ? color.red : #8B0000
plot(show_tf3 and tf3 != '' ? short3 : na, color=shortXtrenderCol3, style=plot.style_columns, linewidth=1, title='TF3 - Histogram')
