//@version=6
indicator("[CT] Trend Pulse Oscillator", shorttitle="[CT] TPO", overlay=false, precision=1)

//────────────────────────────────────────────────────────────────────
// Inputs
//────────────────────────────────────────────────────────────────────
groupCore = "Core"
src       = input.source(close, "Source", group=groupCore)
fastLen   = input.int(9,  "Fast EMA", minval=1, group=groupCore)
slowLen   = input.int(21, "Slow EMA", minval=1, group=groupCore)
atrLen    = input.int(14, "ATR Length", minval=1, group=groupCore)
speed     = input.float(2.0, "Speed (Sensitivity)", minval=0.1, step=0.1, group=groupCore, tooltip="Higher = faster flips, more sensitive. Lower = smoother, fewer flips.")

groupSig  = "Signal"
sigLen    = input.int(9, "Signal Length", minval=1, group=groupSig)

groupLvls = "Levels"
ob        = input.float(80, "Overbought", minval=0, maxval=100, group=groupLvls)
os        = input.float(20, "Oversold",   minval=0, maxval=100, group=groupLvls)

groupStyle = "Style"
showFill   = input.bool(true, "Fill Between Osc & Signal", group=groupStyle)
fillOpacity= input.int(85, "Fill Opacity", minval=0, maxval=100, group=groupStyle)
showHist   = input.bool(true, "Show Pulse Histogram (Osc - Signal)", group=groupStyle)
showBars   = input.bool(false, "Color Price Bars (on chart)", group=groupStyle)

// Colors (user adjustable)
bullCol    = input.color(color.new(color.lime, 0), "Bull Color", group=groupStyle)
bearCol    = input.color(color.new(color.red,  0), "Bear Color", group=groupStyle)
sigCol     = input.color(color.new(color.aqua, 0), "Signal Color", group=groupStyle)
oscCol     = input.color(color.new(color.teal, 0), "Osc Color", group=groupStyle)

//────────────────────────────────────────────────────────────────────
// Engine (NOT percentile band based)
// Spread of fast/slow EMAs, normalized by ATR, then smoothly bounded to 0–100
//────────────────────────────────────────────────────────────────────
fast = ta.ema(src, fastLen)
slow = ta.ema(src, slowLen)
spread = fast - slow

atr = ta.atr(atrLen)
norm = atr > 0 ? spread / atr : 0.0

// Smooth bounded mapping to 0..100 using atan (Pine-safe)
osc = 50.0 + 50.0 * (2.0 / math.pi) * math.atan(norm * speed)

// Signal line
sig = ta.ema(osc, sigLen)

// Pulse (difference)
pulse = osc - sig

//────────────────────────────────────────────────────────────────────
// Plots & visuals
//────────────────────────────────────────────────────────────────────
pOsc = plot(osc, "Osc", color=oscCol, linewidth=2)
pSig = plot(sig, "Signal", color=sigCol, linewidth=2)

hline(50, "Mid", color=color.new(color.gray, 60), linestyle=hline.style_dashed)
hOB = hline(ob, "Overbought", color=color.new(color.gray, 70), linestyle=hline.style_dashed)
hOS = hline(os, "Oversold",   color=color.new(color.gray, 70), linestyle=hline.style_dashed)

// Fill between Osc and Signal (global scope)
fillCol = showFill ? (osc >= sig ? color.new(bullCol, fillOpacity) : color.new(bearCol, fillOpacity)) : na
fill(pOsc, pSig, color=fillCol, title="Osc/Signal Fill")

// Pulse histogram (global scope)
histCol = osc >= sig ? bullCol : bearCol
plot(showHist ? pulse : na, "Pulse (Osc - Signal)", style=plot.style_histogram, color=histCol, linewidth=2)

// Optional candle coloring on main chart
barcolor(showBars ? (osc >= sig ? bullCol : bearCol) : na)

//────────────────────────────────────────────────────────────────────
// Alerts (your main factor: Osc crossing Signal)
//────────────────────────────────────────────────────────────────────
alertcondition(ta.crossover(osc, sig), "Osc Cross Up Signal", "TPO: Osc crossed ABOVE Signal (bull)")
alertcondition(ta.crossunder(osc, sig),"Osc Cross Down Signal","TPO: Osc crossed BELOW Signal (bear)")
alertcondition(ta.crossover(osc, 50),  "Osc Cross Up 50",     "TPO: Osc crossed ABOVE 50")
alertcondition(ta.crossunder(osc, 50), "Osc Cross Down 50",   "TPO: Osc crossed BELOW 50")
alertcondition(ta.crossover(osc, ob),  "Osc Cross Up OB",     "TPO: Osc crossed ABOVE Overbought")
alertcondition(ta.crossunder(osc, os), "Osc Cross Down OS",   "TPO: Osc crossed BELOW Oversold")
