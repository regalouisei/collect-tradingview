// ============================================
// BUYING OPPORTUNITY INDICATOR V2.2
// ============================================
// 
// Composite scoring system combining multiple fear/oversold signals
// to identify potential buying opportunities during market pullbacks.
// 
// Components:
// - VIX Level (market fear)
// - Price Drawdown (distance from highs)
// - RSI (momentum/oversold)
// - Bollinger Bands (statistical extension)
// - VIX Timing (fear subsiding)
//
// V2.2 Features:
// - Historical signal tracking with stats table
// - Visual markers showing past signals and outcomes
// - Rolling 1Y/3Y/5Y performance statistics
// - Multiple alert options
//
// For educational/research purposes. Past performance does not
// guarantee future results. Not financial advice.
//
// ============================================

//@version=6
indicator("Buying Opportunity Score V2.2", shorttitle="Buying Opportunity V2.2", overlay=false, precision=1, max_labels_count=500, max_lines_count=500)

// ============================================
// INPUTS
// ============================================

// VIX Settings
vixSymbol = input.symbol("CBOE:VIX", "VIX Symbol", group="Volatility Settings")
vixMA_length = input.int(10, "VIX Moving Average", minval=5, maxval=50, group="Volatility Settings")
vixDeclinePeriod = input.int(3, "VIX Decline Lookback", minval=2, maxval=10, group="Volatility Settings")
vixPeakPeriod = input.int(5, "VIX Peak Lookback", minval=3, maxval=20, group="Volatility Settings")

// RSI Settings
rsiLength = input.int(14, "RSI Length", minval=2, maxval=50, group="Indicator Settings")

// Drawdown Settings
drawdownLength = input.int(52, "Drawdown Lookback (weeks)", minval=10, maxval=104, group="Indicator Settings")

// Bollinger Band Settings
bbLength = input.int(20, "Bollinger Band Length", group="Indicator Settings")
bbMult = input.float(2.0, "Bollinger Band StdDev", minval=1.0, maxval=3.0, group="Indicator Settings")

// Signal Thresholds
strongBuyThreshold = input.int(80, "Strong Buy Threshold", minval=60, maxval=95, group="Signal Thresholds")
buyThreshold = input.int(70, "Buy Threshold", minval=50, maxval=90, group="Signal Thresholds")
moderateThreshold = input.int(60, "Moderate Threshold", minval=40, maxval=80, group="Signal Thresholds")

// Display Settings
showComponents = input.bool(false, "Show Component Scores", group="Display")
showSignalMarkers = input.bool(true, "Show Signal Markers on Chart", group="Display")
showStatsTable = input.bool(true, "Show Statistics Table", group="Display")
showOutcomeLabels = input.bool(true, "Show Outcome Labels (Win/Loss)", group="Display")
statsTablePosition = input.string("Bottom Right", "Stats Table Position", options=["Top Right", "Top Left", "Bottom Right", "Bottom Left"], group="Display")

// Outcome Measurement
outcomePeriod = input.int(20, "Outcome Period (days)", minval=5, maxval=60, group="Performance Tracking", tooltip="Number of bars to measure signal success")

// Alert Settings
// Note: Alerts are configured when you create them in TradingView
// Go to: Right-click indicator → Add Alert → Select condition

// ============================================
// CALCULATIONS
// ============================================

// Get VIX data
vixClose = request.security(vixSymbol, timeframe.period, close)
vixMA = ta.sma(vixClose, vixMA_length)

// VIX declining detection
vixDeclineMax = ta.highest(vixClose, vixDeclinePeriod)
vixPeakMax = ta.highest(vixClose, vixPeakPeriod)
vixDeclining = vixClose < vixDeclineMax
vixOffPeak = vixClose < vixPeakMax

// Price data
price = close
highestHigh = ta.highest(high, drawdownLength * 5)
drawdownPct = (highestHigh - price) / highestHigh * 100

// RSI
rsi = ta.rsi(close, rsiLength)

// Bollinger Bands
[bbMiddle, bbUpper, bbLower] = ta.bb(close, bbLength, bbMult)
bbPctB = (close - bbLower) / (bbUpper - bbLower)

// ============================================
// V2 SCORING SYSTEM
// ============================================

// 1. VIX SCORE (0-30)
float vixScore = 0.0
if vixClose >= 40
    vixScore := 30
else if vixClose >= 35
    vixScore := 27
else if vixClose >= 30
    vixScore := 24
else if vixClose >= 27
    vixScore := 20
else if vixClose >= 25
    vixScore := 16
else if vixClose >= 22
    vixScore := 10
else if vixClose >= 20
    vixScore := 5
else
    vixScore := 0

// 2. DRAWDOWN SCORE (0-30)
float ddScore = 0.0
if drawdownPct >= 25
    ddScore := 30
else if drawdownPct >= 20
    ddScore := 26
else if drawdownPct >= 15
    ddScore := 22
else if drawdownPct >= 12
    ddScore := 18
else if drawdownPct >= 10
    ddScore := 14
else if drawdownPct >= 7
    ddScore := 8
else if drawdownPct >= 5
    ddScore := 4
else
    ddScore := 0

// 3. RSI SCORE (0-12)
float rsiScore = 0.0
if rsi <= 20
    rsiScore := 12
else if rsi <= 25
    rsiScore := 10
else if rsi <= 30
    rsiScore := 8
else if rsi <= 35
    rsiScore := 5
else if rsi <= 40
    rsiScore := 2
else
    rsiScore := 0

// 4. BOLLINGER BAND SCORE (0-13)
float bbScore = 0.0
if bbPctB <= -0.1
    bbScore := 13
else if bbPctB <= 0
    bbScore := 10
else if bbPctB <= 0.1
    bbScore := 6
else if bbPctB <= 0.2
    bbScore := 3
else
    bbScore := 0

// 5. VIX TIMING SCORE (0-15)
float timingScore = 0.0
if vixDeclining
    timingScore := timingScore + 10
if vixOffPeak
    timingScore := timingScore + 5

// Composite Score
rawScore = vixScore + ddScore + rsiScore + bbScore + timingScore
compositeScore = math.min(rawScore, 100)

// Signal Classification
isStrongBuy = compositeScore >= strongBuyThreshold
isBuy = compositeScore >= buyThreshold and compositeScore < strongBuyThreshold
isModerate = compositeScore >= moderateThreshold and compositeScore < buyThreshold
isNoSignal = compositeScore < moderateThreshold

// Signal triggers (for new signals only)
strongBuyTrigger = isStrongBuy and not isStrongBuy[1]
buyTrigger = (isStrongBuy or isBuy) and not (isStrongBuy[1] or isBuy[1])
moderateTrigger = (isStrongBuy or isBuy or isModerate) and not (isStrongBuy[1] or isBuy[1] or isModerate[1])

// ============================================
// PERFORMANCE TRACKING
// ============================================

// Track signals and outcomes
var int totalSignals70 = 0
var int wins70 = 0
var int losses70 = 0
var float totalReturn70 = 0.0

var int totalSignals80 = 0
var int wins80 = 0
var int losses80 = 0
var float totalReturn80 = 0.0

// Store signal prices for outcome calculation
var float[] signalPrices70 = array.new_float(0)
var int[] signalBars70 = array.new_int(0)
var float[] signalScores70 = array.new_float(0)

var float[] signalPrices80 = array.new_float(0)
var int[] signalBars80 = array.new_int(0)
var float[] signalScores80 = array.new_float(0)

// Record new 70+ signals
if buyTrigger and barstate.isconfirmed
    array.push(signalPrices70, close)
    array.push(signalBars70, bar_index)
    array.push(signalScores70, compositeScore)
    totalSignals70 := totalSignals70 + 1

// Record new 80+ signals
if strongBuyTrigger and barstate.isconfirmed
    array.push(signalPrices80, close)
    array.push(signalBars80, bar_index)
    array.push(signalScores80, compositeScore)
    totalSignals80 := totalSignals80 + 1

// Check outcomes for 70+ signals
if array.size(signalBars70) > 0
    for i = array.size(signalBars70) - 1 to 0
        signalBar = array.get(signalBars70, i)
        if bar_index - signalBar == outcomePeriod
            signalPrice = array.get(signalPrices70, i)
            returnPct = (close - signalPrice) / signalPrice * 100
            totalReturn70 := totalReturn70 + returnPct
            if returnPct > 0
                wins70 := wins70 + 1
            else
                losses70 := losses70 + 1
            
            // Draw outcome label with context
            if showOutcomeLabels and showSignalMarkers
                outcomeColor = returnPct > 0 ? color.green : color.red
                outcomeText = returnPct > 0 ? "WIN +" + str.tostring(returnPct, "#.#") + "% after " + str.tostring(outcomePeriod) + "d" : "LOSS " + str.tostring(returnPct, "#.#") + "% after " + str.tostring(outcomePeriod) + "d"
                label.new(signalBar, 85, outcomeText, 
                         color=outcomeColor, textcolor=color.white, size=size.small, style=label.style_label_down)

// Check outcomes for 80+ signals
if array.size(signalBars80) > 0
    for i = array.size(signalBars80) - 1 to 0
        signalBar = array.get(signalBars80, i)
        if bar_index - signalBar == outcomePeriod
            signalPrice = array.get(signalPrices80, i)
            returnPct = (close - signalPrice) / signalPrice * 100
            totalReturn80 := totalReturn80 + returnPct
            if returnPct > 0
                wins80 := wins80 + 1
            else
                losses80 := losses80 + 1

// Calculate statistics
completedSignals70 = wins70 + losses70
completedSignals80 = wins80 + losses80

winRate70 = completedSignals70 > 0 ? (wins70 / completedSignals70) * 100 : 0.0
winRate80 = completedSignals80 > 0 ? (wins80 / completedSignals80) * 100 : 0.0

avgReturn70 = completedSignals70 > 0 ? totalReturn70 / completedSignals70 : 0.0
avgReturn80 = completedSignals80 > 0 ? totalReturn80 / completedSignals80 : 0.0

// ============================================
// PLOTTING
// ============================================

// Main score plot with color coding
scoreColor = isStrongBuy ? color.new(color.green, 0) : 
             isBuy ? color.new(color.lime, 0) : 
             isModerate ? color.new(color.orange, 0) : 
             color.new(color.gray, 40)

plot(compositeScore, "V2 Score", color=scoreColor, linewidth=3)

// Reference lines
hline(strongBuyThreshold, "Strong Buy", color=color.green, linestyle=hline.style_solid, linewidth=2)
hline(buyThreshold, "Buy", color=color.lime, linestyle=hline.style_dashed)
hline(moderateThreshold, "Moderate", color=color.orange, linestyle=hline.style_dotted)

// Background coloring
bgcolor(isStrongBuy ? color.new(color.green, 80) : na)
bgcolor(isBuy ? color.new(color.lime, 85) : na)
bgcolor(isModerate ? color.new(color.orange, 85) : na)

// Signal markers
plotshape(showSignalMarkers and strongBuyTrigger ? compositeScore : na, "Strong Buy Signal", 
          shape.triangleup, location.absolute, color.green, size=size.normal)
plotshape(showSignalMarkers and buyTrigger and not strongBuyTrigger ? compositeScore : na, "Buy Signal", 
          shape.triangleup, location.absolute, color.lime, size=size.small)
plotshape(showSignalMarkers and moderateTrigger and not buyTrigger ? compositeScore : na, "Moderate Signal", 
          shape.circle, location.absolute, color.orange, size=size.tiny)

// Component scores (optional display)
plot(showComponents ? vixScore : na, "VIX Score (0-30)", color=color.new(color.purple, 50), linewidth=1)
plot(showComponents ? ddScore : na, "Drawdown Score (0-30)", color=color.new(color.orange, 50), linewidth=1)
plot(showComponents ? rsiScore : na, "RSI Score (0-12)", color=color.new(color.blue, 50), linewidth=1)
plot(showComponents ? bbScore : na, "BB Score (0-13)", color=color.new(color.teal, 50), linewidth=1)
plot(showComponents ? timingScore : na, "Timing Score (0-15)", color=color.new(color.fuchsia, 50), linewidth=1)

// ============================================
// STATISTICS TABLE
// ============================================

// Calculate stats for different lookback periods
var int[] signalBars70_1Y = array.new_int(0)
var int[] signalBars70_3Y = array.new_int(0)
var int[] signalBars70_5Y = array.new_int(0)
var int[] signalBars80_1Y = array.new_int(0)
var int[] signalBars80_3Y = array.new_int(0)
var int[] signalBars80_5Y = array.new_int(0)

var float[] signalPrices70_1Y = array.new_float(0)
var float[] signalPrices70_3Y = array.new_float(0)
var float[] signalPrices70_5Y = array.new_float(0)
var float[] signalPrices80_1Y = array.new_float(0)
var float[] signalPrices80_3Y = array.new_float(0)
var float[] signalPrices80_5Y = array.new_float(0)

// Lookback periods in bars (approximate trading days)
lookback1Y = 252
lookback3Y = 756
lookback5Y = 1260

// Track signals for each period
if buyTrigger and barstate.isconfirmed
    array.push(signalBars70_1Y, bar_index)
    array.push(signalPrices70_1Y, close)
    array.push(signalBars70_3Y, bar_index)
    array.push(signalPrices70_3Y, close)
    array.push(signalBars70_5Y, bar_index)
    array.push(signalPrices70_5Y, close)

if strongBuyTrigger and barstate.isconfirmed
    array.push(signalBars80_1Y, bar_index)
    array.push(signalPrices80_1Y, close)
    array.push(signalBars80_3Y, bar_index)
    array.push(signalPrices80_3Y, close)
    array.push(signalBars80_5Y, bar_index)
    array.push(signalPrices80_5Y, close)

// Remove signals older than lookback period
if array.size(signalBars70_1Y) > 0
    while array.size(signalBars70_1Y) > 0 and bar_index - array.get(signalBars70_1Y, 0) > lookback1Y + outcomePeriod
        array.shift(signalBars70_1Y)
        array.shift(signalPrices70_1Y)

if array.size(signalBars70_3Y) > 0
    while array.size(signalBars70_3Y) > 0 and bar_index - array.get(signalBars70_3Y, 0) > lookback3Y + outcomePeriod
        array.shift(signalBars70_3Y)
        array.shift(signalPrices70_3Y)

if array.size(signalBars70_5Y) > 0
    while array.size(signalBars70_5Y) > 0 and bar_index - array.get(signalBars70_5Y, 0) > lookback5Y + outcomePeriod
        array.shift(signalBars70_5Y)
        array.shift(signalPrices70_5Y)

if array.size(signalBars80_1Y) > 0
    while array.size(signalBars80_1Y) > 0 and bar_index - array.get(signalBars80_1Y, 0) > lookback1Y + outcomePeriod
        array.shift(signalBars80_1Y)
        array.shift(signalPrices80_1Y)

if array.size(signalBars80_3Y) > 0
    while array.size(signalBars80_3Y) > 0 and bar_index - array.get(signalBars80_3Y, 0) > lookback3Y + outcomePeriod
        array.shift(signalBars80_3Y)
        array.shift(signalPrices80_3Y)

if array.size(signalBars80_5Y) > 0
    while array.size(signalBars80_5Y) > 0 and bar_index - array.get(signalBars80_5Y, 0) > lookback5Y + outcomePeriod
        array.shift(signalBars80_5Y)
        array.shift(signalPrices80_5Y)

// Calculate outcomes for each period
var int wins70_1Y = 0, var int losses70_1Y = 0, var float totalRet70_1Y = 0.0
var int wins70_3Y = 0, var int losses70_3Y = 0, var float totalRet70_3Y = 0.0
var int wins70_5Y = 0, var int losses70_5Y = 0, var float totalRet70_5Y = 0.0
var int wins80_1Y = 0, var int losses80_1Y = 0, var float totalRet80_1Y = 0.0
var int wins80_3Y = 0, var int losses80_3Y = 0, var float totalRet80_3Y = 0.0
var int wins80_5Y = 0, var int losses80_5Y = 0, var float totalRet80_5Y = 0.0

// Reset counters each bar and recalculate (needed for lookback windows)
wins70_1Y := 0, losses70_1Y := 0, totalRet70_1Y := 0.0
wins70_3Y := 0, losses70_3Y := 0, totalRet70_3Y := 0.0
wins70_5Y := 0, losses70_5Y := 0, totalRet70_5Y := 0.0
wins80_1Y := 0, losses80_1Y := 0, totalRet80_1Y := 0.0
wins80_3Y := 0, losses80_3Y := 0, totalRet80_3Y := 0.0
wins80_5Y := 0, losses80_5Y := 0, totalRet80_5Y := 0.0

// Helper function to calculate stats
calcStats(signalBars, signalPrices, lookbackPeriod) =>
    int w = 0
    int l = 0
    float totRet = 0.0
    int completed = 0
    if array.size(signalBars) > 0
        for i = 0 to array.size(signalBars) - 1
            sBar = array.get(signalBars, i)
            sPrice = array.get(signalPrices, i)
            barsAgo = bar_index - sBar
            // Only count if within lookback AND has outcome
            if barsAgo >= outcomePeriod and barsAgo <= lookbackPeriod + outcomePeriod
                futurePrice = close[barsAgo - outcomePeriod]
                ret = (futurePrice - sPrice) / sPrice * 100
                totRet := totRet + ret
                completed := completed + 1
                if ret > 0
                    w := w + 1
                else
                    l := l + 1
    [w, l, totRet, completed]

// Calculate all stats
[w70_1Y, l70_1Y, r70_1Y, c70_1Y] = calcStats(signalBars70_1Y, signalPrices70_1Y, lookback1Y)
[w70_3Y, l70_3Y, r70_3Y, c70_3Y] = calcStats(signalBars70_3Y, signalPrices70_3Y, lookback3Y)
[w70_5Y, l70_5Y, r70_5Y, c70_5Y] = calcStats(signalBars70_5Y, signalPrices70_5Y, lookback5Y)
[w80_1Y, l80_1Y, r80_1Y, c80_1Y] = calcStats(signalBars80_1Y, signalPrices80_1Y, lookback1Y)
[w80_3Y, l80_3Y, r80_3Y, c80_3Y] = calcStats(signalBars80_3Y, signalPrices80_3Y, lookback3Y)
[w80_5Y, l80_5Y, r80_5Y, c80_5Y] = calcStats(signalBars80_5Y, signalPrices80_5Y, lookback5Y)

// Calculate win rates and avg returns
winRate70_1Y = c70_1Y > 0 ? w70_1Y / c70_1Y * 100 : na
winRate70_3Y = c70_3Y > 0 ? w70_3Y / c70_3Y * 100 : na
winRate70_5Y = c70_5Y > 0 ? w70_5Y / c70_5Y * 100 : na
winRate80_1Y = c80_1Y > 0 ? w80_1Y / c80_1Y * 100 : na
winRate80_3Y = c80_3Y > 0 ? w80_3Y / c80_3Y * 100 : na
winRate80_5Y = c80_5Y > 0 ? w80_5Y / c80_5Y * 100 : na

avgRet70_1Y = c70_1Y > 0 ? r70_1Y / c70_1Y : na
avgRet70_3Y = c70_3Y > 0 ? r70_3Y / c70_3Y : na
avgRet70_5Y = c70_5Y > 0 ? r70_5Y / c70_5Y : na
avgRet80_1Y = c80_1Y > 0 ? r80_1Y / c80_1Y : na
avgRet80_3Y = c80_3Y > 0 ? r80_3Y / c80_3Y : na
avgRet80_5Y = c80_5Y > 0 ? r80_5Y / c80_5Y : na

// Helper for background color based on win rate
winRateBgColor(wr) =>
    na(wr) ? color.new(color.gray, 70) : wr >= 70 ? color.new(color.green, 60) : wr >= 50 ? color.new(color.orange, 60) : color.new(color.red, 60)

// Helper for background color based on return
returnBgColor(ret) =>
    na(ret) ? color.new(color.gray, 70) : ret > 0 ? color.new(color.green, 70) : color.new(color.red, 70)

// Format value or show dash
formatPct(val) =>
    na(val) ? "—" : str.tostring(val, "#.#") + "%"

formatInt(val) =>
    str.tostring(val)

// ============================================
// UNIFIED STATISTICS TABLE
// ============================================

var table statsTable = table.new(position.bottom_right, 7, 7, bgcolor=color.white, border_width=1, border_color=color.new(color.gray, 60), frame_width=2, frame_color=color.black)

if barstate.islast and showStatsTable
    // Row 0: Title
    table.cell(statsTable, 0, 0, "", bgcolor=color.new(color.black, 20))
    table.cell(statsTable, 1, 0, "", bgcolor=color.new(color.black, 20))
    table.cell(statsTable, 2, 0, "", bgcolor=color.new(color.black, 20))
    table.cell(statsTable, 3, 0, " BUYING OPPORTUNITY INDICATOR ", text_color=color.white, text_size=size.normal, bgcolor=color.new(color.black, 20))
    table.cell(statsTable, 4, 0, "", bgcolor=color.new(color.black, 20))
    table.cell(statsTable, 5, 0, "", bgcolor=color.new(color.black, 20))
    table.cell(statsTable, 6, 0, "", bgcolor=color.new(color.black, 20))
    
    // Row 1: Current Score (purple bar spanning all columns) - LARGER for emphasis
    signalText = isStrongBuy ? "STRONG BUY" : isBuy ? "BUY" : isModerate ? "WATCH" : "NO SIGNAL"
    contextMsg = compositeScore >= 80 ? "HIGH CONVICTION" : 
                 compositeScore >= 70 ? "CONSIDER ENTRY" : 
                 compositeScore >= 60 ? "ENTRY SOON" : 
                 compositeScore >= 50 ? "MONITOR" : 
                 compositeScore >= 30 ? "NOT ACTIONABLE" : 
                 "WAIT FOR PULLBACK"
    
    table.cell(statsTable, 0, 1, " CURRENT SCORE ", text_color=color.white, text_size=size.large, bgcolor=color.new(color.purple, 30))
    table.cell(statsTable, 1, 1, " " + str.tostring(compositeScore, "#") + " ", text_color=color.white, text_size=size.large, bgcolor=color.new(color.purple, 30))
    table.cell(statsTable, 2, 1, " " + signalText + " ", text_color=color.white, text_size=size.large, bgcolor=color.new(color.purple, 30))
    table.cell(statsTable, 3, 1, "", bgcolor=color.new(color.purple, 30))
    table.cell(statsTable, 4, 1, " " + contextMsg + " ", text_color=color.white, text_size=size.large, bgcolor=color.new(color.purple, 30))
    table.cell(statsTable, 5, 1, "", bgcolor=color.new(color.purple, 30))
    table.cell(statsTable, 6, 1, "", bgcolor=color.new(color.purple, 30))
    
    // Row 2: Chart Results header with 1Y/3Y/5Y
    table.cell(statsTable, 0, 2, " Chart Results ", text_color=color.white, text_size=size.normal, bgcolor=color.new(color.navy, 20))
    table.cell(statsTable, 1, 2, " 1Y ", text_color=color.white, text_size=size.normal, bgcolor=color.new(color.lime, 30))
    table.cell(statsTable, 2, 2, " 3Y ", text_color=color.white, text_size=size.normal, bgcolor=color.new(color.lime, 30))
    table.cell(statsTable, 3, 2, " 5Y ", text_color=color.white, text_size=size.normal, bgcolor=color.new(color.lime, 30))
    table.cell(statsTable, 4, 2, " 1Y ", text_color=color.white, text_size=size.normal, bgcolor=color.new(color.green, 20))
    table.cell(statsTable, 5, 2, " 3Y ", text_color=color.white, text_size=size.normal, bgcolor=color.new(color.green, 20))
    table.cell(statsTable, 6, 2, " 5Y ", text_color=color.white, text_size=size.normal, bgcolor=color.new(color.green, 20))
    
    // Row 3: Signal type labels (70+ Buy / 80+ Strong Buy)
    table.cell(statsTable, 0, 3, "", bgcolor=color.new(color.gray, 80))
    table.cell(statsTable, 1, 3, "", bgcolor=color.new(color.lime, 50))
    table.cell(statsTable, 2, 3, " 70+ (Buy) ", text_color=color.black, text_size=size.normal, bgcolor=color.new(color.lime, 50))
    table.cell(statsTable, 3, 3, "", bgcolor=color.new(color.lime, 50))
    table.cell(statsTable, 4, 3, "", bgcolor=color.new(color.green, 40))
    table.cell(statsTable, 5, 3, " 80+ (Strong Buy) ", text_color=color.black, text_size=size.normal, bgcolor=color.new(color.green, 40))
    table.cell(statsTable, 6, 3, "", bgcolor=color.new(color.green, 40))
    
    // Row 4: Signals count
    table.cell(statsTable, 0, 4, " Signals ", text_color=color.black, text_size=size.normal, bgcolor=color.new(color.gray, 80))
    table.cell(statsTable, 1, 4, " " + formatInt(c70_1Y) + " ", text_color=color.black, text_size=size.normal, bgcolor=color.new(color.gray, 90))
    table.cell(statsTable, 2, 4, " " + formatInt(c70_3Y) + " ", text_color=color.black, text_size=size.normal, bgcolor=color.new(color.gray, 90))
    table.cell(statsTable, 3, 4, " " + formatInt(c70_5Y) + " ", text_color=color.black, text_size=size.normal, bgcolor=color.new(color.gray, 90))
    table.cell(statsTable, 4, 4, " " + formatInt(c80_1Y) + " ", text_color=color.black, text_size=size.normal, bgcolor=color.new(color.gray, 90))
    table.cell(statsTable, 5, 4, " " + formatInt(c80_3Y) + " ", text_color=color.black, text_size=size.normal, bgcolor=color.new(color.gray, 90))
    table.cell(statsTable, 6, 4, " " + formatInt(c80_5Y) + " ", text_color=color.black, text_size=size.normal, bgcolor=color.new(color.gray, 90))
    
    // Row 5: Win Rate
    table.cell(statsTable, 0, 5, " Win Rate ", text_color=color.black, text_size=size.normal, bgcolor=color.new(color.gray, 80))
    table.cell(statsTable, 1, 5, " " + formatPct(winRate70_1Y) + " ", text_color=color.black, text_size=size.normal, bgcolor=winRateBgColor(winRate70_1Y))
    table.cell(statsTable, 2, 5, " " + formatPct(winRate70_3Y) + " ", text_color=color.black, text_size=size.normal, bgcolor=winRateBgColor(winRate70_3Y))
    table.cell(statsTable, 3, 5, " " + formatPct(winRate70_5Y) + " ", text_color=color.black, text_size=size.normal, bgcolor=winRateBgColor(winRate70_5Y))
    table.cell(statsTable, 4, 5, " " + formatPct(winRate80_1Y) + " ", text_color=color.black, text_size=size.normal, bgcolor=winRateBgColor(winRate80_1Y))
    table.cell(statsTable, 5, 5, " " + formatPct(winRate80_3Y) + " ", text_color=color.black, text_size=size.normal, bgcolor=winRateBgColor(winRate80_3Y))
    table.cell(statsTable, 6, 5, " " + formatPct(winRate80_5Y) + " ", text_color=color.black, text_size=size.normal, bgcolor=winRateBgColor(winRate80_5Y))
    
    // Row 6: Avg Return
    table.cell(statsTable, 0, 6, " Avg Return ", text_color=color.black, text_size=size.normal, bgcolor=color.new(color.gray, 80))
    table.cell(statsTable, 1, 6, " " + formatPct(avgRet70_1Y) + " ", text_color=color.black, text_size=size.normal, bgcolor=returnBgColor(avgRet70_1Y))
    table.cell(statsTable, 2, 6, " " + formatPct(avgRet70_3Y) + " ", text_color=color.black, text_size=size.normal, bgcolor=returnBgColor(avgRet70_3Y))
    table.cell(statsTable, 3, 6, " " + formatPct(avgRet70_5Y) + " ", text_color=color.black, text_size=size.normal, bgcolor=returnBgColor(avgRet70_5Y))
    table.cell(statsTable, 4, 6, " " + formatPct(avgRet80_1Y) + " ", text_color=color.black, text_size=size.normal, bgcolor=returnBgColor(avgRet80_1Y))
    table.cell(statsTable, 5, 6, " " + formatPct(avgRet80_3Y) + " ", text_color=color.black, text_size=size.normal, bgcolor=returnBgColor(avgRet80_3Y))
    table.cell(statsTable, 6, 6, " " + formatPct(avgRet80_5Y) + " ", text_color=color.black, text_size=size.normal, bgcolor=returnBgColor(avgRet80_5Y))

// ============================================
// COMPONENT BREAKDOWN TABLE
// ============================================

var table componentTable = table.new(position.middle_right, 2, 7, bgcolor=color.new(color.black, 85), border_width=1)

if barstate.islast and showComponents
    table.cell(componentTable, 0, 0, "COMPONENTS", text_color=color.white, text_size=size.small, bgcolor=color.new(color.purple, 60))
    table.cell(componentTable, 1, 0, "Score", text_color=color.white, text_size=size.small, bgcolor=color.new(color.purple, 60))
    
    table.cell(componentTable, 0, 1, "VIX (" + str.tostring(vixClose, "#.#") + ")", text_color=color.white, text_size=size.tiny)
    table.cell(componentTable, 1, 1, str.tostring(vixScore, "#") + "/30", text_color=color.purple, text_size=size.tiny)
    
    table.cell(componentTable, 0, 2, "Drawdown (" + str.tostring(drawdownPct, "#.#") + "%)", text_color=color.white, text_size=size.tiny)
    table.cell(componentTable, 1, 2, str.tostring(ddScore, "#") + "/30", text_color=color.orange, text_size=size.tiny)
    
    table.cell(componentTable, 0, 3, "RSI (" + str.tostring(rsi, "#.#") + ")", text_color=color.white, text_size=size.tiny)
    table.cell(componentTable, 1, 3, str.tostring(rsiScore, "#") + "/12", text_color=color.blue, text_size=size.tiny)
    
    table.cell(componentTable, 0, 4, "Bollinger (" + str.tostring(bbPctB, "#.##") + ")", text_color=color.white, text_size=size.tiny)
    table.cell(componentTable, 1, 4, str.tostring(bbScore, "#") + "/13", text_color=color.teal, text_size=size.tiny)
    
    vixStatus = vixDeclining ? "↓ Declining" : "↑ Rising"
    table.cell(componentTable, 0, 5, "VIX Timing (" + vixStatus + ")", text_color=color.white, text_size=size.tiny)
    table.cell(componentTable, 1, 5, str.tostring(timingScore, "#") + "/15", text_color=color.fuchsia, text_size=size.tiny)
    
    table.cell(componentTable, 0, 6, "TOTAL", text_color=color.white, text_size=size.small)
    table.cell(componentTable, 1, 6, str.tostring(compositeScore, "#") + "/100", text_color=scoreColor, text_size=size.small)

// ============================================
// ALERTS
// ============================================

// Note: alertcondition messages must be constant strings
// Use {{plot_0}} for score, {{ticker}} for symbol, {{time}} for timestamp

// Strong Buy Alert (80+)
alertcondition(strongBuyTrigger, 
     "STRONG BUY Signal (80+)", 
     "STRONG BUY - Score: {{plot_0}} on {{ticker}}")

// Buy Alert (70+)  
alertcondition(buyTrigger, 
     "BUY Signal (70+)", 
     "BUY OPPORTUNITY - Score: {{plot_0}} on {{ticker}}")

// Moderate Alert (60+)
alertcondition(moderateTrigger, 
     "Moderate Signal (60+)", 
     "MODERATE - Score: {{plot_0}} on {{ticker}}")

// Score crossing thresholds
alertcondition(ta.crossover(compositeScore, 80), 
     "Score Crossed 80", 
     "Score crossed above 80 on {{ticker}} - STRONG BUY zone")

alertcondition(ta.crossover(compositeScore, 70), 
     "Score Crossed 70", 
     "Score crossed above 70 on {{ticker}} - BUY zone")

alertcondition(ta.crossunder(compositeScore, 70), 
     "Score Dropped Below 70", 
     "Score dropped below 70 on {{ticker}} - Signal ended")

// Combined alert for any signal (useful for webhook)
alertcondition(strongBuyTrigger or buyTrigger, 
     "Any Buy Signal (70+)", 
     "BUY SIGNAL on {{ticker}} - Score: {{plot_0}}")

// ============================================
// NOTES
// ============================================
//
// STATISTICS TRACKING:
// - Stats are calculated in real-time as you scroll through history
// - "Completed" signals are those with enough bars after them to measure outcome
// - Pending signals (within outcomePeriod bars of current) aren't counted yet
// - Win/Loss is determined by whether price is higher after outcomePeriod bars
//
// ALERTS SETUP:
// 1. Click on the indicator name in the chart
// 2. Click the "..." menu and select "Add Alert"
// 3. Choose which alert condition you want
// 4. Set notification method (popup, email, webhook, etc.)
//
// RECOMMENDED ALERT SETTINGS:
// - For active trading: Enable "Any Buy Signal (70+)"
// - For high-conviction only: Enable just "STRONG BUY Signal"
// - For monitoring: Enable "Score Crossed 70" and "Score Crossed 80"
//
// ============================================
