//@version=5
// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © 2026 mfsz2015

indicator("Supertrend + Stochastic Strategy", overlay=true, max_labels_count=500)

// Supertrend Settings
atrPeriod = input.int(10, "ATR Period", minval=1, group="Supertrend")
atrMultiplier = input.float(3.0, "ATR Multiplier", minval=0.1, step=0.1, group="Supertrend")

// Stochastic Settings
kPeriod = input.int(14, "K Period", minval=1, group="Stochastic")
dPeriod = input.int(3, "D Period", minval=1, group="Stochastic")
kSmooth = input.int(3, "K Smoothing", minval=1, group="Stochastic")
oversoldLine = input.int(20, "Oversold Level", minval=0, maxval=100, group="Stochastic")
overboughtLine = input.int(80, "Overbought Level", minval=0, maxval=100, group="Stochastic")

// Signal Settings
showBuy = input.bool(true, "Show Buy Signals", group="Signals")
showSell = input.bool(true, "Show Sell Signals", group="Signals")
showLabels = input.bool(false, "Show Labels", group="Signals", tooltip="Enable to show text labels instead of circles")
professionalStyle = input.bool(true, "Professional Signal Style", group="Signals", tooltip="Enable for clean circular signals. Disable for classic triangle arrows")
minDistance = input.int(5, "Minimum Candles Between Signals", minval=1, maxval=20, group="Signals", tooltip="Reduces noise by spacing out signals")
strongOnly = input.bool(false, "Strong Signals Only", group="Signals", tooltip="Only show signals from oversold/overbought zones")

// Calculate Supertrend
atrValue = ta.atr(atrPeriod)
src = hl2

upperBand = src + (atrMultiplier * atrValue)
lowerBand = src - (atrMultiplier * atrValue)

var float trend = na
var int trendDir = na

prevTrend = nz(trend[1], lowerBand)
prevDir = nz(trendDir[1], 1)

if prevDir == 1
    trend := lowerBand > prevTrend ? lowerBand : prevTrend
else
    trend := upperBand < prevTrend ? upperBand : prevTrend

trendDir := close > trend ? 1 : -1

dirChanged = trendDir != trendDir[1]
bullTrend = trendDir == 1
bearTrend = trendDir == -1

trendColor = bullTrend ? color.new(color.green, 0) : color.new(color.red, 0)
plot(trend, "Supertrend", color=trendColor, linewidth=2)

// Calculate Stochastic
k = ta.sma(ta.stoch(close, high, low, kPeriod), kSmooth)
d = ta.sma(k, dPeriod)

kCrossUp = ta.crossover(k, d)
kCrossDown = ta.crossunder(k, d)

inOversold = k < oversoldLine
inOverbought = k > overboughtLine

// Signal Logic
justChanged = dirChanged and not dirChanged[1]
priceAboveTrend = bullTrend and close > trend
priceBelowTrend = bearTrend and close < trend

recentCrossUp = kCrossUp or kCrossUp[1] or kCrossUp[2]
recentCrossDown = kCrossDown or kCrossDown[1] or kCrossDown[2]

var int lastBuy = 0
var int lastSell = 0
canBuy = bar_index - lastBuy >= minDistance
canSell = bar_index - lastSell >= minDistance

buyCondition = justChanged and priceAboveTrend and recentCrossUp
buyFiltered = buyCondition and canBuy

strongBuy = buyFiltered and (inOversold[1] or inOversold[2] or inOversold[3])
normalBuy = buyFiltered and not strongBuy

buySignal = strongOnly ? strongBuy : (strongBuy or normalBuy)

sellCondition = justChanged and priceBelowTrend and recentCrossDown
sellFiltered = sellCondition and canSell

strongSell = sellFiltered and (inOverbought[1] or inOverbought[2] or inOverbought[3])
normalSell = sellFiltered and not strongSell

sellSignal = strongOnly ? strongSell : (strongSell or normalSell)

if buySignal
    lastBuy := bar_index
if sellSignal
    lastSell := bar_index

// Plot Signals
// Professional Style (Circles) - Only show when labels are disabled
plotshape(showBuy and strongBuy and professionalStyle and not showLabels, "Strong Buy Pro", shape.circle, location.belowbar, color=color.new(#00ff00, 0), size=size.small, text="●")
plotshape(showBuy and normalBuy and not strongOnly and professionalStyle and not showLabels, "Buy Pro", shape.circle, location.belowbar, color=color.new(#26a69a, 0), size=size.tiny, text="○")
plotshape(showSell and strongSell and professionalStyle and not showLabels, "Strong Sell Pro", shape.circle, location.abovebar, color=color.new(#ff0000, 0), size=size.small, text="●")
plotshape(showSell and normalSell and not strongOnly and professionalStyle and not showLabels, "Sell Pro", shape.circle, location.abovebar, color=color.new(#ef5350, 0), size=size.tiny, text="○")

// Classic Style (Triangles) - Only show when labels are disabled
plotshape(showBuy and strongBuy and not professionalStyle and not showLabels, "Strong Buy Classic", shape.triangleup, location.belowbar, color=color.new(color.green, 0), size=size.normal)
plotshape(showBuy and normalBuy and not strongOnly and not professionalStyle and not showLabels, "Buy Classic", shape.triangleup, location.belowbar, color=color.new(color.lime, 30), size=size.small)
plotshape(showSell and strongSell and not professionalStyle and not showLabels, "Strong Sell Classic", shape.triangledown, location.abovebar, color=color.new(color.red, 0), size=size.normal)
plotshape(showSell and normalSell and not strongOnly and not professionalStyle and not showLabels, "Sell Classic", shape.triangledown, location.abovebar, color=color.new(color.orange, 30), size=size.small)

// Labels
if showBuy and showLabels
    if strongBuy
        label.new(bar_index, low * 0.999, "STRONG BUY", style=label.style_label_up, color=color.new(#00c853, 0), textcolor=color.white, size=size.small, textalign=text.align_center)
    else if normalBuy and not strongOnly
        label.new(bar_index, low * 0.9995, "BUY", style=label.style_label_up, color=color.new(#26a69a, 10), textcolor=color.white, size=size.tiny, textalign=text.align_center)

if showSell and showLabels
    if strongSell
        label.new(bar_index, high * 1.001, "STRONG SELL", style=label.style_label_down, color=color.new(#d32f2f, 0), textcolor=color.white, size=size.small, textalign=text.align_center)
    else if normalSell and not strongOnly
        label.new(bar_index, high * 1.0005, "SELL", style=label.style_label_down, color=color.new(#ef5350, 10), textcolor=color.white, size=size.tiny, textalign=text.align_center)

// Alerts
alertcondition(strongBuy, title="Strong Buy Alert", message="Strong Buy: Supertrend turned bullish + Stochastic crossed up from oversold")
alertcondition(buySignal, title="Buy Alert", message="Buy Signal: Supertrend bullish + Stochastic crossed up")
alertcondition(strongSell, title="Strong Sell Alert", message="Strong Sell: Supertrend turned bearish + Stochastic crossed down from overbought")
alertcondition(sellSignal, title="Sell Alert", message="Sell Signal: Supertrend bearish + Stochastic crossed down")

// Dashboard
var table dashboard = table.new(position.top_right, 2, 5, border_width=1, border_color=color.gray, frame_color=color.gray, frame_width=1)

if barstate.islast
    table.cell(dashboard, 0, 0, "Indicator", bgcolor=color.new(color.blue, 80), text_color=color.white, text_size=size.small)
    table.cell(dashboard, 1, 0, "Status", bgcolor=color.new(color.blue, 80), text_color=color.white, text_size=size.small)
    
    table.cell(dashboard, 0, 1, "Supertrend", text_size=size.small)
    table.cell(dashboard, 1, 1, bullTrend ? "Bullish ▲" : "Bearish ▼", bgcolor=bullTrend ? color.new(color.green, 80) : color.new(color.red, 80), text_color=color.white, text_size=size.small)
    
    table.cell(dashboard, 0, 2, "Stochastic K", text_size=size.small)
    table.cell(dashboard, 1, 2, str.tostring(math.round(k, 2)), bgcolor=inOversold ? color.new(color.green, 80) : inOverbought ? color.new(color.red, 80) : color.new(color.gray, 80), text_color=color.white, text_size=size.small)
    
    table.cell(dashboard, 0, 3, "Crossover", text_size=size.small)
    crossStatus = k > d ? "K above D" : "K below D"
    table.cell(dashboard, 1, 3, crossStatus, bgcolor=k > d ? color.new(color.green, 80) : color.new(color.red, 80), text_color=color.white, text_size=size.small)
    
    table.cell(dashboard, 0, 4, "Signal", text_size=size.small)
    signalText = strongBuy ? "Strong Buy" : buySignal ? "Buy" : strongSell ? "Strong Sell" : sellSignal ? "Sell" : "Wait"
    signalColor = strongBuy or buySignal ? color.new(color.green, 70) : strongSell or sellSignal ? color.new(color.red, 70) : color.new(color.gray, 80)
    table.cell(dashboard, 1, 4, signalText, bgcolor=signalColor, text_color=color.white, text_size=size.small)
