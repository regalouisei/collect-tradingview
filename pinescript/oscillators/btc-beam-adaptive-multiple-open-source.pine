// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Rob_Maths

//@version=6
// -----------------------------------------------------------------------------
// SCRIPT: BTC - BEAM: Adaptive Multiple Oscillator | RM
// AUTHOR: Rob_Maths
// SHORT:  BEAM | RM
// METHODOLOGY: BEAM (Bitcoin Economics Adaptive Multiple) measures the 
//              logarithmic deviation of price from its 1400-day (4-year) mean.
//              It identifies macro cycle extremes using Halving-synced baselines.
// -----------------------------------------------------------------------------

indicator("BTC - BEAM: Adaptive Multiple | RM", shorttitle="BEAM | RM", overlay=false, precision=2)

// ==========================================
// 1. SETTINGS & CONFIGURATION
// ==========================================
grp_mod  = "Model Parameters"
lenMA    = input.int(1400, "MA Length (Days)", minval=200, group=grp_mod, tooltip="The '4-Year' anchor. 1400 days represents a full halving cycle baseline.")
scaleK   = input.float(2.5, "Scaling Factor (K)", step=0.1, group=grp_mod, tooltip="Canonical divisor to normalize the log-deviation into a standard 0-1 range.")

grp_vis  = "Visual & Regimes"
th_high  = input.float(1.0, "Overheated (Top)", step=0.05, group=grp_vis, tooltip="The logarithmic ceiling where Bitcoin is historically overextended.")
th_low   = input.float(0.1, "Undervalued (Floor)", step=0.05, group=grp_vis, tooltip="The logarithmic floor where Bitcoin is fundamentally cheap.")
showTabs = input.bool(true, "Show Status Table", group=grp_vis)

// ==========================================
// 2. DATA ENGINE (DAILY LOCK + GAP PROOF)
// ==========================================
f_calc_beam(_len, _k) =>
    // NA-robust price handling
    var float _seed = na
    if na(_seed) and not na(close)
        _seed := close
    _cFilled = nz(close, nz(close[1], _seed))
    
    // MA Logic: Warmup vs. Long SMA
    _nBars = ta.cum(1)
    _validRaw = not na(close)
    _sumC_warm = ta.cum(_validRaw ? close : 0.0)
    _sumN_warm = ta.cum(_validRaw ? 1.0 : 0.0)
    _ma_warm   = _sumN_warm > 0 ? _sumC_warm / _sumN_warm : na
    
    _closeNZ   = nz(close, 0.0)
    _validNum  = _validRaw ? 1.0 : 0.0
    _cumC      = ta.cum(_closeNZ)
    _cumN      = ta.cum(_validNum)
    _sumC_win  = _cumC - nz(_cumC[_len])
    _sumN_win  = _cumN - nz(_cumN[_len])
    _ma_long   = _sumN_win > 0 ? _sumC_win / _sumN_win : na
    
    _ma = _nBars < _len ? _ma_warm : _ma_long
    
    // The Core Formula: ln(Price / MA) / K
    _ratio = _ma != 0 ? _cFilled / _ma : 1.0
    _beam  = math.log(math.max(1e-9, _ratio)) / _k
    _beam

// Request Daily BEAM (Ensures consistency on Weekly/Monthly charts)
d_beam = request.security(syminfo.tickerid, "D", f_calc_beam(lenMA, scaleK))

// ==========================================
// 3. PLOTTING & ZONES
// ==========================================
// Rob Maths Palette
c_beam = color.rgb(217, 119, 6)   // RM Deep Orange
c_top  = color.rgb(220, 38, 38)    // Cycle Top Red
c_bot  = color.rgb(22, 163, 74)    // Cycle Floor Green

// Main Oscillator Plot
plot(d_beam, "BEAM Score", color=c_beam, linewidth=2)

// Threshold Lines
hline(th_high, "Ceiling", color=color.new(c_top, 50), linestyle=hline.style_dashed)
hline(th_low,  "Floor",   color=color.new(c_bot, 50), linestyle=hline.style_dashed)
hline(0.5,     "Midpoint", color=color.new(color.gray, 80))

// Regime Shading
bg_col = d_beam >= th_high ? color.new(c_top, 85) : d_beam <= th_low ? color.new(c_bot, 85) : na
bgcolor(bg_col, title="Regime Background")

// ==========================================
// 4. STATUS DASHBOARD
// ==========================================
var table info = table.new(position.bottom_right, 2, 2, border_width=1, border_color=color.new(color.gray, 70))
if barstate.islast and showTabs
    _status = d_beam >= th_high ? "OVERHEATED" : d_beam <= th_low ? "ACCUMULATION" : "NEUTRAL"
    _s_col  = d_beam >= th_high ? c_top : d_beam <= th_low ? c_bot : color.gray
    
    table.cell(info, 0, 0, "BEAM SCORE", bgcolor=color.gray, text_color=color.white, text_size=size.small)
    table.cell(info, 1, 0, str.tostring(d_beam, "#.2"), bgcolor=color.black, text_color=color.white, text_size=size.small)
    table.cell(info, 0, 1, "CYCLE REGIME", bgcolor=color.gray, text_color=color.white, text_size=size.small)
    table.cell(info, 1, 1, _status, bgcolor=color.black, text_color=_s_col, text_size=size.small)
