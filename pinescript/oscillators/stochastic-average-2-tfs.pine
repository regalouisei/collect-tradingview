//@version=6
indicator("Stoch (2 TFs)", overlay = false)

// INPUTS
kLen  = input.int(13, "%K Length")
kSmt  = input.int(3, "%K Smoothing")
dSmt  = input.int(3, "%D Smoothing")

tf1   = input.timeframe("30", "30")
k1color = input.color(color.new(color.blue,   100), "%K Color (1)")
d1color = input.color(color.new(color.aqua,   100), "%D Color (1)")

tf2   = input.timeframe("60", "60")
k2color = input.color(color.new(color.red,    100), "%K Color (2)")
d2color = input.color(color.new(color.orange, 100), "%D Color (2)")

// FUNCTION
stochCalc(tf) =>
    h = request.security(syminfo.tickerid, tf, ta.highest(high, kLen))
    l = request.security(syminfo.tickerid, tf, ta.lowest(low,  kLen))
    c = request.security(syminfo.tickerid, tf, close)
    k = ta.sma(100 * (c - l) / (h - l), kSmt)
    d = ta.sma(k, dSmt)
    [k, d]

// CALCS
[k1, d1] = stochCalc(tf1)
[k2, d2] = stochCalc(tf2)

// PLOTS (enable/disable via ternary)
plot(k1, "K1", k1color, 1)
plot(d1, "D1", d1color, 1)
plot(k2, "K2", k2color, 1)
plot(d2, "D2", d2color, 1)

var table tfInfo = table.new(position.top_right, 2, 1)

if barstate.islast
    table.cell(tfInfo, 0, 0, tf1)
    table.cell(tfInfo, 1, 0, tf2)

// BANDS
upperLevel  = 80.0
middleLevel = 50.0
lowerLevel  = 20.0

hline(upperLevel,  "Upper Band",  color.gray)
hline(middleLevel, "Middle Band", color.new(color.gray, 70))
hline(lowerLevel,  "Lower Band",  color.gray)

// BACKGROUND (light blue band between 80 and 20)
bgTop = plot(upperLevel, "Background Top", display = display.none)
bgBot = plot(lowerLevel, "Background Bottom", display = display.none)
fill(bgTop, bgBot, title = "Background", color = color.new(color.blue, 95))

// Sum then average of the 4 values
color = input.color(color.new(color.black, 0), "Average Color")
prevColor = input.color(color.new(color.red, 100), "Average Color")
sumKD = k1 + d1 + k2 + d2
prevSumKD = k1[1] + d1[1] + k2[1] + d2[1]
plot(sumKD / 4, "Sum KD", color, 1, plot.style_line)
plot(prevSumKD / 4, "Prev Sum KD", prevColor, 1, plot.style_line)
