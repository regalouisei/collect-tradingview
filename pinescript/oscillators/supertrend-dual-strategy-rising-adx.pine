//@version=6
strategy("Supertrend Dual Strategy + Rising ADX (Fixed)", overlay=true, process_orders_on_close=true)

// --- 1. 입력 변수 설정 (조정 제안 반영) ---
// [변경] Fast ATR 10 -> 12 (조금 더 여유있게)
atrPeriod1 = input.int(12, "Fast ATR Length (Exit)") 
factor1 = input.float(3.0, "Fast Factor")

// [변경] Slow Factor 4 -> 3.5 (조금 더 민감하게 진입)
atrPeriod2 = input.int(14, "Slow ATR Length (Entry)")
factor2 = input.float(3.5, "Slow Factor")

// ADX 설정
adxLen = input.int(14, "ADX Smoothing")
diLen = input.int(14, "DI Length")
adxThreshold = input.int(20, "ADX Threshold")

// --- 2. 지표 계산 ---
[stFast, dirFast] = ta.supertrend(factor1, atrPeriod1) 
[stSlow, dirSlow] = ta.supertrend(factor2, atrPeriod2) 
// dirSlow: -1이면 롱(초록), 1이면 숏(빨강)

// ADX 계산
dirmov(len) =>
    up = ta.change(high)
    down = -ta.change(low)
    plusDM = na(up) ? na : (up > down and up > 0 ? up : 0)
    minusDM = na(down) ? na : (down > up and down > 0 ? down : 0)
    truerange = ta.rma(ta.tr, len)
    plus = fixnan(100 * ta.rma(plusDM, len) / truerange)
    minus = fixnan(100 * ta.rma(minusDM, len) / truerange)
    [plus, minus]

[plus, minus] = dirmov(diLen)
sum = plus + minus
adx = 100 * ta.rma(math.abs(plus - minus) / (sum == 0 ? 1 : sum), adxLen)

// ADX 상승 조건
adxRising = adx > adx[1]

// --- 3. 매매 로직 (개선됨) ---

// [중요] '교차(Crossover)'가 아니라 '상태(State)'를 체크합니다.
// 이미 슈퍼트렌드가 롱 추세인 상태(close > stSlow)라도, 
// 현재 포지션이 없고(strategy.position_size == 0), ADX 조건이 맞으면 진입합니다.

// Long 진입: 가격이 Slow선 위에 있고 + ADX조건 만족 + 현재 포지션 없음
longCondition = (close > stSlow) and (close > stFast) and (strategy.position_size == 0)

// Short 진입: 가격이 Slow선 아래에 있고 + ADX조건 만족 + 현재 포지션 없음
shortCondition = (close < stSlow) and (close < stFast) and (strategy.position_size == 0)


// 청산 조건: Fast ST 방향 전환 (기존과 동일)
exitLong = ta.crossunder(close, stFast) 
exitShort = ta.crossover(close, stFast) 

// --- 4. 주문 실행 ---
if (longCondition)
    strategy.entry("Long", strategy.long)

if (shortCondition)
    strategy.entry("Short", strategy.short)

if (exitLong)
    strategy.close("Long", comment="Fast ST Exit")

if (exitShort)
    strategy.close("Short", comment="Fast ST Exit")

// --- 5. 차트 시각화 ---
plot(stFast, color=color.new(color.blue, 0), title="Fast ST (Exit)")
plot(stSlow, color=color.new(color.gray, 0), linewidth=2, title="Slow ST (Entry)")
bgcolor((adx >= adxThreshold) ? color.new(color.green, 90) : na, title="Valid Entry Zone")
