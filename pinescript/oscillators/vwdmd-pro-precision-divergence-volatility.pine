//@version=6
indicator("VWDMD Pro: Precision Divergence & Volatility", shorttitle="VWDMD_PRO", overlay=false, max_labels_count=500, precision=4)

// --- Settings ---
len          = input.int(14, "Momentum Period", minval=5)
src          = input.source(close, "Source Price")
vol_mult     = input.float(1.5, "Volume Sensitivity", minval=1.0)
lookback     = input.int(5, "Divergence Lookback", minval=2)
ema_len      = input.int(200, "Trend Filter (EMA)", minval=10)
bg_vizi      = input.int(92, "Background Transp.", minval=50, maxval=100)
show_lines   = input.bool(true, "Show Divergence Lines", tooltip="Draws lines connecting price and indicator pivots.")

// --- Core Logic ---
main_trend_ema   = ta.ema(close, ema_len)
is_bullish_trend = close > main_trend_ema

// Volume Weighted Dynamic Momentum (VWDMD)
vol_avg          = ta.sma(volume, len * 2)
relative_vol     = volume / math.max(vol_avg, 1e-9)
weighted_change  = ta.change(src) * (1 + math.log(relative_vol + 1) * vol_mult)
dmi              = ta.ema(weighted_change, len)

// Volatility Bands (Adaptive Thresholds)
std_dev     = ta.stdev(dmi, len * 2)
upper_band  = std_dev * 2.5
lower_band  = -std_dev * 2.5

// --- Aesthetics ---
trend_bg_color = is_bullish_trend ? color.new(color.green, bg_vizi) : color.new(color.red, bg_vizi)
bgcolor(trend_bg_color, title="Main Trend Context")

color c_up = dmi > 0 ? (dmi > dmi[1] ? #00ff00 : #006400) : (dmi < dmi[1] ? #ff0000 : #8b0000)
plot(dmi, "VWDMD Histogram", color=color.new(c_up, 20), style=plot.style_columns)
plot(upper_band, "Upper Volatility", color=color.new(color.red, 30))
plot(lower_band, "Lower Volatility", color=color.new(color.green, 30))
hline(0, "Equilibrium", color=color.new(color.gray, 60), linestyle=hline.style_dotted)

// OB/OS Markers
plotshape(dmi > upper_band, "Overbought", shape.triangledown, location.top, color.red, size=size.tiny)
plotshape(dmi < lower_band, "Oversold", shape.triangleup, location.bottom, color.green, size=size.tiny)

// --- Advanced Divergence Detection (Regular & Hidden) ---
ph = ta.pivothigh(dmi, lookback, lookback)
pl = ta.pivotlow(dmi, lookback, lookback)

var float last_pl_price = na
var float last_pl_dmi   = na
var int   last_pl_index = na
var float last_ph_price = na
var float last_ph_dmi   = na
var int   last_ph_index = na

// 1. BULLISH DIVERGENCES
if not na(pl)
    // Regular Bullish (Reversal)
    if low[lookback] < last_pl_price and pl > last_pl_dmi and is_bullish_trend
        label.new(bar_index[lookback], dmi[lookback], "BUY", color=color.green, textcolor=color.white, style=label.style_label_up, size=size.small)
        if show_lines
            line.new(last_pl_index, last_pl_dmi, bar_index[lookback], pl, color=color.green, width=1, style=line.style_dashed)
    
    // Hidden Bullish (Trend Continuation)
    if low[lookback] > last_pl_price and pl < last_pl_dmi and is_bullish_trend
        label.new(bar_index[lookback], dmi[lookback], "H-BUY", color=color.new(color.green, 30), textcolor=color.white, style=label.style_label_up, size=size.tiny)
    
    last_pl_price := low[lookback]
    last_pl_dmi   := pl
    last_pl_index := bar_index[lookback]

// 2. BEARISH DIVERGENCES
if not na(ph)
    // Regular Bearish (Reversal)
    if high[lookback] > last_ph_price and ph < last_ph_dmi and not is_bullish_trend
        label.new(bar_index[lookback], dmi[lookback], "SELL", color=color.red, textcolor=color.white, style=label.style_label_down, size=size.small)
        if show_lines
            line.new(last_ph_index, last_ph_dmi, bar_index[lookback], ph, color=color.red, width=1, style=line.style_dashed)
    
    // Hidden Bearish (Trend Continuation)
    if high[lookback] < last_ph_price and ph > last_ph_dmi and not is_bullish_trend
        label.new(bar_index[lookback], dmi[lookback], "H-SELL", color=color.new(color.red, 30), textcolor=color.white, style=label.style_label_down, size=size.tiny)
        
    last_ph_price := high[lookback]
    last_ph_dmi   := ph
    last_ph_index := bar_index[lookback]

// --- Dashboard ---
var table stats = table.new(position.top_right, 2, 2, frame_color=color.gray, frame_width=1)
if barstate.islast
    table.cell(stats, 0, 0, "TREND", bgcolor=color.black, text_color=color.white, text_size=size.small)
    table.cell(stats, 1, 0, is_bullish_trend ? "BULL" : "BEAR", bgcolor=is_bullish_trend ? color.green : color.red, text_color=color.white, text_size=size.small)
    table.cell(stats, 0, 1, "MOM.", bgcolor=color.black, text_color=color.white, text_size=size.small)
    table.cell(stats, 1, 1, dmi > 0 ? "POS" : "NEG", bgcolor=c_up, text_color=color.white, text_size=size.small)
