// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Gold Macro Projection Model - [BCT]
// © bigcitytom

// Main Indicator (Gold Macro Projection Model - [BCT])
// Complimentary Indicator (Gold Projection Divergence - [BCT])

//@version=6
indicator("Gold Projection Divergence", shorttitle="Gold Div", overlay=false, precision=2)

// ══════════════════════════════════════════════════════════════════════════════
// INPUTS
// ══════════════════════════════════════════════════════════════════════════════

// Lookback Periods
i_corrPeriod    = input.int(60, "Correlation Period", minval=20, maxval=252, group="Lookback Settings")
i_regPeriod     = input.int(120, "Regression Period", minval=30, maxval=504, group="Lookback Settings")
i_smoothPeriod  = input.int(10, "Smoothing Period", minval=1, maxval=50, group="Lookback Settings")

// Symbol Inputs
i_goldSym       = input.symbol("COMEX:GC1!", "Gold Symbol", group="Symbols")
i_silverSym     = input.symbol("COMEX:SI1!", "Silver Symbol", group="Symbols")
i_m2Sym         = input.symbol("ECONOMICS:USM2", "M2 Money Supply", group="Symbols")
i_dxySym        = input.symbol("TVC:DXY", "US Dollar Index", group="Symbols")
i_spxSym        = input.symbol("SP:SPX", "S&P 500", group="Symbols")
i_djiSym        = input.symbol("DJ:DJI", "Dow Jones", group="Symbols")
i_ndxSym        = input.symbol("NASDAQ:NDX", "Nasdaq 100", group="Symbols")
i_rutSym        = input.symbol("TVC:RUT", "Russell 2000", group="Symbols")
i_tipsSym       = input.symbol("AMEX:TIP", "TIPS ETF (Real Rates Proxy)", group="Symbols")

// Display Settings
i_showHistogram = input.bool(true, "Show Histogram", group="Display")
i_showZScore    = input.bool(true, "Show Z-Score Line", group="Display")
i_showPctDiv    = input.bool(false, "Show Percentage Divergence", group="Display")
i_showSignals   = input.bool(true, "Show Signal Markers", group="Display")
i_showTable     = input.bool(true, "Show Component Table", group="Display")

// ══════════════════════════════════════════════════════════════════════════════
// DATA FETCHING
// ══════════════════════════════════════════════════════════════════════════════

gold    = request.security(i_goldSym, "D", close, lookahead=barmerge.lookahead_off)
silver  = request.security(i_silverSym, "D", close, lookahead=barmerge.lookahead_off)
m2      = request.security(i_m2Sym, "D", close, lookahead=barmerge.lookahead_off)
dxy     = request.security(i_dxySym, "D", close, lookahead=barmerge.lookahead_off)
spx     = request.security(i_spxSym, "D", close, lookahead=barmerge.lookahead_off)
dji     = request.security(i_djiSym, "D", close, lookahead=barmerge.lookahead_off)
ndx     = request.security(i_ndxSym, "D", close, lookahead=barmerge.lookahead_off)
rut     = request.security(i_rutSym, "D", close, lookahead=barmerge.lookahead_off)
tips    = request.security(i_tipsSym, "D", close, lookahead=barmerge.lookahead_off)

// ══════════════════════════════════════════════════════════════════════════════
// HELPER FUNCTIONS
// ══════════════════════════════════════════════════════════════════════════════

zScore(src, len) =>
    mean = ta.sma(src, len)
    std = ta.stdev(src, len)
    std != 0 ? (src - mean) / std : 0

// ══════════════════════════════════════════════════════════════════════════════
// CORRELATION CALCULATIONS
// ══════════════════════════════════════════════════════════════════════════════

corrSilver  = ta.correlation(gold, silver, i_corrPeriod)
corrM2      = ta.correlation(gold, m2, i_corrPeriod)
corrDXY     = ta.correlation(gold, dxy, i_corrPeriod)
corrSPX     = ta.correlation(gold, spx, i_corrPeriod)
corrDJI     = ta.correlation(gold, dji, i_corrPeriod)
corrNDX     = ta.correlation(gold, ndx, i_corrPeriod)
corrRUT     = ta.correlation(gold, rut, i_corrPeriod)
corrTIPS    = ta.correlation(gold, tips, i_corrPeriod)
corrEquity  = (corrSPX + corrDJI + corrNDX + corrRUT) / 4

// Z-scores
zGold       = zScore(gold, i_regPeriod)
zSilver     = zScore(silver, i_regPeriod)
zM2         = zScore(m2, i_regPeriod)
zDXY        = zScore(dxy, i_regPeriod)
zTIPS       = zScore(tips, i_regPeriod)
zEquity     = (zScore(spx, i_regPeriod) + zScore(dji, i_regPeriod) + zScore(ndx, i_regPeriod) + zScore(rut, i_regPeriod)) / 4

// Weights
absSilverCorr   = math.abs(corrSilver)
absM2Corr       = math.abs(corrM2)
absDXYCorr      = math.abs(corrDXY)
absEquityCorr   = math.abs(corrEquity)
absTIPSCorr     = math.abs(corrTIPS)
totalAbsCorr    = absSilverCorr + absM2Corr + absDXYCorr + absEquityCorr + absTIPSCorr

finalSilverW    = totalAbsCorr != 0 ? absSilverCorr / totalAbsCorr : 0.20
finalM2W        = totalAbsCorr != 0 ? absM2Corr / totalAbsCorr : 0.20
finalDXYW       = totalAbsCorr != 0 ? absDXYCorr / totalAbsCorr : 0.20
finalEquityW    = totalAbsCorr != 0 ? absEquityCorr / totalAbsCorr : 0.20
finalTIPSW      = totalAbsCorr != 0 ? absTIPSCorr / totalAbsCorr : 0.20

// ══════════════════════════════════════════════════════════════════════════════
// PROJECTION CALCULATION
// ══════════════════════════════════════════════════════════════════════════════

dxySign     = corrDXY < 0 ? -1 : 1
tipsSign    = corrTIPS > 0 ? 1 : -1

compositZ = (zSilver * finalSilverW * math.sign(corrSilver)) +  (zM2 * finalM2W * math.sign(corrM2)) + (zDXY * finalDXYW * dxySign) + (zEquity * finalEquityW * math.sign(corrEquity)) + (zTIPS * finalTIPSW * tipsSign)

goldMean    = ta.sma(gold, i_regPeriod)
goldStd     = ta.stdev(gold, i_regPeriod)
projectedZ  = goldMean + compositZ * goldStd

// Silver/Gold ratio projection
silverGoldRatio = silver / gold
avgSGRatio      = ta.sma(silverGoldRatio, i_regPeriod)
projectedSGR    = avgSGRatio != 0 ? silver / avgSGRatio : gold

// M2 projection
goldM2Ratio     = gold / (m2 / 100)
avgGM2Ratio     = ta.sma(goldM2Ratio, i_regPeriod)
projectedM2     = (m2 / 100) * avgGM2Ratio

// Combined projection
combinedProjection = (projectedZ * 0.50) + (projectedSGR * 0.35) + (projectedM2 * 0.15)
smoothedProjection = ta.ema(combinedProjection, i_smoothPeriod)

// ══════════════════════════════════════════════════════════════════════════════
// DIVERGENCE METRICS
// ══════════════════════════════════════════════════════════════════════════════

divergence      = gold - smoothedProjection
divergencePct   = smoothedProjection != 0 ? (divergence / smoothedProjection) * 100 : 0
divergenceStd   = ta.stdev(divergence, i_regPeriod)
divergenceZ     = divergenceStd != 0 ? divergence / divergenceStd : 0

// Smoothed versions
smoothDivZ      = ta.ema(divergenceZ, i_smoothPeriod)
smoothDivPct    = ta.ema(divergencePct, i_smoothPeriod)

// Individual component divergences (for breakdown)
silverDiv   = zGold - (zSilver * math.sign(corrSilver))
m2Div       = zGold - (zM2 * math.sign(corrM2))
dxyDiv      = zGold - (zDXY * dxySign)
equityDiv   = zGold - (zEquity * math.sign(corrEquity))
tipsDiv     = zGold - (zTIPS * tipsSign)

// ══════════════════════════════════════════════════════════════════════════════
// SIGNAL CONDITIONS
// ══════════════════════════════════════════════════════════════════════════════

extremeUnder    = smoothDivZ < -2
extremeOver     = smoothDivZ > 2
moderateUnder   = smoothDivZ < -1 and smoothDivZ >= -2
moderateOver    = smoothDivZ > 1 and smoothDivZ <= 2

// Crossover signals
crossUnder2     = ta.crossunder(smoothDivZ, -2)
crossOver2      = ta.crossover(smoothDivZ, 2)
crossZeroUp     = ta.crossover(smoothDivZ, 0)
crossZeroDown   = ta.crossunder(smoothDivZ, 0)

// ══════════════════════════════════════════════════════════════════════════════
// PLOTTING
// ══════════════════════════════════════════════════════════════════════════════

// Zero line
hline(0, "Zero", color=color.gray, linestyle=hline.style_solid, linewidth=1)

// Standard deviation bands
hline(2, "+2σ", color=color.red, linestyle=hline.style_dashed, linewidth=1)
hline(-2, "-2σ", color=color.green, linestyle=hline.style_dashed, linewidth=1)
hline(1, "+1σ", color=color.new(color.red, 50), linestyle=hline.style_dotted, linewidth=1)
hline(-1, "-1σ", color=color.new(color.green, 50), linestyle=hline.style_dotted, linewidth=1)

// Histogram
histColor = smoothDivZ > 2 ? color.new(color.red, 20) : smoothDivZ > 1 ? color.new(color.orange, 30) : smoothDivZ > 0 ? color.new(color.orange, 60) :smoothDivZ > -1 ? color.new(color.green, 60) : smoothDivZ > -2 ? color.new(color.green, 30) : color.new(color.lime, 20)

plot(i_showHistogram ? smoothDivZ : na, "Divergence Z Histogram", color=histColor, style=plot.style_columns, linewidth=4)

// Z-Score line
plot(i_showZScore ? smoothDivZ : na, "Divergence Z-Score", color=color.yellow, linewidth=2)

// Percentage divergence (secondary)
plot(i_showPctDiv ? smoothDivPct : na, "Divergence %", color=color.aqua, linewidth=1, style=plot.style_line)

// Signal markers
plotshape(i_showSignals and crossUnder2 ? smoothDivZ : na, "Extreme Undervalue", shape.triangleup, location.absolute, color.lime, size=size.small)
plotshape(i_showSignals and crossOver2 ? smoothDivZ : na, "Extreme Overvalue", shape.triangledown, location.absolute, color.red, size=size.small)
plotshape(i_showSignals and crossZeroUp ? 0 : na, "Cross Zero Up", shape.circle, location.absolute, color.green, size=size.tiny)
plotshape(i_showSignals and crossZeroDown ? 0 : na, "Cross Zero Down", shape.circle, location.absolute, color.red, size=size.tiny)

// ══════════════════════════════════════════════════════════════════════════════
// COMPONENT TABLE
// ══════════════════════════════════════════════════════════════════════════════

if i_showTable and barstate.islast
    var table compTable = table.new(position.top_right, 3, 8, bgcolor=color.new(color.black, 80), border_width=1)
    
    // Header
    table.cell(compTable, 0, 0, "DIVERGENCE", text_color=color.yellow, text_size=size.small)
    table.cell(compTable, 1, 0, "BREAKDOWN", text_color=color.yellow, text_size=size.small)
    table.cell(compTable, 2, 0, "", text_color=color.yellow, text_size=size.small)
    
    // Column headers
    table.cell(compTable, 0, 1, "Factor", text_color=color.gray, text_size=size.tiny)
    table.cell(compTable, 1, 1, "Div", text_color=color.gray, text_size=size.tiny)
    table.cell(compTable, 2, 1, "Signal", text_color=color.gray, text_size=size.tiny)
    
    // Silver divergence
    silverDivColor = silverDiv > 0 ? color.red : color.green
    silverSignal = silverDiv > 1 ? "Over" : silverDiv < -1 ? "Under" : "Fair"
    table.cell(compTable, 0, 2, "Silver", text_color=color.white, text_size=size.tiny)
    table.cell(compTable, 1, 2, str.tostring(silverDiv, "#.##"), text_color=silverDivColor, text_size=size.tiny)
    table.cell(compTable, 2, 2, silverSignal, text_color=silverDivColor, text_size=size.tiny)
    
    // M2 divergence
    m2DivColor = m2Div > 0 ? color.red : color.green
    m2Signal = m2Div > 1 ? "Over" : m2Div < -1 ? "Under" : "Fair"
    table.cell(compTable, 0, 3, "M2", text_color=color.white, text_size=size.tiny)
    table.cell(compTable, 1, 3, str.tostring(m2Div, "#.##"), text_color=m2DivColor, text_size=size.tiny)
    table.cell(compTable, 2, 3, m2Signal, text_color=m2DivColor, text_size=size.tiny)
    
    // DXY divergence
    dxyDivColor = dxyDiv > 0 ? color.red : color.green
    dxySignal = dxyDiv > 1 ? "Over" : dxyDiv < -1 ? "Under" : "Fair"
    table.cell(compTable, 0, 4, "DXY", text_color=color.white, text_size=size.tiny)
    table.cell(compTable, 1, 4, str.tostring(dxyDiv, "#.##"), text_color=dxyDivColor, text_size=size.tiny)
    table.cell(compTable, 2, 4, dxySignal, text_color=dxyDivColor, text_size=size.tiny)
    
    // Equity divergence
    eqDivColor = equityDiv > 0 ? color.red : color.green
    eqSignal = equityDiv > 1 ? "Over" : equityDiv < -1 ? "Under" : "Fair"
    table.cell(compTable, 0, 5, "Equity", text_color=color.white, text_size=size.tiny)
    table.cell(compTable, 1, 5, str.tostring(equityDiv, "#.##"), text_color=eqDivColor, text_size=size.tiny)
    table.cell(compTable, 2, 5, eqSignal, text_color=eqDivColor, text_size=size.tiny)
    
    // TIPS divergence
    tipsDivColor = tipsDiv > 0 ? color.red : color.green
    tipsSignal = tipsDiv > 1 ? "Over" : tipsDiv < -1 ? "Under" : "Fair"
    table.cell(compTable, 0, 6, "TIPS", text_color=color.white, text_size=size.tiny)
    table.cell(compTable, 1, 6, str.tostring(tipsDiv, "#.##"), text_color=tipsDivColor, text_size=size.tiny)
    table.cell(compTable, 2, 6, tipsSignal, text_color=tipsDivColor, text_size=size.tiny)
    
    // Overall
    overallColor = smoothDivZ > 2 ? color.red : smoothDivZ > 1 ? color.orange : smoothDivZ < -2 ? color.lime : smoothDivZ < -1 ? color.green : color.gray
    overallText = smoothDivZ > 2 ? "Sell" : smoothDivZ > 1 ? "Reduce" : smoothDivZ < -2 ? "Strong Buy" : smoothDivZ < -1 ? "Accumulate" : "Neutral"
    table.cell(compTable, 0, 7, "OVERALL:", text_color=color.white, text_size=size.small)
    table.cell(compTable, 1, 7, overallText, text_color=overallColor, text_size=size.small)
    table.cell(compTable, 2, 7, "Z: " + str.tostring(smoothDivZ, "#.##"), text_color=overallColor, text_size=size.small)

// ══════════════════════════════════════════════════════════════════════════════
// BACKGROUND COLORING
// ══════════════════════════════════════════════════════════════════════════════

bgcolor(smoothDivZ > 2 ? color.new(color.red, 90) : smoothDivZ < -2 ? color.new(color.green, 90) : na)

// ══════════════════════════════════════════════════════════════════════════════
// ALERTS
// ══════════════════════════════════════════════════════════════════════════════

alertcondition(crossUnder2, "Extreme Undervaluation", "Gold divergence Z-score crossed below -2 - potential strong buy")
alertcondition(crossOver2, "Extreme Overvaluation", "Gold divergence Z-score crossed above +2 - potential strong sell")
alertcondition(crossZeroUp, "Divergence Turned Positive", "Gold now trading above projected value")
alertcondition(crossZeroDown, "Divergence Turned Negative", "Gold now trading below projected value")
alertcondition(ta.crossunder(smoothDivZ, -1), "Moderate Undervaluation", "Gold divergence Z-score crossed below -1")
alertcondition(ta.crossover(smoothDivZ, 1), "Moderate Overvaluation", "Gold divergence Z-score crossed above +1")
