// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Original RVI divergence concept by madoqa.
// Adapted to Pine Script v6 by Carlos Mauricio Vizcarra with enhanced visualization, configurable pivot ranges, and user-defined SMA filter.

//@version=6
indicator("RVI Divergence Detector with Custom SMA Filter (v6)", shorttitle="DiverRVI+SMA", format=format.price, precision=4)

// =============================================================================
// INPUTS
// =============================================================================
lbR = input.int(5, "Pivot Lookback Right")
lbL = input.int(5, "Pivot Lookback Left")
rangeUpper = input.int(60, "Max of Lookback Range")
rangeLower = input.int(5, "Min of Lookback Range")
plotBull = input.bool(true, "Plot Bullish")
plotHiddenBull = input.bool(true, "Plot Hidden Bullish")
plotBear = input.bool(true, "Plot Bearish")
plotHiddenBear = input.bool(true, "Plot Hidden Bearish")

// Nueva entrada: perÃ­odo de la SMA del RVI
smaPeriod = input.int(14, "RVI SMA Period", minval=1, maxval=200)
showSMA = input.bool(true, "Show RVI SMA")

// =============================================================================
// RVI CALCULATION (based on madoqa's implementation)
// =============================================================================
p = 10

CO = close - open
HL = high - low

value1 = (CO + 2 * CO[1] + 2 * CO[2] + CO[3]) / 6.0
value2 = (HL + 2 * HL[1] + 2 * HL[2] + HL[3]) / 6.0

num = math.sum(value1, p)
denom = math.sum(value2, p)

RVI = denom != 0 ? num / denom : 0.0
RVIsig = (RVI + 2 * RVI[1] + 2 * RVI[2] + RVI[3]) / 6.0

// =============================================================================
// ADD CUSTOMIZABLE SMA OF RVI
// =============================================================================
rviSMA = ta.sma(RVI, smaPeriod)

// =============================================================================
// PLOTTING
// =============================================================================
hline(0, "Zero Line", color=color.gray)

plot(RVI, title="RVI", color=color.white, linewidth=2)
plot(RVIsig, title="Signal", color=color.red, linewidth=1)

// Plot SMA only if enabled
plot(showSMA ? rviSMA : na, title="RVI SMA", color=color.new(color.gray, 0), linewidth=1, style=plot.style_line)

osc = RVI

// =============================================================================
// PIVOT DETECTION
// =============================================================================
plFound = not na(ta.pivotlow(osc, lbL, lbR))
phFound = not na(ta.pivothigh(osc, lbL, lbR))

_inRange(cond) =>
    bars = ta.barssince(cond[1])
    not na(bars) and rangeLower <= bars and bars <= rangeUpper

// =============================================================================
// DIVERGENCE CONDITIONS
// =============================================================================

// Regular Bullish
oscHL = osc[lbR] > ta.valuewhen(plFound, osc[lbR], 1) and _inRange(plFound)
priceLL = low[lbR] < ta.valuewhen(plFound, low[lbR], 1)
bullCond = plotBull and priceLL and oscHL and plFound

// Hidden Bullish
oscLL = osc[lbR] < ta.valuewhen(plFound, osc[lbR], 1) and _inRange(plFound)
priceHL = low[lbR] > ta.valuewhen(plFound, low[lbR], 1)
hiddenBullCond = plotHiddenBull and priceHL and oscLL and plFound

// Regular Bearish
oscLH = osc[lbR] < ta.valuewhen(phFound, osc[lbR], 1) and _inRange(phFound)
priceHH = high[lbR] > ta.valuewhen(phFound, high[lbR], 1)
bearCond = plotBear and priceHH and oscLH and phFound

// Hidden Bearish
oscHH = osc[lbR] > ta.valuewhen(phFound, osc[lbR], 1) and _inRange(phFound)
priceLH = high[lbR] < ta.valuewhen(phFound, high[lbR], 1)
hiddenBearCond = plotHiddenBear and priceLH and oscHH and phFound

// =============================================================================
// PLOT PIVOTS AND LABELS
// =============================================================================
noneColor = color.new(color.white, 100)

plot(plFound ? osc[lbR] : na, offset=-lbR, title="Bullish Pivot", linewidth=2, color=(bullCond or hiddenBullCond) ? color.navy : noneColor)
plot(phFound ? osc[lbR] : na, offset=-lbR, title="Bearish Pivot", linewidth=2, color=(bearCond or hiddenBearCond) ? color.red : noneColor)

plotshape(bullCond ? osc[lbR] : na, offset=-lbR, text="D", style=shape.labelup, location=location.absolute, color=color.navy, textcolor=color.white, size=size.small)
plotshape(hiddenBullCond ? osc[lbR] : na, offset=-lbR, text="H", style=shape.labelup, location=location.absolute, color=color.navy, textcolor=color.white, size=size.small)
plotshape(bearCond ? osc[lbR] : na, offset=-lbR, text="D", style=shape.labeldown, location=location.absolute, color=color.red, textcolor=color.white, size=size.small)
plotshape(hiddenBearCond ? osc[lbR] : na, offset=-lbR, text="H", style=shape.labeldown, location=location.absolute, color=color.red, textcolor=color.white, size=size.small)

// =============================================================================
// DRAW DIVERGENCE LINES
// =============================================================================
var float lastPlRvi = na
var int lastPlBar = na
var float lastPhRvi = na
var int lastPhBar = na

if plFound
    lastPlRvi := osc[lbR]
    lastPlBar := bar_index - lbR

if phFound
    lastPhRvi := osc[lbR]
    lastPhBar := bar_index - lbR

if bullCond or hiddenBullCond
    line.new(x1=lastPlBar[1], y1=lastPlRvi[1], x2=bar_index - lbR, y2=osc[lbR], color=color.green, width=1)

if bearCond or hiddenBearCond
    line.new(x1=lastPhBar[1], y1=lastPhRvi[1], x2=bar_index - lbR, y2=osc[lbR], color=color.red, width=1)

// =============================================================================
// ALERT CONDITIONS
// =============================================================================
alertcondition(bullCond, "Regular Bullish Divergence", "RVI: Regular bullish divergence detected")
alertcondition(hiddenBullCond, "Hidden Bullish Divergence", "RVI: Hidden bullish divergence detected")
alertcondition(bearCond, "Regular Bearish Divergence", "RVI: Regular bearish divergence detected")
alertcondition(hiddenBearCond, "Hidden Bearish Divergence", "RVI: Hidden bearish divergence detected")
