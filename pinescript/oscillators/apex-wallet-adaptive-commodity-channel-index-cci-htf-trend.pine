//@version=5
indicator("www.Apex-Wallet.fr - Commodity Channel Index (CCI)", format=format.price, precision=2)

// ──────────────────────────────────────────────────────────────────────────────
// Inputs
// ──────────────────────────────────────────────────────────────────────────────
mode = input.string("Day Trading", "Mode de trading", options=["Scalping", "Day Trading", "Swing"], group="Général")

showMarketTrend = input.bool(false, "Afficher la tendance du Marché (couleur courbe)", group="Tendance Marché")
useHTFBackground = input.bool(false, "Tendance en Higher Timeframe (fond)", group="Tendance HTF")
trendTF = input.timeframe("60", "TF Tendance (si HTF activée)", group="Tendance HTF")

// Couleurs (prises du script TDI Apex)
colUp = color.rgb(0, 200, 0)
colDn = color.rgb(220, 0, 0)
colNeutral = color.gray

// Fond HTF à 25% de transparence (0 opaque → 100 invisible)
bgTransp = 95

// ──────────────────────────────────────────────────────────────────────────────
// Presets
// ──────────────────────────────────────────────────────────────────────────────
cciLen = 20
cciSignalLen = 9
trendLen = 100
if mode == "Scalping"
    cciLen := 14
    cciSignalLen := 6
    trendLen := 50
else if mode == "Swing"
    cciLen := 34
    cciSignalLen := 14
    trendLen := 200

// ──────────────────────────────────────────────────────────────────────────────
// CCI
// ──────────────────────────────────────────────────────────────────────────────
src = hlc3
basis = ta.sma(src, cciLen)
cci = (src - basis) / (0.015 * ta.dev(src, cciLen))
cciSignal = ta.ema(cci, cciSignalLen)

// Bandes CCI (style proche original)
bandColor = #787B86
hU = hline(100, title="Upper Band", color=bandColor, linestyle=hline.style_dashed)
hM = hline(0, title="Middle Band", color=color.new(bandColor, 50))
hL = hline(-100, title="Lower Band", color=bandColor, linestyle=hline.style_dashed)
fill(hU, hL, title="Background", color=color.rgb(33, 150, 243, 90))

// ──────────────────────────────────────────────────────────────────────────────
// Tendance marché (TF graphique) => couleur de la courbe signal
// ──────────────────────────────────────────────────────────────────────────────
emaMkt = ta.ema(close, trendLen)
mktUp = showMarketTrend and (close > emaMkt) and (emaMkt > emaMkt[1])
mktDn = showMarketTrend and (close < emaMkt) and (emaMkt < emaMkt[1])

signalColor = showMarketTrend ? (mktUp ? colUp : mktDn ? colDn : colNeutral) : color.new(color.yellow, 0)
signalWidth = showMarketTrend ? 2 : 1  // si tendance marché OFF -> épaisseur -1

// ──────────────────────────────────────────────────────────────────────────────
// Tendance HTF => fond (bgcolor) à 25% de transparence
// ──────────────────────────────────────────────────────────────────────────────
useHTF = useHTFBackground and (trendTF != "")

emaHTF = useHTF ? request.security(syminfo.tickerid, trendTF, ta.ema(close, trendLen), barmerge.gaps_off, barmerge.lookahead_off) : na
emaHTFPrev = useHTF ? request.security(syminfo.tickerid, trendTF, ta.ema(close, trendLen)[1], barmerge.gaps_off, barmerge.lookahead_off) : na
closeHTF = useHTF ? request.security(syminfo.tickerid, trendTF, close, barmerge.gaps_off, barmerge.lookahead_off) : na

htfUp = useHTF and (closeHTF > emaHTF) and (emaHTF > emaHTFPrev)
htfDn = useHTF and (closeHTF < emaHTF) and (emaHTF < emaHTFPrev)

bgcolor(useHTF ? (htfUp ? color.new(colUp, bgTransp) : htfDn ? color.new(colDn, bgTransp) : color.new(colNeutral, bgTransp)) : na)

// ──────────────────────────────────────────────────────────────────────────────
// Plots
// ──────────────────────────────────────────────────────────────────────────────
plot(cci, title="CCI", linewidth=1, color=color.new(#2962FF, 0))
plot(cciSignal, title="CCI (Signal)", linewidth=signalWidth, color=signalColor)
