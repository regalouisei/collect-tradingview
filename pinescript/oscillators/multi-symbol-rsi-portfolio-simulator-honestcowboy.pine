//@version=6
indicator('Multi-Symbol RSI Portfolio Simulator [Honestcowboy]', overlay = false, precision = 2, max_labels_count = 500)

// ==========================================
// --- Global Strategy Settings ---
// ==========================================
initial_capital = input.float(1000.0, 'Initial Capital ($)', group = 'Global Settings')
stake_per_pair = input.float(100.0, 'Fixed Stake per Pair ($)', group = 'Global Settings')
max_trades = input.int(5, 'Max Simultaneous Trades', minval = 1, maxval = 40, group = 'Risk Management')
rsi_len = input.int(14, 'RSI Length', group = 'Global Settings')

entry_ob = input.int(80, 'Short Entry (RSI >)', group = 'Thresholds')
exit_ob = input.int(70, 'Short Exit (RSI <)', group = 'Thresholds')
entry_os = input.int(20, 'Long Entry (RSI <)', group = 'Thresholds')
exit_os = input.int(30, 'Long Exit (RSI >)', group = 'Thresholds')
global_mode = input.string('Mean Revert', 'Global Mode', options = ['Trend', 'Mean Revert'], group = 'Global Settings')

// ==========================================
// --- UI & Helper Functions ---
// ==========================================
//get_contrast_color(bg) => color.luminance(bg) > 0.5 ? color.black : color.white

// ==========================================
// --- Symbols & OPTIMIZED Global Data Extraction ---
// ==========================================
// Using Tuples to get RSI, Open, and Close in ONE call per symbol (40 total calls)
f_get_data(s) =>
    request.security(s, timeframe.period, [ta.rsi(close, rsi_len), open, close])

s01 = input.symbol('EURUSD', '01')
s02 = input.symbol('GBPUSD', '02')
s03 = input.symbol('USDJPY', '03')
s04 = input.symbol('AUDUSD', '04')
s05 = input.symbol('USDCAD', '05')
s06 = input.symbol('USDCHF', '06')
s07 = input.symbol('NZDUSD', '07')
s08 = input.symbol('EURGBP', '08')
s09 = input.symbol('EURJPY', '09')
s10 = input.symbol('GBPJPY', '10')
s11 = input.symbol('AUDJPY', '11')
s12 = input.symbol('EURCHF', '12')
s13 = input.symbol('EURAUD', '13')
s14 = input.symbol('GBPAUD', '14')
s15 = input.symbol('CADJPY', '15')
s16 = input.symbol('GBPCAD', '16')
s17 = input.symbol('AUDCAD', '17')
s18 = input.symbol('NZDJPY', '18')
s19 = input.symbol('AUDNZD', '19')
s20 = input.symbol('GBPCHF', '20')
s21 = input.symbol('EURCAD', '21')
s22 = input.symbol('CHFJPY', '22')
s23 = input.symbol('GBPNZD', '23')
s24 = input.symbol('EURNZD', '24')
s25 = input.symbol('CADCHF', '25')
s26 = input.symbol('NZDCAD', '26')
s27 = input.symbol('NZDCHF', '27')
s28 = input.symbol('AUDCHF', '28')
s29 = input.symbol('USDSGD', '29')
s30 = input.symbol('USDHKD', '30')
s31 = input.symbol('USDMXN', '31')
s32 = input.symbol('USDZAR', '32')
s33 = input.symbol('USDTRY', '33')
s34 = input.symbol('USDSEK', '34')
s35 = input.symbol('USDNOK', '35')
s36 = input.symbol('USDPLN', '36')
s37 = input.symbol('USDCZK', '37')
s38 = input.symbol('USDHUF', '38')
s39 = input.symbol('USDILS', '39')
s40 = input.symbol('XAUUSD', '40')

[rsi01, o01, c01] = f_get_data(s01)
[rsi02, o02, c02] = f_get_data(s02)
[rsi03, o03, c03] = f_get_data(s03)
[rsi04, o04, c04] = f_get_data(s04)
[rsi05, o05, c05] = f_get_data(s05)
[rsi06, o06, c06] = f_get_data(s06)
[rsi07, o07, c07] = f_get_data(s07)
[rsi08, o08, c08] = f_get_data(s08)
[rsi09, o09, c09] = f_get_data(s09)
[rsi10, o10, c10] = f_get_data(s10)
[rsi11, o11, c11] = f_get_data(s11)
[rsi12, o12, c12] = f_get_data(s12)
[rsi13, o13, c13] = f_get_data(s13)
[rsi14, o14, c14] = f_get_data(s14)
[rsi15, o15, c15] = f_get_data(s15)
[rsi16, o16, c16] = f_get_data(s16)
[rsi17, o17, c17] = f_get_data(s17)
[rsi18, o18, c18] = f_get_data(s18)
[rsi19, o19, c19] = f_get_data(s19)
[rsi20, o20, c20] = f_get_data(s20)
[rsi21, o21, c21] = f_get_data(s21)
[rsi22, o22, c22] = f_get_data(s22)
[rsi23, o23, c23] = f_get_data(s23)
[rsi24, o24, c24] = f_get_data(s24)
[rsi25, o25, c25] = f_get_data(s25)
[rsi26, o26, c26] = f_get_data(s26)
[rsi27, o27, c27] = f_get_data(s27)
[rsi28, o28, c28] = f_get_data(s28)
[rsi29, o29, c29] = f_get_data(s29)
[rsi30, o30, c30] = f_get_data(s30)
[rsi31, o31, c31] = f_get_data(s31)
[rsi32, o32, c32] = f_get_data(s32)
[rsi33, o33, c33] = f_get_data(s33)
[rsi34, o34, c34] = f_get_data(s34)
[rsi35, o35, c35] = f_get_data(s35)
[rsi36, o36, c36] = f_get_data(s36)
[rsi37, o37, c37] = f_get_data(s37)
[rsi38, o38, c38] = f_get_data(s38)
[rsi39, o39, c39] = f_get_data(s39)
[rsi40, o40, c40] = f_get_data(s40)

// ==========================================
// --- Core Strategy Engine ---
// ==========================================
var int st01 = 0
var int st02 = 0
var int st03 = 0
var int st04 = 0
var int st05 = 0
var int st06 = 0
var int st07 = 0
var int st08 = 0
var int st09 = 0
var int st10 = 0
var int st11 = 0
var int st12 = 0
var int st13 = 0
var int st14 = 0
var int st15 = 0
var int st16 = 0
var int st17 = 0
var int st18 = 0
var int st19 = 0
var int st20 = 0
var int st21 = 0
var int st22 = 0
var int st23 = 0
var int st24 = 0
var int st25 = 0
var int st26 = 0
var int st27 = 0
var int st28 = 0
var int st29 = 0
var int st30 = 0
var int st31 = 0
var int st32 = 0
var int st33 = 0
var int st34 = 0
var int st35 = 0
var int st36 = 0
var int st37 = 0
var int st38 = 0
var int st39 = 0
var int st40 = 0

f_process(sym, curr_st, slots, pnl, rsi, o, c, mode, ob_e, ob_x, os_e, os_x, stake) =>
    new_st = curr_st
    float new_pnl = pnl
    new_slots = slots

    if not na(rsi[1])
        if curr_st == 0 // Neutral
            if slots > 0
                if rsi[1] < os_e
                    new_st := mode == 'Mean Revert' ? 1 : -1
                    new_slots := slots - 1
                    new_slots
                else if rsi[1] > ob_e
                    new_st := mode == 'Mean Revert' ? -1 : 1
                    new_slots := slots - 1
                    new_slots
        else // In Position
            pnl_tick = (curr_st == 1 ? (c - o) / o : (o - c) / o) * stake
            new_pnl := pnl + pnl_tick

            bool exit = false
            if curr_st == 1 and (mode == 'Mean Revert' and rsi[1] > os_x or mode == 'Trend' and rsi[1] < os_e)
                exit := true
                exit
            if curr_st == -1 and (mode == 'Mean Revert' and rsi[1] < ob_x or mode == 'Trend' and rsi[1] > ob_e)
                exit := true
                exit

            if exit
                new_st := 0
                new_slots := slots + 1
                new_slots

    [new_st, new_slots, new_pnl]

// The Sequential Chain
[nst01, s01_L, p01] = f_process(s01, st01, max_trades, 0.0, rsi01, o01, c01, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st01 := nst01
[nst02, s02_L, p02] = f_process(s02, st02, s01_L, p01, rsi02, o02, c02, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st02 := nst02
[nst03, s03_L, p03] = f_process(s03, st03, s02_L, p02, rsi03, o03, c03, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st03 := nst03
[nst04, s04_L, p04] = f_process(s04, st04, s03_L, p03, rsi04, o04, c04, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st04 := nst04
[nst05, s05_L, p05] = f_process(s05, st05, s04_L, p04, rsi05, o05, c05, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st05 := nst05
[nst06, s06_L, p06] = f_process(s06, st06, s05_L, p05, rsi06, o06, c06, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st06 := nst06
[nst07, s07_L, p07] = f_process(s07, st07, s06_L, p06, rsi07, o07, c07, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st07 := nst07
[nst08, s08_L, p08] = f_process(s08, st08, s07_L, p07, rsi08, o08, c08, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st08 := nst08
[nst09, s09_L, p09] = f_process(s09, st09, s08_L, p08, rsi09, o09, c09, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st09 := nst09
[nst10, s10_L, p10] = f_process(s10, st10, s09_L, p09, rsi10, o10, c10, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st10 := nst10
[nst11, s11_L, p11] = f_process(s11, st11, s10_L, p10, rsi11, o11, c11, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st11 := nst11
[nst12, s12_L, p12] = f_process(s12, st12, s11_L, p11, rsi12, o12, c12, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st12 := nst12
[nst13, s13_L, p13] = f_process(s13, st13, s12_L, p12, rsi13, o13, c13, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st13 := nst13
[nst14, s14_L, p14] = f_process(s14, st14, s13_L, p13, rsi14, o14, c14, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st14 := nst14
[nst15, s15_L, p15] = f_process(s15, st15, s14_L, p14, rsi15, o15, c15, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st15 := nst15
[nst16, s16_L, p16] = f_process(s16, st16, s15_L, p15, rsi16, o16, c16, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st16 := nst16
[nst17, s17_L, p17] = f_process(s17, st17, s16_L, p16, rsi17, o17, c17, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st17 := nst17
[nst18, s18_L, p18] = f_process(s18, st18, s17_L, p17, rsi18, o18, c18, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st18 := nst18
[nst19, s19_L, p19] = f_process(s19, st19, s18_L, p18, rsi19, o19, c19, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st19 := nst19
[nst20, s20_L, p20] = f_process(s20, st20, s19_L, p19, rsi20, o20, c20, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st20 := nst20
[nst21, s21_L, p21] = f_process(s21, st21, s20_L, p20, rsi21, o21, c21, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st21 := nst21
[nst22, s22_L, p22] = f_process(s22, st22, s21_L, p21, rsi22, o22, c22, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st22 := nst22
[nst23, s23_L, p23] = f_process(s23, st23, s22_L, p22, rsi23, o23, c23, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st23 := nst23
[nst24, s24_L, p24] = f_process(s24, st24, s23_L, p23, rsi24, o24, c24, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st24 := nst24
[nst25, s25_L, p25] = f_process(s25, st25, s24_L, p24, rsi25, o25, c25, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st25 := nst25
[nst26, s26_L, p26] = f_process(s26, st26, s25_L, p25, rsi26, o26, c26, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st26 := nst26
[nst27, s27_L, p27] = f_process(s27, st27, s26_L, p26, rsi27, o27, c27, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st27 := nst27
[nst28, s28_L, p28] = f_process(s28, st28, s27_L, p27, rsi28, o28, c28, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st28 := nst28
[nst29, s29_L, p29] = f_process(s29, st29, s28_L, p28, rsi29, o29, c29, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st29 := nst29
[nst30, s30_L, p30] = f_process(s30, st30, s29_L, p29, rsi30, o30, c30, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st30 := nst30
[nst31, s31_L, p31] = f_process(s31, st31, s30_L, p30, rsi31, o31, c31, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st31 := nst31
[nst32, s32_L, p32] = f_process(s32, st32, s31_L, p31, rsi32, o32, c32, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st32 := nst32
[nst33, s33_L, p33] = f_process(s33, st33, s32_L, p32, rsi33, o33, c33, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st33 := nst33
[nst34, s34_L, p34] = f_process(s34, st34, s33_L, p33, rsi34, o34, c34, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st34 := nst34
[nst35, s35_L, p35] = f_process(s35, st35, s34_L, p34, rsi35, o35, c35, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st35 := nst35
[nst36, s36_L, p36] = f_process(s36, st36, s35_L, p35, rsi36, o36, c36, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st36 := nst36
[nst37, s37_L, p37] = f_process(s37, st37, s36_L, p36, rsi37, o37, c37, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st37 := nst37
[nst38, s38_L, p38] = f_process(s38, st38, s37_L, p37, rsi38, o38, c38, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st38 := nst38
[nst39, s39_L, p39] = f_process(s39, st39, s38_L, p38, rsi39, o39, c39, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st39 := nst39
[nst40, s40_L, p40] = f_process(s40, st40, s39_L, p39, rsi40, o40, c40, global_mode, entry_ob, exit_ob, entry_os, exit_os, stake_per_pair)
st40 := nst40

// ==========================================
// --- Dashboard Drawing ---
// ==========================================
var table dash = table.new(position.top_right, 3, 41, border_width = 1, frame_color = color.new(color.gray, 50))

f_row(r, nm, rs, s) =>
    bg_rsi = rs >= 50 ? color.from_gradient(rs, 50, 100, color.gray, color.red) : color.from_gradient(rs, 0, 50, color.lime, color.gray)
    m_bg = global_mode == 'Trend' ? color.blue : color.orange
    s_col = s != 0 ? color.yellow : color.gray
    table.cell(dash, 0, r, nm, text_color = s_col, text_size = size.tiny)
    table.cell(dash, 1, r, global_mode, bgcolor = m_bg, text_color = color.black, text_size = size.tiny)
    table.cell(dash, 2, r, str.tostring(rs, '#.#'), bgcolor = bg_rsi, text_color = color.black, text_size = size.tiny)

if barstate.islast
    table.cell(dash, 0, 0, 'Pair', bgcolor = color.black, text_color = color.white, text_size = size.tiny)
    table.cell(dash, 1, 0, 'Mode', bgcolor = color.black, text_color = color.white, text_size = size.tiny)
    table.cell(dash, 2, 0, 'RSI', bgcolor = color.black, text_color = color.white, text_size = size.tiny)
    f_row(1, 'EURUSD', rsi01, st01)
    f_row(2, 'GBPUSD', rsi02, st02)
    f_row(3, 'USDJPY', rsi03, st03)
    f_row(4, 'AUDUSD', rsi04, st04)
    f_row(5, 'USDCAD', rsi05, st05)
    f_row(6, 'USDCHF', rsi06, st06)
    f_row(7, 'NZDUSD', rsi07, st07)
    f_row(8, 'EURGBP', rsi08, st08)
    f_row(9, 'EURJPY', rsi09, st09)
    f_row(10, 'GBPJPY', rsi10, st10)
    f_row(11, 'AUDJPY', rsi11, st11)
    f_row(12, 'EURCHF', rsi12, st12)
    f_row(13, 'EURAUD', rsi13, st13)
    f_row(14, 'GBPAUD', rsi14, st14)
    f_row(15, 'CADJPY', rsi15, st15)
    f_row(16, 'GBPCAD', rsi16, st16)
    f_row(17, 'AUDCAD', rsi17, st17)
    f_row(18, 'NZDJPY', rsi18, st18)
    f_row(19, 'AUDNZD', rsi19, st19)
    f_row(20, 'GBPCHF', rsi20, st20)
    f_row(21, 'EURCAD', rsi21, st21)
    f_row(22, 'CHFJPY', rsi22, st22)
    f_row(23, 'GBPNZD', rsi23, st23)
    f_row(24, 'EURNZD', rsi24, st24)
    f_row(25, 'CADCHF', rsi25, st25)
    f_row(26, 'NZDCAD', rsi26, st26)
    f_row(27, 'NZDCHF', rsi27, st27)
    f_row(28, 'AUDCHF', rsi28, st28)
    f_row(29, 'USDSGD', rsi29, st29)
    f_row(30, 'USDHKD', rsi30, st30)
    f_row(31, 'USDMXN', rsi31, st31)
    f_row(32, 'USDZAR', rsi32, st32)
    f_row(33, 'USDTRY', rsi33, st33)
    f_row(34, 'USDSEK', rsi34, st34)
    f_row(35, 'USDNOK', rsi35, st35)
    f_row(36, 'USDPLN', rsi36, st36)
    f_row(37, 'USDCZK', rsi37, st37)
    f_row(38, 'USDHUF', rsi38, st38)
    f_row(39, 'USDILS', rsi39, st39)
    f_row(40, 'XAUUSD', rsi40, st40)

// ==========================================
// --- Visuals & Equity Glow ---
// ==========================================
var float equity = initial_capital
equity := equity + p40
active_trades = max_trades - s40_L
dynamic_alpha = math.min(70, active_trades / max_trades * 70)
c_curve = equity >= initial_capital ? #00ff88 : #ff3333

p_eq = plot(equity, 'Total Equity', color = c_curve, linewidth = 2)
p_base = plot(initial_capital, 'Base', display = display.none)
fill(p_eq, p_base, color.new(c_curve, 80 - dynamic_alpha), 'Exposure Glow')
