// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © unicorpusstocks

//@version=6
indicator("Debt-Cycle vs Bitcoin-Cycle", timeframe = "21D")

//inputs

offset = input.int(0, "offset")

//------------------------------------------------------------------------------------------
//OnChain Z-Score

Zscore(src) =>
    
    meanValue = ta.sma(src, 50)
    zScoreValue = (src - meanValue) / ta.stdev(src, 50)
    smooth = ta.hma(zScoreValue, 20)
    smooth > 0 ? smooth * 1 : smooth * 1

Zscore2(src, up, down) =>
    
    meanValue = ta.sma(src, 50)
    zScoreValue = (src - meanValue) / ta.stdev(src, 50)
    smooth = ta.hma(zScoreValue, 20)
    smooth > 0 ? smooth * up : smooth * down

out = math.avg(

//currencies
     math.avg(
           nz(request.security("DXY", timeframe.period, Zscore2(close * -1, 1, 0.5))),
           nz(request.security("USDWCU", timeframe.period, Zscore2(close, 2, 1))),
           nz(request.security("EXY", timeframe.period, Zscore(close))),
           nz(request.security("EURWCU", timeframe.period, Zscore(close)))),

//commodities
     math.avg(
           nz(request.security("PALLFNFINDEXQ", timeframe.period, Zscore(close * -1 ))),
           nz(request.security("POILBREUSDM", timeframe.period, Zscore2(close * -1, 1, 0.5))),
           nz(request.security("TVC:GOLD", timeframe.period, Zscore2(close * -1, 0.75, 1.5))),
           nz(request.security("PNGASEUUSDM", timeframe.period, Zscore(close * -1 ))),
           nz(request.security("INDEX:BTCUSD", timeframe.period, Zscore(close))),
           nz(request.security("PWHEAMTUSDM", timeframe.period, Zscore(close * -1)))),


//corporate bonds
     math.avg(
           nz(request.security("HQMCB10YRP", timeframe.period, Zscore(close * -1))),//
           nz(request.security("HQMCB10YR", timeframe.period, Zscore(close * -1))),
           nz(request.security("BAMLC0A0CMEY", timeframe.period, Zscore(close * -1))),
           nz(request.security("BAMLEMCBPIEY", timeframe.period, Zscore(close * -1))),
           nz(request.security("BAMLEMCBPIOAS", timeframe.period, Zscore(close * -1))),
           nz(request.security("FRED:BAMLC0A3CA+FRED:BAMLC0A2CAA+FRED:BAMLC0A1CAAA", timeframe.period, Zscore(close * -1))),
           nz(request.security("FRED:BAMLH0A0HYM2-TVC:US05Y", timeframe.period, Zscore(close * -1)))),


//corporate bonds
     math.avg(
           nz(request.security("ECONOMICS:USM2*FX_IDC:USDWCU", timeframe.period, Zscore(close))),
           nz(request.security("ECONOMICS:USFER*FX_IDC:USDWCU", timeframe.period, Zscore(close))),
           nz(request.security("ECONOMICS:EUM2*FX_IDC:EURWCU", timeframe.period, Zscore(close))),
           nz(request.security("ECONOMICS:EUFER*FX_IDC:EURWCU", timeframe.period, Zscore(close)))),

//treasury bonds
     math.avg(
           nz(request.security("T10Y2Y", timeframe.period, Zscore(close))),
           nz(request.security("T10Y3M", timeframe.period, Zscore(close))),
           nz(request.security("T10Y3MM", timeframe.period, Zscore(close))),
           nz(request.security("T10YFF", timeframe.period, Zscore(close))),
           nz(request.security("THREEFYTP10", timeframe.period, Zscore(close * -1))),
           nz(request.security("DLTIIT", timeframe.period, Zscore(close * -1))),
           nz(request.security("DGS10", timeframe.period, Zscore(close))))

     )




//Bitcoin Zscore

//------------------------------------------------------------------------------------------
//OnChain Z-Score

zscore(src, sma_length, stdev_length, smoothing_length, upside_multiplier , downside_multiplier, addition) =>
    
    meanValue = ta.sma(src, sma_length)
    zScoreValue = (src - meanValue) / ta.stdev(src, stdev_length)
    smooth = ta.hma(zScoreValue, smoothing_length)
    smooth > 0 ? smooth * upside_multiplier + addition : smooth * downside_multiplier + addition


btc = nz(request.security("INDEX:BTCUSD", timeframe.period, 
     zscore(close, 50, 50, 10, 1, 1, -2)
     ))

btc_mm = nz(request.security("INDEX:BTCUSD", timeframe.period, 
     zscore(close / ta.sma(close, 28), 50, 50, 10, 1, 1, 0)
     ))
     
btc_mvrv = nz(request.security("BTC_MVRV", timeframe.period, 
     zscore(close, 50, 50, 10, 1, 1, 0)
     ))

btc_nupl = nz(request.security("(GLASSNODE:BTC_MARKETCAP-COINMETRICS:BTC_MARKETCAPREAL)/GLASSNODE:BTC_MARKETCAP*100", timeframe.period, 
     zscore(close, 60, 60, 7, 1, 1, 0)
     ))

btc_pnl = nz(request.security("INTOTHEBLOCK:BTC_PROFITADDRESSES-INTOTHEBLOCK:BTC_LOSSESADDRESSES-INTOTHEBLOCK:BTC_BREAKEVENADDRESSES", timeframe.period, 
     zscore(close, 60, 60, 7, 1, 1, -1)
     ))

ethbtc = nz(request.security("INDEX:ETHUSD / INDEX:BTCUSD", timeframe.period, 
     zscore(close, 40, 40, 7, 1, 1, 0)
     ))

btcout = math.avg(
    //OnChain
     btc_mvrv,
     btc_nupl,
     btc_pnl,
    //technical
     btc,
     btc_mm,
    //RSPS 
     ethbtc
     ) * 0.5


//plots
plot(out, "Finance-Cycle", #ffffff, 2, offset = offset)
plot(btcout, "BTC", color.orange, 2, offset = 1)
hline(0, "mid", #ffffff, hline.style_solid, 2)
