//@version=5
indicator("RSI + Elder Bull-Bear pressure ", overlay=false)

// ─── Inputs ───────────────────────────────────────────────────────────────────
groupElder = "Elder-Ray"
emaLen     = input.int(13, "EMA Length", minval=1, group=groupElder)
showBull   = input.bool(true,  "Show Bull Power", group=groupElder)
showBear   = input.bool(true,  "Show Bear Power", group=groupElder)
bullCol    = input.color(color.new(color.lime, 0), "Bull Color", group=groupElder)
bearCol    = input.color(color.new(color.red,  0), "Bear Color", group=groupElder)

groupNorm  = "Normalization & Gain"
atrLen     = input.int(14, "ATR Length (for Power normalization)", minval=1, group=groupNorm)
powerGain  = input.float(1.0, "Power Gain (×)", minval=0.1, step=0.1, group=groupNorm)
rsiGain    = input.float(1.0, "RSI Gain (×)",   minval=0.1, step=0.1, group=groupNorm)

groupRSI   = "RSI"
rsiLen     = input.int(14, "RSI Length", minval=1, group=groupRSI)
rsiCol     = input.color(color.new(color.aqua, 0), "RSI Color", group=groupRSI)
rsiMode    = input.string("Normalized (−1..+1)", "RSI Mode", options=["Raw (0..100)", "Normalized (−1..+1)"], group=groupRSI)

groupBands = "RSI Bands"
showBands  = input.bool(true, "Show RSI Bands & Fills", group=groupBands)
bandsCol   = input.color(color.new(color.orange, 0), "Band Line Color", group=groupBands)
bandLineW  = input.int(1, "Band Line Width (thin)", minval=1, maxval=3, group=groupBands)
// Standard defaults: 30 / 50 / 80
rawLower   = input.float(30, "Raw Lower", minval=0, maxval=100, step=0.5, group=groupBands)
rawMid     = input.float(50, "Raw Mid",   minval=0, maxval=100, step=0.5, group=groupBands)
rawUpper   = input.float(70, "Raw Upper", minval=0, maxval=100, step=0.5, group=groupBands)
// Band placement option (FIX): use raw inputs by default
bandPlacement = input.string("Use Raw Bands", "Band placement",
     options=["Use Raw Bands", "Use Distance"], group=groupBands)
// Keep distance for those who prefer it
normDist   = input.float(0.60, "Normalized Band Distance (±)", minval=0.1, maxval=0.9, step=0.05, group=groupBands)
fillTopCol = input.color(color.new(color.orange, 85), "Fill: Mid→Upper", group=groupBands)
fillBotCol = input.color(color.new(color.orange, 85), "Fill: Lower→Mid", group=groupBands)

groupLbl              = "Labels"
showBandLabels        = input.bool(true, "Show band value labels at right edge", group=groupLbl)
showRsiLabel          = input.bool(true, "Show current RSI value label", group=groupLbl)
labelTxtCol           = input.color(color.new(color.white, 0), "Label text color", group=groupLbl)
labelBgCol            = input.color(color.new(color.black, 80), "Label background", group=groupLbl)
// Defaults per your screenshot
labelSizeInp          = input.string("tiny", "Label size", options=["tiny","small","normal","large"], group=groupLbl)
xOffsetBars           = input.int(50, "Label X offset (bars to the right)", minval=1, maxval=200, group=groupLbl)
rsiLabelExtraOffset   = input.int(50, "RSI label extra X offset (bars)", minval=0, maxval=200, group=groupLbl)
labSize               = labelSizeInp == "tiny" ? size.tiny : labelSizeInp == "small" ? size.small : labelSizeInp == "normal" ? size.normal : size.large

groupSmooth = "Bull/Bear Smoothing"
smoothOn    = input.bool(true,  "Smooth Bull/Bear", group=groupSmooth)
smoothType  = input.string("EMA", "Type", options=["EMA","SMA","RMA","HMA"], group=groupSmooth)
smoothLen   = input.int(21, "Length", minval=1, group=groupSmooth)
plotMode    = input.string("Line (smoothed)", "Plot Mode",
                           options=["Columns (raw)","Line (smoothed)","Columns (raw) + Line (smoothed)"],
                           group=groupSmooth)

// ─── Core calcs ───────────────────────────────────────────────────────────────
emaClose = ta.ema(close, emaLen)
bullRaw  = high - emaClose
bearRaw  = low  - emaClose
atrVal   = ta.atr(atrLen)
bullN    = atrVal > 0 ? (bullRaw / atrVal) * powerGain : na
bearN    = atrVal > 0 ? (bearRaw / atrVal) * powerGain : na

// RSI normalized (for overlap)
rsiRaw   = ta.rsi(close, rsiLen)
rsiNorm  = ((rsiRaw - 50.0) / 50.0) * rsiGain
useRaw   = rsiMode == "Raw (0..100)"
rsiPlot  = rsiNorm

// ─── Smoothing helper & series ────────────────────────────────────────────────
f_smooth(src, _type, _len) =>
    switch _type
        "EMA" => ta.ema(src, _len)
        "SMA" => ta.sma(src, _len)
        "RMA" => ta.rma(src, _len)
        "HMA" =>
            _l1 = math.max(1, _len)
            _l2 = math.max(1, math.round(_l1 / 2.0))
            _l3 = math.max(1, math.round(math.sqrt(_l1)))
            ta.wma(2 * ta.wma(src, _l2) - ta.wma(src, _l1), _l3)

bullSm = smoothOn ? f_smooth(bullN, smoothType, smoothLen) : bullN
bearSm = smoothOn ? f_smooth(bearN, smoothType, smoothLen) : bearN

// ─── Plots ───────────────────────────────────────────────────────────────────
showCols = plotMode == "Columns (raw)" or plotMode == "Columns (raw) + Line (smoothed)"
showLine = plotMode == "Line (smoothed)" or plotMode == "Columns (raw) + Line (smoothed)"

// Raw columns (optional)
plot(series=showBull and showCols ? bullN : na, title="Bull Power (raw)", style=plot.style_columns, color=bullCol, linewidth=2)
plot(series=showBear and showCols ? bearN : na, title="Bear Power (raw)", style=plot.style_columns, color=bearCol, linewidth=2)

// Smoothed line (optional)
plot(series=showBull and showLine ? bullSm : na, title="Bull Power (smoothed)", color=bullCol, linewidth=2)
plot(series=showBear and showLine ? bearSm : na, title="Bear Power (smoothed)", color=bearCol, linewidth=2)

// Common zero & RSI (RSI line slimmer)
plot(series=0.0, title="Zero", color=color.new(color.gray, 75), linewidth=1)
plot(series=rsiPlot, title="RSI (normalized)", color=rsiCol, linewidth=1)

// ─── RSI bands (thin, spaced, fills) ─────────────────────────────────────────
// Map raw band inputs to the normalized plotting axis when "Use Raw Bands"
// Otherwise use distance from 50
useRawBands = bandPlacement == "Use Raw Bands"
midNorm = 0.0
upNorm  = useRawBands ? ((rawUpper - 50.0) / 50.0) * rsiGain :  normDist * rsiGain
lowNorm = useRawBands ? ((rawLower - 50.0) / 50.0) * rsiGain : -normDist * rsiGain

midVal = showBands ? midNorm : na
upVal  = showBands ? upNorm  : na
lowVal = showBands ? lowNorm : na

midP = plot(series=midVal, title="RSI Mid",   color=bandsCol, linewidth=bandLineW)
upP  = plot(series=upVal,  title="RSI Upper", color=bandsCol, linewidth=bandLineW)
loP  = plot(series=lowVal, title="RSI Lower", color=bandsCol, linewidth=bandLineW)

fill(midP, upP, color=fillTopCol)
fill(loP,  midP, color=fillBotCol)

// ─── Right-edge labels (bands + current RSI; RSI pushed further right) ───────
f_fmt1(v) => str.tostring(math.round(v * 10.0) / 10.0)

var label lblMid = na
var label lblUp  = na
var label lblLow = na
var label lblRSI = na

// Labels now always show your RAW inputs (so you'll see 30 / 50 / 80)
rawMidShow = rawMid
rawUpShow  = rawUpper
rawLowShow = rawLower

txtMid = "RSI " + f_fmt1(rawMidShow)
txtUp  = "RSI " + f_fmt1(rawUpShow)
txtLow = "RSI " + f_fmt1(rawLowShow)
txtRSI = "RSI " + f_fmt1(rsiRaw)

// Y positions on shared (normalized) axis
yMid = nz(midVal, 0.0)
yUp  = nz(upVal,  0.0)
yLow = nz(lowVal, 0.0)
yRsi = rsiPlot

// X positions: bands at last+offset, RSI further right by extra offset
xBands = bar_index + xOffsetBars
xRSI   = bar_index + xOffsetBars + rsiLabelExtraOffset

// Small vertical nudge to reduce overlap when RSI equals a band level
near(a, b) => math.abs(a - b) <= 1e-6
nudgeUnit = 0.02 * math.max(1.0, rsiGain)
yRsiAdj = yRsi
yRsiAdj += near(yRsiAdj, yMid) ?  nudgeUnit : 0.0
yRsiAdj += near(yRsiAdj, yUp)  ? -nudgeUnit : 0.0
yRsiAdj += near(yRsiAdj, yLow) ?  nudgeUnit : 0.0

if barstate.islast
    if showBands and showBandLabels
        if na(lblMid)
            lblMid := label.new(x=xBands, y=yMid, text=txtMid, style=label.style_label_right, textcolor=labelTxtCol, color=labelBgCol, size=labSize)
        else
            label.set_xy(lblMid, xBands, yMid), label.set_text(lblMid, txtMid), label.set_color(lblMid, labelBgCol), label.set_textcolor(lblMid, labelTxtCol), label.set_size(lblMid, labSize)
        if na(lblUp)
            lblUp := label.new(x=xBands, y=yUp, text=txtUp, style=label.style_label_right, textcolor=labelTxtCol, color=labelBgCol, size=labSize)
        else
            label.set_xy(lblUp, xBands, yUp), label.set_text(lblUp, txtUp), label.set_color(lblUp, labelBgCol), label.set_textcolor(lblUp, labelTxtCol), label.set_size(lblUp, labSize)
        if na(lblLow)
            lblLow := label.new(x=xBands, y=yLow, text=txtLow, style=label.style_label_right, textcolor=labelTxtCol, color=labelBgCol, size=labSize)
        else
            label.set_xy(lblLow, xBands, yLow), label.set_text(lblLow, txtLow), label.set_color(lblLow, labelBgCol), label.set_textcolor(lblLow, labelTxtCol), label.set_size(lblLow, labSize)
    else
        if not na(lblMid)
            label.delete(lblMid), lblMid := na
        if not na(lblUp)
            label.delete(lblUp),  lblUp  := na
        if not na(lblLow)
            label.delete(lblLow), lblLow := na

    if showRsiLabel
        if na(lblRSI)
            lblRSI := label.new(x=xRSI, y=yRsiAdj, text=txtRSI, style=label.style_label_right, textcolor=rsiCol, color=labelBgCol, size=labSize)
        else
            label.set_xy(lblRSI, xRSI, yRsiAdj), label.set_text(lblRSI, txtRSI), label.set_color(lblRSI, labelBgCol), label.set_textcolor(lblRSI, rsiCol), label.set_size(lblRSI, labSize)
    else
        if not na(lblRSI)
            label.delete(lblRSI), lblRSI := na
