//@version=5
indicator("Precision Sword QQE - Clean Mode", shorttitle="Sword_Clean", overlay=false)

// --- INPUTS ---
rsiLen      = input.int(14, "RSI Length")
rsiSmooth   = input.int(8,  "RSI Smoothing")
qqeFactor   = input.float(4.236, "QQE Factor")
kijunLen    = input.int(26, "Kijun-sen Period")

// --- CALCULATIONS ---
src = close
rsindex = ta.rsi(src, rsiLen)
rsindexSmooth = ta.ema(rsindex, rsiSmooth)

// QQE Trailing Logic
tr = math.abs(rsindexSmooth[1] - rsindexSmooth)
atr_rsi = ta.ema(tr, 27)
qqe_threshold = atr_rsi * qqeFactor

var float qqe_long = 0.0
var float qqe_short = 0.0

qqe_long  := rsindexSmooth > qqe_long[1]  ? math.max(qqe_long[1], rsindexSmooth - qqe_threshold) : rsindexSmooth - qqe_threshold
qqe_short := rsindexSmooth < qqe_short[1] ? math.min(qqe_short[1], rsindexSmooth + qqe_threshold) : rsindexSmooth + qqe_threshold

qqe_line = rsindexSmooth - 50
signal_line = ta.ema(qqe_line, 8)

// Kijun-sen Filter
kijun = (ta.highest(high, kijunLen) + ta.lowest(low, kijunLen)) / 2

// --- VISUALS ---
is_bull = qqe_line > signal_line and close > kijun
is_bear = qqe_line < signal_line and close < kijun

// Σχεδίαση Histogram (Momentum)
plot(qqe_line, title="Momentum Hist", style=plot.style_columns, color=is_bull ? color.new(#00ffbb, 50) : is_bear ? color.new(#ff0055, 50) : color.new(color.gray, 80))

// Σχεδίαση Γραμμών (Οι οδηγοί σου)
plot(qqe_line, "Main Line (QQE)", color=color.white, linewidth=2)
plot(signal_line, "Signal Line", color=color.new(color.yellow, 30), linewidth=1)

// Γραμμή Μηδέν
hline(0, "Zero", color=color.new(color.gray, 70))

// Φόντο Επιβεβαίωσης (Πολύ απαλό για να μην κουράζει)
bgcolor(is_bull ? color.new(color.green, 97) : is_bear ? color.new(color.red, 97) : na)
