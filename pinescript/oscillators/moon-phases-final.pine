//@version=6
indicator("Moon Phases Final [Gemini]", overlay=false, precision=2)

// --- ĞœĞ°Ñ‚ĞµĞ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ñ€Ğ°ÑÑ‡ĞµÑ‚ ---
base_new_moon = timestamp("UTC", 2000, 1, 6, 18, 14, 0)
lunar_cycle = 29.530588853 * 24 * 60 * 60 * 1000 
current_phase = ((time - base_new_moon) % lunar_cycle) / lunar_cycle * 100

// Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ñ„Ğ°Ğ·
is_full_moon = ta.crossover(current_phase, 50)
is_new_moon  = ta.crossover(current_phase, 99.5) or ta.crossunder(current_phase, 0.5)

// --- ĞÑ‚Ñ€Ğ¸ÑĞ¾Ğ²ĞºĞ° Ğ² Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾Ğ¼ Ğ¾ĞºĞ½Ğµ (Ğ¿Ğ¾Ğ´ Ğ³Ñ€Ğ°Ñ„Ğ¸ĞºĞ¾Ğ¼) ---
plot(current_phase, "Ğ¤Ğ°Ğ·Ğ° Ğ›ÑƒĞ½Ñ‹ %", color=color.new(color.yellow, 0), linewidth=2)
hline(50, "ĞŸĞ¾Ğ»Ğ½Ğ¾Ğ»ÑƒĞ½Ğ¸Ğµ", color=color.new(color.white, 70), linestyle=hline.style_dashed)
fill(hline(0), hline(100), color=color.new(color.blue, 90))

// --- ĞÑ‚Ñ€Ğ¸ÑĞ¾Ğ²ĞºĞ° Ğ½Ğ° Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğ¼ Ğ³Ñ€Ğ°Ñ„Ğ¸ĞºĞµ (Ñ‡ĞµÑ€ĞµĞ· force_overlay) ---
// ĞœĞµÑ‚ĞºĞ° ĞŸĞ¾Ğ»Ğ½Ğ¾Ğ»ÑƒĞ½Ğ¸Ñ
plotshape(is_full_moon, 
     style=shape.labeldown, 
     location=location.abovebar, 
     color=color.yellow, 
     text="ğŸŒ•", 
     textcolor=color.black, 
     force_overlay=true,
     title="Full Moon Label")

// ĞœĞµÑ‚ĞºĞ° ĞĞ¾Ğ²Ğ¾Ğ»ÑƒĞ½Ğ¸Ñ
plotshape(is_new_moon, 
     style=shape.labelup, 
     location=location.belowbar, 
     color=color.gray, 
     text="ğŸŒ‘", 
     textcolor=color.white, 
     force_overlay=true,
     title="New Moon Label")

// --- Ğ˜Ğ½Ñ„Ğ¾-Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° (Ñ‚Ğ¾Ğ¶Ğµ Ñ„Ğ¾Ñ€ÑĞ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ° Ğ³Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ ÑĞºÑ€Ğ°Ğ½) ---
var table moonTable = table.new(position.top_right, 1, 1, bgcolor=color.new(color.black, 60), border_width=1, force_overlay=true)
if barstate.islast
    phase_name = current_phase > 45 and current_phase < 55 ? "ĞŸĞĞ›ĞĞĞ›Ğ£ĞĞ˜Ğ•" : 
                 current_phase > 95 or current_phase < 5 ? "ĞĞĞ’ĞĞ›Ğ£ĞĞ˜Ğ•" : "Ğ’ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞµ"
    table.cell(moonTable, 0, 0, "Ğ›ÑƒĞ½Ğ°: " + str.tostring(current_phase, "#.#") + "% (" + phase_name + ")", text_color=color.white)
