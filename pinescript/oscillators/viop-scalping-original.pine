//@version=5
strategy("VIOP Scalping - Original C# (v1.1)", overlay=true, initial_capital=1000000, commission_type=strategy.commission.percent, commission_value=0.01)

// --- C# PARAMETERS (Lines 20-80) ---
// Trend and Indicators
wmaLen = input.int(50, "Main Trend WMA", tooltip="Price above = LONG, Price below = SHORT")
emaFastLen = input.int(8, "Fast EMA")
emaSlowLen = input.int(21, "Slow EMA")
rsiLen = input.int(14, "RSI Period")
adxLen = input.int(14, "ADX Period")

// Threshold Values
rsiBuyLimit = input.float(65, "RSI Long Ceiling", tooltip="RSI must be LOWER than this for Long")
rsiSellLimit = input.float(35, "RSI Short Floor", tooltip="RSI must be HIGHER than this for Short")
adxThreshold = input.float(16.0, "ADX Threshold", tooltip="Trend strength must be greater than this")
emaDiffThreshold = input.float(0.03, "EMA Difference Threshold")

// Risk Management (Fixed Percentages)
tpPercent = input.float(0.45, "Take Profit %") / 100
tpStrongPercent = input.float(0.70, "Strong Trend Take Profit %") / 100
slPercent = input.float(0.90, "Stop Loss %") / 100
trailActivePct = input.float(0.35, "Trailing Activation %") / 100
trailDistPct = input.float(0.15, "Trailing Distance %") / 100

// Time Filter (C# Lines 26-27: No trades between 09:30-10:05)
// Check your TradingView session settings to match.
noTradeSession = input.session("0930-1005", "No-Trade Hours")

// --- INDICATORS ---
// WMA 50 Main Trend
mainTrendWMA = ta.wma(close, wmaLen)

// EMAs
emaFast = ta.ema(close, emaFastLen)
emaSlow = ta.ema(close, emaSlowLen)
emaDiff = emaFast - emaSlow
prevEmaDiff = emaDiff[1]

// RSI
rsiVal = ta.rsi(close, rsiLen)

// ADX Calculation
[diPlus, diMinus, adxVal] = ta.dmi(adxLen, adxLen) // Built-in PineScript ADX

// --- ENTRY LOGIC (C# Lines 430-520) ---
// Time Check (Do not trade during banned hours)
isInNoTradeTime = not na(time(timeframe.period, noTradeSession))

// Trend Status
isMainTrendUp = close > mainTrendWMA
isMainTrendDown = close < mainTrendWMA

// Long Conditions
// 1. EMA Difference positive and > threshold
// 2. Momentum increasing (Diff > Prev Diff)
// 3. RSI Filter (48 < RSI < 65)
// 4. Price higher than previous close
// 5. ADX > 16
longCondition = (emaDiff > emaDiffThreshold) and (emaDiff > prevEmaDiff) and (rsiVal > 48 and rsiVal < rsiBuyLimit) and (close > close[1]) and (adxVal > adxThreshold) and isMainTrendUp

// Short Conditions
shortCondition = (emaDiff < -emaDiffThreshold) and (emaDiff < prevEmaDiff) and (rsiVal < 52 and rsiVal > rsiSellLimit) and (close < close[1]) and (adxVal > adxThreshold) and isMainTrendDown

// Strong Trend Check (For higher Take Profit)
// C# Code: Price difference > 20 points AND EMA diff > 1.5 points
isStrongTrend = math.abs(close - mainTrendWMA) > 20 and math.abs(emaDiff) > 1.5
currentTP = isStrongTrend ? tpStrongPercent : tpPercent

// --- TRADE EXECUTION ---
if not isInNoTradeTime
    if longCondition
        strategy.entry("Long", strategy.long, comment="L | ADX:" + str.tostring(math.round(adxVal,1)))
        
    if shortCondition
        strategy.entry("Short", strategy.short, comment="S | ADX:" + str.tostring(math.round(adxVal,1)))

// --- EXIT MANAGEMENT (Trailing + Fixed TP/SL) ---
// PineScript strategy.exit handles trailing automatically.
// Trailing Activation: When price reaches 0.35% profit.
// Trailing Distance: Follows price from 0.15% distance.

strategy.exit("Exit Long", "Long", profit=close * currentTP / syminfo.mintick, loss=close * slPercent / syminfo.mintick, trail_price=close * (1 + trailActivePct), trail_offset=close * trailDistPct / syminfo.mintick)
strategy.exit("Exit Short", "Short", profit=close * currentTP / syminfo.mintick, loss=close * slPercent / syminfo.mintick, trail_price=close * (1 - trailActivePct), trail_offset=close * trailDistPct / syminfo.mintick)

// Visuals
plot(mainTrendWMA, color=color.yellow, linewidth=2, title="WMA 50 Trend")
plot(emaFast, color=color.green, title="EMA 8")
plot(emaSlow, color=color.red, title="EMA 21")
