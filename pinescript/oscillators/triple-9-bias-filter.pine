//@version=6
indicator("Triple 9 Bias filter ", overlay=true, max_lines_count=500)

// ────── Inputs ──────
tf_1h  = input.timeframe("60",  "1H Timeframe")
tf_4h  = input.timeframe("240", "4H Timeframe")
tf_15m = input.timeframe("15",  "15m Timeframe")
len_ema_21 = input.int(9, "1H EMA Length")
len_ema_50 = input.int(9, "4H EMA Length")
len_rsi    = input.int(14, "RSI Length")
src = input.source(close, "Source")

// ────── LOCKED HTF VALUES (Replay-safe) ──────
ema_1h = request.security(syminfo.tickerid, tf_1h, ta.ema(src, len_ema_21)[1], gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
dir_1h = request.security(syminfo.tickerid, tf_1h,
     ta.ema(src, len_ema_21)[1] > ta.ema(src, len_ema_21)[6] ? "UP" :
     ta.ema(src, len_ema_21)[1] < ta.ema(src, len_ema_21)[6] ? "DOWN" : "FLAT",
     gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)

ema_4h = request.security(syminfo.tickerid, tf_4h, ta.ema(src, len_ema_50)[1], gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
dir_4h = request.security(syminfo.tickerid, tf_4h,
     ta.ema(src, len_ema_50)[1] > ta.ema(src, len_ema_50)[10] ? "UP" :
     ta.ema(src, len_ema_50)[1] < ta.ema(src, len_ema_50)[10] ? "DOWN" : "FLAT",
     gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)

// 15m EMA 9
ema_15m = request.security(syminfo.tickerid, tf_15m, ta.ema(src, 9)[1], gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
dir_15m = request.security(syminfo.tickerid, tf_15m,
     ta.ema(src, 9)[1] > ta.ema(src, 9)[6] ? "UP" :
     ta.ema(src, 9)[1] < ta.ema(src, 9)[6] ? "DOWN" : "FLAT",
     gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)

// 4H RSI filter (locked)
dir_rsi = request.security(syminfo.tickerid, tf_4h,
     ta.rsi(src, len_rsi)[1] > 50 ? "BUY" :
     ta.rsi(src, len_rsi)[1] < 50 ? "SELL" : "FLAT",
     gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)

// ────── Plots ──────
plot(ema_1h,  "1H EMA 9",  color=color.purple, linewidth=2, style=plot.style_stepline)
plot(ema_4h,  "4H EMA 9",  color=color.red,    linewidth=2, style=plot.style_stepline)
plot(ema_15m, "15m EMA 9", color=color.orange, linewidth=2, style=plot.style_stepline)

// ────── Confluence Background ──────
bullish = dir_4h == "UP" and dir_rsi == "BUY"
bearish = dir_4h == "DOWN" and dir_rsi == "SELL"
bg = bullish ? color.new(color.lime, 70) : bearish ? color.new(color.red, 70) : color.new(color.gray, 80)

// ────── FINAL TABLE ──────
var table t = table.new(position.bottom_right, 2, 7, border_width=1, bgcolor=color.new(#0D1117, 15))

if barstate.islast
    table.cell(t, 0, 0, "BIAS FILTER", bgcolor=bg, text_color=color.white, text_size=size.large)
    table.merge_cells(t, 0, 0, 1, 0)

    table.cell(t, 0, 1, "Primary", text_color=color.yellow, text_size=size.large)
    table.merge_cells(t, 0, 1, 1, 1)

    table.cell(t, 0, 2, "4H EMA 9", text_color=color.white)
    table.cell(t, 1, 2, dir_4h, text_color=dir_4h=="UP" ? color.lime : color.red)

    table.cell(t, 0, 3, "1H EMA 9", text_color=color.white)
    table.cell(t, 1, 3, dir_1h, text_color=dir_1h=="UP" ? color.lime : color.red)

    table.cell(t, 0, 4, "15m EMA 9", text_color=color.white)
    table.cell(t, 1, 4, dir_15m, text_color=dir_15m=="UP" ? color.lime : color.red)

    table.cell(t, 0, 5, "Secondary", text_color=color.aqua, text_size=size.large)
    table.merge_cells(t, 0, 5, 1, 5)

    table.cell(t, 0, 6, "4H RSI >50", text_color=color.white)
    table.cell(t, 1, 6, dir_rsi, text_color=dir_rsi=="BUY" ? color.lime : color.red)
