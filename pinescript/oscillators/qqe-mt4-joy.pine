//@version=6
// By Glaz â€” MT4 QQE port refactored for Pine Script v6
indicator("QQE MT4", shorttitle="QQE MT4", overlay=false, precision=2)

rsiPeriod = input.int(14, "RSI Period", minval=1)
slowFactor = input.int(5, "RSI Smoothing (EMA)", minval=1)
qqeMultiplier = input.float(4.236, "QQE Multiplier", minval=0.1, step=0.001)

wildersPeriod = rsiPeriod * 2 - 1

rsiValue = ta.rsi(close, rsiPeriod)
rsiMa = ta.ema(rsiValue, slowFactor)
atrRsi = math.abs(rsiMa[1] - rsiMa)
maAtrRsi = ta.ema(atrRsi, wildersPeriod)
dar = ta.ema(maAtrRsi, wildersPeriod) * qqeMultiplier

var float longBand = na
var float shortBand = na
var float trend = 1.0

newShortBand = rsiMa + dar
newLongBand = rsiMa - dar
longBand := rsiMa[1] > nz(longBand[1], newLongBand) and rsiMa > nz(longBand[1], newLongBand) ? math.max(nz(longBand[1], newLongBand), newLongBand) : newLongBand
shortBand := rsiMa[1] < nz(shortBand[1], newShortBand) and rsiMa < nz(shortBand[1], newShortBand) ? math.min(nz(shortBand[1], newShortBand), newShortBand) : newShortBand

bullCross = ta.cross(rsiMa, shortBand[1])
bearCross = ta.cross(longBand[1], rsiMa)
trend := bullCross ? 1 : bearCross ? -1 : nz(trend[1], 1)
fastAtrRsiTL = trend == 1 ? longBand : shortBand

plot(fastAtrRsiTL, color=color.red, title="Slow Trailing Stop")
plot(rsiMa, color=color.yellow, title="Smoothed RSI")
