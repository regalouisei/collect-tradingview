//@version=6
indicator("Kernel Filter Histogram (RBF) — Regime/Ev Gate", overlay=false, max_bars_back=5000)

//-------------------------
// Inputs
//-------------------------
src          = input.source(close, "Source")
lookback     = input.int(120, "Kernel Lookback (bars)", minval=20, maxval=500)
bandwidth    = input.float(18.0, "RBF Bandwidth (sigma)", minval=2.0, maxval=100.0, step=0.5)
atrLen       = input.int(14, "ATR Length (normalization)", minval=5, maxval=100)
smoothHist   = input.int(9, "Histogram Smoothing (EMA)", minval=1, maxval=50)
zLen         = input.int(150, "Z-Score Window", minval=30, maxval=1000)
clipZ        = input.float(3.0, "Clip Z-Score", minval=1.0, maxval=10.0, step=0.5)

useThreshold = input.bool(true, "Use Threshold Gate?")
thresh       = input.float(0.30, "Threshold (|Z| >)", minval=0.0, maxval=5.0, step=0.05)

showKRLine   = input.bool(false, "Show Kernel Regression Line (in this pane)")
showSignal   = input.bool(true, "Show Signal Line (EMA of Histogram)")

//-------------------------
// Helpers
//-------------------------
rbf(dist, sigma) =>
    // Gaussian / RBF kernel
    math.exp(-(dist * dist) / (2.0 * sigma * sigma))

clamp(x, lo, hi) =>
    math.max(lo, math.min(hi, x))

//-------------------------
// Kernel Regression (Nadaraya–Watson)
//-------------------------
// Weighted average of src[i] using time-distance weights (0..lookback-1)
var float kr = na

float num = 0.0
float den = 0.0

for i = 0 to lookback - 1
    w = rbf(i, bandwidth)
    num += w * src[i]
    den += w

kr := den != 0.0 ? (num / den) : na

//-------------------------
// Histogram = normalized slope of kernel regression
//-------------------------
atr   = ta.atr(atrLen)
slope = kr - kr[1]

// Normalize slope by ATR to make it comparable across instruments
normSlope = atr != 0.0 ? (slope / atr) : 0.0

// Convert to z-score so histogram reads like “edge pressure”
meanNS = ta.sma(normSlope, zLen)
stdNS  = ta.stdev(normSlope, zLen)
z      = stdNS != 0.0 ? (normSlope - meanNS) / stdNS : 0.0
zClip  = clamp(z, -clipZ, clipZ)

// Smooth histogram for readability
histRaw = zClip
hist    = ta.ema(histRaw, smoothHist)
sig     = ta.ema(hist, smoothHist)

//-------------------------
// Gate logic
//-------------------------
bullOK = useThreshold ? (hist > +thresh) : (hist > 0)
bearOK = useThreshold ? (hist < -thresh) : (hist < 0)

//-------------------------
// Plots
//-------------------------
hColor = bullOK ? color.lime : bearOK ? color.red : color.gray

plot(hist, "Kernel Hist (Z)", style=plot.style_histogram, color=hColor, linewidth=2)
plot(0, "Zero", color=color.new(color.white, 70))

plot(showSignal ? sig : na, "Signal", color=color.new(color.white, 0), linewidth=1)
plot(showKRLine ? kr : na, "Kernel Regression (src)", color=color.new(color.aqua, 0), linewidth=2)

// Optional markers for regime flips
flipUp = ta.crossover(hist, 0)
flipDn = ta.crossunder(hist, 0)

plotshape(flipUp, title="Flip Up", style=shape.triangleup, size=size.tiny, color=color.lime, location=location.bottom)
plotshape(flipDn, title="Flip Down", style=shape.triangledown, size=size.tiny, color=color.red, location=location.top)

//-------------------------
// Alerts (optional)
//-------------------------
alertcondition(bullOK and not bullOK[1], title="Kernel Gate ON (Bull)", message="Kernel filter turned Bullish")
alertcondition(bearOK and not bearOK[1], title="Kernel Gate ON (Bear)", message="Kernel filter turned Bearish")
