//@version=5
indicator("RSI Structure Engine (Aggressive Soft) | Murat", shorttitle="RSI-STRUCT-A2", overlay=false, max_lines_count=200, max_labels_count=200)

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// INPUTS
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
rsiLen     = input.int(7, "RSI Periyot", minval=2)
hiLevel    = input.float(70, "Tepe BaÅŸlangÄ±Ã§", step=0.5)
loLevel    = input.float(30, "Dip BaÅŸlangÄ±Ã§", step=0.5)
midHigh    = input.float(40, "Tepe Kilit (Alt)", step=0.5)  // â‰¥70 sonrasÄ± <=40 gelince tepe kilit
midLow     = input.float(60, "Dip Kilit (Ãœst)", step=0.5)   // â‰¤30 sonrasÄ± >=60 gelince dip kilit
maxSwings  = input.int(30, "Max Swing (Ã§izim limiti)", minval=5, maxval=200)
showStruct = input.bool(true, "HH / HL / LH / LL")
showLines  = input.bool(true, "BaÄŸlantÄ± Ã‡izgileri")
showDots   = input.bool(true, "CanlÄ± Takip NoktalarÄ±")

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// RSI
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
rsi = ta.rsi(close, rsiLen)
plot(rsi, title="RSI", linewidth=2)
hline(hiLevel, "70", linestyle=hline.style_dotted)
hline(loLevel, "30", linestyle=hline.style_dotted)
hline(50, "50", linestyle=hline.style_dotted)
hline(midHigh, "40", linestyle=hline.style_dashed)
hline(midLow, "60", linestyle=hline.style_dashed)

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ARRAYS (object limits)
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
var label[] peakLabels   = array.new_label()
var label[] valleyLabels = array.new_label()
var line[]  peakLines    = array.new_line()
var line[]  valleyLines  = array.new_line()

f_trimLabel(arr) =>
    if array.size(arr) > maxSwings
        label.delete(array.shift(arr))

f_trimLine(arr) =>
    if array.size(arr) > maxSwings
        line.delete(array.shift(arr))

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// STATE
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
var bool  inPeak   = false
var bool  inValley = false

var float peakVal = na
var int   peakBar = na
var float valleyVal = na
var int   valleyBar = na

var float lastPeak = na
var int   lastPeakBar = na
var float prevPeak = na
var int   prevPeakBar = na

var float lastValley = na
var int   lastValleyBar = na
var float prevValley = na
var int   prevValleyBar = na

f_peakTag(a, b) => na(b) ? "" : (a > b ? "HH" : "LH")
f_valleyTag(a, b) => na(b) ? "" : (a > b ? "HL" : "LL")

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ENTER MODES
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
if (rsi >= hiLevel) and not inPeak
    inPeak := true
    inValley := false
    peakVal := rsi
    peakBar := bar_index

if (rsi <= loLevel) and not inValley
    inValley := true
    inPeak := false
    valleyVal := rsi
    valleyBar := bar_index

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// TRACK EXTREMES
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
if inPeak and (na(peakVal) or rsi > peakVal)
    peakVal := rsi
    peakBar := bar_index

if inValley and (na(valleyVal) or rsi < valleyVal)
    valleyVal := rsi
    valleyBar := bar_index

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// LIVE DOTS (plot circles) âœ…
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
plot(showDots and inPeak   ? peakVal   : na, title="Peak Tracking Dot",   style=plot.style_circles, linewidth=3)
plot(showDots and inValley ? valleyVal : na, title="Valley Tracking Dot", style=plot.style_circles, linewidth=3)

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// LOCK PEAK (â‰¥70 then <=40)
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
if inPeak and (rsi <= midHigh)
    prevPeak := lastPeak
    prevPeakBar := lastPeakBar
    lastPeak := peakVal
    lastPeakBar := peakBar

    tag = showStruct ? f_peakTag(lastPeak, prevPeak) : ""
    lbp = label.new(lastPeakBar, lastPeak, tag == "" ? "ğŸ”º" : ("ğŸ”º " + tag), style=label.style_label_down, color=color.new(color.red, 20), textcolor=color.white, size=size.small)
    array.push(peakLabels, lbp), f_trimLabel(peakLabels)

    if showLines and not na(prevPeak) and not na(prevPeakBar)
        lnp = line.new(prevPeakBar, prevPeak, lastPeakBar, lastPeak, color=color.new(color.red, 0), width=2)
        array.push(peakLines, lnp), f_trimLine(peakLines)

    inPeak := false
    peakVal := na
    peakBar := na

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// LOCK VALLEY (<=30 then >=60)
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
if inValley and (rsi >= midLow)
    prevValley := lastValley
    prevValleyBar := lastValleyBar
    lastValley := valleyVal
    lastValleyBar := valleyBar

    tag2 = showStruct ? f_valleyTag(lastValley, prevValley) : ""
    lbv = label.new(lastValleyBar, lastValley, tag2 == "" ? "ğŸ”»" : ("ğŸ”» " + tag2), style=label.style_label_up, color=color.new(color.green, 20), textcolor=color.white, size=size.small)
    array.push(valleyLabels, lbv), f_trimLabel(valleyLabels)

    if showLines and not na(prevValley) and not na(prevValleyBar)
        lnv = line.new(prevValleyBar, prevValley, lastValleyBar, lastValley, color=color.new(color.green, 0), width=2)
        array.push(valleyLines, lnv), f_trimLine(valleyLines)

    inValley := false
    valleyVal := na
    valleyBar := na
