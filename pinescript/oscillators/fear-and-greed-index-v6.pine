//@version=6
// @description Multi-factor sentiment analysis using RSI, Volatility (ATR), and Volume.
indicator("Fear and Greed Index V6", shorttitle="F&G V6", overlay=false)

// --- Inputs ---
rsiLen    = input.int(14, "RSI Period")
volLen    = input.int(20, "Lookback Period")
smoothLen = input.int(5, "Smoothing")

// --- Calculations ---
rsiVal = ta.rsi(close, rsiLen)
atr    = ta.atr(volLen)
avgAtr = ta.sma(atr, volLen * 2)
volSMA = ta.sma(volume, volLen)

// Sentiment Logic
float sentimentRaw = rsiVal

// FIXED INDENTATION: The lines below the 'if' must be indented
if close < close[1] and atr > avgAtr
    sentimentRaw := sentimentRaw - ((atr / math.max(avgAtr, 1)) * 5)

if close > close[1] and volume > (volSMA * 1.2)
    sentimentRaw := sentimentRaw + ((volume / math.max(volSMA, 1)) * 2)

// Normalization (Manual Clamp)
float clampedSent = sentimentRaw > 100 ? 100 : (sentimentRaw < 0 ? 0 : sentimentRaw)
float finalScore  = ta.ema(clampedSent, smoothLen)

// --- Plotting ---
indexColor = finalScore > 70 ? color.lime : (finalScore < 30 ? color.red : color.gray)
plot(finalScore, "Index Score", color=indexColor, linewidth=2)

h_max = hline(100, display=display.none)
h_80  = hline(80, "Ext Greed", color=color.new(color.lime, 50), linestyle=hline.style_dashed)
h_mid = hline(50, "Neutral", color=color.new(color.gray, 50))
h_20  = hline(20, "Ext Fear", color=color.new(color.red, 50), linestyle=hline.style_dashed)
h_min = hline(0, display=display.none)

fill(h_80, h_max, color.new(color.lime, 90), "Greed Zone")
fill(h_20, h_min, color.new(color.red, 90), "Fear Zone")

// --- Dashboard ---
var table dash = table.new(position.top_right, 2, 2, border_width = 1, border_color = color.gray)

// Dynamic Status logic using ternary for V6 stability
string txtStatus = finalScore >= 80 ? "EXTREME GREED" : finalScore >= 60 ? "GREED" : finalScore <= 20 ? "EXTREME FEAR" : finalScore <= 40 ? "FEAR" : "NEUTRAL"
color  colStatus = finalScore >= 60 ? color.lime : finalScore <= 40 ? color.red : color.gray

if barstate.islast
    table.cell(dash, 0, 0, "Sentiment", bgcolor=color.new(color.black, 20), text_color=color.white, text_size=size.small)
    table.cell(dash, 1, 0, txtStatus, bgcolor=colStatus, text_color=color.black, text_size=size.small)
    table.cell(dash, 0, 1, "Score", bgcolor=color.new(color.black, 20), text_color=color.white, text_size=size.small)
    table.cell(dash, 1, 1, str.tostring(math.round(finalScore, 2)), bgcolor=colStatus, text_color=color.black, text_size=size.small)
