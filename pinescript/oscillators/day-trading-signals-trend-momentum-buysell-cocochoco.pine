//@version=6
indicator("Day Trading Signals Trend & Momentum Buy/Sell [CocoChoco]", overlay = true)

// --- Inputs ---
smaFastLen = input.int(10, "Fast SMA Length", minval = 1)
smaSlowLen = input.int(50, "Slow SMA Length", minval = 1)
smaColor   = input.color(color.yellow, "Fast SMA Color")

// Confluence Settings
// Logic: If chart <= 15m, use 1H. Otherwise use 4H.
autoTF       = (timeframe.isintraday and timeframe.multiplier <= 15) ? "60" : "240"
confSmaLen   = input.int(200, "Confluence SMA Length")

stochLen         = input.int(14, "Stochastic Length")
stochKSmoothing  = input.int(3, "Stochastic %K Smoothing")
stochDSmoothing  = input.int(3, "Stochastic %D Smoothing")
stochOBLevel     = input.int(80, "Stoch Overbought Level")
stochOSLevel     = input.int(20, "Stoch Oversold Level")

adxLen       = input.int(14, "ADX Length")
adxThreshold = input.int(20, "ADX Minimum Level")

upColor   = input.color(color.green, "Long Signal Color")
downColor = input.color(color.red, "Short Signal Color")

// ATR & Buy/Sell Box Settings
atrLen          = input.int(14, "ATR Length")
riskAtrMult     = input.float(1.0, "SL ATR Multiplier", step = 0.1)
riskRewardRatio = input.float(1.0, "Risk:Reward Ratio", step = 0.1)
boxWidth        = input.int(12, "Box Width (Bars)", minval = 1)

// --- Calculations ---
sma10 = ta.sma(close, smaFastLen)
sma50 = ta.sma(close, smaSlowLen)

// Adaptive Confluence SMA
sma200_conf = request.security(syminfo.tickerid, autoTF, ta.sma(close, confSmaLen))
priceAboveConf = close > sma200_conf
priceBelowConf = close < sma200_conf

fastK = ta.stoch(close, high, low, stochLen) 
k = ta.sma(fastK, stochKSmoothing) 
[_, _, adx] = ta.dmi(adxLen, adxLen)

// --- Trade State Management ---
var bool inLongTrade  = false
var bool inShortTrade = false

longConditionsMet  = (sma10 > sma50) and priceAboveConf and ta.rising(k, 1) and (adx >= adxThreshold) and (k < stochOBLevel) and (close > open) and (close > sma10)
shortConditionsMet = (sma10 < sma50) and priceBelowConf and ta.falling(k, 1) and (adx >= adxThreshold) and (k > stochOSLevel) and (close < open) and (close < sma10)

longSignal  = longConditionsMet and not inLongTrade
shortSignal = shortConditionsMet and not inShortTrade

if longSignal
    inLongTrade := true
if shortSignal
    inShortTrade := true

longExitCondition  = inLongTrade and ta.crossunder(sma10, sma50)
shortExitCondition = inShortTrade and ta.crossover(sma10, sma50)

if longExitCondition
    inLongTrade := false
if shortExitCondition
    inShortTrade := false

// --- ATR Box Logic ---
atr = ta.atr(atrLen)

drawBoxes(isLong, entry, slMult, rr) =>
    float slDist = atr * slMult
    float tpDist = slDist * rr
    float slPrice = isLong ? entry - slDist : entry + slDist
    float tpPrice = isLong ? entry + tpDist : entry - tpDist
    
    // SL Box (Red) - No border
    box.new(left = bar_index, top = isLong ? entry : slPrice, right = bar_index + boxWidth, bottom = isLong ? slPrice : entry, 
             bgcolor = color.new(color.red, 80), border_color = na)
             
    // TP Box (Green) - No border
    box.new(left = bar_index, top = isLong ? tpPrice : entry, right = bar_index + boxWidth, bottom = isLong ? entry : tpPrice, 
             bgcolor = color.new(color.green, 80), border_color = na)

if longSignal
    drawBoxes(true, close, riskAtrMult, riskRewardRatio)

if shortSignal
    drawBoxes(false, close, riskAtrMult, riskRewardRatio)

// --- Plotting ---
plot(sma10, "Fast SMA", color = smaColor, linewidth = 2)
 

// Entry Signals
plotshape(longSignal,  style = shape.labelup,   location = location.belowbar, color = upColor,   size = size.small)
plotshape(shortSignal, style = shape.labeldown, location = location.abovebar, color = downColor, size = size.small)

// Exit Signals (Red X)
plotchar(longExitCondition,  char = "X", location = location.abovebar, color = color.red, textcolor = color.white, title = "Long Exit", size = size.tiny)
plotchar(shortExitCondition, char = "X", location = location.belowbar, color = color.red, textcolor = color.white, title = "Short Exit", size = size.tiny)
