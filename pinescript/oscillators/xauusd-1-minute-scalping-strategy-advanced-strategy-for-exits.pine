//@version=6
strategy("XAUUSD 1-Minute Scalping Strategy - FIXED Exits", overlay=true, 
         default_qty_type=strategy.fixed, default_qty_value=1, 
         initial_capital=1000000, currency=currency.USD)

// â”€â”€ Inputs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
length       = input.int(14, title="RSI Length")
overbought   = input.int(70, title="Overbought Level")
oversold     = input.int(30, title="Oversold Level")
takeProfit   = input.int(10, title="Take Profit (pips)")
stopLoss     = input.int(5,  title="Stop Loss (pips)")

use_trend_filter = input.bool(true, "Use 200 EMA Trend Filter (recommended)")

// â”€â”€ Calculations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
rsi    = ta.rsi(close, length)
ema200 = ta.ema(close, 200)

// â”€â”€ Entry Conditions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
longCondition  = rsi < oversold  and (not use_trend_filter or close > ema200)
shortCondition = rsi > overbought and (not use_trend_filter or close < ema200)

// â”€â”€ Entries â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if (longCondition and strategy.position_size == 0)
    strategy.entry("Long", strategy.long)

if (shortCondition and strategy.position_size == 0)
    strategy.entry("Short", strategy.short)

// â”€â”€ FIXED TP/SL (set once at entry) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var float long_tp_price  = na
var float long_sl_price  = na
var float short_tp_price = na
var float short_sl_price = na

// Capture prices on the entry bar only
if strategy.position_size > 0 and strategy.position_size[1] <= 0
    long_tp_price  := close + takeProfit * syminfo.mintick
    long_sl_price  := close - stopLoss  * syminfo.mintick

if strategy.position_size < 0 and strategy.position_size[1] >= 0
    short_tp_price := close - takeProfit * syminfo.mintick
    short_sl_price := close + stopLoss  * syminfo.mintick

// Place exits only once right after entry (prevents overwriting)
if strategy.position_size > 0 and strategy.position_size[1] <= 0
    strategy.exit("TP/SL Long", from_entry="Long", 
                  limit = long_tp_price, 
                  stop  = long_sl_price)

if strategy.position_size < 0 and strategy.position_size[1] >= 0
    strategy.exit("TP/SL Short", from_entry="Short", 
                  limit = short_tp_price, 
                  stop  = short_sl_price)

// â”€â”€ VISUALIZATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
hline(overbought, "Overbought", color=color.new(color.red, 50), linestyle=hline.style_dashed, linewidth=2)
hline(oversold,   "Oversold",   color=color.new(color.green, 50), linestyle=hline.style_dashed, linewidth=2)
hline(50,         "Midline",    color=color.new(color.gray, 70),  linestyle=hline.style_dotted, linewidth=1)

rsiPlot = plot(rsi, title="RSI", color=color.new(color.blue, 0), linewidth=2)
fill(plot(50, display=display.none), rsiPlot, color=rsi > 50 ? color.new(color.blue, 90) : color.new(color.orange, 90), title="RSI Background")

bgcolor(rsi > overbought ? color.new(color.red, 85) : rsi < oversold ? color.new(color.green, 85) : na, title="RSI Zones")

plotshape(longCondition,  "Long Entry",  style=shape.triangleup,   location=location.belowbar, color=color.new(color.lime, 0), size=size.small, text="BUY",  textcolor=color.white)
plotshape(shortCondition, "Short Entry", style=shape.triangledown, location=location.abovebar, color=color.new(color.red, 0),  size=size.small, text="SELL", textcolor=color.white)

// â”€â”€ PROFESSIONAL DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var table dashboard = table.new(
     position=position.top_right,
     columns=2,
     rows=11,
     bgcolor=color.new(color.black, 30),
     border_color=color.new(color.blue, 70),
     border_width=2,
     frame_color=color.new(color.blue, 70),
     frame_width=2)

if barstate.islast
    // HEADER
    table.cell(dashboard, 0, 0, "XAUUSD 1M SCALPER", 
               bgcolor=color.new(color.blue, 60), text_color=color.white, 
               text_size=size.large, text_halign=text.align_center)
    table.merge_cells(dashboard, 0, 0, 1, 0)
    
    // NET PROFIT
    table.cell(dashboard, 0, 1, "Net P&L", bgcolor=color.new(color.gray, 50), text_color=color.white, text_size=size.small)
    profitColor = strategy.netprofit > 0 ? color.new(color.green, 30) : color.new(color.red, 30)
    profitTextColor = strategy.netprofit > 0 ? color.lime : color.red
    table.cell(dashboard, 1, 1, "$" + str.tostring(strategy.netprofit, "#,##0.00"), 
               bgcolor=profitColor, text_color=profitTextColor, text_size=size.large, text_halign=text.align_right)
    
    // TOTAL TRADES
    table.cell(dashboard, 0, 2, "Total Trades", bgcolor=color.new(color.gray, 50), text_color=color.white, text_size=size.small)
    table.cell(dashboard, 1, 2, str.tostring(strategy.closedtrades), 
               text_color=color.white, text_size=size.normal, text_halign=text.align_right)
    
    // WIN RATE
    table.cell(dashboard, 0, 3, "Win Rate", bgcolor=color.new(color.gray, 50), text_color=color.white, text_size=size.small)
    winRate = strategy.closedtrades > 0 ? (strategy.wintrades / strategy.closedtrades) * 100 : 0
    wrColor = winRate > 50 ? color.lime : winRate > 40 ? color.yellow : color.red
    table.cell(dashboard, 1, 3, str.tostring(winRate, "#.##") + "%", 
               text_color=wrColor, text_size=size.normal, text_halign=text.align_right)
    
    // PROFIT FACTOR
    table.cell(dashboard, 0, 4, "Profit Factor", bgcolor=color.new(color.gray, 50), text_color=color.white, text_size=size.small)
    pf = strategy.grossloss != 0 ? math.abs(strategy.grossprofit / strategy.grossloss) : 0
    pfColor = pf > 1.5 ? color.lime : pf > 1.0 ? color.yellow : color.red
    table.cell(dashboard, 1, 4, str.tostring(pf, "#.##"), 
               text_color=pfColor, text_size=size.normal, text_halign=text.align_right)
    
    // WINNING / LOSING TRADES
    table.cell(dashboard, 0, 5, "Winning Trades", bgcolor=color.new(color.gray, 50), text_color=color.white, text_size=size.small)
    table.cell(dashboard, 1, 5, str.tostring(strategy.wintrades), 
               text_color=color.lime, text_size=size.normal, text_halign=text.align_right)
    
    table.cell(dashboard, 0, 6, "Losing Trades", bgcolor=color.new(color.gray, 50), text_color=color.white, text_size=size.small)
    table.cell(dashboard, 1, 6, str.tostring(strategy.losstrades), 
               text_color=color.red, text_size=size.normal, text_halign=text.align_right)
    
    // CURRENT RSI
    table.cell(dashboard, 0, 7, "Current RSI", bgcolor=color.new(color.gray, 50), text_color=color.white, text_size=size.small)
    rsiColor = rsi > overbought ? color.red : rsi < oversold ? color.lime : color.yellow
    table.cell(dashboard, 1, 7, str.tostring(rsi, "#.##"), 
               text_color=rsiColor, text_size=size.normal, text_halign=text.align_right)
    
    // POSITION STATUS
    table.cell(dashboard, 0, 8, "Position", bgcolor=color.new(color.gray, 50), text_color=color.white, text_size=size.small)
    posText = strategy.position_size > 0 ? "LONG ðŸ“ˆ" : strategy.position_size < 0 ? "SHORT ðŸ“‰" : "FLAT â”"
    posColor = strategy.position_size > 0 ? color.lime : strategy.position_size < 0 ? color.red : color.gray
    table.cell(dashboard, 1, 8, posText, 
               text_color=posColor, text_size=size.normal, text_halign=text.align_right)
    
    // RISK/REWARD
    rrRatio = takeProfit / stopLoss
    table.cell(dashboard, 0, 9, "TP/SL Ratio", bgcolor=color.new(color.gray, 50), text_color=color.white, text_size=size.small)
    table.cell(dashboard, 1, 9, "1:" + str.tostring(rrRatio, "#.#"), text_color=color.aqua, text_size=size.normal, text_halign=text.align_right)
    
    // FOOTER
    table.cell(dashboard, 0, 10, "IC Markets â€¢ v6 Fixed", bgcolor=color.new(color.gray, 70), text_color=color.white, text_size=size.tiny, text_halign=text.align_center)
    table.merge_cells(dashboard, 0, 10, 1, 10)

// â”€â”€ WEBHOOK ALERTS (STRATEGY-SAFE) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// BUY ALERT
if longCondition and strategy.position_size == 0
    alert(
        "{\n" +
        "  \"symbol\": \"XAUUSD\",\n" +
        "  \"quantity\": 1,\n" +
        "  \"action\": \"buy\"\n" +
        "}",
        alert.freq_once_per_bar_close
    )

// SELL ALERT
if shortCondition and strategy.position_size == 0
    alert(
        "{\n" +
        "  \"symbol\": \"XAUUSD\",\n" +
        "  \"quantity\": 1,\n" +
        "  \"action\": \"sell\"\n" +
        "}",
        alert.freq_once_per_bar_close
    )
