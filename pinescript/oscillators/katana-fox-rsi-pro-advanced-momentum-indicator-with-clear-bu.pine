//@version=5
indicator(" Katana_Fox RSI", "Katana_Fox RSI Pro", format=format.price, precision=2)

// Input parameters
lenrsi = input.int(3, "RSI Length", minval=1)
lenupdown = input.int(2, "UpDown Length", minval=1)
lenroc = input.int(100, "ROC Length", minval=1)

// Alerts and signals
show_signals = input.bool(true, "Show Buy/Sell Signals")
show_alerts = input.bool(true, "Enable Alert Conditions")
overbought = input.int(70, "Overbought Level", minval=50, maxval=90)
oversold = input.int(30, "Oversold Level", minval=10, maxval=50)

// Style options
show_fill = input.bool(true, "Show Background Fill")
custom_colors = input.bool(true, "Use Custom Colors")

// UpDown function
updown(s) =>
    isEqual = s == s[1]
    isGrowing = s > s[1]
    ud = 0.0
    ud := isEqual ? 0 : isGrowing ? (nz(ud[1]) <= 0 ? 1 : nz(ud[1]) + 1) : (nz(ud[1]) >= 0 ? -1 : nz(ud[1]) - 1)
    ud

// Calculate components
rsi = ta.rsi(close, lenrsi)
updownrsi = ta.rsi(updown(close), lenupdown)
percentrank = ta.percentrank(ta.roc(close, 1), lenroc)
crsi = math.avg(rsi, updownrsi, percentrank)

// Smoothing
smoothed_crsi = ta.ema(crsi, 2)

// Signal conditions
bullish_signal = ta.crossover(smoothed_crsi, oversold) and smoothed_crsi > oversold
bearish_signal = ta.crossunder(smoothed_crsi, overbought) and smoothed_crsi < overbought
strong_bullish = smoothed_crsi < oversold and ta.rising(smoothed_crsi, 2)
strong_bearish = smoothed_crsi > overbought and ta.falling(smoothed_crsi, 2)

// Colors
crsi_color = custom_colors ? 
             smoothed_crsi >= overbought ? #FF6B9D : 
             smoothed_crsi <= oversold ? #4FC3F7 : 
             smoothed_crsi >= 50 ? #43A047 : #FFA726 : #2962FF

fill_color = custom_colors ? color.new(#2E3192, 85) : color.new(#2962FF, 90)

// Plotting
plot(smoothed_crsi, "CRSI", crsi_color, 2)

// Signal labels with BUY/SELL text
if show_signals
    if bullish_signal
        label.new(bar_index, na, "BUY", color=color.new(#4CAF50, 0), textcolor=color.white, style=label.style_label_up, yloc=yloc.belowbar)
    if bearish_signal
        label.new(bar_index, na, "SELL", color=color.new(#F44336, 0), textcolor=color.white, style=label.style_label_down, yloc=yloc.abovebar)

// Levels
overbought_line = hline(overbought, "Overbought", color=color.new(#F44336, 30), linestyle=hline.style_dashed)
middle_line = hline(50, "Middle", color=color.new(#787B86, 50), linestyle=hline.style_dotted)
oversold_line = hline(oversold, "Oversold", color=color.new(#4CAF50, 30), linestyle=hline.style_dashed)

// Background fill
fill(overbought_line, oversold_line, color=show_fill ? fill_color : color.new(color.white, 100), title="Background Fill")

// Alerts
alertcondition(bullish_signal and show_alerts, "CRSI Bullish Signal", "CRSI crossing above oversold level")
alertcondition(bearish_signal and show_alerts, "CRSI Bearish Signal", "CRSI crossing below overbought level")
alertcondition(strong_bullish and show_alerts, "CRSI Strong Bullish", "CRSI rising from oversold territory")
alertcondition(strong_bearish and show_alerts, "CRSI Strong Bearish", "CRSI falling from overbought territory")
