//@version=6
//──────────────────────────────────────────────────────────────────────────────
//  [TL5 Shahnaz] Williams %R + RSI Heatmap + ALMA Trend
//──────────────────────────────────────────────────────────────────────────────
//  DESCRIPTION
//  This indicator combines:
//  • Williams %R momentum oscillator
//  • RSI-based background heatmap for strength / weakness bias
//  • ALMA moving-average stack for trend direction and slope
//
//  HOW TO USE
//  • %R above -40  → bullish momentum
//  • %R below -60  → bearish momentum
//  • Rising %R     → strengthening momentum
//  • RSI heatmap   → background bias (green = strength, red = weakness)
//  • ALMA stack    → trend direction and smooth dynamic support/resistance
//
//  Designed for discretionary trading and trend confirmation.
//──────────────────────────────────────────────────────────────────────────────

indicator(
    title     = "[TL5 Shahnaz] %R + RSI Heatmap + ALMA",
    shorttitle= "[TL5 Shahnaz] %R ALMA",
    overlay   = false,
    format    = format.price,
    precision = 2
)

// ==============================================================================
// INPUTS — WILLIAMS %R
// ==============================================================================
groupWR = "Williams %R Settings"
wrLength = input.int(14, "Lookback Length", minval=1, group=groupWR)
wrSource = input.source(close, "Source", group=groupWR)

// ==============================================================================
// FUNCTION — WILLIAMS %R (Division-by-Zero Safe)
// ==============================================================================
williamsR(len) =>
    highestHigh = ta.highest(len)
    lowestLow   = ta.lowest(len)
    highestHigh == lowestLow ? 0 : 
      100 * (wrSource - highestHigh) / (highestHigh - lowestLow)

// Calculate %R
percentR = williamsR(wrLength)

// ==============================================================================
// %R REFERENCE LEVELS
// ==============================================================================
level0    = plot(0,    title="0")
level20   = plot(-20, title="-20")
level40   = plot(-40, title="-40")
level50   = plot(-50, title="-50", color=color.gray, linewidth=2)
level60   = plot(-60, title="-60")
level80   = plot(-80, title="-80")
level100  = plot(-100,title="-100")

fill(level40, level50, color=color.white)
fill(level50, level60, color=color.yellow)

// ==============================================================================
// RSI HEATMAP — MARKET BIAS
// ==============================================================================
rsiLength = 14
rsiValue  = ta.rsi(close, rsiLength)

// Color scale based on RSI strength / weakness
rsiColor =
     rsiValue > 90 ? color.new(color.lime, 10) :
     rsiValue > 80 ? color.new(color.lime, 20) :
     rsiValue > 70 ? color.new(color.lime, 30) :
     rsiValue > 60 ? color.new(color.lime, 70) :
     rsiValue > 55 ? color.new(color.lime, 80) :
     rsiValue < 10 ? color.new(color.red, 0)  :
     rsiValue < 20 ? color.new(color.red, 30) :
     rsiValue < 30 ? color.new(color.red, 50) :
     rsiValue < 40 ? color.new(color.red, 70) :
     rsiValue < 55 ? color.new(color.red, 80) :
                     color.new(color.gray, 0)

// Apply background heatmap (both panels & overlay)
bgcolor(rsiColor, force_overlay=true)
bgcolor(rsiColor, force_overlay=false)

// Fill %R extreme zones using RSI bias
fill(level0, level20, color=rsiColor)
fill(level80, level100, color=rsiColor)

// ==============================================================================
// %R MOMENTUM COLOR LOGIC
// ==============================================================================
wrColor =
     percentR > -40            ? color.blue  :
     percentR < -60            ? color.red   :
     percentR > percentR[1]    ? color.white :
     percentR < percentR[1]    ? color.yellow:
                                 color.black

barcolor(wrColor)

// ==============================================================================
// %R PLOT
// ==============================================================================
plot(percentR, title="Williams %R", color=wrColor, linewidth=2)

// ==============================================================================
// ALMA TREND STACK
// ==============================================================================
groupALMA = "ALMA Trend Settings"

almaOffset = 0.85
almaSigma  = 8

alma12 = ta.alma(close, 12, almaOffset, almaSigma)
alma14 = ta.alma(close, 14, almaOffset, almaSigma)
alma30 = ta.alma(close, 30, almaOffset, almaSigma)
alma40 = ta.alma(close, 40, almaOffset, almaSigma)
alma90 = ta.alma(close, 90, almaOffset, almaSigma)

// Overlay ALMA lines
plot(alma12, title="ALMA 12", color=wrColor, linewidth=2, force_overlay=true)
plot(alma14, title="ALMA 14", color=wrColor, linewidth=2, force_overlay=true)
plot(alma30, title="ALMA 30", color=percentR > -50 ? color.blue : color.red, linewidth=3, force_overlay=true)
plot(alma40, title="ALMA 40", color=percentR > -50 ? color.blue : color.red, style=plot.style_circles, linewidth=1, force_overlay=true)

// ==============================================================================
// ALMA SLOPE LABEL (LAST BAR ONLY)
// ==============================================================================
almaSlope = alma14 - alma14[1]
var label slopeLabel = na

if barstate.islast
    label.delete(slopeLabel)
    slopeLabel := label.new(
        bar_index + 2,
        close,
        text  = "ALMA Slope: " + str.tostring(math.round(almaSlope, 2)) +
                "\nPrice: " + str.tostring(math.round(close, 4)),
        style = label.style_label_left,
        force_overlay = true
    )

// Shoutout to Biffy — I found the SMA 77 in the “BOSS METHOD TRIBUTE” indicator really helpful.
sma77 = ta.sma(close, 77)
plot(sma77, title = "sma77", color = color.black, linewidth = 2, force_overlay = true)
//──────────────────────────────────────────────────────────────────────────────
//  NOTES
//  • This indicator does NOT generate trading signals by itself.
//  • Intended for confirmation and discretionary analysis.
//  • Works on all markets and timeframes.
//──────────────────────────────────────────────────────────────────────────────
