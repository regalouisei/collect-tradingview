//@version=6
indicator("Adaptive Vol Gauge [ParadoxAlgo]", overlay=true)

// Inputs
base_lookback = input.int(20, "Base Lookback", minval=1)
adapt_factor = input.float(0.5, "Adaptation Factor", minval=0.0, step=0.1)
annualize = input.bool(true, "Annualize Volatility")
sensitivity = input.float(1.0, "Regime Sensitivity", minval=0.1, step=0.1)
show_labels = input.bool(true, "Show Regime Labels")
bg_trans = input.int(80, "Background Transparency", minval=0, maxval=100)
bar_trans = input.int(50, "Bar Transparency", minval=0, maxval=100)

// Compute range factor
short_period = 10
long_period = 100
range_rel = (high - low) / close
short_ar = ta.sma(range_rel, short_period)
long_ar = ta.sma(range_rel, long_period)
range_factor = nz(short_ar / long_ar, 1.0)

// Adaptive n
n_float = base_lookback * math.pow(range_factor, -adapt_factor)
n = math.max(10, math.min(50, math.round(n_float)))

// Volatility calculation
hl_log = math.pow(math.log(high / low), 2)
sum_hl = math.sum(hl_log, n)
vol = math.sqrt(sum_hl / (4 * n * math.log(2)))

// Annualization factor
float ann_factor = na
if timeframe.isintraday
    ann_factor := (252.0 * 390) / timeframe.multiplier
else if timeframe.isdaily
    ann_factor := 252.0
else if timeframe.isweekly
    ann_factor := 52.0
else if timeframe.ismonthly
    ann_factor := 12.0
if annualize and not na(ann_factor)
    vol *= math.sqrt(ann_factor)

// Regime identification
vol_avg = ta.sma(vol, base_lookback)
vol_std = ta.stdev(vol, base_lookback)
zscore = (vol - vol_avg) / vol_std
high_regime = zscore > sensitivity
low_regime = zscore < -sensitivity

// Colors with gradient
col_high = #003ff5
col_low = #00e2ff
vol_color = color.from_gradient(zscore, -sensitivity * 2, sensitivity * 2, col_low, col_high)

// Background
bgcolor(color.new(vol_color, bg_trans))

// Dynamic bar coloring
barcolor(color.new(vol_color, bar_trans))

// Regime labels
if show_labels
    if not high_regime[1] and high_regime
        label.new(bar_index, low, "High Vol", yloc=yloc.price, color=color.new(col_high, 0), style=label.style_label_up, size=size.tiny)
    if not low_regime[1] and low_regime
        label.new(bar_index, high, "Low Vol", yloc=yloc.price, color=color.new(col_low, 0), style=label.style_label_down, size=size.tiny)
