// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © fullmax


//@version=6
strategy(title = 'ST-StochRsi', overlay = true, pyramiding = 0)

//  trail stop inputs
longTrailPerc = input.float(1.5, title = 'Trail Long Loss (%)', minval = 0.0, step = 0.1) * 0.01

shortTrailPerc = input.float(1.5, title = 'Trail Short Loss (%)', minval = 0.0, step = 0.1) * 0.01

//// super trend
atrPeriod = input.int(5, 'ATR Length', minval = 1)
factor = input.float(3.0, 'Factor', minval = 0.01, step = 0.01)
[supertrend, direction] = ta.supertrend(factor, atrPeriod)
supertrend := barstate.isfirst ? na : supertrend
up = direction < 0 ? supertrend : na
dn = direction < 0 ? na : supertrend
plot(up, 'Up Trend', color = color.green, style = plot.style_linebr)
plot(dn, 'Down Trend', color = color.red, style = plot.style_linebr)
//
tradedir = input.string('Both', title = 'Trade Direction', options = ['Long', 'Short', 'Both'])
////Stoch/RSI
smoothK = input.int(3, 'K smooth Stoch/Rsi', minval = 1)
lengthRSI = input.int(20, 'RSI Length', minval = 1)
lengthStoch = input.int(11, 'Stochastic Length', minval = 1)
src = input(close, title = 'RSI Source')
rsi = ta.rsi(src, lengthRSI)
k = ta.sma(ta.stoch(rsi, rsi, rsi, lengthStoch), smoothK)
LB = input(6, 'Low band of ST/RSI for long trade')
HB = input(99, 'High band of ST/RSI for short trade')
///// pivot S/R
S_R = input.bool(true, title = 'Support-Res')
sup = input.int(5, title = 'Lookback (Sup)', minval = 1)
res = input.int(9, title = 'Lookback (Res)', minval = 1)
support = ta.lowest(low[1], sup)
resistan = ta.highest(high[1], res)
entrysup = low >= support
entryres = high <= resistan

///// buy sell signals
b = direction < 0 
s = direction > 0 
buy = k < LB and b
sell = k > HB and s
var Buy = bool(na)
var Sell = bool(na)
buys = entrysup and buy
sells = entryres and sell
if S_R == true
    Buy := buys
    Sell := sells
    Sell
else
    Buy := buy
    Buy

// Determine trail stop
longStopPrice = 0.0
shortStopPrice = 0.0

longStopPrice := if strategy.position_size > 0
    stopValue = close * (1 - longTrailPerc)
    math.max(stopValue, longStopPrice[1])
else
    0

shortStopPrice := if strategy.position_size < 0
    stopValue = close * (1 + shortTrailPerc)
    math.min(stopValue, shortStopPrice[1])
else
    999999

// Plot stop price
plot(strategy.position_size > 0 ? longStopPrice : na, color = color.blue, style = plot.style_circles, linewidth = 1, title = 'Long Trail Stop')
plot(strategy.position_size < 0 ? shortStopPrice : na, color = color.blue, style = plot.style_circles, linewidth = 1, title = 'Short Trail Stop')
//// size of the trade
SZZ = input(1000, title = 'Size of the trade in USD')/close
// strategy orders
if Buy and (tradedir == "Long" or tradedir == "Both")
    strategy.entry('Long', strategy.long, qty = SZZ)

if Sell and (tradedir == "Short" or tradedir == "Both")
    strategy.entry('Short', strategy.short, qty = SZZ)
    
// 
if strategy.position_size > 0 
    strategy.exit('Tp/stop', stop = longStopPrice )


if strategy.position_size < 0
    strategy.exit('Tp/stop', stop = shortStopPrice)
