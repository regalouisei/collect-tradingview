// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Yesid_Correa_Cano

//@version=6
indicator("1D % Change (Histogram)", overlay=false)

//====================
// Inputs
//====================
grpSrc  = "Source"
tfBase  = input.timeframe("D", "Base timeframe", group=grpSrc)

grpCalc = "Calculation"
mode = input.string("Last vs Prev Close", "Method",
     options=["Last vs Prev Close","Close vs Prev Close","Close vs Open"],
     group=grpCalc)

showZero = input.bool(true, "Show zero line?", group=grpCalc)
showTag  = input.bool(true, "Show last value tag?", group=grpCalc)

//====================
// Series (always current chart symbol)
//====================
ticker = syminfo.tickerid

// Daily OHLC for the chart symbol
dOpen  = request.security(ticker, tfBase, open,  barmerge.gaps_off, barmerge.lookahead_off)
dClose = request.security(ticker, tfBase, close, barmerge.gaps_off, barmerge.lookahead_off)
dPrevC = request.security(ticker, tfBase, close[1], barmerge.gaps_off, barmerge.lookahead_off)

// "Last" price from the chart (updates intrabar on intraday charts)
lastPx = close

//====================
// 1D % change
//====================
float pct =
     mode == "Last vs Prev Close"  ? (100.0 * (lastPx - dPrevC) / dPrevC) :
     mode == "Close vs Prev Close" ? (100.0 * (dClose  - dPrevC) / dPrevC) :
                                     (100.0 * (dClose  - dOpen ) / dOpen)

//====================
// Plot
//====================
col = pct >= 0 ? color.lime : color.red
plot(pct, title="1D %", style=plot.style_histogram, linewidth=2, color=col)

plot(0, title="Zero", color=color.new(color.gray, 60), linewidth=1,
     display = showZero ? display.all : display.none)

// Persistent last value tag (no label spam)
var label lv = na
if showTag and barstate.islast
    if na(lv)
        lv := label.new(bar_index, pct, "", style=label.style_label_right,
          textcolor=color.white, color=col)
    label.set_x(lv, bar_index)
    label.set_y(lv, pct)
    label.set_text(lv, str.tostring(pct, format.mintick))
    label.set_color(lv, col)
else if not showTag and not na(lv)
    label.delete(lv)
    lv := na
