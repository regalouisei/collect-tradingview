// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Rob_Maths (Modified for Freshness Check)

//@version=6
// Title: LEVR: Leverage Efficiency & Volume Ratio
// Short Title: LEVR
// Author: Rob_Maths
// Methodology: Quantifies the "Speculative Premium" by comparing Derivatives Open Interest (Gambling) to Active Addresses (Utility).

indicator("BTC – LEVR: Leverage Efficiency & Volume Ratio", shorttitle="BTC – LEVR | RM", format=format.price, precision=2)

// ==========================================
// 1. INPUTS & CONFIGURATION
// ==========================================
grp_sets    = "Calculation Settings"
lookback    = input.int(365, "Z-Score Lookback Period", minval=100, tooltip="Rolling window to normalize the data.", group=grp_sets)
smoothLen   = input.int(7, "Signal Smoothing", minval=1, group=grp_sets)
stale_days  = input.int(3, "Stale Data Threshold (Days)", minval=1, tooltip="If data hasn't updated in this many days, mark as STALE.", group=grp_sets)

grp_zones   = "Zone Settings"
bubble_top  = input.float(3.0, "Bubble Zone Top (Extreme)", step=0.1, group=grp_zones)
bubble_bot  = input.float(2.0, "Bubble Zone Bottom (Warning)", step=0.1, group=grp_zones)
organic_top = input.float(-1.5, "Organic Zone Top (Value)", step=0.1, group=grp_zones)
organic_bot = input.float(-2.5, "Organic Zone Bottom (Deep)", step=0.1, group=grp_zones)

// ==========================================
// 2. DATA FETCHING (IntoTheBlock Data)
// ==========================================
// Fetching [Value, Time] for both metrics
[oi_raw, oi_time]         = request.security("INTOTHEBLOCK:BTC_PERPETUALOPENINTEREST", "D", [close, time], ignore_invalid_symbol=true)
[active_raw, active_time] = request.security("INTOTHEBLOCK:BTC_ACTIVEADDRESSES", "D", [close, time], ignore_invalid_symbol=true)

// ==========================================
// 3. FRESHNESS LOGIC
// ==========================================
ms_threshold = stale_days * 24 * 60 * 60 * 1000
oi_is_live     = (not na(oi_raw)) and (timenow - oi_time < ms_threshold)
active_is_live = (not na(active_raw)) and (timenow - active_time < ms_threshold)
both_live      = oi_is_live and active_is_live

// ==========================================
// 4. MATHEMATICAL CORE
// ==========================================
safe_div(num, den) =>
    den == 0 or na(den) ? 0 : num / den

levr_ratio  = safe_div(oi_raw, active_raw)
levr_smooth = ta.sma(levr_ratio, smoothLen)
mean        = ta.sma(levr_smooth, lookback)
stdDev      = ta.stdev(levr_smooth, lookback)
levr_final  = safe_div((levr_smooth - mean), stdDev)

// ==========================================
// 5. PLOTTING & VISUALS
// ==========================================
// If data is stale, the line turns gray
color line_col = not both_live ? color.gray : levr_final > bubble_bot ? color.red : levr_final < organic_top ? color.blue : color.orange

plot(levr_final, "LEVR Index", color=line_col, linewidth=2)
hline(0, "Zero Line", color=color.gray, linestyle=hline.style_dotted)

// Shaded Zones
h_bub_top = hline(bubble_top, "Bubble Top", color=color.new(color.red, 100)) 
h_bub_bot = hline(bubble_bot, "Bubble Bot", color=color.red, linestyle=hline.style_dashed)
fill(h_bub_top, h_bub_bot, color=color.new(color.red, 85), title="Speculative Bubble Fill")

h_org_top = hline(organic_top, "Organic Top", color=color.green, linestyle=hline.style_dashed)
h_org_bot = hline(organic_bot, "Organic Bot", color=color.new(color.green, 100)) 
fill(h_org_top, h_org_bot, color=color.new(color.green, 85), title="Organic Value Fill")

// ==========================================
// 6. STATUS TABLES
// ==========================================
var table tbl_bub_label = table.new(position.top_left, 2, 2, bgcolor=color.new(color.black, 100))
var table tbl_org_label = table.new(position.bottom_left, 2, 2, bgcolor=color.new(color.black, 100))

if barstate.islast
    table.cell(tbl_bub_label, 1, 1, "SPECULATIVE PREMIUM\n(RISK ON)", text_color=color.white, bgcolor=color.new(color.red, 20), text_size=size.normal)
    table.cell(tbl_org_label, 1, 0, "ORGANIC BASE\n(RISK OFF)", text_color=color.white, bgcolor=color.new(color.green, 20), text_size=size.normal)

var table infoTable = table.new(position.bottom_right, 2, 4, border_width=1)
if barstate.islast
    table.cell(infoTable, 0, 0, "LEVR Data Check", bgcolor=color.gray, text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, "Status", bgcolor=color.gray, text_color=color.white, text_size=size.small)
    
    // OI Status
    table.cell(infoTable, 0, 1, "Open Interest (Spec)", bgcolor=color.black, text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 1, oi_is_live ? "LIVE" : "STALE", bgcolor=oi_is_live ? color.green : color.red, text_color=color.white, text_size=size.small)
    
    // Active Addresses Status
    table.cell(infoTable, 0, 2, "Active Addr (Util)", bgcolor=color.black, text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 2, active_is_live ? "LIVE" : "STALE", bgcolor=active_is_live ? color.green : color.red, text_color=color.white, text_size=size.small)
    
    // Warning Row if anything is dead
    if not both_live
        table.cell(infoTable, 0, 3, "WARNING:", bgcolor=color.maroon, text_color=color.white, text_size=size.small)
        table.cell(infoTable, 1, 3, "DATA OUTDATED", bgcolor=color.maroon, text_color=color.white, text_size=size.small)
