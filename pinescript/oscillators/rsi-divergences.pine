// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Genz_bulltrader (Evolvex)

//@version=6
indicator("RSI Divergences", shorttitle="RSID", format=format.price, precision=2)

// ─── Inputs ──────────────────────────────────────────────────────────────────
rsiLen      = input.int(14, "RSI Period", minval=1, step=1)
srcName     = input.string("close", "RSI Source", options=["close","hlc3","ohlc4","typical","weighted"])
lbL         = input.int(10, "Pivot Lookback Left", minval=1, step=1)
lbR         = input.int(10, "Pivot Lookback Right", minval=1, step=1)
rangeUpper  = input.int(100, "Max of Lookback Range", minval=2, step=1)
rangeLower  = input.int(5, "Min of Lookback Range", minval=1, step=1)

signalMode  = input.string("Regular Only", "Signals", options=["Regular Only","Hidden Only","All","None"])

showLines   = input.bool(true, "Show Divergence Lines")
showForming = input.bool(true, "Show Forming?")
showMarks   = input.bool(true, "Show Pivot Markers")
lineWidth   = input.int(2, "Line Width", minval=1, maxval=4)

// New input for background opacity
bgOpacity   = input.int(70, "Background Transparency", minval=0, maxval=95, tooltip="Lower = more visible (60-75 recommended)")

// ─── Colors ──────────────────────────────────────────────────────────────────
colRSI   = #FFA500
colGuide = #787B86
colBull  = #00C27A
colBear  = #E05A5A
colHBull = #61D8A6
colHBear = #F08C8C

// ─── Source Selection ────────────────────────────────────────────────────────
src = switch srcName
    "close"    => close
    "hlc3"     => hlc3
    "ohlc4"    => ohlc4
    "typical"  => hlc3
    "weighted" => hlcc4

// ─── RSI Calculation ─────────────────────────────────────────────────────────
rsiS = ta.rsi(src, rsiLen)

// ─── Pivot Detection ─────────────────────────────────────────────────────────
pivotLow  = ta.pivotlow(rsiS, lbL, lbR)
pivotHigh = ta.pivothigh(rsiS, lbL, lbR)

// ─── Storage Arrays ──────────────────────────────────────────────────────────
var array<line> bullRegLines = array.new<line>()
var array<line> bearRegLines = array.new<line>()
var array<line> bullHidLines = array.new<line>()
var array<line> bearHidLines = array.new<line>()
var array<line> bullFormLines = array.new<line>()
var array<line> bearFormLines = array.new<line>()

var array<label> bullLabels = array.new<label>()
var array<label> bearLabels = array.new<label>()
var array<label> hBullLabels = array.new<label>()
var array<label> hBearLabels = array.new<label>()

// ─── Last Pivot Storage ──────────────────────────────────────────────────────
var float lastPL_rsi = na
var int lastPL_idx = na
var float lastPL_price = na

var float lastPH_rsi = na
var int lastPH_idx = na
var float lastPH_price = na

// ─── Signal Mode Flags ───────────────────────────────────────────────────────
wantReg    = (signalMode == "Regular Only" or signalMode == "All")
wantHidden = (signalMode == "Hidden Only" or signalMode == "All")

// Improved forming lookback - closer to actual pivot detection
FORMING_LOOKBACK = math.max(5, math.floor(lbR * 0.6))

// ─── Helper Function: Is Forming Pivot ──────────────────────────────────────
is_forming_pivot(int lookback, float priceVal, bool isHigh) =>
    result = true
    if bar_index < lookback
        result := false
    else
        for k = 1 to lookback
            comparePrice = isHigh ? high[k] : low[k]
            if isHigh and comparePrice > priceVal
                result := false
                break
            if not isHigh and comparePrice < priceVal
                result := false
                break
    result

// ─── Process Pivot Low ───────────────────────────────────────────────────────
if not na(pivotLow)
    currentRsi = rsiS[lbR]
    currentPrice = low[lbR]
    currentIdx = bar_index - lbR
    
    if not na(lastPL_idx)
        bars = currentIdx - lastPL_idx
        if bars >= rangeLower and bars <= rangeUpper
            rsiHL = currentRsi > lastPL_rsi
            rsiLL = currentRsi < lastPL_rsi
            priceLL = currentPrice < lastPL_price
            priceHL = currentPrice > lastPL_price
            
            // Regular Bullish
            if wantReg and priceLL and rsiHL
                if showLines
                    array.push(bullRegLines, line.new(lastPL_idx, lastPL_rsi, currentIdx, currentRsi, 
                         color=color.new(colBull, 20), width=lineWidth, style=line.style_solid))
                if showMarks
                    array.push(bullLabels, label.new(currentIdx, currentRsi, "●", 
                         style=label.style_none, color=colBull, textcolor=colBull, size=size.large, 
                         textalign=text.align_center))
            
            // Hidden Bullish
            if wantHidden and priceHL and rsiLL
                if showLines
                    array.push(bullHidLines, line.new(lastPL_idx, lastPL_rsi, currentIdx, currentRsi, 
                         color=color.new(colHBull, 50), width=lineWidth, style=line.style_solid))
                if showMarks
                    array.push(hBullLabels, label.new(currentIdx, currentRsi, "●", 
                         style=label.style_none, color=colHBull, textcolor=colHBull, size=size.normal,
                         textalign=text.align_center))
    
    lastPL_idx := currentIdx
    lastPL_rsi := currentRsi
    lastPL_price := currentPrice

// ─── Process Pivot High ──────────────────────────────────────────────────────
if not na(pivotHigh)
    currentRsi = rsiS[lbR]
    currentPrice = high[lbR]
    currentIdx = bar_index - lbR
    
    if not na(lastPH_idx)
        bars = currentIdx - lastPH_idx
        if bars >= rangeLower and bars <= rangeUpper
            rsiLH = currentRsi < lastPH_rsi
            rsiHH = currentRsi > lastPH_rsi
            priceHH = currentPrice > lastPH_price
            priceLH = currentPrice < lastPH_price
            
            // Regular Bearish
            if wantReg and priceHH and rsiLH
                if showLines
                    array.push(bearRegLines, line.new(lastPH_idx, lastPH_rsi, currentIdx, currentRsi, 
                         color=color.new(colBear, 20), width=lineWidth, style=line.style_solid))
                if showMarks
                    array.push(bearLabels, label.new(currentIdx, currentRsi, "●", 
                         style=label.style_none, color=colBear, textcolor=colBear, size=size.large,
                         textalign=text.align_center))
            
            // Hidden Bearish
            if wantHidden and priceLH and rsiHH
                if showLines
                    array.push(bearHidLines, line.new(lastPH_idx, lastPH_rsi, currentIdx, currentRsi, 
                         color=color.new(colHBear, 50), width=lineWidth, style=line.style_solid))
                if showMarks
                    array.push(hBearLabels, label.new(currentIdx, currentRsi, "●", 
                         style=label.style_none, color=colHBear, textcolor=colHBear, size=size.normal,
                         textalign=text.align_center))
    
    lastPH_idx := currentIdx
    lastPH_rsi := currentRsi
    lastPH_price := currentPrice

// ─── Forming Divergences ─────────────────────────────────────────────────────
if showForming and barstate.islast
    // Clean up old forming lines
    if array.size(bullFormLines) > 0
        for i = 0 to array.size(bullFormLines) - 1
            line.delete(array.get(bullFormLines, i))
        array.clear(bullFormLines)
    
    if array.size(bearFormLines) > 0
        for i = 0 to array.size(bearFormLines) - 1
            line.delete(array.get(bearFormLines, i))
        array.clear(bearFormLines)
    
    // Check for forming bearish divergence
    if not na(lastPH_idx)
        for i = 0 to 50
            if bar_index - i <= lastPH_idx
                break
            if is_forming_pivot(FORMING_LOOKBACK, high[i], true)
                potentialRsi = rsiS[i]
                potentialPrice = high[i]
                potentialIdx = bar_index - i
                
                // Check if bars between pivots is in valid range
                bars = potentialIdx - lastPH_idx
                if bars >= rangeLower and bars <= rangeUpper
                    priceHH = potentialPrice > lastPH_price
                    priceLH = potentialPrice < lastPH_price
                    rsiLH = potentialRsi < lastPH_rsi
                    rsiHH = potentialRsi > lastPH_rsi
                    
                    if (wantReg and priceHH and rsiLH) or (wantHidden and priceLH and rsiHH)
                        array.push(bearFormLines, line.new(lastPH_idx, lastPH_rsi, potentialIdx, potentialRsi, 
                             color=color.new(colBear, 10), width=lineWidth, style=line.style_dotted))
                break
    
    // Check for forming bullish divergence
    if not na(lastPL_idx)
        for i = 0 to 50
            if bar_index - i <= lastPL_idx
                break
            if is_forming_pivot(FORMING_LOOKBACK, low[i], false)
                potentialRsi = rsiS[i]
                potentialPrice = low[i]
                potentialIdx = bar_index - i
                
                // Check if bars between pivots is in valid range
                bars = potentialIdx - lastPL_idx
                if bars >= rangeLower and bars <= rangeUpper
                    priceLL = potentialPrice < lastPL_price
                    priceHL = potentialPrice > lastPL_price
                    rsiHL = potentialRsi > lastPL_rsi
                    rsiLL = potentialRsi < lastPL_rsi
                    
                    if (wantReg and priceLL and rsiHL) or (wantHidden and priceHL and rsiLL)
                        array.push(bullFormLines, line.new(lastPL_idx, lastPL_rsi, potentialIdx, potentialRsi, 
                             color=color.new(colBull, 10), width=lineWidth, style=line.style_dotted))
                break

// ─── Background Zones (Overbought/Oversold) - IMPROVED VISIBILITY ───────────
// Overbought zone (70-100) - More visible red tint
obColor = rsiS >= 70 ? color.new(#E05A5A, bgOpacity) : na
bgcolor(obColor, title="Overbought Zone")

// Oversold zone (0-30) - More visible green tint
osColor = rsiS <= 30 ? color.new(#00C27A, bgOpacity) : na
bgcolor(osColor, title="Oversold Zone")

// ─── Horizontal Lines ────────────────────────────────────────────────────────
// Key 50 level - Most prominent
hline(50, "Midline", color=color.new(colGuide, 0), linestyle=hline.style_solid, linewidth=2)

// Overbought/Oversold boundaries - More visible
hline(70, "Overbought", color=color.new(#E05A5A, 20), linestyle=hline.style_solid, linewidth=2)
hline(30, "Oversold", color=color.new(#00C27A, 20), linestyle=hline.style_solid, linewidth=2)

// Additional reference lines
hline(80, "", color=color.new(#E05A5A, 10), linestyle=hline.style_dotted, linewidth=1)
hline(20, "", color=color.new(#00C27A, 10), linestyle=hline.style_dotted, linewidth=1)

// ─── RSI Plot ────────────────────────────────────────────────────────────────
plot(rsiS, "RSI", color=colRSI, linewidth=2)

// ─── Line Management (limit total lines to prevent memory issues) ────────────
if barstate.islast
    MAX_LINES = 100
    
    if array.size(bullRegLines) > MAX_LINES
        line.delete(array.shift(bullRegLines))
    if array.size(bearRegLines) > MAX_LINES
        line.delete(array.shift(bearRegLines))
    if array.size(bullHidLines) > MAX_LINES
        line.delete(array.shift(bullHidLines))
    if array.size(bearHidLines) > MAX_LINES
        line.delete(array.shift(bearHidLines))
    
    if array.size(bullLabels) > MAX_LINES
        label.delete(array.shift(bullLabels))
    if array.size(bearLabels) > MAX_LINES
        label.delete(array.shift(bearLabels))
    if array.size(hBullLabels) > MAX_LINES
        label.delete(array.shift(hBullLabels))
    if array.size(hBearLabels) > MAX_LINES
        label.delete(array.shift(hBearLabels))
