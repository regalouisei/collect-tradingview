//@version=6
indicator("AccDist MACD Dual + Stoch RSI Zero‑Line Alerts", shorttitle="MACD+STOCH Alerts", overlay=false)

// === INPUTS ===
smd             = input.bool(true, "Show MACD Lines?")
histColor4Mode  = input.bool(true, "4‑Color Mode for MACD2 Lines?")
showZeroLine    = input.bool(true, "Show Zero Line?")

// MACD1 Inputs
fast1   = input.int(12, minval=1, title="MACD1 Fast Length")
slow1   = input.int(26, minval=1, title="MACD1 Slow Length")
sig1    = input.int(9,  minval=1, title="MACD1 Signal Length")

// Stoch RSI Inputs
smoothK     = input.int(3,  title="Stoch RSI K Smoothing")
lengthRSI   = input.int(14, title="Stoch RSI RSI Length")
lengthStoch = input.int(14, title="Stoch RSI Length")
rsiSrc      = input.source(close, "RSI Source")
upperLevel  = input.float(99.9, title="Upper Level")
lowerLevel  = input.float(0.2,  title="Lower Level")
showStochLabels = input.bool(true, "Show Stoch RSI Alert Labels?")

// Label colors
labelColorUp   = color.new(#0bf814, 0)   // Green
labelColorDown = color.new(#ff0b0b, 0)   // Red

// === ACCUMULATION / DISTRIBUTION CALC ===
ad = ta.cum((close == high and close == low) or (high == low) ? 0.0 :
     ((2 * close - low - high) / (high - low)) * volume)

// === MACD #1 ===
fastMA1 = ta.ema(ad, fast1)
slowMA1 = ta.ema(ad, slow1)
macd1   = fastMA1 - slowMA1
signal1 = ta.sma(macd1, sig1)

macd1_color = macd1 >= signal1 ? color.blue : color.new(color.orange, 0)

p_macd1   = plot(smd ? macd1 : na, title="MACD 1", color=macd1_color, linewidth=2)
p_sig1    = plot(smd ? signal1 : na, title="MACD1 Signal", color=color.new(macd1_color, 25))
fill(p_macd1, p_sig1, color=color.new(macd1_color, 25))

// === MACD #2 ===
const int fast2 = 48
const int slow2 = 104
const int sig2  = 36

fastMA2 = ta.ema(ad, fast2)
slowMA2 = ta.ema(ad, slow2)
macd2   = fastMA2 - slowMA2
signal2 = ta.sma(macd2, sig2)

// === MACD2 4-COLOR FUNCTION ===
f_macd2Color(_macd, _signal) =>
    float hist = _macd - _signal
    color result = color.gray
    if hist > 0 and hist > hist[1]
        result := color.new(#0ed100, 0)   // rising green
    else if hist > 0 and hist <= hist[1]
        result := color.new(#b8b8b8, 0)   // falling green/gray
    else if hist <= 0 and hist < hist[1]
        result := color.new(#c90000, 0)   // falling red
    else
        result := color.new(#fccbcd, 0)   // rising red/light
    result

macd2_color   = histColor4Mode ? f_macd2Color(macd2, signal2) : (macd2 >= signal2 ? color.lime : color.red)
signal2_color = histColor4Mode ? f_macd2Color(macd2, signal2) : color.new(macd2_color, 25)

p_macd2   = plot(smd ? macd2 : na, title="MACD 2", color=macd2_color, linewidth=2)
p_sig2    = plot(smd ? signal2 : na, title="MACD2 Signal", color=signal2_color, linewidth=2)
fill(p_macd2, p_sig2, color=color.new(macd2_color, 25))

// === ZERO LINE (GLOBAL SCOPE) ===
hline_color = showZeroLine ? color.gray : na
hline(0.0, "Zero Line", color=hline_color, linestyle=hline.style_solid, linewidth=2)

// === STOCH RSI CALCULATION ===
rsiValue = ta.rsi(rsiSrc, lengthRSI)
kLine    = ta.sma(ta.stoch(rsiValue, rsiValue, rsiValue, lengthStoch), smoothK)

// State tracking
var bool wasAboveUpper = false
var bool wasBelowLower = false

if kLine > upperLevel
    wasAboveUpper := true
if kLine < lowerLevel
    wasBelowLower := true

crossBackDown = wasAboveUpper and kLine < upperLevel
crossBackUp   = wasBelowLower and kLine > lowerLevel

if crossBackDown
    wasAboveUpper := false
if crossBackUp
    wasBelowLower := false

// === LABELS AT ZERO LINE ===
if showStochLabels and crossBackDown
    label.new(bar_index, 0.0, "", style=label.style_label_center,
      color=labelColorDown, textcolor=labelColorDown, size=size.tiny)

if showStochLabels and crossBackUp
    label.new(bar_index, 0.0, "", style=label.style_label_center,
      color=labelColorUp, textcolor=labelColorUp, size=size.tiny)
