//@version=5
indicator("BH Ergodic (TSI-style) [v5]", shorttitle="BH Ergodic", overlay=false, timeframe="", timeframe_gaps=true)

// ── Inputs
src = input.source(close, "Source")
lenFast = input.int(25, "First Smoothing (r)", minval=1)
lenSlow = input.int(13, "Second Smoothing (s)", minval=1)
lenSignal = input.int(7, "Signal Length", minval=1)
showHist = input.bool(true, "Show Histogram")

// ── Core (True Strength Index formulation = Bill Blau Ergodic style)
mtm = src - src[1]
mtmE1 = ta.ema(mtm, lenFast)
mtmE2 = ta.ema(mtmE1, lenSlow)

absmE1 = ta.ema(math.abs(mtm), lenFast)
absmE2 = ta.ema(absmE1, lenSlow)

// Avoid division by zero
tsi_raw = absmE2 != 0 ? 100 * (mtmE2 / absmE2) : 0.0

// Signal line (EMA of main)
signal = ta.ema(tsi_raw, lenSignal)

// ── Visualization
h = tsi_raw - signal
colHist = h >= 0 ? color.new(color.teal, 0) : color.new(color.red, 0)
colLine = tsi_raw >= signal ? color.new(color.teal, 0) : color.new(color.red, 0)

plot(0, "Zero", color=color.new(color.gray, 70))
plot(tsi_raw, "BH Ergodic", color=colLine, linewidth=2)
plot(signal, "Signal", color=color.new(color.orange, 0), linewidth=2, style=plot.style_line)

plot(showHist ? h : na, "Hist (Main - Signal)", style=plot.style_columns, color=colHist)

// ── Signals
bullCross = ta.crossover(tsi_raw, signal)
bearCross = ta.crossunder(tsi_raw, signal)

// ── Alerts
alertcondition(bullCross, title="Bullish Cross", message="BH Ergodic crossed UP the Signal")
alertcondition(bearCross, title="Bearish Cross", message="BH Ergodic crossed DOWN the Signal")

// ── Handy plotshapes for crosses
plotshape(bullCross, title="Bullish Cross", style=shape.triangleup, color=color.new(color.teal, 0), location=location.bottom, size=size.tiny, text="▲")
plotshape(bearCross, title="Bearish Cross", style=shape.triangledown, color=color.new(color.red, 0), location=location.top, size=size.tiny, text="▼")

// ── Notes:
// • This implements BH-Ergodic using the True Strength Index formulation:
// TSI = 100 * EMA(EMA(momentum, r), s) / EMA(EMA(|momentum|, r), s)
// • Typical defaults (25,13,7). Increase r/s to smooth more, decrease for faster response.
// • Signals: main above signal and >0 favors bullish momentum; below signal and <0 favors bearish.
