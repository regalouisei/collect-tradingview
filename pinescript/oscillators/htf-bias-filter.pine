//@version=6
indicator("HTF Bias Filter – Truly Locked & Replay-Proof", overlay=true, max_lines_count=500)

// ────── Inputs ──────
tf_1h      = input.timeframe("60",  "1H Timeframe")
tf_4h      = input.timeframe("240", "4H Timeframe")
len_ema_21 = input.int(21, "1H EMA Length")
len_ema_50 = input.int(50, "4H EMA Length")
len_obv    = input.int(21, "OBV EMA Smooth Length")
len_rsi    = input.int(14, "RSI Length")
src        = input.source(close, "Source")

// ────── LOCKED HTF VALUES (Replay-safe) ──────
ema_1h = request.security(syminfo.tickerid, tf_1h, ta.ema(src, len_ema_21)[1], gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
dir_1h = request.security(
     syminfo.tickerid, tf_1h,
     ta.ema(src, len_ema_21)[1] > ta.ema(src, len_ema_21)[6] ? "UP" :
     ta.ema(src, len_ema_21)[1] < ta.ema(src, len_ema_21)[6] ? "DOWN" : "FLAT",
     gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off
)

ema_4h = request.security(syminfo.tickerid, tf_4h, ta.ema(src, len_ema_50)[1], gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
dir_4h = request.security(
     syminfo.tickerid, tf_4h,
     ta.ema(src, len_ema_50)[1] > ta.ema(src, len_ema_50)[10] ? "UP" :
     ta.ema(src, len_ema_50)[1] < ta.ema(src, len_ema_50)[10] ? "DOWN" : "FLAT",
     gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off
)

/// True 4H OBV trend (manual OBV inside HTF security)
dir_obv = request.security(
     syminfo.tickerid, tf_4h,
     // Manual OBV: cumulative sign(change(src)) * volume
     ta.ema(ta.cum(math.sign(ta.change(src)) * volume), len_obv)[1] >
     ta.ema(ta.cum(math.sign(ta.change(src)) * volume), len_obv)[10] ? "UP" :
     ta.ema(ta.cum(math.sign(ta.change(src)) * volume), len_obv)[1] <
     ta.ema(ta.cum(math.sign(ta.change(src)) * volume), len_obv)[10] ? "DOWN" : "FLAT",
     gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off
)


dir_price_vs_ema = request.security(
     syminfo.tickerid, tf_4h,
     close[1] > ta.ema(src, len_ema_50)[1] ? "BUY" : close[1] < ta.ema(src, len_ema_50)[1] ? "SELL" : "FLAT",
     gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off
)

dir_rsi = request.security(
     syminfo.tickerid, tf_4h,
     ta.rsi(src, len_rsi)[1] > 50 ? "BUY" : ta.rsi(src, len_rsi)[1] < 50 ? "SELL" : "FLAT",
     gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off
)

// ────── Plots ──────
plot(ema_1h, "1H EMA 21", color=color.purple, linewidth=2, style=plot.style_stepline)
plot(ema_4h, "4H EMA 50", color=color.red,    linewidth=2, style=plot.style_stepline)

// ────── Confluence Background ──────
bullish = dir_4h == "UP" and dir_obv == "UP" and dir_price_vs_ema == "BUY" and dir_rsi == "BUY"
bearish = dir_4h == "DOWN" and dir_obv == "DOWN" and dir_price_vs_ema == "SELL" and dir_rsi == "SELL"
bg = bullish ? color.new(color.lime, 70) : bearish ? color.new(color.red, 70) : color.new(color.gray, 80)

// ────── FINAL TABLE – Dark + Big Primary/Secondary Headings ──────
var table t = table.new(position.bottom_right, 2, 9, border_width=1, bgcolor=color.new(#0D1117, 15))

if barstate.islast
    table.cell(t, 0, 0, "BIAS FILTER", bgcolor=bg, text_color=color.white, text_size=size.large)
    table.merge_cells(t, 0, 0, 1, 0)

    table.cell(t, 0, 1, "Primary", text_color=color.yellow, text_size=size.large)
    table.merge_cells(t, 0, 1, 1, 1)

    table.cell(t, 0, 2, "4H EMA 50", text_color=color.white)
    table.cell(t, 1, 2, dir_4h, text_color=dir_4h=="UP" ? color.lime : color.red, text_size=size.normal)

    table.cell(t, 0, 3, "1H EMA 21", text_color=color.white)
    table.cell(t, 1, 3, dir_1h, text_color=dir_1h=="UP" ? color.lime : color.red, text_size=size.normal)

    table.cell(t, 0, 4, "Secondary", text_color=color.aqua, text_size=size.large)
    table.merge_cells(t, 0, 4, 1, 4)

    table.cell(t, 0, 5, "4H OBV Trend", text_color=color.white)
    table.cell(t, 1, 5, dir_obv, text_color=dir_obv=="UP" ? color.lime : color.red)

    table.cell(t, 0, 6, "4H Price vs EMA", text_color=color.white)
    table.cell(t, 1, 6, dir_price_vs_ema, text_color=dir_price_vs_ema=="BUY" ? color.lime : color.red)

    table.cell(t, 0, 7, "4H RSI >50", text_color=color.white)
    table.cell(t, 1, 7, dir_rsi, text_color=dir_rsi=="BUY" ? color.lime : color.red)
