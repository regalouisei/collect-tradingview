//@version=6
indicator("SCR Signals", overlay=true, max_labels_count=500)

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// Inputs
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
groupSt = "Stochastic"
kLen     = input.int(5,  "%K 길이",   minval=1, group=groupSt)
kSmooth  = input.int(1,  "%K 스무딩", minval=1, group=groupSt)
dSmooth  = input.int(3,  "%D 스무딩", minval=1, group=groupSt)
stBasis  = input.string("%K", "신호 기준선", options=["%K","%D"], group=groupSt)
stUpper  = input.float(80.0, "과매수(Upper)", minval=0, maxval=100, group=groupSt)
stLower  = input.float(20.0, "과매도(Lower)", minval=0, maxval=100, group=groupSt)

groupC = "CCI"
cciLen   = input.int(20, "길이", minval=1, group=groupC)
cciUpper = input.float(100.0,  "과매수(Upper)", group=groupC)
cciLower = input.float(-100.0, "과매도(Lower)", group=groupC)

groupR = "RSI"
rsiLen   = input.int(14, "길이", minval=1, group=groupR)
rsiUpper = input.float(70.0, "과매수(Upper)", minval=0, maxval=100, group=groupR)
rsiLower = input.float(30.0, "과매도(Lower)", minval=0, maxval=100, group=groupR)

groupS = "Signals"
showSignals   = input.bool(true, "시그널 표시", group=groupS)
confirmedOnly = input.bool(true, "확정봉에서만 신호", group=groupS)
showRsiArrows = input.bool(true, "RSI 전용 화살표(↓/↑)", group=groupS)

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// Calculations (표시용 plot 없음: 계산만)
// ✅ 핵심 수정: ta.stoch(source, high, low, length) -> source는 close
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
kRaw = ta.stoch(close, high, low, kLen)     // ✅ FIXED
k    = ta.sma(kRaw, kSmooth)
d    = ta.sma(k, dSmooth)
stSig = stBasis == "%K" ? k : d

cci = ta.cci(hlc3, cciLen)
rsi = ta.rsi(close, rsiLen)

okBar = not confirmedOnly or barstate.isconfirmed

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// Events (동시에 = 같은 봉에서 이벤트 발생한 개수)
//  - 과매수 해소: Upper 위→아래 (crossunder Upper)
//  - 과매도 해소: Lower 아래→위 (crossover Lower)
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
st_ob_resolve  = okBar and ta.crossunder(stSig, stUpper)
cci_ob_resolve = okBar and ta.crossunder(cci,   cciUpper)
rsi_ob_resolve = okBar and ta.crossunder(rsi,   rsiUpper)

st_os_resolve  = okBar and ta.crossover(stSig, stLower)
cci_os_resolve = okBar and ta.crossover(cci,   cciLower)
rsi_os_resolve = okBar and ta.crossover(rsi,   rsiLower)

obCount = (st_ob_resolve ? 1 : 0) + (cci_ob_resolve ? 1 : 0) + (rsi_ob_resolve ? 1 : 0)
osCount = (st_os_resolve ? 1 : 0) + (cci_os_resolve ? 1 : 0) + (rsi_os_resolve ? 1 : 0)

S1 = obCount == 1
S2 = obCount == 2
S3 = obCount == 3

B1 = osCount == 1
B2 = osCount == 2
B3 = osCount == 3

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// Plot signals on MAIN chart only
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
sigSize = size.small
bgTransparent = color.new(color.black, 100)

// S (과매수 해소) → 캔들 위
plotshape(showSignals and S1, title="S1 (▽)", text="▽", style=shape.labeldown, location=location.abovebar,
     color=bgTransparent, textcolor=color.red, size=sigSize, force_overlay=true)
plotshape(showSignals and S2, title="S2 (▼)", text="▼", style=shape.labeldown, location=location.abovebar,
     color=bgTransparent, textcolor=color.red, size=sigSize, force_overlay=true)
plotshape(showSignals and S3, title="S3 (↓)", text="↓", style=shape.labeldown, location=location.abovebar,
     color=bgTransparent, textcolor=color.red, size=sigSize, force_overlay=true)

// B (과매도 해소) → 캔들 아래
plotshape(showSignals and B1, title="B1 (△)", text="△", style=shape.labelup, location=location.belowbar,
     color=bgTransparent, textcolor=color.lime, size=sigSize, force_overlay=true)
plotshape(showSignals and B2, title="B2 (▲)", text="▲", style=shape.labelup, location=location.belowbar,
     color=bgTransparent, textcolor=color.lime, size=sigSize, force_overlay=true)
plotshape(showSignals and B3, title="B3 (↑)", text="↑", style=shape.labelup, location=location.belowbar,
     color=bgTransparent, textcolor=color.lime, size=sigSize, force_overlay=true)

// RSI special arrows (요청사항 유지)
plotshape(showSignals and showRsiArrows and rsi_ob_resolve, title="RSI OB Resolve (↓)", text="↓",
     style=shape.labeldown, location=location.abovebar,
     color=bgTransparent, textcolor=color.red, size=sigSize, force_overlay=true)

plotshape(showSignals and showRsiArrows and rsi_os_resolve, title="RSI OS Resolve (↑)", text="↑",
     style=shape.labelup, location=location.belowbar,
     color=bgTransparent, textcolor=color.lime, size=sigSize, force_overlay=true)
