//@version=6
indicator("Zone Tap Counter: Support & Resistance Strength", overlay=true, max_labels_count=100, max_lines_count=100)

// ==== SETTINGS ====
swingLen       = input.int(7, "Swing Length", minval=2)
zoneTolPct     = input.float(0.15, "Tap Tolerance (%)", minval=0.01, step=0.01)
minStrength    = input.int(2, "Highlight If Taps â‰¥", minval=2)
maxZoneHistory = input.int(5, "Max Simultaneous Zones", minval=1, maxval=10)

// ==== ARRAYS FOR ZONES AND COUNTS ====
var array<float> resistLevels  = array.new<float>()  // resistance zone level (swing high)
var array<int>   resistTaps    = array.new<int>()   // tap count for each resistance
var array<int>   resistStart   = array.new<int>()   // bar_index where resistance zone started

var array<float> supportLevels = array.new<float>() // support zone level (swing low)
var array<int>   supportTaps   = array.new<int>()  // tap count for each support
var array<int>   supportStart  = array.new<int>()  // bar_index where support zone started

// ==== DETECT SWINGS TO DEFINE ZONES ====
swingHigh = ta.pivothigh(high, swingLen, swingLen)
swingLow  = ta.pivotlow(low, swingLen, swingLen)

if not na(swingHigh)
    array.unshift(resistLevels, swingHigh)
    array.unshift(resistTaps, 0)
    array.unshift(resistStart, bar_index[swingLen])
    if array.size(resistLevels) > maxZoneHistory
        array.pop(resistLevels), array.pop(resistTaps), array.pop(resistStart)
if not na(swingLow)
    array.unshift(supportLevels, swingLow)
    array.unshift(supportTaps, 0)
    array.unshift(supportStart, bar_index[swingLen])
    if array.size(supportLevels) > maxZoneHistory
        array.pop(supportLevels), array.pop(supportTaps), array.pop(supportStart)

// ==== TOLERANCE FOR TAPS ====
tapTol = close * zoneTolPct / 100

// ==== COUNT TAPS FOR EACH ZONE (UNIQUE BARS ONLY) ====
if array.size(resistLevels) > 0
    for i = 0 to array.size(resistLevels)-1
        level = array.get(resistLevels, i)
        tapped = math.abs(high - level) <= tapTol
        // Only increment if price touched this bar and didn't already tap last bar
        if tapped
            prevTaps = array.get(resistTaps, i)
            wasTappedPrev = (bar_index > 0) ? (math.abs(high[1] - level) <= tapTol) : false
            if not wasTappedPrev
                array.set(resistTaps, i, prevTaps + 1)

if array.size(supportLevels) > 0
    for i = 0 to array.size(supportLevels)-1
        level = array.get(supportLevels, i)
        tapped = math.abs(low - level) <= tapTol
        if tapped
            prevTaps = array.get(supportTaps, i)
            wasTappedPrev = (bar_index > 0) ? (math.abs(low[1] - level) <= tapTol) : false
            if not wasTappedPrev
                array.set(supportTaps, i, prevTaps + 1)

// ==== DRAW ZONES WITH TAP-BASED STRENGTH (DARKER = STRONGER) ====

// Resistance Zones
resLabelsShown = 0
if barstate.islast and array.size(resistLevels) > 0
    for i = 0 to array.size(resistLevels)-1
        taps = array.get(resistTaps, i)
        level = array.get(resistLevels, i)
        startIdx = array.get(resistStart, i)
        strengthAlpha = math.max(90 - taps * 18, 20)
        if taps >= minStrength
            line.new(startIdx, level, bar_index, level, color=color.new(color.red, strengthAlpha), width=2)
            if resLabelsShown < maxZoneHistory
                label.new(bar_index, level, str.tostring(taps) + "x", style=label.style_label_down, color=color.red, textcolor=color.white, size=size.tiny)
                resLabelsShown += 1

// Support Zones
supLabelsShown = 0
if barstate.islast and array.size(supportLevels) > 0
    for i = 0 to array.size(supportLevels)-1
        taps = array.get(supportTaps, i)
        level = array.get(supportLevels, i)
        startIdx = array.get(supportStart, i)
        strengthAlpha = math.max(90 - taps * 18, 20)
        if taps >= minStrength
            line.new(startIdx, level, bar_index, level, color=color.new(color.green, strengthAlpha), width=2)
            if supLabelsShown < maxZoneHistory
                label.new(bar_index, level, str.tostring(taps) + "x", style=label.style_label_up, color=color.green, textcolor=color.white, size=size.tiny)
                supLabelsShown += 1
