//@version=5
indicator("Hidden Divergence with BB & Triple Filter", overlay=true, max_bars_back=500)

// --- Inputs ---
bbLength = input.int(20, "BB Length")
bbMult   = input.float(2.0, "BB StdDev")
rsiLen   = input.int(14, "RSI Length")
lookback = 5 // Lookback for swing points

// --- Calculations ---
[basis, upper, lower] = ta.bb(close, bbLength, bbMult)
rsiVal = ta.rsi(close, rsiLen)

// BB Half-Zone Conditions
inUpperHalf = close > basis and close < upper
inLowerHalf = close < basis and close > lower

// --- Divergence Logic ---
// We use 'ta.pivotlow' and 'ta.pivothigh' to find structural points
ph = ta.pivothigh(rsiVal, lookback, lookback)
pl = ta.pivotlow(rsiVal, lookback, lookback)

// Price at those pivots
pricePh = ta.pivothigh(high, lookback, lookback)
pricePl = ta.pivotlow(low, lookback, lookback)

// --- Bullish Hidden Divergence (Price HL, RSI LL) ---
// Condition: Must be in Lower Half of BB (as per typical mean reversion/trend play)
bullishDiv = false
if not na(pl) and not na(pricePl)
    lowerPrice = pricePl > pricePl[1] // Higher Low
    lowerRSI   = pl < pl[1]           // Lower Low
    bullishDiv := lowerPrice and lowerRSI and inLowerHalf

// --- Bearish Hidden Divergence (Price LH, RSI HH) ---
bearishDiv = false
if not na(ph) and not na(pricePh)
    higherPrice = pricePh < pricePh[1] // Lower High
    higherRSI   = ph > ph[1]           // Higher High
    bearishDiv := higherPrice and higherRSI and inUpperHalf

// --- Triple Divergence Filter ("3rd time no trade") ---
var int bullCount = 0
var int bearCount = 0

if bullishDiv
    bullCount += 1
else if ta.change(low) < 0 and low < ta.lowest(low[1], 10) // New structural low resets or advances count
    bullCount := 0 

if bearishDiv
    bearCount += 1
else if ta.change(high) > 0 and high > ta.highest(high[1], 10)
    bearCount := 0

// Final Signal Logic
validBull = bullishDiv and bullCount < 3
validBear = bearishDiv and bearCount < 3

// --- Visuals ---
plot(basis, color=color.gray, title="BB Basis")
plot(upper, color=color.blue, title="BB Upper")
plot(lower, color=color.blue, title="BB Lower")

plotshape(validBull, style=shape.triangleup, location=location.belowbar, color=color.green, size=size.small, title="Bullish Hidden Div")
plotshape(validBear, style=shape.triangledown, location=location.abovebar, color=color.red, size=size.small, title="Bearish Hidden Div")

// Alerts for 3rd time "No Trade" zones
plotshape(bullishDiv and bullCount >= 3, style=shape.xcross, location=location.belowbar, color=color.orange, title="Bullish Filtered (3rd Time)")
plotshape(bearishDiv and bearCount >= 3, style=shape.xcross, location=location.abovebar, color=color.orange, title="Bearish Filtered (3rd Time)")
