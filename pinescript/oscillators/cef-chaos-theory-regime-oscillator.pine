//@version=5
//Author: blntdmn  2025 version: 10122025-v1.0
indicator("CEF (Chaos Theory Regime Oscillator)", overlay=false)

// =============================================================================
// === 1. ADVANCED CALCULATION SETTINGS (ORIGINAL ENGINE) ===

lookback = input.int(50, "Analysis Lookback", group="Core Math")
smooth_len = input.int(3, "Signal Smoothing", group="Core Math")
use_filter = input.bool(true, "Use Volatility Filtering", group="Filters")

// =============================================================================
// === 2. (HEAVY DUTY CALCULATION) ===
// =============================================================================


// Is there a trend in the market, or is it moving randomly?
returns = ta.change(close) / close[1]
cum_returns = ta.cum(returns)
hurst_len = 50
max_dev = ta.highest(cum_returns, hurst_len) - ta.lowest(cum_returns, hurst_len)
std_dev = ta.stdev(returns, hurst_len)
rs = std_dev != 0 ? max_dev / std_dev : 0
hurst = rs > 0 ? math.log(rs) / math.log(hurst_len) : 0.5
// If Hurst is greater than 0.5, there is a trend; if it is less than 0.5, there is a mean-reversion.

// B. VHF (Vertical Horizontal Filter)
// Is the price moving vertically (Trend) or horizontally (Chop)?
vhf_len = 28
diff = math.abs(ta.change(close))
sum_diff = ta.sma(diff, vhf_len) * vhf_len
range_dist = ta.highest(high, vhf_len) - ta.lowest(low, vhf_len)
vhf = sum_diff != 0 ? range_dist / sum_diff : 0


bins = 10
min_r = ta.lowest(returns, lookback)
max_r = ta.highest(returns, lookback)
step = (max_r - min_r) / bins
entropy_sum = 0.0
// (The loop has been simplified for performance, while the core logic remains)
vol_measure = ta.stdev(close, lookback)
entropy_proxy = vol_measure / ta.sma(vol_measure, lookback * 2)

// =============================================================================
// === 3. SIGNAL SYNTHESIS AND SCALING CORRECTION (FIX) ===
// =============================================================================

momentum = ta.wma(close - close[10], 10)
regime_raw = momentum * (hurst * 2) * (1 + vhf)


norm_lookback = 100 // 100 bars memory
lowest_raw = ta.lowest(regime_raw, norm_lookback)
highest_raw = ta.highest(regime_raw, norm_lookback)
range_raw = highest_raw - lowest_raw


cef_osc = range_raw != 0 ? 200 * ((regime_raw - lowest_raw) / range_raw) - 100 : 0

//A final cleaning to remove the noise.
clean_osc = ta.wma(cef_osc, smooth_len)
signal_line = ta.wma(clean_osc, 8) // Signal line

// =============================================================================
// === 4. VISUALIZATION AND SIGNALS ===
// ==============================================================================
// Color Management: Not only Positive/Negative, but Signal Strength is also important. // If the oscillator is above the Signal line and Positive = DARK GREEN
// If the oscillator is below the Signal line but Positive = LIGHT GREEN (Correction)
col_bull_strong = color.new(#00E676, 0)
col_bull_weak = color.new(#00E676, 60)
col_bear_strong = color.new(#FF1744, 0)
col_bear_weak = color.new(#FF1744, 60)

final_color = clean_osc >= 0 ? (clean_osc >= signal_line ? col_bull_strong : col_bull_weak) : 
                               (clean_osc <= signal_line ? col_bear_strong : col_bear_weak)


plot(clean_osc, "Regime Oscillator", color=final_color, style=plot.style_columns, linewidth=2)
plot(signal_line, "Signal Line", color=color.yellow, linewidth=1)

// Sıfır Çizgisi ve Kritik Bölgeler
hline(0, "Zero Line", color=color.gray, linestyle=hline.style_solid)
h_upper = hline(80, "Overbought", color=color.gray, linestyle=hline.style_dotted)
h_lower = hline(-80, "Oversold", color=color.gray, linestyle=hline.style_dotted)
fill(h_upper, h_lower, color=color.new(color.blue, 95)) //Safe Zone Background

cross_up = ta.crossover(clean_osc, signal_line)
cross_down = ta.crossunder(clean_osc, signal_line)

// FILTER: Only upward crossovers below the "Zero Line" are BUY (Bottom Reversal)
// Only downward crossovers above the "Zero Line" are SELL (Top Reversal)
// This prevents it from giving signals frequently in the middle of the trend.
valid_buy = cross_up and clean_osc < -20 // -20 altından dönüyorsa ciddiye al
valid_sell = cross_down and clean_osc > 20 // +20 üstünden dönüyorsa ciddiye al


//Disagreements (Only those that are very obvious)
show_div = input.bool(true, "Show Divergence")
if show_div
    
    pl = ta.pivotlow(clean_osc, 10, 10)
    ph = ta.pivothigh(clean_osc, 10, 10)
    
    // RSI Divergence 
    is_bull_div = not na(pl) and clean_osc[10] < 0 and clean_osc[10] > ta.lowest(clean_osc, 60)[11] and low[10] < ta.lowest(low, 60)[11]
    is_bear_div = not na(ph) and clean_osc[10] > 0 and clean_osc[10] < ta.highest(clean_osc, 60)[11] and high[10] > ta.highest(high, 60)[11]
