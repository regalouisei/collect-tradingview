// This Pine Scriptâ„¢ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© PrimeAutomation

//@strategy_alert_message {{strategy.order.alert_message}}

//@version=6
strategy("RSI Strategy [PrimeAutomation]", overlay=false
 , default_qty_type = strategy.percent_of_equity
 , default_qty_value = 10 
 , commission_type = strategy.commission.percent 
 , commission_value = 0.06 
 , initial_capital = 10000
 , margin_long = 0
 , margin_short = 0
 , process_orders_on_close = true
 , pyramiding = 0
 )



string OpSettings           = "â Optimization Settings ğŸ”¸"
string OpSettings1          = "â Settings ğŸ”¸"


// Strategy Settings
startTime     = input.time(timestamp("01-01-2023"), "Strategy Start Date", group = OpSettings1)
MarketClosed  = input.bool(false ,"Exit before market close", group = OpSettings1)


var StartTIME = 0
totaltrades = strategy.closedtrades
PNL = strategy.netprofit_percent + strategy.openprofit_percent
WinRate = (strategy.wintrades / totaltrades ) * 100 
MaxDraw = strategy.max_drawdown_percent

Con = strategy.closedtrades == 0 and strategy.opentrades == 1 
StartTIME:= ta.valuewhen(Con and not Con[1],time,0)

MC()=>
    hr = hour == 15
    min = minute == 55
    _Hr = request.security(syminfo.tickerid,"5",hr)
    _min = request.security(syminfo.tickerid,"5",min)
    MClose = (_Hr and _min )
    MClose


var float dailyPNL = na
var int maxDays = 60
var float lastNetProfit = na
var array<string> PNLS = array.new_string()

newDay = ta.change(time("D")) != 0
currentNetProfit = strategy.netprofit

if newDay
    if not na(lastNetProfit)
        dailyPNL := currentNetProfit - lastNetProfit

        if dailyPNL != 0
            dateStr = str.format("{0,date,MM-dd}", time)
            combined = dateStr + ":" + str.tostring(dailyPNL, "#.##")
            array.unshift(PNLS, combined)

            if array.size(PNLS) > maxDays
                array.pop(PNLS)

    lastNetProfit := currentNetProfit



// log.error(str.tostring(PNLS))



tradesCount = strategy.closedtrades

// Get PnL of last closed trade
LastPNL = 0.
if tradesCount > 0
    LastPNL := strategy.closedtrades.profit(tradesCount - 1)



method parseing(string st,tp = 0 , sl = 0 , size = 0 , per = 0.)=>
    string ret = st
    ret := str.replace_all(ret, "{{tickerid}}", syminfo.tickerid)
    ret := str.replace_all(ret, "{{ticker}}", syminfo.ticker)
    ret := str.replace_all(ret, "{{exchange}}", syminfo.prefix)
    ret := str.replace_all(ret, "{{close}}", str.tostring(close))
    ret := str.replace_all(ret, "{{open}}", str.tostring(open))
    ret := str.replace_all(ret, "{{high}}", str.tostring(high))
    ret := str.replace_all(ret, "{{low}}", str.tostring(low))
    ret := str.replace_all(ret, "{{time}}", str.format_time(time, "yyyy-MM-dd HH:mm", syminfo.timezone))
    ret := str.replace_all(ret, "{{timenow}}", str.format_time(timenow, "yyyy-MM-dd HH:mm", syminfo.timezone))
    ret := str.replace_all(ret, "{{volume}}", str.tostring(volume))
    ret := str.replace_all(ret, "{{interval}}", timeframe.period)
    ret := str.replace_all(ret, "{{country}}", syminfo.country)
    ret := str.replace_all(ret, "{{description}}", syminfo.description)
    ret := str.replace_all(ret, "{{root}}", syminfo.root)
    ret := str.replace_all(ret, "{{industry}}", syminfo.industry)
    ret := str.replace_all(ret, "{{type}}", syminfo.type)
    ret := str.replace_all(ret, "{{tp}}", str.tostring(tp))
    ret := str.replace_all(ret, "{{sl}}", str.tostring(sl))
    ret := str.replace_all(ret, "{{size}}", str.tostring(size))
    ret := str.replace_all(ret, "{{per}}", str.tostring(per))
    ret := str.replace_all(ret, "{{TotalTrades}}", str.tostring(strategy.closedtrades))
    ret := str.replace_all(ret, "{{PNL}}", str.tostring(strategy.netprofit_percent + strategy.openprofit_percent,"#.##"))
    ret := str.replace_all(ret, "{{WinRate}}", str.tostring((strategy.wintrades / totaltrades) * 100 ,"#.##"))
    ret := str.replace_all(ret, "{{MaxDraw}}", str.tostring(strategy.max_drawdown_percent,"#.##" ))
    ret := str.replace_all(ret, "{{StartDate}}", str.format("{0,date,medium}",StartTIME))
    ret := str.replace_all(ret, "{{DailyPnl}}", str.tostring(dailyPNL,"#.##"))
    ret := str.replace_all(ret, "{{historyPNL}}", str.tostring(PNLS))
    ret := str.replace_all(ret, "{{LastPNL}}", str.tostring(LastPNL))
    ret



LongEntryMSG   = '{"ticker": "{{ticker}}","action": "buy","price": "{{close}}", "time": "{{timenow}}", "size": "{{size}}","TotalTrades":  "{{TotalTrades}}" ,"PNL": "{{PNL}}", "WinRate":  "{{WinRate}}", "MaxDraw": "{{MaxDraw}}", "StartDate":  "{{StartDate}}", "DailyPNL": "{{DailyPnl}}"}'
LongExitMSG    = '{"ticker": "{{ticker}}","action": "exit_buy","price": "{{close}}", "time": "{{timenow}}", "size": "{{size}}", "per": "{{per}}", "sl": "{{sl}}", "tp": "{{tp}}" ,"TotalTrades":  "{{TotalTrades}}" ,"PNL": "{{PNL}}", "WinRate":  "{{WinRate}}", "MaxDraw": "{{MaxDraw}}", "StartDate":  "{{StartDate}}", "DailyPNL": "{{DailyPnl}}"}'
ShortEntryMSG  = '{"ticker": "{{ticker}}","action": "sell","price": "{{close}}", "time": "{{timenow}}", "size": "{{size}}" ,"TotalTrades":  "{{TotalTrades}}" ,"PNL": "{{PNL}}", "WinRate":  "{{WinRate}}", "MaxDraw": "{{MaxDraw}}", "StartDate":  "{{StartDate}}", "DailyPNL": "{{DailyPnl}}"}'
ShortExitMSG   = '{"ticker": "{{ticker}}","action": "exit_sell","price": "{{close}}", "time": "{{timenow}}", "size": "{{size}}", "per": "{{per}}", "sl": "{{sl}}", "tp": "{{tp}}" ,"TotalTrades":  "{{TotalTrades}}" ,"PNL": "{{PNL}}", "WinRate":  "{{WinRate}}", "MaxDraw": "{{MaxDraw}}", "StartDate":  "{{StartDate}}", "DailyPNL": "{{DailyPnl}}"}'




var float currentSize = na
isNewTrade = strategy.opentrades > strategy.opentrades[1]

if isNewTrade
    currentSize := math.abs(strategy.opentrades.size(strategy.opentrades -1))


MarketisClose = MC()



// --------------------------------------------------------------------------------------------------------------------}
// ğŸ“Œ ğ™ğ™ğ™€ğ™ ğ™„ğ™‰ğ™‹ğ™ğ™ğ™
// --------------------------------------------------------------------------------------------------------------------{
len       = input.int(40, minval = 1, title = "RSI Length", group = OpSettings)
upper     = input.int(60, "Upper", group = OpSettings)
lower     = input.int(35, "Lower", group = OpSettings)


multiStop = input.float(4, "Trail Stop", step = 0.1, group = "TP/SL")
useTP     = input.bool(true, "Take Profit", group = "TP/SL", inline = "tp")
multiTP   = input.float(7, "", step = 0.1, group = "TP/SL", inline = "tp")

rsi = ta.rsi(close, len)


// Variables
var bool  trend     = false

var tp1     = float(na)
var stop    = float(na)
var stop1    = float(na)

var enter   = float(na)
var isLong  = bool(na)

atr = ta.atr(200) * multiStop
atr1 = ta.atr(200) * multiTP

var inTrade = false
var startL = 0


// Signals
Buy  = ta.crossover(rsi, upper) 
Sell = ta.crossunder(rsi, lower)



// Strategy Execution// -----------------------------------------------------------------------------------------------{



trailActivation = close - atr
trailDistance   = atr



BuyExit  = low < stop and isLong 
SellExit = high > stop and not isLong 

TPLong   = ta.crossover(high, tp1) and isLong
TPShort  = ta.crossunder(low, tp1) and not isLong

isTrailing = true




if time >= startTime and bar_index > 200





    // TakeProfit 
    if strategy.opentrades == 0
        stop := float(na)
        tp1 := float(na)
        enter := float(na)
        inTrade := false
        stop1 := float(na)
    


    // Trades
    if Buy and (useTP or isTrailing ? not inTrade : true)

        label.new(bar_index-1, rsi[1], "â—†\nLONG", color = color(na), textcolor = chart.fg_color, style = label.style_label_up)

        stop   := float(na)
        stop   := close - atr
        stop1  := stop
        isLong := true

        if useTP
            tp1 := close + atr1

        enter   := close
        inTrade := true

        strategy.close('Short', 'Short Exit', alert_message = ShortExitMSG.parseing(per = 100,size = math.abs(strategy.position_size)))   
        strategy.entry("Long", strategy.long, comment="Long", alert_message =  LongEntryMSG.parseing( size = currentSize ))

    if Sell and (useTP or isTrailing ? not inTrade : true)

        label.new(bar_index-1, rsi[1], "SHORT\nâ—†", color = color(na), textcolor = chart.fg_color, style = label.style_label_down)

        stop   := float(na)
        stop   := close + atr
        stop1  := stop
        isLong := false

        if useTP
            tp1 := close - atr1 

        enter   := close
        inTrade := true

        strategy.close('Long', 'Long Exit', alert_message = LongExitMSG.parseing(per = 100,size = math.abs(strategy.position_size))) 
        strategy.entry("Short", strategy.short, comment="Short", alert_message =  ShortEntryMSG.parseing( size = currentSize))


    txtStopL = "Long Exit"
    txtStopS = "Short Exit"

    strategy.exit(txtStopL, "Long", stop = stop1, qty_percent = 100, alert_message = LongExitMSG.parseing(per = 100,size = math.abs(strategy.position_size)))
    strategy.exit(txtStopS, "Short", stop = stop1, qty_percent = 100, alert_message = ShortExitMSG.parseing(per = 100,size = math.abs(strategy.position_size)))

    strategy.exit(txtStopL, "Long", limit = tp1, stop = stop, qty_percent = 100, alert_message = LongExitMSG.parseing(per = 100,size = math.abs(strategy.position_size)))
    strategy.exit(txtStopS, "Short", limit = tp1, stop = stop, qty_percent = 100, alert_message = ShortExitMSG.parseing(per = 100,size = math.abs(strategy.position_size)))


    // Exits
    if BuyExit 
        strategy.close('Long', txtStopL, alert_message = LongExitMSG.parseing(per = 100,size = math.abs(strategy.position_size)), immediately = true) 

    if SellExit 
        strategy.close('Short', txtStopS, alert_message = ShortExitMSG.parseing(per = 100,size = math.abs(strategy.position_size)), immediately = true)   




    // Trailing Stop
    if inTrade and isTrailing

        if isLong 
            stop := math.max(stop, low-atr)

        else 
            stop := math.min(stop, high+atr)









// Close Trades when Market Closed
if MarketClosed and MarketClosed 
    if strategy.position_size > 0
        strategy.close('Long', 'Long Exit', alert_message = LongExitMSG.parseing(per = 100,size = math.abs(strategy.position_size))) 
    else 
        strategy.close('Short', 'Short Exit', alert_message = ShortExitMSG.parseing(per = 100,size = math.abs(strategy.position_size)))   



// --------------------------------------------------------------------------------------------------------------------}
// Plot
ps = plot(trend != trend[1] ? na : stop, "Trail Stop", color = color.red, style = plot.style_linebr, force_overlay = true)
pt = plot(trend != trend[1] ? na : tp1, "Take Profit", color = color.green, style = plot.style_linebr, force_overlay = true)
pe = plot(trend != trend[1] ? na : enter, "Entery Price", color = chart.fg_color, style = plot.style_linebr, force_overlay = true)

fill(pe, pt, tp1, enter, color(na), color.new(color.green, 80))
fill(pe, ps, stop, enter, color(na), color.new(color.red, 80))


plot(rsi, "RSI",  color = color.purple, linewidth = 2)

pu = plot(upper, "Upper threshold", color = color.green)
pl = plot(lower, "Lower threshold", color = color.red)
pm = plot(50, "Mid Line", color = chart.fg_color)

fill(pm, pu, upper, 50, color(na), color.new(color.green, 80))
fill(pm, pl, lower, 50, color(na), color.new(color.red, 80))
