//@version=6
indicator(title="RSI [Hash Capital Research]", shorttitle="RSI [Hash Capital Research]", format=format.price, precision=2, timeframe="", timeframe_gaps=true)

// ═══════════════════════════════════════════════════════════════════════════
// CORE SETTINGS
// ═══════════════════════════════════════════════════════════════════════════
length = input.int(13, "RSI Period", minval=1, tooltip="Number of bars for RSI calculation. Lower values (7-14) = more sensitive. Higher values (21-30) = smoother signals.")
src = input.source(hlc3, "Source", tooltip="Price data used for RSI calculation. HLC3 (default) uses average of High, Low, Close for smoother signals.")
smoothing = input.int(3, "Smoothing", minval=1, maxval=10, tooltip="Additional smoothing applied to RSI. 1-3 = responsive, 4-6 = balanced, 7-10 = very smooth.")

// ═══════════════════════════════════════════════════════════════════════════
// VISUAL SETTINGS
// ═══════════════════════════════════════════════════════════════════════════
colorIntensity = input.float(6.0, "Color Intensity", minval=1.0, maxval=10.0, step=1.0, group="Visual", tooltip="Controls color vibrancy. 1-3 = subtle, 4-6 = balanced, 7-10 = vivid colors.")
showGlowEffect = input.bool(true, "Glow Effect", group="Visual", tooltip="Adds a luminous glow around the RSI line for dramatic visual impact.")
glowIntensity = input.float(4.0, "Glow Intensity", minval=1.0, maxval=10.0, step=1.0, group="Visual", tooltip="Controls glow brightness. 1-3 = subtle, 4-6 = moderate, 7-10 = intense glow.")
showMidline = input.bool(true, "Midline (50)", group="Visual", tooltip="Display the neutral 50 level line.")

// ═══════════════════════════════════════════════════════════════════════════
// ZONE SETTINGS
// ═══════════════════════════════════════════════════════════════════════════
overboughtLevel = input.int(70, "Overbought Level", minval=51, maxval=90, group="Zones", tooltip="RSI level considered overbought. Standard is 70.")
oversoldLevel = input.int(30, "Oversold Level", minval=10, maxval=49, group="Zones", tooltip="RSI level considered oversold. Standard is 30.")

// ═══════════════════════════════════════════════════════════════════════════
// SIGNAL SETTINGS
// ═══════════════════════════════════════════════════════════════════════════
showBuySignals = input.bool(true, "Show Buy Signals", group="Signal Settings", tooltip="Display strong buy signals when RSI is extremely oversold.")
showSellSignals = input.bool(true, "Show Sell Signals", group="Signal Settings", tooltip="Display strong sell signals when RSI is extremely overbought.")
buySignalLocation = input.string("Bottom", "Buy Signal Location", options=["Bottom", "Zone Line", "RSI Line"], group="Signal Settings", tooltip="Where to place buy signal dots.")
sellSignalLocation = input.string("Top", "Sell Signal Location", options=["Top", "Zone Line", "RSI Line"], group="Signal Settings", tooltip="Where to place sell signal dots.")

// ═══════════════════════════════════════════════════════════════════════════
// SIGNAL LINE SMOOTHING SETTINGS
// ═══════════════════════════════════════════════════════════════════════════
maTypeInput = input.string("None", "Signal Line Type", options=["None", "SMA", "EMA", "SMMA (RMA)", "WMA", "VWMA"], group="Signal Line", tooltip="Type of moving average for signal line.")
maLengthInput = input.int(14, "Signal Line Length", group="Signal Line", tooltip="Period for signal line calculation.")
signalLineColor = input.color(color.yellow, "Signal Line Color", group="Signal Line")
var enableSignalLine = maTypeInput != "None"

// ═══════════════════════════════════════════════════════════════════════════
// DIVERGENCE SETTINGS
// ═══════════════════════════════════════════════════════════════════════════
calculateDivergence = input.bool(false, title="Calculate Divergence", group="Divergence", tooltip="Enable divergence detection and alerts.")
lookbackRight = input.int(5, "Pivot Lookback Right", minval=1, group="Divergence")
lookbackLeft = input.int(5, "Pivot Lookback Left", minval=1, group="Divergence")
rangeUpper = input.int(60, "Max Pivot Range", minval=1, group="Divergence")
rangeLower = input.int(5, "Min Pivot Range", minval=1, group="Divergence")

// ═══════════════════════════════════════════════════════════════════════════
// RSI CALCULATION WITH SMOOTHING
// ═══════════════════════════════════════════════════════════════════════════
// Calculate raw RSI
rawRSI = ta.rsi(src, length)

// Apply multi-layer smoothing for precision
rsi1 = ta.ema(rawRSI, smoothing)
rsi = ta.ema(rsi1, 2)

// Momentum analysis
momentum = ta.change(rsi, 1)
velocity = ta.change(momentum, 1)

// ═══════════════════════════════════════════════════════════════════════════
// SIGNAL LINE CALCULATION
// ═══════════════════════════════════════════════════════════════════════════
ma(source, length, MAtype) =>
    switch MAtype
        "SMA" => ta.sma(source, length)
        "EMA" => ta.ema(source, length)
        "SMMA (RMA)" => ta.rma(source, length)
        "WMA" => ta.wma(source, length)
        "VWMA" => ta.vwma(source, length)

smoothingMA = enableSignalLine ? ma(rsi, maLengthInput, maTypeInput) : na

// ═══════════════════════════════════════════════════════════════════════════
// ADAPTIVE COLOR SYSTEM - WHITE WITH ZONE-BASED GLOW
// ═══════════════════════════════════════════════════════════════════════════
getAdaptiveColor() =>
    // White line by default
    // Lime green when below oversold level, red when above overbought level
    if rsi < oversoldLevel
        // Bright lime green for oversold zone (matching Z-Score style)
        color.new(#00FF00, 0)
    else if rsi > overboughtLevel
        // Red for overbought zone
        color.new(#FF0000, 0)
    else
        // White for neutral zone
        color.new(#FFFFFF, 0)

// ═══════════════════════════════════════════════════════════════════════════
// GLOW EFFECT - ZONE-BASED
// ═══════════════════════════════════════════════════════════════════════════
getGlowColor() =>
    if showGlowEffect
        glowScale = glowIntensity / 10.0
        
        if rsi < oversoldLevel
            // Bright lime green glow for oversold zone
            glowAlpha = math.round(60 - (20 * glowScale))
            color.new(#00FF00, math.max(30, glowAlpha))
        else if rsi > overboughtLevel
            // Red glow for overbought zone
            glowAlpha = math.round(60 - (20 * glowScale))
            color.new(#FF0000, math.max(30, glowAlpha))
        else
            // Subtle white glow for neutral zone
            color.new(#FFFFFF, 75)
    else
        na

// ═══════════════════════════════════════════════════════════════════════════
// SIGNAL DETECTION
// ═══════════════════════════════════════════════════════════════════════════
// Oversold/Overbought reversals with momentum confirmation
oversoldReversal = rsi < oversoldLevel and momentum > 0 and velocity > 0
overboughtReversal = rsi > overboughtLevel and momentum < 0 and velocity < 0

// Extreme signals - wait for candle close by checking previous bar
extremeOversold = rsi[1] < 20 and ta.crossover(momentum, 0)[1]
extremeOverbought = rsi[1] > 80 and ta.crossunder(momentum, 0)[1]

// Midline crossovers
bullishCross = ta.crossover(rsi, 50)
bearishCross = ta.crossunder(rsi, 50)

// ═══════════════════════════════════════════════════════════════════════════
// DIVERGENCE DETECTION
// ═══════════════════════════════════════════════════════════════════════════
bearColor = color.red
bullColor = color.green
textColor = color.white
noneColor = color.new(color.white, 100)

_inRange(bool cond) =>
    bars = ta.barssince(cond)
    rangeLower <= bars and bars <= rangeUpper

plFound = false
phFound = false

bullCond = false
bearCond = false

rsiLBR = rsi[lookbackRight]

if calculateDivergence
    //------------------------------------------------------------------------------
    // Regular Bullish
    // RSI: Higher Low
    plFound := not na(ta.pivotlow(rsi, lookbackLeft, lookbackRight))
    rsiHL = rsiLBR > ta.valuewhen(plFound, rsiLBR, 1) and _inRange(plFound[1])
    // Price: Lower Low
    lowLBR = low[lookbackRight]
    priceLL = lowLBR < ta.valuewhen(plFound, lowLBR, 1)
    bullCond := priceLL and rsiHL and plFound

    //------------------------------------------------------------------------------
    // Regular Bearish
    // RSI: Lower High
    phFound := not na(ta.pivothigh(rsi, lookbackLeft, lookbackRight))
    rsiLH = rsiLBR < ta.valuewhen(phFound, rsiLBR, 1) and _inRange(phFound[1])
    // Price: Higher High
    highLBR = high[lookbackRight]
    priceHH = highLBR > ta.valuewhen(phFound, highLBR, 1)
    bearCond := priceHH and rsiLH and phFound

// ═══════════════════════════════════════════════════════════════════════════
// PLOTTING
// ═══════════════════════════════════════════════════════════════════════════
// Main RSI line with glow
rsiMainLine = plot(rsi, "RSI Line", color=getAdaptiveColor(), linewidth=2, display=display.all)
rsiGlowLine = plot(rsi, "RSI Glow", color=getGlowColor(), linewidth=6, display=display.all)

// Signal line
plot(smoothingMA, "RSI Signal Line", color=signalLineColor, linewidth=1, display=enableSignalLine ? display.all : display.none)

// ═══════════════════════════════════════════════════════════════════════════
// ZONE VISUALIZATION
// ═══════════════════════════════════════════════════════════════════════════
// Overbought/Oversold levels
hline(overboughtLevel, "Overbought", color=color.new(#FF0000, 40), linestyle=hline.style_dashed, linewidth=1)
hline(oversoldLevel, "Oversold", color=color.new(#00FF00, 40), linestyle=hline.style_dashed, linewidth=1)

// Midline - dashed
hline(showMidline ? 50 : na, "Midline", color=color.new(color.white, 60), linestyle=hline.style_dashed, linewidth=1)

// Reference levels
hline(100, "Upper Bound", color=color.new(color.white, 90), linestyle=hline.style_solid)
hline(0, "Lower Bound", color=color.new(color.white, 90), linestyle=hline.style_solid)

// ═══════════════════════════════════════════════════════════════════════════
// SIGNAL MARKERS
// ═══════════════════════════════════════════════════════════════════════════
// Determine signal positions based on user selection
getBuySignalPosition() =>
    if buySignalLocation == "Bottom"
        0
    else if buySignalLocation == "Zone Line"
        oversoldLevel
    else  // RSI Line
        rsi[1]

getSellSignalPosition() =>
    if sellSignalLocation == "Top"
        100
    else if sellSignalLocation == "Zone Line"
        overboughtLevel
    else  // RSI Line
        rsi[1]

// Plot signals only if enabled and after candle close
plotshape(showBuySignals and extremeOversold ? getBuySignalPosition() : na, "Strong Buy", shape.circle, location.absolute, color=color.new(#00FF00, 0), size=size.tiny, offset=-1)
plotshape(showSellSignals and extremeOverbought ? getSellSignalPosition() : na, "Strong Sell", shape.circle, location.absolute, color=color.new(#FF0000, 0), size=size.tiny, offset=-1)

// ═══════════════════════════════════════════════════════════════════════════
// DIVERGENCE PLOTTING
// ═══════════════════════════════════════════════════════════════════════════
plot(
     plFound ? rsiLBR : na,
     offset=-lookbackRight,
     title="Regular Bullish",
     linewidth=2,
     color=(bullCond ? bullColor : noneColor),
     display=display.pane)

plotshape(
     bullCond ? rsiLBR : na,
     offset=-lookbackRight,
     title="Regular Bullish Label",
     text=" Bull ",
     style=shape.labelup,
     location=location.absolute,
     color=bullColor,
     textcolor=textColor,
     display=display.pane)

plot(
     phFound ? rsiLBR : na,
     offset=-lookbackRight,
     title="Regular Bearish",
     linewidth=2,
     color=(bearCond ? bearColor : noneColor),
     display=display.pane)

plotshape(
     bearCond ? rsiLBR : na,
     offset=-lookbackRight,
     title="Regular Bearish Label",
     text=" Bear ",
     style=shape.labeldown,
     location=location.absolute,
     color=bearColor,
     textcolor=textColor,
     display=display.pane)

// ═══════════════════════════════════════════════════════════════════════════
// ALERTS
// ═══════════════════════════════════════════════════════════════════════════
alertcondition(extremeOversold, "RSI - Strong Buy", "Extreme oversold reversal detected")
alertcondition(extremeOverbought, "RSI - Strong Sell", "Extreme overbought reversal detected")
alertcondition(oversoldReversal, "RSI - Buy Signal", "Oversold reversal with momentum")
alertcondition(overboughtReversal, "RSI - Sell Signal", "Overbought reversal with momentum")
alertcondition(bullishCross, "RSI - Bullish Cross", "RSI crossed above 50")
alertcondition(bearishCross, "RSI - Bearish Cross", "RSI crossed below 50")
alertcondition(bullCond, "RSI - Bullish Divergence", "Found a new Regular Bullish Divergence")
alertcondition(bearCond, "RSI - Bearish Divergence", "Found a new Regular Bearish Divergence")
