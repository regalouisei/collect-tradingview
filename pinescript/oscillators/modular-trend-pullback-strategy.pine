// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © AIScripts


//@version=6
strategy(
    "Modular Trend Pullback Strategy",
    overlay=true,
    initial_capital=100000,
    default_qty_type=strategy.percent_of_equity,
    default_qty_value=5,
    commission_type=strategy.commission.percent,
    commission_value=0.05,
    slippage=1
)

// ───────── INPUTS ─────────
fastLen = input.int(20, "Fast EMA")
slowLen = input.int(50, "Slow EMA")
atrLen  = input.int(14, "ATR Length")
atrMult = input.float(1.5, "Stop ATR Mult")
rr      = input.float(2.0, "Risk Reward")

// ───────── INDICATORS ─────────
emaFast = ta.ema(close, fastLen)
emaSlow = ta.ema(close, slowLen)
atrVal  = ta.atr(atrLen)

// ───────── TREND ─────────
trendUp   = emaFast > emaSlow
trendDown = emaFast < emaSlow

// ───────── GLOBAL TRIGGERS (ALWAYS EXECUTE) ─────────
breakHigh = ta.crossover(close, high[1])
breakLow  = ta.crossunder(close, low[1])

// ───────── PULLBACK LOGIC ─────────
pullbackLong  = trendUp and close < emaFast
pullbackShort = trendDown and close > emaFast

longTrigger  = pullbackLong and breakHigh
shortTrigger = pullbackShort and breakLow

// ───────── ENTRIES ─────────
if longTrigger and strategy.position_size == 0
    strategy.entry("Long", strategy.long)

if shortTrigger and strategy.position_size == 0
    strategy.entry("Short", strategy.short)

// ───────── RISK MANAGEMENT ─────────
longSL  = strategy.position_avg_price - atrVal * atrMult
longTP  = strategy.position_avg_price + atrVal * atrMult * rr

shortSL = strategy.position_avg_price + atrVal * atrMult
shortTP = strategy.position_avg_price - atrVal * atrMult * rr

strategy.exit("Long Exit", from_entry="Long", stop=longSL, limit=longTP)
strategy.exit("Short Exit", from_entry="Short", stop=shortSL, limit=shortTP)

// ───────── VISUALS ─────────
plot(emaFast, color=color.orange)
plot(emaSlow, color=color.blue)
