//@version=5
// @author LazyBear
// Modified by Bromley - Multi-Mode Signal Version with EMA Filter

indicator("TDI Advanced Signals with EMA Filter", shorttitle="TDI-EMA", overlay=true)

// === INPUTS ===
signalMode = input.string("Mode1", title="Signal Mode", options=["Mode1", "Mode2", "Mode3"])
rsiPeriod = input.int(13, minval = 1, title = "RSI Period")
bandLength = input.int(34, minval = 1, title = "Band Length")
lengthrsipl = input.int(2, minval = 0, title = "Fast MA on RSI")
lengthtradesl = input.int(7, minval = 1, title = "Slow MA on RSI")
lookbackPeriod = input.int(5, minval = 1, maxval = 10, title = "Overextension Lookback Period")
overboughtLevel = input.float(70.0, minval = 50.1, maxval = 100, title = "Overbought Level")
oversoldLevel = input.float(30.0, minval = 0, maxval = 49.9, title = "Oversold Level")

// === EMA FILTER INPUTS ===
useEMAFilter = input.bool(false, title="Use EMA Filter")
emaLength = input.int(200, minval = 1, maxval = 1000, title = "EMA Length")

// === CALCULATIONS ===
src = close
r = ta.rsi(src, rsiPeriod)
ma = ta.sma(r, bandLength)
offs = (1.6185 * ta.stdev(r, bandLength))
up = ma + offs
dn = ma - offs
fastMA = ta.sma(r, lengthrsipl)
slowMA = ta.sma(r, lengthtradesl)
emaFilter = ta.ema(close, emaLength)

// === OVEREXTENSION TRACKING ===
var bool wasOverboughtValue = false
var bool wasOversoldValue = false
var bool wasOverboughtBand = false
var bool wasOversoldBand = false

var int overboughtValueBarsAgo = 0
var int oversoldValueBarsAgo = 0
var int overboughtBandBarsAgo = 0
var int oversoldBandBarsAgo = 0

// Track overextension by MA value (Mode 1)
if fastMA > overboughtLevel
    wasOverboughtValue := true
    overboughtValueBarsAgo := 0
else if wasOverboughtValue
    overboughtValueBarsAgo := overboughtValueBarsAgo + 1

if fastMA < oversoldLevel
    wasOversoldValue := true
    oversoldValueBarsAgo := 0
else if wasOversoldValue
    oversoldValueBarsAgo := oversoldValueBarsAgo + 1

// Track overextension by band cross (Mode 2)
if fastMA > up
    wasOverboughtBand := true
    overboughtBandBarsAgo := 0
else if wasOverboughtBand
    overboughtBandBarsAgo := overboughtBandBarsAgo + 1

if fastMA < dn
    wasOversoldBand := true
    oversoldBandBarsAgo := 0
else if wasOversoldBand
    oversoldBandBarsAgo := oversoldBandBarsAgo + 1

// Reset overextension flags if lookback period exceeded
if overboughtValueBarsAgo > lookbackPeriod
    wasOverboughtValue := false
    overboughtValueBarsAgo := 0

if oversoldValueBarsAgo > lookbackPeriod
    wasOversoldValue := false
    oversoldValueBarsAgo := 0

if overboughtBandBarsAgo > lookbackPeriod
    wasOverboughtBand := false
    overboughtBandBarsAgo := 0

if oversoldBandBarsAgo > lookbackPeriod
    wasOversoldBand := false
    oversoldBandBarsAgo := 0

// === SIGNAL CONDITIONS BY MODE ===
valueBuy = ta.crossover(fastMA, slowMA) and wasOversoldValue and oversoldValueBarsAgo <= lookbackPeriod
valueSell = ta.crossunder(fastMA, slowMA) and wasOverboughtValue and overboughtValueBarsAgo <= lookbackPeriod

bandBuy = ta.crossover(fastMA, slowMA) and wasOversoldBand and oversoldBandBarsAgo <= lookbackPeriod
bandSell = ta.crossunder(fastMA, slowMA) and wasOverboughtBand and overboughtBandBarsAgo <= lookbackPeriod

bothBuy = ta.crossover(fastMA, slowMA) and wasOversoldValue and oversoldValueBarsAgo <= lookbackPeriod and wasOversoldBand and oversoldBandBarsAgo <= lookbackPeriod
bothSell = ta.crossunder(fastMA, slowMA) and wasOverboughtValue and overboughtValueBarsAgo <= lookbackPeriod and wasOverboughtBand and overboughtBandBarsAgo <= lookbackPeriod

// === SELECT SIGNALS BASED ON MODE ===
bullishCross = switch signalMode
    "Mode1" => valueBuy
    "Mode2" => bandBuy
    "Mode3" => bothBuy
    => false

bearishCross = switch signalMode
    "Mode1" => valueSell
    "Mode2" => bandSell
    "Mode3" => bothSell
    => false

// === EMA FILTER LOGIC ===
emaBuyCondition = useEMAFilter ? close > emaFilter : true
emaSellCondition = useEMAFilter ? close < emaFilter : true

// === FINAL SIGNALS WITH EMA FILTER ===
bullishSignal = bullishCross and emaBuyCondition
bearishSignal = bearishCross and emaSellCondition

// === PLOT EMA (OPTIONAL) ===
plot(useEMAFilter ? emaFilter : na, title="EMA Filter", color=color.blue, linewidth=2)

// === PLOT SIGNALS ===
plotshape(bullishSignal, style=shape.triangleup, location=location.belowbar, color=color.green, size=size.normal, title="Buy Signal", text="BUY", textcolor=color.white)
plotshape(bearishSignal, style=shape.triangledown, location=location.abovebar, color=color.red, size=size.normal, title="Sell Signal", text="SELL", textcolor=color.white)

// === ALERT CONDITIONS ===
alertcondition(bullishSignal, title="TDI Buy Signal", message="TDI Buy Signal - Mode: {{signalMode}}")
alertcondition(bearishSignal, title="TDI Sell Signal", message="TDI Sell Signal - Mode: {{signalMode}}")
