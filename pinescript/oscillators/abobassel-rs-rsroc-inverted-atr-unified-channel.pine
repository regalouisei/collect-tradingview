// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © AboBassil

//@version=5
indicator("RS + RS.ROC + INVERTED ATRP (Unified Channel + Trend Signals)", overlay=false, max_labels_count=500, max_lines_count=500)

//──────────────── INPUTS ────────────────
compSymbol = input.symbol("NDX", "Comparative Symbol")
normLen    = input.int(200, "Normalization Lookback", minval=50)

// RS settings
rsPeriod = input.int(81, "RS Period")

// RS.ROC settings
rsrocPeriod = input.int(81, "RS.ROC Period")
rsrocTF     = input.timeframe("", "RS.ROC Timeframe (leave empty = chart TF)")

// MA settings
maType  = input.string("SMA", "MA Type", options=["SMA", "EMA"])
maShort = input.int(16, "Short MA Period")
maLong  = input.int(21, "Long MA Period")

// ATRP settings
atrTF  = input.timeframe("422", "ATR Timeframe (minutes)")
atrLen = input.int(15, "ATR Lookback Period")

// Inversion toggles
invertRS    = input.bool(false, "Invert RS")
invertRSROC = input.bool(false, "Invert RS.ROC")
invertATRP  = input.bool(true,  "Invert ATRP")

// Channel Levels
upperCurb  = input.float(100,  "Upper Extreme Curb")
upperBand  = input.float(60,   "Upper Inner Band")
midLevel   = input.float(0,    "Middle")
lowerBand  = input.float(-60,  "Lower Inner Band")
lowerCurb  = input.float(-100, "Lower Extreme Curb")

// Major trend detection sensitivity
slopeThreshold = input.float(5, "Slope Threshold for Major Trend", step=0.1)

//──────────────── FUNCTIONS ────────────────
ma(src, len) =>
    maType == "EMA" ? ta.ema(src, len) : ta.sma(src, len)

normalize(src, len) =>
    lo = ta.lowest(src, len)
    hi = ta.highest(src, len)
    nz((src - lo) / (hi - lo) * 200 - 100)

goldenCross(short, long) => ta.crossover(short, long)
deathCross(short, long)  => ta.crossunder(short, long)

slope(src, len) => src - src[len]

majorTrend(short, long) =>
    slopeVal = slope(short - long, 1)
    (goldenCross(short, long) or deathCross(short, long)) and math.abs(slopeVal) > slopeThreshold

//──────────────── PRICE DATA ────────────────
base = request.security(syminfo.tickerid, timeframe.period, close)
comp = request.security(compSymbol, timeframe.period, close)

//──────────────── 1) RS ────────────────
rs_raw = (base / base[rsPeriod]) / (comp / comp[rsPeriod]) - 1
rs_shortMA = ma(rs_raw, maShort)
rs_longMA  = ma(rs_raw, maLong)
rs_val = rs_shortMA - rs_longMA
rs_val := invertRS ? -rs_val : rs_val
rs_norm = normalize(rs_val, normLen)

//──────────────── 2) RS.ROC ────────────────
rsroc_source = request.security(syminfo.tickerid, rsrocTF, close)
n1 = math.round(0.25 * rsrocPeriod)
n2 = math.round(0.50 * rsrocPeriod)
n3 = math.round(0.75 * rsrocPeriod)
n4 = rsrocPeriod

m1 = rsroc_source / rsroc_source[n1] - 1
m2 = rsroc_source / rsroc_source[n2] - 1
m3 = rsroc_source / rsroc_source[n3] - 1
m4 = rsroc_source / rsroc_source[n4] - 1

rsroc_raw = 100 * (0.4 * m1 + 0.2 * (m2 + m3 + m4))
rsroc_ma  = ma(rsroc_raw, maShort)
rsroc_val = rsroc_raw - rsroc_ma
rsroc_val := invertRSROC ? -rsroc_val : rsroc_val
rsroc_norm = normalize(rsroc_val, normLen)
rsroc_shortMA = ma(rsroc_val, maShort)
rsroc_longMA  = ma(rsroc_val, maLong)

//──────────────── 3) INVERTED ATRP ────────────────
atr_val = request.security(syminfo.tickerid, atrTF, ta.atr(atrLen))
atrp_raw = (atr_val / close) * 100
atrp_val = invertATRP ? -atrp_raw : atrp_raw
atrp_norm = normalize(atrp_val, normLen)
atrp_shortMA = ma(atrp_val, maShort)
atrp_longMA  = ma(atrp_val, maLong)

//──────────────── PLOTS ────────────────
plot(rs_norm,      title="RS",            color=color.blue,   linewidth=2)
plot(rsroc_norm,   title="RS.ROC",        color=color.purple,linewidth=2)
plot(atrp_norm,    title="INVERTED ATRP", color=color.white,  linewidth=2)

//──────────────── CHANNEL & CURBS ────────────────
hline(upperCurb, "Upper Extreme", color=color.new(color.red, 0), linewidth=2)
hline(upperBand, "Upper Band",    color=color.new(color.red, 0), linewidth=2)
hline(midLevel,  "Middle",        color=color.new(color.gray, 0), linewidth=2)
hline(lowerBand, "Lower Band",    color=color.new(color.green, 0), linewidth=2)
hline(lowerCurb, "Lower Extreme", color=color.new(color.green, 0), linewidth=2)
//──────────────── BACKGROUND COLOR ────────────────
bullish = (rs_shortMA > rs_longMA) and (rsroc_shortMA > rsroc_longMA) and (atrp_shortMA > atrp_longMA)
bearish = (rs_shortMA < rs_longMA) and (rsroc_shortMA < rsroc_longMA) and (atrp_shortMA < atrp_longMA)

bgcolor(
     bullish ? color.new(color.green, 91) :  // 9% transparency
     bearish ? color.new(color.red, 91) :
     rs_norm > upperBand or rsroc_norm > upperBand or atrp_norm > upperBand ? color.new(color.red, 91) :
     rs_norm < lowerBand or rsroc_norm < lowerBand or atrp_norm < lowerBand ? color.new(color.green, 91) :
     na)

//──────────────── CROSS ARROWS ────────────────
plotArrow(shortMA, longMA, norm) =>
    if majorTrend(shortMA, longMA)
        label.new(bar_index, norm, "▲", color=color.blue, style=label.style_label_up, textcolor=color.white, size=size.tiny)
    else
        if goldenCross(shortMA, longMA)
            label.new(bar_index, norm, "▲", color=color.green, style=label.style_label_up, textcolor=color.white, size=size.tiny)
        else if deathCross(shortMA, longMA)
            label.new(bar_index, norm, "▼", color=color.red, style=label.style_label_down, textcolor=color.white, size=size.tiny)

// Apply arrows
plotArrow(rs_shortMA, rs_longMA, rs_norm)
plotArrow(rsroc_shortMA, rsroc_longMA, rsroc_norm)
plotArrow(atrp_shortMA, atrp_longMA, atrp_norm)
