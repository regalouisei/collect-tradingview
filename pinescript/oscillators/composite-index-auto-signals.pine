// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © liaor

//@version=6
indicator(title="Composite Index [Auto Signals]", shorttitle="CM_CI_Auto", precision=2)

// --- 参数设置 ---
rsiper = input(14, title="RSI Period")
momper = input(9, title="Momentum Period")
smapershort = input(3, title="Short MA Span") // 这里的3和13是计算CI本身用的
smaperlong = input(13, title="Long MA Span")

// --- 计算核心公式 (康妮·布朗原版逻辑) ---
calc_rsi = ta.rsi(close, rsiper)
del_rsi = calc_rsi - ta.rsi(close, rsiper)[momper] // RSI的动量变化
ci = del_rsi + ta.sma(calc_rsi, smapershort) // 最终的复合指数 (灰线)

// --- 计算参考均线 ---
sma_ci_short = ta.sma(ci, 13) // 绿色快线
sma_ci_long = ta.sma(ci, 33)  // 红色慢线

// --- 绘图 ---
plot(ci, color=color.new(color.gray, 0), linewidth=2, title="Composite Index")
plot(sma_ci_short, color=color.new(color.green, 30), title="Fast MA")
plot(sma_ci_long, color=color.new(color.red, 30), linewidth=2, title="Slow MA")

// 零轴参考
hline(0, color=color.gray, linestyle=hline.style_dotted)

// ==============================================
// >>> 自动信号逻辑 (新增部分) <<<
// ==============================================

// 定义金叉和死叉 (以灰线穿越红线为准，过滤噪音)
ci_cross_up = ta.crossover(ci, sma_ci_long)
ci_cross_down = ta.crossunder(ci, sma_ci_long)

// 绘制信号图标
// 绿色向上三角 = 动能启动/排雷成功
plotshape(ci_cross_up, title="启动信号", style=shape.triangleup, location=location.bottom, color=color.green, size=size.tiny)

// 红色向下三角 = 动能衰竭/逃顶预警
plotshape(ci_cross_down, title="逃顶信号", style=shape.triangledown, location=location.top, color=color.red, size=size.tiny)

// (可选) 极端区域背景色提醒
bgcolor(ci > 120 ? color.new(color.red, 90) : na, title="极端超买区")
bgcolor(ci < -20 ? color.new(color.green, 90) : na, title="极端超卖区")
