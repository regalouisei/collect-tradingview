// This Pine Scriptâ„¢ code is subject to the terms of the Mozilla Public License 2.0
// https://mozilla.org/MPL/2.0/
// Â© DDCA Composite Risk Metric v2.2
// Based on: Benjamin Cowen Macro Risk Memo Q1 2026 + Investment Cookbook 2026-2030
// Purpose: Single 0-1 risk oscillator for Dynamic DCA buying/selling
// 0.0 = MAX opportunity (all-in buy) â†’ 1.0 = MAX risk (sell everything)
// v2.0: Adaptive percentile+ROC normalization, Puell Multiple, SSR
// v2.1: Sigmoid rescale, F&G proxy replaces Bitfinex L/S
// v2.2: Symmetric 7-band zones: <0.25 ALL-IN | 0.45-0.55 HOLD | >0.75 ALL-OUT
//       Macro 35% | On-chain 30% | Technical 25% | Sentiment 10% = 100%

//@version=6
indicator("DDCA Composite Risk Metric", shorttitle="DDCA Risk", overlay=false, precision=3, max_labels_count=500)

// ============================================================================
// INPUTS
// ============================================================================

grp_t = "â•â•â• TIER TOGGLES â•â•â•"
tierMacro   = input.bool(true, "TIER 1 â€” MACRO & LIQUIDITY",  group=grp_t)
tierOnchain = input.bool(true, "TIER 2 â€” ON-CHAIN",           group=grp_t)
tierTech    = input.bool(true, "TIER 3 â€” TECHNICAL",           group=grp_t)
tierSent    = input.bool(true, "TIER 4 â€” SENTIMENT",           group=grp_t)

grp_w = "â•â•â• WEIGHTS (sum to 100) â•â•â•"
// TIER 1: MACRO & LIQUIDITY (35%)
e01 = input.bool(true, "â‘  FED Rate Direction â€”â€”â€” ON/OFF", group=grp_w)
w01 = input.float(5.0,  "    â†³ Weight",      minval=0, maxval=20, step=0.5, group=grp_w)
e02 = input.bool(true, "â‘¡ Global M2 YoY â€”â€”â€” ON/OFF", group=grp_w)
w02 = input.float(11.0, "    â†³ Weight",           minval=0, maxval=20, step=0.5, group=grp_w)
e03 = input.bool(true, "â‘¢ FED Balance Sheet â€”â€”â€” ON/OFF", group=grp_w)
w03 = input.float(4.0,  "    â†³ Weight",        minval=0, maxval=20, step=0.5, group=grp_w)
e04 = input.bool(true, "â‘£ US Real Yields â€”â€”â€” ON/OFF", group=grp_w)
w04 = input.float(5.0,  "    â†³ Weight",           minval=0, maxval=20, step=0.5, group=grp_w)
e05 = input.bool(true, "â‘¤ Unemployment Trend â€”â€”â€” ON/OFF", group=grp_w)
w05 = input.float(3.0,  "    â†³ Weight",       minval=0, maxval=20, step=0.5, group=grp_w)
e06 = input.bool(true, "â‘¥ DXY Dollar â€”â€”â€” ON/OFF", group=grp_w)
w06 = input.float(7.0,  "    â†³ Weight",              minval=0, maxval=20, step=0.5, group=grp_w)
// TIER 2: ON-CHAIN (30%)
e07 = input.bool(true, "â‘¦ MVRV Z-Score â€”â€”â€” ON/OFF", group=grp_w)
w07 = input.float(11.0, "    â†³ Weight",            minval=0, maxval=20, step=0.5, group=grp_w)
e08 = input.bool(true, "â‘§ NUPL â€”â€”â€” ON/OFF", group=grp_w)
w08 = input.float(5.0,  "    â†³ Weight",                    minval=0, maxval=20, step=0.5, group=grp_w)
e09 = input.bool(true, "â‘¨ Puell Multiple â€”â€”â€” ON/OFF", group=grp_w)
w09 = input.float(4.0,  "    â†³ Weight",  minval=0, maxval=20, step=0.5, group=grp_w)
e10 = input.bool(true, "â‘© LTH Netflow proxy â€”â€”â€” ON/OFF", group=grp_w)
w10 = input.float(6.0,  "    â†³ Weight",       minval=0, maxval=20, step=0.5, group=grp_w)
e11 = input.bool(true, "â‘ª Hash Ribbons â€”â€”â€” ON/OFF", group=grp_w)
w11 = input.float(4.0,  "    â†³ Weight",            minval=0, maxval=20, step=0.5, group=grp_w)
// TIER 3: TECHNICAL (25%)
e12 = input.bool(true, "â‘« 200W MA Ratio â€”â€”â€” ON/OFF", group=grp_w)
w12 = input.float(4.0,  "    â†³ Weight",           minval=0, maxval=20, step=0.5, group=grp_w)
e13 = input.bool(true, "â‘¬ Bull Mkt Support Band â€”â€”â€” ON/OFF", group=grp_w)
w13 = input.float(4.0,  "    â†³ Weight",   minval=0, maxval=20, step=0.5, group=grp_w)
e14 = input.bool(true, "â‘­ Pi Cycle Top â€”â€”â€” ON/OFF", group=grp_w)
w14 = input.float(3.0,  "    â†³ Weight",            minval=0, maxval=20, step=0.5, group=grp_w)
e15 = input.bool(true, "â‘® BTC Dominance â€”â€”â€” ON/OFF", group=grp_w)
w15 = input.float(6.0,  "    â†³ Weight",           minval=0, maxval=20, step=0.5, group=grp_w)
e16 = input.bool(true, "â‘¯ Log Regression Band â€”â€”â€” ON/OFF", group=grp_w)
w16 = input.float(5.0,  "    â†³ Weight",     minval=0, maxval=20, step=0.5, group=grp_w)
e17 = input.bool(true, "â‘° Stablecoin Supply Ratio â€”â€”â€” ON/OFF", group=grp_w)
w17 = input.float(3.0,  "    â†³ Weight",      minval=0, maxval=20, step=0.5, group=grp_w)
// TIER 4: SENTIMENT (10%)
e18 = input.bool(true, "â‘± Fear & Greed Proxy â€”â€”â€” ON/OFF", group=grp_w)
w18 = input.float(6.0,  "    â†³ Weight",      minval=0, maxval=20, step=0.5, group=grp_w)
e19 = input.bool(true, "â‘² Altcoin Breadth â€”â€”â€” ON/OFF", group=grp_w)
w19 = input.float(4.0,  "    â†³ Weight",         minval=0, maxval=20, step=0.5, group=grp_w)

grp_s = "â•â•â• SETTINGS â•â•â•"
smoothLen   = input.int(7,    "Composite SMA smoothing",  minval=1, maxval=30, group=grp_s)
showBands   = input.bool(true, "Show DDCA action bands",  group=grp_s)
showSub     = input.bool(false,"Show sub-scores (debug)",  group=grp_s)
showTable   = input.bool(true, "Show score table",         group=grp_s)

// ============================================================================
// DATA FETCHING â€” ~22 request.security() calls (within 40 limit)
// ============================================================================

// --- MACRO DATA (FRED) ---
fedRate     = request.security("FRED:FEDFUNDS",  "D", close, ignore_invalid_symbol=true)
us02y       = request.security("TVC:US02Y",      "D", close, ignore_invalid_symbol=true)
m2          = request.security("FRED:M2SL",      "M", close, ignore_invalid_symbol=true)
walcl       = request.security("FRED:WALCL",     "W", close, ignore_invalid_symbol=true)
rrp         = request.security("FRED:RRPONTSYD", "D", close, ignore_invalid_symbol=true)
realYield   = request.security("FRED:DFII10",    "D", close, ignore_invalid_symbol=true)
unrate      = request.security("FRED:UNRATE",    "M", close, ignore_invalid_symbol=true)
dxy         = request.security("TVC:DXY",        "D", close, ignore_invalid_symbol=true)

// --- ON-CHAIN DATA ---
btcMcap     = request.security("GLASSNODE:BTC_MARKETCAP",       "D", close, ignore_invalid_symbol=true)
btcRcap     = request.security("COINMETRICS:BTC_MARKETCAPREAL", "D", close, ignore_invalid_symbol=true)
btcHashrate = request.security("INTOTHEBLOCK:BTC_HASHRATE",     "D", close, ignore_invalid_symbol=true)
btcNetflow  = request.security("INTOTHEBLOCK:BTC_NETFLOW",      "D", close, ignore_invalid_symbol=true)
minerRev    = request.security("QUANDL:BCHAIN/MIREV",           "D", close, ignore_invalid_symbol=true)

// --- MARKET DATA ---
btcD        = request.security("CRYPTOCAP:BTC.D",    "D", close, ignore_invalid_symbol=true)
totalMcap   = request.security("CRYPTOCAP:TOTAL",    "D", close, ignore_invalid_symbol=true)
total2Mcap  = request.security("CRYPTOCAP:TOTAL2",   "D", close, ignore_invalid_symbol=true)
usdtMcap    = request.security("CRYPTOCAP:USDT",     "D", close, ignore_invalid_symbol=true)
usdcMcap    = request.security("CRYPTOCAP:USDC",     "D", close, ignore_invalid_symbol=true)

// --- BTC PRICE (weekly for long-term MAs) ---
btcW        = request.security(syminfo.tickerid,      "W", close)
btcWsma200  = request.security(syminfo.tickerid,      "W", ta.sma(close, 200))
btcWsma20   = request.security(syminfo.tickerid,      "W", ta.sma(close, 20))
btcWema21   = request.security(syminfo.tickerid,      "W", ta.ema(close, 21))

// ============================================================================
// HELPER: clamp to 0-1
// ============================================================================
clamp(float val) =>
    math.max(0.0, math.min(1.0, val))

// Normalize value within a range to 0-1
normRange(float val, float lo, float hi) =>
    clamp((val - lo) / (hi - lo))

// ============================================================================
// INDICATOR 1: FED RATE DIRECTION (5%)
// INVERTED: High rates = assets cheap = LOW risk to buy
// Low/cutting rates = assets pumping = HIGH risk to buy
// ============================================================================
fedSpread    = nz(fedRate) - nz(us02y)
fedRoc6m     = nz(fedRate) - nz(fedRate[126])
s01_spread   = normRange(fedSpread, -1.0, 2.0)
s01_dir      = normRange(fedRoc6m, -2.0, 1.0)
s01          = 1.0 - clamp(0.6 * s01_spread + 0.4 * s01_dir)

// ============================================================================
// INDICATOR 2: GLOBAL M2 YoY% (11%)
// INVERTED: Contracting M2 = cheap assets = LOW risk to buy
// Expanding M2 = expensive assets = HIGH risk to buy
// ============================================================================
m2_yoy       = nz(m2) > 0 ? (nz(m2) - nz(m2[12])) / nz(m2[12]) * 100 : 0.0
s02          = normRange(m2_yoy, -5.0, 25.0)

// ============================================================================
// INDICATOR 3: FED BALANCE SHEET / NET LIQUIDITY (4%)
// INVERTED: QT / shrinking = cheap assets = LOW risk to buy
// QE / expanding = expensive assets = HIGH risk to buy
// ============================================================================
netLiq       = nz(walcl) - nz(rrp)
netLiq3m     = nz(netLiq[63])
liqRoc       = netLiq3m > 0 ? (netLiq - netLiq3m) / netLiq3m * 100 : 0.0
s03          = normRange(liqRoc, -5.0, 5.0)

// ============================================================================
// INDICATOR 4: US REAL YIELDS (5%)
// INVERTED: High real yields = assets beaten down = LOW risk to buy
// Negative real yields = everything pumped = HIGH risk to buy
// ============================================================================
ry           = nz(realYield)
s04          = 1.0 - normRange(ry, -1.0, 3.0)

// ============================================================================
// INDICATOR 5: UNEMPLOYMENT TREND (3%)
// INVERTED: Rising unemployment = recession fear = cheap prices = LOW risk to buy
// Low/falling unemployment = economy booming = expensive = HIGH risk
// ============================================================================
unrateRoc    = nz(unrate) - nz(unrate[6])
s05          = 1.0 - normRange(unrateRoc, -0.5, 1.5)

// ============================================================================
// INDICATOR 6: DXY DOLLAR INDEX (7%)
// INVERTED: Strong dollar = global pain = cheap crypto = LOW risk to buy
// Weak dollar = liquidity party = expensive = HIGH risk
// ============================================================================
dxySma200    = ta.sma(nz(dxy), 200)
dxyRatio     = nz(dxy) / nz(dxySma200, 100.0)
s06          = 1.0 - normRange(dxyRatio, 0.96, 1.06)

// ============================================================================
// INDICATOR 7: MVRV Z-SCORE (11%) â€” ADAPTIVE
// (MarketCap - RealizedCap) / StdDev(MarketCap)
// Uses rolling percentile + ROC blend to handle cycle compression
// ============================================================================
mc           = nz(btcMcap)
rc           = nz(btcRcap)
mcStd        = ta.stdev(mc, 400)
mvrvZ        = mcStd > 0 ? (mc - rc) / mcStd : 0.0
// 70% rolling percentile (4yr) + 30% 90-day momentum
// nz() fallback to fixed range when percentrank has insufficient history
mvrvPct      = nz(ta.percentrank(mvrvZ, 1460) / 100.0, normRange(mvrvZ, -0.5, 8.0))
mvrvRoc90    = nz(ta.change(mvrvZ, 90), 0.0)
mvrvRocStd   = nz(ta.stdev(mvrvZ, 365), 1.0)
mvrvRocNorm  = mvrvRocStd > 0 ? normRange(mvrvRoc90 / mvrvRocStd, -2.0, 2.0) : 0.5
s07          = clamp(0.7 * mvrvPct + 0.3 * mvrvRocNorm)

// ============================================================================
// INDICATOR 8: NUPL (5%) â€” ADAPTIVE
// (MarketCap - RealizedCap) / MarketCap * 100
// Rolling percentile + ROC blend
// ============================================================================
nupl         = mc > 0 ? (mc - rc) / mc * 100 : 0.0
nuplPct      = nz(ta.percentrank(nupl, 1460) / 100.0, normRange(nupl, -25.0, 80.0))
nuplRoc90    = nz(ta.change(nupl, 90), 0.0)
nuplRocStd   = nz(ta.stdev(nupl, 365), 1.0)
nuplRocNorm  = nuplRocStd > 0 ? normRange(nuplRoc90 / nuplRocStd, -2.0, 2.0) : 0.5
s08          = clamp(0.7 * nuplPct + 0.3 * nuplRocNorm)

// ============================================================================
// INDICATOR 9: PUELL MULTIPLE (4%) â€” ADAPTIVE
// Daily miner revenue / 365D SMA of miner revenue
// High = miners earning a lot = tops. Low = miner capitulation = bottoms.
// ============================================================================
mr           = nz(minerRev)
mrSma365     = ta.sma(mr, 365)
puell        = mrSma365 > 0 ? mr / mrSma365 : 1.0
// Rolling percentile + ROC blend
puellPct     = nz(ta.percentrank(puell, 1460) / 100.0, normRange(puell, 0.3, 4.0))
puellRoc90   = nz(ta.change(puell, 90), 0.0)
puellRocStd  = nz(ta.stdev(puell, 365), 1.0)
puellRocNorm = puellRocStd > 0 ? normRange(puellRoc90 / puellRocStd, -2.0, 2.0) : 0.5
s09          = clamp(0.7 * puellPct + 0.3 * puellRocNorm)

// ============================================================================
// INDICATOR 10: LTH BEHAVIOR / NETFLOW PROXY (6%)
// Negative netflow = coins leaving exchanges = accumulation = low risk
// Positive netflow = coins entering = distribution = high risk
// ============================================================================
nf           = nz(btcNetflow)
nfSma30      = ta.sma(nf, 30)
nfStd        = ta.stdev(nf, 180)
nfZ          = nfStd > 0 ? nfSma30 / nfStd : 0.0
s10          = normRange(nfZ, -2.0, 2.0)

// ============================================================================
// INDICATOR 11: HASH RIBBONS (4%)
// 30D SMA vs 60D SMA of hashrate
// Capitulation (30 < 60) = buy zone. Recovery cross = strong buy.
// ============================================================================
hr           = nz(btcHashrate)
hrSma30      = ta.sma(hr, 30)
hrSma60      = ta.sma(hr, 60)
hrCapitulating = hrSma30 < hrSma60
hrRatio      = hrSma60 > 0 ? hrSma30 / hrSma60 : 1.0
s11          = hrCapitulating ? 0.1 : normRange(hrRatio, 0.95, 1.15)

// ============================================================================
// INDICATOR 12: 200-WEEK MA RATIO (4%) â€” ADAPTIVE
// Price / 200W SMA. Rolling percentile + ROC blend.
// ============================================================================
ratio200w    = nz(btcWsma200) > 0 ? close / nz(btcWsma200) : 1.0
logRatio     = math.log(math.max(ratio200w, 0.3))
r200Pct      = nz(ta.percentrank(logRatio, 1460) / 100.0, normRange(logRatio, math.log(0.5), math.log(4.0)))
r200Roc90    = nz(ta.change(logRatio, 90), 0.0)
r200RocStd   = nz(ta.stdev(logRatio, 365), 1.0)
r200RocNorm  = r200RocStd > 0 ? normRange(r200Roc90 / r200RocStd, -2.0, 2.0) : 0.5
s12          = clamp(0.7 * r200Pct + 0.3 * r200RocNorm)

// ============================================================================
// INDICATOR 13: BULL MARKET SUPPORT BAND (4%) â€” ADAPTIVE
// 20W SMA Ã— 21W EMA. Rolling percentile + ROC blend.
// ============================================================================
bandMid      = (nz(btcWsma20) + nz(btcWema21)) / 2.0
bandRatio    = bandMid > 0 ? close / bandMid : 1.0
bmsbPct      = nz(ta.percentrank(bandRatio, 1460) / 100.0, normRange(bandRatio, 0.7, 1.8))
bmsbRoc90    = nz(ta.change(bandRatio, 90), 0.0)
bmsbRocStd   = nz(ta.stdev(bandRatio, 365), 1.0)
bmsbRocNorm  = bmsbRocStd > 0 ? normRange(bmsbRoc90 / bmsbRocStd, -2.0, 2.0) : 0.5
s13          = clamp(0.7 * bmsbPct + 0.3 * bmsbRocNorm)

// ============================================================================
// INDICATOR 14: PI CYCLE TOP (3%)
// 111DMA vs 350DMA Ã— 2. Cross = cycle top.
// Use proximity as gradient, not just binary.
// ============================================================================
ma111        = ta.sma(close, 111)
ma350x2      = ta.sma(close, 350) * 2
piRatio      = nz(ma350x2) > 0 ? nz(ma111) / nz(ma350x2) : 0.5
piTriggered  = ta.crossover(ma111, ma350x2)
// Ratio approaching 1.0 = danger. Range 0.3 to 1.05
s14          = piTriggered ? 1.0 : normRange(piRatio, 0.3, 1.05)

// ============================================================================
// INDICATOR 15: BTC DOMINANCE ADJUSTED (6%)
// Adjusted = BTC.D * TOTAL / (TOTAL - stablecoins)
// Very high BTC.D = cycle not mature yet (moderate risk)
// Peaking + declining = rotation imminent (higher cycle risk)
// ============================================================================
adjBtcD      = nz(totalMcap) - nz(usdtMcap) > 0 ? nz(btcD) * nz(totalMcap) / (nz(totalMcap) - nz(usdtMcap)) : nz(btcD)
btcDsma30    = ta.sma(adjBtcD, 30)
btcDrising   = adjBtcD > btcDsma30
// Low dominance (40%) = altseason = late cycle = high risk. High (>60%) + rising = early = low risk.
// Peaked + falling = rotation = moderate-high
s15_level    = normRange(adjBtcD, 35.0, 70.0)
// Invert because high dominance = early cycle = LOWER risk for BTC specifically
s15          = clamp(1.0 - s15_level * 0.6 - (btcDrising ? 0.0 : 0.2))

// ============================================================================
// INDICATOR 16: LOG REGRESSION BAND (5%)
// Position in long-term log growth channel
// Approximate: log(price) = a * ln(days_since_genesis) + b
// ============================================================================
daysSinceGenesis = (time - timestamp(2009, 1, 3, 0, 0, 0)) / 86400000.0
logFairValue = daysSinceGenesis > 0 ? 5.84 * math.log(daysSinceGenesis) - 17.01 : 0.0
logPrice     = close > 0 ? math.log(close) : 0.0
logDeviation = logPrice - logFairValue
// Deviation range: -3 (deep below) to +3 (far above)
s16          = normRange(logDeviation, -3.0, 3.0)

// ============================================================================
// INDICATOR 17: STABLECOIN SUPPLY RATIO â€” SSR (3%) â€” ADAPTIVE
// BTC market cap / total stablecoin supply
// Low SSR = lots of dry powder relative to BTC = bullish = low risk
// High SSR = no stablecoin ammo = high risk
// ============================================================================
stableSupply = nz(usdtMcap) + nz(usdcMcap)
ssr          = stableSupply > 0 ? mc / stableSupply : 10.0
// Percentile only (no ROC â€” slow-moving structural metric)
ssrPct       = nz(ta.percentrank(ssr, 1460) / 100.0, normRange(ssr, 2.0, 20.0))
s17          = clamp(ssrPct)

// ============================================================================
// INDICATOR 18: CRYPTO FEAR & GREED PROXY (6%)
// 3-component oscillator: Momentum + Volatility + Price Strength
// Oscillates 0-1 like alternative.me F&G index
// ============================================================================
// Component 1: Momentum (40%) â€” RSI blend
fgRsi14      = ta.rsi(close, 14)
fgRsi30      = ta.rsi(close, 30)
fgMomentum   = (nz(fgRsi14) * 0.6 + nz(fgRsi30) * 0.4) / 100.0

// Component 2: Volatility (30%) â€” 20D realized vol, percentile-ranked
// High vol = fear (low score after inversion), low vol = greed
fgReturns    = close / close[1] - 1.0
fgVol20      = ta.stdev(fgReturns, 20) * math.sqrt(365) * 100.0
fgVolPct     = nz(ta.percentrank(fgVol20, 365) / 100.0, 0.5)
fgVolScore   = 1.0 - fgVolPct  // Invert: high vol = fear = low score

// Component 3: Price Strength (30%) â€” position vs 50 & 200 SMA
fgSma50      = ta.sma(close, 50)
fgSma200     = ta.sma(close, 200)
fgAbove50    = close > fgSma50 ? 1.0 : 0.0
fgAbove200   = close > fgSma200 ? 1.0 : 0.0
fgMargin50   = nz(fgSma50) > 0 ? clamp((close / fgSma50 - 0.85) / 0.3) : 0.5
fgStrength   = fgAbove50 * 0.3 + fgAbove200 * 0.3 + fgMargin50 * 0.4

// Composite F&G: 0 = extreme fear, 1 = extreme greed
fgRaw        = fgMomentum * 0.4 + fgVolScore * 0.3 + fgStrength * 0.3
s18          = ta.sma(fgRaw, 7)  // Smooth 7D to reduce noise

// ============================================================================
// INDICATOR 19: ALTCOIN BREADTH (4%)
// TOTAL2 / TOTAL ratio. Rising = broadening (late cycle). Declining = narrow.
// ============================================================================
breadth      = nz(totalMcap) > 0 ? nz(total2Mcap) / nz(totalMcap) : 0.4
// Range: 0.25 (BTC heavy, low risk) to 0.65 (altseason, high risk)
s19          = normRange(breadth, 0.25, 0.65)

// ============================================================================
// COMPOSITE SCORE â€” WEIGHTED AVERAGE (respects ON/OFF toggles)
// ============================================================================
// Effective weights: 0 when tier OR individual toggled off
ew01 = tierMacro and e01 ? w01 : 0.0
ew02 = tierMacro and e02 ? w02 : 0.0
ew03 = tierMacro and e03 ? w03 : 0.0
ew04 = tierMacro and e04 ? w04 : 0.0
ew05 = tierMacro and e05 ? w05 : 0.0
ew06 = tierMacro and e06 ? w06 : 0.0
ew07 = tierOnchain and e07 ? w07 : 0.0
ew08 = tierOnchain and e08 ? w08 : 0.0
ew09 = tierOnchain and e09 ? w09 : 0.0
ew10 = tierOnchain and e10 ? w10 : 0.0
ew11 = tierOnchain and e11 ? w11 : 0.0
ew12 = tierTech and e12 ? w12 : 0.0
ew13 = tierTech and e13 ? w13 : 0.0
ew14 = tierTech and e14 ? w14 : 0.0
ew15 = tierTech and e15 ? w15 : 0.0
ew16 = tierTech and e16 ? w16 : 0.0
ew17 = tierTech and e17 ? w17 : 0.0
ew18 = tierSent and e18 ? w18 : 0.0
ew19 = tierSent and e19 ? w19 : 0.0

totalW = ew01+ew02+ew03+ew04+ew05+ew06+ew07+ew08+ew09+ew10+ew11+ew12+ew13+ew14+ew15+ew16+ew17+ew18+ew19

raw_composite = totalW > 0 ?
     (nz(s01,0.5)*ew01 + nz(s02,0.5)*ew02 + nz(s03,0.5)*ew03 + nz(s04,0.5)*ew04 + nz(s05,0.5)*ew05 + nz(s06,0.5)*ew06 +
      nz(s07,0.5)*ew07 + nz(s08,0.5)*ew08 + nz(s09,0.5)*ew09 + nz(s10,0.5)*ew10 + nz(s11,0.5)*ew11 +
      nz(s12,0.5)*ew12 + nz(s13,0.5)*ew13 + nz(s14,0.5)*ew14 + nz(s15,0.5)*ew15 + nz(s16,0.5)*ew16 + nz(s17,0.5)*ew17 +
      nz(s18,0.5)*ew18 + nz(s19,0.5)*ew19) / totalW : 0.5

// Smoothed composite
compositeSmooth = ta.sma(raw_composite, smoothLen)

// ============================================================================
// RESCALE â€” Sigmoid curve compresses extremes, keeps middle responsive
// Prevents 2021-style blow-off where all indicators max out simultaneously
// ============================================================================
grp_n = "â•â•â• RESCALING â•â•â•"
centerPoint = input.float(0.42, "Center (raw midpoint)", minval=0.1, maxval=0.8, step=0.05, group=grp_n)
steepness   = input.float(8.0,  "Sigmoid steepness",     minval=2.0, maxval=20.0, step=0.5, group=grp_n)

// Sigmoid: 1 / (1 + exp(-k * (x - center)))
// Maps any raw value smoothly to 0.05-0.95 with natural compression at extremes
sigmoid_input = -steepness * (compositeSmooth - centerPoint)
composite     = math.max(0.05, math.min(0.95, 1.0 / (1.0 + math.exp(sigmoid_input))))

// ============================================================================
// TIER SUB-SCORES (for debugging / display)
// ============================================================================
macroW       = ew01+ew02+ew03+ew04+ew05+ew06
onchainW     = ew07+ew08+ew09+ew10+ew11
techW        = ew12+ew13+ew14+ew15+ew16+ew17
sentW        = ew18+ew19

tier_macro   = macroW > 0 ? (nz(s01,0.5)*ew01+nz(s02,0.5)*ew02+nz(s03,0.5)*ew03+nz(s04,0.5)*ew04+nz(s05,0.5)*ew05+nz(s06,0.5)*ew06) / macroW : na
tier_onchain = onchainW > 0 ? (nz(s07,0.5)*ew07+nz(s08,0.5)*ew08+nz(s09,0.5)*ew09+nz(s10,0.5)*ew10+nz(s11,0.5)*ew11) / onchainW : na
tier_tech    = techW > 0 ? (nz(s12,0.5)*ew12+nz(s13,0.5)*ew13+nz(s14,0.5)*ew14+nz(s15,0.5)*ew15+nz(s16,0.5)*ew16+nz(s17,0.5)*ew17) / techW : na
tier_sent    = sentW > 0 ? (nz(s18,0.5)*ew18+nz(s19,0.5)*ew19) / sentW : na

// ============================================================================
// PLOTTING
// ============================================================================

// DDCA Action Bands

// Background bands
hline(0.25, "0.25 ALL-INâ†“",    color=color.new(#00e676, 40), linestyle=hline.style_solid)
hline(0.35, "0.35",             color=color.new(#66bb6a, 80), linestyle=hline.style_dotted)
hline(0.45, "0.45 BUYâ†‘ HOLDâ†“", color=color.new(#ffc107, 60), linestyle=hline.style_solid)
hline(0.5, "0.5",               color=color.new(#78909c, 85), linestyle=hline.style_dotted)
hline(0.55, "0.55 HOLDâ†‘ SELLâ†“", color=color.new(#ff5722, 60), linestyle=hline.style_solid)
hline(0.65, "0.65",             color=color.new(#ef5350, 80), linestyle=hline.style_dotted)
hline(0.75, "0.75 ALL-OUTâ†‘",   color=color.new(#d50000, 40), linestyle=hline.style_solid)

// Background fill â€” tight bounds so chart doesn't waste vertical space
h045 = hline(0.45, color=color.new(color.white, 100))
h055 = hline(0.55, color=color.new(color.white, 100))
h_lo = hline(0.08, color=color.new(color.white, 100))
h_hi = hline(0.92, color=color.new(color.white, 100))
fill(h_lo, h045, color=showBands ? color.new(#00e676, 92) : na, title="Buy Zone")
fill(h045, h055, color=showBands ? color.new(#78909c, 93) : na, title="Hold Zone")
fill(h055, h_hi, color=showBands ? color.new(#ff5722, 92) : na, title="Sell Zone")

// Main composite line
compositeColor = composite <= 0.25 ? #00e676 : composite <= 0.35 ? #66bb6a : composite <= 0.45 ? #a5d6a7 : composite <= 0.55 ? #ffc107 : composite <= 0.65 ? #ffab91 : composite <= 0.75 ? #ff5722 : #d50000

plot(composite, "DDCA Risk", color=compositeColor, linewidth=3)

// â”€â”€ Tracking tooltip â€” invisible labels on curve, hover to see popup â”€â”€
bandLabel = composite < 0.25 ? "ðŸŸ¢ ALL-IN" : composite < 0.35 ? "ðŸŸ¢ STRONG BUY" : composite < 0.45 ? "ðŸŸ¢ BUY" : composite < 0.55 ? "ðŸŸ¡ HOLD" : composite < 0.65 ? "ðŸ”´ SELL" : composite < 0.75 ? "ðŸ”´ STRONG SELL" : "ðŸ”´ ALL-OUT"
tipText  = "Risk: " + str.tostring(composite, "#.###") + "\n" + bandLabel + "\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€\nMacro:     " + str.tostring(tier_macro, "#.##") + "\nOn-Chain:  " + str.tostring(tier_onchain, "#.##") + "\nTechnical: " + str.tostring(tier_tech, "#.##") + "\nSentiment: " + str.tostring(tier_sent, "#.##")
label.new(bar_index, composite, "", color=color.new(compositeColor, 100), textcolor=color.new(color.white, 100), style=label.style_label_center, size=size.tiny, tooltip=tipText)

// â”€â”€ Persistent label on current bar â€” always visible, colored by band â”€â”€
var label curLabel = na
if barstate.islast
    label.delete(curLabel)
    curLabel := label.new(bar_index + 2, composite, str.tostring(composite, "#.##") + " " + bandLabel, color=color.new(compositeColor, 20), textcolor=color.white, style=label.style_label_left, size=size.normal, textalign=text.align_left)

// Sub-score plots (toggle)
plot(showSub ? tier_macro : na,   "Tier: Macro",    color=color.new(#e94560, 50), linewidth=1)
plot(showSub ? tier_onchain : na, "Tier: On-Chain",  color=color.new(#2196f3, 50), linewidth=1)
plot(showSub ? tier_tech : na,    "Tier: Technical", color=color.new(#9c27b0, 50), linewidth=1)
plot(showSub ? tier_sent : na,    "Tier: Sentiment", color=color.new(#ff9800, 50), linewidth=1)

// ============================================================================
// TABLE â€” Current scores breakdown
// ============================================================================
if showTable and barstate.islast
    var table t = table.new(position.top_right, 4, 24, bgcolor=color.new(#0a0a14, 10), border_width=1, border_color=color.new(#333333, 0))
    header_bg = color.new(#1a1a2e, 0)
    
    table.cell(t, 0, 0, "DDCA COMPOSITE RISK", text_color=#e94560, text_size=size.small, bgcolor=header_bg, text_halign=text.align_left)
    table.cell(t, 1, 0, str.tostring(composite, "#.###"), text_color=compositeColor, text_size=size.normal, bgcolor=header_bg)
    actionLabel = composite <= 0.25 ? "ALL-IN" : composite <= 0.35 ? "STRONG BUY" : composite <= 0.45 ? "BUY" : composite <= 0.55 ? "HOLD" : composite <= 0.65 ? "SELL" : composite <= 0.75 ? "STRONG SELL" : "ALL-OUT"
    table.cell(t, 2, 0, actionLabel, text_color=compositeColor, text_size=size.small, bgcolor=header_bg)
    table.cell(t, 3, 0, "", bgcolor=header_bg)

    // Tier summaries
    table.cell(t, 0, 1, "Macro 35%",    text_color=#e94560, text_size=size.tiny, bgcolor=color.new(#111111, 0), text_halign=text.align_left)
    table.cell(t, 1, 1, str.tostring(tier_macro, "#.##"), text_color=#e94560, text_size=size.tiny, bgcolor=color.new(#111111, 0))
    table.cell(t, 0, 2, "OnChain 30%",  text_color=#2196f3, text_size=size.tiny, bgcolor=color.new(#111111, 0), text_halign=text.align_left)
    table.cell(t, 1, 2, str.tostring(tier_onchain, "#.##"), text_color=#2196f3, text_size=size.tiny, bgcolor=color.new(#111111, 0))
    table.cell(t, 0, 3, "Tech 25%",     text_color=#9c27b0, text_size=size.tiny, bgcolor=color.new(#111111, 0), text_halign=text.align_left)
    table.cell(t, 1, 3, str.tostring(tier_tech, "#.##"), text_color=#9c27b0, text_size=size.tiny, bgcolor=color.new(#111111, 0))
    table.cell(t, 0, 4, "Sentiment 10%",text_color=#ff9800, text_size=size.tiny, bgcolor=color.new(#111111, 0), text_halign=text.align_left)
    table.cell(t, 1, 4, str.tostring(tier_sent, "#.##"), text_color=#ff9800, text_size=size.tiny, bgcolor=color.new(#111111, 0))

    // Individual scores
    row = 5
    labels = array.from("â‘ FED Rate","â‘¡M2 YoY","â‘¢WALCL","â‘£RealYld","â‘¤Unempl","â‘¥DXY","â‘¦MVRV-Z","â‘§NUPL","â‘¨Puell","â‘©LTH Net","â‘ªHashRib","â‘«200W MA","â‘¬BMSB","â‘­PiCycle","â‘®BTC.D","â‘¯LogReg","â‘°SSR","â‘±F&G","â‘²Breadth")
    scores = array.from(s01,s02,s03,s04,s05,s06,s07,s08,s09,s10,s11,s12,s13,s14,s15,s16,s17,s18,s19)
    weights = array.from(w01,w02,w03,w04,w05,w06,w07,w08,w09,w10,w11,w12,w13,w14,w15,w16,w17,w18,w19)
    
    for i = 0 to array.size(labels) - 1
        sc = array.get(scores, i)
        wt = array.get(weights, i)
        scColor = sc <= 0.3 ? #00e676 : sc <= 0.6 ? #ffc107 : #ef5350
        r = row + i
        table.cell(t, 0, r, array.get(labels, i), text_color=#888888, text_size=size.tiny, bgcolor=color.new(#0d0d14, 0), text_halign=text.align_left)
        table.cell(t, 1, r, str.tostring(sc, "#.##"), text_color=scColor, text_size=size.tiny, bgcolor=color.new(#0d0d14, 0))
        table.cell(t, 2, r, str.tostring(wt, "#") + "%", text_color=#555555, text_size=size.tiny, bgcolor=color.new(#0d0d14, 0))
        // Mini bar
        table.cell(t, 3, r, str.tostring(math.round(sc * 100)) + "%", text_color=scColor, text_size=size.tiny, bgcolor=color.new(#0d0d14, 0))

// ============================================================================
// ALERTS
// ============================================================================
alertcondition(ta.crossunder(composite, 0.25), "RISK < 0.25 â€” ALL-IN",       "DDCA Risk dropped below 0.25 â€” ALL-IN buy signal")
alertcondition(ta.crossunder(composite, 0.35), "RISK < 0.35 â€” STRONG BUY",  "DDCA Risk dropped below 0.35 â€” Strong buy signal")
alertcondition(ta.crossunder(composite, 0.45), "RISK < 0.45 â€” BUY",         "DDCA Risk dropped below 0.45 â€” Buy signal")
alertcondition(ta.crossover(composite, 0.55),  "RISK > 0.55 â€” SELL",        "DDCA Risk rose above 0.55 â€” Sell signal")
alertcondition(ta.crossover(composite, 0.65),  "RISK > 0.65 â€” STRONG SELL", "DDCA Risk rose above 0.65 â€” Strong sell signal")
alertcondition(ta.crossover(composite, 0.75),  "RISK > 0.75 â€” ALL-OUT",     "DDCA Risk rose above 0.75 â€” ALL-OUT signal")
