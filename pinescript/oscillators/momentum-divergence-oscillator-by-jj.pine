//@version=6
indicator("Momentum Divergence Oscillator by JJ", overlay = false)

// === INPUTS ===
// MACD Settings
macdSource = input.source(close, title="Source")
fastLength = input.int(8, title = "Fast Length")
slowLength = input.int(21, title = "Slow Length")
signalLength = input.int(5, title = "Signal Length")
histAmplify = input.float(500.0, title = "Histogram Amplification")
macdAmplify = input.float(100.0, title = "MACD/Signal Amplification")

// MTF Settings
tf1 = input.string("30", title="MTF 1 (e.g. 30)")
tf2 = input.string("60", title="MTF 2 (e.g. 60)")
bgTransparency = input.int(92, title="MTF Background Transparency", minval=0, maxval=100)

// Divergence/Signal Settings
showPeaks = input.bool(true, title="Show Histogram Peaks")
rsiLength = input.int(14, title="RSI Period (for Div)")
pivotLookback = input.int(5, title="Pivot Lookback (for Div)", minval=1)


// === MULTI-TIMEFRAME MACD ===
// Use the built-in MACD function for cleaner MTF requests
macd_tf(src, fast, slow, signal) =>
    [macdLine, signalLine, histLine] = ta.macd(src, fast, slow, signal)
    macdLine > signalLine ? 1 : macdLine < signalLine ? -1 : 0

macdTrend1 = request.security(syminfo.tickerid, tf1, macd_tf(macdSource, fastLength, slowLength, signalLength))
macdTrend2 = request.security(syminfo.tickerid, tf2, macd_tf(macdSource, fastLength, slowLength, signalLength))

mtfBull = macdTrend1 > 0 and macdTrend2 > 0
mtfBear = macdTrend1 < 0 and macdTrend2 < 0

// === CORE MACD CALCULATION ===
[macd, signal, hist] = ta.macd(macdSource, fastLength, slowLength, signalLength)


// === VOLUME DIVERGENCE ===
vol = volume
// Removed volume divergence plot as it was very noisy/basic, focuses on standard divergences below.
// This area is prime for a dedicated Volume Oscillator divergence addition if desired in a future update.


// === RSI DIVERGENCE (Using new pivot input) ===
rsi = ta.rsi(macdSource, rsiLength)
rsiLow = ta.pivotlow(rsi, pivotLookback, pivotLookback)
priceLow = ta.pivotlow(close, pivotLookback, pivotLookback)
rsiHigh = ta.pivothigh(rsi, pivotLookback, pivotLookback)
priceHigh = ta.pivothigh(close, pivotLookback, pivotLookback)

// Simplified divergence conditions:
rsiDivBull = not na(rsiLow) and close[pivotLookback] > priceLow[pivotLookback] and rsi[pivotLookback] < rsiLow[pivotLookback]
rsiDivBear = not na(rsiHigh) and close[pivotLookback] < priceHigh[pivotLookback] and rsi[pivotLookback] > rsiHigh[pivotLookback]


plotshape(rsiDivBull, title="Bullish RSI Divergence", location=location.bottom, style=shape.labelup, color=color.green, text="Bull RSI Div")
plotshape(rsiDivBear, title="Bearish RSI Divergence", location=location.top, style=shape.labeldown, color=color.red, text="Bear RSI Div")


// === HISTOGRAM PEAKS ===
peakTop = hist > hist[1] and hist[1] > hist[2] and hist[1] > hist[3] and hist[1] > hist[4]
peakBottom = hist < hist[1] and hist[1] < hist[2] and hist[1] < hist[3] and hist[1] < hist[4]
plotshape(showPeaks and peakTop, title="Histogram Top", location=location.top, style=shape.xcross, color=color.red)
plotshape(showPeaks and peakBottom, title="Histogram Bottom", location=location.bottom, style=shape.xcross, color=color.green)


// === MACD ZERO CROSS MARKERS ===
bullCross = ta.crossover(macd, 0)
bearCross = ta.crossunder(macd, 0)
plotshape(bullCross, title="MACD Zero Cross Up", location=location.bottom, style=shape.triangleup, color=color.green, size=size.tiny)
plotshape(bearCross, title="MACD Zero Cross Down", location=location.top, style=shape.triangledown, color=color.red, size=size.tiny)


// === PLOTS ===
plot(macd * macdAmplify, title = "MACD Line", color = color.blue, linewidth = 2)
plot(signal * macdAmplify, title = "Signal Line", color = color.orange, linewidth = 2)
plot(hist * histAmplify, title = "Histogram", style = plot.style_columns, color = hist >= 0 ? color.green : color.red)
plot(0, title = "Zero Line", color = color.gray)


// === BACKGROUND SHADING ===
bgcolor(mtfBull ? color.new(color.green, bgTransparency) : mtfBear ? color.new(color.red, bgTransparency) : na)

// === END ===
