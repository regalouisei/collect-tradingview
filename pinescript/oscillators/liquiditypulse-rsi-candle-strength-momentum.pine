//@version=5
indicator("LiquidityPulse RSI Candle Strength Momentum",
     shorttitle = "LPCandleS",
     overlay    = true,
     max_labels_count = 500)

groupVolTop = "Volume"
volMethod = input.string("Relative (MA)", "Volume method",
     options = ["Relative (MA)", "Z-score", "Percentile", "Efficiency"],
     group = groupVolTop)

float Z_DIV       = 2.0
float PCT_MIN_REL = 0.30
float PCT_MAX_REL = 2.20

themeOpt = input.string("CL – Classic", "Colour theme",
     options = ["CL – Classic","CU – Cool","NE – Neon","PA – Pastel","AV – Abyss"])

makePal(c0,c1,c2,c3,c4,c5,c6,c7,c8,c9) =>
    array.from(c0,c1,c2,c3,c4,c5,c6,c7,c8,c9)

palClassicBull = makePal(#d4f4d7,#b8ecbc,#9ce4a1,#80db86,#64d36b,#49cb51,#2db336,#199a25,#0e801c,#066717)
palClassicBear = makePal(#ffd6d2,#ffbab4,#ff9e96,#ff8278,#ff665a,#f64d41,#d93b30,#b62b25,#921e1a,#6e1210)
palCoolBull    = makePal(#d2f7ff,#b4efff,#96e8ff,#78e0ff,#5ad8ff,#3cd0ff,#1ec7ff,#00bfff,#0090e6,#0070cc)
palCoolBear    = makePal(#ffd2f7,#ffb4ef,#ff96e8,#ff78e0,#ff5ad8,#ff3cd0,#ff1ec7,#ff00bf,#d900b4,#b300a8)
palNeonBull    = makePal(#adfff9,#7dfffa,#4dfeff,#1df2ff,#00d5ff,#00b8ff,#009cff,#007eff,#0061ff,#0047f5)
palNeonBear    = makePal(#ffd0ff,#ffadff,#ff8aff,#ff67ff,#ff44ff,#ff21ff,#e400ff,#c300ff,#a200ff,#8000f2)
palPastelBull  = makePal(#e2fbe4,#c7f7d0,#acf4bc,#91f0a8,#76ec94,#5be880,#40e46c,#25df58,#0ad944,#00c233)
palPastelBear  = makePal(#ffe5df,#ffcbbf,#ffb09f,#ff967f,#ff7b5f,#ff613f,#f5482b,#d9361e,#b92514,#991109)
palAbyssBull   = makePal(#d2f2f5,#a8e3eb,#7dd5e0,#53c6d6,#29b7cb,#00a8c1,#0090a8,#007890,#006078,#004960)
palAbyssBear   = makePal(#ffe9d1,#ffd1a8,#ffb97f,#ffa156,#ff892d,#ff7104,#e65f00,#cc4e00,#b33d00,#8f2e00)

bullCol1  = input.color(#d4f4d7,"Bull score 1",  group="Bull Colours")
bullCol2  = input.color(#b8ecbc,"Bull score 2",  group="Bull Colours")
bullCol3  = input.color(#9ce4a1,"Bull score 3",  group="Bull Colours")
bullCol4  = input.color(#80db86,"Bull score 4",  group="Bull Colours")
bullCol5  = input.color(#64d36b,"Bull score 5",  group="Bull Colours")
bullCol6  = input.color(#49cb51,"Bull score 6",  group="Bull Colours")
bullCol7  = input.color(#2db336,"Bull score 7",  group="Bull Colours")
bullCol8  = input.color(#199a25,"Bull score 8",  group="Bull Colours")
bullCol9  = input.color(#0e801c,"Bull score 9",  group="Bull Colours")
bullCol10 = input.color(#066717,"Bull score 10", group="Bull Colours")

bearCol1  = input.color(#ffd6d2,"Bear score 1",  group="Bear Colours")
bearCol2  = input.color(#ffbab4,"Bear score 2",  group="Bear Colours")
bearCol3  = input.color(#ff9e96,"Bear score 3",  group="Bear Colours")
bearCol4  = input.color(#ff8278,"Bear score 4",  group="Bear Colours")
bearCol5  = input.color(#ff665a,"Bear score 5",  group="Bear Colours")
bearCol6  = input.color(#f64d41,"Bear score 6",  group="Bear Colours")
bearCol7  = input.color(#d93b30,"Bear score 7",  group="Bear Colours")
bearCol8  = input.color(#b62b25,"Bear score 8",  group="Bear Colours")
bearCol9  = input.color(#921e1a,"Bear score 9",  group="Bear Colours")
bearCol10 = input.color(#6e1210,"Bear score 10", group="Bear Colours")

bullUser = array.from(bullCol1,bullCol2,bullCol3,bullCol4,bullCol5,
                      bullCol6,bullCol7,bullCol8,bullCol9,bullCol10)
bearUser = array.from(bearCol1,bearCol2,bearCol3,bearCol4,bearCol5,
                      bearCol6,bearCol7,bearCol8,bearCol9,bearCol10)

var color[] bullPal = na
var color[] bearPal = na
if barstate.isfirst
    bullPal := themeOpt=="CU – Cool"   ? palCoolBull  :
               themeOpt=="NE – Neon"   ? palNeonBull  :
               themeOpt=="PA – Pastel" ? palPastelBull:
               themeOpt=="AV – Abyss"  ? palAbyssBull : bullUser
    bearPal := themeOpt=="CU – Cool"   ? palCoolBear  :
               themeOpt=="NE – Neon"   ? palNeonBear  :
               themeOpt=="PA – Pastel" ? palPastelBear:
               themeOpt=="AV – Abyss"  ? palAbyssBear : bearUser

colourCandles = input.bool(true , "Colour candles",                   group="Display")
showNumbers   = input.bool(true , "Show numbers",                     group="Number Style")
useBg         = input.bool(true , "Show background",                  group="Number Style")
bgCol         = input.color(color.new(color.rgb(40,44,52),58), "Background colour", group="Number Style")
numTxtCol     = input.color(color.white, "Number text colour",        group="Number Style")

groupGen       = "General"
minStrength    = input.int (8 , "Min candle strength", minval=1, maxval=10, group=groupGen)
lookbackRSI    = input.int (2 , "RSI look-back bars",  minval=1,            group=groupGen)
showSignals    = input.bool(true, "Show signal arrows",                    group=groupGen)

groupRSI       = "RSI Levels"
overboughtLvl  = input.int(70, "Overbought level", minval=1, maxval=99, group=groupRSI)
oversoldLvl    = input.int(30, "Oversold level" ,  minval=1, maxval=99, group=groupRSI)

groupCS        = "Candle-Strength"
lookbackCS     = input.int  (50 , "Look-back (all bars)", minval=5, group=groupCS)
useFloors      = input.bool (false, "Enforce ATR & volume floors",   group=groupCS)
atrLen         = input.int  (14 , "ATR length",           minval=1, group=groupCS)
atrMult        = input.float(0.5, "Body ≥ atrMult×ATR",   minval=0, group=groupCS)
minVol         = input.float(1e4, "Volume floor",         minval=0, group=groupCS)
sensitivity    = input.float(2.0, "Sensitivity (raw×)",  minval=0.1, step=0.1, group=groupCS)

useSessionNorm = input.bool(false, "Normalise by exchange session only", group=groupCS)

bodyAbs = math.abs(close - open)
atr     = ta.atr(atrLen)

sessString = syminfo.session
inSess     = useSessionNorm ? not na(time(timeframe.period, sessString)) : true

bodyForBase = useSessionNorm ? (inSess ? bodyAbs : na) : bodyAbs
volForBase  = useSessionNorm ? (inSess ? volume : na) : volume

baseBodySess = ta.sma(bodyForBase, lookbackCS)
baseBodyFull = ta.sma(bodyAbs,     lookbackCS)
baseBody     = na(baseBodySess) ? baseBodyFull : baseBodySess

baseVolSess = ta.sma(volForBase, lookbackCS)
baseVolFull = ta.sma(volume,     lookbackCS)
baseVol     = na(baseVolSess) ? baseVolFull : baseVolSess

f_clamp(x, lo, hi) =>
    x < lo ? lo : x > hi ? hi : x

f_lerp(a, b, t) =>
    a + (b - a) * t

f_percentRank(src, len) =>
    int n = 0
    int c = 0
    for i = 0 to len - 1
        float v = src[i]
        if not na(v)
            n += 1
            if v <= src
                c += 1
    n > 0 ? (c / float(n)) : na

tr  = ta.tr(true)
eff = volume / math.max(tr, syminfo.mintick)

effForBase = useSessionNorm ? (inSess ? eff : na) : eff
baseEffSess = ta.sma(effForBase, lookbackCS)
baseEffFull = ta.sma(eff,        lookbackCS)
baseEff     = na(baseEffSess) ? baseEffFull : baseEffSess

vMeanSess = ta.sma(volForBase, lookbackCS)
vStdSess  = ta.stdev(volForBase, lookbackCS)
vMeanFull = ta.sma(volume, lookbackCS)
vStdFull  = ta.stdev(volume, lookbackCS)

vMean = na(vMeanSess) ? vMeanFull : vMeanSess
vStd  = na(vStdSess)  ? vStdFull  : vStdSess

volMultiple() =>
    float mult = na

    if volMethod == "Relative (MA)"
        mult := (not na(baseVol) and baseVol != 0.0) ? (volume / baseVol) : na

    else if volMethod == "Z-score"
        float z = (not na(vStd) and vStd != 0.0) ? ((volume - vMean) / vStd) : na
        
        mult := not na(z) ? math.max(0.05, 1.0 + (z / Z_DIV)) : na

    else if volMethod == "Percentile"
        float r = f_percentRank(volForBase, lookbackCS)
        mult := not na(r) ? f_lerp(PCT_MIN_REL, PCT_MAX_REL, f_clamp(r, 0.0, 1.0)) : na

    else
        mult := (not na(baseEff) and baseEff != 0.0) ? (eff / baseEff) : na

    mult

scoreFor(isBull) =>
    ok = isBull ? close > open : close < open
    if not ok
        0
    else
        bb = baseBody
        vm = volMultiple()

        if na(bb) or bb == 0.0 or na(vm) or vm <= 0.0
            0
        else
            _raw = math.sqrt((bodyAbs / bb) * vm)
            gate = not useFloors or (bodyAbs >= atrMult * atr and volume >= minVol)
            if not gate
                0
            else
                s = math.ceil(_raw * sensitivity)
                math.min(10, math.max(1, s))

scoreBull = scoreFor(true)
scoreBear = scoreFor(false)

isBull = scoreBull > 0
isBear = scoreBear > 0

score = scoreBull > 0 ? scoreBull : scoreBear

bullClr = isBull ? array.get(bullPal, scoreBull - 1) : na
bearClr = isBear ? array.get(bearPal, scoreBear - 1) : na
cFill   = close >= open ? bullClr : bearClr

barcolor(na)
plotcandle(open, high, low, close,
           color       = colourCandles ? cFill : na,
           wickcolor   = colourCandles ? cFill : na,
           bordercolor = colourCandles ? cFill : na)

if showNumbers and score > 0
    mid      = (high + low) / 2
    labStyle = useBg ? label.style_label_up : label.style_none
    labCol   = useBg ? bgCol : na
    label.new(bar_index, mid, str.tostring(score),
              style     = labStyle,
              yloc      = yloc.price,
              size      = size.tiny,
              color     = labCol,
              textcolor = numTxtCol)

rsi = ta.rsi(close, 14)

oversold   = ta.lowest(rsi,  lookbackRSI) < oversoldLvl
overbought = ta.highest(rsi, lookbackRSI) > overboughtLvl

bullSignal = scoreBull >= minStrength and oversold
bearSignal = scoreBear >= minStrength and overbought

sigUpCol = color.new(color.lime, 0)
sigDnCol = color.new(color.red , 0)

plotshape(showSignals and bullSignal,
          title     = "Bull signal",
          style     = shape.triangleup,
          location  = location.belowbar,
          color     = sigUpCol,
          size      = size.tiny)

plotshape(showSignals and bearSignal,
          title     = "Bear signal",
          style     = shape.triangledown,
          location  = location.abovebar,
          color     = sigDnCol,
          size      = size.tiny)

alertcondition(bullSignal,
     title   = "Bull Candle-RSI Signal",
     message = "Bullish strength ≥ {{input:minStrength}} & RSI < {{input:oversoldLvl}} within {{input:lookbackRSI}} bars")

alertcondition(bearSignal,
     title   = "Bear Candle-RSI Signal",
     message = "Bearish strength ≥ {{input:minStrength}} & RSI > {{input:overboughtLvl}} within {{input:lookbackRSI}} bars")
