//@version=6
indicator("Smart Money Pressure Differential", shorttitle = "SMPD", overlay = false)

//---------------------------------------------------------
// Inputs
//---------------------------------------------------------
nviEmaLen = input.int(255, "NVI EMA Length", minval = 1)
pviEmaLen = input.int(255, "PVI EMA Length", minval = 1)
stdLen    = input.int(255, "Standardization Length", minval = 1)
rocLen    = input.int(9,   "ROC Length", minval = 1)

useRocSmoothing = input.bool(true, "Smooth ROC Output")
rocSmoothLen    = input.int(10, "ROC Smoothing Length (WMA)", minval = 1)

useROC = input.bool(true, "Enable ROC Layer (Dotted Lines)")

//---------------------------------------------------------
// NVI & PVI (scaled ×1000 like original scripts)
//---------------------------------------------------------
nvi = ta.nvi * 1000.0
pvi = ta.pvi * 1000.0

nviEma = ta.ema(nvi, nviEmaLen)
pviEma = ta.ema(pvi, pviEmaLen)

//---------------------------------------------------------
// Differences (Deviation from signal)
//---------------------------------------------------------
nviDiff = nvi - nviEma
pviDiff = pvi - pviEma

//---------------------------------------------------------
// Standardization function
//---------------------------------------------------------
f_std(series, len) =>
    m = ta.sma(series, len)
    d = ta.stdev(series, len)
    d != 0 ? (series - m) / d : na

//---------------------------------------------------------
// Standardize NVI and PVI separately BEFORE differencing
//---------------------------------------------------------
stdNviDiff = f_std(nviDiff, stdLen)
stdPviDiff = f_std(pviDiff, stdLen)

// Spread = standardized NVI minus standardized PVI
stdSpreadDiff = stdNviDiff - stdPviDiff

//---------------------------------------------------------
// LOG-ROC function (stable acceleration)
//---------------------------------------------------------
// f_roc(series, len) =>
//     series[len] != 0 ? 100 * math.log(series / series[len]) : na

// //---------------------------------------------------------
// // ROC of standardized differences (log-ROC)
// //---------------------------------------------------------
// rocNviDiff    = f_roc(stdNviDiff, rocLen)
// rocPviDiff    = f_roc(stdPviDiff, rocLen)
// rocSpreadDiff = f_roc(stdSpreadDiff, rocLen)

// //---------------------------------------------------------
// // Standardized ROC
// //---------------------------------------------------------
// stdRocNviDiff    = f_std(rocNviDiff, stdLen)
// stdRocPviDiff    = f_std(rocPviDiff, stdLen)
// stdRocSpreadDiff = f_std(rocSpreadDiff, stdLen)

//---------------------------------------------------------
// Stable ROC Alternative for Z-Scores
//---------------------------------------------------------
// f_stable_roc(src, len) =>
//     change = src - src[len]
//     volatility = ta.stdev(src, len)
//     // Divide change by volatility instead of the source value
//     // This scales the 'velocity' without the zero-division explosion
//     volatility != 0 ? change / volatility : 0

// ROC (Momentum) of standardized differences
// rocNviDiff      = f_stable_roc(stdNviDiff,      rocLen)
// rocPviDiff      = f_stable_roc(stdPviDiff,      rocLen)
// rocSpreadDiff   = f_stable_roc(stdSpreadDiff, rocLen)

//---------------------------------------------------------
// ROC of standardized differences
//---------------------------------------------------------
f_roc(src, len) =>
    100 * (src - src[len])/src[len]

// ROC (Momentum) of standardized differences
rocNviDiff      = f_roc(stdNviDiff,      rocLen)
rocPviDiff      = f_roc(stdPviDiff,      rocLen)
rocSpreadDiff   = f_roc(stdSpreadDiff, rocLen)

// Now standardizing these is safe and will not explode
stdRocNviDiff    = f_std(rocNviDiff,    stdLen)
stdRocPviDiff    = f_std(rocPviDiff,    stdLen)
stdRocSpreadDiff = f_std(rocSpreadDiff, stdLen)

//---------------------------------------------------------
// OPTIONAL POST‑ROC SMOOTHING (WMA)
//---------------------------------------------------------
smoothStdRocNviDiff    = useRocSmoothing ? ta.wma(stdRocNviDiff, rocSmoothLen)    : stdRocNviDiff
smoothStdRocPviDiff    = useRocSmoothing ? ta.wma(stdRocPviDiff, rocSmoothLen)    : stdRocPviDiff
smoothStdRocSpreadDiff = useRocSmoothing ? ta.wma(stdRocSpreadDiff, rocSmoothLen) : stdRocSpreadDiff

//---------------------------------------------------------
// Plotting — Standardized Differences (LINES)
//---------------------------------------------------------
plot(stdNviDiff,     "Std NVI Diff",     color = color.new(color.green, 0), linewidth = 1)
plot(stdPviDiff,     "Std PVI Diff",     color = color.new(color.blue, 0),  linewidth = 1)
plot(stdSpreadDiff,  "Std Spread Diff",  color = color.new(color.orange, 0), linewidth = 1)

//---------------------------------------------------------
// Plotting — Standardized ROC (DOTTED LINES, TOGGLED)
//---------------------------------------------------------
plot(useROC ? smoothStdRocNviDiff    : na, "Std ROC NVI Diff",    color = color.new(color.green, 0), linewidth = 2, linestyle = plot.linestyle_dotted)
plot(useROC ? smoothStdRocPviDiff    : na, "Std ROC PVI Diff",    color = color.new(color.blue , 0), linewidth = 2, linestyle = plot.linestyle_dotted)
plot(useROC ? smoothStdRocSpreadDiff : na, "Std ROC Spread Diff", color = color.new(color.orange, 0), linewidth = 2, linestyle = plot.linestyle_dotted)

//---------------------------------------------------------
// SD Reference Lines
//---------------------------------------------------------
hline(0,  "Midline",     color = color.gray, linestyle = hline.style_solid)
hline(1,  "Upper 1 SD",  color = color.gray, linestyle = hline.style_dashed)
hline(-1, "Lower 1 SD",  color = color.gray, linestyle = hline.style_dashed)
hline(2,  "Upper 2 SD",  color = color.red,  linestyle = hline.style_dashed)
hline(-2, "Lower 2 SD",  color = color.red,  linestyle = hline.style_dashed)
hline(3,  "Upper 3 SD",  color = color.red,  linestyle = hline.style_dotted)
hline(-3, "Lower 3 SD",  color = color.red,  linestyle = hline.style_dotted)

//---------------------------------------------------------
// Volume availability check
//---------------------------------------------------------
if ta.cum(nz(volume)) == 0.0 and barstate.islastconfirmedhistory
    runtime.error("No volume is provided by the data vendor.")
