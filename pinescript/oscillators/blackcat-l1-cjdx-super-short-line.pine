//** 
//* 【Script Summary】
//* Indicator Name: CJDX Super Short Line - Optimized with Buy/Sell Signals
//* Indicator Type: Sub-chart Indicator
//* Core Function: Short-term momentum indicator based on triple exponential moving average, 
//*                generating buy/sell signals through optimized K/D line golden cross and death cross
//* 
//* 【Optimization Strategy】
//* 1. Smoothing Optimization: Use EMA instead of SMA to reduce lag while maintaining smoothness
//*    - K line: Changed from MA(J,1) to EMA(J,3)
//*    - D line: Changed from MA(J,3) to EMA(J,5)
//* 2. Momentum Confirmation: Added J value filter conditions
//*    - Buy signal: Golden cross and J>0 (confirming upward momentum)
//*    - Sell signal: Death cross and J<0 (confirming downward momentum)
//* 3. Signal Filtering: Use filter function to filter consecutive signals, avoiding frequent trading
//*    - Buy/sell signals must be at least 3 periods apart
//* 
//* 【Buy/Sell Signal Generation Logic】
//* - Golden Cross Buy: K line (fast line) crosses above D line (slow line) and J>0, displays "B" marker
//* - Death Cross Sell: K line (fast line) crosses below D line (slow line) and J<0, displays "S" marker
//* - J line (histogram): Shows price momentum changes, positive values indicate upward momentum, negative values indicate downward momentum
//* - D line (red): 5-day exponential moving average of J line, serves as slow signal line
//* - K line (white): 3-day exponential moving average of J line, serves as fast line


//@version=6
indicator("[blackcat] L1 CJDX Super Short Line", overlay=false, shorttitle="L1 CJDX", max_bars_back=5000)

// ==================== Parameter Definition ====================
// Signal gap period count (minimum interval between buy/sell signals)
int signalGapPeriod = 3

// ==================== Base Calculation ====================
// Calculate weightedTypicalPrice: weighted typical price, (2*close+high+low)/4
float weightedTypicalPrice = (2 * close + high + low) / 4

// Calculate tripleEmaValue: triple 4-day exponential moving average of weightedTypicalPrice, very high smoothness
float tripleEmaValue = ta.ema(ta.ema(ta.ema(weightedTypicalPrice, 4), 4), 4)

// Calculate jLineMomentum: rate of change of tripleEmaValue, (current value - previous value) / previous value * 100
float jLineMomentum = (tripleEmaValue - tripleEmaValue[1]) / tripleEmaValue[1] * 100

// Plot J line histogram (positive values red, negative values green)
plot(jLineMomentum, "J Histogram", color=jLineMomentum >= 0 ? color.red : color.green, style=plot.style_columns)

// ==================== Optimized K/D Line Calculation ====================
// Calculate kLineFast: 3-day exponential moving average of J line (optimization: originally 1-day SMA, now 3-day EMA to reduce noise)
float kLineFast = ta.ema(jLineMomentum, 3)

// Calculate dLineSlow: 5-day exponential moving average of J line (optimization: originally 3-day SMA, now 5-day EMA for smoother result)
float dLineSlow = ta.ema(jLineMomentum, 5)

// Plot K line, using white color
plot(kLineFast, "K", color=color.white)

// Plot D line, using red color
plot(dLineSlow, "D", color=color.red)

// ==================== Signal Generation and Filtering ====================
// Golden cross condition: K line crosses above D line
bool isGoldenCross = ta.crossover(kLineFast, dLineSlow)

// Death cross condition: K line crosses below D line
bool isDeathCross = ta.crossunder(kLineFast, dLineSlow)

// Raw buy signal: golden cross and J>0 (momentum confirmation, ensure buying in uptrend)
bool rawBuySignal = isGoldenCross and jLineMomentum > 0

// Raw sell signal: death cross and J<0 (momentum confirmation, ensure selling in downtrend)
bool rawSellSignal = isDeathCross and jLineMomentum < 0

// ==================== Signal Filtering Implementation ====================
// Filter consecutive signals: buy/sell signals must be at least signalGapPeriod periods apart
// TScript's filter(x,n) function implementation: ensure signals are at least n periods apart
var int lastBuyBarIndex = na
var int lastSellBarIndex = na

// Filter buy signal
bool filteredBuySignal = rawBuySignal and (na(lastBuyBarIndex) or (bar_index - lastBuyBarIndex) >= signalGapPeriod)
if filteredBuySignal
    lastBuyBarIndex := bar_index

// Filter sell signal
bool filteredSellSignal = rawSellSignal and (na(lastSellBarIndex) or (bar_index - lastSellBarIndex) >= signalGapPeriod)
if filteredSellSignal
    lastSellBarIndex := bar_index

// ==================== Plot Buy/Sell Markers ====================
// Plot buy signal marker - display B text, red color, located below K line (y offset -20)
// Corresponding TScript: drawText(buySignal,k,"B",color="red",y=-20);
var label buySignalLabel = na
if filteredBuySignal
    buySignalLabel := label.new(bar_index, kLineFast, "B",
                          color=color.new(color.white, 10),  // transparent background
                          style=label.style_label_center,
                          textcolor=color.red,
                          size=size.normal,
                          textalign=text.align_center)

// Plot sell signal marker - display S text, green color, located above K line (y offset +20)
// Corresponding TScript: drawText(sellSignal,k,"S",color="green",y=20);
var label sellSignalLabel = na
if filteredSellSignal
    sellSignalLabel := label.new(bar_index, kLineFast, "S",
                           color=color.new(color.white, 10),  // transparent background
                           style=label.style_label_center,
                           textcolor=color.green,
                           size=size.normal,
                           textalign=text.align_center)

// ==================== Zero Axis Reference Line ====================
hline(0, "Zero Axis", color=color.gray, linestyle=hline.style_dotted)
