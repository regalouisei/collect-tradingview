//@version=5
indicator("VWAP + STD Dashboard (D/W/M)", overlay=true)

// =======================
// Inputs
// =======================
showTable = input.bool(true, "Show Dashboard Table")
src       = input.source(close, "Price used for status")
typPrice  = input.source(hlc3, "Typical price for VWAP/STD calc (recommended: HLC3)")

// =======================
// Helpers
// =======================
statusVWAP(float v) =>
    na(v) ? "n/a" : (src >= v ? "Bullish" : "Bearish")

statusSTD(float mean, float sd) =>
    if na(mean) or na(sd)
        "n/a"
    else
        upper = mean + sd
        lower = mean - sd
        src > upper ? "Bullish" : src < lower ? "Bearish" : "Balanced market"

bgForStatus(string s) =>
    s == "Bullish" ? color.new(color.green, 0) :
     s == "Bearish" ? color.new(color.red, 0) :
     s == "Balanced market" ? color.new(color.gray, 15) :
     color.new(color.gray, 80)

txtForStatus(string s) =>
    s == "n/a" ? color.new(color.white, 0) : color.new(color.white, 0)

// =======================
// Anchored VWAP (reset by timeframe boundary)
// =======================

// ---- Daily VWAP
newD = ta.change(time("D"))
var float d_cumPV = na
var float d_cumV  = na
if barstate.isfirst
    d_cumPV := typPrice * volume
    d_cumV  := volume
else
    if newD
        d_cumPV := typPrice * volume
        d_cumV  := volume
    else
        d_cumPV += typPrice * volume
        d_cumV  += volume
d_vwap = (d_cumV != 0) ? (d_cumPV / d_cumV) : na

// ---- Weekly VWAP
newW = ta.change(time("W"))
var float w_cumPV = na
var float w_cumV  = na
if barstate.isfirst
    w_cumPV := typPrice * volume
    w_cumV  := volume
else
    if newW
        w_cumPV := typPrice * volume
        w_cumV  := volume
    else
        w_cumPV += typPrice * volume
        w_cumV  += volume
w_vwap = (w_cumV != 0) ? (w_cumPV / w_cumV) : na

// ---- Monthly VWAP
newM = ta.change(time("M"))
var float m_cumPV = na
var float m_cumV  = na
if barstate.isfirst
    m_cumPV := typPrice * volume
    m_cumV  := volume
else
    if newM
        m_cumPV := typPrice * volume
        m_cumV  := volume
    else
        m_cumPV += typPrice * volume
        m_cumV  += volume
m_vwap = (m_cumV != 0) ? (m_cumPV / m_cumV) : na

// =======================
// Volume-weighted STD around VWAP (Â±1)
//   sd = sqrt(E[p^2] - (E[p])^2), with weights = volume
// =======================

// ---- Weekly STD
var float w_cumP2V = na
if barstate.isfirst
    w_cumP2V := (typPrice * typPrice) * volume
else
    if newW
        w_cumP2V := (typPrice * typPrice) * volume
    else
        w_cumP2V += (typPrice * typPrice) * volume

w_mean = w_vwap
w_var  = (w_cumV != 0) ? (w_cumP2V / w_cumV - w_mean * w_mean) : na
w_std  = na(w_var) ? na : math.sqrt(math.max(w_var, 0))

// ---- Monthly STD
var float m_cumP2V = na
if barstate.isfirst
    m_cumP2V := (typPrice * typPrice) * volume
else
    if newM
        m_cumP2V := (typPrice * typPrice) * volume
    else
        m_cumP2V += (typPrice * typPrice) * volume

m_mean = m_vwap
m_var  = (m_cumV != 0) ? (m_cumP2V / m_cumV - m_mean * m_mean) : na
m_std  = na(m_var) ? na : math.sqrt(math.max(m_var, 0))

// =======================
// Status strings
// =======================
s_m_vwap = statusVWAP(m_vwap)
s_w_vwap = statusVWAP(w_vwap)
s_d_vwap = statusVWAP(d_vwap)
s_w_std  = statusSTD(w_mean, w_std)
s_m_std  = statusSTD(m_mean, m_std)

// =======================
// Table (Top Right): 5 rows x 2 cols
// =======================
var table t = table.new(position.top_right, 2, 5, frame_color=color.new(color.gray, 0), border_width=1)

if showTable and barstate.islast
    // Row 0
    table.cell(t, 0, 0, "VWAP monthly", text_color=color.white)
    table.cell(t, 1, 0, s_m_vwap, text_color=txtForStatus(s_m_vwap), bgcolor=bgForStatus(s_m_vwap))

    // Row 1
    table.cell(t, 0, 1, "VWAP weekly", text_color=color.white)
    table.cell(t, 1, 1, s_w_vwap, text_color=txtForStatus(s_w_vwap), bgcolor=bgForStatus(s_w_vwap))

    // Row 2
    table.cell(t, 0, 2, "VWAP daily", text_color=color.white)
    table.cell(t, 1, 2, s_d_vwap, text_color=txtForStatus(s_d_vwap), bgcolor=bgForStatus(s_d_vwap))

    // Row 3
    table.cell(t, 0, 3, "Weekly STD", text_color=color.white)
    table.cell(t, 1, 3, s_w_std, text_color=txtForStatus(s_w_std), bgcolor=bgForStatus(s_w_std))

    // Row 4
    table.cell(t, 0, 4, "Monthly STD", text_color=color.white)
    table.cell(t, 1, 4, s_m_std, text_color=txtForStatus(s_m_std), bgcolor=bgForStatus(s_m_std))

// Optional: you can plot nothing, table is overlay anyway.
