//@version=6
indicator("Liquidity Oscillator (Spread-Adjusted)", overlay=false, precision=2)

// ─────────────────────────────────────────────
// Inputs
impactLen   = input.int(14,  "Impact Length", minval=1)
normLen     = input.int(100, "Normalization Length", minval=20)
smoothLen   = input.int(5,   "Smoothing", minval=1)

// Spread regime controls
spreadLen   = input.int(100, "Spread Lookback")
rangeMult   = input.float(1.5, "High/Low Range Multiplier")

// ─────────────────────────────────────────────
float eps = 1e-10

// ─────────────────────────────────────────────
// Spread proxy (bid/ask proxy)
spreadRaw = high - low
spreadPct = spreadRaw / math.max(close, eps)

// Historical spread stats
spreadMean = ta.sma(spreadPct, spreadLen)
spreadStd  = ta.stdev(spreadPct, spreadLen)

// Define regimes numerically
tightSpread = spreadMean - spreadStd * rangeMult
wideSpread  = spreadMean + spreadStd * rangeMult

// Spread factor (penalize wide spreads)
spreadFactor = spreadPct / math.max(spreadMean, eps)

// ─────────────────────────────────────────────
// Dollar volume
dollarVol = volume * close

// Price impact proxy
retAbs = math.abs(ta.change(close)) / math.max(close[1], eps)
impact = ta.ema(retAbs, impactLen)

// Liquidity proxy (spread-adjusted)
liqRaw = dollarVol / (math.max(impact, eps) * (1 + spreadFactor))

// Log compress
liqLog = math.log(math.max(liqRaw, eps))

// Z-score normalize
mean  = ta.sma(liqLog, normLen)
stdev = ta.stdev(liqLog, normLen)
z = (liqLog - mean) / math.max(stdev, eps)

// Oscillator
oscUnsmoothed = (2 / math.pi) * math.atan(z) * 100
osc = ta.ema(oscUnsmoothed, smoothLen)

// ─────────────────────────────────────────────
// Dynamic Levels Based on Historical Ranges
hiLevel =  50 * rangeMult
loLevel = -50 * rangeMult

// ─────────────────────────────────────────────
// Plot
plot(osc, "Liquidity", linewidth=2)

hline(hiLevel, "High Liquidity", linestyle=hline.style_dotted)
hline(0, "Mid", linestyle=hline.style_dotted)
hline(loLevel, "Low Liquidity", linestyle=hline.style_dotted)

// End-Indicator
