//@version=5
indicator(title="OBV with Divergence (SMA Smoother)", shorttitle="OBV_Div_SMA", overlay=false)

// --- INPUTS ---
len = input.int(20, title="OBV EMA Length")

// --- Smoothing Line Feature ---
useSMA = input.bool(false, title="Show SMA Smoothing Line")
smaLen = input.int(5, title="SMA Smoothing Length", minval=1)
// ------------------------------

lbR = input.int(title="Pivot Lookback Right", defval=5)
lbL = input.int(title="Pivot Lookback Left", defval=5)
rangeUpper = input.int(title="Max of Lookback Range", defval=60)
rangeLower = input.int(title="Min of Lookback Range", defval=5)
plotBull = input.bool(title="Plot Regular Bullish", defval=true)
plotHiddenBull = input.bool(title="Plot Hidden Bullish", defval=false)
plotBear = input.bool(title="Plot Regular Bearish", defval=true)
plotHiddenBear = input.bool(title="Plot Hidden Bearish", defval=false)

// --- COLORS ---
bearColor = color.red
bullColor = color.green
hiddenBullColor = color.new(color.green, 80)
hiddenBearColor = color.new(color.red, 80)
textColor = color.white
noneColor = color.new(color.white, 100)

// --- OBV AND OSCILLATOR CALCULATION ---
obv_calc(src) =>
    // The v5 way to calculate OBV
    ta.cum(ta.change(src) > 0 ? volume : ta.change(src) < 0 ? -volume : 0 * volume)

os = obv_calc(close)
// OBV Oscillator (OBV - EMA of OBV)
obv_osc = os - ta.ema(os, len) 

// --- SMA Smoothing Calculation ---
obv_osc_sma = ta.sma(obv_osc, smaLen)


// --- PLOTS ---
obc_color = obv_osc > 0 ? color.green : color.red
plot(obv_osc, color=obc_color, style=plot.style_line, title="OBV-Points", linewidth=2)
plot(obv_osc, color=color.silver, transp=70, title="OBV Area", style=plot.style_area)

// Plot the SMA Smoothing Line (New Feature)
plot(useSMA ? obv_osc_sma : na, color=color.blue, title="SMA Smoothing Line", linewidth=2, display=display.all)

hline(0, color=color.gray, linestyle=hline.style_dashed, title="Zero Line")


// --- PIVOT LOGIC ---
plFound = na(ta.pivotlow(obv_osc, lbL, lbR)) ? false : true
phFound = na(ta.pivothigh(obv_osc, lbL, lbR)) ? false : true

_inRange(cond) =>
    bars = ta.barssince(cond)
    rangeLower <= bars and bars <= rangeUpper

//------------------------------------------------------------------------------
// Regular Bullish (Osc: HL, Price: LL)
oscHL = obv_osc[lbR] > ta.valuewhen(plFound, obv_osc[lbR], 1) and _inRange(plFound[1])
priceLL = low[lbR] < ta.valuewhen(plFound, low[lbR], 1)
bullCond = plotBull and priceLL and oscHL and plFound

plot(
     plFound ? obv_osc[lbR] : na,
     offset=-lbR,
     title="Regular Bullish Plot",
     linewidth=2,
     color=(bullCond ? bullColor : noneColor),
     transp=0
     )

plotshape(
     bullCond ? obv_osc[lbR] : na,
     offset=-lbR,
     title="Regular Bullish Label",
     text=" Bull ",
     style=shape.labelup,
     location=location.absolute,
     color=bullColor,
     textcolor=textColor,
     transp=0
     )

//------------------------------------------------------------------------------
// Hidden Bullish (Osc: LL, Price: HL)
oscLL = obv_osc[lbR] < ta.valuewhen(plFound, obv_osc[lbR], 1) and _inRange(plFound[1])
priceHL = low[lbR] > ta.valuewhen(plFound, low[lbR], 1)
hiddenBullCond = plotHiddenBull and priceHL and oscLL and plFound

plot(
     plFound ? obv_osc[lbR] : na,
     offset=-lbR,
     title="Hidden Bullish Plot",
     linewidth=2,
     color=(hiddenBullCond ? hiddenBullColor : noneColor),
     transp=0
     )

plotshape(
     hiddenBullCond ? obv_osc[lbR] : na,
     offset=-lbR,
     title="Hidden Bullish Label",
     text=" H Bull ",
     style=shape.labelup,
     location=location.absolute,
     color=bullColor,
     textcolor=textColor,
     transp=0
     )

//------------------------------------------------------------------------------
// Regular Bearish (Osc: LH, Price: HH)
oscLH = obv_osc[lbR] < ta.valuewhen(phFound, obv_osc[lbR], 1) and _inRange(phFound[1])
priceHH = high[lbR] > ta.valuewhen(phFound, high[lbR], 1)
bearCond = plotBear and priceHH and oscLH and phFound

plot(
     phFound ? obv_osc[lbR] : na,
     offset=-lbR,
     title="Regular Bearish Plot",
     linewidth=2,
     color=(bearCond ? bearColor : noneColor),
     transp=0
     )

plotshape(
     bearCond ? obv_osc[lbR] : na,
     offset=-lbR,
     title="Regular Bearish Label",
     text=" Bear ",
     style=shape.labeldown,
     location=location.absolute,
     color=bearColor,
     textcolor=textColor,
     transp=0
     )

//------------------------------------------------------------------------------
// Hidden Bearish (Osc: HH, Price: LH)
oscHH = obv_osc[lbR] > ta.valuewhen(phFound, obv_osc[lbR], 1) and _inRange(phFound[1])
priceLH = high[lbR] < ta.valuewhen(phFound, high[lbR], 1)
hiddenBearCond = plotHiddenBear and priceLH and oscHH and phFound

plot(
     phFound ? obv_osc[lbR] : na,
     offset=-lbR,
     title="Hidden Bearish Plot",
     linewidth=2,
     color=(hiddenBearCond ? hiddenBearColor : noneColor),
     transp=0
     )

plotshape(
     hiddenBearCond ? obv_osc[lbR] : na,
     offset=-lbR,
     title="Hidden Bearish Label",
     text=" H Bear ",
     style=shape.labeldown,
     location=location.absolute,
     color=bearColor,
     textcolor=textColor,
     transp=0
     )
