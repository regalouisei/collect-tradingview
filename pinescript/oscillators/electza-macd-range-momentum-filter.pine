//@version=5
indicator("EZ_RangeMACD", overlay=false, max_labels_count=500)

//-----------------------------------------------------
// Inputs
//-----------------------------------------------------
fastLen     = input.int(12,  "Fast Length")
slowLen     = input.int(26,  "Slow Length")
signalLen   = input.int(9,   "Signal Length")
rangeLen    = input.int(20,  "Range Length (ATR)")
rangeThresh = input.float(0.85, "Range Threshold", step=0.05)
showSignal  = input.bool(true, "Show Buy / Sell Signals")

//-----------------------------------------------------
// MACD Core Calculation
//-----------------------------------------------------
fastMA   = ta.ema(close, fastLen)
slowMA   = ta.ema(close, slowLen)
macdLine = fastMA - slowMA
signal   = ta.ema(macdLine, signalLen)
hist     = macdLine - signal

//-----------------------------------------------------
// Range Detector (ATR Compression)
//-----------------------------------------------------
atrVal  = ta.atr(1)
atrAvg  = ta.sma(atrVal, rangeLen)
inRange = atrVal < atrAvg * rangeThresh

//-----------------------------------------------------
// Color Logic
//-----------------------------------------------------
histColor = inRange ? color.new(color.gray, 75) :
     hist > 0 ? color.new(color.lime, 0) :
     color.new(color.red, 0)

signalColor = color.new(color.white, 30)

//-----------------------------------------------------
// Plots (MACD Style)
//-----------------------------------------------------
plot(hist,  title="Histogram", style=plot.style_histogram, color=histColor, linewidth=3)
plot(macdLine, title="MACD", color=color.new(color.aqua, 0), linewidth=2)
plot(signal,   title="Signal", color=signalColor, linewidth=1)

// Center line
hline(0, "Zero", color=color.new(color.white, 50))

//-----------------------------------------------------
// Buy/Sell Signals (Optional)
//-----------------------------------------------------
buy  = not inRange and ta.crossover(macdLine, signal)
sell = not inRange and ta.crossunder(macdLine, signal)

plotshape(showSignal and buy,  title="Buy",  style=shape.triangleup, color=color.lime, location=location.bottom, size=size.tiny)
plotshape(showSignal and sell, title="Sell", style=shape.triangledown, color=color.red,  location=location.top,    size=size.tiny)

// Background shading for range areas
bgcolor(inRange ? color.new(color.gray, 85) : na)
