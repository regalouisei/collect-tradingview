//@version=6
strategy(
     "3Commas DCA Strategy Backtesting [The Quant Science]",
     overlay = false,
     default_qty_type = strategy.cash,
     default_qty_value = 1000,
     pyramiding = 100,
     currency = currency.USDT,
     initial_capital = 10000,
     commission_type = strategy.commission.percent,
     commission_value = 0.07,
     slippage = 5,
     process_orders_on_close = true,
     close_entries_rule = "ANY"
     )

// DATE RANGE FEATURE 
start_date  = input.int(title="D: ", defval=1,    minval=1,    maxval=31,   inline = 'Start', group = "DATE PERIOD BACKTESTING")
start_month = input.int(title="M: ", defval=1,    minval=1,    maxval=12,   inline = 'Start', group = "DATE PERIOD BACKTESTING")
start_year  = input.int(title="Y: ", defval=2021, minval=1800, maxval=2100, inline = 'Start', group = "DATE PERIOD BACKTESTING")
end_date    = input.int(title="D: ", defval=31,   minval=1,    maxval=31,   inline = 'End',   group = "DATE PERIOD BACKTESTING")
end_month   = input.int(title="M: ", defval=12,   minval=1,    maxval=12,   inline = 'End',   group = "DATE PERIOD BACKTESTING")
end_year    = input.int(title="Y: ", defval=2026, minval=1800, maxval=2100, inline = 'End',   group = "DATE PERIOD BACKTESTING")

in_date_range = (time >= timestamp(syminfo.timezone, start_year, start_month, start_date, 0, 0)) and (time < timestamp(syminfo.timezone, end_year, end_month, end_date, 0, 0))

// BASE ORDER SIZE CONFIGURATION
qty_base = input.int(defval = 1000, minval = 0, step = 1, title = "Base order (USDT):", group = "STRATEGY", tooltip = "The Base Order is the first order the bot will create when starting a new trade.", inline = "base-order-size")

// RSI INDICATOR 
lenght_period = input.int(title="Lenght", defval=7, minval=0, group = "START DEAL CONDITION", inline = "rsi")
trigger_rsi = input.int(title="Trigger RSI", defval=35, minval=0, group = "START DEAL CONDITION", inline = "rsi")
rsi = ta.rsi(close, lenght_period)

rsi_color_green = rsi <= trigger_rsi 
rsi_color_red = rsi >= trigger_rsi
rsi_color = rsi_color_red ? #ff0000 : rsi_color_green ? #00ff00 : #00ff00

plot(rsi,  title = "RSI", color = rsi_color, linewidth = 1)
hline(0, title = "RSI - Bottom line", color = color.rgb(0, 255, 8))
hline(100, title = "RSI - Top line", color = color.rgb(255, 39, 39))
hline(trigger_rsi, title = "RSI - Trigger value", color = color.rgb(72, 73, 73), linewidth = 2, linestyle = hline.style_dotted)

rsi_entry_condition = ta.crossunder(rsi, trigger_rsi) 

// AVERAGING ORDERS
qty_dca = input.int(defval = 100, minval = 0, step = 1, title = "Averaging order size (USDT: ", group = "AVERAGING ORDERS", inline = "Header", tooltip = "Enter the amount of funds your averaging orders.", confirm = true)
DROP = input.float(defval = 1,  minval = 0, title = "Price Deviation (% from initial order): ", step = 0.10, group = "AVERAGING ORDERS", inline = "Drop", tooltip = "Deviation to open first averaging order", confirm = true)
SAFETY_ORDER_VOLUME_SCALE = input.float(defval = 1.7, minval = 0, step = 0.1, maxval = 100, title = "Order size multiplier: ", group = "AVERAGING ORDERS", confirm = true)
STEP_SCALE_VALUE = input.float(defval = 4, minval = 0, maxval = 100, title = "Deviation step multiplier: ", step = 0.10, group = "AVERAGING ORDERS", confirm = true)

// TAKE PROFIT FEATURE 
PROFIT = input.float(defval = 2.4, minval = 0, title = "Target profit (%): ", step = 0.10, group = "TAKE PROFIT", inline = "pov", tooltip = "Configure the percentage 'Take Profit' target the strategy will use to close successful trades, the strategy will automatically account for exchange fees.", confirm = true)

// STOP LOSS FEATURE 
STOPLOSS = input.bool(defval = false, title = "", group = "STOP LOSS", inline = "SL")
STOPLOSSVALUE  = input.float(defval = 99, minval = 0, title = "Stop loss (%): ", step = 0.10, group = "STOP LOSS", inline = "SL", tooltip = "This is the percentage that price needs to move in the opposite direction to your take profit target, at which point the strategy will execute a 'Market Order' on the exchange account to close the deal for a smaller loss than keeping the deal open. Please note, the 'Stop Loss' is calculated from the price the initial 'Base Order' was filled at on the exchange account and not the Dollar Cost Average price.")

// INITIALIZE VARIABLES 
var float equity = 0

var float base_order_price = 0
var float dca1   = 0
var float dca2   = 0
var float dca3   = 0
var float dca4   = 0
var float dca5   = 0
var float dca6   = 0
var float dca7   = 0
var float dca8   = 0
var float dca9   = 0
var float dca10  = 0

var float exit_condition_long = 0 
var float exit_condition_stoploss = 0 

// STARTING DCA CONDITIONS 
if (rsi_entry_condition and in_date_range and strategy.opentrades==0) 

    equity := strategy.equity
    base_order_price := close 

    // DEFINE PRICE LEVELS 
    dca1  := (base_order_price - (base_order_price * (DROP * (STEP_SCALE_VALUE * 1))/ 100)) 
    dca2  := (dca1 - (dca1 * (DROP * (STEP_SCALE_VALUE * 2))  / 100)) 
    dca3  := (dca2 - (dca2 * (DROP * (STEP_SCALE_VALUE * 3))  / 100)) 
    dca4  := (dca3 - (dca3 * (DROP * (STEP_SCALE_VALUE * 4))  / 100)) 
    dca5  := (dca4 - (dca4 * (DROP * (STEP_SCALE_VALUE * 5))  / 100)) 
    dca6  := (dca5 - (dca5 * (DROP * (STEP_SCALE_VALUE * 6))  / 100))
    dca7  := (dca6 - (dca6 * (DROP * (STEP_SCALE_VALUE * 7))  / 100)) 
    dca8  := (dca7 - (dca7 * (DROP * (STEP_SCALE_VALUE * 8))  / 100))
    dca9  := (dca8 - (dca8 * (DROP * (STEP_SCALE_VALUE * 9))  / 100))
    dca10 := (dca9 - (dca9 * (DROP * (STEP_SCALE_VALUE * 10)) / 100))

    // DEFINE TAKE PROFIT EXIT 
    exit_condition_long := equity + (equity * PROFIT / 100)

    // DEFINE STOP LOSS EXIT 
    if STOPLOSS==true
        exit_condition_stoploss := base_order_price - (base_order_price * STOPLOSSVALUE / 100)

    // PLACE ORDERS 
    strategy.entry(id = "Buy",  direction = strategy.long, qty = qty_base/base_order_price, limit = base_order_price)
    strategy.entry(id = "SO1",  direction = strategy.long, qty = qty_dca  * (SAFETY_ORDER_VOLUME_SCALE * 1) /dca1,  limit = dca1)
    strategy.entry(id = "SO2",  direction = strategy.long, qty = qty_dca  * (SAFETY_ORDER_VOLUME_SCALE * 2) /dca2,  limit = dca2)
    strategy.entry(id = "SO3",  direction = strategy.long, qty = qty_dca  * (SAFETY_ORDER_VOLUME_SCALE * 3) /dca3,  limit = dca3)
    strategy.entry(id = "SO4",  direction = strategy.long, qty = qty_dca  * (SAFETY_ORDER_VOLUME_SCALE * 4) /dca4,  limit = dca4)
    strategy.entry(id = "SO5",  direction = strategy.long, qty = qty_dca  * (SAFETY_ORDER_VOLUME_SCALE * 5) /dca5,  limit = dca5)
    strategy.entry(id = "SO6",  direction = strategy.long, qty = qty_dca  * (SAFETY_ORDER_VOLUME_SCALE * 6) /dca6,  limit = dca6)
    strategy.entry(id = "SO7",  direction = strategy.long, qty = qty_dca  * (SAFETY_ORDER_VOLUME_SCALE * 7) /dca7,  limit = dca7)
    strategy.entry(id = "SO8",  direction = strategy.long, qty = qty_dca  * (SAFETY_ORDER_VOLUME_SCALE * 8) /dca8,  limit = dca8)
    strategy.entry(id = "SO9",  direction = strategy.long, qty = qty_dca  * (SAFETY_ORDER_VOLUME_SCALE * 9) /dca9,  limit = dca9)
    strategy.entry(id = "SO10", direction = strategy.long, qty = qty_dca  * (SAFETY_ORDER_VOLUME_SCALE * 10) /dca10, limit = dca10)

// EXIT CONDITIONS
stop_loss_target =  ta.crossunder(close, exit_condition_stoploss)
take_profit_gain = ta.crossover(strategy.equity, exit_condition_long)

if (take_profit_gain and in_date_range)

    strategy.close_all("Take Profit")

    strategy.cancel("SO1")
    strategy.cancel("SO2")
    strategy.cancel("SO3")
    strategy.cancel("SO4")
    strategy.cancel("SO5")
    strategy.cancel("SO6")
    strategy.cancel("SO7")
    strategy.cancel("SO8")
    strategy.cancel("SO9")
    strategy.cancel("SO10")

if (stop_loss_target and in_date_range)

    strategy.close_all("Stop Loss")

    strategy.cancel("SO1")
    strategy.cancel("SO2")
    strategy.cancel("SO3")
    strategy.cancel("SO4")
    strategy.cancel("SO5")
    strategy.cancel("SO6")
    strategy.cancel("SO7")
    strategy.cancel("SO8")
    strategy.cancel("SO9")
    strategy.cancel("SO10")
 
// BANKRUPTCY CHECK
if strategy.equity < 0
    runtime.error("Bankruptcy! The equity line of this backtesting is negative. Try the backtesting again using different parameters, or reduce or increase the test period.")