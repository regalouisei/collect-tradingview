// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © DivergentTrades

//@version=6
indicator("AI-Enhanced MSS Hunter", shorttitle="AI-HUNTER", overlay=true, max_bars_back=2000)

// -------------------------------------------------------------------------
// 1. SETTINGS
// -------------------------------------------------------------------------
grp_time   = "Time Windows (Kill Zones)"
use_time   = input.bool(true, "Filter by Time?", group=grp_time)
tz_input   = input.string("America/New_York", "Timezone", options=["America/New_York", "Europe/London", "Asia/Tokyo", "UTC"], group=grp_time)
sess_am    = input.session("0830-1000", "AM Session", group=grp_time)
sess_pm    = input.session("1400-1500", "PM Session", group=grp_time)
show_bg    = input.bool(true, "Highlight Kill Zones?", group=grp_time)

grp_levels = "Key Levels"
show_daily = input.bool(true, "Show Daily Levels", group=grp_levels)
show_labels= input.bool(true, "Show Text Labels", group=grp_levels)
c_pdh      = input.color(color.new(color.red, 30), "PDH Color", group=grp_levels)
c_pdl      = input.color(color.new(color.green, 30), "PDL Color", group=grp_levels)
c_pdc      = input.color(color.new(color.gray, 30), "PDC Color", group=grp_levels)

grp_ml     = "AI Settings"
k_param    = input.int(5, "KNN (k)", minval=3, group=grp_ml)
win_param  = input.int(1000, "Training Window", minval=100, maxval=2000, group=grp_ml)

grp_mss    = "Structure"
sw_len     = input.int(3, "Swing Length", group=grp_mss)

grp_vis    = "Visuals"
show_fibs  = input.bool(true, "Show Active Golden Zones", group=grp_vis)

// -------------------------------------------------------------------------
// 2. TIME WINDOW LOGIC
// -------------------------------------------------------------------------
// Helper function to check if we are in the session
in_session(sess) => 
    not na(time(timeframe.period, sess, tz_input))

is_killzone = use_time ? (in_session(sess_am) or in_session(sess_pm)) : true

// Visual Highlight for Kill Zones
bgcolor(show_bg and is_killzone ? color.new(color.blue, 90) : na, title="Kill Zone Background")

// -------------------------------------------------------------------------
// 3. DATA & LEVELS
// -------------------------------------------------------------------------
d_high  = request.security(syminfo.tickerid, "D", high[1], lookahead=barmerge.lookahead_on)
d_low   = request.security(syminfo.tickerid, "D", low[1],  lookahead=barmerge.lookahead_on)
d_close = request.security(syminfo.tickerid, "D", close[1], lookahead=barmerge.lookahead_on)

bool new_day = ta.change(time("D")) != 0

plot(show_daily ? d_high : na,  "PDH", color=c_pdh, style=plot.style_circles)
plot(show_daily ? d_low : na,   "PDL", color=c_pdl, style=plot.style_circles)
plot(show_daily ? d_close : na, "PDC", color=c_pdc, style=plot.style_cross)

if show_daily and show_labels and barstate.islast
    var label l_pdh = na
    var label l_pdl = na
    var label l_pdc = na
    label.delete(l_pdh)
    label.delete(l_pdl)
    label.delete(l_pdc)
    l_pdh := label.new(bar_index + 3, d_high, "PDH", xloc=xloc.bar_index, style=label.style_none, textcolor=c_pdh)
    l_pdl := label.new(bar_index + 3, d_low,  "PDL", xloc=xloc.bar_index, style=label.style_none, textcolor=c_pdl)
    l_pdc := label.new(bar_index + 3, d_close,"PDC", xloc=xloc.bar_index, style=label.style_none, textcolor=c_pdc)

// -------------------------------------------------------------------------
// 4. AI ENGINE
// -------------------------------------------------------------------------
f1 = ta.rsi(close, 14)
f2 = ta.cci(close, 14)
f3 = ta.roc(close, 10)

predict_direction(current_f1, current_f2, current_f3, k, win) =>
    if bar_index <= 220
        0
    else
        int bullish_votes = 0
        int bearish_votes = 0
        float[] distances = array.new_float(0)
        int[] directions  = array.new_int(0) 
        
        for i = 4 to 200 
            float d = math.sqrt(math.pow(current_f1 - f1[i], 2) + math.pow(current_f2 - f2[i], 2) + math.pow(current_f3 - f3[i], 2))
            array.push(distances, d)
            array.push(directions, close[i-3] > close[i] ? 1 : -1)
        
        for j = 0 to k-1
            float min_dist = 999999.0
            int min_idx = -1
            if array.size(distances) > 0
                for i = 0 to array.size(distances) - 1
                    if array.get(distances, i) < min_dist
                        min_dist := array.get(distances, i)
                        min_idx := i
                
                if min_idx != -1
                    int dir = array.get(directions, min_idx)
                    if dir == 1
                        bullish_votes += 1
                    else
                        bearish_votes += 1
                    array.remove(distances, min_idx)
                    array.remove(directions, min_idx)
        bullish_votes > bearish_votes ? 1 : -1

// -------------------------------------------------------------------------
// 5. STRUCTURE & MSS
// -------------------------------------------------------------------------
ph = ta.pivothigh(high, sw_len, sw_len)
pl = ta.pivotlow(low, sw_len, sw_len)
var float last_sh = na
var float last_sl = na
if not na(ph)
    last_sh := high[sw_len]
if not na(pl)
    last_sl := low[sw_len]
plot(last_sh, "SH", color=color.new(color.red, 70))
plot(last_sl, "SL", color=color.new(color.green, 70))

// -------------------------------------------------------------------------
// 6. PRIMARY SIGNAL LOGIC
// -------------------------------------------------------------------------
var bool swept_pdh = false
var bool swept_pdl = false

if new_day
    swept_pdh := false
    swept_pdl := false

if high >= d_high
    swept_pdh := true
if low <= d_low
    swept_pdl := true

bull_mss = close > last_sh and close[1] <= last_sh 
bear_mss = close < last_sl and close[1] >= last_sl 

int ai_signal = predict_direction(f1, f2, f3, k_param, win_param)

// -- ENTRY TRIGGERS (NOW FILTERED BY TIME) --
buy_signal  = is_killzone and swept_pdl and bull_mss and ai_signal == 1
sell_signal = is_killzone and swept_pdh and bear_mss and ai_signal == -1

if buy_signal
    swept_pdl := false
if sell_signal
    swept_pdh := false

// -------------------------------------------------------------------------
// 7. SECONDARY SIGNAL (GOLDEN ZONE)
// -------------------------------------------------------------------------
var int leg_state = 0 
var float leg_start = na
var float leg_end = na
var bool zone_touched = false

if buy_signal
    leg_state := 1
    leg_start := last_sl 
    leg_end := high
    zone_touched := false

if sell_signal
    leg_state := -1
    leg_start := last_sh 
    leg_end := low
    zone_touched := false

float fib_50 = na
float fib_618 = na

if leg_state == 1 // LONG
    if low < leg_start
        leg_state := 0 
    else
        if high > leg_end
            leg_end := high
            zone_touched := false 
        range_len = leg_end - leg_start
        fib_50  := leg_end - (range_len * 0.5)
        fib_618 := leg_end - (range_len * 0.618)
        if low <= fib_50
            zone_touched := true

if leg_state == -1 // SHORT
    if high > leg_start
        leg_state := 0
    else
        if low < leg_end
            leg_end := low
            zone_touched := false
        range_len = leg_start - leg_end
        fib_50  := leg_end + (range_len * 0.5)
        fib_618 := leg_end + (range_len * 0.618)
        if high >= fib_50
            zone_touched := true

// Re-entry also filtered by time? Usually yes, to avoid late day traps.
reentry_buy = is_killzone and leg_state == 1 and zone_touched and bull_mss
reentry_sell = is_killzone and leg_state == -1 and zone_touched and bear_mss

if reentry_buy or reentry_sell
    leg_state := 0 
    zone_touched := false

// -------------------------------------------------------------------------
// 8. VISUALS & ALERTS
// -------------------------------------------------------------------------
p50 = plot(leg_state != 0 and show_fibs ? fib_50 : na, "Fib 0.5", color=color.new(color.yellow, 100))
p618 = plot(leg_state != 0 and show_fibs ? fib_618 : na, "Fib 0.618", color=color.new(color.orange, 100))
fill(p50, p618, color = leg_state == 1 ? color.new(color.green, 90) : color.new(color.red, 90), title="Golden Zone")

plotshape(buy_signal, "AI Long", shape.circle, location.belowbar, color.green, size=size.small)
plotshape(sell_signal, "AI Short", shape.circle, location.abovebar, color.red, size=size.small)
plotshape(reentry_buy, "Re-Entry Long", shape.triangleup, location.belowbar, color.lime, size=size.small)
plotshape(reentry_sell, "Re-Entry Short", shape.triangledown, location.abovebar, color.maroon, size=size.small)

alertcondition(buy_signal, "Long Signal", "PDL Sweep + AI MSS Buy")
alertcondition(sell_signal, "Short Signal", "PDH Sweep + AI MSS Sell")
alertcondition(reentry_buy, "Re-Entry Long", "Golden Zone Re-Entry Buy")
alertcondition(reentry_sell, "Re-Entry Short", "Golden Zone Re-Entry Sell")
