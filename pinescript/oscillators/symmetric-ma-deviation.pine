//@version=5
indicator("Symmetric MA", overlay=false)

// 50-period SMA
sma50 = ta.sma(close, 50)

// Determine the price to use based on position relative to SMA
price_used = close
price_used := close > sma50 ? high : close < sma50 ? low : close

// Symmetric oscillator (log2 ratio) using selected price
osc = math.log(price_used / sma50) / math.log(2)

// Function to compute color gradient
f_color(val) =>
    r = 0
    g = 0
    b = 0
    if val > 0
        r := math.min(math.max(math.round(50 * (1 - val)), 0), 255)
        g := math.min(math.max(math.round(200 * val + 55), 0), 255)
        b := math.min(math.max(math.round(50 * (1 - val)), 0), 255)
    else if val < 0
        r := math.min(math.max(math.round(200 * -val + 55), 0), 255)
        g := math.min(math.max(math.round(50 * (1 + val)), 0), 255)
        b := math.min(math.max(math.round(50 * (1 + val)), 0), 255)
    else
        r := 128
        g := 128
        b := 128
    color.rgb(r, g, b)

col = f_color(osc)

// Plot oscillator
plot(osc, title="MA Deviation Oscillator (HL/Close)", color=col, linewidth=2)

// Baseline at 0, 50% transparent
plot(0, color=color.new(color.gray, 50), linewidth=1)
