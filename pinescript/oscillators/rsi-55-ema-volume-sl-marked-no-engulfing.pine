//@version=5
strategy("RSI + 55 EMA + Volume (SL Marked, No Engulfing)", 
     overlay = true, margin_long = 100, margin_short = 100, initial_capital = 100000)

// ──────────────────────────────
// INPUTS
// ──────────────────────────────
emaLength  = input.int(55,  "EMA Length")
rsiLength  = input.int(14,  "RSI Length")
volLen     = input.int(20,  "Volume SMA Length")
rsiLong    = input.float(55, "RSI > for Long")
rsiShort   = input.float(45, "RSI < for Short")
volMult    = input.float(1.3, "Volume Multiplier for Entry Candle")

slPerc = input.float(0.8, "Stop Loss %", step = 0.1)
tpPerc = input.float(1.0, "Take Profit %", step = 0.1)

// ──────────────────────────────
// INDICATORS
// ──────────────────────────────
ema55 = ta.ema(close, emaLength)
rsi   = ta.rsi(close, rsiLength)
volMA = ta.sma(volume, volLen)

// Simple rejection candle logic (no engulfing)
// Bullish rejection: green candle with decent lower wick near EMA
bullRejection = close > open and (close - low) > (open - close)

// Bearish rejection: red candle with decent upper wick near EMA
bearRejection = close < open and (high - close) > (close - open)

// ──────────────────────────────
// LONG CONDITIONS
// ──────────────────────────────
longTrend    = close > ema55                      // price above EMA → uptrend
longMomentum = rsi > rsiLong                      // RSI filter
// price pulls back to EMA zone (±0.3%)
longPullback = low <= ema55 * 1.003 and low >= ema55 * 0.997
// rejection candle near EMA
longSignalCandle = bullRejection
// volume confirmation
longVolume   = volume >= volMA * volMult

longSignal   = longTrend and longMomentum and longPullback and longSignalCandle and longVolume

// ──────────────────────────────
// SHORT CONDITIONS
// ──────────────────────────────
shortTrend    = close < ema55                     // price below EMA → downtrend
shortMomentum = rsi < rsiShort
shortPullback = high >= ema55 * 0.997 and high <= ema55 * 1.003
shortSignalCandle = bearRejection
shortVolume   = volume >= volMA * volMult

shortSignal   = shortTrend and shortMomentum and shortPullback and shortSignalCandle and shortVolume

// ──────────────────────────────
// EXECUTION
// ──────────────────────────────
if longSignal
    strategy.entry("Long", strategy.long)

if shortSignal
    strategy.entry("Short", strategy.short)

// Exit levels (current bar, used by engine)
longStopPrice  = strategy.position_avg_price * (1 - slPerc/100)
longTpPrice    = strategy.position_avg_price * (1 + tpPerc/100)
shortStopPrice = strategy.position_avg_price * (1 + slPerc/100)
shortTpPrice   = strategy.position_avg_price * (1 - tpPerc/100)

strategy.exit("Exit Long",  "Long",  stop = longStopPrice,  limit = longTpPrice)
strategy.exit("Exit Short", "Short", stop = shortStopPrice, limit = shortTpPrice)

// ──────────────────────────────
// STOP-LOSS MARKERS (CANDLE + LEVEL)
// ──────────────────────────────
wasLongPrev  = strategy.position_size[1] > 0
wasShortPrev = strategy.position_size[1] < 0
flatNow      = strategy.position_size == 0

// Use previous bar's average price to reconstruct that trade's SL/TP
longStopPrev  = strategy.position_avg_price[1] * (1 - slPerc/100)
longTpPrev    = strategy.position_avg_price[1] * (1 + tpPerc/100)
shortStopPrev = strategy.position_avg_price[1] * (1 + slPerc/100)
shortTpPrev   = strategy.position_avg_price[1] * (1 - tpPerc/100)

// Long SL hit: we were long, now flat, low pierced stop and bar did not reach TP
longSlHit  = wasLongPrev and flatNow and not na(strategy.position_avg_price[1]) and low <= longStopPrev and high < longTpPrev

// Short SL hit: we were short, now flat, high pierced stop and bar did not reach TP
shortSlHit = wasShortPrev and flatNow and not na(strategy.position_avg_price[1]) and high >= shortStopPrev and low > shortTpPrev

// Draw labels
if longSlHit
    // Candle label (below bar)
    label.new(
         bar_index, low, "SL",
         style     = label.style_label_down,
         color     = color.new(color.red, 0),
         textcolor = color.white,
         size      = size.tiny)
    // Price-level label
    label.new(
         bar_index, longStopPrev, "SL",
         style     = label.style_label_left,
         color     = color.new(color.red, 0),
         textcolor = color.white,
         size      = size.tiny)

if shortSlHit
    // Candle label (above bar)
    label.new(
         bar_index, high, "SL",
         style     = label.style_label_up,
         color     = color.new(color.red, 0),
         textcolor = color.white,
         size      = size.tiny)
    // Price-level label
    label.new(
         bar_index, shortStopPrev, "SL",
         style     = label.style_label_left,
         color     = color.new(color.red, 0),
         textcolor = color.white,
         size      = size.tiny)

// ──────────────────────────────
// VISUALS
// ──────────────────────────────
plot(ema55, "EMA 55", color = color.new(color.blue, 0), linewidth = 2)

plotshape(longSignal,  title = "BUY", 
     text     = "BUY",  
     style    = shape.labelup, 
     color    = color.new(color.green, 0), 
     size     = size.small, 
     location = location.belowbar)

plotshape(shortSignal, title = "SELL", 
     text     = "SELL", 
     style    = shape.labeldown, 
     color    = color.new(color.red, 0), 
     size     = size.small, 
     location = location.abovebar)

// Trend background shading
bgcolor(longTrend  ? color.new(color.green, 92) : na)
bgcolor(shortTrend ? color.new(color.red,   92) : na)

// ──────────────────────────────
// ALERTS
// ──────────────────────────────
alertcondition(longSignal,  "Long Entry",  "RSI+EMA+Volume LONG")
alertcondition(shortSignal, "Short Entry", "RSI+EMA+Volume SHORT")
