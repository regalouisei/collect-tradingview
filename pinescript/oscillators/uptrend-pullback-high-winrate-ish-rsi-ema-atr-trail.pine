//@version=6
strategy('Uptrend Pullback (High Winrate-ish) - RSI + EMA + ATR Trail', overlay = true, pyramiding = 0, process_orders_on_close = true, initial_capital = 100000)

// ===== Inputs =====
emaFastLen = input.int(50, 'EMA Fast', minval = 1)
emaSlowLen = input.int(200, 'EMA Slow', minval = 1)

rsiLen = input.int(14, 'RSI Length', minval = 1)
rsiPullLvl = input.float(40, 'Pullback RSI level (cross up)', step = 0.1)
rsiExitLvl = input.float(70, 'Exit RSI touch >=', step = 0.1)

atrLen = input.int(14, 'ATR Length', minval = 1)
trailAtrMult = input.float(2.0, 'ATR Trailing Mult', minval = 0.1, step = 0.1)
hardSlAtrMult = input.float(3.0, 'Hard Stop ATR Mult', minval = 0.1, step = 0.1)

// ===== Indicators =====
emaFast = ta.ema(close, emaFastLen)
emaSlow = ta.ema(close, emaSlowLen)
rsi = ta.rsi(close, rsiLen)
atr = ta.atr(atrLen)

// ===== Regime filter (uptrend only) =====
upTrend = emaFast > emaSlow and close > emaSlow

// ===== Entry: pullback -> reversal =====
// RSIが弱い水準（rsiPullLvl未満）から上抜け＝押し目の反転
longEntry = upTrend and ta.crossover(rsi, rsiPullLvl)

// ===== Trailing stop (ATR) =====
var float trailStop = na
inLong = strategy.position_size > 0

if strategy.position_size == 0
    trailStop := na
    trailStop

if inLong
    // 追随ストップ：価格 - ATR*倍率 を切り上げ続ける
    newStop = close - atr * trailAtrMult
    trailStop := na(trailStop) ? newStop : math.max(trailStop, newStop)
    trailStop

// ハードストップ（最悪の保険）
hardStop = strategy.position_avg_price - atr * hardSlAtrMult

// ===== Exit conditions =====
rsiExit = rsi >= rsiExitLvl

// ===== Orders =====
if strategy.position_size == 0 and longEntry
    strategy.entry('L', strategy.long)

// RSI利確（過熱でクローズ）
if inLong and rsiExit
    strategy.close('L', comment = 'RSI TP')

// トレーリング or ハードSL（どちらか高い方が実質有効になりやすい）
if inLong
    stopPrice = math.max(hardStop, trailStop)
    strategy.exit('XL', from_entry = 'L', stop = stopPrice)

// ===== Plots =====
plot(emaFast, 'EMA Fast')
plot(emaSlow, 'EMA Slow')
plot(trailStop, 'ATR Trail Stop', style = plot.style_linebr)
