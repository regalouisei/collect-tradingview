//@version=6
indicator("RSI + Psy + ADX（RCI置換版）", overlay=false, max_lines_count=500)

//=== パラメータ ===//
rsiShortLen = input.int(9, "RSI 短期")
rsiMidLen   = input.int(26, "RSI 中期")
rsiLongLen  = input.int(52, "RSI 長期")
psyLen        = input.int(12, "サイコロジカル期間")
psyOverbought = input.int(75, "サイコロジカル買われすぎ")
psyOversold   = input.int(25, "サイコロジカル売られすぎ")

// ADX パラメータ
adxLen = input.int(14, "ADX期間")
adxWeak = input.int(20, "ADX弱いトレンド閾値")
adxMid  = input.int(30, "ADX中間トレンド閾値")

//=== RSI 計算 ===//
rsiShort = ta.rsi(close, rsiShortLen)
rsiMid   = ta.rsi(close, rsiMidLen)
rsiLong  = ta.rsi(close, rsiLongLen)

//=== サイコロジカル計算 ===//
psyCount = 0
for i = 1 to psyLen
    if i < bar_index
        psyCount += close[i-1] > close[i] ? 1 : 0
psy = 100.0 * psyCount / psyLen

// サイコロジカル棒グラフ（売られすぎ/買われすぎのみ）
float psySignal = na
color psyColor = na
if psy > psyOverbought
    psySignal := (psy - psyOverbought) / (100 - psyOverbought) * 100
    psyColor := color.new(color.red, 0)
else if psy < psyOversold
    psySignal := (psyOversold - psy) / psyOversold * 100
    psyColor := color.new(color.green, 0)

//=== RSIライン表示 ===//
plot(rsiShort, "RSI 短期", color=color.new(color.red, 0))
plot(rsiMid,   "RSI 中期", color=color.new(color.blue, 0))
plot(rsiLong,  "RSI 長期", color=color.new(color.green, 0))

// RSI固定ゾーン
hline(70, "RSI 70ライン", color=color.red, linestyle=hline.style_dotted)
hline(30, "RSI 30ライン", color=color.green, linestyle=hline.style_dotted)
hline(50, "RSI ゼロライン", color=color.gray)

// サイコロジカル棒グラフ
plot(psySignal, "サイコロジカルシグナル", style=plot.style_columns, color=psyColor, linewidth=3)
hline(50, "Psy ミドルライン", color=color.gray, linestyle=hline.style_dotted)

//=== ADX計算 (DI+/DI-から算出) ===//
upMove = high - high[1]
downMove = low[1] - low
plusDM = (upMove > downMove and upMove > 0) ? upMove : 0
minusDM = (downMove > upMove and downMove > 0) ? downMove : 0

// True Range 計算
tr1 = high - low
tr2 = math.abs(high - close[1])
tr3 = math.abs(low - close[1])
tr = math.max(tr1, math.max(tr2, tr3))
smTR = ta.rma(tr, adxLen)

smPlusDM = ta.rma(plusDM, adxLen)
smMinusDM = ta.rma(minusDM, adxLen)

plusDI = 100 * smPlusDM / smTR
minusDI = 100 * smMinusDM / smTR

dx = 100 * math.abs(plusDI - minusDI) / (plusDI + minusDI)
adxVal = ta.rma(dx, adxLen)

// ADX段階色分け
adxColor = adxVal < adxWeak ? color.blue : adxVal < adxMid ? color.yellow : color.red

plot(adxVal, "ADX", color=adxColor, linewidth=2)
hline(adxMid, "中間閾値", color=color.gray, linestyle=hline.style_dotted)
