//@version=5
indicator("John Carter Momentum Candles (TradingView)", overlay=true)

// === Inputs
length = input.int(20, "Donchian Length")

// === Donchian Midline calculation
donchianHigh = ta.highest(high, length)
donchianLow  = ta.lowest(low, length)
donchianSma  = ta.sma(close, length)
donchianMidline = (donchianHigh + donchianLow + donchianSma) / 3

// === Momentum Delta calculation
sma = close - donchianMidline
delta = ta.linreg(sma, length, 0)
delta_prev = nz(delta[1])

// === Candle color logic
color_candle = if delta > 0 and delta > delta_prev
    color.rgb(0, 245, 255)    // cyan - rising momentum
else if delta > 0 and delta < delta_prev
    color.rgb(0, 0, 255)      // blue - slowing momentum
else if delta < 0 and delta < delta_prev
    color.rgb(255, 0, 0)      // red - accelerating down
else if delta < 0 and delta > delta_prev
    color.rgb(255, 255, 0)    // yellow - losing negative momentum
else
    color.gray

// === Apply candle colors (safe for any timeframe)
barcolor(color_candle)

// === Optional Donchian midline for reference
plot(donchianMidline, title="Donchian Midline", color=color.new(color.white, 0), linewidth=2)
