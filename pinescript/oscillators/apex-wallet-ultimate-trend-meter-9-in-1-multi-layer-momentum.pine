// filepath: indicators/trend_meter_one_line_menu_order_v12m_trendmeter_with_tdi_andean_final.pine
//@version=5
indicator("www.Apex-Wallet.fr - Trend Meter Stochastic, RSI, MACD, TDI, Andean, Delta Grid et Tendance", overlay=false, max_labels_count=500, max_lines_count=500)

// ======== Menu ========
tradingMode   = input.string("Day-Trading", "Mode de trading", options=["Scalping","Day-Trading","Swing-Trading"])
showEMAFast   = input.bool(true,  "Afficher l'EMA courte")
showEMAMed    = input.bool(true,  "Afficher l'EMA moyenne")
showEMA       = input.bool(true,  "Afficher l'EMA longue")
showRSIR      = input.bool(false, "Afficher la tendance du StochRSI")
showSTO       = input.bool(false, "Afficher la tendance du Stochastique")
showRSI       = input.bool(false, "Afficher la tendance du RSI")
showMACD      = input.bool(false, "Afficher la tendance du MACD")

// --- Ajouts sous MACD ---
showTDI       = input.bool(false, "Afficher la tendance du TDI")
showANDEAN    = input.bool(false, "Afficher la tendance de l'Andean")

showDeltaGrid = input.bool(true,  "Afficher le Volume Delta")

// === Delta Net — section dédiée ===
groupDelta = "Delta Net"
deltaMode = input.string("Achat/Vente", "Mode du Delta Net", options=["Achat/Vente","Achat/Vente/Neutre","Automatique"], tooltip="Achat/Vente: si la clôture n'évolue pas, le volume suit la dernière polarité.\nAchat/Vente/Neutre: si la clôture n'évolue pas, volume neutre.\nAutomatique: bascule selon le % de barres plates.", group=groupDelta)
scaleMode = input.string("Automatique", "Échelle du Delta", options=["Automatique","Valeur brute"], tooltip="Automatique: adapte l'affichage (10 / 100 / 1k / 10k).", group=groupDelta)

// ===== Affichage — tailles =====
fontChoice     = input.string("Default", "Taille de la police du tableau", options=["Small (-1)", "Default", "Large (+1)"])
legendTextSize = fontChoice == "Default" ? size.small : fontChoice == "Small (-1)" ? size.tiny : size.normal
deltaLabelSize = fontChoice == "Small (-1)" ? size.small : fontChoice == "Default" ? size.normal : size.large

// ===== Presets par mode =====
periodK   = tradingMode == "Scalping" ? 7  : tradingMode == "Swing-Trading" ? 21 : 14
smoothK   = tradingMode == "Scalping" ? 3  : tradingMode == "Swing-Trading" ? 6  : 4
periodD   = tradingMode == "Scalping" ? 3  : tradingMode == "Swing-Trading" ? 6  : 4
rsiPeriod = tradingMode == "Scalping" ? 7  : tradingMode == "Swing-Trading" ? 21 : 14

trendLen   = tradingMode == "Scalping" ? 50  : tradingMode == "Swing-Trading" ? 200 : 100
emaFastLen = tradingMode == "Scalping" ? 5   : tradingMode == "Swing-Trading" ? 20  : 9
emaMedLen  = tradingMode == "Scalping" ? 13  : tradingMode == "Swing-Trading" ? 50  : 26
emaSlowLen = tradingMode == "Scalping" ? 50  : tradingMode == "Swing-Trading" ? 200 : 52

macdFast   = tradingMode == "Scalping" ? 6   : tradingMode == "Swing-Trading" ? 24  : 12
macdSlow   = tradingMode == "Scalping" ? 13  : tradingMode == "Swing-Trading" ? 52  : 26
macdSignal = 9

// ===== Source =====
src = hl2

// ===== Couleurs globales =====
colUp   = color.new(color.green, 0)
colNeut = color.new(color.gray,  40)
colDown = color.new(color.red,   0)
trendCol(state) => state == 1 ? colUp : state == 0 ? colNeut : colDown

// ===== EMAs & états =====
emaBase      = ta.ema(src, trendLen)
emaFast      = ta.ema(src, emaFastLen)
emaMed       = ta.ema(src, emaMedLen)
emaSlow      = ta.ema(src, emaSlowLen)
emaFastState = emaFast > emaFast[1] ? 1 : emaFast < emaFast[1] ? -1 : 0
emaMedState  = emaMed  > emaMed[1]  ? 1 : emaMed  < emaMed[1]  ? -1 : 0
emaSlowState = emaSlow > emaSlow[1] ? 1 : emaSlow < emaSlow[1] ? -1 : 0

// ===== Tendance =====
mktUp    = (emaBase > emaBase[1]) and (close > emaBase)
mktDown  = (emaBase < emaBase[1]) and (close < emaBase)
mktState = mktUp ? 1 : mktDown ? -1 : 0

// ===== StochRSI =====
rsiVal  = ta.rsi(src, rsiPeriod)
rsiLL   = ta.lowest(rsiVal, periodK)
rsiHH   = ta.highest(rsiVal, periodK)
den     = math.max(rsiHH - rsiLL, 1e-10)  // why: éviter division par 0
kRawRSI = (rsiVal - rsiLL) / den * 100.0
kRSI    = ta.sma(kRawRSI, smoothK)
dRSI    = ta.sma(kRSI,    periodD)
stochRsiCrossState = kRSI > dRSI ? 1 : kRSI < dRSI ? -1 : 0

// ===== Stoch classique =====
kClassic = ta.sma(ta.stoch(high, low, close, periodK), smoothK)
dClassic = ta.sma(kClassic, periodD)
stochCrossState = kClassic > dClassic ? 1 : kClassic < dClassic ? -1 : 0

// ===== MACD =====
macdLine = ta.ema(src, macdFast) - ta.ema(src, macdSlow)
macdSig  = ta.ema(macdLine, macdSignal)
macdHist = macdLine - macdSig
macdCrossState = macdLine > macdSig ? 1 : macdLine < macdSig ? -1 : 0

// =========================== TDI (Tendance) ===========================
tdiRsiLen = tradingMode == "Scalping" ? 7  : tradingMode == "Day-Trading" ? 14 : 21
tdiPlLen  = tradingMode == "Scalping" ? 2  : tradingMode == "Day-Trading" ? 2  : 3
tdiSigLen = tradingMode == "Scalping" ? 5  : tradingMode == "Day-Trading" ? 9  : 20
tdiMblLen = tradingMode == "Scalping" ? 13 : tradingMode == "Day-Trading" ? 26 : 50

tdiRsi = ta.rsi(close, tdiRsiLen)
tdiPl  = tradingMode == "Scalping" ? ta.ema(tdiRsi, tdiPlLen) : ta.sma(tdiRsi, tdiPlLen)
tdiSig = tradingMode == "Scalping" ? ta.ema(tdiPl,  tdiSigLen) : ta.sma(tdiPl,  tdiSigLen)
tdiMbl = ta.sma(tdiRsi, tdiMblLen)

var int tdiRel = 0
tdiRel := tdiPl > tdiSig ? 1 : tdiPl < tdiSig ? -1 : nz(tdiRel[1], 0)
tdiBias = tdiPl > tdiMbl ? 1 : tdiPl < tdiMbl ? -1 : 0

// =========================== ANDEAN (Tendance) ===========================
andeanLen  = tradingMode == "Scalping" ? 21 : tradingMode == "Day-Trading" ? 50 : 100
andeanSigL = tradingMode == "Scalping" ? 5  : tradingMode == "Day-Trading" ? 9  : 14

max3(a, b, c) => math.max(math.max(a, b), c)
min3(a, b, c) => math.min(math.min(a, b), c)
sqrt_safe(x)  => math.sqrt(math.max(x, 0.0))

andeanAlpha = 2.0 / (andeanLen + 1.0)

var float up1 = na
var float up2 = na
var float dn1 = na
var float dn2 = na

C = close
O = open
C2 = C * C
O2 = O * O

up1 := nz(max3(C,  O,  up1[1] - (up1[1] - C)  * andeanAlpha), C)
up2 := nz(max3(C2, O2, up2[1] - (up2[1] - C2) * andeanAlpha), C2)

dn1 := nz(min3(C,  O,  dn1[1] + (C  - dn1[1]) * andeanAlpha), C)
dn2 := nz(min3(C2, O2, dn2[1] + (C2 - dn2[1]) * andeanAlpha), C2)

andeanBull   = sqrt_safe(dn2 - dn1 * dn1)
andeanBear   = sqrt_safe(up2 - up1 * up1)
andeanSignal = ta.ema(math.max(andeanBull, andeanBear), andeanSigL)

var string andeanState = "NEUTRE"
var color  andeanColor = colNeut

andeanIsBullTrend = andeanBull > andeanBear
andeanIsBearTrend = andeanBear > andeanBull
andeanIsRangeCond = (andeanIsBullTrend and andeanSignal > andeanBull) or (andeanIsBearTrend and andeanSignal > andeanBear)
andeanIsPureBull  = andeanIsBullTrend and not andeanIsRangeCond
andeanIsPureBear  = andeanIsBearTrend and not andeanIsRangeCond
andeanCross       = ta.cross(andeanBull, andeanBear)

if andeanCross
    andeanState := "INFLEXION"
    andeanColor := color.rgb(138, 43, 226)
else
    if andeanState == "INFLEXION"
        if andeanIsPureBull
            andeanState := "HAUSSIER"
            andeanColor := colUp
        else if andeanIsPureBear
            andeanState := "BAISSIER"
            andeanColor := colDown
        else if andeanIsRangeCond
            andeanState := "CONSOLIDATION"
            andeanColor := color.orange
        else
            andeanState := "NEUTRE"
            andeanColor := colNeut
    else
        if andeanIsPureBull
            andeanState := "HAUSSIER"
            andeanColor := colUp
        else if andeanIsPureBear
            andeanState := "BAISSIER"
            andeanColor := colDown
        else if andeanIsRangeCond
            andeanState := "CONSOLIDATION"
            andeanColor := color.orange
        else
            andeanState := "NEUTRE"
            andeanColor := colNeut

// ===== Couleurs (indicateurs) =====
emaFastCol  = trendCol(emaFastState)
emaMedCol   = trendCol(emaMedState)
emaSlowCol  = trendCol(emaSlowState)
stochRsiCol = (stochRsiCrossState == 1 and mktState == 1) ? colUp : (stochRsiCrossState == -1 and mktState == -1) ? colDown : colNeut
stochCol    = (stochCrossState    == 1 and mktState == 1) ? colUp : (stochCrossState    == -1 and mktState == -1) ? colDown : colNeut
rsiCol      = trendCol(mktState)
macdCol     = (macdCrossState     == 1 and mktState == 1) ? colUp : (macdCrossState     == -1 and mktState == -1) ? colDown : colNeut
tdiCol      = (tdiRel == 1 and mktState == 1) ? colUp : (tdiRel == -1 and mktState == -1) ? colDown : colNeut

// =========================== DELTA ===========================
// Paramètres AUTO optimisés par mode (pas d'inputs)
autoLookback     = tradingMode == "Scalping" ? 30  : tradingMode == "Swing-Trading" ? 100 : 50
autoThresholdPct = tradingMode == "Scalping" ? 25  : tradingMode == "Swing-Trading" ? 35  : 30
smallBodyFrac    = tradingMode == "Scalping" ? 0.12: tradingMode == "Swing-Trading" ? 0.08: 0.10

UPDOWNNEUTRAL_MODE = 1
UPDOWN_MODE        = 2

barRange   = high - low
hasRange   = barRange > 0
smallBody  = hasRange and math.abs(close - open) <= barRange * smallBodyFrac
equalClose = close == close[1]
isFlatBar  = equalClose or smallBody
flatRate   = 100.0 * ta.sma(isFlatBar ? 1.0 : 0.0, autoLookback)

iModeManual = deltaMode == "Achat/Vente/Neutre" ? UPDOWNNEUTRAL_MODE : UPDOWN_MODE
iModeEff    = deltaMode == "Automatique" ? (flatRate >= autoThresholdPct ? UPDOWNNEUTRAL_MODE : UPDOWN_MODE) : iModeManual

// Volume Up/Down/Neutral
f_upDnNtVolume(_mode) =>
    varip float _prevClose    = open
    varip float _prevVolume   = 0.0
    varip float _newVolume    = 0.0
    varip float _volUp        = 0.0
    varip float _volDn        = 0.0
    varip float _volNt        = 0.0
    varip int   _prevPolarity = 0
    if barstate.isnew
        _volUp        := 0.0
        _volDn        := 0.0
        _volNt        := 0.0
        _prevClose    := nz(close[1], open)
        _prevVolume   := 0.0
        _prevPolarity := nz(_prevPolarity[1], 0)
    _newVolume := nz(volume, 0.0) - _prevVolume
    if close > _prevClose
        _prevPolarity := 1
        _volUp += math.max(_newVolume, 0.0)
    else if close < _prevClose
        _prevPolarity := -1
        _volDn += math.max(_newVolume, 0.0)
    else
        if _mode == UPDOWN_MODE
            if _prevPolarity == 1
                _volUp += math.max(_newVolume, 0.0)
            else if _prevPolarity == -1
                _volDn += math.max(_newVolume, 0.0)
            else
                _volNt += math.max(_newVolume, 0.0)
        else
            _volNt += math.max(_newVolume, 0.0)
    _prevClose  := close
    _prevVolume := nz(volume, 0.0)
    [_volUp, _volDn, _volNt]

[volUp, volDn, volNt] = f_upDnNtVolume(iModeEff)
rawDelta = volUp - volDn

// ====== Presets Delta optimisés par mode (aucun input) ======
deltaShowNumber = true
deltaMaxLabels  = tradingMode == "Scalping" ? 300 : tradingMode == "Swing-Trading" ? 400 : 500
deltaSmaLen     = tradingMode == "Scalping" ? 1   : tradingMode == "Swing-Trading" ? 5   : 3
deltaNeutralThr = tradingMode == "Scalping" ? 0.0 : tradingMode == "Swing-Trading" ? 10.0: 5.0

deltaNetPre  = deltaSmaLen > 1 ? ta.sma(rawDelta, deltaSmaLen) : rawDelta
deltaNet     = math.abs(deltaNetPre) <= deltaNeutralThr ? 0.0 : deltaNetPre

// Échelle auto ou fixe
f_auto_factor(v) =>
    av = math.abs(v)
    av >= 100000 ? 10000 :
     av >= 10000 ? 1000  :
     av >= 1000  ? 100   :
     av >= 100   ? 10    : 1

autoFactor  = scaleMode == "Valeur brute" ? 1 : f_auto_factor(deltaNet)
deltaScaled = math.round(deltaNet / autoFactor)
deltaColor  = deltaNet > 0 ? colUp : deltaNet < 0 ? colDown : colNeut
deltaRaw    = math.round(rawDelta)

// ===== Layout =====
rowHeight = 0.20
rowGap    = 0.08
step      = rowHeight + rowGap

emaCount     = (showEMAFast?1:0) + (showEMAMed?1:0) + (showEMA?1:0)
postEMACount = (showRSIR?1:0) + (showSTO?1:0) + (showRSI?1:0) + (showMACD?1:0) + (showTDI?1:0) + (showANDEAN?1:0) + (showDeltaGrid?1:0)

baseEMASlow = (emaCount > 0) ? postEMACount * step : na
baseEMAMed  = showEMAMed  ? baseEMASlow + (showEMA ? step : 0) : na
baseEMAFast = showEMAFast ? (showEMAMed ? baseEMAMed + step : baseEMASlow + (showEMA ? step : 0)) : na

afterRSIR   = (showSTO?1:0) + (showRSI?1:0) + (showMACD?1:0) + (showTDI?1:0) + (showANDEAN?1:0) + (showDeltaGrid?1:0)
afterSTO    = (showRSI?1:0) + (showMACD?1:0) + (showTDI?1:0) + (showANDEAN?1:0) + (showDeltaGrid?1:0)
afterRSI    = (showMACD?1:0) + (showTDI?1:0) + (showANDEAN?1:0) + (showDeltaGrid?1:0)
afterMACD   = (showTDI?1:0) + (showANDEAN?1:0) + (showDeltaGrid?1:0)
afterTDI    = (showANDEAN?1:0) + (showDeltaGrid?1:0)
afterANDEAN = (showDeltaGrid?1:0)
afterDEL    = 0

baseRSIR   = showRSIR      ? afterRSIR   * step : na
baseSTO    = showSTO       ? afterSTO    * step : na
baseRSI    = showRSI       ? afterRSI    * step : na
baseMACD   = showMACD      ? afterMACD   * step : na
baseTDI    = showTDI       ? afterTDI    * step : na
baseANDEAN = showANDEAN    ? afterANDEAN * step : na
baseDEL    = showDeltaGrid ? afterDEL    * step : na

activeCount = emaCount + (showRSIR?1:0) + (showSTO?1:0) + (showRSI?1:0) + (showMACD?1:0) + (showTDI?1:0) + (showANDEAN?1:0) + (showDeltaGrid?1:0)
lastTop = activeCount > 0 ? (activeCount*step - rowGap) : 0

// ===== Traces =====
plot(series=showEMAFast ? baseEMAFast + rowHeight : na, style=plot.style_columns, histbase=baseEMAFast, color=showEMAFast ? emaFastCol : na, title="EMA courte")
plot(series=showEMAMed  ? baseEMAMed  + rowHeight : na, style=plot.style_columns, histbase=baseEMAMed,  color=showEMAMed  ? emaMedCol  : na, title="EMA moyenne")
plot(series=showEMA     ? baseEMASlow + rowHeight : na, style=plot.style_columns, histbase=baseEMASlow, color=showEMA     ? emaSlowCol : na, title="EMA longue")
plot(series=showRSIR ? baseRSIR + rowHeight : na, style=plot.style_columns, histbase=baseRSIR, color=showRSIR ? stochRsiCol : na, title="StochRSI (K/D)")
plot(series=showSTO  ? baseSTO  + rowHeight : na, style=plot.style_columns, histbase=baseSTO,  color=showSTO  ? stochCol    : na, title="Stoch (K/D)")
plot(series=showRSI  ? baseRSI  + rowHeight : na, style=plot.style_columns, histbase=baseRSI,  color=showRSI  ? rsiCol      : na, title="RSI")
plot(series=showMACD ? baseMACD + rowHeight : na, style=plot.style_columns, histbase=baseMACD, color=showMACD ? macdCol     : na, title="MACD")

// --- Ajouts : sous MACD ---
plot(series=showTDI ? baseTDI + rowHeight : na, style=plot.style_columns, histbase=baseTDI, color=showTDI ? tdiCol : na, title="TDI (PL/SIG)")
plot(series=showANDEAN ? baseANDEAN + rowHeight : na, style=plot.style_columns, histbase=baseANDEAN, color=showANDEAN ? andeanColor : na, title="Andean (Etat)")

// ===== Delta : bande + étiquette centrale =====
plot(series=showDeltaGrid ? baseDEL + rowHeight : na, style=plot.style_columns, histbase=baseDEL, color=showDeltaGrid ? deltaColor : na, title="Delta net")

// FIFO label storage
var label[] deltaLabels = array.new<label>()
if showDeltaGrid and not na(baseDEL) and deltaShowNumber
    if array.size(deltaLabels) >= deltaMaxLabels
        label.delete(array.shift(deltaLabels))
    yCenter   = baseDEL + rowHeight * 0.5
    centerTxt = str.tostring(deltaScaled)
    newLbl = label.new(bar_index, yCenter, centerTxt, yloc=yloc.price, style=label.style_label_center, textcolor=color.white, textalign=text.align_center, size=deltaLabelSize, color=color.new(color.black, 100))
    array.push(deltaLabels, newLbl)

// ===== helper : écrit 1 ligne =====
f_row(_legend, _row, _txt, _bg, _txtcol, _size) =>
    table.cell(_legend, 0, _row, _txt, text_color=_txtcol, bgcolor=_bg, text_size=_size)
    _row + 1

// ===== Légende =====
var table legend = table.new(position.top_right, 1, 10, border_width=1)
if barstate.islast
    table.clear(table_id=legend, start_row=0, start_column=0, end_row=9, end_column=0)
    r = 0
    if showEMAFast
        r := f_row(legend, r, "EMA courte (" + str.tostring(emaFastLen) + ")", emaFastCol, color.white, legendTextSize)
    if showEMAMed
        r := f_row(legend, r, "EMA moyenne (" + str.tostring(emaMedLen) + ")", emaMedCol, color.white, legendTextSize)
    if showEMA
        r := f_row(legend, r, "EMA longue (" + str.tostring(emaSlowLen) + ")", emaSlowCol, color.white, legendTextSize)
    if showRSIR
        r := f_row(legend, r, "StochRSI", stochRsiCol, color.white, legendTextSize)
    if showSTO
        r := f_row(legend, r, "Stochastique", stochCol, color.white, legendTextSize)
    if showRSI
        r := f_row(legend, r, "RSI", rsiCol, color.white, legendTextSize)
    if showMACD
        r := f_row(legend, r, "MACD", macdCol, color.white, legendTextSize)
    if showTDI
        r := f_row(legend, r, "TDI", tdiCol, color.white, legendTextSize)
    if showANDEAN
        r := f_row(legend, r, "Andean : " + andeanState, andeanColor, color.white, legendTextSize)
    if showDeltaGrid
        r := f_row(legend, r, "Delta net : " + str.tostring(deltaRaw), deltaColor, color.white, legendTextSize)
