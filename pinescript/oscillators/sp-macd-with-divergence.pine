// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © disizsid
//SPRINGPAD
//@version=6
indicator("SP - MACD with Divergence", shorttitle="SP - MACD+", format=format.price, precision=2, timeframe="", timeframe_gaps=true)

// ───────── INPUTS ─────────
fastLength     = input.int(12, minval=1, title="Fast Length", group="MACD Settings")
slowLength     = input.int(26, minval=1, title="Slow Length", group="MACD Settings")
signalLength   = input.int(9, minval=1, title="Signal Smoothing", group="MACD Settings")
src            = input.source(close, title="Source", group="MACD Settings")
enableDivergence = input.bool(true, title="Enable Divergence Detection", group="Divergence Settings", tooltip="Detects regular bullish and bearish divergences on MACD")

// ───────── MACD CALCULATION ─────────
fastMA   = ta.ema(src, fastLength)
slowMA   = ta.ema(src, slowLength)
macdLine = fastMA - slowMA
signal   = ta.ema(macdLine, signalLength)
hist     = macdLine - signal

// ───────── MACD PLOTS ─────────
plot(macdLine, "MACD Line", color=color.new(color.teal, 0), linewidth=2)
plot(signal, "Signal Line", color=color.new(color.orange, 0), linewidth=2)
plot(hist, "Histogram", style=plot.style_columns, color=(hist >= 0 ? color.new(color.teal, 0) : color.new(color.red, 0)))

// ───────── DIVERGENCE SETTINGS ─────────
lookbackLeft  = 5
lookbackRight = 5
rangeUpper    = 60
rangeLower    = 5
bullColor     = color.new(color.green, 0)
bearColor     = color.new(color.red, 0)
textColor     = color.white
noneColor     = color.new(color.white, 100)

_inRange(cond) =>
    bars = ta.barssince(cond)
    rangeLower <= bars and bars <= rangeUpper

plFound = false
phFound = false
bullCond = false
bearCond = false

macdLBR = macdLine[lookbackRight]

if enableDivergence
    // ── Regular Bullish Divergence ──
    plFound := not na(ta.pivotlow(macdLine, lookbackLeft, lookbackRight))
    macdHL = macdLBR > ta.valuewhen(plFound, macdLBR, 1) and _inRange(plFound[1])
    lowLBR = low[lookbackRight]
    priceLL = lowLBR < ta.valuewhen(plFound, lowLBR, 1)
    bullCond := priceLL and macdHL and plFound

    // ── Regular Bearish Divergence ──
    phFound := not na(ta.pivothigh(macdLine, lookbackLeft, lookbackRight))
    macdLH = macdLBR < ta.valuewhen(phFound, macdLBR, 1) and _inRange(phFound[1])
    highLBR = high[lookbackRight]
    priceHH = highLBR > ta.valuewhen(phFound, highLBR, 1)
    bearCond := priceHH and macdLH and phFound

// ───────── DIVERGENCE PLOTS ─────────
plot(
     plFound ? macdLBR : na,
     offset    = -lookbackRight,
     title     = "Regular Bullish",
     linewidth = 2,
     color     = (bullCond ? bullColor : noneColor),
     display   = display.pane,
     editable  = enableDivergence)

plotshape(
     bullCond  ? macdLBR : na,
     offset    = -lookbackRight,
     title     = "Regular Bullish Label",
     text      = " Bull ",
     style     = shape.labelup,
     location  = location.absolute,
     color     = bullColor,
     textcolor = textColor,
     display   = display.pane,
     editable  = enableDivergence)

plot(
     phFound   ? macdLBR : na,
     offset    = -lookbackRight,
     title     = "Regular Bearish",
     linewidth = 2,
     color     = (bearCond ? bearColor : noneColor),
     display   = display.pane,
     editable  = enableDivergence)

plotshape(
     bearCond  ? macdLBR : na,
     offset    = -lookbackRight,
     title     = "Regular Bearish Label",
     text      = " Bear ",
     style     = shape.labeldown,
     location  = location.absolute,
     color     = bearColor,
     textcolor = textColor,
     display   = display.pane,
     editable  = enableDivergence)

// ───────── ALERTS ─────────
alertcondition(bullCond, title="Regular Bullish Divergence", message="MACD: Regular Bullish Divergence detected.")
alertcondition(bearCond, title="Regular Bearish Divergence", message="MACD: Regular Bearish Divergence detected.")
