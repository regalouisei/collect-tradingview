//@version=5
indicator("MTF Stoch RSI + RSI Signals", overlay=true, timeframe="", timeframe_gaps=true)

//--------------------
// Inputs
//--------------------
rsiLen    = input.int(14, "RSI Length")
stochLen  = input.int(14, "Stoch RSI Length")
kSmooth   = input.int(3, "Stoch %K Smoothing")
dSmooth   = input.int(3, "Stoch %D Smoothing")

tfStoch   = input.timeframe("D",  "HTF for Stoch RSI (Daily)")
tfRsi     = input.timeframe("15", "HTF for RSI Filter (15 min)")

buyRsiLvl  = input.float(55.0, "15m RSI Min for BUY")
sellRsiLvl = input.float(50.0, "15m RSI Max for SELL")

//--------------------
// Function: Stoch RSI
//--------------------
f_stochRsi(src, rLen, sLen, kSm, dSm) =>
    _rsi = ta.rsi(src, rLen)
    _min = ta.lowest(_rsi, sLen)
    _max = ta.highest(_rsi, sLen)
    _stochRsi = (_max - _min == 0.0) ? 0.0 : (_rsi - _min) / (_max - _min) * 100.0
    _k = ta.sma(_stochRsi, kSm)
    _d = ta.sma(_k, dSm)
    [_k, _d]

//--------------------
// Higher-timeframe values
//--------------------

// Daily Stoch RSI â€” must be in ONE LINE
[stochK_D, stochD_D] = request.security(syminfo.tickerid, tfStoch, f_stochRsi(close, rsiLen, stochLen, kSmooth, dSmooth))

// 15-minute RSI filter
rsi_15 = request.security(syminfo.tickerid, tfRsi, ta.rsi(close, rsiLen))

//--------------------
// Conditions
//--------------------

// BUY:
// Daily StochRSI %K crosses above %D
// AND %K < 20
// AND 15m RSI > 55
buyCond = ta.crossover(stochK_D, stochD_D) and (stochK_D < 20) and (rsi_15 > buyRsiLvl)

// SELL:
// Daily StochRSI %K crosses below %D
// AND %K > 80
// AND 15m RSI < 50
sellCond = ta.crossunder(stochK_D, stochD_D) and (stochK_D > 80) and (rsi_15 < sellRsiLvl)

//--------------------
// Plot Signals
//--------------------
plotshape(buyCond,  title="BUY",  style=shape.triangleup,   location=location.belowbar, color=color.new(color.lime, 0),  size=size.large, text="BUY")
plotshape(sellCond, title="SELL", style=shape.triangledown, location=location.abovebar, color=color.new(color.red,  0),  size=size.large, text="SELL")

// Optional background highlight
bgcolor(buyCond ? color.new(color.lime, 85) : sellCond ? color.new(color.red, 85) : na)

// Plot HTF values for reference
plot(stochK_D, "Daily StochRSI %K", color=color.new(color.blue, 70))
plot(stochD_D, "Daily StochRSI %D", color=color.new(color.orange,70))
plot(rsi_15,   "15m RSI",           color=color.new(color.purple,70))
