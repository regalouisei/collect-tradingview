//@version=5
indicator(title="Vdubus TrixStoch + HMA Filter", shorttitle="Vdubus TrixStoch HMA", format=format.price, precision=2, overlay=false)

// --- 1. TRIX SETTINGS (Momentum) ---
group_trix = "TRIX Trend Filter"
trixLen = input.int(34, title="TRIX Length", group=group_trix)
trixSrc = input.source(close, title="Source", group=group_trix)

// Calculate TRIX
ema1 = ta.ema(math.log(trixSrc), trixLen)
ema2 = ta.ema(ema1, trixLen)
ema3 = ta.ema(ema2, trixLen)
trixValue = (ema3 - ema3[1]) * 10000

// Define TRIX Trend
isTrixBullish = trixValue > 0
isTrixBearish = trixValue < 0

// --- 2. HMA SETTINGS (Mladen's Logic) ---
group_hma = "HMA Long Trend Filter"
hmaPeriod   = input.int(100, title="HMA Period", group=group_hma)
hmaDivisor  = input.float(1.0, title="HMA Divisor", step=0.1, group=group_hma)
hmaSrc      = input.source(close, title="HMA Source", group=group_hma)

// Calculate Mladen's Hull
halfPeriod = math.round(hmaPeriod / hmaDivisor)
wmaFull    = ta.wma(hmaSrc, hmaPeriod)
wmaHalf    = ta.wma(hmaSrc, halfPeriod)
rawHull    = (2 * wmaHalf) - wmaFull
hmaValue   = ta.wma(rawHull, math.round(math.sqrt(hmaPeriod)))

// Define HMA Trend (Slope Based)
isHmaBullish = hmaValue > hmaValue[1]
isHmaBearish = hmaValue < hmaValue[1]

// --- 3. STOCHASTIC SETTINGS (Trigger) ---
group_stoch = "Stochastic Settings"
periodK = input.int(13, title="K Length", minval=1, group=group_stoch)
periodD = input.int(1, title="D Smoothing", minval=1, group=group_stoch)
smoothK = input.int(9, title="K Smoothing", minval=1, group=group_stoch)

// Dual Center Lines
upperLimit = input.int(52, title="Upper Limit (Sell)", minval=50, group=group_stoch)
lowerLimit = input.int(48, title="Lower Limit (Buy)", maxval=50, group=group_stoch)

// Calculate Stochastic
stochK = ta.sma(ta.stoch(close, high, low, periodK), smoothK)
stochD = ta.sma(stochK, periodD)
triggerLine = stochK 

// --- 4. COMBINED SIGNALS ---
// BULLISH: Trix is UP + HMA Slope is UP + Stoch dips
bullishSignal = isTrixBullish and isHmaBullish and ta.crossunder(triggerLine, lowerLimit)

// BEARISH: Trix is DOWN + HMA Slope is DOWN + Stoch rallies
bearishSignal = isTrixBearish and isHmaBearish and ta.crossover(triggerLine, upperLimit)

// --- 5. PLOTTING ---
plot(stochK, title="%K", color=color.blue)
plot(stochD, title="%D", color=color.orange)

// Plot Limits
hUpper = hline(upperLimit, "Upper", color=color.gray, linestyle=hline.style_dotted)
hLower = hline(lowerLimit, "Lower", color=color.gray, linestyle=hline.style_dotted)
fill(hUpper, hLower, color=color.new(color.gray, 90))
hline(80, "Upper Band", color=color.gray)
hline(20, "Lower Band", color=color.gray)

// Visualizing the Trend (Background)
finalTrendColor = isTrixBullish and isHmaBullish ? color.new(color.green, 90) : 
                  isTrixBearish and isHmaBearish ? color.new(color.red, 90) : 
                  color.new(color.gray, 95) 

bgcolor(finalTrendColor, title="Trend Confluence Background")

// Plot Signals
plotshape(bullishSignal ? lowerLimit : na, title="Buy Signal", location=location.absolute, color=color.green, style=shape.circle, size=size.tiny, text="Dip", textcolor=color.green, offset=0)
plotshape(bearishSignal ? upperLimit : na, title="Sell Signal", location=location.absolute, color=color.red, style=shape.circle, size=size.tiny, text="Rally", textcolor=color.red, offset=0)

// Alerts
alertcondition(bullishSignal, title="HMA+Trix Buy", message="Confluence Buy: HMA Up, Trix Up, Stoch Dip")
alertcondition(bearishSignal, title="HMA+Trix Sell", message="Confluence Sell: HMA Down, Trix Down, Stoch Rally")
