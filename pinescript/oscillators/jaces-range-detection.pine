//@version=5
indicator("Range Detection", overlay=true)

// Input parameters
rangePeriod = input.int(20, "Range Detection Period", minval=5, maxval=200, tooltip="Number of bars to analyze for range detection")
rangeThreshold = input.float(2.0, "Range Threshold %", minval=0.5, maxval=10.0, step=0.5, tooltip="Maximum price movement % to be considered ranging")
atrPeriod = input.int(14, "ATR Period", minval=1, maxval=100, tooltip="Period for ATR calculation")
atrMultiplier = input.float(0.5, "ATR Range Multiplier", minval=0.1, maxval=2.0, step=0.1, tooltip="ATR multiplier for range detection")
showRangeBox = input.bool(true, "Show Range Box", tooltip="Display a box around the ranging period")
showLabels = input.bool(true, "Show Labels", tooltip="Display ranging/trending labels")

// Calculate ATR for volatility measurement
atr = ta.atr(atrPeriod)

// Calculate highest high and lowest low over the period
highestHigh = ta.highest(high, rangePeriod)
lowestLow = ta.lowest(low, rangePeriod)
rangeSize = highestHigh - lowestLow
midPoint = (highestHigh + lowestLow) / 2

// Calculate price movement as percentage
priceMovement = (rangeSize / midPoint) * 100

// Method 1: Price movement threshold
isRangingByPrice = priceMovement <= rangeThreshold

// Method 2: ATR-based detection
avgPrice = (high + low) / 2
isRangingByATR = rangeSize <= (atr * atrMultiplier * rangePeriod)

// Combine both methods
isRanging = isRangingByPrice or isRangingByATR

// Calculate trend strength using ADX concept
dmPlus = high - high[1]
dmMinus = low[1] - low
dmPlusSmooth = ta.sma(dmPlus > dmMinus and dmPlus > 0 ? dmPlus : 0, rangePeriod)
dmMinusSmooth = ta.sma(dmMinus > dmPlus and dmMinus > 0 ? dmMinus : 0, rangePeriod)
dx = math.abs(dmPlusSmooth - dmMinusSmooth) / (dmPlusSmooth + dmMinusSmooth) * 100
adx = ta.sma(dx, rangePeriod)

// Consider it ranging if ADX is low (weak trend)
isRangingByADX = adx < 25

// Final ranging determination
finalRanging = isRanging and isRangingByADX

// Track state changes
var bool wasRanging = false
rangingStateChanged = finalRanging != wasRanging
wasRanging := finalRanging

// Plot range lines (hidden - only used for fill)
upperRange = plot(na, display=display.none, title="Upper Range")
lowerRange = plot(na, display=display.none, title="Lower Range")

// Draw range boxes
var box rangeBox = na
if finalRanging and showRangeBox
    if not finalRanging[1]
        // Starting a new range
        rangeBox := box.new(left=bar_index,top=highestHigh,right=bar_index,bottom=lowestLow,border_color=color.orange,bgcolor=color.new(color.orange, 95),border_width=2,extend=extend.right)
    else if not na(rangeBox)
        // Update existing range box
        box.set_right(rangeBox, bar_index)
        box.set_top(rangeBox, highestHigh)
        box.set_bottom(rangeBox, lowestLow)
else if not finalRanging and not na(rangeBox)
    // End the range box
    box.set_right(rangeBox, bar_index)
    box.set_extend(rangeBox, extend.none)
    rangeBox := na

// Show labels
if showLabels
    if finalRanging and not finalRanging[1]
        label.new(bar_index,high,"RANGING",color=color.new(color.orange, 20),textcolor=color.white,style=label.style_label_down,size=size.small)
    else if not finalRanging and finalRanging[1]
        label.new(bar_index,high,"BREAKOUT",color=color.new(color.green, 20),textcolor=color.white,style=label.style_label_down,size=size.small)

// Background color
bgcolor(finalRanging ? color.new(color.orange, 95) : na, title="Ranging Background")

// Plot signals
plotshape(finalRanging and not finalRanging[1],title="Range Start",style=shape.triangleup,location=location.belowbar,color=color.orange,size=size.small)

plotshape(not finalRanging and finalRanging[1],title="Range End",style=shape.triangledown,location=location.abovebar,color=color.green,size=size.small)

// Info table
var table infoTable = table.new(position.top_right, 2, 5, bgcolor=color.new(color.black, 80), border_width=1)

if barstate.islast
    table.cell(infoTable, 0, 0, "Status:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, finalRanging ? "RANGING" : "TRENDING", text_color=finalRanging ? color.orange : color.green, text_size=size.small)
    
    table.cell(infoTable, 0, 1, "Range Size:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 1, str.tostring(rangeSize, "#.##"), text_color=color.yellow, text_size=size.small)
    
    table.cell(infoTable, 0, 2, "Movement %:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 2, str.tostring(priceMovement, "#.##") + "%", text_color=color.aqua, text_size=size.small)
    
    table.cell(infoTable, 0, 3, "ADX:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 3, str.tostring(adx, "#.##"), text_color=color.yellow, text_size=size.small)
    
    table.cell(infoTable, 0, 4, "Mid Point:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 4, str.tostring(midPoint, "#.##"), text_color=color.white, text_size=size.small)

// Alert conditions
alertcondition(finalRanging and not finalRanging[1], title="Entering Range", message="Stock is entering a ranging period")
alertcondition(not finalRanging and finalRanging[1], title="Breakout from Range", message="Stock is breaking out of range")
