//@version=6
indicator("FVG PRO Auto Adaptive", overlay=true)

// ===== USER CONTROL =====
useAutoTF = input.bool(true, "Auto Adjust Parameters by Timeframe")
useSweepFilter = input.bool(true, "Use Liquidity Sweep Filter")
deleteIDsInput = input.string("", "Delete FVG IDs (comma separated)")

// ===== COLOR CONTROL =====
bullColor   = input.color(color.green, "Bullish Rectangle Color")
bearColor   = input.color(color.red, "Bearish Rectangle Color")
closedColor = input.color(color.gray, "Closed Rectangle Color")

bullTransp   = input.int(70, "Bullish Transparency (0-100)", minval=0, maxval=100)
bearTransp   = input.int(70, "Bearish Transparency (0-100)", minval=0, maxval=100)
closedTransp = input.int(90, "Closed Transparency (0-100)", minval=0, maxval=100)

// ===== TIMEFRAME DETECTION =====
tf = timeframe.in_seconds(timeframe.period)

// ===== DEFAULT MANUAL VALUES =====
manualLookback = input.int(15, "Manual Liquidity Lookback")
manualMemory   = input.int(12, "Manual Sweep Memory")
manualBuffer   = input.float(0.25, "Manual ATR Buffer")
manualATRmult  = input.float(1.2, "Manual ATR Multiplier")

// ===== AUTO PARAMETERS =====
lookback = useAutoTF ? (tf <= 60 ? 12 : tf <= 300 ? 15 : 20) : manualLookback
memory   = useAutoTF ? (tf <= 60 ? 8  : tf <= 300 ? 12 : 18) : manualMemory
buffer   = useAutoTF ? (tf <= 60 ? 0.35 : tf <= 300 ? 0.25 : 0.15) : manualBuffer
atrMultiplier = useAutoTF ? (tf <= 60 ? 1.1 : tf <= 300 ? 1.2 : 1.35) : manualATRmult

// ===== BASE SETTINGS =====
minGapPerc = 0.015
atr = ta.atr(14)

// ===== LIQUIDITY =====
rangeHigh = ta.highest(high, lookback)[1]
rangeLow  = ta.lowest(low, lookback)[1]

// ===== IMPULSE =====
candleRange = high[1] - low[1]
candleBody  = math.abs(close[1] - open[1])
bodyRatio   = candleRange > 0 ? candleBody / candleRange : 0
impulseValid = candleRange > atr * atrMultiplier and bodyRatio >= 0.5

// ===== SWEEP =====
bullSweepNow = low[1] <= (rangeLow + atr * buffer)
bearSweepNow = high[1] >= (rangeHigh - atr * buffer)

bullSweepRecent = ta.barssince(bullSweepNow) <= memory
bearSweepRecent = ta.barssince(bearSweepNow) <= memory

// ===== GAP =====
bullGap = low > high[2]
bearGap = high < low[2]

bullSize = ((low - high[2]) / high[2]) * 100.0
bearSize = ((low[2] - high) / low[2]) * 100.0

validBull = bullGap and bullSize >= minGapPerc and impulseValid and (not useSweepFilter or bullSweepRecent)
validBear = bearGap and bearSize >= minGapPerc and impulseValid and (not useSweepFilter or bearSweepRecent)

// ===== ARRAYS =====
var box[] boxes = array.new_box()
var line[] mids = array.new_line()
var label[] ids = array.new_label()
var float[] midPrices = array.new_float()
var float[] topPrices = array.new_float()
var float[] bottomPrices = array.new_float()
var bool[] isBull = array.new_bool()
var bool[] midAlerted = array.new_bool()
var bool[] fullyClosed = array.new_bool()
var int[] idNumbers = array.new_int()

var int nextID = 1
deleteList = str.split(deleteIDsInput, ",")

// ===== CREATE =====
if validBull or validBear
    isBullish = validBull
    top = isBullish ? low : low[2]
    bottom = isBullish ? high[2] : high
    mid = (top + bottom) / 2.0

    rectColor = isBullish ? bullColor : bearColor
    rectTransp = isBullish ? bullTransp : bearTransp

    b = box.new(bar_index - 2, top, bar_index, bottom,
        bgcolor=color.new(rectColor, rectTransp),
        border_color=rectColor)

    l = line.new(bar_index - 2, mid, bar_index, mid,
        color=isBullish ? color.yellow : color.orange, width=2)

    idLabel = label.new(bar_index - 2, top,
        text=str.tostring(nextID),
        style=isBullish ? label.style_label_down : label.style_label_up,
        color=rectColor,
        textcolor=color.white)

    array.push(boxes, b)
    array.push(mids, l)
    array.push(ids, idLabel)
    array.push(midPrices, mid)
    array.push(topPrices, top)
    array.push(bottomPrices, bottom)
    array.push(isBull, isBullish)
    array.push(midAlerted, false)
    array.push(fullyClosed, false)
    array.push(idNumbers, nextID)

    nextID += 1

// ===== UPDATE (PROTECTED LOOP) =====
boxCount = array.size(boxes)

if boxCount > 0
    for i = 0 to boxCount - 1

        b = array.get(boxes, i)
        l = array.get(mids, i)
        lab = array.get(ids, i)
        mid = array.get(midPrices, i)
        top = array.get(topPrices, i)
        bottom = array.get(bottomPrices, i)
        bull = array.get(isBull, i)
        alerted = array.get(midAlerted, i)
        closed = array.get(fullyClosed, i)
        thisID = array.get(idNumbers, i)

        // DELETE BY ID
        shouldDelete = false
        for j = 0 to array.size(deleteList) - 1
            idText = str.trim(array.get(deleteList, j))
            if idText != "" and str.tonumber(idText) == thisID
                shouldDelete := true

        if shouldDelete
            box.delete(b)
            line.delete(l)
            label.delete(lab)

        else
            if not closed
                box.set_right(b, bar_index)
                line.set_x2(l, bar_index)
                label.set_x(lab, bar_index)

                if not alerted and ((bull and low <= mid) or (not bull and high >= mid))
                    alert("FVG 50% touched", alert.freq_once_per_bar)
                    array.set(midAlerted, i, true)

                fullyFilled = (bull and low <= bottom) or (not bull and high >= top)

                if fullyFilled
                    array.set(fullyClosed, i, true)
                    box.set_bgcolor(b, color.new(closedColor, closedTransp))
                    box.set_border_color(b, closedColor)
                    line.set_color(l, closedColor)
