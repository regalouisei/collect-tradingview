// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© YourName or similar

//@version=5
strategy("TRAMA + Supertrend + SuperOsc Long Strategy", overlay=true, initial_capital=500, default_qty_type=strategy.percent_of_equity, default_qty_value=100, commission_type=strategy.commission.percent, commission_value=0)

// TRAMA Inputs and Calculation
length_trama = input.int(99, "TRAMA Length")
src_trama = input.source(close, "TRAMA Source")
float ama = 0.0
hh = math.max(math.sign(ta.change(ta.highest(length_trama))), 0)
ll = math.max(math.sign(ta.change(ta.lowest(length_trama)) * -1), 0)
tc = math.pow(ta.sma(hh or ll ? 1 : 0, length_trama), 2)
ama := nz(ama[1] + tc * (src_trama - ama[1]), src_trama)
plot(ama, "TRAMA", color=color.yellow, linewidth=2)

// Supertrend Inputs and Calculation
Periods = input.int(10, "ATR Period")
src_st = input.source(hl2, "Supertrend Source")
Multiplier = input.float(3.0, "ATR Multiplier", step=0.1)
changeATR = input.bool(true, "Change ATR Calculation Method ?")
atr2 = ta.sma(ta.tr, Periods)
atr_val = changeATR ? ta.atr(Periods) : atr2
up = src_st - (Multiplier * atr_val)
up1 = nz(up[1], up)
up := close[1] > up1 ? math.max(up, up1) : up
dn = src_st + (Multiplier * atr_val)
dn1 = nz(dn[1], dn)
dn := close[1] < dn1 ? math.min(dn, dn1) : dn
int trend_st = na
trend_st := nz(trend_st[1], 1)
trend_st := trend_st == -1 and close > dn1 ? 1 : trend_st == 1 and close < up1 ? -1 : trend_st

// Supertrend Plots (optional, for visualization)
upPlot = plot(trend_st == 1 ? up : na, title="Up Trend", style=plot.style_linebr, linewidth=2, color=color.green)
dnPlot = plot(trend_st == 1 ? na : dn, title="Down Trend", style=plot.style_linebr, linewidth=2, color=color.red)
mPlot = plot(ohlc4, title="", style=plot.style_circles, linewidth=0)
longFillColor = color.new(color.green, 90)  // Light green for highlighting
shortFillColor = color.new(color.red, 90)   // Light red
fill(mPlot, upPlot, title="UpTrend Highlighter", color=longFillColor)
fill(mPlot, dnPlot, title="DownTrend Highlighter", color=shortFillColor)

// Supertrend Signals
buySignal = trend_st == 1 and trend_st[1] == -1  // Uptrend Begins (Green dot)
sellSignal = trend_st == -1 and trend_st[1] == 1 // Downtrend Begins (Red dot)

// Plot Signals (optional)
plotshape(buySignal ? up : na, title="UpTrend Begins", location=location.absolute, style=shape.circle, size=size.tiny, color=color.green)
plotshape(sellSignal ? dn : na, title="DownTrend Begins", location=location.absolute, style=shape.circle, size=size.tiny, color=color.red)

// SuperTrend Oscillator Inputs and Calculation (for green bar detection)
length_sto = input.int(10, "SuperOsc Length", minval=1)
mult_sto = input.float(2.0, "SuperOsc Multiplier", minval=1)
src_sto = close
atr_sto = ta.atr(length_sto) * mult_sto
up_sto = hl2 + atr_sto
dn_sto = hl2 - atr_sto
float upper_sto = 0.0
float lower_sto = 0.0
int trend_sto_osc = 0
upper_sto := src_sto[1] < upper_sto[1] ? math.min(up_sto, upper_sto[1]) : up_sto
lower_sto := src_sto[1] > lower_sto[1] ? math.max(dn_sto, lower_sto[1]) : dn_sto
trend_sto_osc := src_sto > upper_sto[1] ? 1 : src_sto < lower_sto[1] ? 0 : nz(trend_sto_osc[1])
Spt = trend_sto_osc * lower_sto + (1 - trend_sto_osc) * upper_sto
osc = math.max(math.min((src_sto - Spt) / (upper_sto - lower_sto), 1), -1)

// SuperOsc Signal: OSC is green (positive)
oscGreen = osc > 0

// Entry/Exit Conditions
// Primary entry at start of uptrend if above TRAMA and OSC green
primaryLong = buySignal and (close > ama) and oscGreen
// Additional entry during uptrend on crossover above TRAMA if OSC green and not in position
additionalLong = (trend_st == 1) and ta.crossover(close, ama) and oscGreen and (strategy.position_size == 0)
longCondition = primaryLong or additionalLong
// Exit ONLY on Supertrend Downtrend Begins (red dot)
exitCondition = sellSignal

// Strategy Orders
if (longCondition)
    strategy.entry("Long", strategy.long)

if (exitCondition)
    strategy.close("Long")

// Optional: Plot strategy signals
plotshape(series=longCondition, title="Strategy Long Entry", location=location.belowbar, color=color.lime, style=shape.labelup, text="LONG", size=size.small)
plotshape(series=exitCondition, title="Strategy Long Exit", location=location.abovebar, color=color.orange, style=shape.labeldown, text="EXIT", size=size.small)
