// This work is licensed under a Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0) https://creativecommons.org/licenses/by-nc-sa/4.0/
// © LuxAlgo
//@version=6
indicator("Normalized Resonator [LuxAlgo]", "LuxAlgo - Normalized Resonator", overlay = false)

//---------------------------------------------------------------------------------------------------------------------}
// Constants
//---------------------------------------------------------------------------------------------------------------------{
float PI = math.pi

//---------------------------------------------------------------------------------------------------------------------}
// Inputs
//---------------------------------------------------------------------------------------------------------------------{
float srcInput          = input.source(hl2, "Source")
int   periodInput       = input.int(100,    "Center Period",        minval = 2, tooltip = "The primary cycle length to isolate.")
float deltaInput        = input.float(0.5,  "Bandwidth",            minval = 0.01, maxval = 1, step = 0.05, tooltip = "Determines the width of the passband. Lower values result in a sharper filter.")
float lookbackMultInput = input.float(1.0,  "Lookback Multiplier",  minval = 0.1, step = 0.1, tooltip = "Sets the normalization lookback as a multiple of the Center Period. A value of 1.0 means the lookback equals the Center Period.")

// Signal & Levels
int   signalLengthInput = input.int(9,      "Signal Line Period",   minval = 1, tooltip = "Smoothing period for the signal line.")
float obInput           = input.float(0.8,  "Overbought",           minval = 0, step = 0.1, group = "Levels")
float osInput           = input.float(-0.8, "Oversold",             maxval = 0, step = 0.1, group = "Levels")

// Style Settings
color bullColorInput    = input.color(#089981,  "Bullish Color",    group = "Style")
color bearColorInput    = input.color(#f23645,  "Bearish Color",    group = "Style")
color signalColorInput  = input.color(#787b86,  "Signal Line Color",group = "Style")
string signalSizeInput  = input.string("Normal", "Signal Size",      group = "Style", options = ["Tiny", "Small", "Normal", "Large", "Huge"])

//---------------------------------------------------------------------------------------------------------------------}
// Calculations
//---------------------------------------------------------------------------------------------------------------------{

// 1. Resonator Math (Bilinear Transform / Unity Gain)
float omega = 2 * PI / periodInput
float alpha = math.tan(PI * deltaInput / periodInput)
float beta  = math.cos(omega)
float r     = 1.0 / (1.0 + alpha)

// Coefficients for stable damping and unity gain
float c1    = 2 * r * beta
float c2    = -(2 * r - 1)
float gain  = alpha * r

var float bp = 0.0
bp := gain * (srcInput - srcInput[2]) + c1 * nz(bp[1]) + c2 * nz(bp[2])

// 2. Normalization via Lookback Multiplier
int peakLookback = math.max(1, int(periodInput * lookbackMultInput))
float peak       = ta.highest(math.abs(bp), peakLookback)
float oscillator = peak != 0 ? bp / peak : 0

// 3. Signal Line
float signalLine = ta.ema(oscillator, signalLengthInput)

// Colors & Visuals
color signalColor = oscillator > 0 ? bullColorInput : bearColorInput

// Gradient logic
float topVal    = math.max(oscillator, 0)
float bottomVal = math.min(oscillator, 0)
color topColor  = oscillator > 0 ? color.new(bullColorInput, 50) : color.new(bearColorInput, 100)
color botColor  = oscillator > 0 ? color.new(bullColorInput, 100) : color.new(bearColorInput, 50)

// Crossover Logic
bool crossUp   = ta.crossover(oscillator, signalLine) and oscillator < osInput
bool crossDown = ta.crossunder(oscillator, signalLine) and oscillator > obInput

var signalSize = switch signalSizeInput
    "Tiny"   => size.tiny
    "Small"  => size.small
    "Normal" => size.normal
    "Large"  => size.large
    "Huge"   => size.huge

//---------------------------------------------------------------------------------------------------------------------}
// Plots
//---------------------------------------------------------------------------------------------------------------------{
plotZero = plot(0, "Zero Line", color.new(chart.fg_color, 70))
plotOsc  = plot(oscillator, "Oscillator", signalColor, 2)
plotSig  = plot(signalLine, "Signal Line", signalColorInput, 1)

// Gradient Fill
fill(plotOsc, plotZero, topVal, bottomVal, topColor, botColor, "Oscillator Fill")

// OB/OS Levels
hline(obInput, "Overbought Level", color.new(chart.fg_color, 60), linestyle = hline.style_dashed)
hline(osInput, "Oversold Level",   color.new(chart.fg_color, 60), linestyle = hline.style_dashed)
// Signals (Labels) - Forced to Overlay on Main Chart
if crossUp
    label.new(bar_index, low, "▲", color = #00000000, textcolor = bullColorInput, style = label.style_label_up, size = signalSize, force_overlay = true)

if crossDown
    label.new(bar_index, high, "▼", color = #00000000, textcolor = bearColorInput, style = label.style_label_down, size = signalSize, force_overlay = true)

//---------------------------------------------------------------------------------------------------------------------}
