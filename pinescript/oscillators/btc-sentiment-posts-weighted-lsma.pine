//@version=6
indicator("BTC - Sentiment (Posts weighted) LSMA | RM", overlay=false, precision=2)

// ==========================================
// █▀█ █▀█ █▄▄   █▀▄▀█ ▄▀█ ▀█▀ █▄█ █▀
// █▀▄ █▄█ █▄█   █░▀░█ █▀█ ░█░ █░█ ▄█
// ==========================================
// Series : BTC - Social Data
// BTC - Sentiment LSMA Oscillator | RM
// ==========================================

// ==========================================
// 1. DATA INPUTS
// ==========================================
grp_audit = "LunarCrush Social Audit"
social_src = input.string("LUNARCRUSH:BTC_SENTIMENT", "Social Metric Source", group=grp_audit)
lsma_len   = input.int(28, "LSMA Lookback Window", minval=2, group=grp_audit)

grp_logic  = "Sentiment Thresholds"
buy_th     = input.float(72.5, "Oversold/Accumulation (Blue)", minval=0, group=grp_logic)
sell_th    = input.float(82.5, "Overheated/Distribution (Red)", minval=0, group=grp_logic)

grp_visual = "Visual Scaling & Assets"
low_bound  = input.float(65.0, "Scale Floor (mNAV Sync)", group=grp_visual)
high_bound = input.float(90.0, "Scale Ceiling (mNAV Sync)", group=grp_visual)
c_over     = input.color(#ff1100, "Overheated Sentiment", group=grp_visual)
c_under    = input.color(#0094ff, "Social Despair", group=grp_visual)
c_neut     = input.color(#909497, "Neutral Zone", group=grp_visual)

// ==========================================
// 2. SENTIMENT LSMA ENGINE
// ==========================================
// Fetching Social Sentiment Data
raw_sentiment = request.security(social_src, timeframe.period, close)

// Least Squares Moving Average (Linear Regression)
// This removes noise while preserving the trend direction
lsma_sentiment = ta.linreg(raw_sentiment, lsma_len, 0)

// ==========================================
// 3. VISUAL ENGINE
// ==========================================
// Forcing the scale between 65 and 90 to ensure visibility
plot(high_bound, "Ceiling", color=color.new(color.white, 100))
plot(low_bound, "Floor", color=color.new(color.white, 100))

// Dynamic Color Mapping
c_dynamic = lsma_sentiment > sell_th ? c_over : lsma_sentiment < buy_th ? c_under : c_neut

// Main Curve
p_main = plot(lsma_sentiment, "Sentiment LSMA", color=c_dynamic, linewidth=3)

// Horizontal Reference Lines
h_sell = hline(sell_th, "Overheated Level", color=color.new(c_over, 50), linestyle=hline.style_dashed)
h_buy  = hline(buy_th, "Accumulation Level", color=color.new(c_under, 50), linestyle=hline.style_dashed)

// Shading the Threshold Zones
fill(p_main, plot(high_bound, display=display.none), color = lsma_sentiment > sell_th ? color.new(c_over, 80) : na)
fill(p_main, plot(low_bound, display=display.none), color = lsma_sentiment < buy_th ? color.new(c_under, 80) : na)

// ==========================================
// 4. REGIME DASHBOARD
// ==========================================
if barstate.islast
    var table rm_table = table.new(position.top_right, 2, 4, bgcolor=color.rgb(15, 15, 15), border_width=1)
    
    // Header
    table.cell(rm_table, 0, 0, "LSMA SENTIMENT", text_color=color.white, text_size=size.small)
    table.cell(rm_table, 1, 0, str.tostring(lsma_sentiment, "#.##") + "%", text_color=color.white, text_size=size.small)
    
    // Integrity Score Proxy
    float social_score = ((lsma_sentiment - 65) / (90 - 65)) * 10
    table.cell(rm_table, 0, 1, "SOCIAL HEAT INDEX", text_color=color.white, text_size=size.small)
    table.cell(rm_table, 1, 1, str.tostring(social_score, "#.#") + " / 10", text_color=c_dynamic, text_size=size.small)

    // Regime Audit
    string regime = lsma_sentiment > sell_th ? "DISTRIBUTION" : lsma_sentiment < buy_th ? "ACCUMULATION" : "NEUTRAL"
    table.cell(rm_table, 0, 2, "REGIME AUDIT", text_color=color.white, text_size=size.small)
    table.cell(rm_table, 1, 2, regime, text_color=c_dynamic, text_size=size.small)
