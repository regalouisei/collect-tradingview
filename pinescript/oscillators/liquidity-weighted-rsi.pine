//@version=6
indicator("Liquidity-Weighted RSI", shorttitle="LW-RSI", overlay=false)

// ===== Inputs =====
rsiLen    = input.int(14, "RSI Length", minval=1)
volLen    = input.int(20, "Volume MA Length", minval=1)
lwMaLen   = input.int(20, "LW-RSI Average Length", minval=1)
threshold = input.float(100.0, "Spike Threshold", step=0.1)
src       = input.source(close, "RSI Source")

// ===== Core Calculation =====
rsiVal   = ta.rsi(src, rsiLen)
volMA    = ta.sma(volume, volLen)
volRatio = volMA != 0.0 ? volume / volMA : na

// LW-RSI (not smoothed)
lwRsi = rsiVal * volRatio

// ===== LW-RSI Average (IMPORTANT PART) =====
// This is NOT MA of price or volume
// This is MA of LW-RSI itself
lwRsiAvg = ta.sma(lwRsi, lwMaLen)

// ===== Spike Color Logic =====
// Normal state: BLUE
// Spike state (lwRsi > threshold):
//   - GREEN if buy-pressure proxy (close > open)
//   - RED   if sell-pressure proxy (close < open)
// If close == open, keep BLUE even in spike (neutral bar)
isBuy  = close > open
isSell = close < open

lwColor =
     lwRsi > threshold ? (isBuy ? color.lime : isSell ? color.red : color.blue)
                       : color.blue

// ===== Plots =====
plot(lwRsi, title="LW-RSI", linewidth=2, color=lwColor)
plot(lwRsiAvg, title="LW-RSI Average", linewidth=2, color=color.orange)

// ===== Reference (RSI guides only) =====
hline(70, "RSI 70", linestyle=hline.style_dotted)
hline(50, "RSI 50", linestyle=hline.style_dotted)
hline(30, "RSI 30", linestyle=hline.style_dotted)
hline(threshold, "Spike Threshold", linestyle=hline.style_dashed)
// ===== 0â€“Threshold Background Band =====
h0 = hline(0, "Zero")
hT = hline(threshold, "Threshold")

fill(h0, hT, color=color.new(color.blue, 85))
