//@version=6
indicator("BTC Regime Oscillator (MC + Spread) [1D]", overlay=false, precision=2, timeframe="D")

// Inputs
mcapSymbol   = input.symbol("CRYPTOCAP:BTC", "BTC Market Cap Symbol (USD)")
totalSupply  = input.float(21000000, "BTC Total Supply (Hard Cap)", minval=0)
normLen      = input.int(200, "Normalization Length", minval=50)
smoothLen    = input.int(7, "Smoothing", minval=1)

// Zones
upperZone = input.int(60, "Upper Zone", minval=0, maxval=100)
lowerZone = input.int(-60, "Lower Zone", minval=-100, maxval=0)

// Make spread visually obvious (does NOT change underlying math)
spreadMult = input.float(10.0, "Spread Visual Multiplier", minval=1.0, step=0.5)

float eps = 1e-10

// Data (1D)
mcap = request.security(mcapSymbol, timeframe.period, close)
fdv  = close * totalSupply

// Log transform to tame scale
mcLog  = math.log(math.max(mcap, eps))
fdvLog = math.log(math.max(fdv, eps))

// Z-scores
mcMean  = ta.sma(mcLog, normLen)
mcStdev = ta.stdev(mcLog, normLen)
mcZ     = (mcLog - mcMean) / math.max(mcStdev, eps)

fdvMean  = ta.sma(fdvLog, normLen)
fdvStdev = ta.stdev(fdvLog, normLen)
fdvZ     = (fdvLog - fdvMean) / math.max(fdvStdev, eps)

// Compress to [-100, 100]
mcOsc  = ta.ema((2.0 / math.pi) * math.atan(mcZ) * 100.0, smoothLen)
fdvOsc = ta.ema((2.0 / math.pi) * math.atan(fdvZ) * 100.0, smoothLen)

// Spread (for BTC: valuation stress, not dilution)
spread    = fdvOsc - mcOsc
spreadVis = spread * spreadMult

// Zones
hline(upperZone, "Upper Zone", linestyle=hline.style_dotted)
hline(0, "Mid", linestyle=hline.style_dotted)
hline(lowerZone, "Lower Zone", linestyle=hline.style_dotted)

// Plots (oscillator-first)
// 1) MAIN LINE: Market Cap Osc (anchor)
plot(mcOsc, title="MC Osc (Anchor)", linewidth=3)

// 2) OPTIONAL LINE: FDV Osc (thin, just for reference)
plot(fdvOsc, title="FDV Osc (Reference)", linewidth=1)

// 3) MAIN SIGNAL: Spread histogram (scaled so you can actually see it)
plot(spreadVis, title="Spread (FDV - MC) x Mult", style=plot.style_histogram, linewidth=2)

// Extra: highlight when spread is positive (FDV above MC)
bgcolor(spread > 0 ? color.new(color.red, 90) : na)
