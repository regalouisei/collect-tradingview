//@version=5
indicator("HaP D-RSI", overlay=false)

// Kullanıcıdan periyot girdileri
rsiksa_period = input.int(10, minval=1, title="RSI kısa Periyodu")
rsiuzun_period = input.int(14, minval=1, title="RSI uzun Periyodu")

timeframe = input.timeframe("", title="Periyot Seçimi")

// EMA periyodu için ayar
ema_period = input.int(9, minval=1, title="EMA Periyodu",  display = display.none)

// RSI Hesaplamaları
rsiksa = request.security(syminfo.tickerid, timeframe, ta.rsi(close, rsiksa_period))
rsiuzun = request.security(syminfo.tickerid, timeframe, ta.rsi(close, rsiuzun_period))


// RSI 14 üzerine EMA hesaplaması
rsi_ema = ta.ema(rsiuzun, ema_period)

// RSI çizdirme
plot_rsiksa = plot(rsiksa, color=color.lime, title="RSI (10)", display = display.none)
plot_rsi_ema = plot(rsi_ema, color=color.orange, title="RSI (14) EMA", linewidth=2,  display = display.none)
plot_rsiuzun = plot(rsiuzun, color=color.blue, title="RSI (14)",  display = display.none)

// RSI kısa ile RSI EMA arasındaki alanı doldur
color_fill_up = color.new(color.blue, 1)  // RSI kısa üstteyken alan rengi
color_fill_down = color.new(color.red, 1)  // RSI kısa alttayken alan rengi


// Alan boyama için opaklık kontrolü
rsi_previous = nz(rsiksa[1])  // Bir önceki RSI değeri
rsi_current = rsiksa           // Mevcut RSI değeri

// Opaklık değişimleri
color_fill_up_opacity = (rsi_current < rsi_previous) ? color.new(color.blue, 50) : color.blue
color_fill_down_opacity = (rsi_current > rsi_previous) ? color.new(color.red, 50) : color.red

// Alan boyama
fill(plot_rsiksa, plot_rsi_ema, color=(rsiksa > rsi_ema ? color_fill_up_opacity : color_fill_down_opacity))
fill(plot_rsiksa, plot_rsiuzun, color=rsiksa > rsiuzun ? color.new(color.blue, 70) : color.new(color.red, 70), title="RSI 10 ve RSI 14 Arası Alan")

// 70 ve 30 referans çizgileri çizdirme
hline(70, "Aşırı Alım", color=color.rgb(230, 111, 96), linestyle=hline.style_dashed)
hline(30, "Aşırı Satım", color=#33af18, linestyle=hline.style_dashed)
hline(50, "orta", color=color.rgb(3, 31, 1), linestyle=hline.style_dashed)

// Uyumsuzluk tespiti için gerekli değişkenler
lbR = input.int(5, title="Pivot Lookback Right", minval=1)
lbL = input.int(5, title="Pivot Lookback Left", minval=1)
rangeUpper = input.int(60, title="Max of Lookback Range", minval=1)
rangeLower = input.int(5, title="Min of Lookback Range", minval=1)
plotBull = input.bool(true, title="pozitif uyumsuzluk")
plotHiddenBull = input.bool(true, title="gizli pozitif uyumsuzluk")
plotBear = input.bool(true, title="negatif uyumsuzluk")
plotHiddenBear = input.bool(true, title="gizli negatif uyumsuzluk")

bearColor = color.red
bullColor = color.navy
hiddenBullColor = color.new(color.olive, 50)
hiddenBearColor = color.new(color.fuchsia, 50)
textColor = color.white
noneColor = color.new(color.white, 100)

// RSI değerini kullanarak uyumsuzluk tespiti
osc = rsiuzun

plFound = ta.pivotlow(osc, lbL, lbR) != 0
phFound = ta.pivothigh(osc, lbL, lbR) != 0

_inRange(cond) =>
    bars = ta.barssince(cond)
    rangeLower <= bars and bars <= rangeUpper

// Regular Bullish Divergence
oscHL = osc[lbR] > ta.valuewhen(plFound, osc[lbR], 1) and _inRange(plFound[1])
priceLL = low[lbR] < ta.valuewhen(plFound, low[lbR], 1)
bullCond = plotBull and priceLL and oscHL and plFound

plot(plFound ? osc[lbR] : na, offset=-lbR, title="pozitif uyumsuzluk", linewidth=2, color=(bullCond ? bullColor : noneColor), transp=0,  display = display.none)
plotshape(bullCond ? osc[lbR] : na, offset=-lbR, title="pozitif uyumsuzluk alanı" , text="pu", style=shape.labelup, location=location.absolute, color=bullColor, textcolor=textColor, transp=0)

// Hidden Bullish Divergence
oscLL = osc[lbR] < ta.valuewhen(plFound, osc[lbR], 1) and _inRange(plFound[1])
priceHL = low[lbR] > ta.valuewhen(plFound, low[lbR], 1)
hiddenBullCond = plotHiddenBull and priceHL and oscLL and plFound

plot(plFound ? osc[lbR] : na, offset=-lbR, title="gizli pozitif uyumsuzluk", linewidth=2, color=(hiddenBullCond ? hiddenBullColor : noneColor), transp=0,  display = display.none)
plotshape(hiddenBullCond ? osc[lbR] : na, offset=-lbR, title="gizli pozitif uyumsuzluk alanı", text="gpu", style=shape.labelup, location=location.absolute, color=bullColor, textcolor=textColor, transp=0)

// Regular Bearish Divergence
oscLH = osc[lbR] < ta.valuewhen(phFound, osc[lbR], 1) and _inRange(phFound[1])
priceHH = high[lbR] > ta.valuewhen(phFound, high[lbR], 1)
bearCond = plotBear and priceHH and oscLH and phFound

plot(phFound ? osc[lbR] : na, offset=-lbR, title="negatif uyumsuzluk", linewidth=2, color=(bearCond ? bearColor : noneColor), transp=0,  display = display.none)
plotshape(bearCond ? osc[lbR] : na, offset=-lbR, title="negatif uyumsuzluk alanı ", text="nu", style=shape.labeldown, location=location.absolute, color=bearColor, textcolor=textColor, transp=0)

// Hidden Bearish Divergence
oscHH = osc[lbR] > ta.valuewhen(phFound, osc[lbR], 1) and _inRange(phFound[1])
priceLH = high[lbR] < ta.valuewhen(phFound, high[lbR], 1)
hiddenBearCond = plotHiddenBear and priceLH and oscHH and phFound

plot(phFound ? osc[lbR] : na, offset=-lbR, title="gizli negatif uyumsuzluk", linewidth=2, color=(hiddenBearCond ? hiddenBearColor : noneColor), transp=0,  display = display.none)
plotshape(hiddenBearCond ? osc[lbR] : na, offset=-lbR, title="gizli negatif uyumsuzluk alanı", text="gnu", style=shape.labeldown, location=location.absolute, color=bearColor, textcolor=textColor, transp=0)
