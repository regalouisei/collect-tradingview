//@version=6
indicator("RSI Divergence (Clean Pivots) — v1.2", "RSIDiv+", overlay=false, max_bars_back=2000, max_labels_count=300, max_lines_count=300)

//──────── Input Groups ────────//
grp_rsi  = "RSI Settings"
grp_piv  = "Pivot Settings"
grp_div  = "Divergence Logic"
grp_vis  = "Visuals"
grp_ping = "Pings & Alerts"

//──────── Inputs ────────//
// RSI
len      = input.int(9, "RSI Length", minval=2, group=grp_rsi)
src      = input.source(close, "RSI Source", group=grp_rsi)

// Pivots
lbL      = input.int(2, "Pivot Left", minval=1, group=grp_piv)
lbR      = input.int(2, "Pivot Right", minval=1, group=grp_piv)
minBars  = input.int(5, "Min Bars Between Pivots", minval=1, group=grp_piv)
maxBars  = input.int(60, "Max Bars Between Pivots", minval=2, group=grp_piv)

// Divergence filters
showReg  = input.bool(true, "Show Regular Divergences", group=grp_div)
showHid  = input.bool(true, "Show Hidden Divergences", group=grp_div)

// Visual options
showObOs     = input.bool(true, "Show OB / OS Levels", group=grp_vis)
obLevel      = input.float(70.0, "Overbought Level", step=0.1, group=grp_vis)
osLevel      = input.float(30.0, "Oversold Level", step=0.1, group=grp_vis)
midLevel     = input.float(50.0, "Midline Level", step=0.1, group=grp_vis)
rsiLineWidth = input.int(2, "RSI Line Width", minval=1, maxval=4, group=grp_vis)

showLabels   = input.bool(true, "Show Divergence Labels", group=grp_vis)
labelSize    = input.string("tiny", "Label Size", options=["tiny","small","normal","large","huge"], group=grp_vis)

showDivLines = input.bool(true, "Show Divergence Connector Lines", group=grp_vis)
lineWidth    = input.int(2, "Divergence Line Width", minval=1, maxval=5, group=grp_vis)

// Ping / alert options
showPings    = input.bool(true, "Show Tiny Ping Markers", tooltip="Marks when alerts would fire (non-repainting)", group=grp_ping)

//──────── Core RSI ────────//
r = ta.rsi(src, len)

//──────── Confirmed pivots (RSI) ────────//
pl_r = ta.pivotlow(r, lbL, lbR)      // RSI pivot low value (confirmed on current bar)
ph_r = ta.pivothigh(r, lbL, lbR)     // RSI pivot high value (confirmed on current bar)

plFound = not na(pl_r)               // true on the bar the RSI low pivot is confirmed
phFound = not na(ph_r)               // true on the bar the RSI high pivot is confirmed

//──────── Align to TRUE pivot bars + measure distances ────────//
// On the confirmation bar, the true pivot bar index is (bar_index - lbR).

// LOW pivots
currPl_bar   = plFound ? (bar_index - lbR) : na
prevPl_bar   = ta.valuewhen(plFound, (bar_index - lbR), 1)
distPl       = currPl_bar - prevPl_bar

currPl_price = plFound ? low[lbR] : na
prevPl_price = ta.valuewhen(plFound, low[lbR], 1)

currPl_r     = pl_r
prevPl_r     = ta.valuewhen(plFound, pl_r, 1)

okPl         = plFound and not na(prevPl_bar) and not na(prevPl_price) and not na(prevPl_r) and distPl >= minBars and distPl <= maxBars

// HIGH pivots
currPh_bar   = phFound ? (bar_index - lbR) : na
prevPh_bar   = ta.valuewhen(phFound, (bar_index - lbR), 1)
distPh       = currPh_bar - prevPh_bar

currPh_price = phFound ? high[lbR] : na
prevPh_price = ta.valuewhen(phFound, high[lbR], 1)

currPh_r     = ph_r
prevPh_r     = ta.valuewhen(phFound, ph_r, 1)

okPh         = phFound and not na(prevPh_bar) and not na(prevPh_price) and not na(prevPh_r) and distPh >= minBars and distPh <= maxBars

//──────── Divergence Logic (aligned, non-repainting) ────────//
// Regular Bullish: price LL, RSI HL
bullReg = showReg and okPl and (currPl_price < prevPl_price) and (currPl_r > prevPl_r)
// Hidden Bullish: price HL, RSI LL
bullHid = showHid and okPl and (currPl_price > prevPl_price) and (currPl_r < prevPl_r)
// Regular Bearish: price HH, RSI LH
bearReg = showReg and okPh and (currPh_price > prevPh_price) and (currPh_r < prevPh_r)
// Hidden Bearish: price LH, RSI HH
bearHid = showHid and okPh and (currPh_price < prevPh_price) and (currPh_r > prevPh_r)

//──────── Signals & Alerts (confirmed bar only) ────────//
bool sig_bullReg = bullReg and barstate.isconfirmed
bool sig_bullHid = bullHid and barstate.isconfirmed
bool sig_bearReg = bearReg and barstate.isconfirmed
bool sig_bearHid = bearHid and barstate.isconfirmed
bool sig_anyDiv  = sig_bullReg or sig_bullHid or sig_bearReg or sig_bearHid

alertcondition(sig_bullReg, title="RSI: Bullish Regular", message="RSI Regular Bullish divergence confirmed on {{ticker}} {{interval}} at {{time}}.")
alertcondition(sig_bullHid, title="RSI: Bullish Hidden",  message="RSI Hidden Bullish divergence confirmed on {{ticker}} {{interval}} at {{time}}.")
alertcondition(sig_bearReg, title="RSI: Bearish Regular", message="RSI Regular Bearish divergence confirmed on {{ticker}} {{interval}} at {{time}}.")
alertcondition(sig_bearHid, title="RSI: Bearish Hidden",  message="RSI Hidden Bearish divergence confirmed on {{ticker}} {{interval}} at {{time}}.")
alertcondition(sig_anyDiv,  title="RSI: Any Divergence",  message="RSI divergence (any) confirmed on {{ticker}} {{interval}} at {{time}}.")

//──────── RSI Plot & Levels ────────//
rColor = r > obLevel ? color.new(color.red, 0) : r < osLevel ? color.new(color.lime, 0) : color.new(color.white, 0)
plot(r, "RSI", color=rColor, linewidth=rsiLineWidth)

ob  = hline(obLevel, "OB",  color=color.new(color.red, 70))
os  = hline(osLevel, "OS",  color=color.new(color.lime, 70))
mid = hline(midLevel, "Mid", color=color.new(color.gray, 85))

// fill() must be in global scope, so we control visibility via color
fill(ob, os, showObOs ? color.new(color.purple, 95) : na)

//──────── Labels (non-repainting; on confirmation bar) ────────//
label_size_enum = labelSize == "tiny" ? size.tiny : labelSize == "small" ? size.small : labelSize == "normal" ? size.normal : labelSize == "large" ? size.large : size.huge

if showLabels
    if sig_bullReg
        label.new(currPl_bar, currPl_r, "Bull",   xloc=xloc.bar_index, yloc=yloc.price, style=label.style_label_up,   color=color.lime,                 textcolor=color.black, size=label_size_enum)
    if sig_bullHid
        label.new(currPl_bar, currPl_r, "H Bull", xloc=xloc.bar_index, yloc=yloc.price, style=label.style_label_up,   color=color.new(color.lime, 60),  textcolor=color.black, size=label_size_enum)
    if sig_bearReg
        label.new(currPh_bar, currPh_r, "Bear",   xloc=xloc.bar_index, yloc=yloc.price, style=label.style_label_down, color=color.fuchsia,              textcolor=color.white, size=label_size_enum)
    if sig_bearHid
        label.new(currPh_bar, currPh_r, "H Bear", xloc=xloc.bar_index, yloc=yloc.price, style=label.style_label_down, color=color.new(color.fuchsia,60),textcolor=color.white, size=label_size_enum)

//──────── Divergence Connector Lines (non-repainting) ────────//
if showDivLines
    if sig_bullReg
        line.new(prevPl_bar, prevPl_r, currPl_bar, currPl_r, xloc=xloc.bar_index, extend=extend.none, color=color.lime,                 width=lineWidth)
    if sig_bullHid
        line.new(prevPl_bar, prevPl_r, currPl_bar, currPl_r, xloc=xloc.bar_index, extend=extend.none, color=color.new(color.lime, 60), width=lineWidth)
    if sig_bearReg
        line.new(prevPh_bar, prevPh_r, currPh_bar, currPh_r, xloc=xloc.bar_index, extend=extend.none, color=color.fuchsia,             width=lineWidth)
    if sig_bearHid
        line.new(prevPh_bar, prevPh_r, currPh_bar, currPh_r, xloc=xloc.bar_index, extend=extend.none, color=color.new(color.fuchsia,60), width=lineWidth)

//──────── Optional tiny ping markers (bottom/top of panel) ────────//
dispPings = showPings ? display.all : display.none

plotshape(sig_bullReg, title="Bull Reg ping",  style=shape.triangleup,   size=size.tiny, location=location.bottom, color=color.new(color.lime, 0),     offset=0, display=dispPings)
plotshape(sig_bullHid, title="Bull Hid ping",  style=shape.triangleup,   size=size.tiny, location=location.bottom, color=color.new(color.lime, 60),    offset=0, display=dispPings)
plotshape(sig_bearReg, title="Bear Reg ping",  style=shape.triangledown, size=size.tiny, location=location.top,    color=color.new(color.fuchsia, 0),  offset=0, display=dispPings)
plotshape(sig_bearHid, title="Bear Hid ping",  style=shape.triangledown, size=size.tiny, location=location.top,    color=color.new(color.fuchsia, 60), offset=0, display=dispPings)
