//@version=6
indicator("ATH Dip Levels - Buy on Dips", overlay=true, max_labels_count=500)

// ============================================================================
// INPUT PARAMETERS
// ============================================================================
lookbackPeriod = input.int(220, "ATH Lookback Period", 
     minval=50, maxval=500, 
     tooltip="Number of bars for calculating rolling All-Time High")

showLevelLines = input.bool(true, "Show Target Level Lines", group="Visual Settings")
showLabels = input.bool(true, "Show Buy Labels", group="Visual Settings")

// Individual level toggles
enable3pct  = input.bool(true, "Show 3% Level", group="Levels")
enable5pct  = input.bool(true, "Show 5% Level", group="Levels")
enable10pct = input.bool(true, "Show 10% Level", group="Levels")
enable15pct = input.bool(true, "Show 15% Level", group="Levels")
enable25pct = input.bool(true, "Show 25% Level", group="Levels")
enable35pct = input.bool(true, "Show 35% Level", group="Levels")
enable50pct = input.bool(true, "Show 50% Level", group="Levels")

// ============================================================================
// CALCULATE ATH AND DETECT NEW HIGHS
// ============================================================================
// Current 220-bar ATH
ath = ta.highest(high, lookbackPeriod)

// Previous bar's ATH for comparison
prevATH = ath[1]

// Detect when ATH increases (new high formed)
newATH = ath > prevATH and not na(prevATH)

// Plot the ATH line
plot(ath, "220-Bar ATH", 
     color=color.new(#2962FF, 0), 
     linewidth=3, 
     style=plot.style_line)

// ============================================================================
// CALCULATE DIP PRICE LEVELS
// ============================================================================
level3pct  = ath * 0.97  // 3% below ATH
level5pct  = ath * 0.95  // 5% below ATH
level10pct = ath * 0.90  // 10% below ATH
level15pct = ath * 0.85  // 15% below ATH
level25pct = ath * 0.75  // 25% below ATH
level35pct = ath * 0.65  // 35% below ATH
level50pct = ath * 0.50  // 50% below ATH

// ============================================================================
// VISUAL LEVEL LINES - DYNAMIC TARGET ZONES
// ============================================================================
// Plot horizontal lines for each dip level (subtle, professional look)

plot(showLevelLines and enable3pct ? level3pct : na, 
     "3% Level", 
     color=color.new(#4CAF50, 70), 
     linewidth=1, 
     style=plot.style_stepline)

plot(showLevelLines and enable5pct ? level5pct : na, 
     "5% Level", 
     color=color.new(#4CAF50, 65), 
     linewidth=1, 
     style=plot.style_stepline)

plot(showLevelLines and enable10pct ? level10pct : na, 
     "10% Level", 
     color=color.new(#8BC34A, 60), 
     linewidth=2, 
     style=plot.style_stepline)

plot(showLevelLines and enable15pct ? level15pct : na, 
     "15% Level", 
     color=color.new(#CDDC39, 60), 
     linewidth=2, 
     style=plot.style_stepline)

plot(showLevelLines and enable25pct ? level25pct : na, 
     "25% Level", 
     color=color.new(#FF9800, 55), 
     linewidth=2, 
     style=plot.style_stepline)

plot(showLevelLines and enable35pct ? level35pct : na, 
     "35% Level", 
     color=color.new(#FF5722, 50), 
     linewidth=2, 
     style=plot.style_stepline)

plot(showLevelLines and enable50pct ? level50pct : na, 
     "50% Level", 
     color=color.new(#F44336, 45), 
     linewidth=3, 
     style=plot.style_stepline)

// ============================================================================
// ONE-TIME TRIGGER STATE MANAGEMENT
// ============================================================================
// Track whether each level has been hit in the current ATH cycle
// These flags reset when a new ATH is formed

var bool hit3pct  = false
var bool hit5pct  = false
var bool hit10pct = false
var bool hit15pct = false
var bool hit25pct = false
var bool hit35pct = false
var bool hit50pct = false

// Reset all hit flags when new ATH is reached
if newATH
    hit3pct  := false
    hit5pct  := false
    hit10pct := false
    hit15pct := false
    hit25pct := false
    hit35pct := false
    hit50pct := false

// ============================================================================
// DETECT LEVEL HITS
// ============================================================================
// A level is "hit" when price touches/crosses it AND it hasn't been hit yet

hitNow3pct  = enable3pct  and not hit3pct  and low <= level3pct
hitNow5pct  = enable5pct  and not hit5pct  and low <= level5pct
hitNow10pct = enable10pct and not hit10pct and low <= level10pct
hitNow15pct = enable15pct and not hit15pct and low <= level15pct
hitNow25pct = enable25pct and not hit25pct and low <= level25pct
hitNow35pct = enable35pct and not hit35pct and low <= level35pct
hitNow50pct = enable50pct and not hit50pct and low <= level50pct

// ============================================================================
// CREATE LABELS AT EXACT PRICE LEVELS
// ============================================================================
// Labels appear only once per level per ATH cycle

// 3% Dip Label
if showLabels and hitNow3pct
    label.new(bar_index, level3pct, "BUY 3%", 
         style=label.style_label_left, 
         color=color.new(#4CAF50, 0), 
         textcolor=color.white, 
         size=size.small,
         textalign=text.align_left)
    hit3pct := true

// 5% Dip Label
if showLabels and hitNow5pct
    label.new(bar_index, level5pct, "BUY 5%", 
         style=label.style_label_left, 
         color=color.new(#4CAF50, 0), 
         textcolor=color.white, 
         size=size.small,
         textalign=text.align_left)
    hit5pct := true

// 10% Dip Label
if showLabels and hitNow10pct
    label.new(bar_index, level10pct, "BUY 10%", 
         style=label.style_label_left, 
         color=color.new(#8BC34A, 0), 
         textcolor=color.white, 
         size=size.normal,
         textalign=text.align_left)
    hit10pct := true

// 15% Dip Label
if showLabels and hitNow15pct
    label.new(bar_index, level15pct, "BUY 15%", 
         style=label.style_label_left, 
         color=color.new(#CDDC39, 0), 
         textcolor=color.black, 
         size=size.normal,
         textalign=text.align_left)
    hit15pct := true

// 25% Dip Label
if showLabels and hitNow25pct
    label.new(bar_index, level25pct, "BUY 25%", 
         style=label.style_label_left, 
         color=color.new(#FF9800, 0), 
         textcolor=color.white, 
         size=size.normal,
         textalign=text.align_left)
    hit25pct := true

// 35% Dip Label
if showLabels and hitNow35pct
    label.new(bar_index, level35pct, "BUY 35%", 
         style=label.style_label_left, 
         color=color.new(#FF5722, 0), 
         textcolor=color.white, 
         size=size.normal,
         textalign=text.align_left)
    hit35pct := true

// 50% Dip Label
if showLabels and hitNow50pct
    label.new(bar_index, level50pct, "BUY 50%", 
         style=label.style_label_left, 
         color=color.new(#F44336, 0), 
         textcolor=color.white, 
         size=size.large,
         textalign=text.align_left)
    hit50pct := true

// ============================================================================
// BACKGROUND HIGHLIGHTING
// ============================================================================
// Subtle background when new ATH is reached (visual reset indicator)
bgcolor(newATH ? color.new(#2962FF, 92) : na, title="New ATH Background")

// ============================================================================
// TABLE - CURRENT STATUS DISPLAY (OPTIONAL)
// ============================================================================
// Display current ATH and percentage from ATH in a table

var table statusTable = table.new(position.top_right, 2, 9, 
     border_width=1, 
     border_color=color.new(color.gray, 50),
     frame_width=1,
     frame_color=color.new(color.gray, 50))

if barstate.islast
    // Header
    table.cell(statusTable, 0, 0, "Level", 
         bgcolor=color.new(#1E1E1E, 0), 
         text_color=color.white, 
         text_size=size.small)
    table.cell(statusTable, 1, 0, "Status", 
         bgcolor=color.new(#1E1E1E, 0), 
         text_color=color.white, 
         text_size=size.small)
    
    // Current price distance from ATH
    currentDrop = ((ath - close) / ath) * 100
    
    // Rows for each level
    table.cell(statusTable, 0, 1, "ATH", 
         text_color=color.new(color.white, 0), 
         text_size=size.tiny)
    table.cell(statusTable, 1, 1, str.tostring(ath, format.mintick), 
         text_color=color.new(#2962FF, 0), 
         text_size=size.tiny)
    
    table.cell(statusTable, 0, 2, "3%", 
         text_color=color.new(color.white, 0), 
         text_size=size.tiny)
    table.cell(statusTable, 1, 2, hit3pct ? "✓ Hit" : "—", 
         text_color=hit3pct ? color.new(#4CAF50, 0) : color.new(color.gray, 0), 
         text_size=size.tiny)
    
    table.cell(statusTable, 0, 3, "5%", 
         text_color=color.new(color.white, 0), 
         text_size=size.tiny)
    table.cell(statusTable, 1, 3, hit5pct ? "✓ Hit" : "—", 
         text_color=hit5pct ? color.new(#4CAF50, 0) : color.new(color.gray, 0), 
         text_size=size.tiny)
    
    table.cell(statusTable, 0, 4, "10%", 
         text_color=color.new(color.white, 0), 
         text_size=size.tiny)
    table.cell(statusTable, 1, 4, hit10pct ? "✓ Hit" : "—", 
         text_color=hit10pct ? color.new(#8BC34A, 0) : color.new(color.gray, 0), 
         text_size=size.tiny)
    
    table.cell(statusTable, 0, 5, "15%", 
         text_color=color.new(color.white, 0), 
         text_size=size.tiny)
    table.cell(statusTable, 1, 5, hit15pct ? "✓ Hit" : "—", 
         text_color=hit15pct ? color.new(#CDDC39, 0) : color.new(color.gray, 0), 
         text_size=size.tiny)
    
    table.cell(statusTable, 0, 6, "25%", 
         text_color=color.new(color.white, 0), 
         text_size=size.tiny)
    table.cell(statusTable, 1, 6, hit25pct ? "✓ Hit" : "—", 
         text_color=hit25pct ? color.new(#FF9800, 0) : color.new(color.gray, 0), 
         text_size=size.tiny)
    
    table.cell(statusTable, 0, 7, "35%", 
         text_color=color.new(color.white, 0), 
         text_size=size.tiny)
    table.cell(statusTable, 1, 7, hit35pct ? "✓ Hit" : "—", 
         text_color=hit35pct ? color.new(#FF5722, 0) : color.new(color.gray, 0), 
         text_size=size.tiny)
    
    table.cell(statusTable, 0, 8, "50%", 
         text_color=color.new(color.white, 0), 
         text_size=size.tiny)
    table.cell(statusTable, 1, 8, hit50pct ? "✓ Hit" : "—", 
         text_color=hit50pct ? color.new(#F44336, 0) : color.new(color.gray, 0), 
         text_size=size.tiny)

// ============================================================================
// ALERT CONDITIONS
// ============================================================================
alertcondition(hitNow3pct, "3% Level Hit", "Price touched 3% dip level")
alertcondition(hitNow5pct, "5% Level Hit", "Price touched 5% dip level")
alertcondition(hitNow10pct, "10% Level Hit", "Price touched 10% dip level")
alertcondition(hitNow15pct, "15% Level Hit", "Price touched 15% dip level")
alertcondition(hitNow25pct, "25% Level Hit", "Price touched 25% dip level")
alertcondition(hitNow35pct, "35% Level Hit", "Price touched 35% dip level")
alertcondition(hitNow50pct, "50% Level Hit", "Price touched 50% dip level")
alertcondition(newATH, "New ATH Formed", "New 220-bar ATH - all levels reset")
