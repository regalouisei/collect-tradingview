//@version=6
indicator("Bull vs Bear Volume(Simplified)", shorttitle="BvB Volume Simp", overlay=false)

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// ① USER INPUTS
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
sumPrd      = input.int(20, "Sum period", minval=1)
smoothPrd   = input.int(5,  "Smooth period", minval=1)

// Line Colors
bullLineColor    = input.color(color.lime, "Bull Line Color")
bearLineColor    = input.color(color.red,  "Bear Line Color")
neutralLineColor = input.color(color.gray, "Neutral Line Color")

// Fill Colors
bullFillColor    = input.color(color.new(color.lime, 80), "Bull Fill Color")
bearFillColor    = input.color(color.new(color.red, 80),  "Bear Fill Color")
neutralFillColor = input.color(color.new(color.gray, 80), "Neutral Fill Color")

// Transparency(0..100)
fillTranspPct   = input.int(60, "Base Fill Transparency (0 opaque)", minval=0, maxval=100)
lineTranspPct   = input.int(0,  "Line Transparency (0 opaque)", minval=0, maxval=100)
rippleIntensityPct = input.int(40, "Ripple Brightness (0 opaque)", minval=0, maxval=100)

// Line appearance
lineWidth       = input.int(2, "Line Width", minval=1, maxval=5)
lineStyleChoice = input.string("Line", "Line Style", options = ["Line", "Stepline", "Histogram"])

// Ripple / highlight parameters
showRipple      = input.bool(true, "Show Ripple on Cross")
rippleBars      = input.int(3, "Ripple Duration (bars)", minval=1, maxval=10)

// Cross markers
showCrossMarks  = input.bool(true, "Show Cross Markers")


//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// ② CALCULATION: Bull / Bear Volume
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
bullV = close > open ? volume : 0.0
bearV = close < open ? volume : 0.0

// ta.sum()을 사용하여 누적합을 간결하게 계산
cumBull = ta.cum(bullV)
cumVol     = ta.cum(volume)
hasHistory = not na(cumVol[sumPrd])
sumBull     = hasHistory ? (cumBull - cumBull[sumPrd]) : 0.0
sumTotal = hasHistory ? (cumVol     - cumVol[sumPrd])     : 0.0

ratioBull = sumTotal > 0 ? (sumBull / sumTotal) * 100.0 : 0.0
ratioBear = sumTotal > 0 ? ((sumTotal - sumBull) / sumTotal) * 100.0 : 0.0

eRatioBull = ta.ema(ratioBull, smoothPrd)
eRatioBear = ta.ema(ratioBear, smoothPrd)

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// ③ STYLE MAPPING
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
plotStyle = lineStyleChoice == "Line" ? plot.style_line : (lineStyleChoice == "Stepline" ? plot.style_stepline : plot.style_histogram)

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// ④ DYNAMIC COLORS
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
bullIsAbove = eRatioBull > eRatioBear
bearIsAbove = eRatioBear > eRatioBull

// 투명도 적용
bullLineNow = color.new(bullIsAbove ? bullLineColor : neutralLineColor, lineTranspPct)
bearLineNow = color.new(bearIsAbove ? bearLineColor : neutralLineColor, lineTranspPct)

// Base Fill Color
baseFillColorNow = bullIsAbove ? color.new(bullFillColor, fillTranspPct) : 
                   bearIsAbove ? color.new(bearFillColor, fillTranspPct) : 
                                 color.new(neutralFillColor, fillTranspPct)

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// ⑤ RIPPLE / HIGHLIGHT
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
crossUp   = ta.crossover(eRatioBull, eRatioBear)
crossDown = ta.crossunder(eRatioBull, eRatioBear)
var int rippleCounter = 0

if showRipple
    if crossUp or crossDown
        rippleCounter := rippleBars
    else
        rippleCounter := math.max(rippleCounter - 1, 0)
else
    rippleCounter := 0

rippleActive = rippleCounter > 0

finalFillColor = rippleActive ? color.new(color.white, rippleIntensityPct) : baseFillColorNow

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// ⑥ PLOT & FILL
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
pBull = plot(eRatioBull, title="Bull Volume", color=bullLineNow, style=plotStyle, linewidth=lineWidth)
pBear = plot(eRatioBear, title="Bear Volume", color=bearLineNow, style=plotStyle, linewidth=lineWidth)

fill(pBull, pBear, color=finalFillColor, title="Bull vs Bear Fill")

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// ⑦ CROSS MARKERS (plotshape으로 복귀, 절대 위치 사용)
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
plotshape(showCrossMarks and crossUp,

     title="Bull Cross Up",

     location=location.top,

     style=shape.triangleup,

     size=size.tiny,

     color=bullLineColor)



plotshape(showCrossMarks and crossDown,

     title="Bear Cross Down",

     location=location.bottom,

     style=shape.triangledown,

     size=size.tiny,

     color=bearLineColor)

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// ⑧ LAST BAR LABEL
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
if barstate.islast
    var label lb = na
    label.delete(lb)
    lb := label.new(
         bar_index, 
         math.max(eRatioBull, eRatioBear) * 1.01,
         text = "B: " + str.tostring(eRatioBull, format.percent) + "\nA: " + str.tostring(eRatioBear, format.percent),
         style = label.style_label_left, 
         color=color.new(color.black, 90), 
         textcolor=color.white, 
         yloc=yloc.price
         )
