//@version=5
indicator("In The Zone RSI – 12-Band Spectrum", shorttitle="IZ RSI 12 Bands", overlay = true)

// ========= Core inputs =========
src           = input.source(close, "RSI Source")
len           = input.int(14, "RSI Length", minval = 1)
htfTf         = input.timeframe("15", "Higher Timeframe (for RSI coloring)")
confirmedOnly = input.bool(true, "Use CLOSED HTF bars (no repaint)")
brightness    = input.int(0, "Color Brightness (−dark … +bright)", minval = -70, maxval = 70)

// Visual mode
bordersOnly   = input.bool(false, "Borders-only mode")
fillOpacity   = input.int(100, "Fill opacity (0–100)", minval = 0, maxval = 100)

// ========= Arrows =========
showArrows   = input.bool(true, "Show RSI Band-Change Arrows")
arrowSizeStr = input.string("Normal", "Arrow Size",
                 options = ["Tiny", "Small", "Normal", "Large", "Huge"])
arrowUpColor = input.color(color.lime, "Arrow Up Color")
arrowDnColor = input.color(color.red,  "Arrow Down Color")

// ========= Alerts =========
enableAlerts  = input.bool(true, "Enable Alerts")
alertLevel    = input.int(4, "Alert when |level| ≥", minval = 1, maxval = 6)

// ========= Legend =========
showLegend    = input.bool(true, "Show Vertical Legend")
legendCorner  = input.string("Top Left", "Legend Position",
                   options = ["Top Left", "Top Right", "Bottom Left", "Bottom Right"])
showRanges    = input.bool(true, "Show RSI Range Labels (Legend)")

// ========= Custom RSI cutoffs (12 bands) =========
// Weak side (<50)
W1 = input.float(10, "Weak cutoff W1 (≤ → band −6)", step = 0.1, minval = 0,  maxval = 50)
W2 = input.float(20, "Weak cutoff W2 (≤ → band −5)", step = 0.1, minval = 0,  maxval = 50)
W3 = input.float(30, "Weak cutoff W3 (≤ → band −4)", step = 0.1, minval = 0,  maxval = 50)
W4 = input.float(37, "Weak cutoff W4 (≤ → band −3)", step = 0.1, minval = 0,  maxval = 50)
W5 = input.float(44, "Weak cutoff W5 (≤ → band −2)", step = 0.1, minval = 0,  maxval = 50)
W6 = input.float(49, "Weak cutoff W6 (≤ → band −1)", step = 0.1, minval = 0,  maxval = 50)

// Strong side (>50)
S1 = input.float(55, "Strong cutoff S1 (≤ → band +1)", step = 0.1, minval = 50, maxval = 100)
S2 = input.float(60, "Strong cutoff S2 (≤ → band +2)", step = 0.1, minval = 50, maxval = 100)
S3 = input.float(70, "Strong cutoff S3 (≤ → band +3)", step = 0.1, minval = 50, maxval = 100)
S4 = input.float(80, "Strong cutoff S4 (≤ → band +4)", step = 0.1, minval = 50, maxval = 100)
S5 = input.float(90, "Strong cutoff S5 (≤ → band +5)", step = 0.1, minval = 50, maxval = 100)
S6 = input.float(96, "Strong cutoff S6 (≤ → band +6)", step = 0.1, minval = 50, maxval = 100)

// ========= HTF RSI =========
look      = confirmedOnly ? barmerge.lookahead_off : barmerge.lookahead_on
htfRsiRaw = request.security(syminfo.tickerid, htfTf, ta.rsi(src, len),
                             barmerge.gaps_off, look)

// ========= Helpers =========
clamp(v, lo, hi) => math.min(math.max(v, lo), hi)
fmt1(x)          => str.tostring(math.round(x * 10) / 10)

sortClamp6(a1, a2, a3, a4, a5, a6, lo, hi) =>
    arr = array.new_float(6)
    array.set(arr, 0, clamp(a1, lo, hi))
    array.set(arr, 1, clamp(a2, lo, hi))
    array.set(arr, 2, clamp(a3, lo, hi))
    array.set(arr, 3, clamp(a4, lo, hi))
    array.set(arr, 4, clamp(a5, lo, hi))
    array.set(arr, 5, clamp(a6, lo, hi))
    array.sort(arr, order.ascending)
    arr

weakCuts   = sortClamp6(W1, W2, W3, W4, W5, W6, 0, 50)
strongCuts = sortClamp6(S1, S2, S3, S4, S5, S6, 50, 100)

// Map RSI → band level (−6..−1, +1..+6; 0 unused)
level_by_custom(r) =>
    if r <= array.get(weakCuts, 0)
        -6
    else if r <= array.get(weakCuts, 1)
        -5
    else if r <= array.get(weakCuts, 2)
        -4
    else if r <= array.get(weakCuts, 3)
        -3
    else if r <= array.get(weakCuts, 4)
        -2
    else if r <= array.get(weakCuts, 5) or r <= 50
        -1
    else if r <= array.get(strongCuts, 0)
        1
    else if r <= array.get(strongCuts, 1)
        2
    else if r <= array.get(strongCuts, 2)
        3
    else if r <= array.get(strongCuts, 3)
        4
    else if r <= array.get(strongCuts, 4)
        5
    else
        6

lvl = level_by_custom(htfRsiRaw)

// ========= Palettes =========
// Weak side: −1 light blue → −6 black
var bearCols = array.new_color()
if barstate.isfirst
    array.push(bearCols, color.new(#000000, 0))  // index 0 → −6
    array.push(bearCols, color.new(#4A148C, 0))  // −5 dark purple
    array.push(bearCols, color.new(#9C27B0, 0))  // −4 purple
    array.push(bearCols, color.new(#1E88E5, 0))  // −3 dark blue
    array.push(bearCols, color.new(#64B5F6, 0))  // −2 mid blue
    array.push(bearCols, color.new(#B3E5FF, 0))  // −1 light blue

// Strong side: +1 yellow → +6 black
var bullCols = array.new_color()
if barstate.isfirst
    array.push(bullCols, color.new(#FFEB3B, 0))  // +1 yellow
    array.push(bullCols, color.new(#FF9800, 0))  // +2 orange
    array.push(bullCols, color.new(#FF7043, 0))  // +3 orange-red
    array.push(bullCols, color.new(#FF5252, 0))  // +4 light red
    array.push(bullCols, color.new(#7F0000, 0))  // +5 maroon
    array.push(bullCols, color.new(#000000, 0))  // +6 black

// Brightness adjuster
adjust(c, off) =>
    color.rgb(
      clamp(color.r(c) + off, 0, 255),
      clamp(color.g(c) + off, 0, 255),
      clamp(color.b(c) + off, 0, 255))

color_for_level(l) =>
    if l > 0
        adjust(array.get(bullCols, l - 1), brightness)
    else if l < 0
        adjust(array.get(bearCols, 6 + l), brightness) // 6 + (−6..−1) → 0..5
    else
        na

// ========= Candle colouring =========
fillCol            = color_for_level(lvl)
fillColWithOpacity = color.new(fillCol, 100 - fillOpacity)

// Colour the main candle bodies
barcolor(bordersOnly ? na : fillColWithOpacity)

// Optional coloured borders via overlay
borderOverlay = bordersOnly ? fillColWithOpacity : na
plotcandle(open, high, low, close,
           color = na, wickcolor = na, bordercolor = borderOverlay)

// ========= Band-change arrows (pure above/below-bar, no prices) =========
rsiUp   = lvl > lvl[1]
rsiDown = lvl < lvl[1]

// Booleans only – cannot float independently of the bar
upTiny   = showArrows and rsiUp   and arrowSizeStr == "Tiny"
upSmall  = showArrows and rsiUp   and arrowSizeStr == "Small"
upNormal = showArrows and rsiUp   and arrowSizeStr == "Normal"
upLarge  = showArrows and rsiUp   and arrowSizeStr == "Large"
upHuge   = showArrows and rsiUp   and arrowSizeStr == "Huge"

dnTiny   = showArrows and rsiDown and arrowSizeStr == "Tiny"
dnSmall  = showArrows and rsiDown and arrowSizeStr == "Small"
dnNormal = showArrows and rsiDown and arrowSizeStr == "Normal"
dnLarge  = showArrows and rsiDown and arrowSizeStr == "Large"
dnHuge   = showArrows and rsiDown and arrowSizeStr == "Huge"

plotshape(upTiny,   title="RSI Stronger (Tiny)"  , style=shape.triangleup,   location=location.abovebar, size=size.tiny,   color=arrowUpColor)
plotshape(upSmall,  title="RSI Stronger (Small)" , style=shape.triangleup,   location=location.abovebar, size=size.small,  color=arrowUpColor)
plotshape(upNormal, title="RSI Stronger (Normal)", style=shape.triangleup,   location=location.abovebar, size=size.normal, color=arrowUpColor)
plotshape(upLarge,  title="RSI Stronger (Large)" , style=shape.triangleup,   location=location.abovebar, size=size.large,  color=arrowUpColor)
plotshape(upHuge,   title="RSI Stronger (Huge)"  , style=shape.triangleup,   location=location.abovebar, size=size.huge,   color=arrowUpColor)

plotshape(dnTiny,   title="RSI Weaker (Tiny)"    , style=shape.triangledown, location=location.belowbar, size=size.tiny,   color=arrowDnColor)
plotshape(dnSmall,  title="RSI Weaker (Small)"   , style=shape.triangledown, location=location.belowbar, size=size.small,  color=arrowDnColor)
plotshape(dnNormal, title="RSI Weaker (Normal)"  , style=shape.triangledown, location=location.belowbar, size=size.normal, color=arrowDnColor)
plotshape(dnLarge,  title="RSI Weaker (Large)"   , style=shape.triangledown, location=location.belowbar, size=size.large,  color=arrowDnColor)
plotshape(dnHuge,   title="RSI Weaker (Huge)"    , style=shape.triangledown, location=location.belowbar, size=size.huge,   color=arrowDnColor)

// ========= Alerts =========
bullAlert = lvl >= alertLevel
bearAlert = lvl <= -alertLevel

alertcondition(enableAlerts and bullAlert,
     title   = "Strong Bull RSI",
     message = "HTF RSI ≥ +threshold band")

alertcondition(enableAlerts and bearAlert,
     title   = "Strong Bear RSI",
     message = "HTF RSI ≤ −threshold band")

// ========= Legend =========
posFromStr(s) =>
    if s == "Top Left"
        position.top_left
    else if s == "Top Right"
        position.top_right
    else if s == "Bottom Left"
        position.bottom_left
    else if s == "Bottom Right"
        position.bottom_right
    else
        position.top_left

var table vLeg = na
if barstate.isfirst
    vLeg := table.new(posFromStr(legendCorner), 14, 3, border_width = 1)

// Build / refresh legend every bar
if showLegend
    // Header
    table.cell(vLeg, 0, 0, "RSI Bands",
               text_color = color.white,
               bgcolor    = color.new(color.gray, 25))

    // Labels −6..−1
    for i = 0 to 5
        table.cell(vLeg, 1 + i, 0,
                   "-" + str.tostring(6 - i),
                   text_color = color.white,
                   bgcolor    = color.new(color.gray, 80))

    // Gap
    table.cell(vLeg, 7, 0, "", bgcolor = na)

    // Labels +1..+6
    for i = 1 to 6
        table.cell(vLeg, 7 + i, 0,
                   "+" + str.tostring(i),
                   text_color = color.white,
                   bgcolor    = color.new(color.gray, 80))

    // Swatches row (colours)
    for i = 0 to 5
        table.cell(vLeg, 1 + i, 1, "", bgcolor = color_for_level(-(6 - i)))
    for i = 1 to 6
        table.cell(vLeg, 7 + i, 1, "", bgcolor = color_for_level(i))

    if showRanges
        // Weak side ranges
        w1 = array.get(weakCuts, 0)
        w2 = array.get(weakCuts, 1)
        w3 = array.get(weakCuts, 2)
        w4 = array.get(weakCuts, 3)
        w5 = array.get(weakCuts, 4)
        w6 = array.get(weakCuts, 5)

        table.cell(vLeg, 1,  2, "≤ " + fmt1(w1),              text_color = color.white, bgcolor = color.new(color.black, 85))
        table.cell(vLeg, 2,  2, fmt1(w1) + "–" + fmt1(w2),    text_color = color.white, bgcolor = color.new(color.black, 85))
        table.cell(vLeg, 3,  2, fmt1(w2) + "–" + fmt1(w3),    text_color = color.white, bgcolor = color.new(color.black, 85))
        table.cell(vLeg, 4,  2, fmt1(w3) + "–" + fmt1(w4),    text_color = color.white, bgcolor = color.new(color.black, 85))
        table.cell(vLeg, 5,  2, fmt1(w4) + "–" + fmt1(w5),    text_color = color.white, bgcolor = color.new(color.black, 85))
        table.cell(vLeg, 6,  2, fmt1(w5) + "–50",             text_color = color.white, bgcolor = color.new(color.black, 85))

        // Strong side ranges
        s1 = array.get(strongCuts, 0)
        s2 = array.get(strongCuts, 1)
        s3 = array.get(strongCuts, 2)
        s4 = array.get(strongCuts, 3)
        s5 = array.get(strongCuts, 4)
        s6 = array.get(strongCuts, 5)

        table.cell(vLeg, 8,  2, "50–" + fmt1(s1),             text_color = color.white, bgcolor = color.new(color.black, 85))
        table.cell(vLeg, 9,  2, fmt1(s1) + "–" + fmt1(s2),    text_color = color.white, bgcolor = color.new(color.black, 85))
        table.cell(vLeg, 10, 2, fmt1(s2) + "–" + fmt1(s3),    text_color = color.white, bgcolor = color.new(color.black, 85))
        table.cell(vLeg, 11, 2, fmt1(s3) + "–" + fmt1(s4),    text_color = color.white, bgcolor = color.new(color.black, 85))
        table.cell(vLeg, 12, 2, fmt1(s4) + "–" + fmt1(s5),    text_color = color.white, bgcolor = color.new(color.black, 85))
        table.cell(vLeg, 13, 2, "≥ " + fmt1(s6),              text_color = color.white, bgcolor = color.new(color.black, 85))

// Dummy plot to keep editor happy
plot(na)
