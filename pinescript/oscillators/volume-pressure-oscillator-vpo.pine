//@version=6
indicator("Volume Pressure Oscillator (VPO) — Stable v6", shorttitle="VPO+", overlay=false, precision=2)

//===========================
// Inputs
//===========================
len = input.int(20, "VPM Smoothing Length", minval=1)
normLen = input.int(200, "Normalization Lookback", minval=10)
left = input.int(3, "Pivot Left", minval=1)
right = input.int(3, "Pivot Right", minval=1)
smoothType = input.string("EMA", "Smoothing Type", options=["SMA", "EMA", "RMA"])
showDiv = input.bool(true, "Show Divergences")
zoneHigh = input.int(30, "Upper Zone", minval=1)
zoneLow = input.int(-30, "Lower Zone", maxval=-1)
plotHistogram = input.bool(false, "Plot histogram instead of line")

//===========================
// Core Calculations
//===========================
eps = 1e-8
body = close - open
rng = math.max(high - low, eps)
rawVPM = (body / rng) * volume  // Volume Pressure Measure

// Smoothing
smooth(v, l) =>
    if smoothType == "EMA"
        ta.ema(v, l)
    else if smoothType == "RMA"
        ta.rma(v, l)
    else
        ta.sma(v, l)

smVPM = smooth(rawVPM, len)

// Normalize to -100..+100
rollingMin = ta.lowest(smVPM, normLen)
rollingMax = ta.highest(smVPM, normLen)
rangeNorm = math.max(rollingMax - rollingMin, eps)
vpo = 200 * (smVPM - rollingMin) / rangeNorm - 100

//===========================
// Divergence Detection
//===========================
var int prevHighBar = na
var float prevHighPrice = na
var float prevHighVPO = na

var int prevLowBar = na
var float prevLowPrice = na
var float prevLowVPO = na

ph = ta.pivothigh(high, left, right)
pl = ta.pivotlow(low, left, right)

var bool bearDivPending = false
var int bearDivBar = na
var float bearDivPrice = na

var bool bullDivPending = false
var int bullDivBar = na
var float bullDivPrice = na

if not na(ph)
    pivotBar = bar_index - right
    pivotPrice = ph
    pivotVPO = vpo[right]
    if not na(prevHighBar)
        if pivotPrice > prevHighPrice and pivotVPO < prevHighVPO
            bearDivPending := true
            bearDivBar := pivotBar
            bearDivPrice := pivotPrice
    prevHighBar := pivotBar
    prevHighPrice := pivotPrice
    prevHighVPO := pivotVPO

if not na(pl)
    pivotBar = bar_index - right
    pivotPrice = pl
    pivotVPO = vpo[right]
    if not na(prevLowBar)
        if pivotPrice < prevLowPrice and pivotVPO > prevLowVPO
            bullDivPending := true
            bullDivBar := pivotBar
            bullDivPrice := pivotPrice
    prevLowBar := pivotBar
    prevLowPrice := pivotPrice
    prevLowVPO := pivotVPO

plotBearDiv = false
plotBullDiv = false
if bearDivPending
    plotBearDiv := true
    bearDivPending := false
if bullDivPending
    plotBullDiv := true
    bullDivPending := false

//===========================
// Plotting
//===========================
hline(0, title="Zero", color=color.new(color.gray, 75))
hline(zoneHigh, title="Upper Zone", color=color.new(color.green, 80), linestyle=hline.style_dotted)
hline(zoneLow, title="Lower Zone", color=color.new(color.red, 80), linestyle=hline.style_dotted)

vpoColor = vpo > 0 ? color.new(color.lime, 0) : color.new(color.red, 0)

// ✅ One-line global plot (no line breaks)
plot(vpo, title="VPO", style=plotHistogram ? plot.style_histogram : plot.style_line, color=vpoColor, linewidth=plotHistogram ? 1 : 2)

//===========================
// Divergences
//===========================
plotshape(plotBullDiv and showDiv, title="Bullish Divergence", style=shape.triangleup, location=location.belowbar, color=color.new(color.green, 0), size=size.small, offset=-right)
plotshape(plotBearDiv and showDiv, title="Bearish Divergence", style=shape.triangledown, location=location.abovebar, color=color.new(color.red, 0), size=size.small, offset=-right)

if plotBullDiv and showDiv and not na(bullDivBar) and not na(bullDivPrice)
    label.new(bullDivBar, bullDivPrice, "Bull Div", xloc=xloc.bar_index, yloc=yloc.price, style=label.style_label_up, color=color.new(color.green, 0), textcolor=color.white, size=size.small)

if plotBearDiv and showDiv and not na(bearDivBar) and not na(bearDivPrice)
    label.new(bearDivBar, bearDivPrice, "Bear Div", xloc=xloc.bar_index, yloc=yloc.price, style=label.style_label_down, color=color.new(color.red, 0), textcolor=color.white, size=size.small)

//===========================
// Alerts & Info
//===========================
alertcondition(plotBullDiv and showDiv, title="VPO Bullish Divergence", message="VPO bullish divergence detected")
alertcondition(plotBearDiv and showDiv, title="VPO Bearish Divergence", message="VPO bearish divergence detected")

var label info = na
if barstate.islast
    infoText = "VPO: " + str.tostring(vpo, format.mintick)
    if na(info)
        info := label.new(bar_index, high, infoText, xloc=xloc.bar_index, yloc=yloc.price, style=label.style_label_left, color=color.new(color.blue, 90), textcolor=color.white)
    else
        label.set_xy(info, bar_index, high)
        label.set_text(info, infoText)
