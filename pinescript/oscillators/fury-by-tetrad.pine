//@version=6
// -------------------------------------------------------------
// Fury by Tetrad — Ultra Glow
//
// DISCLAIMER:
// This strategy is provided for educational and research purposes.
// It is not investment advice. Trading involves risk. Past performance
// does not guarantee future results. © Tetrad Protocol. All rights reserved.
// -------------------------------------------------------------
strategy("Fury by Tetrad — Ultra Glow",
     overlay=true,
     initial_capital=100,
     commission_type=strategy.commission.percent,
     commission_value=0.05,
     slippage=3,
     default_qty_type=strategy.percent_of_equity,
     default_qty_value=100,
     pyramiding=0,
     calc_on_every_tick=true)

// ---------------------------
// USER INPUTS
// ---------------------------
bbLength       = input.int(205, "Bollinger Length", minval=1)
bbMult         = input.float(2.2, "Bollinger Multiplier", step=0.1)
rsiLen         = input.int(23, "RSI Length", minval=1)

// RSI thresholds
longRsiThreshold  = input.float(28.3, "Long RSI Entry Threshold",  step=0.1)
shortRsiThreshold = input.float(88.4, "Short RSI Entry Threshold", step=0.1)

// Profit target multipliers (entry x multiplier = exit price)
longExitMult  = input.float(1.14, "Long Exit Multiplier",  step=0.01)
shortExitMult = input.float(0.915, "Short Exit Multiplier", step=0.01)

// Stop Loss Inputs (price-based factors)
stopLossEnabled = input.bool(false, "Stop Loss")
longStopFactor  = input.float(0.73, "Long Stop Factor",  step=0.01)
shortStopFactor = input.float(1.05, "Short Stop Factor", step=0.01)

// Time-based Stop Inputs
timeStopEnabled = input.bool(false, "Time Based Stop")
timeStopDays    = input.int(2, "Time Stop Days", minval=1)

// Market Direction Input
marketDirection = input.string("Market Neutral", "Market Direction", options=["Market Neutral", "Long Only", "Short Only"])

// ---------------------------
// INDICATOR CALCULATIONS
// ---------------------------
basis = ta.sma(close, bbLength)
dev   = bbMult * ta.stdev(close, bbLength)
upper = basis + dev
lower = basis - dev

// RSI
rsiValue = ta.rsi(close, rsiLen)

// ---------------------------
// ENTRY CONDITIONS
// ---------------------------
longCondition  = (close < lower) and (rsiValue < longRsiThreshold)
shortCondition = (close > upper) and (rsiValue > shortRsiThreshold)

// ---------------------------
// EXIT PRICE TARGETS
// ---------------------------
longExitPrice  = strategy.position_avg_price * longExitMult
shortExitPrice = strategy.position_avg_price * shortExitMult

// ---------------------------
// TIME-BASED STOP TRACKING (OPTIONAL)
// ---------------------------
var float entryTime = na
if strategy.position_size != 0 and strategy.position_size[1] == 0
    entryTime := time
if strategy.position_size == 0 and strategy.position_size[1] != 0
    entryTime := na

// ---------------------------
// ENTRY EXECUTION
// ---------------------------
if (marketDirection == "Market Neutral" or marketDirection == "Long Only") and longCondition
    strategy.entry("Long", strategy.long)
if (marketDirection == "Market Neutral" or marketDirection == "Short Only") and shortCondition
    strategy.entry("Short", strategy.short)

// ---------------------------
// STOPS AND PROFIT EXITS
// ---------------------------
if strategy.position_size > 0
    if stopLossEnabled
        stopLong = strategy.position_avg_price * longStopFactor
        strategy.exit("Long Stop", from_entry="Long", stop=stopLong)
    if close >= longExitPrice
        strategy.close("Long")

if strategy.position_size < 0
    if stopLossEnabled
        stopShort = strategy.position_avg_price * shortStopFactor
        strategy.exit("Short Stop", from_entry="Short", stop=stopShort)
    if close <= shortExitPrice
        strategy.close("Short")

// ---------------------------
// TETRAD VISUALS (thinnest lines)
// ---------------------------
groupGlow       = "Tetrad Visuals"
ultraGlowOn     = input.bool(true,  "Ultra Glow Mode", group=groupGlow)
tintBarsLight   = input.bool(false, "Subtle Bar Tint by Regime", group=groupGlow)
showTradeLabels = input.bool(true,  "Show Trade Labels", group=groupGlow)
showRegimeBox   = input.bool(true,  "Show Market Regime Box (Top-Right)", group=groupGlow)

// Palette
cBlue    = color.rgb(0, 159, 253)
cPink    = color.rgb(255, 0, 153)
cPurple  = color.rgb(162, 0, 255)
cWhite   = color.white
cOnyx    = color.rgb(6, 10, 18)

// Helpers
clamp(v, lo, hi) =>
    math.max(lo, math.min(hi, v))

volRatio = clamp((upper - lower) / nz(basis, close), 0.01, 0.20)
alphaAdj = math.round(clamp((0.06 - volRatio) * 500.0, -20.0, 20.0))

dynAlpha(base) =>
    clamp(base + alphaAdj, 0, 100)

glow(base, baseAlpha, offAlpha) =>
    color.new(base, ultraGlowOn ? dynAlpha(baseAlpha) : offAlpha)

f_row(tbl, row, name, active, baseColor) =>
    leftBg  = active ? color.new(baseColor, 75) : color.new(cOnyx, 0)
    rightBg = active ? color.new(baseColor, 55) : color.new(cOnyx, 0)
    table.cell(tbl, 0, row, name,                   text_color=color.white, bgcolor=leftBg,  text_halign=text.align_left)
    table.cell(tbl, 1, row, active ? "ACTIVE" : "", text_color=color.white, bgcolor=rightBg, text_halign=text.align_right)

// Ultra Glow Bollinger (all linewidth=1)
pU4 = plot(upper, "Upper Glow 4", color=glow(cPink,   85, 100), linewidth=1)
pU3 = plot(upper, "Upper Glow 3", color=glow(cPink,   72, 100), linewidth=1)
pU2 = plot(upper, "Upper Glow 2", color=glow(cPink,   52, 100), linewidth=1)
pU1 = plot(upper, "Upper Glow 1", color=glow(cPink,   32, 100), linewidth=1)

pB4 = plot(basis, "Basis Glow 4", color=glow(cPurple, 85, 100), linewidth=1)
pB3 = plot(basis, "Basis Glow 3", color=glow(cPurple, 68, 100), linewidth=1)
pB2 = plot(basis, "Basis Glow 2", color=glow(cPurple, 48, 100), linewidth=1)
pB1 = plot(basis, "Basis Glow 1", color=glow(cPurple, 24, 100), linewidth=1)

pL4 = plot(lower, "Lower Glow 4", color=glow(cBlue,   85, 100), linewidth=1)
pL3 = plot(lower, "Lower Glow 3", color=glow(cBlue,   72, 100), linewidth=1)
pL2 = plot(lower, "Lower Glow 2", color=glow(cBlue,   52, 100), linewidth=1)
pL1 = plot(lower, "Lower Glow 1", color=glow(cBlue,   32, 100), linewidth=1)

// Core lines (linewidth=1)
plot(upper, "Upper", color=glow(cPink,   0, 0), linewidth=1)
plot(basis, "Basis", color=glow(cPurple, 0, 0), linewidth=1)
plot(lower, "Lower", color=glow(cBlue,   0, 0), linewidth=1)

// Channel fill
fill(pU1, pL1, color=glow(cPurple, 92, 100))

// Optional bar tint
barcolor(tintBarsLight ? color.new(cPurple, 90) : na)

// ---------------------------
// TRADE LABELS
// ---------------------------
positionWas = strategy.position_size[1]
positionNow = strategy.position_size

if showTradeLabels
    if positionWas == 0 and positionNow > 0
        label.new(bar_index, low, "LONG",  style=label.style_label_up,   color=color.new(cBlue, 10), textcolor=color.white, yloc=yloc.belowbar, size=size.tiny)
    if positionWas == 0 and positionNow < 0
        label.new(bar_index, high, "SHORT", style=label.style_label_down, color=color.new(cPink, 10), textcolor=color.white, yloc=yloc.abovebar, size=size.tiny)
    if positionWas > 0 and positionNow == 0
        label.new(bar_index, high, "EXIT",  style=label.style_label_down, color=color.new(cPurple, 15), textcolor=color.white, yloc=yloc.abovebar, size=size.tiny)
    if positionWas < 0 and positionNow == 0
        label.new(bar_index, low,  "EXIT",  style=label.style_label_up,   color=color.new(cPurple, 15), textcolor=color.white, yloc=yloc.belowbar, size=size.tiny)
    if positionWas > 0 and positionNow < 0
        label.new(bar_index, high, "FLIP->SHORT", style=label.style_label_down, color=color.new(color.black, 0), textcolor=cWhite, yloc=yloc.abovebar, size=size.tiny)
    if positionWas < 0 and positionNow > 0
        label.new(bar_index, low,  "FLIP->LONG",  style=label.style_label_up,   color=color.new(color.black, 0), textcolor=cWhite, yloc=yloc.belowbar, size=size.tiny)

// ---------------------------
// AUTO REGIME CLASS (visual only; no effect on trades)
// ---------------------------
slopeLen   = 5
slopeBasis = ta.ema(basis - basis[slopeLen], 5)
isUp       = slopeBasis > 0
isDown     = slopeBasis < 0

isLongParab  = close > upper and isUp
isShortParab = close < lower and isDown
isLongTrend  = close >= basis and isUp and not isLongParab
isShortTrend = close <= basis and isDown and not isShortParab
isRange      = not (isLongParab or isShortParab or isLongTrend or isShortTrend)

currentRegime =
     isLongParab  ? "Long Parabolic"  :
     isShortParab ? "Short Parabolic" :
     isLongTrend  ? "Long Trend"      :
     isShortTrend ? "Short Trend"     : "Range"

// ---------------------------
// MARKET REGIME BOX (Top-Right)
// ---------------------------
var table regimeTbl = table.new(position.top_right, 2, 6, na, color.new(cPurple, 60), 1)

if barstate.islastconfirmedhistory
    if showRegimeBox
        table.cell(regimeTbl, 0, 0, "MARKET REGIME", text_color=color.white, bgcolor=color.new(cPurple, 70), text_halign=text.align_left)
        table.cell(regimeTbl, 1, 0, "",              text_color=color.white, bgcolor=color.new(cPurple, 70), text_halign=text.align_right)

        f_row(regimeTbl, 1, "Long Parabolic",  currentRegime == "Long Parabolic",  cBlue)
        f_row(regimeTbl, 2, "Long Trend",      currentRegime == "Long Trend",      cBlue)
        f_row(regimeTbl, 3, "Range",           currentRegime == "Range",           cPurple)
        f_row(regimeTbl, 4, "Short Trend",     currentRegime == "Short Trend",     cPink)
        f_row(regimeTbl, 5, "Short Parabolic", currentRegime == "Short Parabolic", cPink)
    else
        for i = 0 to 5
            table.cell(regimeTbl, 0, i, "", bgcolor=color.new(color.black, 100))
            table.cell(regimeTbl, 1, i, "", bgcolor=color.new(color.black, 100))
