//@version=6
// This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0.
// If a copy of the MPL was not distributed with this file, You can obtain one at https://mozilla.org/MPL/2.0/.
// © BullByte
// ============================================================================
// VMDM - Volume, Momentum & Divergence Master[BullByte]
// Author: BullByte
// Version: 1.0 (Production Release)
//
// DESCRIPTION:
// Educational indicator combining volume pressure analysis, RSI momentum
// divergence detection, and institutional footprint patterns into a unified
// confluence scoring system. Designed to teach market structure recognition
// through transparent, non-repainting signal detection.
//
// MASHUP JUSTIFICATION:
// This indicator uniquely combines four independent analytical layers:
// 1) RSI Divergence - Identifies momentum exhaustion before price reversal
// 2) Volume Pressure - Quantifies buying/selling intensity via close position
// 3) Institutional Footprint - Detects absorption, stop hunts, exhaustion
// 4) Confluence Scoring - Weights all factors into 0-100 quality score
// The pivot confirmation system ensures all signals are non-repainting.
//
// PINE SCRIPT VERSION:
//  Pine Script v6.
//
// PERFORMANCE NOTES:
// - Pressure lookback capped at 300 bars for calculation efficiency
// - Use "Master Visual Toggle" to disable all drawings on mobile/slow devices
// - Default object limits set to 100 for stability
// - Consecutive institutional events merge into single zones for clarity
//
// IMPORTANT:
// - This indicator is for EDUCATIONAL purposes only
// - Not financial advice, not a trading system
// - All signals use confirmed pivots to prevent repainting
// - Natural confirmation delay exists in divergence modes
//
// DISCLAIMER:
// Past pattern performance does not guarantee future results. Trading involves
// substantial risk of loss. Use proper risk management at all times. Any
// backtest results should account for realistic slippage, commissions, and
// sufficient sample size before drawing conclusions.
// ============================================================================

indicator(title="VMDM - Volume, Momentum & Divergence Master [BullByte]", shorttitle="VMDM [BullByte]", overlay=true, max_labels_count=100, max_lines_count=100, max_boxes_count=100)

// ============================================================================
// SECTION 1: USER INPUTS
// ============================================================================

// --- Performance & Master Controls ---
i_renderVisuals = input.bool(true, "Enable All Visuals (Master Toggle)", group="Performance", tooltip="Master switch to enable/disable ALL visual elements. Turn OFF on mobile or slow devices for better performance.")
i_maxLabelHistory = input.int(50, "Maximum Object History", minval=10, maxval=100, group="Performance", tooltip="Maximum number of each object type kept in memory. Lower values improve performance. Capped at 100.")
i_alertCooldown = input.int(5, "Alert Cooldown (Bars)", minval=1, maxval=50, group="Performance", tooltip="Minimum bars between repeated alerts of the same type to prevent spam.")

// --- User Experience ---
i_useTooltips = input.bool(true, "Show Enhanced Tooltips", group="User Experience", tooltip="Displays detailed hover-over help text. Turn OFF if you encounter compilation errors related to tooltip arguments on older platforms.")

// --- Market Structure Detection ---
i_pivotLeft = input.int(3, "Pivot Left Bars", minval=2, maxval=10, group="Market Structure Detection", tooltip="Number of bars to the left required for pivot validation. Higher values create stricter, more significant pivots.")
i_pivotRight = input.int(3, "Pivot Right Bars", minval=2, maxval=10, group="Market Structure Detection", tooltip="Confirmation bars to the right. This creates the non-repainting delay. Signals appear AFTER this many bars pass the pivot.")
i_sensitivityScore = input.int(60, "Minimum Confluence Score", minval=40, maxval=95, group="Market Structure Detection", tooltip="Threshold for pattern display (0-100 scale). Lower = more signals but lower quality. Higher = fewer signals but higher quality.")

// --- Technical Periods ---
i_rsiLen = input.int(14, "RSI Period", minval=5, maxval=50, group="Technical Periods", tooltip="Standard RSI lookback period. 14 is industry standard.")
i_volLen = input.int(20, "Volume Moving Average Period", minval=10, maxval=200, group="Technical Periods", tooltip="Period for volume average calculation.")
i_atrLen = input.int(14, "ATR Period", minval=5, maxval=100, group="Technical Periods", tooltip="Average True Range period for volatility measurement.")
i_pressurePRLen = input.int(50, "Pressure Percentile Lookback", minval=10, maxval=300, group="Technical Periods", tooltip="Lookback for volume pressure percentile ranking. Capped at 300 bars for performance.")

// --- Signal Detection ---
i_consolidatedMode = input.string("Divergence + Confluence (Confirmed)", "Signal Detection Mode", options=["Confluence Only (Real-time)", "Divergence + Confluence (Confirmed)", "Divergence + Confluence (Relaxed)"], group="Signal Detection", tooltip="CONFIRMED: Full system with pivot confirmation. REAL-TIME: Instant confluence signals. RELAXED: Adaptive thresholds.")

// --- Visual Layers ---
i_showStructure = input.bool(true, "Show Market Structure (Pivots & Lines)", group="Visual Layers", tooltip="Displays pivot high/low markers and horizontal support/resistance lines.")
i_showPressure = input.bool(true, "Show Pressure Zones (Background Color)", group="Visual Layers", tooltip="Colors chart background based on volume pressure strength.")
i_showDivergence = input.bool(true, "Show Divergence Lines", group="Visual Layers", tooltip="Draws connecting lines between pivots when divergence is detected.")
i_showFootprint = input.bool(true, "Show Institutional Footprint Markers", group="Visual Layers", tooltip="Displays absorption boxes, stop hunt labels, and exhaustion markers.")
i_showConsolidated = input.bool(true, "Show Consolidated Analysis Label", group="Visual Layers", tooltip="Main pattern detection label with full confluence breakdown.")
i_compactConsolidated = input.bool(false, "Use Compact Label Format", group="Visual Layers", tooltip="Single-line compact labels when ON, full multi-line format when OFF.")
i_labelSize = input.string("Small", "Consolidated Label Size", options=["Tiny", "Small", "Normal"], group="Visual Layers", tooltip="Text size for main pattern labels. Tiny = most compact, Normal = most readable.")
// --- Dashboard ---
i_dashboardMode = input.string("Optimized", "Dashboard Mode", options=["Off", "Compact", "Optimized", "Full"], group="Dashboard", tooltip="OFF: No dashboard. COMPACT: Essential info. OPTIMIZED: Balanced. FULL: All metrics.")
i_dashPosition = input.string("Top Right", "Dashboard Position", options=["Top Right", "Top Left", "Bottom Right", "Bottom Left"], group="Dashboard")

// --- Visual Theme ---
i_colorTheme = input.string("Dark Theme (Default)", "Color Theme", options=["Dark Theme (Default)", "Light Theme", "Auto (Follow Chart)"], group="Visual Theme", tooltip="Dark: Optimized for dark backgrounds. Light: Optimized for light backgrounds. Auto: Attempts to detect chart background.")

// ============================================================================
// SECTION 2: COLOR PALETTE (THEME-AWARE)
// ============================================================================

isDarkTheme = i_colorTheme == "Dark Theme (Default)" ? true : i_colorTheme == "Light Theme" ? false : true

color ACCUMULATION = isDarkTheme ? #00E676 : #1B5E20
color DISTRIBUTION = isDarkTheme ? #FF1744 : #B71C1C
color NEUTRAL_FLOW = isDarkTheme ? #607D8B : #546E7A
color DIVERGENCE_BULL = isDarkTheme ? #69F0AE : #2E7D32
color DIVERGENCE_BEAR = isDarkTheme ? #FF5252 : #C62828
color INSTITUTIONAL = isDarkTheme ? #FFD700 : #F57F17
color ABSORPTION = isDarkTheme ? #9C27B0 : #6A1B9A
color STOPHUNT = isDarkTheme ? #FF6F00 : #E65100
color EXHAUSTION = isDarkTheme ? #00BCD4 : #00838F

color PANEL_BG = isDarkTheme ? color.new(#0D1117, 3) : color.new(#FFFFFF, 5)
color PANEL_HEADER = isDarkTheme ? color.new(#161B22, 5) : color.new(#F5F5F5, 10)
color PANEL_BORDER = isDarkTheme ? color.new(#30363D, 20) : color.new(#BDBDBD, 30)

color TEXT_PRIMARY = isDarkTheme ? #E6EDF3 : #1A1A1A
color TEXT_SECONDARY = isDarkTheme ? #8B949E : #616161
color TEXT_ACCENT = isDarkTheme ? #58A6FF : #1976D2
color TEXT_SUCCESS = isDarkTheme ? #3FB950 : #2E7D32

color PRESSURE_BUY_BG = isDarkTheme ? color.new(ACCUMULATION, 93) : color.new(ACCUMULATION, 88)
color PRESSURE_SELL_BG = isDarkTheme ? color.new(DISTRIBUTION, 93) : color.new(DISTRIBUTION, 88)

color LABEL_BG_BULLISH = isDarkTheme ? color.new(ACCUMULATION, 80) : color.new(ACCUMULATION, 70)
color LABEL_BG_BEARISH = isDarkTheme ? color.new(DISTRIBUTION, 80) : color.new(DISTRIBUTION, 70)
color LABEL_BG_MAIN = isDarkTheme ? color.new(PANEL_BG, 5) : color.new(#FFFFFF, 10)

color LINE_SUPPORT = isDarkTheme ? color.new(ACCUMULATION, 70) : color.new(ACCUMULATION, 50)
color LINE_RESISTANCE = isDarkTheme ? color.new(DISTRIBUTION, 70) : color.new(DISTRIBUTION, 50)
color LINE_DIVERGENCE_BULL = isDarkTheme ? color.new(DIVERGENCE_BULL, 20) : color.new(DIVERGENCE_BULL, 40)
color LINE_DIVERGENCE_BEAR = isDarkTheme ? color.new(DIVERGENCE_BEAR, 20) : color.new(DIVERGENCE_BEAR, 40)

int BOX_ABSORPTION_BG = isDarkTheme ? 85 : 75
int BOX_BORDER_WIDTH = 2

// ============================================================================
// SECTION 3: CORE MARKET CALCULATIONS
// ============================================================================

atr = ta.atr(i_atrLen)
rsi = ta.rsi(close, i_rsiLen)
volAvg = ta.sma(volume, i_volLen)
volRatio = volAvg > 0 ? volume / volAvg : 1.0
barRange = high - low
bodySize = math.abs(close - open)
upperWick = high - math.max(close, open)
lowerWick = math.min(close, open) - low
wickRatio = barRange > 0 ? (upperWick + lowerWick) / barRange : 0.0
isBullBar = close > open
isBearBar = close < open

// ============================================================================
// SECTION 4: VOLUME PRESSURE ANALYSIS
// ============================================================================

f_percent_rank(src, len) =>
    int actualLen = math.min(len, bar_index + 1)
    actualLen := math.min(actualLen, 300)
    if actualLen <= 1
        50.0
    else
        int count = 0
        for i = 0 to actualLen - 1
            count := count + (src >= src[i] ? 1 : 0)
        100.0 * count / actualLen

calcBuyPressure() =>
    float closePos = barRange > 0 ? (close - low) / barRange : 0.5
    float wickWeight = 1.0 - wickRatio * 0.5
    volume * closePos * wickWeight

calcSellPressure() =>
    float closePos = barRange > 0 ? (high - close) / barRange : 0.5
    float wickWeight = 1.0 - wickRatio * 0.5
    volume * closePos * wickWeight

buyPressure = calcBuyPressure()
sellPressure = calcSellPressure()
netPressure = buyPressure - sellPressure
pressureMA = ta.ema(netPressure, 10)
pressureStrength = f_percent_rank(pressureMA, i_pressurePRLen)

// ============================================================================
// SECTION 5: MARKET REGIME CLASSIFICATION
// ============================================================================

atrSma50 = ta.sma(atr, 50)
volatilityRatio = atrSma50 > 0 ? atr / atrSma50 : 1.0
isHighVolatility = volatilityRatio > 1.3
isLowVolatility = volatilityRatio < 0.7
ema20 = ta.ema(close, 20)
ema50 = ta.ema(close, 50)
trendStrength = atr > 0 ? math.abs(ema20 - ema50) / atr : 0.0
isTrending = trendStrength > 2.0
isRanging = trendStrength < 1.0
uptrend = ema20 > ema50
downtrend = ema20 < ema50

getMarketRegime() =>
    if isTrending and uptrend
        "TREND UP"
    else if isTrending and downtrend
        "TREND DOWN"
    else if isRanging
        "RANGING"
    else
        "TRANSITION"

marketRegime = getMarketRegime()
volState = isHighVolatility ? "HV" : isLowVolatility ? "LV" : "NV"

// ============================================================================
// SECTION 6: INSTITUTIONAL FOOTPRINT DETECTION
// ============================================================================

isAbsorption = volRatio > 2.0 and barRange < ta.sma(barRange, 20) * 0.5
absorptionType = isAbsorption and isBullBar ? "ACCUMULATION" : isAbsorption and isBearBar ? "DISTRIBUTION" : "NONE"
recentHigh = ta.highest(high[1], 10)
recentLow = ta.lowest(low[1], 10)
bullStopHunt = low < recentLow * 0.998 and close > recentLow and volRatio > 1.5
bearStopHunt = high > recentHigh * 1.002 and close < recentHigh and volRatio > 1.5
isStopHunt = bullStopHunt or bearStopHunt
stopHuntDir = bullStopHunt ? "BULL HUNT" : bearStopHunt ? "BEAR HUNT" : "NONE"
bullExhaustion = lowerWick > bodySize * 2.5 and volRatio > 1.8 and rsi < 35
bearExhaustion = upperWick > bodySize * 2.5 and volRatio > 1.8 and rsi > 65
isExhaustion = bullExhaustion or bearExhaustion
exhaustionDir = bullExhaustion ? "SELL EXHAUST" : bearExhaustion ? "BUY EXHAUST" : "NONE"
institutionalActivity = absorptionType != "NONE" or stopHuntDir != "NONE" or exhaustionDir != "NONE"

getActiveInstitutionalEvent() =>
    absorptionType != "NONE" ? absorptionType : stopHuntDir != "NONE" ? stopHuntDir : exhaustionDir != "NONE" ? exhaustionDir : "NONE"

activeInstitutionalEvent = getActiveInstitutionalEvent()

var int barsSinceInstitutional = 9999
var string lastInstitutionalType = "NONE"

if institutionalActivity
    barsSinceInstitutional := 0
    lastInstitutionalType := activeInstitutionalEvent
else
    barsSinceInstitutional := barsSinceInstitutional + 1

// ============================================================================
// SECTION 7: PIVOT DETECTION (Confirmed, Non-Repainting)
// ============================================================================

pivotLow = ta.pivotlow(low, i_pivotLeft, i_pivotRight)
pivotHigh = ta.pivothigh(high, i_pivotLeft, i_pivotRight)
isPivotLow = not na(pivotLow)
isPivotHigh = not na(pivotHigh)
pivotLowPrice = isPivotLow ? low[i_pivotRight] : na
pivotHighPrice = isPivotHigh ? high[i_pivotRight] : na
pivotLowBar = isPivotLow ? bar_index - i_pivotRight : na
pivotHighBar = isPivotHigh ? bar_index - i_pivotRight : na
pivotLowRsi = isPivotLow ? rsi[i_pivotRight] : na
pivotHighRsi = isPivotHigh ? rsi[i_pivotRight] : na
pivotLowPressure = isPivotLow ? pressureStrength[i_pivotRight] : na
pivotHighPressure = isPivotHigh ? pressureStrength[i_pivotRight] : na

// ============================================================================
// SECTION 8: PIVOT MEMORY STORAGE
// ============================================================================

var float memPivotLowPrice = na
var float memPivotLowRsi = na
var float memPivotLowPressure = na
var int memPivotLowBar = na
var float memPivotHighPrice = na
var float memPivotHighRsi = na
var float memPivotHighPressure = na
var int memPivotHighBar = na

// ============================================================================
// SECTION 9: DIVERGENCE DETECTION (Price vs RSI)
// ============================================================================

var string divergenceType = "NONE"
var float divergenceStrength = 0.0
var string divergenceExplanation = ""
var bool divergenceDetectedOnThisBar = false

divergenceType := "NONE"
divergenceStrength := 0.0
divergenceExplanation := ""
divergenceDetectedOnThisBar := false

if isPivotLow and not na(memPivotLowPrice)
    bool priceLower = pivotLowPrice < memPivotLowPrice
    bool priceHigher = pivotLowPrice > memPivotLowPrice
    bool rsiHigher = pivotLowRsi > memPivotLowRsi
    bool rsiLower = pivotLowRsi < memPivotLowRsi
    bool pressureHigher = pivotLowPressure > memPivotLowPressure
    if priceLower and rsiHigher
        divergenceType := "BULLISH REGULAR"
        divergenceStrength := 80.0
        divergenceExplanation := "Price: Lower Low\nMomentum: Higher Low\nSignal: Weakening Downtrend"
        divergenceDetectedOnThisBar := true
    else if priceHigher and rsiLower
        divergenceType := "BULLISH HIDDEN"
        divergenceStrength := 65.0
        divergenceExplanation := "Price: Higher Low\nMomentum: Lower Low\nSignal: Uptrend Continuation"
        divergenceDetectedOnThisBar := true
    if divergenceDetectedOnThisBar and pressureHigher and priceLower
        divergenceStrength := divergenceStrength + 15.0

if isPivotHigh and not na(memPivotHighPrice)
    bool priceHigher = pivotHighPrice > memPivotHighPrice
    bool priceLower = pivotHighPrice < memPivotHighPrice
    bool rsiLower = pivotHighRsi < memPivotHighRsi
    bool rsiHigher = pivotHighRsi > memPivotHighRsi
    bool pressureLower = pivotHighPressure < memPivotHighPressure
    if priceHigher and rsiLower
        divergenceType := "BEARISH REGULAR"
        divergenceStrength := 80.0
        divergenceExplanation := "Price: Higher High\nMomentum: Lower High\nSignal: Weakening Uptrend"
        divergenceDetectedOnThisBar := true
    else if priceLower and rsiHigher
        divergenceType := "BEARISH HIDDEN"
        divergenceStrength := 65.0
        divergenceExplanation := "Price: Lower High\nMomentum: Higher High\nSignal: Downtrend Continuation"
        divergenceDetectedOnThisBar := true
    if divergenceDetectedOnThisBar and pressureLower and priceHigher
        divergenceStrength := divergenceStrength + 15.0

hasDivergence = divergenceType != "NONE"

// ============================================================================
// SECTION 10: CONFLUENCE MATRIX SCORING (0-100 Scale)
// ============================================================================

confluenceMomentum = hasDivergence ? 30.0 : 0.0
confluencePressure = (isPivotLow and pressureStrength > 60) or (isPivotHigh and pressureStrength < 40) ? 25.0 : 0.0
confluenceInstitutional = institutionalActivity ? 20.0 : 0.0
confluenceRSI = (isPivotLow and rsi < 30) or (isPivotHigh and rsi > 70) ? 15.0 : 0.0
confluenceVolume = volRatio > 1.5 ? 10.0 : 0.0
totalConfluence = confluenceMomentum + confluencePressure + confluenceInstitutional + confluenceRSI + confluenceVolume
totalConfluenceNoDiv = totalConfluence - confluenceMomentum
isValidPattern = (isPivotLow or isPivotHigh) and hasDivergence and totalConfluence >= i_sensitivityScore

getPatternQuality() =>
    totalConfluence >= 90 ? "TEXTBOOK" : totalConfluence >= 75 ? "HIGH QUALITY" : totalConfluence >= 60 ? "VALID" : "DEVELOPING"

patternQuality = getPatternQuality()

// ============================================================================
// SECTION 11: STATISTICS TRACKING
// ============================================================================

var int patternsObserved = 0
var int bullishPatternsObserved = 0
var int bearishPatternsObserved = 0
var int absorptionEvents = 0
var int stopHuntEvents = 0
var int exhaustionEvents = 0
var int lastPatternBar = na

if barstate.isfirst
    patternsObserved := 0
    bullishPatternsObserved := 0
    bearishPatternsObserved := 0
    absorptionEvents := 0
    stopHuntEvents := 0
    exhaustionEvents := 0
    lastPatternBar := na

if isValidPattern
    patternsObserved += 1
    lastPatternBar := bar_index
    if isPivotLow
        bullishPatternsObserved += 1
    if isPivotHigh
        bearishPatternsObserved += 1

if isAbsorption
    absorptionEvents += 1
if isStopHunt
    stopHuntEvents += 1
if isExhaustion
    exhaustionEvents += 1

totalInstitutionalEvents = absorptionEvents + stopHuntEvents + exhaustionEvents

// ============================================================================
// SECTION 12: OBJECT MANAGEMENT
// ============================================================================

var label[] consolidatedLabels = array.new_label()
var label[] structureLabels = array.new_label()
var label[] institutionalLabels = array.new_label()
var line[] structureLines = array.new_line()
var line[] divergenceLines = array.new_line()
var box[] institutionalBoxes = array.new_box()

cleanupLabels(labelArray, maxCount) =>
    while array.size(labelArray) > maxCount
        oldLabel = array.shift(labelArray)
        if not na(oldLabel)
            label.delete(oldLabel)

cleanupLines(lineArray, maxCount) =>
    while array.size(lineArray) > maxCount
        oldLine = array.shift(lineArray)
        if not na(oldLine)
            line.delete(oldLine)

cleanupBoxes(boxArray, maxCount) =>
    while array.size(boxArray) > maxCount
        oldBox = array.shift(boxArray)
        if not na(oldBox)
            box.delete(oldBox)

safeMaxLabels = math.min(i_maxLabelHistory, 100)
if timeframe.period == "1" and safeMaxLabels > 50
    safeMaxLabels := 50

cleanupLabels(consolidatedLabels, safeMaxLabels)
cleanupLabels(structureLabels, safeMaxLabels)
cleanupLabels(institutionalLabels, safeMaxLabels)
cleanupLines(structureLines, safeMaxLabels)
cleanupLines(divergenceLines, safeMaxLabels)
cleanupBoxes(institutionalBoxes, safeMaxLabels)

// ============================================================================
// SECTION 13: VISUAL RENDERING - MARKET STRUCTURE
// ============================================================================

if i_renderVisuals and i_showStructure
    if isPivotLow
        plLabel = label.new(x=pivotLowBar, y=pivotLowPrice, text="PL", style=label.style_label_up, color=LABEL_BG_BULLISH, textcolor=TEXT_PRIMARY, size=size.tiny, tooltip=i_useTooltips ? "Pivot Low - Confirmed support level" : na)
        array.push(structureLabels, plLabel)
        plLine = line.new(x1=pivotLowBar, y1=pivotLowPrice, x2=bar_index + 10, y2=pivotLowPrice, color=LINE_SUPPORT, width=1, style=line.style_dashed)
        array.push(structureLines, plLine)
    if isPivotHigh
        phLabel = label.new(x=pivotHighBar, y=pivotHighPrice, text="PH", style=label.style_label_down, color=LABEL_BG_BEARISH, textcolor=TEXT_PRIMARY, size=size.tiny, tooltip=i_useTooltips ? "Pivot High - Confirmed resistance level" : na)
        array.push(structureLabels, phLabel)
        phLine = line.new(x1=pivotHighBar, y1=pivotHighPrice, x2=bar_index + 10, y2=pivotHighPrice, color=LINE_RESISTANCE, width=1, style=line.style_dashed)
        array.push(structureLines, phLine)

// ============================================================================
// SECTION 14: VISUAL RENDERING - PRESSURE ZONES
// ============================================================================

getPressureZoneColor() =>
    if not i_renderVisuals or not i_showPressure
        na
    else if pressureStrength > 70
        PRESSURE_BUY_BG
    else if pressureStrength < 30
        PRESSURE_SELL_BG
    else
        na

bgcolor(getPressureZoneColor(), title="Pressure Zone")

// ============================================================================
// SECTION 15: VISUAL RENDERING - DIVERGENCE LINES
// ============================================================================

if i_renderVisuals and i_showDivergence and hasDivergence and divergenceDetectedOnThisBar
    divColor = str.contains(divergenceType, "BULLISH") ? DIVERGENCE_BULL : DIVERGENCE_BEAR
    divLineColor = str.contains(divergenceType, "BULLISH") ? LINE_DIVERGENCE_BULL : LINE_DIVERGENCE_BEAR
    divTypeShort = str.contains(divergenceType, "BULLISH") ? "BULL" : "BEAR"
    divKindShort = str.contains(divergenceType, "REGULAR") ? "REG" : "HID"
    
    if isPivotLow and str.contains(divergenceType, "BULLISH") and not na(memPivotLowBar)
        divPriceLine = line.new(x1=memPivotLowBar, y1=memPivotLowPrice, x2=pivotLowBar, y2=pivotLowPrice, color=divLineColor, width=2, style=line.style_dotted)
        array.push(divergenceLines, divPriceLine)
        if not i_showConsolidated
            midBar = math.round((memPivotLowBar + pivotLowBar) / 2)
            midPrice = (memPivotLowPrice + pivotLowPrice) / 2
            divLabel = label.new(x=midBar, y=midPrice, text=divKindShort + " " + divTypeShort, style=label.style_label_center, color=color.new(divColor, 30), textcolor=isDarkTheme ? color.white : TEXT_PRIMARY, size=size.tiny, tooltip=i_useTooltips ? "Divergence: " + divergenceType : na)
            array.push(consolidatedLabels, divLabel)
    
    if isPivotHigh and str.contains(divergenceType, "BEARISH") and not na(memPivotHighBar)
        divPriceLine = line.new(x1=memPivotHighBar, y1=memPivotHighPrice, x2=pivotHighBar, y2=pivotHighPrice, color=divLineColor, width=2, style=line.style_dotted)
        array.push(divergenceLines, divPriceLine)
        if not i_showConsolidated
            midBar = math.round((memPivotHighBar + pivotHighBar) / 2)
            midPrice = (memPivotHighPrice + pivotHighPrice) / 2
            divLabel = label.new(x=midBar, y=midPrice, text=divKindShort + " " + divTypeShort, style=label.style_label_center, color=color.new(divColor, 30), textcolor=isDarkTheme ? color.white : TEXT_PRIMARY, size=size.tiny, tooltip=i_useTooltips ? "Divergence: " + divergenceType : na)
            array.push(consolidatedLabels, divLabel)

// ============================================================================
// SECTION 16: INSTITUTIONAL FOOTPRINT - MERGED ZONE BOXES
// ============================================================================

var bool wasAbsorptionPrevBar = false
var string prevAbsorptionType = "NONE"
var box currentAbsorptionBox = na
var label currentAbsorptionLabel = na
var float absBoxTop = na
var float absBoxBottom = na
var int absBoxStartBar = na
var int absBarCount = 0

var bool wasStopHuntPrevBar = false
var string prevStopHuntDir = "NONE"
var label currentStopHuntLabel = na
var int huntBarCount = 0

var bool wasExhaustionPrevBar = false
var string prevExhaustionDir = "NONE"
var label currentExhaustionLabel = na
var int exhBarCount = 0

if i_renderVisuals and i_showFootprint
    
    if isAbsorption
        if wasAbsorptionPrevBar and absorptionType == prevAbsorptionType and not na(currentAbsorptionBox)
            absBoxTop := math.max(absBoxTop, high)
            absBoxBottom := math.min(absBoxBottom, low)
            absBarCount := absBarCount + 1
            box.set_right(currentAbsorptionBox, bar_index + 1)
            box.set_top(currentAbsorptionBox, absBoxTop)
            box.set_bottom(currentAbsorptionBox, absBoxBottom)
            if not na(currentAbsorptionLabel)
                labelBar = math.round((absBoxStartBar + bar_index) / 2)
                label.set_x(currentAbsorptionLabel, labelBar)
                label.set_y(currentAbsorptionLabel, absBoxTop + atr * 0.3)
                label.set_text(currentAbsorptionLabel, absorptionType + " (" + str.tostring(absBarCount) + ")")
        else
            absColor = absorptionType == "ACCUMULATION" ? ABSORPTION : DISTRIBUTION
            absBoxTop := high
            absBoxBottom := low
            absBoxStartBar := bar_index
            absBarCount := 1
            currentAbsorptionBox := box.new(left=bar_index - 1, top=high, right=bar_index + 1, bottom=low, border_color=absColor, bgcolor=color.new(absColor, BOX_ABSORPTION_BG), border_width=BOX_BORDER_WIDTH)
            array.push(institutionalBoxes, currentAbsorptionBox)
            currentAbsorptionLabel := label.new(x=bar_index, y=high + atr * 0.3, text=absorptionType + " (1)", style=label.style_label_down, color=color.new(absColor, 30), textcolor=isDarkTheme ? color.white : TEXT_PRIMARY, size=size.tiny, tooltip=i_useTooltips ? "Absorption zone - High volume absorbed into tight range" : na)
            array.push(institutionalLabels, currentAbsorptionLabel)
        wasAbsorptionPrevBar := true
        prevAbsorptionType := absorptionType
    else
        wasAbsorptionPrevBar := false
        prevAbsorptionType := "NONE"
    
    if isStopHunt
        if wasStopHuntPrevBar and stopHuntDir == prevStopHuntDir and not na(currentStopHuntLabel)
            huntBarCount := huntBarCount + 1
            huntY = stopHuntDir == "BULL HUNT" ? low - atr * 0.5 : high + atr * 0.5
            label.set_y(currentStopHuntLabel, huntY)
            label.set_text(currentStopHuntLabel, stopHuntDir + " (" + str.tostring(huntBarCount) + ")")
        else
            huntBarCount := 1
            huntStyle = stopHuntDir == "BULL HUNT" ? label.style_label_up : label.style_label_down
            huntY = stopHuntDir == "BULL HUNT" ? low - atr * 0.5 : high + atr * 0.5
            currentStopHuntLabel := label.new(x=bar_index, y=huntY, text=stopHuntDir + " (1)", style=huntStyle, color=color.new(STOPHUNT, 20), textcolor=isDarkTheme ? color.white : TEXT_PRIMARY, size=size.tiny, tooltip=i_useTooltips ? "Stop hunt - Liquidity sweep detected" : na)
            array.push(institutionalLabels, currentStopHuntLabel)
        wasStopHuntPrevBar := true
        prevStopHuntDir := stopHuntDir
    else
        wasStopHuntPrevBar := false
        prevStopHuntDir := "NONE"
    
    if isExhaustion
        if wasExhaustionPrevBar and exhaustionDir == prevExhaustionDir and not na(currentExhaustionLabel)
            exhBarCount := exhBarCount + 1
            exhY = exhaustionDir == "SELL EXHAUST" ? low - atr * 0.5 : high + atr * 0.5
            label.set_y(currentExhaustionLabel, exhY)
            label.set_text(currentExhaustionLabel, exhaustionDir + " (" + str.tostring(exhBarCount) + ")")
        else
            exhBarCount := 1
            exhStyle = exhaustionDir == "SELL EXHAUST" ? label.style_label_up : label.style_label_down
            exhY = exhaustionDir == "SELL EXHAUST" ? low - atr * 0.5 : high + atr * 0.5
            currentExhaustionLabel := label.new(x=bar_index, y=exhY, text=exhaustionDir + " (1)", style=exhStyle, color=color.new(EXHAUSTION, 20), textcolor=isDarkTheme ? color.white : TEXT_PRIMARY, size=size.tiny, tooltip=i_useTooltips ? "Exhaustion - Potential trend reversal" : na)
            array.push(institutionalLabels, currentExhaustionLabel)
        wasExhaustionPrevBar := true
        prevExhaustionDir := exhaustionDir
    else
        wasExhaustionPrevBar := false
        prevExhaustionDir := "NONE"


// ============================================================================
// SECTION 17: VISUAL RENDERING - CONSOLIDATED ANALYSIS LABEL
// ============================================================================

var bool showConsolidatedNow = false

if i_consolidatedMode == "Confluence Only (Real-time)"
    condPrimary = totalConfluenceNoDiv >= i_sensitivityScore
    condSecondary = totalConfluenceNoDiv >= (i_sensitivityScore - 15) and (confluencePressure > 0 or confluenceInstitutional > 0 or confluenceRSI > 0 or confluenceVolume > 0)
    showConsolidatedNow := i_showConsolidated and (condPrimary or condSecondary)
else if i_consolidatedMode == "Divergence + Confluence (Confirmed)"
    showConsolidatedNow := i_showConsolidated and isValidPattern
else
    showConsolidatedNow := i_showConsolidated and ((hasDivergence and totalConfluence >= (i_sensitivityScore - 10)) or (totalConfluence >= (i_sensitivityScore + 10)))

if i_renderVisuals and showConsolidatedNow
    string analysisText = ""
    if i_compactConsolidated
        analysisText := (hasDivergence ? divergenceType + " | " : "") + "Q:" + patternQuality + " C:" + str.tostring(math.round(totalConfluence))
    else
        analysisText := "PATTERN DETECTED\n-------------------\n"
        if hasDivergence
            analysisText := analysisText + divergenceType + "\n"
        analysisText := analysisText + "Quality: " + patternQuality + "\n\n"
        if hasDivergence
            analysisText := analysisText + divergenceExplanation + "\n\n"
        else
            analysisText := analysisText + "Confluence signals detected\n\n"
        analysisText := analysisText + "CONFLUENCE: " + str.tostring(math.round(totalConfluence)) + "/100\n-------------------\n"
        analysisText := analysisText + "Divergence: " + (confluenceMomentum > 0 ? "[+] " : "[-] ") + str.tostring(math.round(confluenceMomentum)) + "\n"
        analysisText := analysisText + "Pressure: " + (confluencePressure > 0 ? "[+] " : "[-] ") + str.tostring(math.round(confluencePressure)) + "\n"
        analysisText := analysisText + "Institutional: " + (confluenceInstitutional > 0 ? "[+] " : "[-] ") + str.tostring(math.round(confluenceInstitutional)) + "\n"
        analysisText := analysisText + "RSI Extreme: " + (confluenceRSI > 0 ? "[+] " : "[-] ") + str.tostring(math.round(confluenceRSI)) + "\n"
        analysisText := analysisText + "Volume: " + (confluenceVolume > 0 ? "[+] " : "[-] ") + str.tostring(math.round(confluenceVolume))
    
    string tooltipText = i_consolidatedMode == "Confluence Only (Real-time)" ? "Real-time mode - instant signals" : "Confirmed mode - delayed " + str.tostring(i_pivotRight) + " bars"
    
    int analysisBar = na
    float analysisYPos = na
    var analysisStyle = label.style_label_up
    
    if i_consolidatedMode == "Confluence Only (Real-time)"
        analysisBar := bar_index
        analysisYPos := isBullBar ? low - atr * 1.2 : high + atr * 1.2
        analysisStyle := isBullBar ? label.style_label_up : label.style_label_down
    else
        analysisBar := isPivotLow ? pivotLowBar : isPivotHigh ? pivotHighBar : bar_index
        analysisYPos := isPivotLow ? pivotLowPrice - atr * 1.5 : isPivotHigh ? pivotHighPrice + atr * 1.5 : (isBullBar ? low - atr * 1.2 : high + atr * 1.2)
        analysisStyle := isPivotLow ? label.style_label_up : isPivotHigh ? label.style_label_down : (isBullBar ? label.style_label_up : label.style_label_down)
    
    color analysisColor = totalConfluence >= 90 ? INSTITUTIONAL : totalConfluence >= 75 ? TEXT_SUCCESS : TEXT_ACCENT
    
    labelSizeValue = i_labelSize == "Tiny" ? size.tiny : i_labelSize == "Small" ? size.small : size.normal

    consolidatedLabel = label.new(x=analysisBar, y=analysisYPos, text=analysisText, style=analysisStyle, color=LABEL_BG_MAIN, textcolor=analysisColor, size=labelSizeValue, textalign=text.align_left, tooltip=i_useTooltips ? tooltipText : na)
    array.push(consolidatedLabels, consolidatedLabel)
    
    if not i_compactConsolidated and (isPivotLow or isPivotHigh)
        pointerPrice = isPivotLow ? pivotLowPrice : pivotHighPrice
        pointerBar = isPivotLow ? pivotLowBar : pivotHighBar
        pointerStyle = isPivotLow ? label.style_triangleup : label.style_triangledown
        pointerLabel = label.new(x=pointerBar, y=pointerPrice, text="", style=pointerStyle, color=analysisColor, size=size.tiny)
        array.push(consolidatedLabels, pointerLabel)
        pointerLine = line.new(x1=analysisBar, y1=analysisYPos, x2=pointerBar, y2=pointerPrice, color=color.new(analysisColor, isDarkTheme ? 60 : 50), width=1, style=line.style_dotted)
        array.push(divergenceLines, pointerLine)

// ============================================================================
// SECTION 18: UPDATE PIVOT MEMORY
// ============================================================================

if isPivotLow
    memPivotLowPrice := pivotLowPrice
    memPivotLowRsi := pivotLowRsi
    memPivotLowPressure := pivotLowPressure
    memPivotLowBar := pivotLowBar

if isPivotHigh
    memPivotHighPrice := pivotHighPrice
    memPivotHighRsi := pivotHighRsi
    memPivotHighPressure := pivotHighPressure
    memPivotHighBar := pivotHighBar

// ============================================================================
// SECTION 19: DASHBOARD RENDERING
// ============================================================================

getDashPosition() =>
    switch i_dashPosition
        "Top Right" => position.top_right
        "Top Left" => position.top_left
        "Bottom Right" => position.bottom_right
        "Bottom Left" => position.bottom_left
        => position.top_right

f_draw_bar(val) =>
    int clamped = math.round(math.min(math.max(val, 0.0), 100.0))
    int filled = math.round(clamped / 10.0)
    string s = ""
    for i = 0 to 9
        s := s + (i < filled ? "█" : "░")
    s

var table dash = na

if i_renderVisuals and i_dashboardMode != "Off" and barstate.islast
    dashRows = i_dashboardMode == "Full" ? 13 : i_dashboardMode == "Optimized" ? 12 : 8
    
    if na(dash)
        dash := table.new(position=getDashPosition(), columns=3, rows=dashRows, bgcolor=PANEL_BG, border_width=1, border_color=PANEL_BORDER)
    
    instText = syminfo.ticker + " | " + timeframe.period
    table.cell(dash, 0, 0, instText, text_color=TEXT_PRIMARY, bgcolor=PANEL_HEADER, text_size=size.small)
    table.cell(dash, 1, 0, "VMDM[BullByte]", text_color=TEXT_ACCENT, bgcolor=PANEL_HEADER, text_size=size.normal)
    table.cell(dash, 2, 0, "v1.0", text_color=TEXT_SECONDARY, bgcolor=PANEL_HEADER, text_size=size.tiny)
    
    modeShort = i_consolidatedMode == "Confluence Only (Real-time)" ? "REALTIME" : i_consolidatedMode == "Divergence + Confluence (Confirmed)" ? "CONFIRMED" : "RELAXED"
    modeDelay = (i_consolidatedMode == "Divergence + Confluence (Confirmed)" or i_consolidatedMode == "Divergence + Confluence (Relaxed)") ? ("Delay: " + str.tostring(i_pivotRight) + " bars") : "Instant"
    table.cell(dash, 0, 1, "Mode", text_color=TEXT_SECONDARY, bgcolor=PANEL_BG, text_size=size.tiny)
    table.cell(dash, 1, 1, modeShort, text_color=TEXT_ACCENT, bgcolor=PANEL_BG, text_size=size.small)
    table.cell(dash, 2, 1, modeDelay, text_color=TEXT_SECONDARY, bgcolor=PANEL_BG, text_size=size.tiny)
    
    regimeColor = str.contains(marketRegime, "UP") ? ACCUMULATION : str.contains(marketRegime, "DOWN") ? DISTRIBUTION : NEUTRAL_FLOW
    table.cell(dash, 0, 2, "Regime", text_color=TEXT_SECONDARY, bgcolor=PANEL_BG, text_size=size.tiny)
    table.cell(dash, 1, 2, marketRegime + " " + volState, text_color=regimeColor, bgcolor=PANEL_BG, text_size=size.small)
    table.cell(dash, 2, 2, str.tostring(volatilityRatio, "#.##") + "x", text_color=TEXT_SECONDARY, bgcolor=PANEL_BG, text_size=size.tiny)
    
    pressureState = pressureStrength > 60 ? "BUYING" : pressureStrength < 40 ? "SELLING" : "NEUTRAL"
    dashPressureColor = pressureStrength > 60 ? ACCUMULATION : pressureStrength < 40 ? DISTRIBUTION : NEUTRAL_FLOW
    table.cell(dash, 0, 3, "Pressure", text_color=TEXT_SECONDARY, bgcolor=PANEL_BG, text_size=size.tiny)
    table.cell(dash, 1, 3, pressureState, text_color=dashPressureColor, bgcolor=PANEL_BG, text_size=size.small)
    table.cell(dash, 2, 3, f_draw_bar(pressureStrength), text_color=dashPressureColor, bgcolor=PANEL_BG, text_size=size.tiny)
    
    rsiState = rsi > 70 ? "OB" : rsi < 30 ? "OS" : ""
    rsiColor = rsi > 70 ? DISTRIBUTION : rsi < 30 ? ACCUMULATION : NEUTRAL_FLOW
    table.cell(dash, 0, 4, "Vol/RSI", text_color=TEXT_SECONDARY, bgcolor=PANEL_BG, text_size=size.tiny)
    table.cell(dash, 1, 4, str.tostring(volRatio, "#.#") + "x | RSI " + str.tostring(math.round(rsi)), text_color=rsiColor, bgcolor=PANEL_BG, text_size=size.small)
    table.cell(dash, 2, 4, rsiState, text_color=rsiColor, bgcolor=PANEL_BG, text_size=size.tiny)
    
    footprintText = lastInstitutionalType != "NONE" and barsSinceInstitutional < 100 ? lastInstitutionalType : "SCANNING"
    footprintContext = activeInstitutionalEvent != "NONE" ? "NOW" : barsSinceInstitutional < 100 ? str.tostring(barsSinceInstitutional) + " bars" : "..."
    footprintColor = activeInstitutionalEvent != "NONE" ? INSTITUTIONAL : barsSinceInstitutional < 50 ? TEXT_SUCCESS : TEXT_SECONDARY
    table.cell(dash, 0, 5, "Footprint", text_color=TEXT_SECONDARY, bgcolor=PANEL_BG, text_size=size.tiny)
    table.cell(dash, 1, 5, footprintText, text_color=footprintColor, bgcolor=PANEL_BG, text_size=size.small)
    table.cell(dash, 2, 5, footprintContext, text_color=footprintColor, bgcolor=PANEL_BG, text_size=size.tiny)
    
    currentPatternText = hasDivergence ? divergenceType : showConsolidatedNow ? "CONSOLIDATED" : "Scanning..."
    currentPatternColor = hasDivergence ? (str.contains(divergenceType, "BULLISH") ? ACCUMULATION : DISTRIBUTION) : TEXT_SECONDARY
    qualityDisplay = showConsolidatedNow ? patternQuality : "-"
    qualityColor = patternQuality == "TEXTBOOK" ? INSTITUTIONAL : patternQuality == "HIGH QUALITY" ? TEXT_SUCCESS : TEXT_ACCENT
    table.cell(dash, 0, 6, "Pattern", text_color=TEXT_SECONDARY, bgcolor=PANEL_BG, text_size=size.tiny)
    table.cell(dash, 1, 6, currentPatternText, text_color=currentPatternColor, bgcolor=PANEL_BG, text_size=size.small)
    table.cell(dash, 2, 6, qualityDisplay, text_color=qualityColor, bgcolor=PANEL_BG, text_size=size.tiny)
    
    sessionSummary = "A" + str.tostring(absorptionEvents) + " H" + str.tostring(stopHuntEvents) + " E" + str.tostring(exhaustionEvents)
    table.cell(dash, 0, 7, "Session", text_color=TEXT_SECONDARY, bgcolor=PANEL_BG, text_size=size.tiny)
    table.cell(dash, 1, 7, str.tostring(totalInstitutionalEvents) + " events", text_color=INSTITUTIONAL, bgcolor=PANEL_BG, text_size=size.small)
    table.cell(dash, 2, 7, sessionSummary, text_color=TEXT_SECONDARY, bgcolor=PANEL_BG, text_size=size.tiny)
    
    if i_dashboardMode != "Compact"
        confBar = f_draw_bar(totalConfluence)
        table.cell(dash, 0, 8, "Confluence", text_color=TEXT_SECONDARY, bgcolor=PANEL_BG, text_size=size.tiny)
        table.cell(dash, 1, 8, str.tostring(math.round(totalConfluence)) + "/100", text_color=hasDivergence ? TEXT_SUCCESS : TEXT_SECONDARY, bgcolor=PANEL_BG, text_size=size.small)
        table.cell(dash, 2, 8, confBar, text_color=TEXT_ACCENT, bgcolor=PANEL_BG, text_size=size.tiny)
        
        table.cell(dash, 0, 9, "Studied", text_color=TEXT_SECONDARY, bgcolor=PANEL_BG, text_size=size.tiny)
        table.cell(dash, 1, 9, str.tostring(patternsObserved) + " patterns", text_color=TEXT_SUCCESS, bgcolor=PANEL_BG, text_size=size.small)
        lastPatternAgeText = not na(lastPatternBar) ? str.tostring(bar_index - lastPatternBar) + " bars ago" : "-"
        table.cell(dash, 2, 9, lastPatternAgeText, text_color=TEXT_SECONDARY, bgcolor=PANEL_BG, text_size=size.tiny)
        
        ratioDisplay = str.tostring(bullishPatternsObserved) + ":" + str.tostring(bearishPatternsObserved)
        ratioBalance = bullishPatternsObserved > bearishPatternsObserved ? "BULL" : bearishPatternsObserved > bullishPatternsObserved ? "BEAR" : "BAL"
        ratioColor = bullishPatternsObserved > bearishPatternsObserved ? ACCUMULATION : bearishPatternsObserved > bullishPatternsObserved ? DISTRIBUTION : NEUTRAL_FLOW
        table.cell(dash, 0, 10, "Ratio", text_color=TEXT_SECONDARY, bgcolor=PANEL_BG, text_size=size.tiny)
        table.cell(dash, 1, 10, ratioDisplay, text_color=TEXT_ACCENT, bgcolor=PANEL_BG, text_size=size.small)
        table.cell(dash, 2, 10, ratioBalance, text_color=ratioColor, bgcolor=PANEL_BG, text_size=size.tiny)
        
        volVsAvg = str.tostring(math.round(volume)) + " / " + str.tostring(math.round(volAvg))
        table.cell(dash, 0, 11, "Vol Ratio", text_color=TEXT_SECONDARY, bgcolor=PANEL_BG, text_size=size.tiny)
        table.cell(dash, 1, 11, str.tostring(volRatio, "#.#") + "x", text_color=TEXT_SECONDARY, bgcolor=PANEL_BG, text_size=size.small)
        table.cell(dash, 2, 11, volVsAvg, text_color=TEXT_SECONDARY, bgcolor=PANEL_BG, text_size=size.tiny)
        
        if i_dashboardMode == "Full"
            table.cell(dash, 0, 12, "Last Inst.", text_color=TEXT_SECONDARY, bgcolor=PANEL_BG, text_size=size.tiny)
            table.cell(dash, 1, 12, lastInstitutionalType, text_color=TEXT_ACCENT, bgcolor=PANEL_BG, text_size=size.small)
            table.cell(dash, 2, 12, barsSinceInstitutional < 9999 ? str.tostring(barsSinceInstitutional) + " bars" : "...", text_color=TEXT_SECONDARY, bgcolor=PANEL_BG, text_size=size.tiny)

// ============================================================================
// SECTION 20: ALERT SYSTEM
// ============================================================================

var bool alertFiredThisPattern = false
var int lastAlertBar = na
var bool institutionalAlertFired = false
var bool pressureAlertFired = false

if barstate.isnew
    institutionalAlertFired := false
    if not na(lastAlertBar) and (bar_index - lastAlertBar) >= i_alertCooldown
        alertFiredThisPattern := false

if not isValidPattern
    alertFiredThisPattern := false

if (pressureStrength > 50 and pressureStrength[1] <= 50) or (pressureStrength < 50 and pressureStrength[1] >= 50)
    pressureAlertFired := false

bullishPatternAlert = isValidPattern and isPivotLow and str.contains(divergenceType, "BULLISH") and not alertFiredThisPattern
if bullishPatternAlert
    alertFiredThisPattern := true
    lastAlertBar := bar_index

bearishPatternAlert = isValidPattern and isPivotHigh and str.contains(divergenceType, "BEARISH") and not alertFiredThisPattern
if bearishPatternAlert
    alertFiredThisPattern := true
    lastAlertBar := bar_index

highConfluenceAlert = i_consolidatedMode == "Confluence Only (Real-time)" and totalConfluenceNoDiv >= i_sensitivityScore and (isPivotLow or isPivotHigh) and not alertFiredThisPattern
if highConfluenceAlert
    alertFiredThisPattern := true
    lastAlertBar := bar_index

absorptionAlert = isAbsorption and not institutionalAlertFired
if absorptionAlert
    institutionalAlertFired := true

stopHuntAlert = isStopHunt and not institutionalAlertFired
if stopHuntAlert
    institutionalAlertFired := true

exhaustionAlert = isExhaustion and not institutionalAlertFired
if exhaustionAlert
    institutionalAlertFired := true

extremeBuyPressure = pressureStrength >= 85 and volRatio > 1.3 and not pressureAlertFired
if extremeBuyPressure
    pressureAlertFired := true

extremeSellPressure = pressureStrength <= 15 and volRatio > 1.3 and not pressureAlertFired
if extremeSellPressure
    pressureAlertFired := true

anySignificantEvent = bullishPatternAlert or bearishPatternAlert or highConfluenceAlert or absorptionAlert or stopHuntAlert or exhaustionAlert or extremeBuyPressure or extremeSellPressure

// ============================================================================
// SECTION 21: PLOT OUTPUTS FOR ALERTS
// ============================================================================

plot(divergenceType == "BULLISH REGULAR" ? 1 : divergenceType == "BULLISH HIDDEN" ? 2 : divergenceType == "BEARISH REGULAR" ? 3 : divergenceType == "BEARISH HIDDEN" ? 4 : 0, title="DivType", display=display.data_window)
plot(totalConfluence, title="Confluence", display=display.data_window)
plot(patternQuality == "TEXTBOOK" ? 1 : patternQuality == "HIGH QUALITY" ? 2 : patternQuality == "VALID" ? 3 : 0, title="Quality", display=display.data_window)
plot(rsi, title="RSI", display=display.data_window)
plot(pressureStrength, title="Pressure", display=display.data_window)
plot(volRatio, title="VolRatio", display=display.data_window)
plot(isPivotLow ? 1 : isPivotHigh ? -1 : 0, title="Direction", display=display.data_window)
plot(institutionalActivity ? 1 : 0, title="InstActive", display=display.data_window)
plot(absorptionType == "ACCUMULATION" ? 1 : absorptionType == "DISTRIBUTION" ? -1 : 0, title="AbsType", display=display.data_window)
plot(barRange, title="BarRange", display=display.data_window)
plot(stopHuntDir == "BULL HUNT" ? 1 : stopHuntDir == "BEAR HUNT" ? -1 : 0, title="HuntDir", display=display.data_window)
plot(exhaustionDir == "SELL EXHAUST" ? 1 : exhaustionDir == "BUY EXHAUST" ? -1 : 0, title="ExhDir", display=display.data_window)

// ============================================================================
// SECTION 22: ALERT CONDITIONS
// ============================================================================

alertcondition(bullishPatternAlert, title="Bullish Pattern Detected", message="VMDM BULLISH | {{ticker}} {{interval}} | Price: {{close}}")
alertcondition(bearishPatternAlert, title="Bearish Pattern Detected", message="VMDM BEARISH | {{ticker}} {{interval}} | Price: {{close}}")
alertcondition(highConfluenceAlert, title="High Confluence Zone", message="VMDM CONFLUENCE | {{ticker}} {{interval}} | Price: {{close}}")
alertcondition(absorptionAlert, title="Institutional Absorption", message="VMDM ABSORPTION | {{ticker}} {{interval}} | Price: {{close}}")
alertcondition(stopHuntAlert, title="Stop Hunt Detected", message="VMDM STOP HUNT | {{ticker}} {{interval}} | Price: {{close}}")
alertcondition(exhaustionAlert, title="Exhaustion Pattern", message="VMDM EXHAUSTION | {{ticker}} {{interval}} | Price: {{close}}")
alertcondition(extremeBuyPressure, title="Extreme Buying Pressure", message="VMDM EXTREME BUY | {{ticker}} {{interval}} | Price: {{close}}")
alertcondition(extremeSellPressure, title="Extreme Selling Pressure", message="VMDM EXTREME SELL | {{ticker}} {{interval}} | Price: {{close}}")
alertcondition(anySignificantEvent, title="Any VMDM Event", message="VMDM EVENT | {{ticker}} {{interval}} | Price: {{close}}")

// ============================================================================
// END OF VMDM v1.0 PRODUCTION CODE
// ============================================================================
