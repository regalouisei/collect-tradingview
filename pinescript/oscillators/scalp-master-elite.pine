//@version=6
indicator(title = 'Scalp Master Elite üëë', overlay = true, max_labels_count = 500, max_lines_count = 500, max_bars_back = 500)

// === ATR PERSONALIZZABILE === 
atrMultiplier = input.float(3, title = 'ATR Channel Multiplier (0.5-100)', minval = 0.5, maxval = 100, step = 0.5, group = "ATR Bands Filter")
enableATRMode = input.bool(true, title = 'Show ATR Bands üìä', group = "ATR Bands Filter", tooltip = "When enabled, makes ATR bands visible.\nQuando attivo, rende visibili le bande ATR.")
enableATRBoundaryMode = input.bool(true, title = 'Enable ATR Boundary Mode üéØ', group = "ATR Bands Filter", tooltip = "When enabled: Triangle signals only INSIDE ATR bands, Target signals only OUTSIDE ATR bands.\nQuando attivo: Segnali triangolari solo DENTRO le bande ATR, Segnali target solo FUORI dalle bande ATR.")

// === EMA FILTER ===
enableEMAFilter   = input.bool(false, "Enable EMA Filter for IN Signals üìà", group = "EMA Filter", tooltip = "When enabled, bullish signals only appear when price is above the filter EMA, bearish signals only when price is below.\nQuando attivo, i segnali rialzisti appaiono solo sopra l'EMA filtro, i ribassisti solo sotto.")
emaFilterPeriod   = input.int(200, "EMA Filter Period", minval = 1, group = "EMA Filter")

// === TARGET SIGNALS TOGGLE ===
enableAdditionalTargets = true

// === STOP LOSS SETTINGS ===
enableStopLoss = input.bool(false, "Enable Stop Loss üõë", group="Stop Loss Settings", tooltip="When enabled, a stop loss line is shown for each IN trade. The trade closes early if the price hits the SL level.\nQuando attivo, mostra una linea di stop loss per ogni operazione IN. Il trade si chiude anticipatamente se il prezzo tocca il livello SL.")
slPips         = input.float(3000.0, "Stop Loss (pips)", minval=0.1, maxval=500000, step=0.5, group="Stop Loss Settings")
slLineColor    = input.color(color.rgb(255, 50, 50), "SL Line Color", group="Stop Loss Settings")

// === TP VISUAL SETTINGS ===
tpBullColor     = input.color(color.rgb(255, 0, 0, 0),   "Bearish Signal Color (Down Triangle) üîª", group="Visual Settings")
tpBearColor     = input.color(color.rgb(0, 255, 8, 0),   "Bullish Signal Color (Up Triangle) üî∫",   group="Visual Settings")
tpLineExtension = input.int(5, "TP Line Extension (bars)", minval=1, maxval=500, group="Visual Settings")
tpLineColor     = input.color(color.rgb(255, 255, 255),  "TP Line Color", group="Visual Settings")
showEntryExitLabels = input.bool(true,  "Show Entry/Exit Labels", group="Visual Settings")

// === NUOVO TOGGLE PIPS LABEL ===
showPipsOnLabel = input.bool(true, "Show Pips on Exit Label üìç", group="Visual Settings", tooltip="When enabled, shows the number of pips won or lost above the $ / ‚úó exit label.\nQuando attivo, mostra i pips vinti o persi sopra l'etichetta di uscita $ / ‚úó.")

// === TP INDICATORS TOGGLE ===
useTPRSI         = input.bool(true,  "Use RSI",                   group="TP Indicators")
useTPMACD        = input.bool(false, "Use MACD",                  group="TP Indicators")
useTPStoch       = input.bool(true,  "Use Stochastic",            group="TP Indicators")
useTPBB          = input.bool(false, "Use Bollinger Bands",       group="TP Indicators")
useTPSTrend      = input.bool(true,  "Use Supertrend",            group="TP Indicators")
useTPCCI         = input.bool(true,  "Use CCI",                   group="TP Indicators")
useTPEMA         = input.bool(false, "Use EMA Cross",             group="TP Indicators")
useTPPriceAction = input.bool(true,  "Use Price Action Breakout", group="TP Indicators")

minTPConfirmations = input.int(5, "Minimum Confirmations for TP Signal", minval=1, maxval=8, group="TP Settings", tooltip="Lower the number of confirmations to get more signals. Raise it for more selective and reliable signals.\nAbbassa il numero di conferme per ottenere pi√π segnali. Alzalo per segnali pi√π selettivi e affidabili.")

tpRsiLen = input.int(25, "RSI Length",           group="TP RSI Settings")
tpRsiOB  = input.int(55, "RSI Overbought Level", group="TP RSI Settings")
tpRsiOS  = input.int(45, "RSI Oversold Level",   group="TP RSI Settings")

tpMacdFastLen   = input.int(12, "MACD Fast Length",   group="TP MACD Settings")
tpMacdSlowLen   = input.int(26, "MACD Slow Length",   group="TP MACD Settings")
tpMacdSignalLen = input.int(9,  "MACD Signal Length", group="TP MACD Settings")

tpStochKLen    = input.int(14, "Stoch K Length", group="TP Stoch Settings")
tpStochDLen    = input.int(3,  "Stoch D Length", group="TP Stoch Settings")
tpStochSmoothK = input.int(3,  "Stoch Smooth K", group="TP Stoch Settings")

tpBBLen  = input.int(20,    "BB Length",            group="TP BB Settings")
tpBBMult = input.float(2.0, "BB StdDev Multiplier", group="TP BB Settings")

tpSTAtrMult = input.float(3.0, "Supertrend ATR Multiplier", group="TP Supertrend Settings")
tpSTAtrLen  = input.int(10,    "Supertrend ATR Length",     group="TP Supertrend Settings")

tpCCILen = input.int(20,   "CCI Length",     group="TP CCI Settings")
tpCCIOB  = input.int(100,  "CCI Overbought", group="TP CCI Settings")
tpCCIOS  = input.int(-100, "CCI Oversold",   group="TP CCI Settings")

tpEMAFastLen = input.int(12, "EMA Fast Length", group="TP EMA Settings")
tpEMASlowLen = input.int(26, "EMA Slow Length", group="TP EMA Settings")

tpLookBackBars = input.int(5, "Look Back Bars for Breakout", minval=1, maxval=50, group="TP Price Action Settings")

emaPeriod      = input.int(750, title='EMA Period', minval=1, group="Chart Customization")
emaThickness   = input.int(1, "EMA Thickness", minval=1, maxval=4, group="Chart Customization")
showEMA        = input.bool(true, "Show EMA Line", group="Chart Customization")
bandsThickness = input.int(1, "Bands Thickness", minval=1, maxval=4, group="Chart Customization")

showDetailedStats = input.bool(true, "Show Detailed Stats (Pips & P/L)", group="Win Rate Table")

enableTPBullAlert               = input.bool(true, 'Enable Bearish Signal Alert (Down Triangle) üîª', group="Alerts Settings üîä")
enableTPBearAlert               = input.bool(true, 'Enable Bullish Signal Alert (Up Triangle) üî∫',   group="Alerts Settings üîä")
enableAdditionalTargetBullAlert = input.bool(true, 'Enable Target Bullish Alert üéØ',                  group="Alerts Settings üîä")
enableAdditionalTargetBearAlert = input.bool(true, 'Enable Target Bearish Alert üéØ',                  group="Alerts Settings üîä")

// === TYPE FOR TP LINES ===
type TPLine
    line tp_line
    float price_level
    int start_bar

var array<TPLine> activeTPLines = array.new<TPLine>()

// === STATE VARIABLES ===
var bool   lastTriangleWasBull  = false
var bool   lastTriangleWasBear  = false
var bool   targetShownAfterBull = false
var bool   targetShownAfterBear = false
var string lastLabel            = "OUT"
var string lastSignalType       = "TARGET"

// === WIN RATE TRACKING ===
var float entryPriceBull      = na
var float entryPriceBear      = na
var int   totalTradesBull     = 0
var int   winTradesBull       = 0
var int   totalTradesBear     = 0
var int   winTradesBear       = 0
var float totalPipsBull       = 0.0
var float totalPipsBear       = 0.0
var float winPipsBull         = 0.0
var float lossPipsBull        = 0.0
var float winPipsBear         = 0.0
var float lossPipsBear        = 0.0
var float savedEntryPriceBull = na
var float savedEntryPriceBear = na

// === STOP LOSS STATE ===
var bool  slActive  = false
var float slPrice   = na
var bool  slIsBuy   = false
var line  slLine    = na
var label slLblObj  = na

// === EMA & ATR ===
ema         = ta.ema(close, emaPeriod)
smootherATR = ta.ema(ta.tr, 750)
upperBand   = ema + atrMultiplier * smootherATR
lowerBand   = ema - atrMultiplier * smootherATR

bool priceAboveEMA = close > ema

// === EMA FILTER CALCULATION ===
emaFilter        = ta.ema(close, emaFilterPeriod)
bool aboveEMAFilter = close > emaFilter
bool belowEMAFilter = close < emaFilter

// EMA filter gate: if disabled, always true
// tpBearSignal = BUY signal ‚Üí price must be ABOVE ema filter
// tpBullSignal = SELL signal ‚Üí price must be BELOW ema filter
bool emaGateBull = enableEMAFilter ? belowEMAFilter : true  // gate per segnali SELL (tpBullSignal)
bool emaGateBear = enableEMAFilter ? aboveEMAFilter : true  // gate per segnali BUY (tpBearSignal)

color upperFillDynamic = enableATRMode ? (priceAboveEMA ? color.new(#00bcd4, 90) : color.new(#dd326b, 90)) : (priceAboveEMA ? color.new(#00bcd4, 100) : color.new(#dd326b, 100))
color lowerFillDynamic = enableATRMode ? (priceAboveEMA ? color.new(#00bcd4, 90) : color.new(#dd326b, 90)) : (priceAboveEMA ? color.new(#00bcd4, 100) : color.new(#dd326b, 100))

// === TP INDICATORS ===
tpRsi = ta.rsi(close, tpRsiLen)

tpMacd       = ta.ema(close, tpMacdFastLen) - ta.ema(close, tpMacdSlowLen)
tpMacdSig    = ta.ema(tpMacd, tpMacdSignalLen)
tpMacdCrossU = ta.crossunder(tpMacd, tpMacdSig)
tpMacdCrossO = ta.crossover(tpMacd, tpMacdSig)

tpK          = ta.sma(ta.stoch(close, high, low, tpStochKLen), tpStochSmoothK)
tpD          = ta.sma(tpK, tpStochDLen)
tpStochCrossU = ta.crossunder(tpK, tpD)
tpStochCrossO = ta.crossover(tpK, tpD)

tpBasis = ta.sma(close, tpBBLen)
tpDev   = tpBBMult * ta.stdev(close, tpBBLen)
tpUpper = tpBasis + tpDev
tpLower = tpBasis - tpDev

[_, tpSTDir] = ta.supertrend(tpSTAtrMult, tpSTAtrLen)
tpCCI        = ta.cci(close, tpCCILen)

tpEMAFast   = ta.ema(close, tpEMAFastLen)
tpEMASlow   = ta.ema(close, tpEMASlowLen)
tpEmaCrossB = ta.crossover(tpEMAFast, tpEMASlow)
tpEmaCrossS = ta.crossunder(tpEMAFast, tpEMASlow)

tpPriceBull = close > close[tpLookBackBars]
tpPriceBear = close < close[tpLookBackBars]

// === TP LOGIC ===
tpRsiBull      = useTPRSI         and (tpRsi > tpRsiOB)
tpMacdBull     = useTPMACD        and tpMacdCrossU
tpStochBull    = useTPStoch       and tpStochCrossU and tpK > 80
tpBBBull       = useTPBB          and close > tpUpper
tpSTBull       = useTPSTrend      and tpSTDir == -1
tpCCIBull      = useTPCCI         and (tpCCI > tpCCIOB)
tpEmaBull      = useTPEMA         and tpEmaCrossS
tpPriceActBull = useTPPriceAction and tpPriceBull

tpRsiBear      = useTPRSI         and (tpRsi < tpRsiOS)
tpMacdBear     = useTPMACD        and tpMacdCrossO
tpStochBear    = useTPStoch       and tpStochCrossO and tpK < 20
tpBBBear       = useTPBB          and close < tpLower
tpSTBear       = useTPSTrend      and tpSTDir == 1
tpCCIBear      = useTPCCI         and (tpCCI < tpCCIOS)
tpEmaBear      = useTPEMA         and tpEmaCrossB
tpPriceActBear = useTPPriceAction and tpPriceBear

tpBullCount = (tpRsiBull?1:0)+(tpMacdBull?1:0)+(tpStochBull?1:0)+(tpBBBull?1:0)+(tpSTBull?1:0)+(tpCCIBull?1:0)+(tpEmaBull?1:0)+(tpPriceActBull?1:0)
tpBearCount = (tpRsiBear?1:0)+(tpMacdBear?1:0)+(tpStochBear?1:0)+(tpBBBear?1:0)+(tpSTBear?1:0)+(tpCCIBear?1:0)+(tpEmaBear?1:0)+(tpPriceActBear?1:0)

// === ATR BOUNDARY FILTERS ===
priceInsideATR  = close > lowerBand and close < upperBand
priceOutsideATR = close <= lowerBand or close >= upperBand

var bool tpATRFilterBull = true
var bool tpATRFilterBear = true

if enableATRBoundaryMode
    tpATRFilterBull := priceInsideATR
    tpATRFilterBear := priceInsideATR
else
    tpATRFilterBull := close <= upperBand
    tpATRFilterBear := close >= lowerBand

// Apply EMA filter gate to ATR filters (only for IN signals = triangle signals)
tpATRFilterBull := tpATRFilterBull and emaGateBull  // SELL filter
tpATRFilterBear := tpATRFilterBear and emaGateBear  // BUY filter

tpBullSignalRaw = (tpBullCount >= minTPConfirmations) and (tpBullCount > tpBearCount) and tpATRFilterBull
tpBearSignalRaw = not tpBullSignalRaw and (tpBearCount >= minTPConfirmations) and (tpBearCount > tpBullCount) and tpATRFilterBear

tpBullSignal = tpBullSignalRaw and not lastTriangleWasBear and lastSignalType == "TARGET"
tpBearSignal = tpBearSignalRaw and not lastTriangleWasBull and lastSignalType == "TARGET"

// === STOP LOSS: controlla se il prezzo ha toccato lo SL ===
var bool slHitThisBar = false
slHitThisBar := false

if enableStopLoss and slActive
    if slIsBuy and low <= slPrice
        slHitThisBar := true
    if not slIsBuy and high >= slPrice
        slHitThisBar := true

if slHitThisBar
    if slIsBuy
        label.new(bar_index, slPrice, "üõë SL", color=color.new(color.red, 20), textcolor=color.white, style=label.style_label_up, size=size.small)
    else
        label.new(bar_index, slPrice, "üõë SL", color=color.new(color.red, 20), textcolor=color.white, style=label.style_label_down, size=size.small)

    if slIsBuy
        if not na(entryPriceBear)
            totalTradesBear += 1
            float lossPd = (entryPriceBear - slPrice) / syminfo.mintick
            lossPipsBear   += math.abs(lossPd)
            entryPriceBear := na
    else
        if not na(entryPriceBull)
            totalTradesBull += 1
            float lossPd = (slPrice - entryPriceBull) / syminfo.mintick
            lossPipsBull   += math.abs(lossPd)
            entryPriceBull := na

    slActive     := false
    slPrice      := na
    lastLabel    := "OUT"
    lastSignalType := "TARGET"
    lastTriangleWasBull := false
    lastTriangleWasBear := false
    targetShownAfterBull := false
    targetShownAfterBear := false

// === UPDATE TRIANGLE STATE ===
if tpBullSignal
    lastTriangleWasBull := false
    lastTriangleWasBear := true
    targetShownAfterBull := false
    targetShownAfterBear := false
    lastSignalType := "TRIANGLE"

if tpBearSignal
    lastTriangleWasBear := false
    lastTriangleWasBull := true
    targetShownAfterBull := false
    targetShownAfterBear := false
    lastSignalType := "TRIANGLE"

// === TARGET SIGNALS ===
targetATRFilter = enableATRBoundaryMode ? priceOutsideATR : true

additionalTargetBull = not tpBullSignal and (tpBullCount >= minTPConfirmations) and (tpBullCount > tpBearCount) and lastTriangleWasBull and not targetShownAfterBull and targetATRFilter
additionalTargetBear = not tpBearSignal and (tpBearCount >= minTPConfirmations) and (tpBearCount > tpBullCount) and lastTriangleWasBear and not targetShownAfterBear and targetATRFilter

if additionalTargetBull
    targetShownAfterBull := true
    lastTriangleWasBull  := false
    lastSignalType       := "TARGET"
    savedEntryPriceBear  := entryPriceBear
    if not na(entryPriceBear)
        totalTradesBear += 1
        pd = (close - entryPriceBear) / syminfo.mintick
        totalPipsBear += pd
        if close > entryPriceBear
            winTradesBear += 1
            winPipsBear   += pd
        else
            lossPipsBear  += math.abs(pd)
        entryPriceBear := na

if additionalTargetBear
    targetShownAfterBear := true
    lastTriangleWasBear  := false
    lastSignalType       := "TARGET"
    savedEntryPriceBull  := entryPriceBull
    if not na(entryPriceBull)
        totalTradesBull += 1
        pd = (entryPriceBull - close) / syminfo.mintick
        totalPipsBull += pd
        if close < entryPriceBull
            winTradesBull += 1
            winPipsBull   += pd
        else
            lossPipsBull  += math.abs(pd)
        entryPriceBull := na

if tpBullSignal and not na(entryPriceBear)
    savedEntryPriceBear := entryPriceBear
    totalTradesBear += 1
    pd = (close - entryPriceBear) / syminfo.mintick
    totalPipsBear += pd
    if close > entryPriceBear
        winTradesBear += 1
        winPipsBear   += pd
    else
        lossPipsBear  += math.abs(pd)
    entryPriceBear := na

if tpBearSignal and not na(entryPriceBull)
    savedEntryPriceBull := entryPriceBull
    totalTradesBull += 1
    pd = (entryPriceBull - close) / syminfo.mintick
    totalPipsBull += pd
    if close < entryPriceBull
        winTradesBull += 1
        winPipsBull   += pd
    else
        lossPipsBull  += math.abs(pd)
    entryPriceBull := na

if tpBullSignal
    entryPriceBull := close
if tpBearSignal
    entryPriceBear := close

// === STOP LOSS: apri/chiudi su segnale ===
if enableStopLoss and not slHitThisBar
    float pipVal = syminfo.mintick * (syminfo.type == "forex" ? 10 : 1)
    float dist   = slPips * pipVal
    string slTxt = "SL " + str.tostring(slPips, "#.#") + " pips"
    bool anyClose = additionalTargetBull or additionalTargetBear

    if tpBearSignal and not slActive
        slPrice  := close - dist
        slIsBuy  := true
        slActive := true
        label.new(bar_index, slPrice, slTxt, color=color.new(slLineColor, 30), textcolor=color.white, style=label.style_label_right, size=size.small)

    else if tpBullSignal and not slActive
        slPrice  := close + dist
        slIsBuy  := false
        slActive := true
        label.new(bar_index, slPrice, slTxt, color=color.new(slLineColor, 30), textcolor=color.white, style=label.style_label_right, size=size.small)

    else if anyClose and slActive
        slActive := false
        slPrice  := na

plot(enableStopLoss and slActive and not na(slPrice) ? slPrice : na, "Stop Loss", color=slLineColor, linewidth=2, style=plot.style_linebr)

// === PLOT EMA AND BANDS ===
color emaDynColor   = priceAboveEMA ? color.new(#00bcd4, 10) : color.new(#dd326b, 10)
color bandsDynColor = enableATRMode ? (priceAboveEMA ? color.new(#00bcd4, 50) : color.new(#dd326b, 50)) : (priceAboveEMA ? color.new(#00bcd4, 100) : color.new(#dd326b, 100))

emaPlot       = plot(showEMA ? ema : na, 'EMA',        color=emaDynColor,   linewidth=emaThickness)
upperBandPlot = plot(upperBand,          'Upper Band', color=bandsDynColor, linewidth=bandsThickness)
lowerBandPlot = plot(lowerBand,          'Lower Band', color=bandsDynColor, linewidth=bandsThickness)

fill(emaPlot, upperBandPlot, color=upperFillDynamic)
fill(emaPlot, lowerBandPlot, color=lowerFillDynamic)

// === PLOT EMA FILTER LINE ===
plot(enableEMAFilter ? emaFilter : na, 'EMA Filter', color=color.new(color.yellow, 20), linewidth=2, style=plot.style_line)

// === PLOT SIGNALS ===
plotshape(tpBullSignal,        title='Bearish Signal (Down Triangle)', location=location.abovebar, color=tpBullColor, style=shape.triangledown, size=size.small)
plotshape(tpBearSignal,        title='Bullish Signal (Up Triangle)',   location=location.belowbar, color=tpBearColor, style=shape.triangleup,   size=size.small)
plotchar(additionalTargetBull, title='Target Bull', location=location.abovebar, color=color.rgb(255,0,0,0), char='üéØ', size=size.tiny)
plotchar(additionalTargetBear, title='Target Bear', location=location.belowbar, color=color.rgb(0,255,8,0), char='üéØ', size=size.tiny)

// === HELPER: crea etichetta uscita con pips opzionali ===
f_exitLabelAbove(idx, pnl, pips) =>
    mainTxt  = pnl > 0 ? "$" : "‚úó"
    pipsTxt  = showPipsOnLabel ? "\n" + (pips >= 0 ? "+" : "-") + str.tostring(math.round(math.abs(pips))) + " pips" : ""
    fullTxt  = mainTxt + pipsTxt
    bgCol    = pnl > 0 ? color.new(color.green, 50) : color.new(color.red, 50)
    label.new(idx, high, fullTxt, color=bgCol, textcolor=color.white, style=label.style_label_down, size=size.small, yloc=yloc.abovebar)

f_exitLabelBelow(idx, pnl, pips) =>
    mainTxt  = pnl > 0 ? "$" : "‚úó"
    pipsTxt  = showPipsOnLabel ? "\n" + (pips >= 0 ? "+" : "-") + str.tostring(math.round(math.abs(pips))) + " pips" : ""
    fullTxt  = mainTxt + pipsTxt
    bgCol    = pnl > 0 ? color.new(color.green, 50) : color.new(color.red, 50)
    label.new(idx, low, fullTxt, color=bgCol, textcolor=color.white, style=label.style_label_up, size=size.small, yloc=yloc.belowbar)

// === ENTRY/EXIT LABELS ===
if showEntryExitLabels
    bool hasSignal = tpBullSignal or tpBearSignal or additionalTargetBull or additionalTargetBear

    if hasSignal
        bool isEntry = lastLabel == "OUT"

        if tpBullSignal
            if isEntry
                label.new(bar_index, high, "IN", color=color.new(color.rgb(60,60,60),50), textcolor=color.white, style=label.style_label_down, size=size.small, yloc=yloc.abovebar)
                lastLabel := "IN"
            else
                float pnl  = not na(savedEntryPriceBear) ? close - savedEntryPriceBear : 0
                float pips = not na(savedEntryPriceBear) ? (close - savedEntryPriceBear) / syminfo.mintick : 0
                f_exitLabelAbove(bar_index, pnl, pips)
                lastLabel := "OUT"
                savedEntryPriceBear := na

        if tpBearSignal
            if isEntry
                label.new(bar_index, low, "IN", color=color.new(color.rgb(60,60,60),50), textcolor=color.white, style=label.style_label_up, size=size.small, yloc=yloc.belowbar)
                lastLabel := "IN"
            else
                float pnl  = not na(savedEntryPriceBull) ? savedEntryPriceBull - close : 0
                float pips = not na(savedEntryPriceBull) ? (savedEntryPriceBull - close) / syminfo.mintick : 0
                f_exitLabelBelow(bar_index, pnl, pips)
                lastLabel := "OUT"
                savedEntryPriceBull := na

        if additionalTargetBull
            if isEntry
                label.new(bar_index, high, "IN", color=color.new(color.rgb(60,60,60),50), textcolor=color.white, style=label.style_label_down, size=size.small, yloc=yloc.abovebar)
                lastLabel := "IN"
            else
                float pnl  = not na(savedEntryPriceBear) ? close - savedEntryPriceBear : 0
                float pips = not na(savedEntryPriceBear) ? (close - savedEntryPriceBear) / syminfo.mintick : 0
                f_exitLabelAbove(bar_index, pnl, pips)
                lastLabel := "OUT"
                savedEntryPriceBear := na

        if additionalTargetBear
            if isEntry
                label.new(bar_index, low, "IN", color=color.new(color.rgb(60,60,60),50), textcolor=color.white, style=label.style_label_up, size=size.small, yloc=yloc.belowbar)
                lastLabel := "IN"
            else
                float pnl  = not na(savedEntryPriceBull) ? savedEntryPriceBull - close : 0
                float pips = not na(savedEntryPriceBull) ? (savedEntryPriceBull - close) / syminfo.mintick : 0
                f_exitLabelBelow(bar_index, pnl, pips)
                lastLabel := "OUT"
                savedEntryPriceBull := na

// === TP LINES ===
if tpBullSignal or tpBearSignal or additionalTargetBull or additionalTargetBear
    tpLine = line.new(bar_index, close, bar_index + tpLineExtension, close, color=tpLineColor, width=1, style=line.style_solid)
    array.push(activeTPLines, TPLine.new(tpLine, close, bar_index))
    if array.size(activeTPLines) > 300
        line.delete(array.shift(activeTPLines).tp_line)

// === ALERTS ===
alertcondition(tpBullSignal and enableTPBullAlert,               title='Bearish Signal üîª', message='üîª BEARISH SIGNAL')
alertcondition(tpBearSignal and enableTPBearAlert,               title='Bullish Signal üî∫', message='üî∫ BULLISH SIGNAL')
alertcondition(additionalTargetBull and enableAdditionalTargetBullAlert, title='Target Bullish üéØ', message='üéØ TARGET BULLISH')
alertcondition(additionalTargetBear and enableAdditionalTargetBearAlert, title='Target Bearish üéØ', message='üéØ TARGET BEARISH')

if tpBullSignal and enableTPBullAlert
    alert('BEARISH SIGNAL (DOWN TRIANGLE)', alert.freq_once_per_bar_close)
if tpBearSignal and enableTPBearAlert
    alert('BULLISH SIGNAL (UP TRIANGLE)', alert.freq_once_per_bar_close)
if additionalTargetBull and enableAdditionalTargetBullAlert
    alert('TARGET BULLISH SIGNAL', alert.freq_once_per_bar_close)
if additionalTargetBear and enableAdditionalTargetBearAlert
    alert('TARGET BEARISH SIGNAL', alert.freq_once_per_bar_close)

// === WIN RATE TABLE ===
winRateBull  = totalTradesBull > 0 ? (winTradesBull / totalTradesBull) * 100 : 0
winRateBear  = totalTradesBear > 0 ? (winTradesBear / totalTradesBear) * 100 : 0
pipsDiffBuy  = winPipsBear - lossPipsBear
pipsDiffSell = winPipsBull - lossPipsBull
tableRows    = showDetailedStats ? 5 : 4

var table winRateTable = table.new(position.bottom_right, 6, tableRows, border_width=2, border_color=color.rgb(255,255,255,50), frame_width=1, frame_color=color.rgb(255,255,255,30))

if barstate.islast
    table.clear(winRateTable, 0, 0, 5, tableRows - 1)

    if not showDetailedStats
        table.cell(winRateTable, 0, 0, "Scalp Master Elite üëë", text_color=color.white, text_size=size.normal, bgcolor=color.new(#1e1e1e,0))
        table.merge_cells(winRateTable, 0, 0, 2, 0)
        table.cell(winRateTable, 0, 1, "Signal",   text_color=color.rgb(200,200,200), text_size=size.small,  bgcolor=color.new(#2d2d2d,0))
        table.cell(winRateTable, 1, 1, "Trades",   text_color=color.rgb(200,200,200), text_size=size.small,  bgcolor=color.new(#2d2d2d,0))
        table.cell(winRateTable, 2, 1, "Win Rate", text_color=color.rgb(200,200,200), text_size=size.small,  bgcolor=color.new(#2d2d2d,0))
        table.cell(winRateTable, 0, 2, "üî∫ Buy",  text_color=color.rgb(100,255,100), text_size=size.normal, bgcolor=color.new(#1e1e1e,0))
        table.cell(winRateTable, 1, 2, str.tostring(totalTradesBear), text_color=color.white, text_size=size.normal, bgcolor=color.new(#1e1e1e,0))
        table.cell(winRateTable, 2, 2, str.tostring(winRateBear,"#.##")+"%", text_color=(winRateBear>=50?color.rgb(0,255,0):color.rgb(255,50,50)), text_size=size.normal, bgcolor=color.new(#1e1e1e,0))
        table.cell(winRateTable, 0, 3, "üîª Sell", text_color=color.rgb(255,100,100), text_size=size.normal, bgcolor=color.new(#1e1e1e,0))
        table.cell(winRateTable, 1, 3, str.tostring(totalTradesBull), text_color=color.white, text_size=size.normal, bgcolor=color.new(#1e1e1e,0))
        table.cell(winRateTable, 2, 3, str.tostring(winRateBull,"#.##")+"%", text_color=(winRateBull>=50?color.rgb(0,255,0):color.rgb(255,50,50)), text_size=size.normal, bgcolor=color.new(#1e1e1e,0))
    else
        table.cell(winRateTable, 0, 0, "Scalp Master Elite üëë", text_color=color.white, text_size=size.normal, bgcolor=color.new(#1e1e1e,0))
        table.merge_cells(winRateTable, 0, 0, 5, 0)
        table.cell(winRateTable, 0, 1, "Signal",     text_color=color.rgb(200,200,200), text_size=size.small, bgcolor=color.new(#2d2d2d,0))
        table.cell(winRateTable, 1, 1, "Trades",     text_color=color.rgb(200,200,200), text_size=size.small, bgcolor=color.new(#2d2d2d,0))
        table.cell(winRateTable, 2, 1, "Win Rate",   text_color=color.rgb(200,200,200), text_size=size.small, bgcolor=color.new(#2d2d2d,0))
        table.cell(winRateTable, 3, 1, "Win Pips",   text_color=color.rgb(200,200,200), text_size=size.small, bgcolor=color.new(#2d2d2d,0))
        table.cell(winRateTable, 4, 1, "Loss Pips",  text_color=color.rgb(200,200,200), text_size=size.small, bgcolor=color.new(#2d2d2d,0))
        table.cell(winRateTable, 5, 1, "Difference", text_color=color.rgb(200,200,200), text_size=size.small, bgcolor=color.new(#2d2d2d,0))
        table.cell(winRateTable, 0, 2, "üî∫ Buy",    text_color=color.rgb(100,255,100), text_size=size.normal, bgcolor=color.new(#1e1e1e,0))
        table.cell(winRateTable, 1, 2, str.tostring(totalTradesBear), text_color=color.white, text_size=size.normal, bgcolor=color.new(#1e1e1e,0))
        table.cell(winRateTable, 2, 2, str.tostring(winRateBear,"#.##")+"%", text_color=(winRateBear>=50?color.rgb(0,255,0):color.rgb(255,50,50)), text_size=size.normal, bgcolor=color.new(#1e1e1e,0))
        table.cell(winRateTable, 3, 2, str.tostring(winPipsBear,"#.##"),  text_color=color.rgb(0,255,0),   text_size=size.normal, bgcolor=color.new(#1e1e1e,0))
        table.cell(winRateTable, 4, 2, str.tostring(lossPipsBear,"#.##"), text_color=color.rgb(255,50,50), text_size=size.normal, bgcolor=color.new(#1e1e1e,0))
        table.cell(winRateTable, 5, 2, str.tostring(pipsDiffBuy,"#.##"),  text_color=(pipsDiffBuy>=0?color.rgb(0,255,0):color.rgb(255,50,50)), text_size=size.normal, bgcolor=color.new(#1e1e1e,0))
        table.cell(winRateTable, 0, 3, "üîª Sell",   text_color=color.rgb(255,100,100), text_size=size.normal, bgcolor=color.new(#1e1e1e,0))
        table.cell(winRateTable, 1, 3, str.tostring(totalTradesBull), text_color=color.white, text_size=size.normal, bgcolor=color.new(#1e1e1e,0))
        table.cell(winRateTable, 2, 3, str.tostring(winRateBull,"#.##")+"%", text_color=(winRateBull>=50?color.rgb(0,255,0):color.rgb(255,50,50)), text_size=size.normal, bgcolor=color.new(#1e1e1e,0))
        table.cell(winRateTable, 3, 3, str.tostring(winPipsBull,"#.##"),  text_color=color.rgb(0,255,0),   text_size=size.normal, bgcolor=color.new(#1e1e1e,0))
        table.cell(winRateTable, 4, 3, str.tostring(lossPipsBull,"#.##"), text_color=color.rgb(255,50,50), text_size=size.normal, bgcolor=color.new(#1e1e1e,0))
        table.cell(winRateTable, 5, 3, str.tostring(pipsDiffSell,"#.##"), text_color=(pipsDiffSell>=0?color.rgb(0,255,0):color.rgb(255,50,50)), text_size=size.normal, bgcolor=color.new(#1e1e1e,0))
        float totalDiff   = pipsDiffBuy + pipsDiffSell
        float totalWR     = (totalTradesBull+totalTradesBear)>0 ? ((winTradesBull+winTradesBear)/(totalTradesBull+totalTradesBear))*100 : 0
        int   totalTrades = totalTradesBull + totalTradesBear
        table.cell(winRateTable, 0, 4, "Total", text_color=color.rgb(200,200,200), text_size=size.small, bgcolor=color.new(#2d2d2d,0))
        table.cell(winRateTable, 1, 4, str.tostring(totalTrades), text_color=color.white, text_size=size.normal, bgcolor=color.new(#2d2d2d,0))
        table.cell(winRateTable, 2, 4, str.tostring(totalWR,"#.##")+"%", text_color=(totalWR>=50?color.rgb(0,255,0):color.rgb(255,50,50)), text_size=size.normal, bgcolor=color.new(#2d2d2d,0))
        table.cell(winRateTable, 3, 4, str.tostring(winPipsBear+winPipsBull,"#.##"),   text_color=color.rgb(0,255,0),   text_size=size.normal, bgcolor=color.new(#2d2d2d,0))
        table.cell(winRateTable, 4, 4, str.tostring(lossPipsBear+lossPipsBull,"#.##"), text_color=color.rgb(255,50,50), text_size=size.normal, bgcolor=color.new(#2d2d2d,0))
        table.cell(winRateTable, 5, 4, str.tostring(totalDiff,"#.##"), text_color=(totalDiff>=0?color.rgb(0,255,0):color.rgb(255,50,50)), text_size=size.normal, bgcolor=color.new(#2d2d2d,0))
