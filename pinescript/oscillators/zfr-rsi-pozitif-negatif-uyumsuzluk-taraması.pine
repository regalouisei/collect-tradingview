// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Zafer_apiko

//@version=5

indicator(title="Zfr RSI Pozitif - Negatif Uyumsuzluk Taraması", format=format.price)


//grupSec = input.string(defval='ÖZEL LİSTE', options=['ÖZEL LİSTE'])
per = input.timeframe(defval='', title='PERİYOT',group = "Tarama yapmak istediğiniz periyotu seçin")
loc = input.int(defval=15, title='Konum Ayarı', minval = -30,maxval = 50 , step = 5,  group='Tablonun konumunu belirleyin')

len = input.int(title="RSI Period", minval=1, defval=13)
src = input(title="RSI Kaynağı", defval=close)
lbR = input(title="Negatif Uyumsuzluğu Kaç Bar Geride Arasın", defval=6, display = display.data_window)
lbL = input(title="Pozitif Uyumsuzluğu Kaç Bar Geride Arasın", defval=6, display = display.data_window)
rangeUpper = input(title="Geriye Dönük Maksimum Aralık", defval=60, display = display.data_window)
rangeLower = input(title="Geriye Dönük Minimum Aralık", defval=1, display = display.data_window)
plotBull = input(title="Pozitif Uyumsuzluk", defval=true, display = display.data_window)
plotHiddenBull = input(title="Gizli Pozitif Uyumsuzluk", defval=true, display = display.data_window)
plotBear = input(title="Negatif Uyumsuzluk", defval=true, display = display.data_window)
plotHiddenBear = input(title="Gizli Negatif Uyumsuzluk", defval=true, display = display.data_window)
bearColor = color.red
bullColor = color.green
hiddenBullColor = color.green
hiddenBearColor = color.red
textColor = color.white
noneColor = color.new(#ffffff, 100)
osc = ta.rsi(src, len)

// SMA Calculation
smaLength = input.int(title="WMA", minval=1, defval=9)
smaRSI = ta.wma(osc, smaLength)
plot(smaRSI, title="WMA", linewidth=2, color=color.yellow)


plot(osc, title="RSI", linewidth=2, color=color.rgb(21, 102, 201))
hline(50, title="Orta Hat", color=color.rgb(17, 190, 220), linestyle=hline.style_dotted)
obLevel = hline(70, title="Aşırı alım", color=#787B86, linestyle=hline.style_dotted)
osLevel = hline(30, title="Aşırı satım", color=#787B86, linestyle=hline.style_dotted)
fill(obLevel, osLevel, title="Arka plan", color=color.rgb(33, 150, 243, 90))

plFound = na(ta.pivotlow(osc, lbL, lbR)) ? false : true
phFound = na(ta.pivothigh(osc, lbL, lbR)) ? false : true
_inRange(cond) =>
    bars = ta.barssince(cond == true)
    rangeLower <= bars and bars <= rangeUpper

//------------------------------------------------------------------------------
// Regular Bullish - Düzenli Boğa
// Osc: Higher Low - Osc: Yüksek Düşük

oscHL = osc[lbR] > ta.valuewhen(plFound, osc[lbR], 1) and _inRange(plFound[1])

// Price: Lower Low

priceLL = low[lbR] < ta.valuewhen(plFound, low[lbR], 1)
bullCondAlert = priceLL and oscHL and plFound
bullCond = plotBull and bullCondAlert

plot(
     plFound ? osc[lbR] : na,
     offset=-lbR,
     title="Düzenli Boğa",
     linewidth=2,
     color=(bullCond ? bullColor : noneColor),
     display = display.pane
     )

plotshape(
     bullCond ? osc[lbR] : na,
     offset=-lbR,
     title="Düzenli Boğa Etiketi",
     text=" PU ",
     style=shape.labelup,
     location=location.absolute,
     color=bullColor,
     textcolor=textColor
     )

//------------------------------------------------------------------------------
// Hidden Bullish
// Osc: Lower Low

oscLL = osc[lbR] < ta.valuewhen(plFound, osc[lbR], 1) and _inRange(plFound[1])

// Price: Higher Low

priceHL = low[lbR] > ta.valuewhen(plFound, low[lbR], 1)
hiddenBullCondAlert = priceHL and oscLL and plFound
hiddenBullCond = plotHiddenBull and hiddenBullCondAlert

plot(
     plFound ? osc[lbR] : na,
     offset=-lbR,
     title="Gizli Boğa",
     linewidth=2,
     color=(hiddenBullCond ? hiddenBullColor : noneColor),
     display = display.pane
     )

plotshape(
     hiddenBullCond ? osc[lbR] : na,
     offset=-lbR,
     title="Gizli Boğa Etiketil",
     text=" Gizli PU ",
     style=shape.labelup,
     location=location.absolute,
     color=bullColor,
     textcolor=textColor
     )

//------------------------------------------------------------------------------
// Regular Bearish
// Osc: Lower High

oscLH = osc[lbR] < ta.valuewhen(phFound, osc[lbR], 1) and _inRange(phFound[1])

// Price: Higher High

priceHH = high[lbR] > ta.valuewhen(phFound, high[lbR], 1)

bearCondAlert = priceHH and oscLH and phFound
bearCond = plotBear and bearCondAlert

plot(
     phFound ? osc[lbR] : na,
     offset=-lbR,
     title="Düzenli Ayı",
     linewidth=2,
     color=(bearCond ? bearColor : noneColor),
     display = display.pane
     )

plotshape(
     bearCond ? osc[lbR] : na,
     offset=-lbR,
     title="Düzenli Ayı Etiketil",
     text=" NU ",
     style=shape.labeldown,
     location=location.absolute,
     color=bearColor,
     textcolor=textColor
     )

//------------------------------------------------------------------------------
// Hidden Bearish
// Osc: Higher High

oscHH = osc[lbR] > ta.valuewhen(phFound, osc[lbR], 1) and _inRange(phFound[1])

// Price: Lower High

priceLH = high[lbR] < ta.valuewhen(phFound, high[lbR], 1)

hiddenBearCondAlert = priceLH and oscHH and phFound
hiddenBearCond = plotHiddenBear and hiddenBearCondAlert

plot(
     phFound ? osc[lbR] : na,
     offset=-lbR,
     title="Gizli Ayı",
     linewidth=2,
     color=(hiddenBearCond ? hiddenBearColor : noneColor),
     display = display.pane
     )

plotshape(
     hiddenBearCond ? osc[lbR] : na,
     offset=-lbR,
     title="Gizli Ayı Etiketi",
     text=" Gizli NU ",
     style=shape.labeldown,
     location=location.absolute,
     color=bearColor,
     textcolor=textColor
     )

alertcondition(bullCondAlert, title='Regular Bullish Divergence', message="Mevcut çubuğun solunda yeni bir Düzenli Boğa Sapması, `Pivot Geri Bakış Sağ` çubuk sayısı bulundu")
alertcondition(hiddenBullCondAlert, title='Hidden Bullish Divergence', message='Found a new Hidden Bullish Divergence, `Pivot Lookback Right` number of bars to the left of the current bar')
alertcondition(bearCondAlert, title='Regular Bearish Divergence', message='Found a new Regular Bearish Divergence, `Pivot Lookback Right` number of bars to the left of the current bar')
alertcondition(hiddenBearCondAlert, title='Hidden Bearish Divergence', message='Found a new Hidden Bearish Divergence, `Pivot Lookback Right` number of bars to the left of the current bar')


///////////////// TARAMA

func() =>
   

    alim = bullCondAlert or hiddenBullCondAlert
    satim = bearCondAlert or hiddenBearCondAlert
    
    [alim , satim]


//GRUP VE TARANACAK HİSSE SAYISINI AYNI ŞEKİLDE DİLEDİĞİNİZ GİBİ ARTIRABİLİRSİNİZ.
sb1 =  input.symbol(title='1',  defval='BIST:XU030D1!')
sb2 =  input.symbol(title='2',  defval='BIST:AEFES')
sb3 =  input.symbol(title='3',  defval='BIST:AKBNK')
sb4 =  input.symbol(title='4',  defval='BIST:AKSEN')
sb5 =  input.symbol(title='5',  defval='BIST:ALARK')
sb6 =  input.symbol(title='6',  defval='BIST:ASTOR')
sb7 =  input.symbol(title='7',  defval='BIST:ASELS')
sb8 =  input.symbol(title='8',  defval='BIST:ARCLK')
sb9 =  input.symbol(title='9',  defval='BIST:BIMAS')
sb10 = input.symbol(title='10', defval='BIST:CIMSA')
sb11 = input.symbol(title='11', defval='BIST:DOAS')
sb12 = input.symbol(title='12', defval='BIST:DOHOL')
sb13 = input.symbol(title='13', defval='BIST:EKGYO')
sb14 = input.symbol(title='14', defval='BIST:ENJSA')
sb15 = input.symbol(title='15', defval='BIST:ENKAI')
sb16 = input.symbol(title='16', defval='BIST:EREGL')
sb17 = input.symbol(title='17', defval='BIST:GARAN')
sb18 = input.symbol(title='18', defval='BIST:HALKB')
sb19 = input.symbol(title='19', defval='BIST:KCHOL')
sb20 = input.symbol(title='20', defval='BIST:KOZAA')
sb21 = input.symbol(title='21', defval='BIST:KOZAL')
sb22 = input.symbol(title='22', defval='BIST:KRDMD')
sb23 = input.symbol(title='23', defval='BIST:MGROS')
sb24 = input.symbol(title='24', defval='BIST:OYAKC')
sb25 = input.symbol(title='25', defval='BIST:PETKM')
sb26 = input.symbol(title='26', defval='BIST:PGSUS')
sb27 = input.symbol(title='27', defval='BIST:SAHOL')
sb28 = input.symbol(title='28', defval='BIST:SASA')
sb29 = input.symbol(title='29', defval='BIST:SISE')
sb30 = input.symbol(title='30', defval='BIST:SOKM')
sb31 = input.symbol(title='31', defval='BIST:TCELL')
sb32 = input.symbol(title='32', defval='BIST:TTKOM')
sb33 = input.symbol(title='33', defval='BIST:THYAO')
sb34 = input.symbol(title='34', defval='BIST:TSKB')
sb35 = input.symbol(title='35', defval='BIST:TUPRS')
sb36 = input.symbol(title='36', defval='BIST:VAKBN')
sb37 = input.symbol(title='37', defval='BIST:VESTL')
sb38 = input.symbol(title='38', defval='BIST:YKBNK')
sb39 = input.symbol(title='39', defval='BIST:ISCTR')
sb40 = input.symbol(title='40', defval='BIST:HEKTS')



[v1,s1] = request.security(sb1, per, func(),ignore_invalid_symbol = true)
[v2,s2] = request.security(sb2, per, func(),ignore_invalid_symbol = true)
[v3,s3] = request.security(sb3, per, func(),ignore_invalid_symbol = true)
[v4,s4] = request.security(sb4, per, func(),ignore_invalid_symbol = true)
[v5,s5] = request.security(sb5, per, func(),ignore_invalid_symbol = true)
[v6,s6] = request.security(sb6, per, func(),ignore_invalid_symbol = true)
[v7,s7] = request.security(sb7, per, func(),ignore_invalid_symbol = true)
[v8,s8] = request.security(sb8, per, func(),ignore_invalid_symbol = true)
[v9,s9] = request.security(sb9, per, func(),ignore_invalid_symbol = true)
[v10,s10] = request.security(sb10, per, func(),ignore_invalid_symbol = true)
[v11,s11] = request.security(sb11, per, func(),ignore_invalid_symbol = true)
[v12,s12] = request.security(sb12, per, func(),ignore_invalid_symbol = true)
[v13,s13] = request.security(sb13, per, func(),ignore_invalid_symbol = true)
[v14,s14] = request.security(sb14, per, func(),ignore_invalid_symbol = true)
[v15,s15] = request.security(sb15, per, func(),ignore_invalid_symbol = true)
[v16,s16] = request.security(sb16, per, func(),ignore_invalid_symbol = true)
[v17,s17] = request.security(sb17, per, func(),ignore_invalid_symbol = true)
[v18,s18] = request.security(sb18, per, func(),ignore_invalid_symbol = true)
[v19,s19] = request.security(sb19, per, func(),ignore_invalid_symbol = true)
[v20,s20] = request.security(sb20, per, func(),ignore_invalid_symbol = true)
[v21,s21] = request.security(sb21, per, func(),ignore_invalid_symbol = true)
[v22,s22] = request.security(sb22, per, func(),ignore_invalid_symbol = true)
[v23,s23] = request.security(sb23, per, func(),ignore_invalid_symbol = true)
[v24,s24] = request.security(sb24, per, func(),ignore_invalid_symbol = true)
[v25,s25] = request.security(sb25, per, func(),ignore_invalid_symbol = true)
[v26,s26] = request.security(sb26, per, func(),ignore_invalid_symbol = true)
[v27,s27] = request.security(sb27, per, func(),ignore_invalid_symbol = true)
[v28,s28] = request.security(sb28, per, func(),ignore_invalid_symbol = true)
[v29,s29] = request.security(sb29, per, func(),ignore_invalid_symbol = true)
[v30,s30] = request.security(sb30, per, func(),ignore_invalid_symbol = true)
[v31,s31] = request.security(sb31, per, func(),ignore_invalid_symbol = true)
[v32,s32] = request.security(sb32, per, func(),ignore_invalid_symbol = true)
[v33,s33] = request.security(sb33, per, func(),ignore_invalid_symbol = true)
[v34,s34] = request.security(sb34, per, func(),ignore_invalid_symbol = true)
[v35,s35] = request.security(sb35, per, func(),ignore_invalid_symbol = true)
[v36,s36] = request.security(sb36, per, func(),ignore_invalid_symbol = true)
[v37,s37] = request.security(sb37, per, func(),ignore_invalid_symbol = true)
[v38,s38] = request.security(sb38, per, func(),ignore_invalid_symbol = true)
[v39,s39] = request.security(sb39, per, func(),ignore_invalid_symbol = true)
[v40,s40] = request.security(sb40, per, func(),ignore_invalid_symbol = true)




scr_label = 'Rsi Pu\n'
scr_label := v1 ? scr_label + syminfo.ticker(sb1) + '\n' : scr_label
scr_label := v2 ? scr_label + syminfo.ticker(sb2) + '\n' : scr_label
scr_label := v3 ? scr_label + syminfo.ticker(sb3) + '\n' : scr_label
scr_label := v4 ? scr_label + syminfo.ticker(sb4) + '\n' : scr_label
scr_label := v5 ? scr_label + syminfo.ticker(sb5) + '\n' : scr_label
scr_label := v6 ? scr_label + syminfo.ticker(sb6) + '\n' : scr_label
scr_label := v7 ? scr_label + syminfo.ticker(sb7) + '\n' : scr_label
scr_label := v8 ? scr_label + syminfo.ticker(sb8) + '\n' : scr_label
scr_label := v9 ? scr_label + syminfo.ticker(sb9) + '\n' : scr_label
scr_label := v10 ? scr_label + syminfo.ticker(sb10) + '\n' : scr_label
scr_label := v11 ? scr_label + syminfo.ticker(sb11) + '\n' : scr_label
scr_label := v12 ? scr_label + syminfo.ticker(sb12) + '\n' : scr_label
scr_label := v13 ? scr_label + syminfo.ticker(sb13) + '\n' : scr_label
scr_label := v14 ? scr_label + syminfo.ticker(sb14) + '\n' : scr_label
scr_label := v15 ? scr_label + syminfo.ticker(sb15) + '\n' : scr_label
scr_label := v16 ? scr_label + syminfo.ticker(sb16) + '\n' : scr_label
scr_label := v17 ? scr_label + syminfo.ticker(sb17) + '\n' : scr_label
scr_label := v18 ? scr_label + syminfo.ticker(sb18) + '\n' : scr_label
scr_label := v19 ? scr_label + syminfo.ticker(sb19) + '\n' : scr_label
scr_label := v20 ? scr_label + syminfo.ticker(sb20) + '\n' : scr_label
scr_label := v21 ? scr_label + syminfo.ticker(sb21) + '\n' : scr_label
scr_label := v22 ? scr_label + syminfo.ticker(sb22) + '\n' : scr_label
scr_label := v23 ? scr_label + syminfo.ticker(sb23) + '\n' : scr_label
scr_label := v24 ? scr_label + syminfo.ticker(sb24) + '\n' : scr_label
scr_label := v25 ? scr_label + syminfo.ticker(sb25) + '\n' : scr_label
scr_label := v26 ? scr_label + syminfo.ticker(sb26) + '\n' : scr_label
scr_label := v27 ? scr_label + syminfo.ticker(sb27) + '\n' : scr_label
scr_label := v28 ? scr_label + syminfo.ticker(sb28) + '\n' : scr_label
scr_label := v29 ? scr_label + syminfo.ticker(sb29) + '\n' : scr_label
scr_label := v30 ? scr_label + syminfo.ticker(sb30) + '\n' : scr_label
scr_label := v31 ? scr_label + syminfo.ticker(sb31) + '\n' : scr_label
scr_label := v32 ? scr_label + syminfo.ticker(sb32) + '\n' : scr_label
scr_label := v33 ? scr_label + syminfo.ticker(sb33) + '\n' : scr_label
scr_label := v34 ? scr_label + syminfo.ticker(sb34) + '\n' : scr_label
scr_label := v35 ? scr_label + syminfo.ticker(sb35) + '\n' : scr_label
scr_label := v36 ? scr_label + syminfo.ticker(sb36) + '\n' : scr_label
scr_label := v37 ? scr_label + syminfo.ticker(sb37) + '\n' : scr_label
scr_label := v38 ? scr_label + syminfo.ticker(sb38) + '\n' : scr_label
scr_label := v39 ? scr_label + syminfo.ticker(sb39) + '\n' : scr_label
scr_label := v40 ? scr_label + syminfo.ticker(sb40) + '\n' : scr_label

lab_1 = label.new(bar_index + loc,50, scr_label, color=color.green, textcolor=color.white, style=label.style_label_center)
label.delete(lab_1[1])


if str.length(scr_label) > 8
    alert(scr_label,alert.freq_once_per_bar_close)
//------------------------------------------------------

scr_label1 = 'Rsi Nu\n'
scr_label1 := s1 ? scr_label1 + syminfo.ticker(sb1) + '\n' : scr_label1
scr_label1 := s2 ? scr_label1 + syminfo.ticker(sb2) + '\n' : scr_label1
scr_label1 := s3 ? scr_label1 + syminfo.ticker(sb3) + '\n' : scr_label1
scr_label1 := s4 ? scr_label1 + syminfo.ticker(sb4) + '\n' : scr_label1
scr_label1 := s5 ? scr_label1 + syminfo.ticker(sb5) + '\n' : scr_label1
scr_label1 := s6 ? scr_label1 + syminfo.ticker(sb6) + '\n' : scr_label1
scr_label1 := s7 ? scr_label1 + syminfo.ticker(sb7) + '\n' : scr_label1
scr_label1 := s8 ? scr_label1 + syminfo.ticker(sb8) + '\n' : scr_label1
scr_label1 := s9 ? scr_label1 + syminfo.ticker(sb9) + '\n' : scr_label1
scr_label1 := s10 ? scr_label1 + syminfo.ticker(sb10) + '\n' : scr_label1
scr_label1 := s11 ? scr_label1 + syminfo.ticker(sb11) + '\n' : scr_label1
scr_label1 := s12 ? scr_label1 + syminfo.ticker(sb12) + '\n' : scr_label1
scr_label1 := s13 ? scr_label1 + syminfo.ticker(sb13) + '\n' : scr_label1
scr_label1 := s14 ? scr_label1 + syminfo.ticker(sb14) + '\n' : scr_label1
scr_label1 := s15 ? scr_label1 + syminfo.ticker(sb15) + '\n' : scr_label1
scr_label1 := s16 ? scr_label1 + syminfo.ticker(sb16) + '\n' : scr_label1
scr_label1 := s17 ? scr_label1 + syminfo.ticker(sb17) + '\n' : scr_label1
scr_label1 := s18 ? scr_label1 + syminfo.ticker(sb18) + '\n' : scr_label1
scr_label1 := s19 ? scr_label1 + syminfo.ticker(sb19) + '\n' : scr_label1
scr_label1 := s20 ? scr_label1 + syminfo.ticker(sb20) + '\n' : scr_label1
scr_label1 := s21 ? scr_label1 + syminfo.ticker(sb21) + '\n' : scr_label1
scr_label1 := s22 ? scr_label1 + syminfo.ticker(sb22) + '\n' : scr_label1
scr_label1 := s23 ? scr_label1 + syminfo.ticker(sb23) + '\n' : scr_label1
scr_label1 := s24 ? scr_label1 + syminfo.ticker(sb24) + '\n' : scr_label1
scr_label1 := s25 ? scr_label1 + syminfo.ticker(sb25) + '\n' : scr_label1
scr_label1 := s26 ? scr_label1 + syminfo.ticker(sb26) + '\n' : scr_label1
scr_label1 := s27 ? scr_label1 + syminfo.ticker(sb27) + '\n' : scr_label1
scr_label1 := s28 ? scr_label1 + syminfo.ticker(sb28) + '\n' : scr_label1
scr_label1 := s29 ? scr_label1 + syminfo.ticker(sb29) + '\n' : scr_label1
scr_label1 := s30 ? scr_label1 + syminfo.ticker(sb30) + '\n' : scr_label1
scr_label1 := s31 ? scr_label1 + syminfo.ticker(sb31) + '\n' : scr_label1
scr_label1 := s32 ? scr_label1 + syminfo.ticker(sb32) + '\n' : scr_label1
scr_label1 := s33 ? scr_label1 + syminfo.ticker(sb33) + '\n' : scr_label1
scr_label1 := s34 ? scr_label1 + syminfo.ticker(sb34) + '\n' : scr_label1
scr_label1 := s35 ? scr_label1 + syminfo.ticker(sb35) + '\n' : scr_label1
scr_label1 := s36 ? scr_label1 + syminfo.ticker(sb36) + '\n' : scr_label1
scr_label1 := s37 ? scr_label1 + syminfo.ticker(sb37) + '\n' : scr_label1
scr_label1 := s38 ? scr_label1 + syminfo.ticker(sb38) + '\n' : scr_label1
scr_label1 := s39 ? scr_label1 + syminfo.ticker(sb39) + '\n' : scr_label1
scr_label1 := s40 ? scr_label1 + syminfo.ticker(sb40) + '\n' : scr_label1

lab_2 = label.new(bar_index+25 + loc,50, scr_label1, color=color.red, textcolor=color.white, style=label.style_label_center)
label.delete(lab_2[1])


if str.length(scr_label1) > 8
    alert(scr_label1,alert.freq_once_per_bar_close)
//------------------------------------------------------
