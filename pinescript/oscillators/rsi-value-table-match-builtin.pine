//@version=5
indicator("RSI Value Table – match builtin", overlay=true)

// ==== INPUT ====
rsiLen       = input.int(7,  "RSI - Periodo", minval=2, maxval=100)
lockTF       = input.string("D", "Timeframe RSI (vuoto = TF grafico)",options = ["", "5", "15", "30", "60", "240", "D", "W", "M"])
useSmooth    = input.bool(false, "Smussamento post-RSI (non standard)")
smoothLen    = input.int(3, "Lunghezza EMA smussamento", minval=1, maxval=20)
showBand     = input.bool(true, "Colora cella in base alla zona")
posizione    = input.string("bottom_right", "Posizione tabella",options = ["top_left","top_right","bottom_left","bottom_right"])

// ==== RSI (allineato al built-in) ====
// Se lockTF è vuoto, usa il timeframe del grafico; altrimenti usa quello scelto.
// Usiamo sempre security con gaps_off e lookahead_off per evitare discrepanze visive.
tfRSI  = (lockTF == "" ? timeframe.period : lockTF)
rsiRaw = request.security(syminfo.tickerid, tfRSI,ta.rsi(close, rsiLen),gaps = barmerge.gaps_off,lookahead = barmerge.lookahead_off)
// Smoothing opzionale (NON standard): si applica dopo il calcolo del valore “match builtin”.
rsiVal = useSmooth ? ta.ema(rsiRaw, smoothLen) : rsiRaw

// ==== COLORI ZONA RSI ====
bgZone = rsiVal > 50 ? color.new(color.green, 78) :
         rsiVal < 50 ? color.new(color.red,   78) :
                       color.new(color.yellow,78)

// ==== TABELLA ====
var table tb = na
if na(tb)
    posTab = switch posizione
        "top_left"     => position.top_left
        "top_right"    => position.top_right
        "bottom_left"  => position.bottom_left
        =>                position.bottom_right
    tb := table.new(posTab, 2, 3,border_width = 1,frame_color  = color.new(color.gray, 0),border_color = color.new(color.gray, 0))


// Etichette colonna sinistra
labelRSI = "RSI (" + str.tostring(rsiLen) + (useSmooth ? ", EMA " + str.tostring(smoothLen) : "") + ")"
table.cell(tb, 0, 1, labelRSI, text_color=color.white, bgcolor=color.new(color.black, 0))
table.cell(tb, 0, 2, "Timeframe", text_color=color.white, bgcolor=color.new(color.black, 0))

// Valori colonna destra
table.cell(tb, 1, 1, str.tostring(rsiVal, "#.##"),
     text_color=color.white,
     bgcolor=showBand ? bgZone : color.new(color.black, 0))

tfLabel = (lockTF == "" ? "Grafico" : lockTF)
table.cell(tb, 1, 2, tfLabel, text_color=color.white, bgcolor=color.new(color.black, 0))

// ==== ALERT SULLA SOGLIA 50 ====
alertcondition(ta.crossover(rsiVal, 50), "RSI > 50", "RSI cross up 50")
alertcondition(ta.crossunder(rsiVal, 50), "RSI < 50", "RSI cross down 50")
