//@version=5
indicator('IronRod Trigger System', shorttitle='IronRod', overlay=false, max_bars_back=500)

// ════════════════════════════════════════════════════════════════════════════════════
// IronRod Trigger System
// Created by: NPR21
// Version: 5.0 FINAL
// Last Updated: January 09, 2025
// 
// Description: Stochastic Momentum Index (SMI) oscillator with AGAIG pivot detection.
// Combines SMI trend analysis with AGAIG's fractal price turn detection for complete
// trading system with early entry signals and trend confirmation.
//
// All Rights Reserved
// ════════════════════════════════════════════════════════════════════════════════════

//====================
// INPUTS - SMI Settings
//====================
percentKLength = input.int(5, 'Percent K Length', minval=1, group='SMI Settings')
percentDLength = input.int(4, 'Percent D Length', minval=1, group='SMI Settings')
smiLimit = input.int(30, 'Chop Zone (±)', minval=1, group='SMI Settings')
smibarbufr = input.int(4, 'SMI Bar Buffer', minval=0, group='SMI Settings')
histWidth = input.int(1, 'Histogram Width', minval=1, maxval=10, group='SMI Settings')

//====================
// INPUTS - AGAIG Arrow Settings
//====================
length = input.int(5, 'Length for Arrows', minval=1, maxval=20, group='AGAIG Settings')
ignore_last_bar = input.bool(true, 'Ignore Last Bar', group='AGAIG Settings')
show_Arrows = input.bool(true, 'Show Triangle Arrows', group='AGAIG Settings')
show_Labels = input.bool(false, 'Show Buy/Sell Labels', group='AGAIG Settings')
show_Dots = input.bool(false, 'Show Pivot Dots', group='AGAIG Settings')
nP = input.int(13, 'Pivot Period', minval=1, group='AGAIG Settings')

// Label styling
buyOffsetTicks = input.int(title='BUY offset', defval=15, minval=0, group='AGAIG Settings')
sellOffsetTicks = input.int(title='SELL offset', defval=15, minval=0, group='AGAIG Settings')
buyLabelBgColor = input.color(title='BUY label background', defval=color.rgb(0, 50, 45), group='AGAIG Settings')
sellLabelBgColor = input.color(title='SELL label background', defval=color.rgb(80, 0, 0), group='AGAIG Settings')
buyTextColor = input.color(title='BUY text color', defval=color.white, group='AGAIG Settings')
sellTextColor = input.color(title='SELL text color', defval=color.yellow, group='AGAIG Settings')
labelSizeOpt = input.string(title='Label size', defval='normal', options=['tiny', 'small', 'normal', 'large', 'huge'], group='AGAIG Settings')

//====================
// INPUTS - Color Settings
//====================
upLineColor = input.color(color.rgb(0, 255, 0), 'Up Line Color', group='Colors')
downLineColor = input.color(color.rgb(255, 0, 0), 'Down Line Color', group='Colors')
neutralLineColor = input.color(color.rgb(192, 192, 192), 'Neutral Line Color', group='Colors')
histUpColor = input.color(color.rgb(0, 150, 70), 'Histogram Up Color', group='Colors')
histDownColor = input.color(color.rgb(200, 30, 30), 'Histogram Down Color', group='Colors')
histNeutralColor = input.color(color.rgb(140, 140, 140), 'Histogram Neutral Color', group='Colors')
arrowUpColor = input.color(color.rgb(0, 255, 0), 'Buy Arrow Color', group='Colors')
arrowDownColor = input.color(color.rgb(255, 0, 0), 'Sell Arrow Color', group='Colors')

//====================
// SMI CALCULATION
//====================
minLow = ta.lowest(low, percentKLength)
maxHigh = ta.highest(high, percentKLength)
relDiff = close - (maxHigh + minLow) / 2.0
diff = maxHigh - minLow
avgRel = ta.ema(ta.ema(relDiff, percentDLength), percentDLength)
avgDiff = ta.ema(ta.ema(diff, percentDLength), percentDLength)
smi = avgDiff != 0.0 ? (avgRel / (avgDiff / 2.0)) * 100.0 : 0.0
avgSmi = ta.ema(smi, percentDLength)

//====================
// SMI COLORS
//====================
smiCol = smi > smi[1] ? upLineColor : smi < smi[1] ? downLineColor : neutralLineColor
avgCol = avgSmi > avgSmi[1] ? upLineColor : avgSmi < avgSmi[1] ? downLineColor : neutralLineColor

histCol = (smi + smibarbufr) >= smi[1] and smi > -smiLimit ? histUpColor : (smi - smibarbufr) <= smi[1] and smi < smiLimit ? histDownColor : histNeutralColor

chopCol = (smi > -smiLimit and smi < smiLimit) ? color.orange : color.rgb(0, 150, 200)
boundCol = color.gray
cloudCol = color.new(color.rgb(210, 210, 210), 70)

//====================
// AGAIG PIVOT DETECTION (EXACT COPY)
//====================
lblSize = labelSizeOpt == 'tiny' ? size.tiny : labelSizeOpt == 'small' ? size.small : labelSizeOpt == 'normal' ? size.normal : labelSizeOpt == 'large' ? size.large : size.huge

// HIGH POINT DETECTION
isValidHighPoint(int barsAgo) =>
    if bar_index < length + barsAgo
        false
    else
        checkHigh = high[barsAgo]
        isHigherThanPrevious = true
        for i = 1 to length - 1
            if checkHigh <= high[barsAgo + i]
                isHigherThanPrevious := false
                break
        highestInPeriod = checkHigh
        for i = 1 to length - 1
            if high[barsAgo + i] > highestInPeriod
                highestInPeriod := high[barsAgo + i]
            if high[barsAgo - i] > highestInPeriod
                highestInPeriod := high[barsAgo - i]
        isHigherThanPrevious and checkHigh == highestInPeriod

// LOW POINT DETECTION
isValidLowPoint(int barsAgo) =>
    if bar_index < length + barsAgo
        false
    else
        checkLow = low[barsAgo]
        isLowerThanPrevious = true
        for i = 1 to length - 1
            if checkLow >= low[barsAgo + i]
                isLowerThanPrevious := false
                break
        lowestInPeriod = checkLow
        for i = 1 to length - 1
            if low[barsAgo + i] < lowestInPeriod
                lowestInPeriod := low[barsAgo + i]
            if low[barsAgo - i] < lowestInPeriod
                lowestInPeriod := low[barsAgo - i]
        isLowerThanPrevious and checkLow == lowestInPeriod

// Calculate with proper offset
offset = length - 1
highPoint = isValidHighPoint(offset)
lowPoint = isValidLowPoint(offset)

// PIVOT DETECTION (for dots)
pivotHigh = false
pivotLow = false

if bar_index >= nP
    isHigh = true
    for i = 1 to nP
        if high <= high[i]
            isHigh := false
            break
    pivotHigh := isHigh and high == ta.highest(high, nP)

    isLow = true
    for i = 1 to nP
        if low >= low[i]
            isLow := false
            break
    pivotLow := isLow and low == ta.lowest(low, nP)

//====================
// ARROW POSITIONING (in oscillator space with offset)
//====================
buyArrowY = lowPoint ? smi[offset] - buyOffsetTicks : na
sellArrowY = highPoint ? smi[offset] + sellOffsetTicks : na

//====================
// PLOTS - SMI OSCILLATOR
//====================
// 1. Chop zone cloud
u = plot(float(smiLimit), title='Upper', color=boundCol, linewidth=1)
l = plot(float(-smiLimit), title='Lower', color=boundCol, linewidth=1)
fill(u, l, color=cloudCol, title='Chop Cloud')

// 2. Histogram
plot(avgSmi, title='SMIBAR (Histogram)', style=plot.style_columns, color=histCol, linewidth=histWidth)

// 3. Zero line
plot(0.0, title='Zero / ChopBand', color=chopCol, linewidth=5)

// 4. SMI lines
plot(smi, title='SMI', color=smiCol, linewidth=2)
plot(avgSmi, title='AvgSMI', color=avgCol, linewidth=3)

//====================
// PLOTS - AGAIG ARROWS & LABELS
//====================
// Triangle arrows (positioned away from lines)
plotshape(show_Arrows ? buyArrowY : na, title='Buy Arrow', style=shape.triangleup, location=location.absolute, color=arrowUpColor, size=size.small, offset=-offset)

plotshape(show_Arrows ? sellArrowY : na, title='Sell Arrow', style=shape.triangledown, location=location.absolute, color=arrowDownColor, size=size.small, offset=-offset)

// Buy/Sell Labels
if show_Labels and lowPoint
    label.new(bar_index - offset, buyArrowY - 5, 'BUY', style=label.style_label_up, color=buyLabelBgColor, textcolor=buyTextColor, size=lblSize)

if show_Labels and highPoint
    label.new(bar_index - offset, sellArrowY + 5, 'SELL', style=label.style_label_down, color=sellLabelBgColor, textcolor=sellTextColor, size=lblSize)

// Pivot dots
pivotHighY = pivotHigh ? smi + 10 : na
pivotLowY = pivotLow ? smi - 10 : na

plotshape(show_Dots ? pivotHighY : na, title='Pivot High Dot', style=shape.circle, location=location.absolute, color=color.white, size=size.tiny)

plotshape(show_Dots ? pivotLowY : na, title='Pivot Low Dot', style=shape.circle, location=location.absolute, color=color.white, size=size.tiny)
