//@version=6
indicator(title="Stochastic", shorttitle="Stoch", format=format.price, precision=2)

// === Inputs ===
periodK        = input.int(5,    title="%K Length",    minval=1)
smoothK        = input.int(3,    title="%K Smoothing", minval=1)
periodD        = input.int(3,    title="%D Smoothing", minval=1)
showCross      = input.bool(true, title="Show Dots When %K Crosses %D?")
k_colorChange  = input.bool(true, title="Change %K Line Color on Signal Line Cross?")
showCandleColor= input.bool(true, title="ðŸ•¯ï¸ Color Candlesticks by Stochastic Signal?")

// === Divergence Inputs ===
grpDiv       = "â”€â”€ Divergence â”€â”€"
showRegBull  = input.bool(true,  title="Regular Bullish  (â†— Stoch, â†˜ Price)", group=grpDiv)
showRegBear  = input.bool(true,  title="Regular Bearish  (â†˜ Stoch, â†— Price)", group=grpDiv)
showHidBull  = input.bool(false, title="Hidden  Bullish  (â†˜ Stoch, â†— Price)", group=grpDiv)
showHidBear  = input.bool(false, title="Hidden  Bearish  (â†— Stoch, â†˜ Price)", group=grpDiv)
pivotLen     = input.int(5, title="Pivot Lookback Length", minval=2, maxval=20, group=grpDiv)
colRegBull   = input.color(color.new(color.lime,   0), title="Regular Bullish Color", group=grpDiv)
colRegBear   = input.color(color.new(color.red,    0), title="Regular Bearish Color", group=grpDiv)
colHidBull   = input.color(color.new(color.aqua,   0), title="Hidden  Bullish Color", group=grpDiv)
colHidBear   = input.color(color.new(color.orange, 0), title="Hidden  Bearish Color", group=grpDiv)
divLineWidth = input.int(2, title="Line Width", minval=1, maxval=4, group=grpDiv)

// === Stochastic Calculation ===
k = ta.sma(ta.stoch(close, high, low, periodK), smoothK)
d = ta.sma(k, periodD)

// === Cross â€” dihitung di level global ===
kCrossD = ta.cross(k, d)

// === Line Colors ===
k_IsAbove = k >= d
k_color   = k_colorChange ? (k_IsAbove ? color.lime : color.red) : #2962FF
d_color   = #FFEB3B

// === Plots ===
plot(k, title="%K", color=k_color, linewidth=2)
plot(d, title="%D", color=d_color, linewidth=2)
plot(showCross and kCrossD ? d : na, title="Cross", style=plot.style_circles, linewidth=4, color=k_color)

// === Horizontal Lines & Background ===
hUpper = hline(80, "Upper Band",  color=#787B86)
hline(50,          "Middle Band", color=color.new(#787B86, 50))
hLower = hline(20, "Lower Band",  color=#787B86)
fill(hUpper, hLower, color=color.rgb(33, 150, 243, 90), title="Background")

// === Candlestick Color ===
candleColor = k > d and k > 50 ? color.lime   :
              k > d and k < 50 ? color.aqua   :
              k < d and k > 50 ? color.orange :
              color.red
barcolor(showCandleColor ? candleColor : na, title="Candlestick Color")

// === Divergence Engine ===
ph_k = ta.pivothigh(k, pivotLen, pivotLen)
pl_k = ta.pivotlow (k, pivotLen, pivotLen)

var float prev_ph_k_val     = na
var int   prev_ph_k_bar     = na
var float prev_ph_price_val = na

var float prev_pl_k_val     = na
var int   prev_pl_k_bar     = na
var float prev_pl_price_val = na

// â”€â”€ Pivot HIGH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if not na(ph_k)
    curr_bar   = bar_index - pivotLen
    curr_price = high[pivotLen]

    if not na(prev_ph_k_val)
        stoch_lh = ph_k       < prev_ph_k_val
        stoch_hh = ph_k       > prev_ph_k_val
        price_hh = curr_price > prev_ph_price_val
        price_lh = curr_price < prev_ph_price_val

        if showRegBear and price_hh and stoch_lh
            line.new(prev_ph_k_bar, prev_ph_k_val, curr_bar, ph_k,
                     color=colRegBear, width=divLineWidth, style=line.style_dashed)
        if showHidBear and price_lh and stoch_hh
            line.new(prev_ph_k_bar, prev_ph_k_val, curr_bar, ph_k,
                     color=colHidBear, width=divLineWidth, style=line.style_dotted)

    prev_ph_k_val     := ph_k
    prev_ph_k_bar     := bar_index - pivotLen
    prev_ph_price_val := curr_price

// â”€â”€ Pivot LOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if not na(pl_k)
    curr_bar   = bar_index - pivotLen
    curr_price = low[pivotLen]

    if not na(prev_pl_k_val)
        stoch_hl = pl_k       > prev_pl_k_val
        stoch_ll = pl_k       < prev_pl_k_val
        price_ll = curr_price < prev_pl_price_val
        price_hl = curr_price > prev_pl_price_val

        if showRegBull and price_ll and stoch_hl
            line.new(prev_pl_k_bar, prev_pl_k_val, curr_bar, pl_k,
                     color=colRegBull, width=divLineWidth, style=line.style_dashed)
        if showHidBull and price_hl and stoch_ll
            line.new(prev_pl_k_bar, prev_pl_k_val, curr_bar, pl_k,
                     color=colHidBull, width=divLineWidth, style=line.style_dotted)

    prev_pl_k_val     := pl_k
    prev_pl_k_bar     := bar_index - pivotLen
    prev_pl_price_val := curr_price
