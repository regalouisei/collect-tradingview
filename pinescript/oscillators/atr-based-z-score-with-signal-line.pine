//@version=5
indicator(title="ATR-Based Z-Score with Signal Line", shorttitle="ATR-based Z-Score", overlay=false)

// --- Inputs ---
pricePeriod  = input.int(40, title="Price MA Period", minval=1)
atrPeriod    = input.int(300, title="ATR Period (Volatility)", minval=1)
signalPeriod = input.int(15, title="Signal MA Period", minval=1)

// --- Calculations ---
// 1. Der gleitende Durchschnitt des Preises
xMA = ta.sma(close, pricePeriod)

// 2. Der ATR als Volatilitäts-Richtschnur (statt Standardabweichung)
xATR = ta.atr(atrPeriod)

// 3. Der modifizierte Z-Score (Abstand zum MA geteilt durch ATR)
// Wir prüfen, ob xATR > 0 ist, um Division durch Null zu vermeiden
nRes = xATR > 0 ? (close - xMA) / xATR : 0

// 4. Die Signallinie (Durchschnitt des Z-Scores)
signalLine = ta.sma(nRes, signalPeriod)

// --- Plotting ---
// Null-Linie zur Orientierung
hline(0, "Zero Line", color=color.new(color.gray, 50), linestyle=hline.style_solid)

// Extreme Zonen (optional, zur besseren Visualisierung)
upperLimit = hline(2, "Upper Extreme", color=color.new(color.red, 60), linestyle=hline.style_dashed)
lowerLimit = hline(-2, "Lower Extreme", color=color.new(color.green, 60), linestyle=hline.style_dashed)
fill(upperLimit, lowerLimit, color=color.new(color.blue, 95), title="Normal Range")

// Die beiden Linien
plot(nRes, color=color.blue, title="ATR Z-Score", linewidth=2)
plot(signalLine, color=color.orange, title="Signal Line", linewidth=1)
