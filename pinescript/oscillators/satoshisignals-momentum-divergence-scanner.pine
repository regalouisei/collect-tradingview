//@version=6
indicator("Momentum Divergence Scanner — Catch Reversals", shorttitle="RSI Div", overlay=false,
          max_lines_count=200, max_labels_count=200)

// ─────────────────────────────────────────────────────────
//  INPUTS
// ─────────────────────────────────────────────────────────

var string GRP_RSI = "RSI Settings"
rsi_len  = input.int(14,       "Length",     group=GRP_RSI, minval=2, maxval=200)
rsi_src  = input.source(close, "Source",     group=GRP_RSI)
ob       = input.float(70.0,   "Overbought", group=GRP_RSI, minval=50.0, maxval=100.0, step=1.0)
os       = input.float(30.0,   "Oversold",   group=GRP_RSI, minval=0.0,  maxval=50.0,  step=1.0)
show_mid = input.bool(true,    "Show 50 midline", group=GRP_RSI)

var string GRP_DIV = "Divergence Settings"
piv_left      = input.int(5,     "Pivot Left Bars",       group=GRP_DIV, minval=1, maxval=50)
piv_right     = input.int(5,     "Pivot Right Bars",      group=GRP_DIV, minval=1, maxval=50)
show_reg_bear = input.bool(true, "Regular Bearish Div",   group=GRP_DIV)
show_reg_bull = input.bool(true, "Regular Bullish Div",   group=GRP_DIV)
show_hid_bear = input.bool(false,"Hidden Bearish Div",    group=GRP_DIV)
show_hid_bull = input.bool(false,"Hidden Bullish Div",    group=GRP_DIV)
show_labels   = input.bool(true, "Show Labels",           group=GRP_DIV)

// ─────────────────────────────────────────────────────────
//  RSI
// ─────────────────────────────────────────────────────────

rsi = ta.rsi(rsi_src, rsi_len)

// Dynamic color by zone
rsi_col = rsi >= ob ? color.new(#EF5350, 0) :
          rsi <= os ? color.new(#26A69A, 0) :
          rsi > 50  ? color.new(#42A5F5, 0) :
                      color.new(#90A4AE, 0)

// ─────────────────────────────────────────────────────────
//  DIVERGENCE DETECTION
//
//  Approach:
//    - Detect pivot highs/lows in PRICE using ta.pivothigh/pivotlow
//    - At each confirmed pivot bar, read RSI value at that same bar
//    - Compare successive pivots for classic divergence patterns
//
//  Regular Bearish : price makes Higher High, RSI makes Lower High
//  Regular Bullish : price makes Lower Low,   RSI makes Higher Low
//  Hidden  Bearish : price makes Lower High,  RSI makes Higher High
//  Hidden  Bullish : price makes Higher Low,  RSI makes Lower Low
// ─────────────────────────────────────────────────────────

ph = ta.pivothigh(high, piv_left, piv_right)
pl = ta.pivotlow(low,   piv_left, piv_right)

// Track previous pivot high
var int   last_ph_bar   = na
var float last_ph_price = na
var float last_ph_rsi   = na

// Track previous pivot low
var int   last_pl_bar   = na
var float last_pl_price = na
var float last_pl_rsi   = na

reg_bull_div = false
reg_bear_div = false
hid_bull_div = false
hid_bear_div = false

// ── BEARISH divergence checks (pivot highs) ─────────────
if not na(ph)
    curr_bar = bar_index - piv_right
    curr_rsi = rsi[piv_right]   // RSI value at the actual pivot bar

    if not na(last_ph_bar)
        // Regular bearish: price HH + RSI LH
        if show_reg_bear and ph > last_ph_price and curr_rsi < last_ph_rsi
            reg_bear_div := true
            line.new(last_ph_bar, last_ph_rsi, curr_bar, curr_rsi,
                     color=color.new(#EF5350, 0), width=2, style=line.style_dashed)
            if show_labels
                label.new(curr_bar, curr_rsi, "Bear",
                          style=label.style_label_down,
                          color=color.new(#EF5350, 10),
                          textcolor=color.white, size=size.small)

        // Hidden bearish: price LH + RSI HH
        if show_hid_bear and ph < last_ph_price and curr_rsi > last_ph_rsi
            hid_bear_div := true
            line.new(last_ph_bar, last_ph_rsi, curr_bar, curr_rsi,
                     color=color.new(#FF9800, 0), width=1, style=line.style_dotted)
            if show_labels
                label.new(curr_bar, curr_rsi, "H.Bear",
                          style=label.style_label_down,
                          color=color.new(#FF9800, 10),
                          textcolor=color.white, size=size.small)

    last_ph_bar   := bar_index - piv_right
    last_ph_price := ph
    last_ph_rsi   := rsi[piv_right]

// ── BULLISH divergence checks (pivot lows) ──────────────
if not na(pl)
    curr_bar = bar_index - piv_right
    curr_rsi = rsi[piv_right]

    if not na(last_pl_bar)
        // Regular bullish: price LL + RSI HL
        if show_reg_bull and pl < last_pl_price and curr_rsi > last_pl_rsi
            reg_bull_div := true
            line.new(last_pl_bar, last_pl_rsi, curr_bar, curr_rsi,
                     color=color.new(#26A69A, 0), width=2, style=line.style_dashed)
            if show_labels
                label.new(curr_bar, curr_rsi, "Bull",
                          style=label.style_label_up,
                          color=color.new(#26A69A, 10),
                          textcolor=color.white, size=size.small)

        // Hidden bullish: price HL + RSI LL
        if show_hid_bull and pl > last_pl_price and curr_rsi < last_pl_rsi
            hid_bull_div := true
            line.new(last_pl_bar, last_pl_rsi, curr_bar, curr_rsi,
                     color=color.new(#00BCD4, 0), width=1, style=line.style_dotted)
            if show_labels
                label.new(curr_bar, curr_rsi, "H.Bull",
                          style=label.style_label_up,
                          color=color.new(#00BCD4, 10),
                          textcolor=color.white, size=size.small)

    last_pl_bar   := bar_index - piv_right
    last_pl_price := pl
    last_pl_rsi   := rsi[piv_right]

// ─────────────────────────────────────────────────────────
//  PLOTS
// ─────────────────────────────────────────────────────────

plot(rsi, "RSI", color=rsi_col, linewidth=2)

ob_h  = hline(ob,              "Overbought", color=color.new(#EF5350, 40), linestyle=hline.style_dashed)
os_h  = hline(os,              "Oversold",   color=color.new(#26A69A, 40), linestyle=hline.style_dashed)
mid_h = hline(show_mid ? 50 : na, "Midline", color=color.new(color.gray, 60), linestyle=hline.style_dotted)

// Subtle fill between OB and OS levels
fill(ob_h, os_h, color=color.new(#2196F3, 96), title="OB/OS Zone Fill")

// ─────────────────────────────────────────────────────────
//  ALERTS
// ─────────────────────────────────────────────────────────

alertcondition(reg_bull_div,            "Regular Bullish Div",  "RSI: Regular bullish divergence detected")
alertcondition(reg_bear_div,            "Regular Bearish Div",  "RSI: Regular bearish divergence detected")
alertcondition(hid_bull_div,            "Hidden Bullish Div",   "RSI: Hidden bullish divergence detected")
alertcondition(hid_bear_div,            "Hidden Bearish Div",   "RSI: Hidden bearish divergence detected")
alertcondition(ta.crossunder(rsi, ob),  "RSI Exit Overbought",  "RSI crossed below overbought level")
alertcondition(ta.crossover(rsi, os),   "RSI Exit Oversold",    "RSI crossed above oversold level")
alertcondition(ta.crossover(rsi, 50),   "RSI Cross Above 50",   "RSI crossed above midline (50)")
alertcondition(ta.crossunder(rsi, 50),  "RSI Cross Below 50",   "RSI crossed below midline (50)")
