//@version=6
indicator("[blackcat] L2 SKDJ Slow Stochastic Indicator", shorttitle="L2 SKDJ-E", overlay=false, format=format.volume, precision=2, max_labels_count=500, max_lines_count=500)

//**
// 【Script Summary】
// Indicator Name: SKDJ Slow Stochastic Indicator Enhanced
// Indicator Type: Sub-chart Indicator
// Core Function: Slow KD indicator that filters short-term fluctuations through differential averaging, reducing unnecessary trading errors
// 
// 【Buy/Sell Signal Generation Logic】
// - Overbought Zone: When SKDJ indicator > 80, market is in overbought state with high probability of pullback
// - Oversold Zone: When SKDJ indicator < 20, market is in oversold state with high probability of rebound
// - Buy Signal: When K value crosses D value upward around 20, it's considered a buy signal
// - Sell Signal: When K value crosses D value downward around 80, it's considered a sell signal
// - Neutral Zone: Signals from SKDJ indicator fluctuating around 50 have limited significance
// - Indicator Feature: Slower fluctuation speed compared to KDJ, optimizing trend response for buy/sell points
//*/

// Input parameters
var grpMain = "Main Settings"
kPeriod = input.int(9, title="K Period", minval=1, maxval=100, group=grpMain)
dPeriod = input.int(3, title="D Period", minval=1, maxval=100, group=grpMain)

var grpVisual = "Visual Settings"
showLabels = input.bool(true, title="Show B/S Labels", group=grpVisual)
showTable = input.bool(true, title="Show Status Table", group=grpVisual)
showZones = input.bool(true, title="Show Overbought/Oversold Zones", group=grpVisual)
showDivergence = input.bool(false, title="Show Divergence Lines", group=grpVisual)

var grpAlerts = "Alert Settings"
enableAlerts = input.bool(true, title="Enable Alerts", group=grpAlerts)
alertSound = input.string("Default", title="Alert Sound", options=["Default", "Alarm", "Bell", "Chimes", "Completion", "Confirmation"], group=grpAlerts)

// Calculate the lowest value of low prices within kPeriod
lowestValue = ta.lowest(low, kPeriod)

// Calculate the highest value of high prices within kPeriod
highestValue = ta.highest(high, kPeriod)

// Calculate RSV: Raw Stochastic Value, using exponential moving average
rawStochasticValue = ta.ema((close - lowestValue) / (highestValue - lowestValue) * 100, dPeriod)

// Calculate K value: dPeriod exponential moving average of RSV
kValue = ta.ema(rawStochasticValue, dPeriod)

// Calculate D value: dPeriod simple moving average of K value
dValue = ta.sma(kValue, dPeriod)

// Define overbought and oversold levels
overboughtLevel = 80
oversoldLevel = 20

// Draw horizontal lines for overbought and oversold levels
hline(overboughtLevel, title="Overbought Level", color=color.new(#FF6B6B, 30), linestyle=hline.style_dashed)
hline(oversoldLevel, title="Oversold Level", color=color.new(#4ECDC4, 30), linestyle=hline.style_dashed)
hline(50, title="Middle Line", color=color.new(#999999, 50), linestyle=hline.style_dotted)

// Draw K line, title "K", color orange #F9EE30, line width 2
plot(kValue, title="K", color=#F9EE30, linewidth=2)

// Draw D line, title "D", color blue #E748B9, line width 2
plot(dValue, title="D", color=#E748B9, linewidth=2)

// Detect buy signals: K crosses above D around oversold level (20)
buySignal = ta.crossover(kValue, dValue) and dValue < 30

// Detect sell signals: K crosses below D around overbought level (80)
sellSignal = ta.crossunder(kValue, dValue) and dValue > 70

// Additional signal conditions
strongBuySignal = buySignal and dValue < 20
strongSellSignal = sellSignal and dValue > 80

// Determine market state
marketState = kValue > 70 ? "Overbought" : kValue < 30 ? "Oversold" : "Neutral"
trendDirection = kValue > dValue ? "Bullish" : "Bearish"

// Enhanced visualization with zones
bgcolor(showZones ? (kValue > 80 ? color.new(color.red, 90) : kValue < 20 ? color.new(color.green, 90) : na) : na, title="Overbought/Oversold Zones")

// Draw enhanced B (Buy) labels when buy signal is triggered
plotshape(buySignal and showLabels, title="Buy Signal", text="B", style=shape.labelup, location=location.bottom, color=color.green, textcolor=color.white, size=size.small)
plotshape(strongBuySignal and showLabels, title="Strong Buy Signal", text="STRONG BUY", style=shape.labelup, location=location.bottom, color=color.new(color.green, 20), textcolor=color.white, size=size.normal)

// Draw enhanced S (Sell) labels when sell signal is triggered
plotshape(sellSignal and showLabels, title="Sell Signal", text="S", style=shape.labeldown, location=location.top, color=color.red, textcolor=color.white, size=size.small)
plotshape(strongSellSignal and showLabels, title="Strong Sell Signal", text="STRONG SELL", style=shape.labeldown, location=location.top, color=color.new(color.red, 20), textcolor=color.white, size=size.normal)

// Enhanced fill between K and D lines with gradient effect
fillColor = kValue > dValue ? color.new(#F9EE30, 70) : color.new(#E748B9, 70)
fill(plot(kValue, display=display.none), plot(dValue, display=display.none), color=fillColor, title="KD Fill")

// Add divergence detection (basic implementation)
var float kHigh = na
var float priceHigh = na
var float kLow = na
var float priceLow = na

if kValue > ta.highest(kValue, 14)[1]
    kHigh := kValue
    priceHigh := high

if kValue < ta.lowest(kValue, 14)[1]
    kLow := kValue
    priceLow := low

// Draw divergence lines if enabled
if showDivergence and not na(kHigh) and not na(priceHigh)
    line.new(bar_index[14], kHigh, bar_index, kValue, color=color.red, width=2, style=line.style_dashed)
    line.new(bar_index[14], priceHigh, bar_index, high, color=color.red, width=1, style=line.style_dotted)

if showDivergence and not na(kLow) and not na(priceLow)
    line.new(bar_index[14], kLow, bar_index, kValue, color=color.green, width=2, style=line.style_dashed)
    line.new(bar_index[14], priceLow, bar_index, low, color=color.green, width=1, style=line.style_dotted)

// Status Table
var table statusTable = table.new(position.top_right, 2, 6, bgcolor=color.new(color.black, 80), border_width=1, border_color=color.gray)

if showTable and barstate.islast
    table.cell(statusTable, 0, 0, "SKDJ Status", text_color=color.white, text_size=size.small, bgcolor=color.new(color.blue, 70))
    table.cell(statusTable, 1, 0, "", text_color=color.white, text_size=size.small, bgcolor=color.new(color.blue, 70))
    
    table.cell(statusTable, 0, 1, "K Value", text_color=color.white, text_size=size.small)
    table.cell(statusTable, 1, 1, str.tostring(kValue, "#.##"), text_color=color.yellow, text_size=size.small)
    
    table.cell(statusTable, 0, 2, "D Value", text_color=color.white, text_size=size.small)
    table.cell(statusTable, 1, 2, str.tostring(dValue, "#.##"), text_color=color.new(#E748B9, 0), text_size=size.small)
    
    table.cell(statusTable, 0, 3, "Market State", text_color=color.white, text_size=size.small)
    table.cell(statusTable, 1, 3, marketState, text_color=marketState == "Overbought" ? color.red : marketState == "Oversold" ? color.green : color.gray, text_size=size.small)
    
    table.cell(statusTable, 0, 4, "Trend", text_color=color.white, text_size=size.small)
    table.cell(statusTable, 1, 4, trendDirection, text_color=trendDirection == "Bullish" ? color.green : color.red, text_size=size.small)
    
    table.cell(statusTable, 0, 5, "Signal", text_color=color.white, text_size=size.small)
    signalText = strongBuySignal ? "STRONG BUY" : buySignal ? "BUY" : strongSellSignal ? "STRONG SELL" : sellSignal ? "SELL" : "NONE"
    signalColor = strongBuySignal ? color.new(color.green, 20) : buySignal ? color.green : strongSellSignal ? color.new(color.red, 20) : sellSignal ? color.red : color.gray
    table.cell(statusTable, 1, 5, signalText, text_color=signalColor, text_size=size.small)

// Alert conditions
alertcondition(buySignal, title="SKDJ Buy Signal", message="SKDJ Buy Signal - K crossed above D in oversold zone")
alertcondition(sellSignal, title="SKDJ Sell Signal", message="SKDJ Sell Signal - K crossed below D in overbought zone")
alertcondition(strongBuySignal, title="SKDJ Strong Buy Signal", message="SKDJ Strong Buy Signal - K crossed above D in deep oversold zone")
alertcondition(strongSellSignal, title="SKDJ Strong Sell Signal", message="SKDJ Strong Sell Signal - K crossed below D in deep overbought zone")

// Trigger alerts if enabled
if enableAlerts and buySignal
    alert("SKDJ Buy Signal Detected", alert.freq_once_per_bar)

if enableAlerts and sellSignal
    alert("SKDJ Sell Signal Detected", alert.freq_once_per_bar)

if enableAlerts and strongBuySignal
    alert("SKDJ Strong Buy Signal Detected!", alert.freq_once_per_bar)

if enableAlerts and strongSellSignal
    alert("SKDJ Strong Sell Signal Detected!", alert.freq_once_per_bar)
