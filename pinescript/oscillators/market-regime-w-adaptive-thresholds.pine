//@version=5
indicator("Market Regime (Adaptive Thresholds + Visualization & Alerts)", overlay=false)

// --- Inputs ---
thresh_lookback = input.int(100, title="Adaptive Threshold Lookback", minval=10)
smoothing_factor = input.float(0.1, title="Regime Score Smoothing Factor", minval=0.01, maxval=0.5, step=0.01)
regime_persistence = input.int(1, title="Regime Persistence Bars", minval=1)

// --- Regime Logic ---
lookback_short = 5
lookback_long = 10

ema_fast = ta.ema(close, lookback_short)
ema_slow = ta.ema(close, lookback_long)
trend_strength = (ema_fast - ema_slow) / ema_slow

rsi = ta.rsi(close, 7)
rsi_smooth = ta.ema(rsi, 3)

regime_score_raw = 50.0
if trend_strength > 0.01
    regime_score_raw += 60
else if trend_strength < -0.01
    regime_score_raw -= 60

if rsi_smooth > 70
    regime_score_raw += 20
else if rsi_smooth < 30
    regime_score_raw -= 20

// Smooth regime score with integer length
ema_length = math.round(1 / smoothing_factor)
regime_score_smooth = ta.ema(regime_score_raw, ema_length)

// Clamp regime score
final_regime_score = math.max(0, math.min(100, regime_score_smooth))

// Adaptive thresholds using rolling min/max
regime_min = ta.lowest(final_regime_score, thresh_lookback)
regime_max = ta.highest(final_regime_score, thresh_lookback)

thresh_high = regime_min + 0.8 * (regime_max - regime_min)
thresh_low = regime_min + 0.2 * (regime_max - regime_min)

// --- Determine Regime ---
var string current_regime = "NEUTRAL"
var color regime_color = color.gray
var int regime_counter = 0

new_regime = ""
new_color = color.gray

if final_regime_score >= thresh_high
    new_regime := "STRONG TREND"
    new_color := color.green
else if final_regime_score <= thresh_low
    new_regime := "STRONG MEAN REVERSION"
    new_color := color.red
else
    new_regime := "NEUTRAL"
    new_color := color.gray

if new_regime == current_regime
    regime_counter += 1
else
    regime_counter := 1

if regime_counter >= regime_persistence
    current_regime := new_regime
    regime_color := new_color

// --- Visualization ---
// Plot regime score for debug
plot(final_regime_score, title="Regime Score", color=regime_color, linewidth=2)
plot(thresh_high, title="Adaptive High Threshold", color=color.green, style=plot.style_linebr, linewidth=1)
plot(thresh_low, title="Adaptive Low Threshold", color=color.red, style=plot.style_linebr, linewidth=1)
hline(50, "Neutral", color=color.gray, linestyle=hline.style_dotted)

// Background color for regime
bgcolor(current_regime == "STRONG TREND" ? color.new(color.green, 90) : 
       current_regime == "STRONG MEAN REVERSION" ? color.new(color.red, 90) : na)

// --- Table ---
var table regime_table = table.new(position.bottom_left, 2, 3, bgcolor=color.white, border_width=1)
if barstate.islast
    table.cell(regime_table, 0, 0, "REGIME", text_color=color.white, bgcolor=color.navy, text_size=size.small)
    table.cell(regime_table, 1, 0, current_regime, text_color=color.white, bgcolor=regime_color, text_size=size.small)
    table.cell(regime_table, 0, 1, "Color", text_color=color.black, text_size=size.tiny)
    table.cell(regime_table, 1, 1, current_regime == "STRONG TREND" ? "Green" : current_regime == "STRONG MEAN REVERSION" ? "Red" : "Grey", text_color=color.white, bgcolor=regime_color, text_size=size.tiny)
    table.cell(regime_table, 0, 2, "Score", text_color=color.black, text_size=size.tiny)
    table.cell(regime_table, 1, 2, str.tostring(final_regime_score, "#.1"), text_color=color.black, text_size=size.tiny)

// --- Alerts ---
// Alert on regime change
alertcondition(new_regime != current_regime, title="Regime Change", message="Market regime changed to {{new_regime}}")

// Alert on strong trend or mean reversion
alertcondition(current_regime == "STRONG TREND", title="Strong Trend", message="Market is in a strong trending regime")
alertcondition(current_regime == "STRONG MEAN REVERSION", title="Strong Mean Reversion", message="Market is in a strong mean reverting regime")
