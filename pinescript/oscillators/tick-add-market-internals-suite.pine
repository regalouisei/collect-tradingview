//@version=5
indicator("Market Internals Suite: TICK & ADD Pro", shorttitle="TICK+ADD Pro (V3)", overlay=false)

// ==========================================
// 1. 设置区域 (Settings)
// ==========================================

// --- TICK 设置 ---
grp_tick = "TICK Settings (Candles)"
// 默认使用全美 TICK
sym_tick = input.symbol("USI:TICK.US", title="TICK Symbol", group=grp_tick)
tick_alert_val = input.int(1000, title="TICK Extreme Alert (+/-)", group=grp_tick)

// --- ADD 设置 (智能模式) ---
grp_add = "ADD Settings (Smart Calculation)"
// 不再需要手动输入 ADD 代码，改为选择模式
add_mode = input.string("US Composite (Auto)", title="Market Mode", options=["US Composite (Auto)", "NYSE Only", "NASDAQ Only"], group=grp_add, tooltip="US Composite = NYSE ADD + NASDAQ ADD")
// 全美数据数值大，默认缩放 2.5；如果是单交易所，建议改为 1.5-2.0
add_scale = input.float(2.5, title="ADD Visual Scale Ratio", group=grp_add)

// --- 面板设置 ---
grp_dash = "Dashboard Settings"
txt_size_str = input.string("Large", title="Text Size", options=["Small", "Normal", "Large", "Huge"], group=grp_dash)

// --- 颜色设置 ---
grp_col = "Colors"
c_tick_up = input.color(color.green, "TICK Candle Bullish", group=grp_col)
c_tick_dn = input.color(color.red, "TICK Candle Bearish", group=grp_col)
c_add_up  = input.color(color.new(color.green, 30), "ADD Line Bullish", group=grp_col) 
c_add_dn  = input.color(color.new(color.red, 30), "ADD Line Bearish", group=grp_col)

c_bg_tick_high = input.color(color.new(color.green, 80), "TICK Extreme High BG", group=grp_col)
c_bg_tick_low  = input.color(color.new(color.red, 80), "TICK Extreme Low BG", group=grp_col)

// ==========================================
// 2. 数据获取与智能计算
// ==========================================

// 获取 TICK
[tOpen, tHigh, tLow, tClose] = request.security(sym_tick, timeframe.period, [open, high, low, close])

// 获取各个交易所的 ADD 数据
add_nyse = request.security("USI:ADD", timeframe.period, close)
add_nasd = request.security("USI:ADDQ", timeframe.period, close)

// 根据用户选择的模式计算 ADD
float add_real = switch add_mode
    "US Composite (Auto)" => add_nyse + add_nasd // 自动相加
    "NYSE Only"           => add_nyse
    "NASDAQ Only"         => add_nasd
    => add_nyse

// 计算绘图用的缩放数值
add_visual = add_real / add_scale 

// 字体大小转换
string user_size = switch txt_size_str
    "Small"  => size.small
    "Normal" => size.normal
    "Large"  => size.large
    "Huge"   => size.huge
    => size.large

// ==========================================
// 3. 数值显示修正 (状态行)
// ==========================================
plot(tClose, title="TICK Real", color=na, display=display.status_line + display.data_window)
plot(add_real, title="ADD Real", color=na, display=display.status_line + display.data_window)

// ==========================================
// 4. 绘图 (图表)
// ==========================================

// 参考线
hline(0, "Zero", color=color.gray)
hline(800, "Ref 800", color=color.gray, linestyle=hline.style_dashed)
hline(-800, "Ref -800", color=color.gray, linestyle=hline.style_dashed)
hline(tick_alert_val, "Extreme High", color=color.new(color.gray, 80))
hline(-tick_alert_val, "Extreme Low", color=color.new(color.gray, 80))

// 绘制 ADD
plot(add_visual, title="ADD Visual Line", color=add_real >= 0 ? c_add_up : c_add_dn, linewidth=2, display=display.pane)

// 绘制 TICK K线
c_body = tClose >= tOpen ? c_tick_up : c_tick_dn
plotcandle(tOpen, tHigh, tLow, tClose, title="TICK Candles", color=c_body, wickcolor=c_body, bordercolor=c_body, display=display.pane)

// ==========================================
// 5. 警报与高亮
// ==========================================

is_tick_high = tHigh >= tick_alert_val
is_tick_low  = tLow <= -tick_alert_val

bgcolor(is_tick_high ? c_bg_tick_high : na, title="TICK High Highlight")
bgcolor(is_tick_low ? c_bg_tick_low : na, title="TICK Low Highlight")

// ==========================================
// 6. 数据面板
// ==========================================
var table panel = table.new(position.top_right, 2, 2, border_width=0)

if barstate.islast
    table.cell(panel, 0, 0, "REAL DATA", text_color=color.gray, text_size=size.small)
    
    // TICK
    table.cell(panel, 0, 1, "TICK: " + str.tostring(tClose), text_color = tClose >= 0 ? c_tick_up : c_tick_dn, text_size=user_size, text_halign=text.align_left)
    
    // ADD (显示模式名称，例如 "ADD (US): 2500")
    string add_label = switch add_mode
        "US Composite (Auto)" => "ADD (US): "
        "NYSE Only"           => "ADD (NY): "
        "NASDAQ Only"         => "ADD (NQ): "
        => "ADD: "
        
    table.cell(panel, 1, 1, add_label + str.tostring(add_real), text_color = add_real >= 0 ? color.green : color.red, text_size=user_size, text_halign=text.align_left)
