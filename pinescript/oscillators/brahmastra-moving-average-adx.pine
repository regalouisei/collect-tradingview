// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Brahmastra Trading Systems
// Brahmastra Moving Average ADX - Premium Trend Detection Indicator

//@version=5
indicator(title="Brahmastra Moving Average ADX", shorttitle="Brahmastra MA ADX", overlay=true)

// ═══════════════════════════════════════════════════════════════════════════════
// INPUT PARAMETERS
// ═══════════════════════════════════════════════════════════════════════════════

// ADX Settings
lenadx  = input.int(14, minval=1, title="DI Length")
lensig  = input.int(14, title="ADX Smoothing", minval=1, maxval=50)
limadx  = input.int(18, minval=1, title="ADX Trend Threshold")

// Moving Average Settings
len     = input.int(9, minval=1, title="MA Length")
src     = input.source(close, title="MA Source")

// Visual Settings
lineWidth    = input.int(3, minval=1, maxval=5, title="Line Width")
bullColor    = input.color(color.new(#00E676, 0), title="Bullish Color")
bearColor    = input.color(color.new(#FF5252, 0), title="Bearish Color")
neutralColor = input.color(color.new(#9E9E9E, 0), title="Neutral Color")
showFill     = input.bool(true, title="Show MA Fill Zone")
fillOpacity  = input.int(85, minval=0, maxval=100, title="Fill Opacity %")
showSignals  = input.bool(true, title="Show Buy/Sell Signals")
showTable    = input.bool(true, title="Show Info Panel")

// ═══════════════════════════════════════════════════════════════════════════════
// ADX CALCULATION
// ═══════════════════════════════════════════════════════════════════════════════

upMove   = ta.change(high)
downMove = -ta.change(low)

trSmooth = ta.rma(ta.tr, lenadx)

plusDM  = upMove > downMove and upMove > 0 ? upMove : 0
minusDM = downMove > upMove and downMove > 0 ? downMove : 0

plusDI  = nz(100 * ta.rma(plusDM, lenadx) / trSmooth, 0)
minusDI = nz(100 * ta.rma(minusDM, lenadx) / trSmooth, 0)

diSum  = plusDI + minusDI
diDiff = math.abs(plusDI - minusDI)
dx     = diSum == 0 ? 0 : 100 * diDiff / diSum
adx    = ta.rma(dx, lensig)

// ═══════════════════════════════════════════════════════════════════════════════
// MOVING AVERAGE CALCULATION
// ═══════════════════════════════════════════════════════════════════════════════

maValue = ta.wma(src, len)

// ═══════════════════════════════════════════════════════════════════════════════
// TREND DETERMINATION & COLOR LOGIC
// ═══════════════════════════════════════════════════════════════════════════════

isTrending = adx > limadx
isBullish  = plusDI > minusDI
isBearish  = plusDI < minusDI

maColor = isTrending and isBullish ? bullColor : isTrending and isBearish ? bearColor : neutralColor

// ═══════════════════════════════════════════════════════════════════════════════
// SIGNAL GENERATION
// ═══════════════════════════════════════════════════════════════════════════════

bullSignal = isTrending and isBullish and (not isTrending[1] or not isBullish[1])
bearSignal = isTrending and isBearish and (not isTrending[1] or not isBearish[1])

// ═══════════════════════════════════════════════════════════════════════════════
// PLOTTING
// ═══════════════════════════════════════════════════════════════════════════════

maPlot    = plot(maValue, color=maColor, title="Brahmastra MA", linewidth=lineWidth)
pricePlot = plot(showFill ? close : na, display=display.none)

bullFill    = color.new(bullColor, fillOpacity)
bearFill    = color.new(bearColor, fillOpacity)
neutralFill = color.new(neutralColor, 95)

fillColor = isTrending and isBullish ? bullFill : isTrending and isBearish ? bearFill : neutralFill
fill(maPlot, pricePlot, color=showFill ? fillColor : na, title="Trend Fill")

// Buy/Sell Signals
plotshape(showSignals and bullSignal ? low : na, title="Buy Signal", style=shape.triangleup, location=location.belowbar, color=bullColor, size=size.small, text="BUY")
plotshape(showSignals and bearSignal ? high : na, title="Sell Signal", style=shape.triangledown, location=location.abovebar, color=bearColor, size=size.small, text="SELL")

// ═══════════════════════════════════════════════════════════════════════════════
// INFORMATION TABLE
// ═══════════════════════════════════════════════════════════════════════════════

var table infoPanel = table.new(position.top_right, 2, 4, bgcolor=color.new(#1E1E1E, 10), border_width=1, border_color=color.new(#424242, 50))

if showTable and barstate.islast
    trendText = isTrending ? (isBullish ? "▲ BULLISH" : "▼ BEARISH") : "◆ RANGING"
    diText    = str.tostring(plusDI, "#.#") + " / " + str.tostring(minusDI, "#.#")
    adxText   = str.tostring(adx, "#.##")
    
    table.cell(infoPanel, 0, 0, "Brahmastra ADX", text_color=color.white, text_size=size.small)
    table.cell(infoPanel, 1, 0, "", bgcolor=maColor)
    table.cell(infoPanel, 0, 1, "ADX", text_color=color.gray, text_size=size.tiny)
    table.cell(infoPanel, 1, 1, adxText, text_color=isTrending ? color.white : color.gray, text_size=size.tiny)
    table.cell(infoPanel, 0, 2, "+DI / -DI", text_color=color.gray, text_size=size.tiny)
    table.cell(infoPanel, 1, 2, diText, text_color=isBullish ? bullColor : bearColor, text_size=size.tiny)
    table.cell(infoPanel, 0, 3, "Trend", text_color=color.gray, text_size=size.tiny)
    table.cell(infoPanel, 1, 3, trendText, text_color=maColor, text_size=size.tiny)

// ═══════════════════════════════════════════════════════════════════════════════
// ALERTS
// ═══════════════════════════════════════════════════════════════════════════════

alertcondition(bullSignal, title="Brahmastra Bullish Signal", message="Brahmastra MA ADX: Bullish trend confirmed!")
alertcondition(bearSignal, title="Brahmastra Bearish Signal", message="Brahmastra MA ADX: Bearish trend confirmed!")
alertcondition(ta.crossover(adx, limadx), title="ADX Trending", message="Brahmastra: ADX crossed above threshold")
alertcondition(ta.crossunder(adx, limadx), title="ADX Ranging", message="Brahmastra: ADX crossed below threshold")
