// This work is licensed under Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International  
// https://creativecommons.org/licenses/by-nc-sa/4.0/
// UAlgo
//@version=6
indicator("RSI Fibonacci Analysis [UAlgo]", overlay=false, max_lines_count=500, max_labels_count=500)

// =============================================================================
// 1. INPUTS & CONFIGURATION
// =============================================================================

// --- Group: Calculations ---
int rsiLength = input.int(14, "RSI Length", group="Calculations")
float rsiSource = input.source(close, "RSI Source", group="Calculations")
int swingDepth = input.int(5, "Swing Depth", minval=1, group="Calculations", tooltip="Bars required to confirm a High/Low")
int minBarGap = input.int(10, "Min Bars Gap", minval=1, group="Calculations", tooltip="Minimum bars between start and end of Fib")

// --- Group: Visuals ---
color colorRsi = input.color(color.new(#2962FF, 0), "RSI Line Color", group="Visuals")
color colorFibUp = input.color(color.new(color.green, 20), "Bullish Fib Color", group="Visuals")
color colorFibDn = input.color(color.new(color.red, 20), "Bearish Fib Color", group="Visuals")
color colorText = input.color(color.new(color.white, 0), "Label Text Color", group="Visuals")

string lineStyle = input.string("Dashed", "Line Style", options=["Solid", "Dashed", "Dotted"], group="Visuals")
string textSizeRaw = input.string("Small", "Text Size", options=["Tiny", "Small", "Normal", "Large"], group="Visuals")

// --- Group: Statistics ---
bool showStrength = input.bool(true, "Show Level Strength on Chart", group="Statistics")
int lookbackFibs = input.int(200, "Stats Lookback (Swings)", minval=10,maxval = 500, group="Statistics")

// --- Group: Dashboard ---
bool showDash = input.bool(true, "Show Stats Dashboard", group="Dashboard")
string dashPosRaw = input.string("Bottom Right", "Position", options=["Top Right", "Bottom Right", "Top Left", "Bottom Left"], group="Dashboard")
string dashSizeRaw = input.string("Small", "Size", options=["Tiny", "Small", "Normal", "Large"], group="Dashboard")

// =============================================================================
// 2. TYPES
// =============================================================================

type Swing
    float price
    int barIdx
    bool isHigh

type FibLevel
    float ratio
    string label
    int hitsBull // Hits when trend was Up (Bullish Fib)
    int hitsBear // Hits when trend was Down (Bearish Fib)

// =============================================================================
// 3. METHODS & HELPERS
// =============================================================================

method getLineStyle(string styleName) =>
    switch styleName
        "Solid" => line.style_solid
        "Dotted" => line.style_dotted
        => line.style_dashed

method getTextSize(string sizeName) =>
    switch sizeName
        "Tiny" => size.tiny
        "Small" => size.small
        "Normal" => size.normal
        "Large" => size.large
        => size.small

method getDashPos(string posName) =>
    switch posName
        "Top Right" => position.top_right
        "Bottom Right" => position.bottom_right
        "Top Left" => position.top_left
        "Bottom Left" => position.bottom_left
        => position.bottom_right

// Method to draw a fib tool instance
method drawFib(Swing start, Swing end, array<FibLevel> levels, color lineColor, color textColor, string styleName, bool useStats, string sizeName) =>
    // Determine direction for stats usage
    bool isBullish = start.price < end.price

    // Draw Connector
    line.new(
         x1 = start.barIdx, 
         y1 = start.price, 
         x2 = end.barIdx, 
         y2 = end.price, 
         color = lineColor, 
         width = 1, 
         style = styleName.getLineStyle()
     )
    
    // Draw Levels
    float diff = end.price - start.price
    
    // Calculate total hits for THIS direction normalization
    int totalHits = 0
    if useStats
        for lvl in levels
            totalHits += isBullish ? lvl.hitsBull : lvl.hitsBear

    for lvl in levels
        float levelPrice = start.price + (diff * lvl.ratio)
        int hits = isBullish ? lvl.hitsBull : lvl.hitsBear
        
        // Calculate line thickness based on strength
        int lineWidth = 1
        if useStats and totalHits > 0 and hits > 0
            float strength = hits / float(totalHits)
            if strength > 0.2 
                lineWidth := 2
            if strength > 0.3 
                lineWidth := 3

        // Level Line
        line.new(
             x1 = start.barIdx, 
             y1 = levelPrice, 
             x2 = end.barIdx, 
             y2 = levelPrice, 
             color = lineColor, 
             width = lineWidth, 
             style = line.style_solid
         )
        
        // Level Label with Stats
        string labelText = lvl.label
        if useStats and totalHits > 0
            int pct = int((hits / float(totalHits)) * 100)
            if pct > 0
                labelText += " (" + str.tostring(pct) + "%)"

        label.new(
             x = start.barIdx, 
             y = levelPrice, 
             text = labelText, 
             style = label.style_none, 
             textcolor = textColor, 
             size = sizeName.getTextSize()
         )

// =============================================================================
// 4. MAIN LOGIC
// =============================================================================

// --- Calculation ---
float rsiValue = ta.rsi(rsiSource, rsiLength)

// --- Plotting ---
// Gradient RSI Logic
color rsiGradient = rsiValue > 50 ? color.from_gradient(rsiValue, 50, 80, color.new(color.green, 50), color.green) : color.from_gradient(rsiValue, 20, 50, color.red, color.new(color.red, 50))
plot(rsiValue, "RSI", color=rsiGradient, linewidth=2)

hline(70, "Overbought", color=color.new(color.gray, 50), linestyle=hline.style_dotted)
hline(30, "Oversold", color=color.new(color.gray, 50), linestyle=hline.style_dotted)

// --- Swing Detection ---
float ph = ta.pivothigh(rsiValue, swingDepth, swingDepth)
float pl = ta.pivotlow(rsiValue, swingDepth, swingDepth)

// --- State Management ---
var allSwings = array.new<Swing>()

// Define Fib Levels with Stats Counters
var fibLevels = array.from(
      FibLevel.new(0.0, "0", 0, 0),
      FibLevel.new(0.236, "0.236", 0, 0),
      FibLevel.new(0.382, "0.382", 0, 0),
      FibLevel.new(0.5, "0.5", 0, 0),
      FibLevel.new(0.618, "0.618", 0, 0),
      FibLevel.new(0.786, "0.786", 0, 0),
      FibLevel.new(1.0, "1", 0, 0)
  )

// --- Update State ---
if not na(ph)
    allSwings.unshift(Swing.new(ph, bar_index - swingDepth, true))
    if allSwings.size() > 300
        allSwings.pop()

if not na(pl)
    allSwings.unshift(Swing.new(pl, bar_index - swingDepth, false))
    if allSwings.size() > 300
        allSwings.pop()

// --- Stats Collection Logic ---
if not na(ph) or not na(pl) 
    int size = allSwings.size()
    
    if size >= 3
        // Clear old stats
        for lvl in fibLevels
            lvl.hitsBull := 0
            lvl.hitsBear := 0
            
        int maxIter = math.min(lookbackFibs, size - 2)
        
        for i = 0 to maxIter - 1 
            Swing sRetest = allSwings.get(i)
            Swing sEnd    = allSwings.get(i+1)
            Swing sStart  = allSwings.get(i+2)
            
            // Validate Zig-Zag Pattern
            bool isValidPattern = (sStart.isHigh != sEnd.isHigh) and (sEnd.isHigh != sRetest.isHigh)
            
            if isValidPattern
                float fibRange = sEnd.price - sStart.price
                bool isBullish = sStart.price < sEnd.price
                
                if math.abs(fibRange) > 0
                    for lvl in fibLevels
                        float lvlPrice = sStart.price + (fibRange * lvl.ratio)
                        float dist = math.abs(sRetest.price - lvlPrice)
                        
                        if dist < (math.abs(fibRange) * 0.05)
                            if isBullish
                                lvl.hitsBull += 1
                            else
                                lvl.hitsBear += 1

// --- Processing & Drawing Current Fib ---
if allSwings.size() >= 2
    Swing lastSwing = allSwings.get(0)
    Swing prevSwing = allSwings.get(1)
    
    if lastSwing.isHigh != prevSwing.isHigh
        if math.abs(lastSwing.barIdx - prevSwing.barIdx) >= minBarGap
            
            Swing start = prevSwing
            Swing end = lastSwing
            
            bool isNewSwing = not na(ph) or not na(pl)
            
            if isNewSwing
                color useColor = start.price < end.price ? colorFibUp : colorFibDn
                start.drawFib(end, fibLevels, useColor, colorText, lineStyle, showStrength, textSizeRaw)

// =============================================================================
// 5. DASHBOARD
// =============================================================================

// Increased columns to 5 for Bull/Bear separation
var table dash = table.new(position.bottom_right, 5, 8, border_width=1, border_color=color.new(color.gray, 80), frame_color=color.new(color.gray, 80), frame_width=1)

if barstate.islast and showDash
    dash.set_position(dashPosRaw.getDashPos())
    
    color headerBg = color.new(color.blue, 80)
    color headerBull = color.new(color.green, 80)
    color headerBear = color.new(color.red, 80)
    
    dash.cell(0, 0, "Level", bgcolor=headerBg, text_color=colorText, text_size=dashSizeRaw.getTextSize())
    dash.cell(1, 0, "Bull Hits", bgcolor=headerBull, text_color=colorText, text_size=dashSizeRaw.getTextSize())
    dash.cell(2, 0, "Bull %", bgcolor=headerBull, text_color=colorText, text_size=dashSizeRaw.getTextSize())
    dash.cell(3, 0, "Bear Hits", bgcolor=headerBear, text_color=colorText, text_size=dashSizeRaw.getTextSize())
    dash.cell(4, 0, "Bear %", bgcolor=headerBear, text_color=colorText, text_size=dashSizeRaw.getTextSize())
    
    // Calculate Totals
    int totalBull = 0
    int totalBear = 0
    for lvl in fibLevels
        totalBull += lvl.hitsBull
        totalBear += lvl.hitsBear
        
    // Fill Rows
    for i = 0 to fibLevels.size() - 1
        FibLevel lvl = fibLevels.get(i)
        
        float pctBull = totalBull > 0 ? (lvl.hitsBull / float(totalBull)) * 100 : 0
        float pctBear = totalBear > 0 ? (lvl.hitsBear / float(totalBear)) * 100 : 0
        
        color bg = color.new(color.gray, 90)
        
        // Highlighting logic (Optional: Highlight if either side is strong)
        if pctBull > 30 or pctBear > 30
            bg := color.new(color.yellow, 90)
            
        dash.cell(0, i+1, lvl.label, bgcolor=bg, text_color=colorText, text_size=dashSizeRaw.getTextSize())
        
        // Bull Stats
        dash.cell(1, i+1, str.tostring(lvl.hitsBull), bgcolor=bg, text_color=colorText, text_size=dashSizeRaw.getTextSize())
        dash.cell(2, i+1, str.tostring(pctBull, "#.0") + "%", bgcolor=bg, text_color=colorText, text_size=dashSizeRaw.getTextSize())
        
        // Bear Stats
        dash.cell(3, i+1, str.tostring(lvl.hitsBear), bgcolor=bg, text_color=colorText, text_size=dashSizeRaw.getTextSize())
        dash.cell(4, i+1, str.tostring(pctBear, "#.0") + "%", bgcolor=bg, text_color=colorText, text_size=dashSizeRaw.getTextSize())
