//@version=5
indicator("Tri-Core Statistical Trend Navigator", overlay=true, max_labels_count=500, max_lines_count=500)

// ==========================================
// 1. INPUTS & CONFIGURATION
// ==========================================
lotSize    = input.float(50, title="Lot Size (for P&L calc)")
atrLen     = input.int(14, title="ATR Length", group="Risk Management")
slMult     = input.float(1.5, title="Stop Loss Multiplier", group="Risk Management")
tp1Mult    = input.float(1.5, title="TP1 Multiplier", group="Risk Management")
tp2Mult    = input.float(3.0, title="TP2 Multiplier", group="Risk Management")
tp3Mult    = input.float(4.5, title="TP3 Multiplier", group="Risk Management")

// ==========================================
// 2. CORE PHILOSOPHY: GOLDEN POC (VWAP)
// ==========================================
golden_poc = ta.vwap(close)
plot(golden_poc, color=color.new(#FFD700, 0), title="Golden POC", linewidth=2)

// ==========================================
// 3. TRIPLE ENGINE LOGIC
// ==========================================
// --- Engine 1: Statistical Z-Score ---
z_length = 20
z_mean   = ta.sma(close, z_length)
z_std    = ta.stdev(close, z_length)
z_score  = z_std == 0 ? 0 : (close - z_mean) / z_std

// --- Engine 2: MACD Momentum ---
[macdLine, signalLine, _] = ta.macd(close, 12, 26, 9)
mom_cross_up   = ta.crossover(macdLine, signalLine)
mom_cross_down = ta.crossunder(macdLine, signalLine)

// --- Engine 3: Moving Averages ---
ema20 = ta.ema(close, 20)
ema50 = ta.ema(close, 50)

// ==========================================
// 4. SIGNAL TIERING (AI LOGIC)
// ==========================================
// --- BULLISH (LONG) SIGNALS ---
long_a_plus = mom_cross_up and (z_score < -1.5) and (close > ema50)
long_a      = mom_cross_up and (close > ema50) and (close > golden_poc) and not long_a_plus
long_b      = mom_cross_up and not long_a_plus and not long_a

// --- BEARISH (SHORT) SIGNALS ---
short_a_plus = mom_cross_down and (z_score > 1.5) and (close < ema50)
short_a      = mom_cross_down and (close < ema50) and (close < golden_poc) and not short_a_plus
short_b      = mom_cross_down and not short_a_plus and not short_a

// Custom Bar Colors (Visual clarity based on EMA trend and POC)
ha_color = close > golden_poc and ema20 > ema50 ? color.new(color.teal, 0) : close < golden_poc and ema20 < ema50 ? color.new(color.red, 0) : color.new(color.gray, 0)
barcolor(ha_color)

// ==========================================
// 5. TRADE PLAN: LABELS, SL & TP LINES
// ==========================================
atr = ta.atr(atrLen)
var float entry_price = na
var int   trade_dir = 0

// Execute Long
if long_a_plus or long_a or long_b
    entry_price := close
    trade_dir   := 1 
    
    sl_price  = close - (atr * slMult)
    tp1_price = close + (atr * tp1Mult)
    tp2_price = close + (atr * tp2Mult)
    tp3_price = close + (atr * tp3Mult)
    
    lbl_color = long_a_plus ? color.blue : long_a ? color.green : color.yellow
    lbl_text  = long_a_plus ? "A+" : long_a ? "A" : "B"
    label.new(bar_index, low - (atr * 0.5), text=lbl_text, color=lbl_color, style=label.style_label_up, textcolor=color.rgb(0,0,0), size=size.small)
    
    line.new(bar_index, entry_price, bar_index + 15, entry_price, color=color.gray, style=line.style_dotted, width=1)
    line.new(bar_index, sl_price, bar_index + 15, sl_price, color=color.red, width=2)
    line.new(bar_index, tp1_price, bar_index + 15, tp1_price, color=color.green, width=1)
    line.new(bar_index, tp2_price, bar_index + 15, tp2_price, color=color.rgb(0, 255, 128), width=2)
    line.new(bar_index, tp3_price, bar_index + 15, tp3_price, color=color.teal, width=2)

// Execute Short
if short_a_plus or short_a or short_b
    entry_price := close
    trade_dir   := -1 
    
    sl_price  = close + (atr * slMult)
    tp1_price = close - (atr * tp1Mult)
    tp2_price = close - (atr * tp2Mult)
    tp3_price = close - (atr * tp3Mult)
    
    lbl_color = short_a_plus ? color.fuchsia : short_a ? color.red : color.orange
    lbl_text  = short_a_plus ? "A+" : short_a ? "A" : "B"
    label.new(bar_index, high + (atr * 0.5), text=lbl_text, color=lbl_color, style=label.style_label_down, textcolor=color.rgb(0, 0, 0), size=size.small)
    
    line.new(bar_index, entry_price, bar_index + 15, entry_price, color=color.gray, style=line.style_dotted, width=1)
    line.new(bar_index, sl_price, bar_index + 15, sl_price, color=color.red, width=2)
    line.new(bar_index, tp1_price, bar_index + 15, tp1_price, color=color.green, width=1)
    line.new(bar_index, tp2_price, bar_index + 15, tp2_price, color=color.rgb(0, 255, 128), width=2)
    line.new(bar_index, tp3_price, bar_index + 15, tp3_price, color=color.teal, width=2)

// ==========================================
// 6. DASHBOARD CALCULATIONS
// ==========================================
// CHOP IDX
chop_length = 14
atr_sum     = math.sum(ta.atr(1), chop_length)
high_val    = ta.highest(high, chop_length)
low_val     = ta.lowest(low, chop_length)
chop_idx    = 100 * math.log10(atr_sum / (high_val - low_val)) / math.log10(chop_length)

// STATUS
is_choppy    = chop_idx > 60
status_txt   = is_choppy ? "CHOPPY" : "TRENDING"
status_color = is_choppy ? color.gray : color.rgb(0, 255, 128)

// SUPERTREND
[supertrend, st_dir] = ta.supertrend(3, 10)
st_txt   = st_dir < 0 ? "BULL" : "BEAR"
st_color = st_dir < 0 ? color.rgb(0, 255, 128) : color.rgb(255, 50, 50)

// ADX
[_, _, adx] = ta.dmi(14, 14)

// CASH P&L (Handles both Long and Short)
cash_pnl = 0.0
if trade_dir == 1
    cash_pnl := (close - entry_price) * lotSize
else if trade_dir == -1
    cash_pnl := (entry_price - close) * lotSize
pnl_color = cash_pnl >= 0 ? color.green : color.red

// EMA STACK
ema_aligned_bull = ema20 > ema50
ema_aligned_bear = ema20 < ema50
ema_txt     = ema_aligned_bull ? "BULL ALIGNED" : ema_aligned_bear ? "BEAR ALIGNED" : "CONFLICT"
ema_color   = ema_aligned_bull ? color.rgb(0, 255, 128) : ema_aligned_bear ? color.rgb(255, 50, 50) : color.rgb(60, 60, 60)

// OMNI-DIRECTIONAL ALIGNMENT
bull_score = 0.0
bull_score += (close > golden_poc ? 20 : 0)
bull_score += (ema20 > ema50 ? 20 : 0)
bull_score += (macdLine > signalLine ? 20 : 0)
bull_score += (adx > 25 ? 20 : 0)
bull_score += (st_dir < 0 ? 20 : 0)

bear_score = 0.0
bear_score += (close < golden_poc ? 20 : 0)
bear_score += (ema20 < ema50 ? 20 : 0)
bear_score += (macdLine < signalLine ? 20 : 0)
bear_score += (adx > 25 ? 20 : 0)
bear_score += (st_dir > 0 ? 20 : 0)

align_score = math.max(bull_score, bear_score)
align_txt   = str.tostring(align_score) + "%"
align_color = align_score >= 80 ? color.rgb(0, 255, 128) : (align_score > 40 ? color.rgb(60, 60, 60) : color.rgb(255, 50, 50))

// DIVERGENCE HINT
rsi_val  = ta.rsi(close, 14)
bear_div = ta.highest(close, 10) == close and rsi_val < ta.highest(rsi_val, 10)
bull_div = ta.lowest(close, 10) == close and rsi_val > ta.lowest(rsi_val, 10)

var string div_txt = "CLEAR"
var color  div_color = color.rgb(60, 60, 60)

if bear_div
    div_txt := "BEAR ALERT"
    div_color := color.rgb(255, 50, 50)
else if bull_div
    div_txt := "BULL ALERT"
    div_color := color.rgb(0, 255, 128)
else if ta.crossunder(rsi_val, 50) or ta.crossover(rsi_val, 50)
    div_txt := "CLEAR"
    div_color := color.rgb(60, 60, 60)

// ==========================================
// 7. DRAW DASHBOARD TABLE
// ==========================================
var dash = table.new(position.bottom_center, 8, 2, bgcolor=color.new(#0d0d0e, 10), border_width=1, border_color=color.rgb(40, 40, 40))

if barstate.islast
    table.cell(dash, 0, 0, "STATUS", text_color=color.gray, text_size=size.small)
    table.cell(dash, 1, 0, "CASH P&L", text_color=color.gray, text_size=size.small)
    table.cell(dash, 2, 0, "ADX", text_color=color.gray, text_size=size.small)
    table.cell(dash, 3, 0, "SUPERTREND", text_color=color.gray, text_size=size.small)
    table.cell(dash, 4, 0, "EMA STACK", text_color=color.gray, text_size=size.small)
    table.cell(dash, 5, 0, "ALIGNMENT", text_color=color.gray, text_size=size.small)
    table.cell(dash, 6, 0, "CHOP IDX", text_color=color.gray, text_size=size.small)
    table.cell(dash, 7, 0, "DIV HINT", text_color=color.gray, text_size=size.small)

    table.cell(dash, 0, 1, status_txt, bgcolor=status_color, text_color=color.rgb(0, 0, 0), text_size=size.small)
    table.cell(dash, 1, 1, "â‚¹" + str.tostring(math.round(cash_pnl)), bgcolor=color.rgb(255, 230, 0), text_color=pnl_color, text_size=size.normal)
    table.cell(dash, 2, 1, str.tostring(math.round(adx, 1)), bgcolor=color.rgb(88, 75, 75), text_color=color.rgb(0, 0, 0), text_size=size.small)
    table.cell(dash, 3, 1, st_txt, bgcolor=st_color, text_color=color.rgb(0, 0, 0), text_size=size.small)
    table.cell(dash, 4, 1, ema_txt, bgcolor=ema_color, text_color=color.rgb(0, 0, 0), text_size=size.small)
    table.cell(dash, 5, 1, align_txt, bgcolor=align_color, text_color=color.rgb(0, 0, 0), text_size=size.small)
    table.cell(dash, 6, 1, str.tostring(math.round(chop_idx)), bgcolor=color.rgb(40,40,40), text_color=color.yellow, text_size=size.small)
    table.cell(dash, 7, 1, div_txt, bgcolor=div_color, text_color=color.rgb(0, 0, 0), text_size=size.small)
