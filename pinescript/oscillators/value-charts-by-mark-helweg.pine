//@version=6
indicator("Value Charts [Mark Helweg]", shorttitle="Value Charts", overlay=false)

//------------------------------------
// Inputs - CORE
//------------------------------------
length = input.int(50, "Period (Value Chart)", minval=1)
useAutoMult = input.bool(false, "â˜ Use Auto Volatility Factor")
manualMult = input.float(1.0, "Manual Volatility Factor", minval=0.1, step=0.1)
src = input.source(close, "Price Source")

// JANELAS INDEPENDENTES
volSampleWindow = input.int(50, "Volatility Sample Window", minval=10, maxval=500, 
     tooltip="Para auto-adjust do Volatility Factor")
limitSampleWindow = input.int(200, "Limits Sample Window", minval=50, maxval=2000, 
     tooltip="Para auto-adjust dos limites (maior = mais estÃ¡vel)")

useAutoLimits = input.bool(true, "â˜ Use Auto Upper/Lower Limits")
manualTop = input.float(11.0, "Manual Upper Limit")
manualBottom = input.float(-18.0, "Manual Lower Limit")
limitPercentile = input.float(92.0, "Limit Percentile %", minval=85.0, maxval=98.0, step=0.5)

showTable = input.bool(true, "Show Debug Table")

// Inputs - Table Colors
groupColors = "ðŸ“Š Table Colors"
colorHeaderBg = input.color(color.gray, "Header Background", group=groupColors)
colorHeaderText = input.color(color.white, "Header Text", group=groupColors)
colorAutoMode = input.color(color.green, "Auto Mode Text", group=groupColors)
colorManualMode = input.color(color.gray, "Manual Mode Text", group=groupColors)
colorMultValue = input.color(color.purple, "Mult Value", group=groupColors)
colorTopLimit = input.color(color.green, "Top Limit", group=groupColors)
colorBottomLimit = input.color(color.red, "Bottom Limit", group=groupColors)
colorExtremes = input.color(color.blue, "Extremes Background", group=groupColors)
colorExtremesText = input.color(color.white, "Extremes Text", group=groupColors)

//------------------------------------
// VOLATILITY AUTO
//------------------------------------
atrLength = 14
atrBase = ta.atr(atrLength)
smaAtr = ta.sma(atrBase, length)
priceWindow = math.min(volSampleWindow * 2, 200)
rawAutoMult = smaAtr / ((ta.highest(high, priceWindow) - ta.lowest(low, priceWindow)) / 10)
autoMult = ta.sma(rawAutoMult, 3)
multFinal = useAutoMult ? autoMult : manualMult

//------------------------------------
// Core + Value units
//------------------------------------
basis = ta.sma(src, length)
tr = ta.tr(true)
dev = ta.sma(tr, length) * multFinal
dev := dev == 0.0 ? na : dev
vOpen  = (open  - basis) / dev
vHigh  = (high  - basis) / dev
vLow   = (low   - basis) / dev
vClose = (close - basis) / dev

//------------------------------------
// LIMITS AUTO (SIMÃ‰TRICO)
//------------------------------------
lookbackLimits = math.min(limitSampleWindow, 2000)
vcHighs = ta.highest(vHigh, lookbackLimits)
vcLows  = ta.lowest(vLow,  lookbackLimits)
percentileFactor = limitPercentile / 100.0

finalTop    = useAutoLimits ? vcHighs * percentileFactor : manualTop
finalBottom = useAutoLimits ? vcLows / percentileFactor   : manualBottom

//------------------------------------
// Candles Value Chart
//------------------------------------
bull = vClose >= vOpen
barColor = bull ? color.new(color.teal, 0) : color.new(color.red, 0)
plotcandle(vOpen, vHigh, vLow, vClose, color=barColor, wickcolor=barColor, bordercolor=barColor)

//------------------------------------
// Dynamic bands (topo verde, fundo vermelho)
//------------------------------------
plot(finalTop,    "Top Limit",    color=color.green, linewidth=2)
plot(finalBottom, "Bottom Limit", color=color.red,   linewidth=2)
plot(0,           "Zero",         color=color.gray,  linewidth=1)

//------------------------------------
// Tabela de debug
//------------------------------------
if showTable and barstate.isconfirmed
    var table infoTable = table.new(position.top_right, 2, 9, bgcolor=color.new(color.white, 80), border_width=1)
    
    table.cell(infoTable, 0, 0, "Symbol", text_color=colorHeaderText, bgcolor=colorHeaderBg)
    table.cell(infoTable, 1, 0, syminfo.ticker, text_color=colorHeaderText, bgcolor=colorHeaderBg)
    
    table.cell(infoTable, 0, 1, "Vol Window", text_color=colorHeaderText)
    table.cell(infoTable, 1, 1, str.tostring(volSampleWindow), text_color=color.orange)
    table.cell(infoTable, 0, 2, "Limit Window", text_color=colorHeaderText)
    table.cell(infoTable, 1, 2, str.tostring(limitSampleWindow), text_color=color.orange)
    
    table.cell(infoTable, 0, 3, "Mult Mode", text_color=colorHeaderText)
    table.cell(infoTable, 1, 3, useAutoMult ? "AUTO" : "MANUAL", text_color=useAutoMult ? colorAutoMode : colorManualMode)
    table.cell(infoTable, 0, 4, "FINAL Mult", text_color=colorHeaderText)
    table.cell(infoTable, 1, 4, str.tostring(multFinal, "#.###"), text_color=colorMultValue)
    
    table.cell(infoTable, 0, 5, "Limits Mode", text_color=colorHeaderText)
    table.cell(infoTable, 1, 5, useAutoLimits ? "AUTO" : "MANUAL", text_color=useAutoLimits ? colorAutoMode : colorManualMode)
    
    table.cell(infoTable, 0, 6, "Top/Bottom", text_color=colorHeaderText)
    table.cell(infoTable, 1, 6, str.tostring(finalTop, "#.#") + "/" + str.tostring(finalBottom, "#.#"), text_color=colorTopLimit)
    
    table.cell(infoTable, 0, 7, "VC Extremes", text_color=colorExtremesText, bgcolor=colorExtremes)
    table.cell(infoTable, 1, 7, str.tostring(vcHighs, "#.#") + "/" + str.tostring(vcLows, "#.#"), text_color=colorExtremesText, bgcolor=colorExtremes)
    
    table.cell(infoTable, 0, 8, "Dev Atual", text_color=colorHeaderText)
    table.cell(infoTable, 1, 8, str.tostring(dev, "#.##"), text_color=color.yellow)
