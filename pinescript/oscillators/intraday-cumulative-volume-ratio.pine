//@version=5
indicator("Intraday Cumulative Volume Ratio", shorttitle="ICVR", overlay=false)

// ----------------------------------------------------------------------
// DESCRIPTION:
// This indicator measures the ratio of cumulative buy volume vs. sell volume
// starting from the beginning of the session.
// It uses lower timeframe data (Intrabar) for maximum precision.
//
// Values (Zero-Based):
// 0.0 = Balanced Market (Buy Volume = Sell Volume)
// 1.0 = Buyers have 2x more volume than sellers
// 2.0 = Buyers have 3x more volume than sellers
// ----------------------------------------------------------------------

// --- Settings ---
var string grp_data = "Data & Precision"
res_period = input.timeframe("D", "Reset Calculation Every...", group=grp_data)
lower_tf = input.timeframe("1", "Analytical Timeframe", group=grp_data, tooltip="For maximum accuracy, keep this at '1' (minute). The indicator reads volume data 'inside' the candle.")

var string grp_fix = "Extreme Value Filter (Clamping)"
use_limit = input.bool(true, "Enable Max Limit (Clamp)", group=grp_fix, tooltip="Prevents chart distortion caused by extreme volume imbalances (e.g., at market open).")
limit_val = input.float(3.0, "Max Value Limit (+/-)", group=grp_fix, tooltip="Any ratio above this value (e.g., 3.0) will be capped visually to keep the chart readable.")

var string grp_vis = "Visual Reference"
ref_level = input.float(2.0, "Dominance Level (+/-)", group=grp_vis, tooltip="Draws a reference line at this level for easy orientation.")

// --- 1. Get Precision Data (Intrabar) ---
arrVol = request.security_lower_tf(syminfo.tickerid, lower_tf, volume)
arrClose = request.security_lower_tf(syminfo.tickerid, lower_tf, close)
arrOpen = request.security_lower_tf(syminfo.tickerid, lower_tf, open)

// --- 2. Calculate Volume Inside Candle ---
float currentBuyVol = 0.0
float currentSellVol = 0.0

if array.size(arrVol) > 0
    for i = 0 to array.size(arrVol) - 1
        float v = array.get(arrVol, i)
        float c = array.get(arrClose, i)
        float o = array.get(arrOpen, i)
        
        if c > o
            currentBuyVol += v
        else if c < o
            currentSellVol += v
        else
            // Split Doji (neutral) candles 50/50
            currentBuyVol += (v * 0.5)
            currentSellVol += (v * 0.5)

// --- 3. Accumulation (Session Based) ---
bool isNewSession = ta.change(time(res_period)) != 0

var float totalBuy = 0.0
var float totalSell = 0.0

if isNewSession
    totalBuy := currentBuyVol
    totalSell := currentSellVol
else
    totalBuy += currentBuyVol
    totalSell += currentSellVol

// --- 4. Calculate RATIO (Zero Based) ---
// Logic: (Major Side / Minor Side) - 1
// Example: Buy 300, Sell 100 -> Ratio 3.0 -> Chart shows 2.0
float zeroBasedRatio = 0.0
float safeBuy = totalBuy == 0 ? 1 : totalBuy
float safeSell = totalSell == 0 ? 1 : totalSell

if totalBuy >= totalSell
    zeroBasedRatio := (safeBuy / safeSell) - 1
else
    zeroBasedRatio := -((safeSell / safeBuy) - 1)

// --- 5. CLAMPING (Fix Extremes) ---
// If value exceeds limit, cap it for visualization
if use_limit
    if zeroBasedRatio > limit_val
        zeroBasedRatio := limit_val
    if zeroBasedRatio < -limit_val
        zeroBasedRatio := -limit_val

// --- 6. Plotting ---
hline(0, "Zero (Balanced)", color=color.gray, linestyle=hline.style_solid)

// Reference lines for trend strength
hline(ref_level, "Buy Dominance Ref", color=color.new(color.gray, 60), linestyle=hline.style_dashed)
hline(-ref_level, "Sell Dominance Ref", color=color.new(color.gray, 60), linestyle=hline.style_dashed)

// Columns
// Color indicates side only (Green = Buy, Red = Sell)
color col = zeroBasedRatio > 0 ? color.new(color.green, 20) : color.new(color.red, 20)
plot(zeroBasedRatio, title="Volume Ratio", style=plot.style_columns, color=col)

// --- 7. Info Panel (Label) ---
var label infoLabel = label.new(bar_index, high, "", textcolor=color.white)

if barstate.islast
    label.set_xy(infoLabel, bar_index + 1, zeroBasedRatio)
    
    // Convert back to "Human Readable" ratio (add 1 back)
    float humanRatio = math.abs(zeroBasedRatio) + 1
    string side = zeroBasedRatio >= 0 ? "BUYERS" : "SELLERS"
    string suffix = ""
    
    // Indicator that value is capped
    if use_limit and math.abs(zeroBasedRatio) >= limit_val
        suffix := "+"
    
    // Text format: "BUYERS lead by 2.5x"
    string txt = side + " lead by " + str.tostring(humanRatio, "#.1") + "x" + suffix
                 
    label.set_text(infoLabel, txt)
    label.set_style(infoLabel, label.style_label_left)
    
    // Label color based on winning side
    label.set_color(infoLabel, zeroBasedRatio > 0 ? color.new(color.green, 40) : color.new(color.red, 40))
    
//glhf
