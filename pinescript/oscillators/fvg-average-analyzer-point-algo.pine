//@version=5
indicator("FVG Average Analyzer[point algo] ", shorttitle="FVG-Avg pointalgo", overlay=false)

// ========================================
// 1. SETTINGS
// ========================================
lookback = input.int(20, "Average Period (SMA)", minval=1)
threshold = input.float(1.0, "Significant Multiplier", step=0.1)

// ========================================
// 2. FVG DETECTION
// ========================================

var float fvg_size = 0.0
var bool is_fvg = false

bull_gap = low[0] - high[2]
is_bull_fvg = bull_gap > 0

bear_gap = low[2] - high[0]
is_bear_fvg = bear_gap > 0

if is_bull_fvg
    fvg_size := bull_gap
    is_fvg := true
else if is_bear_fvg
    fvg_size := bear_gap
    is_fvg := true
else
    fvg_size := 0.0
    is_fvg := false

// ========================================
// 3. AVERAGE CALCULATION
// ========================================

avg_fvg_size = ta.sma(fvg_size, lookback)

// ========================================
// 4. PLOTTING
// ========================================
col_fvg = is_bull_fvg ? color.new(color.green, 40) : is_bear_fvg ? color.new(color.red, 40) : color.new(color.gray, 90)
plot(fvg_size, "FVG Size", color=col_fvg, style=plot.style_line, linewidth=2)
plot(avg_fvg_size, "Average FVG Size", color=color.yellow, linewidth=2)
is_mega = fvg_size > (avg_fvg_size * 2) and fvg_size > 0
plotshape(is_mega, "Mega Gap", shape.diamond, location.top, color.white, size=size.tiny, title="High Impact Gap")

// ========================================
// 5. DASHBOARD STATS
// ========================================
var table dash = table.new(position.top_right, 2, 3, bgcolor=color.new(color.black, 50))
if barstate.islast
    table.cell(dash, 0, 0, "Current Gap", text_color=color.white)
    table.cell(dash, 1, 0, str.tostring(fvg_size, format.mintick), text_color=is_bull_fvg ? color.green : is_bear_fvg ? color.red : color.gray)
    
    table.cell(dash, 0, 1, "Avg Gap Size", text_color=color.white)
    table.cell(dash, 1, 1, str.tostring(avg_fvg_size, format.mintick), text_color=color.yellow)
    
    // Efficiency Status
    status = fvg_size > avg_fvg_size ? "VOLATILE" : "EFFICIENT"
    table.cell(dash, 0, 2, "Market State", text_color=color.white)
    table.cell(dash, 1, 2, status, text_color=fvg_size > avg_fvg_size ? color.orange : color.blue)
