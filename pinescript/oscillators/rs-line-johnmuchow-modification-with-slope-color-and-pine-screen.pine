// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © HeyHoTrader modified JohnMuchow indicator to include color slope and pine screener capability. Thanks John
// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © JohnMuchow

// CODE REUSE:
// You are welcome to reuse this code as long as it is used in open-source indicators published
// only on TradingView and a link to https://www.tradingview.com/spaces/LevelUpTools/
//
// You CANNOT use this code if published, in full or part, in Protected or Invite-only TradingView indicators.
//

//@version=6
indicator(title="RS Line - Gauge Performance vs Index (EMA Slope + Screener Transitions)", shorttitle="RS Line", overlay=true, max_bars_back=5000)

//-----------------------------------------------------------
// Context filters
//-----------------------------------------------------------
onIndexSymbol   = (syminfo.type == "index")
onFuturesSymbol = (syminfo.type == "futures")

//-----------------------------------------------------------
// Inputs
//-----------------------------------------------------------
iIndex  = input.symbol(defval="SPX", title="Index")
iOffset = input.int(defval=25, minval=1, maxval=1500, step=1, title="Vertical offset of RS Line")

iShowDaily   = input.bool(true,  "Daily",   inline="I10")
iShowWeekly  = input.bool(true,  "Weekly",  inline="I10")
iShowMonthly = input.bool(true,  "Monthly", inline="I10")

iChangeColor = input.bool(false, "Color Based on Direction", inline="I1", group="RS Line Color")
iColorUp     = input.color(#41833A, "Line Up",   inline="I1", group="RS Line Color")
iColorDown   = input.color(#D15A25, "Line Down", inline="I1", group="RS Line Color")
iColor       = input.color(color.new(#5778E7, 1), "Solid Color", inline="I1a", group="RS Line Color")
iWidth       = input.int(1, "Line width", minval=1, maxval=5, inline="I1a", group="RS Line Color")

// New High Indicators (label-free: plotshape)
iShowPriceNewHighDot = input.bool(true, "Show price new high indicator?", group="New High Indicators")
iShowRSNewHighDot    = input.bool(true, "Show RS new high indicator?", group="New High Indicators")
iRecentHighLookback  = input.int(40, "Recent high look-back count", minval=10, maxval=200, group="New High Indicators")
iNewHighColor        = input.color(color.new(#70DA66, 44), "New High Shape Color", group="New High Indicators")

styleOption = input.string(
     defval="Circle",
     title="New High Shape Style",
     options=["Circle","Diamond","Square","Triangle up","Triangle down","Arrow up","Arrow down","Cross","X","None"],
     group="New High Indicators"
)

// Moving Average
iShowRSLineMovingAverage   = input.bool(false, "", group="Moving Average", inline="MA")
iRSLineMovingAverageType   = input.string("SMA", "", options=["SMA","EMA"], group="Moving Average", inline="MA")
iRSLineMovingAverageLength = input.int(50, "", minval=5, maxval=200, group="Moving Average", inline="MA")
iRSLineMovingAverageColor  = input.color(#C6C8CC, "", group="Moving Average", inline="MA")

// MA slope state options
iColorMABySlopeState = input.bool(true, "Color RS Moving Avg by slope state?", group="MA Slope State")
iSlopeLookbackBars   = input.int(5, "Slope lookback (bars)", minval=1, maxval=50, group="MA Slope State")
iFlatBandPct         = input.float(0.15, "Horizontal band (% move over lookback)", minval=0.01, maxval=5.0, step=0.01, group="MA Slope State")

// Pine Screener transition selection
scanTransition = input.string(
     defval="Red → White",
     title="Scan transition",
     options=["Red → White", "Green → Red", "White → Green", "Red → Green", "White → Red"],
     group="Pine Screener Outputs"
)
useConfirmedBarOnly = input.bool(true, "Only count last confirmed bar?", group="Pine Screener Outputs")

// Trendlines
iShowTrendLine1     = input.bool(false, "", group="Trendlines", inline="TL1")
iTrendLineLookback1 = input.int(10, "Lookback count", minval=1, maxval=200, group="Trendlines", inline="TL1")
iTrendLineWidth1    = input.int(1, "Width", minval=1, maxval=5, group="Trendlines", inline="TL1")

iShowTrendLine2     = input.bool(false, "", group="Trendlines", inline="TL2")
iTrendLineLookback2 = input.int(50, "Lookback count", minval=1, maxval=200, group="Trendlines", inline="TL2")
iTrendLineWidth2    = input.int(1, "Width", minval=1, maxval=5, group="Trendlines", inline="TL2")

//-----------------------------------------------------------
// Display filter
//-----------------------------------------------------------
displayRSData =
     ((timeframe.isdaily and iShowDaily) or (timeframe.isweekly and iShowWeekly) or (timeframe.ismonthly and iShowMonthly)) and
     not onIndexSymbol and not onFuturesSymbol

recentLookback = math.min(iRecentHighLookback, bar_index + 1)

//-----------------------------------------------------------
// Index close (daily as in original; "1D" for compatibility)
//-----------------------------------------------------------
spx   = request.security(iIndex, "1D", close, barmerge.gaps_off, barmerge.lookahead_off)
ratio = (close / spx) * 100.0

//-----------------------------------------------------------
// RS plot
//-----------------------------------------------------------
var float previousRatio = na
ratioColor = iChangeColor ? (na(previousRatio) ? iColor : (ratio > previousRatio ? iColorUp : iColorDown)) : iColor
previousRatio := ratio

rsSeries = displayRSData ? ratio * iOffset : na
plot(rsSeries, title="RS Line", color=ratioColor, linewidth=iWidth, editable=false)

//-----------------------------------------------------------
// New highs (label-free markers via plotshape)
//-----------------------------------------------------------
recentCloseHigh = ta.highest(close, recentLookback)
newCloseHigh    = close == recentCloseHigh

recentRSHigh = ta.highest(rsSeries, recentLookback)
newRSHigh    = rsSeries == recentRSHigh

showShape = (styleOption != "None")

shapeStyle = shape.circle
if styleOption == "Diamond"
    shapeStyle := shape.diamond
else if styleOption == "Square"
    shapeStyle := shape.square
else if styleOption == "Triangle up"
    shapeStyle := shape.triangleup
else if styleOption == "Triangle down"
    shapeStyle := shape.triangledown
else if styleOption == "Arrow up"
    shapeStyle := shape.arrowup
else if styleOption == "Arrow down"
    shapeStyle := shape.arrowdown
else if styleOption == "Cross"
    shapeStyle := shape.cross
else if styleOption == "X"
    shapeStyle := shape.xcross

plotshape(displayRSData and barstate.islast and showShape and iShowPriceNewHighDot and newCloseHigh,
     title="Price New High",
     style=shapeStyle,
     location=location.belowbar,
     color=iNewHighColor,
     size=size.tiny)

plotshape(displayRSData and barstate.islast and showShape and iShowRSNewHighDot and newRSHigh,
     title="RS New High",
     style=shapeStyle,
     location=location.abovebar,
     color=iNewHighColor,
     size=size.tiny)

//-----------------------------------------------------------
// Trendlines
//-----------------------------------------------------------
var line trendLine1 = line.new(x1=bar_index, y1=rsSeries, x2=bar_index, y2=rsSeries, color=color.green)
var line trendLine2 = line.new(x1=bar_index, y1=rsSeries, x2=bar_index, y2=rsSeries, color=color.green)

if displayRSData and barstate.islast
    lb1 = math.min(iTrendLineLookback1, bar_index)
    lb2 = math.min(iTrendLineLookback2, bar_index)

    if iShowTrendLine1 and lb1 > 0
        end1 = rsSeries[lb1]
        c1   = rsSeries > end1 ? color.green : color.red
        line.set_color(trendLine1, c1)
        line.set_width(trendLine1, iTrendLineWidth1)
        line.set_xy1(trendLine1, bar_index, rsSeries)
        line.set_xy2(trendLine1, bar_index[lb1], end1)

    if iShowTrendLine2 and lb2 > 0
        end2 = rsSeries[lb2]
        c2   = rsSeries > end2 ? color.green : color.red
        line.set_color(trendLine2, c2)
        line.set_width(trendLine2, iTrendLineWidth2)
        line.set_xy1(trendLine2, bar_index, rsSeries)
        line.set_xy2(trendLine2, bar_index[lb2], end2)

//-----------------------------------------------------------
// RS moving average + slope-state coloring
//-----------------------------------------------------------
rsMA =
     iRSLineMovingAverageType == "SMA" ? ta.sma(rsSeries, iRSLineMovingAverageLength)
                                       : ta.ema(rsSeries, iRSLineMovingAverageLength)

plotMovingAverage = displayRSData and iShowRSLineMovingAverage

maRef     = bar_index >= iSlopeLookbackBars ? rsMA[iSlopeLookbackBars] : na
maDelta   = not na(maRef) ? (rsMA - maRef) : na
maPctMove = (not na(maRef) and maRef != 0.0) ? (maDelta / maRef) * 100.0 : na

maUp    = not na(maPctMove) and maPctMove >  iFlatBandPct
maDown  = not na(maPctMove) and maPctMove < -iFlatBandPct
maState = maUp ? 1 : maDown ? -1 : 0  // 1=Green, 0=White, -1=Red

maStateColor = maUp ? color.green : maDown ? color.red : color.white
maPlotColor  = iColorMABySlopeState ? maStateColor : iRSLineMovingAverageColor

plot(plotMovingAverage ? rsMA : na, title="RS Moving Average", color=maPlotColor, linewidth=2, editable=false)

//-----------------------------------------------------------
// Pine Screener numeric outputs (INCLUDES requested transitions)
//-----------------------------------------------------------
prevState = nz(maState[1], 0)

redToWhite   = (prevState == -1) and (maState == 0)   // Code 1
greenToRed   = (prevState ==  1) and (maState == -1)  // Code 2
whiteToGreen = (prevState ==  0) and (maState == 1)   // Code 3
redToGreen   = (prevState == -1) and (maState == 1)   // Code 4
whiteToRed   = (prevState ==  0) and (maState == -1)  // Code 5

// 1=R→W, 2=G→R, 3=W→G, 4=R→G, 5=W→R
txCode =
     redToWhite   ? 1 :
     greenToRed   ? 2 :
     whiteToGreen ? 3 :
     redToGreen   ? 4 :
     whiteToRed   ? 5 :
     0

selectedMatch =
     (scanTransition == "Red → White"   and redToWhite) or
     (scanTransition == "Green → Red"   and greenToRed) or
     (scanTransition == "White → Green" and whiteToGreen) or
     (scanTransition == "Red → Green"   and redToGreen) or
     (scanTransition == "White → Red"   and whiteToRed)

matchNow = (useConfirmedBarOnly ? barstate.isconfirmed : true) and selectedMatch

// Screener-friendly plots (filter on these)
plot(maState, title="SCREENER: MA State (1 Green, 0 White, -1 Red)", display=display.data_window)
plot(txCode,  title="SCREENER: Transition Code (1 R→W, 2 G→R, 3 W→G, 4 R→G, 5 W→R)", display=display.data_window)
plot(matchNow ? 1 : 0, title="SCREENER: Transition Match (1=yes)", display=display.data_window)

// Alerts (optional)
alertcondition(redToWhite,   "Transition Red→White",   "MA state transitioned from Red to White.")
alertcondition(greenToRed,   "Transition Green→Red",   "MA state transitioned from Green to Red.")
alertcondition(whiteToGreen, "Transition White→Green", "MA state transitioned from White to Green.")
alertcondition(redToGreen,   "Transition Red→Green",   "MA state transitioned from Red to Green.")
alertcondition(whiteToRed,   "Transition White→Red",   "MA state transitioned from White to Red.")
