//@version=6
indicator("USDJPY Timing Composite (5-Component)", overlay=false)

// === INPUTS ===
length = input.int(20, "Z-score Lookback Period", minval=5)
eur_weight = input.float(0.30, "-EURUSD Weight", minval=0, maxval=1, step=0.025)
chf_weight = input.float(0.30, "USDCHF Weight", minval=0, maxval=1, step=0.025)
rate_weight = input.float(0.25, "US02Y Weight", minval=0, maxval=1, step=0.025)
chfjpy_weight = input.float(0.075, "CHFJPY Weight", minval=0, maxval=1, step=0.025)
eurjpy_weight = input.float(0.075, "EURJPY Weight", minval=0, maxval=1, step=0.025)
extreme_threshold = input.float(1.5, "Extreme Threshold", minval=0.5, step=0.1)
show_alignment = input.bool(true, "Show Component Alignment Indicator")

// === GET DATA ===
eurusd = request.security("FX:EURUSD", timeframe.period, close)
usdchf = request.security("FX:USDCHF", timeframe.period, close)
us02y = request.security("TVC:US02Y", timeframe.period, close)
chfjpy = request.security("FX:CHFJPY", timeframe.period, close)
eurjpy = request.security("FX:EURJPY", timeframe.period, close)

// === CALCULATE Z-SCORES ===
// -EURUSD z-score (INVERTED: strong USD/weak EUR = bullish USDJPY)
eur_mean = ta.sma(eurusd, length)
eur_std = ta.stdev(eurusd, length)
eur_zscore = -(eurusd - eur_mean) / eur_std  // INVERTED

// USDCHF z-score (strong USD = bullish USDJPY)
chf_mean = ta.sma(usdchf, length)
chf_std = ta.stdev(usdchf, length)
chf_zscore = (usdchf - chf_mean) / chf_std

// US02Y z-score (high yields = bullish USDJPY)
rate_mean = ta.sma(us02y, length)
rate_std = ta.stdev(us02y, length)
rate_zscore = (us02y - rate_mean) / rate_std

// CHFJPY z-score (weak JPY = bullish USDJPY)
chfjpy_mean = ta.sma(chfjpy, length)
chfjpy_std = ta.stdev(chfjpy, length)
chfjpy_zscore = (chfjpy - chfjpy_mean) / chfjpy_std

// EURJPY z-score (weak JPY = bullish USDJPY)
eurjpy_mean = ta.sma(eurjpy, length)
eurjpy_std = ta.stdev(eurjpy, length)
eurjpy_zscore = (eurjpy - eurjpy_mean) / eurjpy_std

// === COMPOSITE SIGNAL ===
composite = (eur_weight * eur_zscore) + (chf_weight * chf_zscore) + (rate_weight * rate_zscore) + (chfjpy_weight * chfjpy_zscore) + (eurjpy_weight * eurjpy_zscore)

// === CREATE CANDLES WITHOUT WICKS ===
comp_open = composite[1]  // Previous bar's close becomes this bar's open
comp_high = math.max(composite, composite[1])  // High = max of open and close
comp_low = math.min(composite, composite[1])   // Low = min of open and close
comp_close = composite

// === PLOT CANDLES ===
plotcandle(comp_open, comp_high, comp_low, comp_close, "Composite", color = comp_close >= comp_open ? color.green : color.red, wickcolor = comp_close >= comp_open ? color.green : color.red, bordercolor = comp_close >= comp_open ? color.green : color.red)

// === REFERENCE LINES ===
hline(0, "Neutral", color=color.gray, linestyle=hline.style_dashed)
hline(extreme_threshold, "Overbought", color=color.red, linestyle=hline.style_dotted)
hline(-extreme_threshold, "Oversold", color=color.green, linestyle=hline.style_dotted)

// === BACKGROUND SHADING ===
bgcolor(composite > extreme_threshold ? color.new(color.red, 90) : na, title="Overbought Zone")
bgcolor(composite < -extreme_threshold ? color.new(color.green, 90) : na, title="Oversold Zone")

// === COMPONENT ALIGNMENT INDICATOR ===
// Count how many components are bullish (positive z-score)
bullish_count = 0
if eur_zscore > 0
    bullish_count := bullish_count + 1
if chf_zscore > 0
    bullish_count := bullish_count + 1
if rate_zscore > 0
    bullish_count := bullish_count + 1
if chfjpy_zscore > 0
    bullish_count := bullish_count + 1
if eurjpy_zscore > 0
    bullish_count := bullish_count + 1

// Strong alignment: 4+ components agree
strong_bullish = bullish_count >= 4
strong_bearish = bullish_count <= 1

// Plot small dots at top/bottom when strong alignment (only if show_alignment is enabled)
plotshape(show_alignment and strong_bullish and composite > 0.5, "Strong Bull Alignment", shape.circle, location.top, color.new(color.lime, 0), size=size.tiny)
plotshape(show_alignment and strong_bearish and composite < -0.5, "Strong Bear Alignment", shape.circle, location.bottom, color.new(color.fuchsia, 0), size=size.tiny)