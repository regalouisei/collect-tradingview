// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Uncle_the_shooter

//@version=6
indicator("SuperTrend Oscillator MTF", overlay=false, max_bars_back=1000)

// INPUTS 
atrPeriod = input.int(10, "ATR Period")
factor    = input.float(3.0, "Factor", step=0.1)
higherTF1 = input.timeframe("120", "TF 1")
higherTF2 = input.timeframe("480", "TF 2")

useGradient = input.bool(true, "Enable gradient (soft & beautiful)", group="Gradient")
transp      = input.int(85, "Gradient intensity (70=strong, 95=subtle)", minval=70, maxval=95, group="Gradient")
showLabels3TF = input.bool(true, "Show BUY/SELL labels (3 TF agreement)", group="3TF Labels")

// COLORS 
colBull2 = input.color(color.new(#107933, 0), "TF2 Bullish", group="Colors")
colBear2 = input.color(color.new(#db0f0f, 0), "TF2 Bearish", group="Colors")
colBull1 = input.color(color.new(#1f8a22, 0), "TF1 Bullish", group="Colors")
colBear1 = input.color(color.new(#be3d3d, 0), "TF1 Bearish", group="Colors")
colBull0 = input.color(color.new(#54b859, 0), "Current TF Bullish", group="Colors")
colBear0 = input.color(color.new(#e06161, 0), "Current TF Bearish", group="Colors")

// SUPER TREND
f_st() =>
    hl2_src = hl2
    atrv = ta.atr(atrPeriod)
    up = hl2_src - factor * atrv
    dn = hl2_src + factor * atrv
    var float trend = na
    var float st = na
    up := close[1] > up[1] ? math.max(up, up[1]) : up
    dn := close[1] < dn[1] ? math.min(dn, dn[1]) : dn
    trend := close > dn[1] ? 1 : close < up[1] ? -1 : trend[1]
    st := trend == 1 ? up : dn
    st - close

dist    = f_st()
distTF1 = request.security(syminfo.tickerid, higherTF1, f_st(), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
distTF2 = request.security(syminfo.tickerid, higherTF2, f_st(), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)

// NORMALIZATION IN PERCENT
osc   = (dist   / close) * 100
osc1  = (distTF1 / close) * 100
osc2  = (distTF2 / close) * 100

// DYNAMIC COLORS 
colorOsc  = osc  > 0 ? colBear0 : colBull0
colorOsc1 = osc1 > 0 ? colBear1 : colBull1
colorOsc2 = osc2 > 0 ? colBear2 : colBull2

// 3 TF AGREEMENT 
allBull = osc < 0 and osc1 < 0 and osc2 < 0
allBear = osc > 0 and osc1 > 0 and osc2 > 0

// Detect START of agreement
bullConfirm  = allBull and not allBull[1]
bearConfirm  = allBear and not allBear[1]

// ZERO LINE COLOR
zeroColor = allBull ? color.new(colBull0, 30) : allBear ? color.new(colBear0, 30) : color.new(color.gray, 80)

// LINES 
p0     = plot(0, "Zero Line", color=zeroColor, linewidth=6)
p_osc  = plot(osc,  "Current TF", color=colorOsc,  linewidth=2)
p_osc1 = plot(osc1, "TF1",        color=colorOsc1, linewidth=2)
p_osc2 = plot(osc2, "TF2",        color=colorOsc2, linewidth=2)

// SIGNALS 
bullCircle = ta.crossunder(osc, 0)
bearCircle = ta.crossover(osc, 0)

plotshape(bullCircle ? osc - 0.5 : na, style=shape.circle, location=location.absolute, color=colorOsc, size=size.small, title="Bull Circle")
plotshape(bearCircle ? osc + 0.5 : na, style=shape.circle, location=location.absolute, color=colorOsc, size=size.small, title="Bear Circle")

// BUY / SELL LABELS 
plotshape(showLabels3TF and bullConfirm ? -0.3 : na, title="BUY – 3 TF Bullish", style=shape.labelup, location=location.absolute, color=color.new(colBull0, 30), textcolor=color.white, size=size.small, text="BUY")
plotshape(showLabels3TF and bearConfirm ? 0.3 : na, title="SELL – 3 TF Bearish", style=shape.labeldown, location=location.absolute, color=color.new(colBear0, 30), textcolor=color.white, size=size.small, text="SELL")

// GRADIENTS 
c_transp = color.new(color.white, 100)
c_grad0_bull = color.new(colBull0, transp)
c_grad0_bear = color.new(colBear0, transp)
c_grad1_bull = color.new(colBull1, transp)
c_grad1_bear = color.new(colBear1, transp)
c_grad2_bull = color.new(colBull2, transp)
c_grad2_bear = color.new(colBear2, transp)

fill(p_osc, p0, osc > 0 ? osc : na, osc > 0 ? 0 : na, osc > 0 and useGradient ? c_grad0_bear : na, osc > 0 and useGradient ? c_transp : na)
fill(p0, p_osc, osc < 0 ? 0 : na, osc < 0 ? osc : na, osc < 0 and useGradient ? c_transp : na, osc < 0 and useGradient ? c_grad0_bull : na)
fill(p_osc1, p0, osc1 > 0 ? osc1 : na, osc1 > 0 ? 0 : na, osc1 > 0 and useGradient ? c_grad1_bear : na, osc1 > 0 and useGradient ? c_transp : na)
fill(p0, p_osc1, osc1 < 0 ? 0 : na, osc1 < 0 ? osc1 : na, osc1 < 0 and useGradient ? c_transp : na, osc1 < 0 and useGradient ? c_grad1_bull : na)
fill(p_osc2, p0, osc2 > 0 ? osc2 : na, osc2 > 0 ? 0 : na, osc2 > 0 and useGradient ? c_grad2_bear : na, osc2 > 0 and useGradient ? c_transp : na)
fill(p0, p_osc2, osc2 < 0 ? 0 : na, osc2 < 0 ? osc2 : na, osc2 < 0 and useGradient ? c_transp : na, osc2 < 0 and useGradient ? c_grad2_bull : na)
fill(p_osc, p_osc1, osc > osc1 and osc > 0 and osc1 > 0 and useGradient ? osc : na, osc > osc1 and osc > 0 and osc1 > 0 ? osc1 : na, c_grad0_bear, c_transp)
fill(p_osc1, p_osc, osc1 > osc and osc1 > 0 and osc > 0 and useGradient ? osc1 : na, osc1 > osc and osc1 > 0 and osc > 0 ? osc : na, c_grad1_bear, c_transp)
fill(p_osc, p_osc1, osc < osc1 and osc < 0 and osc1 < 0 and useGradient ? osc1 : na, osc < osc1 and osc < 0 and osc1 < 0 ? osc : na, c_transp, c_grad0_bull)
fill(p_osc1, p_osc, osc1 < osc and osc1 < 0 and osc < 0 and useGradient ? osc : na, osc1 < osc and osc1 < 0 and osc < 0 ? osc1 : na, c_transp, c_grad1_bull)

// ALERTS 
alertcondition(bullCircle, "Supertrend Oscillator – Bull Circle", "Bullish circle signal")
alertcondition(bearCircle, "Supertrend Oscillator – Bear Circle", "Bearish circle signal")
alertcondition(bullConfirm, "BUY – 3 TF Bullish", "BUY: All 3 SuperTrends bullish!")
alertcondition(bearConfirm, "SELL – 3 TF Bearish", "SELL: All 3 SuperTrends bearish!")
