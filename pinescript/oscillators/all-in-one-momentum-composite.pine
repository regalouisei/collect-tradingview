//@version=5
indicator(title="All-in-One Momentum Composite [Grok Edition - Fixed]", shorttitle="Momentum Composite", overlay=false)

// === Inputs ===
rsiLength = input.int(14, title="RSI Length")
stochK = input.int(14, title="Stochastic %K Length")
stochD = input.int(3, title="Stochastic %D Smoothing")
wtChannelLen = input.int(10, title="WaveTrend Channel Length")
wtAverageLen = input.int(21, title="WaveTrend Average Length")
wtMALen = input.int(4, title="WaveTrend Signal Smoothing")
macdFast = input.int(12, title="MACD Fast Length")
macdSlow = input.int(26, title="MACD Slow Length")
macdSignal = input.int(9, title="MACD Signal Length")

// Weights (sum to 100 for easy balance)
wRSI = input.int(25, title="RSI Weight (%)")
wStoch = input.int(25, title="Stochastic Weight (%)")
wWT = input.int(25, title="WaveTrend Weight (%)")
wMACD = input.int(25, title="MACD Histogram Weight (%)")

// Composite smoothing
compositeSmooth = input.int(3, title="Composite Line Smoothing (EMA)")

// Divergence detection
showDiv = input.bool(true, title="Show Divergences")
divLeft = input.int(5, title="Divergence Left Bars")
divRight = input.int(3, title="Divergence Right Bars")
showHiddenDiv = input.bool(false, title="Include Hidden Divergences")
maxBarsBetweenPivots = input.int(50, title="Max Bars Between Pivots")

// OB/OS levels
obLevel = input.int(70, title="Overbought Level")
osLevel = input.int(30, title="Oversold Level")

// === Individual Momentum Calculations ===
// RSI (0-100)
rsi = ta.rsi(close, rsiLength)

// Stochastic %D (0-100)
stochKVal = ta.stoch(close, high, low, stochK)
stochDVal = ta.sma(stochKVal, stochD)

// WaveTrend (classic, shifted/clamped to ~0-100)
ap = hlc3
esa = ta.ema(ap, wtChannelLen)
d = ta.ema(math.abs(ap - esa), wtChannelLen)
ci = (ap - esa) / (0.015 * d)
wtTci = ta.ema(ci, wtAverageLen)
wtT1 = ta.ema(wtTci, wtMALen)
waveTrend = math.max(0, math.min(100, wtT1 + 50))

// MACD Histogram (normalized ~0-100, centered at 50)
[macdLine, signalLine, hist] = ta.macd(close, macdFast, macdSlow, macdSignal)
histRange = ta.highest(math.abs(hist), 50)
normMACD = histRange != 0 ? 50 + 50 * (hist / histRange) : 50

// === Normalization ===
normRSI = rsi
normStoch = stochDVal
normWT = waveTrend

// === Composite Score ===
totalWeight = wRSI + wStoch + wWT + wMACD
compositeRaw = (wRSI * normRSI + wStoch * normStoch + wWT * normWT + wMACD * normMACD) / totalWeight
composite = ta.ema(compositeRaw, compositeSmooth)

// === Plotting ===
plot(composite, title="Momentum Composite", color=color.blue, linewidth=2)
hline(50, "Centerline", color=color.gray, linestyle=hline.style_dashed)
hline(obLevel, "Overbought", color=color.red, linestyle=hline.style_dotted)
hline(osLevel, "Oversold", color=color.green, linestyle=hline.style_dotted)
fill(hline(obLevel), hline(100), color=color.new(color.red, 90))
fill(hline(0), hline(osLevel), color=color.new(color.green, 90))
bgcolor(composite > obLevel ? color.new(color.red, 90) : composite < osLevel ? color.new(color.green, 90) : na)

// === Improved Divergence Detection ===
ph = ta.pivothigh(composite, divLeft, divRight)
pl = ta.pivotlow(composite, divLeft, divRight)

if showDiv
    // Bullish Regular
    if not na(pl)
        prevPlBar = ta.barssince(pl[divRight])
        if prevPlBar <= maxBarsBetweenPivots and prevPlBar > 0
            prevPl = composite[prevPlBar + divRight]
            if low[divRight] < low[divRight + prevPlBar] and pl > prevPl
                label.new(bar_index[divRight], low[divRight], "Bull Div", style=label.style_label_up, color=color.green, textcolor=color.white, yloc=yloc.belowbar)
            // Hidden Bullish
            if showHiddenDiv and low[divRight] > low[divRight + prevPlBar] and pl < prevPl
                label.new(bar_index[divRight], low[divRight], "Hidden Bull", style=label.style_label_up, color=color.lime, textcolor=color.black, yloc=yloc.belowbar)

    // Bearish Regular
    if not na(ph)
        prevPhBar = ta.barssince(ph[divRight])
        if prevPhBar <= maxBarsBetweenPivots and prevPhBar > 0
            prevPh = composite[prevPhBar + divRight]
            if high[divRight] > high[divRight + prevPhBar] and ph < prevPh
                label.new(bar_index[divRight], high[divRight], "Bear Div", style=label.style_label_down, color=color.red, textcolor=color.white, yloc=yloc.abovebar)
            // Hidden Bearish
            if showHiddenDiv and high[divRight] < high[divRight + prevPhBar] and ph > prevPh
                label.new(bar_index[divRight], high[divRight], "Hidden Bear", style=label.style_label_down, color=color.orange, textcolor=color.black, yloc=yloc.abovebar)

// === Alerts ===
alertcondition(ta.crossover(composite, 50), title="Bullish Crossover", message="Momentum Composite crossed above 50")
alertcondition(ta.crossunder(composite, 50), title="Bearish Crossover", message="Momentum Composite crossed below 50")
alertcondition(ta.crossover(composite, osLevel), title="Oversold Exit", message="Composite exiting oversold")
alertcondition(ta.crossunder(composite, obLevel), title="Overbought Exit", message="Composite exiting overbought")
