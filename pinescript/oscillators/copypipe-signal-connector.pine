// This Pine Scriptâ„¢ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© CopyPipe

//@version=5
indicator("CopyPipe Signal Connector", overlay=true)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Strategy Selection
strategy_type = input.string("RSI Reversal", "Strategy", options=["RSI Reversal", "EMA Cross", "Breakout", "Custom"])

// RSI Settings
rsi_length = input.int(14, "RSI Length", minval=1, group="RSI Settings")
rsi_oversold = input.int(30, "RSI Oversold", minval=1, maxval=50, group="RSI Settings")
rsi_overbought = input.int(70, "RSI Overbought", minval=50, maxval=99, group="RSI Settings")

// EMA Settings  
ema_fast = input.int(9, "Fast EMA", minval=1, group="EMA Settings")
ema_slow = input.int(21, "Slow EMA", minval=1, group="EMA Settings")

// Breakout Settings
breakout_length = input.int(20, "Breakout Length", minval=1, group="Breakout Settings")

// Risk Management
default_lot = input.float(0.1, "Default Lot Size", minval=0.01, step=0.01, group="Risk")
use_sl_tp = input.bool(true, "Use SL/TP", group="Risk")
sl_percent = input.float(2.0, "Stop Loss %", minval=0.1, step=0.1, group="Risk")
tp_percent = input.float(4.0, "Take Profit %", minval=0.1, step=0.1, group="Risk")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALCULATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// RSI
rsi = ta.rsi(close, rsi_length)

// EMAs
ema_f = ta.ema(close, ema_fast)
ema_s = ta.ema(close, ema_slow)

// Breakout
highest_high = ta.highest(high, breakout_length)
lowest_low = ta.lowest(low, breakout_length)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIGNAL LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var bool buy_signal = false
var bool sell_signal = false

if strategy_type == "RSI Reversal"
    buy_signal := ta.crossover(rsi, rsi_oversold)
    sell_signal := ta.crossunder(rsi, rsi_overbought)
else if strategy_type == "EMA Cross"
    buy_signal := ta.crossover(ema_f, ema_s)
    sell_signal := ta.crossunder(ema_f, ema_s)
else if strategy_type == "Breakout"
    buy_signal := close > highest_high[1]
    sell_signal := close < lowest_low[1]
else // Custom - use both RSI and EMA
    buy_signal := ta.crossover(rsi, rsi_oversold) and ema_f > ema_s
    sell_signal := ta.crossunder(rsi, rsi_overbought) and ema_f < ema_s

// Calculate SL/TP prices
sl_buy = use_sl_tp ? close * (1 - sl_percent/100) : na
tp_buy = use_sl_tp ? close * (1 + tp_percent/100) : na
sl_sell = use_sl_tp ? close * (1 + sl_percent/100) : na
tp_sell = use_sl_tp ? close * (1 - tp_percent/100) : na

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLOTTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Plot EMAs
plot(strategy_type == "EMA Cross" or strategy_type == "Custom" ? ema_f : na, "Fast EMA", color=color.new(color.green, 0), linewidth=2)
plot(strategy_type == "EMA Cross" or strategy_type == "Custom" ? ema_s : na, "Slow EMA", color=color.new(color.red, 0), linewidth=2)

// Plot breakout levels
plot(strategy_type == "Breakout" ? highest_high : na, "Resistance", color=color.new(color.red, 50), style=plot.style_stepline)
plot(strategy_type == "Breakout" ? lowest_low : na, "Support", color=color.new(color.green, 50), style=plot.style_stepline)

// Signal markers
plotshape(buy_signal, "Buy", shape.triangleup, location.belowbar, color.new(color.green, 0), size=size.normal)
plotshape(sell_signal, "Sell", shape.triangledown, location.abovebar, color.new(color.red, 0), size=size.normal)

// Background color on signals
bgcolor(buy_signal ? color.new(color.green, 90) : sell_signal ? color.new(color.red, 90) : na)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTS - CopyPipe Webhook Compatible
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Alert conditions
alertcondition(buy_signal, "CopyPipe BUY", '{"action":"BUY","symbol":"{{ticker}}","lot_size":{{plot("Lot Size")}},"sl":{{plot("SL Buy")}},"tp":{{plot("TP Buy")}}}')
alertcondition(sell_signal, "CopyPipe SELL", '{"action":"SELL","symbol":"{{ticker}}","lot_size":{{plot("Lot Size")}},"sl":{{plot("SL Sell")}},"tp":{{plot("TP Sell")}}}')
alertcondition(buy_signal or sell_signal, "CopyPipe Signal", '{"action":"{{plot("Action")}}","symbol":"{{ticker}}","lot_size":{{plot("Lot Size")}}}')

// Plot values for alert placeholders (invisible)
plot(default_lot, "Lot Size", display=display.none)
plot(buy_signal ? 1 : sell_signal ? -1 : 0, "Action Raw", display=display.none)
plot(sl_buy, "SL Buy", display=display.none)
plot(tp_buy, "TP Buy", display=display.none)
plot(sl_sell, "SL Sell", display=display.none)
plot(tp_sell, "TP Sell", display=display.none)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INFO TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var table info = table.new(position.top_right, 2, 6, bgcolor=color.new(color.black, 80), border_width=1)
if barstate.islast
    table.cell(info, 0, 0, "CopyPipe", text_color=color.white, text_size=size.normal)
    table.cell(info, 1, 0, "Connector", text_color=color.blue, text_size=size.normal)
    table.cell(info, 0, 1, "Strategy:", text_color=color.gray)
    table.cell(info, 1, 1, strategy_type, text_color=color.white)
    table.cell(info, 0, 2, "Lot Size:", text_color=color.gray)
    table.cell(info, 1, 2, str.tostring(default_lot), text_color=color.yellow)
    table.cell(info, 0, 3, "RSI:", text_color=color.gray)
    table.cell(info, 1, 3, str.tostring(rsi, "#.##"), text_color=rsi < rsi_oversold ? color.green : rsi > rsi_overbought ? color.red : color.white)
    table.cell(info, 0, 4, "Signal:", text_color=color.gray)
    table.cell(info, 1, 4, buy_signal ? "BUY ðŸŸ¢" : sell_signal ? "SELL ðŸ”´" : "â€”", text_color=buy_signal ? color.green : sell_signal ? color.red : color.gray)
