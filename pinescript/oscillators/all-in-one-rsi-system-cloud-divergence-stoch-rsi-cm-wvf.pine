//@version=6
indicator("ALL-IN-ONE RSI (Cloud + ORIGINAL Divergence + StochRSI + CM_WVF ORIGINAL + BUY/SELL) [Color Settings]", overlay=false, max_labels_count=500)

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// INPUTS
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
rsiLen = input.int(title="RSI Period", minval=1, defval=14)
src    = input.source(title="RSI Source", defval=close)

// Cloud / zones
baseLen     = input.int(14, "RSI Base EMA")
osStart     = input.float(44.0, "OS Start (red ≤)")
osExtreme   = input.float(25.0, "OS Extreme (purple ≤)")
obStart     = input.float(70.0, "OB Start (green ≥)")
obExtreme   = input.float(85.0, "OB Extreme (blue ≥)")
showCloud   = input.bool(true, "Show Cloud")
cloudOp     = input.int(55, "Cloud Opacity (0=strong)", minval=0, maxval=95)

// BUY/SELL
showBuySell        = input.bool(true, "Show BUY/SELL")
buySellUseStoch    = input.bool(false, "BUY/SELL require Stoch confirmation")
buyOnExtremeOS     = input.bool(true, "BUY when crosses UP from OS (44)")
sellOnExtremeOB    = input.bool(true, "SELL when crosses DOWN from OB (70)")
buyOnPurpleExit    = input.bool(true, "BUY when exits purple (25)")
sellOnBlueExit     = input.bool(true, "SELL when exits blue (85)")

// Stoch RSI
showStoch = input.bool(true, "Show Stoch RSI")
stochLen  = input.int(14, "Stoch RSI Length")
kLen      = input.int(3, "Stoch K")
dLen      = input.int(3, "Stoch D")

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// COLOR SETTINGS (ALL IN SETTINGS PANEL)
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
rsiColor        = input.color(color.rgb(41, 98, 255), "RSI Line Color")
baseColor       = input.color(color.new(color.gray, 80), "RSI Base (EMA) Color")

cloudBullColor  = input.color(color.lime,   "Cloud: Overbought (70-85)")
cloudBearColor  = input.color(color.red,    "Cloud: Oversold (25-44)")
cloudExtremeOS  = input.color(color.purple, "Cloud: Extreme Oversold (<=25)")
cloudExtremeOB  = input.color(color.blue,   "Cloud: Extreme Overbought (>=85)")

bgBandColor     = input.color(color.blue, "OB/OS Background Color")
bgBandOpacity   = input.int(92, "OB/OS Background Opacity", minval=0, maxval=100)

stochKColor     = input.color(color.orange, "Stoch RSI %K Color")
stochDColor     = input.color(color.fuchsia,"Stoch RSI %D Color")
stochLineOpacity= input.int(45, "Stoch Lines Opacity", minval=0, maxval=100)

buyColor        = input.color(color.green, "BUY Label Color")
sellColor       = input.color(color.red,   "SELL Label Color")
labelTextColor  = input.color(color.white, "Label Text Color")

bullDivColor    = input.color(color.green, "Bull Div Stroke")
bearDivColor    = input.color(color.red,   "Bear Div Stroke")
hiddenBullDivColor = input.color(color.new(color.green, 80), "Hidden Bull Div Stroke")
hiddenBearDivColor = input.color(color.new(color.red, 80),   "Hidden Bear Div Stroke")

wvfSpikeColor   = input.color(color.lime, "WVF Spike (Green) Color")
wvfNormalColor  = input.color(color.gray, "WVF Normal (Gray) Color")
wvfRangeColor   = input.color(color.orange, "WVF Range Lines Color")
wvfBandColor    = input.color(color.aqua, "WVF Bands Color")

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// ORIGINAL DIVERGENCE INPUTS (UNCHANGED LOGIC)
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
lbR = input.int(title="Pivot Lookback Right", defval=5, display=display.data_window)
lbL = input.int(title="Pivot Lookback Left", defval=5, display=display.data_window)
rangeUpper = input.int(title="Max of Lookback Range", defval=60, display=display.data_window)
rangeLower = input.int(title="Min of Lookback Range", defval=5, display=display.data_window)

plotBull        = input.bool(title="Plot Bullish", defval=true, display=display.data_window)
plotHiddenBull  = input.bool(title="Plot Hidden Bullish", defval=false, display=display.data_window)
plotBear        = input.bool(title="Plot Bearish", defval=true, display=display.data_window)
plotHiddenBear  = input.bool(title="Plot Hidden Bearish", defval=false, display=display.data_window)

textColor = labelTextColor
noneColor = color.new(color.white, 100)

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// CM_WVF (ORIGINAL) INPUTS
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
showWVF = input.bool(true, "Show CM_Williams_Vix_Fix (shifted down, ORIGINAL shape)")
pd   = input.int(22,   title="WVF LookBack Period Standard Deviation High")
bbl  = input.int(20,   title="WVF Bollinger Band Length")
mult = input.float(2.0, minval=1, maxval=5, title="WVF Bollinger Band Std Dev Up")
lb   = input.int(50,   title="WVF Look Back Period Percentile High")
ph   = input.float(0.85, title="WVF Highest Percentile (e.g. 0.90 = 90%)", step=0.01)
pl   = input.float(1.01, title="WVF Lowest Percentile (e.g. 1.10 = 90%)", step=0.01)
hp   = input.bool(false, title="WVF Show High/Low Range (Percentile & LookBack)")
sd   = input.bool(false, title="WVF Show Standard Deviation Line")

// WVF shift inside RSI pane
wvfBase = input.float(-60.0, "WVF Vertical Shift (more negative = lower)")

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// CORE CALCS
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
osc  = ta.rsi(src, rsiLen)
base = ta.ema(osc, baseLen)

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// STOCH RSI
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
oscMin = ta.lowest(osc, stochLen)
oscMax = ta.highest(osc, stochLen)
stochRSI = oscMax != oscMin ? (osc - oscMin) / (oscMax - oscMin) : 0.0
K = ta.sma(stochRSI * 100.0, kLen)
D = ta.sma(K, dLen)

stochBull = ta.crossover(K, D) and K < 20
stochBear = ta.crossunder(K, D) and K > 80

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// CLOUD COLOR (WITH SETTINGS COLORS)
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
cloudColor =
     osc <= osExtreme ? color.new(cloudExtremeOS, cloudOp) :
     osc <= osStart   ? color.new(cloudBearColor, cloudOp) :
     osc >= obExtreme ? color.new(cloudExtremeOB, cloudOp) :
     osc >= obStart   ? color.new(cloudBullColor, cloudOp) :
     na

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// PLOTS: RSI + BASE + CLOUD
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
pOsc  = plot(osc,  title="RSI", color=color.new(rsiColor, 0), linewidth=2)
pBase = plot(base, title="RSI Base (EMA)", color=baseColor, linewidth=1)

fill(pOsc, pBase, color = showCloud ? cloudColor : na)

hline(50, title="Middle", color=color.new(#787B86, 60), linestyle=hline.style_dotted)
obLine = hline(obStart, title="Overbought", color=color.new(#787B86, 70), linestyle=hline.style_dotted)
osLine = hline(osStart, title="Oversold",  color=color.new(#787B86, 70), linestyle=hline.style_dotted)
fill(obLine, osLine, title="OB/OS Background", color=color.new(bgBandColor, bgBandOpacity))

plot(showStoch ? K : na, title="Stoch K", color=color.new(stochKColor, stochLineOpacity), linewidth=1)
plot(showStoch ? D : na, title="Stoch D", color=color.new(stochDColor, stochLineOpacity), linewidth=1)

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// BUY / SELL (labels)
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
crossUpOS    = ta.crossover(osc, osStart)
crossDownOB  = ta.crossunder(osc, obStart)
exitPurpleUp = ta.crossover(osc, osExtreme)
exitBlueDown = ta.crossunder(osc, obExtreme)

buyCond  = (buyOnExtremeOS  and crossUpOS) or (buyOnPurpleExit and exitPurpleUp)
sellCond = (sellOnExtremeOB and crossDownOB) or (sellOnBlueExit and exitBlueDown)

buyFinal  = showBuySell and buyCond  and (not buySellUseStoch or stochBull)
sellFinal = showBuySell and sellCond and (not buySellUseStoch or stochBear)

plotshape(buyFinal  ? osc : na, title="BUY",  style=shape.labelup,   location=location.absolute, text="BUY",  color=color.new(buyColor, 0),  textcolor=textColor, size=size.small)
plotshape(sellFinal ? osc : na, title="SELL", style=shape.labeldown, location=location.absolute, text="SELL", color=color.new(sellColor, 0), textcolor=textColor, size=size.small)

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// ORIGINAL RSI DIVERGENCE (SAME STRUCTURE, COLORS NOW IN SETTINGS)
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
plFound = na(ta.pivotlow(osc, lbL, lbR)) ? false : true
phFound = na(ta.pivothigh(osc, lbL, lbR)) ? false : true

_inRange(cond) =>
    bars = ta.barssince(cond)
    rangeLower <= bars and bars <= rangeUpper

// Regular Bullish
inRangePl = _inRange(plFound[1])
oscHL = osc[lbR] > ta.valuewhen(plFound, osc[lbR], 1) and inRangePl
priceLL = low[lbR] < ta.valuewhen(plFound, low[lbR], 1)
bullCondAlert = priceLL and oscHL and plFound
bullCond = plotBull and bullCondAlert

plot(plFound ? osc[lbR] : na, offset=-lbR, title="Regular Bullish", linewidth=2, color=(bullCond ? bullDivColor : noneColor), display=display.pane, editable=plotBull)
plotshape(bullCond ? osc[lbR] : na, offset=-lbR, title="Regular Bullish Label", text=" Bull ", style=shape.labelup, location=location.absolute, color=bullDivColor, textcolor=textColor, editable=plotBull)

// Hidden Bullish
oscLL = osc[lbR] < ta.valuewhen(plFound, osc[lbR], 1) and inRangePl
priceHL = low[lbR] > ta.valuewhen(plFound, low[lbR], 1)
hiddenBullCondAlert = priceHL and oscLL and plFound
hiddenBullCond = plotHiddenBull and hiddenBullCondAlert

plot(plFound ? osc[lbR] : na, offset=-lbR, title="Hidden Bullish", linewidth=2, color=(hiddenBullCond ? hiddenBullDivColor : noneColor), display=display.pane, editable=plotHiddenBull)
plotshape(hiddenBullCond ? osc[lbR] : na, offset=-lbR, title="Hidden Bullish Label", text=" H Bull ", style=shape.labelup, location=location.absolute, color=bullDivColor, textcolor=textColor, editable=plotHiddenBull)

// Regular Bearish
inRangePh = _inRange(phFound[1])
oscLH = osc[lbR] < ta.valuewhen(phFound, osc[lbR], 1) and inRangePh
priceHH = high[lbR] > ta.valuewhen(phFound, high[lbR], 1)
bearCondAlert = priceHH and oscLH and phFound
bearCond = plotBear and bearCondAlert

plot(phFound ? osc[lbR] : na, offset=-lbR, title="Regular Bearish", linewidth=2, color=(bearCond ? bearDivColor : noneColor), display=display.pane, editable=plotBear)
plotshape(bearCond ? osc[lbR] : na, offset=-lbR, title="Regular Bearish Label", text=" Bear ", style=shape.labeldown, location=location.absolute, color=bearDivColor, textcolor=textColor, editable=plotBear)

// Hidden Bearish
oscHH = osc[lbR] > ta.valuewhen(phFound, osc[lbR], 1) and inRangePh
priceLH = high[lbR] < ta.valuewhen(phFound, high[lbR], 1)
hiddenBearCondAlert = priceLH and oscHH and phFound
hiddenBearCond = plotHiddenBear and hiddenBearCondAlert

plot(phFound ? osc[lbR] : na, offset=-lbR, title="Hidden Bearish", linewidth=2, color=(hiddenBearCond ? hiddenBearDivColor : noneColor), display=display.pane, editable=plotHiddenBear)
plotshape(hiddenBearCond ? osc[lbR] : na, offset=-lbR, title="Hidden Bearish Label", text=" H Bear ", style=shape.labeldown, location=location.absolute, color=bearDivColor, textcolor=textColor, editable=plotHiddenBear)

//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// CM_WILLIAMS_VIX_FIX (ORIGINAL) – ANCHORED HISTBASE (ORIGINAL LOOK)
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
wvf = ((ta.highest(close, pd) - low) / ta.highest(close, pd)) * 100.0

sDevW      = mult * ta.stdev(wvf, bbl)
midLineW   = ta.sma(wvf, bbl)
lowerBandW = midLineW - sDevW
upperBandW = midLineW + sDevW

rangeHighW = ta.highest(wvf, lb) * ph
rangeLowW  = ta.lowest(wvf, lb) * pl

colW = (wvf >= upperBandW or wvf >= rangeHighW) ? wvfSpikeColor : wvfNormalColor

// shift
wvfShift       = wvfBase + wvf
rangeHighShift = wvfBase + rangeHighW
rangeLowShift  = wvfBase + rangeLowW
upperBandShift = wvfBase + upperBandW
lowerBandShift = wvfBase + lowerBandW

plot(showWVF and hp ? rangeHighShift : na, title="WVF Range High", color=wvfRangeColor, linewidth=1)
plot(showWVF and hp ? rangeLowShift  : na, title="WVF Range Low",  color=wvfRangeColor, linewidth=1)

// KEY: histbase=wvfBase keeps original proportions while shifted
plot(showWVF ? wvfShift : na,
     title="Williams Vix Fix (Shifted)",
     style=plot.style_histogram,
     color=colW,
     linewidth=2,
     histbase=wvfBase)

plot(showWVF and sd ? upperBandShift : na, title="WVF Upper Band", color=wvfBandColor, linewidth=1)
plot(showWVF and sd ? lowerBandShift : na, title="WVF Lower Band", color=wvfBandColor, linewidth=1)
