//@version=6
// This Pine Scriptâ„¢ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© SeerQuant

import TradingView/ta/9 as ta

indicator(
     title      = "Weighted CCI Oscillator [SeerQuant]",
     shorttitle = "ð–ð‚ð‚ðˆ [SeerQuant]",
     overlay    = false
)

// ----------------- ï¼³ï¼´ï¼¡ï¼´ï¼©ï¼£ ï¼¶ï¼¡ï¼²ï¼©ï¼¡ï¼¢ï¼¬ï¼¥ï¼³ ----------------- //

// â€‹ðŸ‡¸â€‹â€‹ðŸ‡¹â€‹â€‹ðŸ‡·â€‹â€‹ðŸ‡®â€‹â€‹ðŸ‡³â€‹â€‹ðŸ‡¬â€‹â€‹ðŸ‡¸â€‹
const string g1 = "Calculation Settings"
const string g2 = "Style Settings"

//â€‹ðŸ‡«â€‹â€‹ðŸ‡±â€‹â€‹ðŸ‡´â€‹â€‹ðŸ‡¦â€‹â€‹ðŸ‡¹â€‹â€‹ðŸ‡¸â€‹
float upper_limit = 200.0
float lower_limit = -200.0
float mid_line    = 0.0

// ----------------- ï¼©ï¼®ï¼°ï¼µï¼´ ï¼¶ï¼¡ï¼²ï¼©ï¼¡ï¼¢ï¼¬ï¼¥ï¼³ ----------------- //

// â€‹ðŸ‡¸â€‹â€‹ðŸ‡¹â€‹â€‹ðŸ‡·â€‹â€‹ðŸ‡®â€‹â€‹ðŸ‡³â€‹â€‹ðŸ‡¬â€‹â€‹ðŸ‡¸â€‹
string colScheme = input.string(
     defval  = "Default",
     title   = "Colour Choice",
     options = ["Default", "Modern", "Cool", "Monochrome"],
     group   = g2
)

string maType = input.string(
     defval  = "EMA",
     title   = "Moving Average Type",
     options = ["SMA", "EMA", "SMMA", "WMA", "VWMA", "LSMA", "HMA", "ALMA", "RMA", "DEMA", "TEMA"],
     group   = g1
)

string weightType = input.string(
     defval  = "Volatility",
     title   = "CCI Weighting Method",
     options = ["Volume", "Momentum", "Volatility", "Reversion Factor"],
     group   = g1
)

string srcMode = input.string(
     defval  = "Typical Price (HLC3)",
     title   = "CCI Source Mode",
     options = ["Typical Price (HLC3)", "Input Source"],
     group   = g1
)

string colcMode = input.string(
     defval  = "WCCI",
     title   = "Candle Color Mode",
     options = ["WCCI", "Smoothed WCCI"],
     group   = g2
)

//â€‹ðŸ‡«â€‹â€‹ðŸ‡±â€‹â€‹ðŸ‡´â€‹â€‹ðŸ‡¦â€‹â€‹ðŸ‡¹â€‹â€‹ðŸ‡¸â€‹
float source = input.source(defval = close, title = "Input Source", group = g1)
float cci_k  = input.float(defval = 0.015, title = "CCI Constant (k)", step = 0.001, group = g1)

//â€‹ðŸ‡®â€‹â€‹ðŸ‡³â€‹â€‹ðŸ‡¹â€‹â€‹ðŸ‡¸â€‹
int length      = input.int(defval = 30, title = "Calculation Length", group = g1)
int smoothLen   = input.int(defval = 8,  title = "Smoothing Length",   group = g1)
int neutralZone = input.int(defval = 30, title = "Neutral Zone Range", group = g1)

//â€‹ðŸ‡§â€‹â€‹ðŸ‡´â€‹â€‹ðŸ‡´â€‹â€‹ðŸ‡±â€‹â€‹ðŸ‡¸â€‹
bool colc = input.bool(defval = false, title = "Color Candles?",     group = g2)
bool cust = input.bool(defval = false, title = "Use Custom Colors?", group = g2)

//â€‹ðŸ‡¨â€‹â€‹ðŸ‡´â€‹â€‹ðŸ‡±â€‹â€‹ðŸ‡´â€‹â€‹ðŸ‡·â€‹â€‹ðŸ‡¸â€‹
color bullc    = input.color(defval = #00ff00, title = "Bull Colour",    group = g2)
color bearc    = input.color(defval = #ff0000, title = "Bear Colour",    group = g2)
color neutralc = input.color(defval = #6c6c6c, title = "Neutral Colour", group = g2)

[bulld, beard] = switch colScheme
    "Default"    => [#00ff00, #ff0000]
    "Modern"     => [#23d7e4, #e11179]
    "Cool"       => [#00ffcc, #4e4f75]
    "Monochrome" => [#ffffff, #4e4e4e]

[bull, bear] = switch cust
    false => [bulld, beard]
    true  => [bullc, bearc]

// ----------------- ï¼¦ï¼µï¼®ï¼£ï¼´ï¼©ï¼¯ï¼®ï¼³ ----------------- //

f_clamp(x, lo, hi) =>
    math.min(math.max(x, lo), hi)

ma(src, len, type) =>
    int _len = math.max(len, 1)
    switch type
        "SMA"  => ta.sma(src, _len)
        "EMA"  => ta.ema(src, _len)
        "SMMA" => ta.rma(src, _len)
        "WMA"  => ta.wma(src, _len)
        "VWMA" => ta.vwma(src, _len)
        "LSMA" => ta.linreg(src, _len, 0)
        "ALMA" => ta.alma(src, _len, 0.85, 6)
        "RMA"  => ta.rma(src, _len)
        "HMA"  =>
            int half = math.max(1, int(math.round(_len / 2.0)))
            int root = math.max(1, int(math.floor(math.sqrt(_len))))
            ta.wma(2.0 * ta.wma(src, half) - ta.wma(src, _len), root)
        "DEMA" =>
            float ema1 = ta.ema(src, _len)
            float ema2 = ta.ema(ema1, _len)
            2.0 * ema1 - ema2
        "TEMA" =>
            float ema1 = ta.ema(src, _len)
            float ema2 = ta.ema(ema1, _len)
            float ema3 = ta.ema(ema2, _len)
            3.0 * (ema1 - ema2) + ema3

// ----------------- ï¼£ï¼¡ï¼¬ï¼£ï¼µï¼¬ï¼¡ï¼´ï¼©ï¼¯ï¼®ï¼³ ----------------- //

// Base source for CCI
tp = srcMode == "Typical Price (HLC3)" ? hlc3 : source

// Weight
wRaw = switch weightType
    "Volume"           => nz(volume, 1.0)
    "Momentum"         => math.abs(ta.mom(tp, length))
    "Volatility"       => ta.stdev(tp, length)
    "Reversion Factor" => 1.0 / (1.0 + ta.variance(tp, length))

wRaw := nz(wRaw, 1.0)

// Normalize weight to keep it stable
wBase = ta.rma(wRaw, length)
wNorm = wBase != 0 ? (wRaw / wBase) : 1.0
wNorm := f_clamp(wNorm, 0.25, 4.0)

// Weighted CCI
basis   = ma(tp, length, maType)
absDevW = ma(math.abs(tp - basis) * wNorm, length, maType)
devW    = (tp - basis) * wNorm
den     = cci_k * absDevW
wcci    = den != 0 ? (devW / den) : 0.0
wcci    := nz(wcci, 0.0)

// Smoothed WCCI
wcci_s = ma(wcci, smoothLen, maType)
wcci_s := nz(wcci_s, 0.0)

// Neutral zone boundaries
neutral_low  = mid_line - neutralZone
neutral_high = mid_line + neutralZone

// ----------------- ï¼°ï¼¬ï¼¯ï¼´ï¼´ï¼©ï¼®ï¼§ ----------------- //

// Thresholds + mid
f1  = plot(upper_limit, color = color.new(bear, 50))
f2  = plot(lower_limit, color = color.new(bull, 50))
mid = plot(mid_line,    color = color.new(chart.fg_color, 55))

// OB / OS gradient fill bands
fill(
     mid, f1,
     top_value    = upper_limit,
     bottom_value = upper_limit - 50.0,
     bottom_color = na,
     top_color    = color.from_gradient(wcci, 100.0, upper_limit, color.new(bear, 100), color.new(bear, 35))
)
fill(
     mid, f2,
     top_value    = lower_limit + 50.0,
     bottom_value = lower_limit,
     bottom_color = color.from_gradient(wcci, lower_limit, -100.0, color.new(bull, 35), color.new(bull, 100)),
     top_color    = na
)

// Main oscillator line
p = plot(
     wcci,
     color     = color.new(wcci > neutral_high ? bull : wcci < neutral_low ? bear : neutralc, 0),
     linewidth = 1
)

// Smoothed line
plot(wcci_s, color = color.gray, linewidth = 1)

// Fill vs midline
fill(p, mid, color = wcci > neutral_high ? color.new(bull, 90) : (wcci < neutral_low ? color.new(bear, 90) : color.new(neutralc, 90)))
fill(
     p, mid,
     top_value    = wcci,
     bottom_value = mid_line,
     top_color    = color.new(chart.bg_color, 100),
     bottom_color = wcci > neutral_high ? bull : (wcci < neutral_low ? bear : neutralc)
)

// Candle coloring
selected = colcMode == "WCCI" ? wcci : wcci_s
col      = selected > neutral_high ? bull : selected < neutral_low ? bear : neutralc

plotcandle(
     open, high, low, close,
     color         = colc ? col : na,
     wickcolor     = colc ? col : na,
     bordercolor   = colc ? col : na,
     force_overlay = true
)

// OB / OS X's
cond1 = selected > upper_limit
cond2 = selected < lower_limit

plotshape(cond1 ? upper_limit : na, color = bear, force_overlay = false, location = location.absolute, style = shape.xcross)
plotshape(cond2 ? lower_limit : na, color = bull, force_overlay = false, location = location.absolute, style = shape.xcross)

// Alerts
alertcondition(selected > neutral_high, title = "WCCI Positive Trend",        message = "WCCI Bullish Signal on: {{exchange}}:{{ticker}}")
alertcondition(selected < neutral_low,  title = "WCCI Negative Trend",        message = "WCCI Bearish Signal on: {{exchange}}:{{ticker}}")
alertcondition(selected < -200,         title = "WCCI Oversold Condition",    message = "WCCI Oversold Signal on: {{exchange}}:{{ticker}}")
alertcondition(selected > 200,          title = "WCCI Overbought Condition",  message = "WCCI Overbought Signal on: {{exchange}}:{{ticker}}")

// ---------------------------------------------------------------------------------------------------------------- //
// -------------------------------------------- ï¼£ï¼²ï¼¥ï¼¡ï¼´ï¼¥ï¼¤ ï¼¢ï¼¹ ------------------------------------------------- //
// ---------------------------------------------------------------------------------------------------------------- //
//                                                                                                                  //
//   â–„â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–„â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–„â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–„â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–„   â–ˆâ–ˆâ–ˆ    â–ˆâ–„     â–„â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–„â–„â–„â–„       â–ˆâ–ˆâ–ˆ         //
//   â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–€â–€â–€â–ˆâ–ˆâ–„ â–€â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–„    //
//    â–ˆâ–ˆâ–ˆ    â–ˆâ–€    â–ˆâ–ˆâ–ˆ    â–ˆâ–€    â–ˆâ–ˆâ–ˆ    â–ˆâ–€    â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ    â–€â–ˆâ–ˆâ–ˆâ–€â–€â–ˆâ–ˆ   //
//    â–ˆâ–ˆâ–ˆ         â–„â–ˆâ–ˆâ–ˆâ–„â–„â–„      â–„â–ˆâ–ˆâ–ˆâ–„â–„â–„      â–„â–ˆâ–ˆâ–ˆâ–„â–„â–„â–„â–ˆâ–ˆâ–€ â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆ   â–€   //
//  â–€â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–€â–€â–ˆâ–ˆâ–ˆâ–€â–€â–€     â–€â–€â–ˆâ–ˆâ–ˆâ–€â–€â–€     â–€â–€â–ˆâ–ˆâ–ˆâ–€â–€â–€â–€â–€   â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ â–€â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆ       //
//           â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ    â–ˆâ–„    â–ˆâ–ˆâ–ˆ    â–ˆâ–„  â–€â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆ       //
//     â–„â–ˆ    â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ  â–€ â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆ       //
//   â–„â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–€    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ  â–€â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–€â–„â–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–€    â–ˆâ–ˆâ–ˆ    â–ˆâ–€   â–€â–ˆ   â–ˆâ–€     â–„â–ˆâ–ˆâ–ˆâ–ˆâ–€     //
//                                                                                                                  //
// ---------------------------------------------------------------------------------------------------------------- //
