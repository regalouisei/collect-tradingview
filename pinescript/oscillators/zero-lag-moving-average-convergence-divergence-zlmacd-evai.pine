// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © evaiinvesting
//@version=6
indicator("Zero Lag Moving Average Convergence Divergence", "ZLMACD", timeframe="", timeframe_gaps=true)

// -------------------- Inputs
sourceInput  = input.source(close, "Source")
fastLenInput = input.int(12, "Fast length",   minval=1)
slowLenInput = input.int(26, "Slow length",   minval=1)
sigLenInput  = input.int(9,  "Signal length", minval=1)

// Default = preset you liked
modeInput = input.string(
     "ZLEMA osc + EMA signal",
     "Mode",
     options=["ZLEMA osc + EMA signal", "Custom"]
)

// Custom settings (ONLY used when Mode = Custom)
groupCustom = "Custom types (used only when Mode = Custom)"
oscTypeInput = input.string("EMA", "Oscillator MA type", ["EMA", "SMA", "ZLEMA"], group=groupCustom)
sigTypeInput = input.string("EMA", "Signal MA type",     ["EMA", "SMA", "ZLEMA"], group=groupCustom)

// -------------------- MA helpers
zlema(series float src, int length) =>
    ema1 = ta.ema(src, length)
    ema2 = ta.ema(ema1, length)
    ema1 + (ema1 - ema2)

ma(series float src, int length, simple string maType) =>
    switch maType
        "EMA"   => ta.ema(src, length)
        "SMA"   => ta.sma(src, length)
        "ZLEMA" => zlema(src, length)

// -------------------- Resolve effective types based on Mode
effOscType = modeInput == "ZLEMA osc + EMA signal" ? "ZLEMA" : oscTypeInput
effSigType = modeInput == "ZLEMA osc + EMA signal" ? "EMA"   : sigTypeInput

// Optional: show what is actually active (Data Window)
plotchar(na, title="Active Osc MA Type", char="", editable=false, display=display.data_window)
plotchar(na, title="Active Sig MA Type", char="", editable=false, display=display.data_window)

// -------------------- MACD
maFast = ma(sourceInput, fastLenInput, effOscType)
maSlow = ma(sourceInput, slowLenInput, effOscType)

macd   = maFast - maSlow
signal = ma(macd, sigLenInput, effSigType)
hist   = macd - signal

// Histogram color (same as your original logic)
hColor = hist >= 0 ? (hist > hist[1] ? #26a69a : #b2dfdb) : (hist > hist[1] ? #ffcdd2 : #ff5252)

// -------------------- Plots
hline(0, "Zero", #787b8680)
plot(hist, "Histogram", hColor, style=plot.style_columns)
plot(macd, "MACD")
plot(signal, "Signal line", #ff6d00)

// -------------------- Alerts
alertcondition(hist[1] >= 0 and hist < 0, "Rising to falling", "MACD histogram switched from rising to falling")
alertcondition(hist[1] <= 0 and hist > 0, "Falling to rising", "MACD histogram switched from falling to rising")
