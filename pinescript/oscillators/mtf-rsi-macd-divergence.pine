// This Pine ScriptÂ® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© iCC_Six

//@version=6
indicator("MTF - RSI - MACD - Divergence", shorttitle="MTF Dashboard", overlay=true, max_lines_count=500, max_labels_count=500)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUTS â€” RSI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
rsi_len  = input.int(14,    "RSI Length",      minval=1,             group="â— RSI Settings")
rsi_ob   = input.float(70,  "Overbought",      minval=51, maxval=99, group="â— RSI Settings")
rsi_os   = input.float(30,  "Oversold",        minval=1,  maxval=49, group="â— RSI Settings")
rsi_src  = input.source(close, "RSI Source",                         group="â— RSI Settings")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUTS â€” MACD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
macd_fast = input.int(12,   "Fast EMA",        minval=1,             group="â— MACD Settings")
macd_slow = input.int(26,   "Slow EMA",        minval=1,             group="â— MACD Settings")
macd_sig  = input.int(9,    "Signal EMA",      minval=1,             group="â— MACD Settings")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUTS â€” DIVERGENCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
div_lb     = input.int(5,    "Pivot Lookback Bars",   minval=2, maxval=20, group="â— Divergence Settings", tooltip="Bars left AND right to confirm a pivot.\nHigher = fewer but stronger pivots.")
show_div   = input.bool(true, "Show Labels on Chart",                      group="â— Divergence Settings")
show_hid   = input.bool(true, "Show Hidden Divergences",                   group="â— Divergence Settings")
show_lines = input.bool(true, "Show Divergence Lines",                     group="â— Divergence Settings", tooltip="Draws a line between the two price pivots that form the divergence.\nSolid = Regular  |  Dashed = Hidden")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUTS â€” RSI OVERLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
show_rsi_ov     = input.bool(false,  "Show RSI Overlay",           group="ðŸ“Š RSI Overlay")
rsi_ov_height   = input.float(1,  "Height (fraction of range)", minval=0.05, maxval=3, step=0.05, group="ðŸ“Š RSI Overlay", tooltip="How tall the RSI overlay is as a fraction of the visible price range. 0.25 = 25%.")
rsi_ov_offset   = input.float(1,   "Vertical Offset (fraction)", minval=0.0,  maxval=3, step=0.05, group="ðŸ“Š RSI Overlay", tooltip="Shift the overlay up from the bottom of the range.")
rsi_ov_scale    = input.int(100,     "Scale Lookback (bars)",      minval=20, maxval=500,              group="ðŸ“Š RSI Overlay", tooltip="Bars used to measure the visible price range for scaling.")
col_rsi_ov_line = input.color(color.new(#ce93d8, 0),     "RSI Line",      group="ðŸ“Š RSI Overlay")
col_rsi_ov_ob   = input.color(color.new(#d50000, 55),    "OB Level",      group="ðŸ“Š RSI Overlay")
col_rsi_ov_os   = input.color(color.new(#00c853, 55),    "OS Level",      group="ðŸ“Š RSI Overlay")
col_rsi_ov_mid  = input.color(color.new(color.gray, 65), "Mid (50) Line", group="ðŸ“Š RSI Overlay")
col_rsi_ov_fill = input.color(color.new(#ce93d8, 88),    "Fill",          group="ðŸ“Š RSI Overlay")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUTS â€” MACD OVERLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
show_macd_ov     = input.bool(false,  "Show MACD Overlay",          group="ðŸ“Š MACD Overlay")
macd_ov_height   = input.float(1,  "Height (fraction of range)", minval=-3, maxval=3, step=0.05, group="ðŸ“Š MACD Overlay")
macd_ov_offset   = input.float(-1,   "Vertical Offset (fraction)", minval=-3,  maxval=3, step=0.05, group="ðŸ“Š MACD Overlay")
macd_ov_scale    = input.int(100,     "Scale Lookback (bars)",      minval=20, maxval=500,              group="ðŸ“Š MACD Overlay")
col_macd_ov_ml   = input.color(color.new(#2962ff, 0),     "MACD Line",   group="ðŸ“Š MACD Overlay")
col_macd_ov_sl   = input.color(color.new(#ff6d00, 0),     "Signal Line", group="ðŸ“Š MACD Overlay")
col_macd_ov_zero = input.color(color.new(color.gray, 65), "Zero Line",   group="ðŸ“Š MACD Overlay")
col_macd_ov_bull = input.color(color.new(#00c853, 75),    "Bull Fill",   group="ðŸ“Š MACD Overlay")
col_macd_ov_bear = input.color(color.new(#d50000, 75),    "Bear Fill",   group="ðŸ“Š MACD Overlay")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUTS â€” TIMEFRAMES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
tf1 = input.timeframe("5",   "TF 1", group="â— Timeframes")
tf2 = input.timeframe("15",  "TF 2", group="â— Timeframes")
tf3 = input.timeframe("60",  "TF 3", group="â— Timeframes")
tf4 = input.timeframe("240", "TF 4", group="â— Timeframes")
tf5 = input.timeframe("D",   "TF 5", group="â— Timeframes")
tf6 = input.timeframe("W",   "TF 6", group="â— Timeframes")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUTS â€” TABLE SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
tbl_pos_inp  = input.string("Top Right", "Table Position", options=["Top Right", "Top Left", "Bottom Right", "Bottom Left"], group="â— Table Settings")
tbl_size_inp = input.string("Small",     "Text Size",      options=["Tiny", "Small", "Normal", "Large"],                     group="â— Table Settings")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUTS â€” TABLE COLOURS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
col_hdr_bg   = input.color(color.new(#0a0f2e, 0),     "Header Background",        group="ðŸŽ¨ Table Colours")
col_hdr2_bg  = input.color(color.new(#12206b, 0),     "Column Header Background", group="ðŸŽ¨ Table Colours")
col_row_odd  = input.color(color.new(#0d1117, 0),     "Row Background (Odd)",     group="ðŸŽ¨ Table Colours")
col_row_evn  = input.color(color.new(#161b22, 0),     "Row Background (Even)",    group="ðŸŽ¨ Table Colours")
col_tbl_txt  = input.color(color.white,                "Table Text",               group="ðŸŽ¨ Table Colours")
col_border   = input.color(color.new(color.white, 85), "Border Colour",            group="ðŸŽ¨ Table Colours")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUTS â€” RSI BADGE COLOURS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
col_rsi_ob      = input.color(#d50000, "Overbought Badge",   group="ðŸŽ¨ RSI Badge Colours")
col_rsi_os      = input.color(#00c853, "Oversold Badge",     group="ðŸŽ¨ RSI Badge Colours")
col_rsi_near_ob = input.color(#ff8f00, "Near OB Badge",      group="ðŸŽ¨ RSI Badge Colours")
col_rsi_near_os = input.color(#00897b, "Near OS Badge",      group="ðŸŽ¨ RSI Badge Colours")
col_rsi_bull    = input.color(#00897b, "Bullish Bias Badge", group="ðŸŽ¨ RSI Badge Colours")
col_rsi_bear    = input.color(#c62828, "Bearish Bias Badge", group="ðŸŽ¨ RSI Badge Colours")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUTS â€” MACD BADGE COLOURS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
col_macd_sbull = input.color(#00c853, "Strong Bull Badge", group="ðŸŽ¨ MACD Badge Colours")
col_macd_bull  = input.color(#00897b, "Bullish Badge",     group="ðŸŽ¨ MACD Badge Colours")
col_macd_sbear = input.color(#d50000, "Strong Bear Badge", group="ðŸŽ¨ MACD Badge Colours")
col_macd_bear  = input.color(#c62828, "Bearish Badge",     group="ðŸŽ¨ MACD Badge Colours")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUTS â€” DIVERGENCE LABEL COLOURS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
col_reg_bull = input.color(color.new(#00c853, 10), "Regular Bull Label",    group="ðŸŽ¨ Divergence Label Colours")
col_reg_bear = input.color(color.new(#d50000, 10), "Regular Bear Label",    group="ðŸŽ¨ Divergence Label Colours")
col_hid_bull = input.color(color.new(#00897b, 20), "Hidden Bull Label",     group="ðŸŽ¨ Divergence Label Colours")
col_hid_bear = input.color(color.new(#c62828, 20), "Hidden Bear Label",     group="ðŸŽ¨ Divergence Label Colours")
col_div_txt  = input.color(color.white,             "Divergence Label Text", group="ðŸŽ¨ Divergence Label Colours")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUTS â€” DIVERGENCE BADGE COLOURS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
col_div_reg_bull = input.color(#00c853, "Table: Reg Bull Badge", group="ðŸŽ¨ Divergence Badge Colours")
col_div_reg_bear = input.color(#d50000, "Table: Reg Bear Badge", group="ðŸŽ¨ Divergence Badge Colours")
col_div_hid_bull = input.color(#00897b, "Table: Hid Bull Badge", group="ðŸŽ¨ Divergence Badge Colours")
col_div_hid_bear = input.color(#c62828, "Table: Hid Bear Badge", group="ðŸŽ¨ Divergence Badge Colours")
col_div_none     = input.color(#37474f, "Table: No Signal",       group="ðŸŽ¨ Divergence Badge Colours")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
f_pos() =>
    switch tbl_pos_inp
        "Top Right"    => position.top_right
        "Top Left"     => position.top_left
        "Bottom Right" => position.bottom_right
        =>               position.bottom_left

f_sz() =>
    switch tbl_size_inp
        "Tiny"   => size.tiny
        "Normal" => size.normal
        "Large"  => size.large
        =>          size.small

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CORE CALCULATION FUNCTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
calc() =>
    rsi = ta.rsi(rsi_src, rsi_len)
    [macd_l, sig_l, hist_l] = ta.macd(close, macd_fast, macd_slow, macd_sig)

    var float prev_hist = na
    hist_rising = na(prev_hist) ? false : hist_l > prev_hist
    prev_hist  := hist_l

    ph = ta.pivothigh(high, div_lb, div_lb)
    pl = ta.pivotlow(low,   div_lb, div_lb)

    var float ph1 = na, var float ph2 = na
    var float pl1 = na, var float pl2 = na
    var float phr1 = na, var float phr2 = na
    var float plr1 = na, var float plr2 = na
    var float phm1 = na, var float phm2 = na
    var float plm1 = na, var float plm2 = na

    if not na(ph)
        ph2  := ph1
        phr2 := phr1
        phm2 := phm1
        ph1  := ph
        phr1 := rsi[div_lb]
        phm1 := hist_l[div_lb]

    if not na(pl)
        pl2  := pl1
        plr2 := plr1
        plm2 := plm1
        pl1  := pl
        plr1 := rsi[div_lb]
        plm1 := hist_l[div_lb]

    has_high_pair = not na(ph1) and not na(ph2)
    has_low_pair  = not na(pl1) and not na(pl2)

    rsi_rb  = not na(pl) and has_low_pair  and pl1 < pl2 and plr1 > plr2
    rsi_rbe = not na(ph) and has_high_pair and ph1 > ph2 and phr1 < phr2
    rsi_hb  = not na(pl) and has_low_pair  and pl1 > pl2 and plr1 < plr2
    rsi_hbe = not na(ph) and has_high_pair and ph1 < ph2 and phr1 > phr2

    mac_rb  = not na(pl) and has_low_pair  and pl1 < pl2 and plm1 > plm2
    mac_rbe = not na(ph) and has_high_pair and ph1 > ph2 and phm1 < phm2
    mac_hb  = not na(pl) and has_low_pair  and pl1 > pl2 and plm1 < plm2
    mac_hbe = not na(ph) and has_high_pair and ph1 < ph2 and phm1 > phm2

    var int rsi_div_state = 0
    if rsi_rb
        rsi_div_state := 1
    else if rsi_rbe
        rsi_div_state := 2
    else if rsi_hb
        rsi_div_state := 3
    else if rsi_hbe
        rsi_div_state := 4

    var int mac_div_state = 0
    if mac_rb
        mac_div_state := 1
    else if mac_rbe
        mac_div_state := 2
    else if mac_hb
        mac_div_state := 3
    else if mac_hbe
        mac_div_state := 4

    [rsi, macd_l, sig_l, hist_l, hist_rising,
     rsi_div_state, mac_div_state,
     rsi_rb, rsi_rbe, rsi_hb, rsi_hbe,
     mac_rb, mac_rbe, mac_hb, mac_hbe]

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CURRENT TF
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[rsi0, ml0, sl0, hist0, hup0, rdiv0, mdiv0,
 rb0, rbe0, hb0, hbe0,
 mrb0, mrbe0, mhb0, mhbe0] = calc()

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MULTI-TIMEFRAME REQUESTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[rsi1, ml1, sl1, hist1, hup1, rdiv1, mdiv1, _r1a, _r1b, _r1c, _r1d, _m1a, _m1b, _m1c, _m1d] = request.security(syminfo.tickerid, tf1, calc(), lookahead=barmerge.lookahead_off)
[rsi2, ml2, sl2, hist2, hup2, rdiv2, mdiv2, _r2a, _r2b, _r2c, _r2d, _m2a, _m2b, _m2c, _m2d] = request.security(syminfo.tickerid, tf2, calc(), lookahead=barmerge.lookahead_off)
[rsi3, ml3, sl3, hist3, hup3, rdiv3, mdiv3, _r3a, _r3b, _r3c, _r3d, _m3a, _m3b, _m3c, _m3d] = request.security(syminfo.tickerid, tf3, calc(), lookahead=barmerge.lookahead_off)
[rsi4, ml4, sl4, hist4, hup4, rdiv4, mdiv4, _r4a, _r4b, _r4c, _r4d, _m4a, _m4b, _m4c, _m4d] = request.security(syminfo.tickerid, tf4, calc(), lookahead=barmerge.lookahead_off)
[rsi5, ml5, sl5, hist5, hup5, rdiv5, mdiv5, _r5a, _r5b, _r5c, _r5d, _m5a, _m5b, _m5c, _m5d] = request.security(syminfo.tickerid, tf5, calc(), lookahead=barmerge.lookahead_off)
[rsi6, ml6, sl6, hist6, hup6, rdiv6, mdiv6, _r6a, _r6b, _r6c, _r6d, _m6a, _m6b, _m6c, _m6d] = request.security(syminfo.tickerid, tf6, calc(), lookahead=barmerge.lookahead_off)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PIVOT TRACKING FOR LINE DRAWING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
cur_ph = ta.pivothigh(high, div_lb, div_lb)
cur_pl = ta.pivotlow(low,   div_lb, div_lb)

var int   cur_ph1_bi = na, var int   cur_ph2_bi = na
var float cur_ph1    = na, var float cur_ph2    = na
var int   cur_pl1_bi = na, var int   cur_pl2_bi = na
var float cur_pl1    = na, var float cur_pl2    = na

if not na(cur_ph)
    cur_ph2_bi := cur_ph1_bi
    cur_ph2    := cur_ph1
    cur_ph1_bi := bar_index - div_lb
    cur_ph1    := cur_ph

if not na(cur_pl)
    cur_pl2_bi := cur_pl1_bi
    cur_pl2    := cur_pl1
    cur_pl1_bi := bar_index - div_lb
    cur_pl1    := cur_pl

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DIVERGENCE LABELS + LINES ON CHART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if show_div
    if rb0
        label.new(bar_index - div_lb, low[div_lb],  "RSI\nReg Bull â†‘", style=label.style_label_up,   color=col_reg_bull, textcolor=col_div_txt, size=size.small, yloc=yloc.price)
    if rbe0
        label.new(bar_index - div_lb, high[div_lb], "RSI\nReg Bear â†“", style=label.style_label_down, color=col_reg_bear, textcolor=col_div_txt, size=size.small, yloc=yloc.price)
    if show_hid and hb0
        label.new(bar_index - div_lb, low[div_lb],  "RSI\nHid Bull â†‘", style=label.style_label_up,   color=col_hid_bull, textcolor=col_div_txt, size=size.small, yloc=yloc.price)
    if show_hid and hbe0
        label.new(bar_index - div_lb, high[div_lb], "RSI\nHid Bear â†“", style=label.style_label_down, color=col_hid_bear, textcolor=col_div_txt, size=size.small, yloc=yloc.price)

    if mrb0
        label.new(bar_index - div_lb, low[div_lb],  "MACD\nReg Bull â†‘", style=label.style_label_up,   color=col_reg_bull, textcolor=col_div_txt, size=size.small, yloc=yloc.price)
    if mrbe0
        label.new(bar_index - div_lb, high[div_lb], "MACD\nReg Bear â†“", style=label.style_label_down, color=col_reg_bear, textcolor=col_div_txt, size=size.small, yloc=yloc.price)
    if show_hid and mhb0
        label.new(bar_index - div_lb, low[div_lb],  "MACD\nHid Bull â†‘", style=label.style_label_up,   color=col_hid_bull, textcolor=col_div_txt, size=size.small, yloc=yloc.price)
    if show_hid and mhbe0
        label.new(bar_index - div_lb, high[div_lb], "MACD\nHid Bear â†“", style=label.style_label_down, color=col_hid_bear, textcolor=col_div_txt, size=size.small, yloc=yloc.price)

if show_lines
    bool low_pair_ok  = not na(cur_pl1_bi) and not na(cur_pl2_bi) and not na(cur_pl1) and not na(cur_pl2)
    bool high_pair_ok = not na(cur_ph1_bi) and not na(cur_ph2_bi) and not na(cur_ph1) and not na(cur_ph2)

    if (rb0 or mrb0) and low_pair_ok
        line.new(cur_pl2_bi, cur_pl2, cur_pl1_bi, cur_pl1, color=col_reg_bull, width=1, style=line.style_solid)
    if (rbe0 or mrbe0) and high_pair_ok
        line.new(cur_ph2_bi, cur_ph2, cur_ph1_bi, cur_ph1, color=col_reg_bear, width=1, style=line.style_solid)
    if show_hid and (hb0 or mhb0) and low_pair_ok
        line.new(cur_pl2_bi, cur_pl2, cur_pl1_bi, cur_pl1, color=col_hid_bull, width=1, style=line.style_dashed)
    if show_hid and (hbe0 or mhbe0) and high_pair_ok
        line.new(cur_ph2_bi, cur_ph2, cur_ph1_bi, cur_ph1, color=col_hid_bear, width=1, style=line.style_dashed)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SIGNAL HELPER FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
f_rsi_sig(v) =>
    if v >= rsi_ob
        ["âš¡ OVERBOUGHT", col_rsi_ob]
    else if v <= rsi_os
        ["âš¡ OVERSOLD", col_rsi_os]
    else if v >= rsi_ob - 10
        ["Near OB Zone", col_rsi_near_ob]
    else if v <= rsi_os + 10
        ["Near OS Zone", col_rsi_near_os]
    else if v >= 50
        ["Bullish Bias", col_rsi_bull]
    else
        ["Bearish Bias", col_rsi_bear]

f_macd_sig(ml, sl) =>
    cross_up   = ta.crossover(ml, sl)
    cross_down = ta.crossunder(ml, sl)
    if cross_up and ml < 0
        ["â¬† Bull Crossover", col_macd_bull]
    else if cross_up and ml >= 0
        ["â¬† Bull X (>0)", col_macd_sbull]
    else if cross_down and ml > 0
        ["â¬‡ Bear Crossover", col_macd_bear]
    else if cross_down and ml <= 0
        ["â¬‡ Bear X (<0)", col_macd_sbear]
    else if ml > sl and ml > 0
        ["â–² Strong Bull", col_macd_sbull]
    else if ml > sl and ml <= 0
        ["â–³ Bullish", col_macd_bull]
    else if ml < sl and ml < 0
        ["â–¼ Strong Bear", col_macd_sbear]
    else
        ["â–½ Bearish", col_macd_bear]

f_hist_txt(h, rising) =>
    if h > 0
        if rising
            ["â–²â–² " + str.tostring(math.round(h, 5)), col_macd_sbull]
        else
            ["â–² "  + str.tostring(math.round(h, 5)), col_macd_bull]
    else
        if not rising
            ["â–¼â–¼ " + str.tostring(math.round(h, 5)), col_macd_sbear]
        else
            ["â–¼ "  + str.tostring(math.round(h, 5)), col_macd_bear]

f_div_txt(d) =>
    switch d
        1 => ["â— Reg Bull â†‘", col_div_reg_bull]
        2 => ["â— Reg Bear â†“", col_div_reg_bear]
        3 => ["â—‹ Hid Bull â†‘", col_div_hid_bull]
        4 => ["â—‹ Hid Bear â†“", col_div_hid_bear]
        => ["  â€”", col_div_none]

f_rsi_col(v) =>
    if v >= rsi_ob
        col_rsi_ob
    else if v <= rsi_os
        col_rsi_os
    else if v >= 50
        col_rsi_bull
    else
        col_rsi_bear

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WEIGHTED SCORE HELPER FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
f_rsi_score(v) =>
    na(v) ? -1 : v >= 50 ? 1 : 0

f_macd_score(ml, sl) =>
    na(ml) or na(sl) ? -1 : ml > sl ? 1 : 0

f_hist_score(h) =>
    na(h) ? -1 : h > 0 ? 1 : 0

f_div_score(d) =>
    d == 0 ? -1 : (d == 1 or d == 3) ? 1 : 0

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PRE-COMPUTE SIGNAL STRINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[rsig0_txt, rsig0_col] = f_rsi_sig(na(rsi0) ? 50 : rsi0)
[rsig1_txt, rsig1_col] = f_rsi_sig(na(rsi1) ? 50 : rsi1)
[rsig2_txt, rsig2_col] = f_rsi_sig(na(rsi2) ? 50 : rsi2)
[rsig3_txt, rsig3_col] = f_rsi_sig(na(rsi3) ? 50 : rsi3)
[rsig4_txt, rsig4_col] = f_rsi_sig(na(rsi4) ? 50 : rsi4)
[rsig5_txt, rsig5_col] = f_rsi_sig(na(rsi5) ? 50 : rsi5)
[rsig6_txt, rsig6_col] = f_rsi_sig(na(rsi6) ? 50 : rsi6)

[msig0_txt, msig0_col] = f_macd_sig(na(ml0) ? 0.0 : ml0, na(sl0) ? 0.0 : sl0)
[msig1_txt, msig1_col] = f_macd_sig(na(ml1) ? 0.0 : ml1, na(sl1) ? 0.0 : sl1)
[msig2_txt, msig2_col] = f_macd_sig(na(ml2) ? 0.0 : ml2, na(sl2) ? 0.0 : sl2)
[msig3_txt, msig3_col] = f_macd_sig(na(ml3) ? 0.0 : ml3, na(sl3) ? 0.0 : sl3)
[msig4_txt, msig4_col] = f_macd_sig(na(ml4) ? 0.0 : ml4, na(sl4) ? 0.0 : sl4)
[msig5_txt, msig5_col] = f_macd_sig(na(ml5) ? 0.0 : ml5, na(sl5) ? 0.0 : sl5)
[msig6_txt, msig6_col] = f_macd_sig(na(ml6) ? 0.0 : ml6, na(sl6) ? 0.0 : sl6)

[h0_txt, h0_col] = f_hist_txt(na(hist0) ? 0.0 : hist0, hup0)
[h1_txt, h1_col] = f_hist_txt(na(hist1) ? 0.0 : hist1, hup1)
[h2_txt, h2_col] = f_hist_txt(na(hist2) ? 0.0 : hist2, hup2)
[h3_txt, h3_col] = f_hist_txt(na(hist3) ? 0.0 : hist3, hup3)
[h4_txt, h4_col] = f_hist_txt(na(hist4) ? 0.0 : hist4, hup4)
[h5_txt, h5_col] = f_hist_txt(na(hist5) ? 0.0 : hist5, hup5)
[h6_txt, h6_col] = f_hist_txt(na(hist6) ? 0.0 : hist6, hup6)

[rd0_txt, rd0_col] = f_div_txt(rdiv0)
[rd1_txt, rd1_col] = f_div_txt(rdiv1)
[rd2_txt, rd2_col] = f_div_txt(rdiv2)
[rd3_txt, rd3_col] = f_div_txt(rdiv3)
[rd4_txt, rd4_col] = f_div_txt(rdiv4)
[rd5_txt, rd5_col] = f_div_txt(rdiv5)
[rd6_txt, rd6_col] = f_div_txt(rdiv6)

[md0_txt, md0_col] = f_div_txt(mdiv0)
[md1_txt, md1_col] = f_div_txt(mdiv1)
[md2_txt, md2_col] = f_div_txt(mdiv2)
[md3_txt, md3_col] = f_div_txt(mdiv3)
[md4_txt, md4_col] = f_div_txt(mdiv4)
[md5_txt, md5_col] = f_div_txt(mdiv5)
[md6_txt, md6_col] = f_div_txt(mdiv6)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABLE
//  Row 0  = title header (merged)
//  Row 1  = column headers
//  Rows 2â€“8 = 7 timeframe data rows
//  Row 9  = weighted total row
//  Row 10 = legend footer
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
NCOLS = 8
NROWS = 11

var table tbl = table.new(f_pos(), NCOLS, NROWS, border_color=col_border, border_width=1, frame_color=col_hdr_bg, frame_width=2)

tbl_cell(col, row, txt, bg, fg) =>
    table.cell(tbl, col, row, txt, bgcolor=bg, text_color=fg, text_size=f_sz(), text_halign=text.align_center)

if barstate.islast
    // â”€â”€ Title â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    table.cell(tbl, 0, 0, "MTF RSI Â· MACD Â· Divergence Dashboard", bgcolor=col_hdr_bg, text_color=col_tbl_txt, text_size=f_sz(), text_halign=text.align_center)
    table.merge_cells(tbl, 0, 0, NCOLS - 1, 0)

    // â”€â”€ Column headers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    hdr_labels = array.from("  TF  ", " RSI ", " RSI Signal ", " MACD Line ", " MACD Signal ", " Histogram ", " RSI Div ", " MACD Div ")
    for c = 0 to NCOLS - 1
        table.cell(tbl, c, 1, array.get(hdr_labels, c), bgcolor=col_hdr2_bg, text_color=col_tbl_txt, text_size=f_sz(), text_halign=text.align_center)

    // â”€â”€ Build data arrays â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    tf_labels  = array.from("â–¸ " + timeframe.period, tf1, tf2, tf3, tf4, tf5, tf6)
    rsi_vals   = array.from(rsi0,  rsi1,  rsi2,  rsi3,  rsi4,  rsi5,  rsi6)
    ml_vals    = array.from(ml0,   ml1,   ml2,   ml3,   ml4,   ml5,   ml6)
    sl_vals    = array.from(sl0,   sl1,   sl2,   sl3,   sl4,   sl5,   sl6)
    hist_vals  = array.from(hist0, hist1, hist2, hist3, hist4, hist5, hist6)
    rdiv_vals  = array.from(rdiv0, rdiv1, rdiv2, rdiv3, rdiv4, rdiv5, rdiv6)
    mdiv_vals  = array.from(mdiv0, mdiv1, mdiv2, mdiv3, mdiv4, mdiv5, mdiv6)

    rsig_txts  = array.from(rsig0_txt, rsig1_txt, rsig2_txt, rsig3_txt, rsig4_txt, rsig5_txt, rsig6_txt)
    rsig_cols  = array.from(rsig0_col, rsig1_col, rsig2_col, rsig3_col, rsig4_col, rsig5_col, rsig6_col)
    msig_txts  = array.from(msig0_txt, msig1_txt, msig2_txt, msig3_txt, msig4_txt, msig5_txt, msig6_txt)
    msig_cols  = array.from(msig0_col, msig1_col, msig2_col, msig3_col, msig4_col, msig5_col, msig6_col)
    h_txts     = array.from(h0_txt, h1_txt, h2_txt, h3_txt, h4_txt, h5_txt, h6_txt)
    h_cols     = array.from(h0_col, h1_col, h2_col, h3_col, h4_col, h5_col, h6_col)
    rd_txts    = array.from(rd0_txt, rd1_txt, rd2_txt, rd3_txt, rd4_txt, rd5_txt, rd6_txt)
    rd_cols    = array.from(rd0_col, rd1_col, rd2_col, rd3_col, rd4_col, rd5_col, rd6_col)
    md_txts    = array.from(md0_txt, md1_txt, md2_txt, md3_txt, md4_txt, md5_txt, md6_txt)
    md_cols    = array.from(md0_col, md1_col, md2_col, md3_col, md4_col, md5_col, md6_col)

    // â”€â”€ Data rows + accumulate weighted scores â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    int total_bull  = 0
    int total_count = 0

    for r = 0 to 6
        row    = r + 2
        bg     = r % 2 == 0 ? col_row_odd : col_row_evn
        rsi_v  = array.get(rsi_vals,  r)
        ml_v   = array.get(ml_vals,   r)
        sl_v   = array.get(sl_vals,   r)
        hist_v = array.get(hist_vals, r)
        rdiv_v = int(array.get(rdiv_vals, r))
        mdiv_v = int(array.get(mdiv_vals, r))

        tbl_cell(0, row, array.get(tf_labels, r), bg, col_tbl_txt)

        if na(rsi_v)
            tbl_cell(1, row, "â€”", bg, color.new(col_tbl_txt, 50))
            tbl_cell(2, row, "No Data", color.new(#212121, 0), color.new(col_tbl_txt, 50))
        else
            tbl_cell(1, row, str.tostring(math.round(rsi_v, 1)), bg, f_rsi_col(rsi_v))
            tbl_cell(2, row, array.get(rsig_txts, r), array.get(rsig_cols, r), col_tbl_txt)

        if na(ml_v)
            tbl_cell(3, row, "â€”", bg, color.new(col_tbl_txt, 50))
            tbl_cell(4, row, "No Data", color.new(#212121, 0), color.new(col_tbl_txt, 50))
        else
            tbl_cell(3, row, str.tostring(ml_v, "#.####"), bg, ml_v > sl_v ? col_macd_bull : col_macd_bear)
            tbl_cell(4, row, array.get(msig_txts, r), array.get(msig_cols, r), col_tbl_txt)

        if na(hist_v)
            tbl_cell(5, row, "â€”", bg, color.new(col_tbl_txt, 50))
        else
            tbl_cell(5, row, array.get(h_txts, r), bg, array.get(h_cols, r))

        tbl_cell(6, row, array.get(rd_txts, r), rdiv_v == 0 ? bg : array.get(rd_cols, r), col_tbl_txt)
        tbl_cell(7, row, array.get(md_txts, r), mdiv_v == 0 ? bg : array.get(md_cols, r), col_tbl_txt)

        // â”€â”€ Accumulate scores â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        s_rsi = f_rsi_score(rsi_v)
        if s_rsi >= 0
            total_count += 1
            total_bull  += s_rsi

        s_macd = f_macd_score(ml_v, sl_v)
        if s_macd >= 0
            total_count += 1
            total_bull  += s_macd

        s_hist = f_hist_score(hist_v)
        if s_hist >= 0
            total_count += 1
            total_bull  += s_hist

        s_rdiv = f_div_score(rdiv_v)
        if s_rdiv >= 0
            total_count += 1
            total_bull  += s_rdiv

        s_mdiv = f_div_score(mdiv_v)
        if s_mdiv >= 0
            total_count += 1
            total_bull  += s_mdiv

    // â”€â”€ Row 9: Weighted Total â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    float bull_pct   = total_count > 0 ? (total_bull / total_count) * 100.0 : 50.0
    string pct_str   = str.tostring(math.round(bull_pct, 1)) + "%"
    string bull_count = str.tostring(total_bull) + " bull / " + str.tostring(total_count - total_bull) + " bear"
    bool   is_bullish = bull_pct >= 50.0
    color  pct_bg    = is_bullish ? color.new(#00c853, 15) : color.new(#d50000, 15)
    string pct_arrow = is_bullish ? "â–²" : "â–¼"
    string bias_lbl  = is_bullish ? " BULLISH" : " BEARISH"
    string pct_label = pct_arrow + bias_lbl + "  " + pct_str

    table.cell(tbl, 0, 9, "âš–  Weighted Signal Total  |  " + bull_count, bgcolor=col_hdr2_bg, text_color=col_tbl_txt, text_size=f_sz(), text_halign=text.align_center)
    table.merge_cells(tbl, 0, 9, NCOLS - 2, 9)
    table.cell(tbl, NCOLS - 1, 9, pct_label, bgcolor=pct_bg, text_color=color.white, text_size=f_sz(), text_halign=text.align_center)

    // â”€â”€ Row 10: Legend footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    table.cell(tbl, 0, 10, "RegBull=PriceLL+IndHL  |  RegBear=PriceHH+IndLH  |  HidBull=PriceHL+IndLL  |  HidBear=PriceLH+IndHH  |  Lines: Solid=Regular  Dashed=Hidden", bgcolor=color.new(col_hdr_bg, 30), text_color=color.new(col_tbl_txt, 60), text_size=size.tiny, text_halign=text.align_center)
    table.merge_cells(tbl, 0, 10, NCOLS - 1, 10)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RSI & MACD OVERLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
_scale_len  = math.max(rsi_ov_scale, macd_ov_scale)
_price_low  = ta.lowest(low,   _scale_len)
_price_high = ta.highest(high, _scale_len)
_price_rng  = math.max(_price_high - _price_low, syminfo.mintick)

_rsi_base    = _price_low + _price_rng * rsi_ov_offset
_rsi_zone    = _price_rng * rsi_ov_height
_s_rsi       = _rsi_base + (rsi0       / 100.0) * _rsi_zone
_s_rsi_ob    = _rsi_base + (rsi_ob     / 100.0) * _rsi_zone
_s_rsi_os    = _rsi_base + (rsi_os     / 100.0) * _rsi_zone
_s_rsi_mid   = _rsi_base + 0.5                   * _rsi_zone
_s_rsi_base  = _rsi_base

_macd_base   = _price_low + _price_rng * macd_ov_offset
_macd_zone   = _price_rng * macd_ov_height
_macd_half   = _macd_zone * 0.5
_macd_zero   = _macd_base + _macd_half
_macd_max    = ta.highest(math.max(math.abs(ml0), math.max(math.abs(sl0), math.abs(hist0))), macd_ov_scale)
_macd_max   := na(_macd_max) or _macd_max == 0.0 ? syminfo.mintick : _macd_max
_s_macd_ml   = _macd_zero + (ml0   / _macd_max) * _macd_half
_s_macd_sl   = _macd_zero + (sl0   / _macd_max) * _macd_half
_s_macd_hist = _macd_zero + (hist0 / _macd_max) * _macd_half

p_rsi_line = plot(show_rsi_ov ? _s_rsi      : na, "RSI Overlay",    color=col_rsi_ov_line, linewidth=2)
p_rsi_ob   = plot(show_rsi_ov ? _s_rsi_ob   : na, "RSI OB Level",   color=col_rsi_ov_ob,   linewidth=1)
p_rsi_os   = plot(show_rsi_ov ? _s_rsi_os   : na, "RSI OS Level",   color=col_rsi_ov_os,   linewidth=1)
p_rsi_mid  = plot(show_rsi_ov ? _s_rsi_mid  : na, "RSI Mid Level",  color=col_rsi_ov_mid,  linewidth=1)
p_rsi_base = plot(show_rsi_ov ? _s_rsi_base : na, "RSI Base",       color=color.new(color.white, 100), linewidth=1)
fill(p_rsi_line, p_rsi_base, color=col_rsi_ov_fill)

_macd_fill_col = ml0 >= 0 ? col_macd_ov_bull : col_macd_ov_bear
p_macd_ml   = plot(show_macd_ov ? _s_macd_ml   : na, "MACD Line Overlay",   color=col_macd_ov_ml,   linewidth=2)
p_macd_sl   = plot(show_macd_ov ? _s_macd_sl   : na, "MACD Signal Overlay", color=col_macd_ov_sl,   linewidth=1)
p_macd_hist = plot(show_macd_ov ? _s_macd_hist : na, "MACD Hist Overlay",   color=_macd_fill_col,   linewidth=3)
p_macd_zero = plot(show_macd_ov ? _macd_zero   : na, "MACD Zero Line",      color=col_macd_ov_zero, linewidth=1)
fill(p_macd_hist, p_macd_zero, color=_macd_fill_col)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA WINDOW Â· ALERTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
plot(rsi0,  "RSI (Current TF)", display=display.data_window, color=color.new(color.purple, 0))
plot(ml0,   "MACD Line",        display=display.data_window, color=color.new(color.blue,   0))
plot(sl0,   "MACD Signal",      display=display.data_window, color=color.new(color.orange, 0))
plot(hist0, "MACD Histogram",   display=display.data_window, color=color.new(color.gray,   0))

alertcondition(rb0,   "RSI Regular Bullish Divergence",  "RSI Regular Bullish Divergence detected")
alertcondition(rbe0,  "RSI Regular Bearish Divergence",  "RSI Regular Bearish Divergence detected")
alertcondition(hb0,   "RSI Hidden Bullish Divergence",   "RSI Hidden Bullish Divergence detected")
alertcondition(hbe0,  "RSI Hidden Bearish Divergence",   "RSI Hidden Bearish Divergence detected")
alertcondition(mrb0,  "MACD Regular Bullish Divergence", "MACD Regular Bullish Divergence detected")
alertcondition(mrbe0, "MACD Regular Bearish Divergence", "MACD Regular Bearish Divergence detected")
alertcondition(mhb0,  "MACD Hidden Bullish Divergence",  "MACD Hidden Bullish Divergence detected")
alertcondition(mhbe0, "MACD Hidden Bearish Divergence",  "MACD Hidden Bearish Divergence detected")
alertcondition(rsi0 >= rsi_ob, "RSI Overbought",   "RSI crossed above overbought level")
alertcondition(rsi0 <= rsi_os, "RSI Oversold",     "RSI crossed below oversold level")
alertcondition(ta.crossover(ml0,  sl0), "MACD Bull Cross", "MACD bullish crossover")
alertcondition(ta.crossunder(ml0, sl0), "MACD Bear Cross", "MACD bearish crossover")
