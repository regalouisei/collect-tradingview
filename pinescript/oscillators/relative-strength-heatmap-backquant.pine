// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © BackQuant

//@version=6
indicator(
 title="Relative Strength Heatmap [BackQuant]", 
 overlay=false
 )

const string set = "Calculation Settings"
const string tfs = "Timeframes"
const string ui = "Plotting and Coloring Settings"

const string step_tt = "Adds this amount to each successive RSI length."
const string mult_tt = "Multiplies each generated RSI length after the step is applied."
const string plt_tt = "RSIs are broken up into 4 groups. Turning this off with remove 5 tiles."
const string cnt_tt = "This is the static count of all RSIs > 70 (White Line), and RSIs<30 (Black Line)"

const string plt= "inline_plotting"

string pal_type = input.string("Viridis","Heatmap Color Palette", options = ["Viridis","Jet","Plasma","Custom Heat","Gray","Cividis","Inferno","Magma","Turbo","Rainbow"])

simple int len = input.int(1, "RS Period", group=set, inline=set)
int step = input.int(2, "RSI Step", group=set, tooltip=step_tt)
float mult = input.float(1.0, "RSI Multiplier", group=set, tooltip=mult_tt)

series float src = input.source(close, "Calculation Source", group=set, inline=set)

bool show1  = input.bool(true, "Show Group 1", group=ui, inline=plt, tooltip=plt_tt)
bool show2  = input.bool(true, "Show Group 2", group=ui, inline=plt, tooltip=plt_tt)
bool show3  = input.bool(true, "Show Group 3", group=ui, inline=plt, tooltip=plt_tt)
bool show4  = input.bool(true, "Show Group 4", group=ui, inline=plt, tooltip=plt_tt)
bool show_count = input.bool(true, "Show Bull and Bear Count", group=ui, tooltip=cnt_tt)

coloring(series float rs, string type) =>
    float v = rs
    color c = color.white

    if type == "Viridis"
        if      v < 10
            c := #440154
        else if v < 20
            c := #472878
        else if v < 30
            c := #3b528b
        else if v < 40
            c := #2c728e
        else if v < 50
            c := #21918c
        else if v < 60
            c := #28ae80
        else if v < 70
            c := #5ec962
        else if v < 80
            c := #aadc32
        else if v < 90
            c := #d5e21a
        else
            c := #fde725

    else if type == "Jet"
        if      v < 10
            c := #00007f
        else if v < 20
            c := #0000ff
        else if v < 30
            c := #007fff
        else if v < 40
            c := #00ffff
        else if v < 50
            c := #7fff7f
        else if v < 60
            c := #ffff00
        else if v < 70
            c := #ffbf00
        else if v < 80
            c := #ff7f00
        else if v < 90
            c := #ff0000
        else
            c := #7f0000

    else if type == "Plasma"
        if      v < 10
            c := #0d0887
        else if v < 20
            c := #41049d
        else if v < 30
            c := #6a00a8
        else if v < 40
            c := #8f0da4
        else if v < 50
            c := #b12a90
        else if v < 60
            c := #cc4778
        else if v < 70
            c := #e16462
        else if v < 80
            c := #f2844b
        else if v < 90
            c := #fca636
        else
            c := #fcfdbf

    else if type == "Custom Heat"
        if      v < 15
            c := #004466
        else if v < 30
            c := #006688
        else if v < 45
            c := #00a0a0
        else if v < 55
            c := #cccccc
        else if v < 60
            c := #ffd480
        else if v < 70
            c := #ffb347
        else if v < 80
            c := #ff7f24
        else if v < 90
            c := #ff4500
        else
            c := #b22222

    else if type == "Gray"
        if      v < 10
            c := #ffffff
        else if v < 20
            c := #f0f0f0
        else if v < 30
            c := #e0e0e0
        else if v < 40
            c := #d0d0d0
        else if v < 50
            c := #c0c0c0
        else if v < 60
            c := #a0a0a0
        else if v < 70
            c := #808080
        else if v < 80
            c := #606060
        else if v < 90
            c := #404040
        else
            c := #000000

    else if type == "Cividis"
        if      v < 10
            c := #00204c
        else if v < 20
            c := #173067
        else if v < 30
            c := #36476f
        else if v < 40
            c := #4b5d6b
        else if v < 50
            c := #62735f
        else if v < 60
            c := #7b884c
        else if v < 70
            c := #979935
        else if v < 80
            c := #b6ba19
        else if v < 90
            c := #d4d322
        else
            c := #fdea45

    else if type == "Inferno"
        if      v < 10
            c := #000004
        else if v < 20
            c := #1b0c41
        else if v < 30
            c := #3b0f70
        else if v < 40
            c := #641a80
        else if v < 50
            c := #8c2981
        else if v < 60
            c := #b5367a
        else if v < 70
            c := #de4968
        else if v < 80
            c := #f66e5b
        else if v < 90
            c := #fe9f6d
        else
            c := #fcfdbf

    else if type == "Magma"
        if      v < 10
            c := #000004
        else if v < 20
            c := #180f3d
        else if v < 30
            c := #3b0f70
        else if v < 40
            c := #5e177f
        else if v < 50
            c := #7f2482
        else if v < 60
            c := #a02a7d
        else if v < 70
            c := #c13672
        else if v < 80
            c := #de4968
        else if v < 90
            c := #f66e5b
        else
            c := #fbfbbf

    else if type == "Turbo"
        if      v < 10
            c := #30123b
        else if v < 20
            c := #4145ad
        else if v < 30
            c := #2f6db3
        else if v < 40
            c := #2488c7
        else if v < 50
            c := #1fa3c2
        else if v < 60
            c := #35b893
        else if v < 70
            c := #84c341
        else if v < 80
            c := #d1c93c
        else if v < 90
            c := #f9a31b
        else
            c := #f0600a

    else if type == "Rainbow"
        if      v < 10
            c := #0000ff
        else if v < 20
            c := #0040ff
        else if v < 30
            c := #0080ff
        else if v < 40
            c := #00c0ff
        else if v < 50
            c := #00ff80
        else if v < 60
            c := #40ff00
        else if v < 70
            c := #80ff00
        else if v < 80
            c := #ffc000
        else if v < 90
            c := #ff8000
        else
            c := #ff0000

    c

rs1 = ta.rsi(src, int(math.round((len + step * 0) * mult)))
rs2 = ta.rsi(src, int(math.round((len + step * 1) * mult)))
rs3 = ta.rsi(src, int(math.round((len + step * 2) * mult)))
rs4 = ta.rsi(src, int(math.round((len + step * 3) * mult)))
rs5 = ta.rsi(src, int(math.round((len + step * 4) * mult)))
rs6 = ta.rsi(src, int(math.round((len + step * 5) * mult)))
rs7 = ta.rsi(src, int(math.round((len + step * 6) * mult)))
rs8 = ta.rsi(src, int(math.round((len + step * 7) * mult)))
rs9 = ta.rsi(src, int(math.round((len + step * 8) * mult)))
rs10 = ta.rsi(src, int(math.round((len + step * 9) * mult)))
rs11 = ta.rsi(src, int(math.round((len + step * 10) * mult)))
rs12 = ta.rsi(src, int(math.round((len + step * 11) * mult)))
rs13 = ta.rsi(src, int(math.round((len + step * 12) * mult)))
rs14 = ta.rsi(src, int(math.round((len + step * 13) * mult)))
rs15 = ta.rsi(src, int(math.round((len + step * 14) * mult)))
rs16 = ta.rsi(src, int(math.round((len + step * 15) * mult)))
rs17 = ta.rsi(src, int(math.round((len + step * 16) * mult)))
rs18 = ta.rsi(src, int(math.round((len + step * 17) * mult)))
rs19 = ta.rsi(src, int(math.round((len + step * 18) * mult)))
rs20 = ta.rsi(src, int(math.round((len + step * 19) * mult)))

plot(series=show1?1:na, title="RSI 1", color=coloring(rs1,pal_type), style=plot.style_area, histbase=0)
plot(series=show1?2:na, title="RSI 2", color=coloring(rs2,pal_type), style=plot.style_area, histbase=1)
plot(series=show1?3:na, title="RSI 3", color=coloring(rs3,pal_type), style=plot.style_area, histbase=2)
plot(series=show1?4:na, title="RSI 4", color=coloring(rs4,pal_type), style=plot.style_area, histbase=3)
plot(series=show1?5:na, title="RSI 5", color=coloring(rs5,pal_type), style=plot.style_area, histbase=4)

plot(series=show2?6:na, title="RSI 6", color=coloring(rs6,pal_type), style=plot.style_area, histbase=5)
plot(series=show2?7:na, title="RSI 7", color=coloring(rs7,pal_type), style=plot.style_area, histbase=6)
plot(series=show2?8:na, title="RSI 8", color=coloring(rs8,pal_type), style=plot.style_area, histbase=7)
plot(series=show2?9:na, title="RSI 9", color=coloring(rs9,pal_type), style=plot.style_area, histbase=8)
plot(series=show2?10:na, title="RSI 10", color=coloring(rs10,pal_type), style=plot.style_area, histbase=9)

plot(series=show3?11:na, title="RSI 11", color=coloring(rs11,pal_type), style=plot.style_area, histbase=10)
plot(series=show3?12:na, title="RSI 12", color=coloring(rs12,pal_type), style=plot.style_area, histbase=11)
plot(series=show3?13:na, title="RSI 13", color=coloring(rs13,pal_type), style=plot.style_area, histbase=12)
plot(series=show3?14:na, title="RSI 14", color=coloring(rs14,pal_type), style=plot.style_area, histbase=13)
plot(series=show3?15:na, title="RSI 15", color=coloring(rs15,pal_type), style=plot.style_area, histbase=14)

plot(series=show4?16:na, title="RSI 16", color=coloring(rs16,pal_type), style=plot.style_area, histbase=15)
plot(series=show4?17:na, title="RSI 17", color=coloring(rs17,pal_type), style=plot.style_area, histbase=16)
plot(series=show4?18:na, title="RSI 18", color=coloring(rs18,pal_type), style=plot.style_area, histbase=17)
plot(series=show4?19:na, title="RSI 19", color=coloring(rs19,pal_type), style=plot.style_area, histbase=18)
plot(series=show4?20:na, title="RSI 20", color=coloring(rs20,pal_type), style=plot.style_area, histbase=19)


int bullCount = 0
int bearCount = 0

float[] all = array.from(rs1,rs2,rs3,rs4,rs5,rs6,rs7,rs8,rs9,rs10,rs11,rs12,rs13,rs14,rs15,rs16,rs17,rs18,rs19,rs20)

for i = 0 to all.size() - 1
    v = all.get(i)
    bullCount += v > 70 ? 1 : 0
    bearCount += v < 30 ? 1 : 0

plot(show_count?bullCount:na,  title="RSI > 70 Count", color=color.white, linewidth=4)
plot(show_count?bearCount:na, title="RSI < 30 Count", color=color.black, linewidth=4)

// Alert Conditions
bool strongBull = bullCount >= 10
bool strongBear = bearCount >= 10

alertcondition(strongBull, "RSI Heatmap Strong Bull", "RSI heatmap strongly overbought cluster {{exchange}}:{{ticker}}")
alertcondition(strongBear, "RSI Heatmap Strong Bear", "RSI heatmap strongly oversold cluster {{exchange}}:{{ticker}}")

bgcolor(strongBull?color.new(coloring(rs1,pal_type),90):na, title="Strong Bull", force_overlay=true)
bgcolor(strongBull?color.new(coloring(rs1,pal_type),90):na, title="Strong Bull", force_overlay=true)

bgcolor(strongBear?color.new(coloring(rs20,pal_type),90):na, title="Strong Bear", force_overlay=true)
bgcolor(strongBear?color.new(coloring(rs20,pal_type),90):na, title="Strong Bear", force_overlay=true)
