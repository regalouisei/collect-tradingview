//@version=6
indicator("RSI Dav1zoN Grid", overlay=true)

//──────────────────── Inputs ────────────────────
rsiLen  = input.int(14, "RSI Length", minval=1)
rsiOB   = input.int(70, "RSI Overbought", minval=1, maxval=99)
rsiOS   = input.int(30, "RSI Oversold",  minval=1, maxval=99)

// Trend threshold (NEW)
trendMid = input.float(50.0, "Trend threshold (RSI)", minval=1, maxval=99)

gridPos  = input.string("top_right", "Grid Position",
     options=["top_left","top_right","middle_left","middle_right","bottom_left","bottom_right"])
gridSize = input.string("small", "Text Size", options=["tiny","small","normal"])
decPrice = input.int(4, "Price Decimals", minval=0, maxval=10)

// Confirmation mode: close vs wick
confirmMode = input.string("Wick (high/low)", "Confirmation uses",
     options=["Close", "Wick (high/low)"])

//──────────────────── Style Inputs ────────────────────
tblBgColor   = input.color(#202033, "Table background color")
tblBgTransp  = input.int(60, "Table background transparency", minval=0, maxval=100)

hdrBgColor   = input.color(#0f0f23, "Header background color")
hdrBgTransp  = input.int(0, "Header background transparency", minval=0, maxval=100)

borderWidth  = input.int(1, "Border width", minval=0, maxval=5)

//──────────────────── Helpers ────────────────────
sz() => gridSize=="tiny"?size.tiny:gridSize=="small"?size.small:size.normal

posFrom(s)=>switch s
    "top_left"=>position.top_left
    "middle_left"=>position.middle_left
    "bottom_left"=>position.bottom_left
    "middle_right"=>position.middle_right
    "bottom_right"=>position.bottom_right
    =>position.top_right

fmtPattern() =>
    decPrice <= 0 ? "#" : "#." + str.repeat("#", decPrice)

fmt(x)=>na(x)?"—":str.tostring(x, fmtPattern())

//──────────────── RSI Projection ────────────────
projRSI(target)=>
    rsT = target/(100-target)

    ch = close - close[1]
    up = math.max(ch,0)
    dn = math.max(-ch,0)

    avgUp = ta.rma(up,rsiLen)[1]
    avgDn = ta.rma(dn,rsiLen)[1]

    na(avgUp) or na(avgDn) or na(close[1]) ? na :
     target > 50
      ? close[1] + (rsiLen-1)*(rsT*avgDn-avgUp)
      : close[1] - (rsiLen-1)*(avgUp/rsT-avgDn)

//──────────────── Data ────────────────────
getData()=>
    r = ta.rsi(close,rsiLen)
    p30 = projRSI(rsiOS)
    p70 = projRSI(rsiOB)
    [r,p30,p70]

// Chart TF (not used in table but kept)
[rC,p30C,p70C]=getData()

// Multi TF
[r1,  p301,  p701 ] = request.security(syminfo.tickerid, "1",   getData())
[r5,  p305,  p705 ] = request.security(syminfo.tickerid, "5",   getData())
[r15, p3015, p7015] = request.security(syminfo.tickerid, "15",  getData())
[r1h, p301h, p701h] = request.security(syminfo.tickerid, "60",  getData())
[r4h, p304h, p704h] = request.security(syminfo.tickerid, "240", getData())
[r1d, p301d, p701d] = request.security(syminfo.tickerid, "D",   getData())
[r1w, p301w, p701w] = request.security(syminfo.tickerid, "W",   getData())
[r1m, p301m, p701m] = request.security(syminfo.tickerid, "M",   getData())

//──────────────── Confirmation logic ────────────────────
reachBelow(p) => confirmMode == "Close" ? close <= p : low <= p
reachAbove(p) => confirmMode == "Close" ? close >= p : high >= p

isOS(r, p30) => not na(r) and not na(p30) and r <= rsiOS and reachBelow(p30)
isOB(r, p70) => not na(r) and not na(p70) and r >= rsiOB and reachAbove(p70)

colRSI(r, p30, p70) =>
    (
        isOS(r, p30) ? color.red :
        isOB(r, p70) ? color.lime :
        color.white
    )

col30(r, p30) => (isOS(r, p30) ? color.red  : color.white)
col70(r, p70) => (isOB(r, p70) ? color.lime : color.white)

//──────────────── Trend L/S column (NEW) ────────────────────
trendTxt(r) =>
    na(r) ? "—" : (r >= trendMid ? "L" : "S")

trendCol(r) =>
    na(r) ? color.white : (r >= trendMid ? color.lime : color.red)

//──────────────── Table ────────────────────
// Now 5 columns instead of 4 (NEW)
var table t = table.new(posFrom(gridPos), 5, 9, border_width=borderWidth)

// precomputed backgrounds
bgRow = color.new(tblBgColor, tblBgTransp)
bgHdr = color.new(hdrBgColor, hdrBgTransp)

row(rn, tf, rsi, p30, p70)=>
    table.cell(t,0,rn,tf,                       bgcolor=bgRow, text_color=color.white,          text_size=sz())
    table.cell(t,1,rn,trendTxt(rsi),             bgcolor=bgRow, text_color=trendCol(rsi),        text_size=sz())
    table.cell(t,2,rn,str.tostring(rsi,"#.##"),  bgcolor=bgRow, text_color=colRSI(rsi,p30,p70),  text_size=sz())
    table.cell(t,3,rn,fmt(p30),                  bgcolor=bgRow, text_color=col30(rsi,p30),       text_size=sz())
    table.cell(t,4,rn,fmt(p70),                  bgcolor=bgRow, text_color=col70(rsi,p70),       text_size=sz())

if barstate.islast
    // Headers
    table.cell(t,0,0,"Time",  bgcolor=bgHdr, text_color=color.white, text_size=sz())
    table.cell(t,1,0,"L/S",   bgcolor=bgHdr, text_color=color.white, text_size=sz())
    table.cell(t,2,0,"RSI",   bgcolor=bgHdr, text_color=color.white, text_size=sz())
    table.cell(t,3,0,"RSI 30",bgcolor=bgHdr, text_color=color.white, text_size=sz())
    table.cell(t,4,0,"RSI 70",bgcolor=bgHdr, text_color=color.white, text_size=sz())

    row(1,"1m",  r1,  p301,  p701)
    row(2,"5m",  r5,  p305,  p705)
    row(3,"15m", r15, p3015, p7015)
    row(4,"1H",  r1h, p301h, p701h)
    row(5,"4H",  r4h, p304h, p704h)
    row(6,"1D",  r1d, p301d, p701d)
    row(7,"1W",  r1w, p301w, p701w)
    row(8,"1M",  r1m, p301m, p701m)
