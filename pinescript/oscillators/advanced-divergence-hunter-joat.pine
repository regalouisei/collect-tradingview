// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © officialjackofalltrades
//@version=6
indicator("Advanced Divergence Hunter [JOAT]", shorttitle="ADH [JOAT]", overlay=false, max_labels_count=100, max_lines_count=100)

// ═══════════════════════════════════════════════════════════════════════════════
// ADVANCED DIVERGENCE HUNTER
// Multi-oscillator divergence detection with PNR filtering
// ═══════════════════════════════════════════════════════════════════════════════

// ────────────────────────────────────────────────────────────────────────────────
// INPUTS
// ────────────────────────────────────────────────────────────────────────────────

// RSI Settings
rsiGroup = "RSI Settings"
rsiLength = input.int(14, "RSI Length", minval=1, group=rsiGroup)
rsiSource = input.source(close, "RSI Source", group=rsiGroup)

// Divergence Settings
divGroup = "Divergence Settings"
pivotLeft = input.int(5, "Pivot Left Bars", minval=1, group=divGroup)
pivotRight = input.int(5, "Pivot Right Bars", minval=1, group=divGroup)
maxLookback = input.int(60, "Max Lookback Range", minval=10, group=divGroup)
minLookback = input.int(5, "Min Lookback Range", minval=1, group=divGroup)

// Display Options
displayGroup = "Display Options"
showRegularBull = input.bool(true, "Show Regular Bullish", group=displayGroup)
showHiddenBull = input.bool(false, "Show Hidden Bullish", group=displayGroup)
showRegularBear = input.bool(true, "Show Regular Bearish", group=displayGroup)
showHiddenBear = input.bool(false, "Show Hidden Bearish", group=displayGroup)

// PNR Filter Settings
pnrGroup = "PNR Filter Settings"
usePNRFilter = input.bool(true, "Use PNR Filter", group=pnrGroup)
pnrLength = input.int(200, "PNR Length", minval=10, group=pnrGroup)
pnrLow = input.float(0.0, "Percentile Low", minval=0, maxval=100, step=0.1, group=pnrGroup)
pnrHigh = input.float(1.0, "Percentile High", minval=0, maxval=100, step=0.1, group=pnrGroup)
pnrSource = input.string("RSI", "PNR Source", options=["RSI", "Close"], group=pnrGroup)

// ────────────────────────────────────────────────────────────────────────────────
// COLOR DEFINITIONS
// ────────────────────────────────────────────────────────────────────────────────

rsiColor = color.rgb(41, 98, 255)
rsiMidColor = color.rgb(120, 123, 134)
obColor = color.rgb(120, 123, 134)
osColor = color.rgb(120, 123, 134)
bgColor = color.rgb(33, 150, 243, 90)

bullDivColor = color.rgb(76, 175, 80)
bearDivColor = color.rgb(244, 67, 54)
hiddenBullColor = color.new(color.green, 60)
hiddenBearColor = color.new(color.red, 60)

pnrLowColor = color.new(color.green, 50)
pnrHighColor = color.new(color.red, 30)
pnrFillColor = color.new(color.green, 50)
pnrSrcColor = color.white

signalBullColor = color.rgb(0, 255, 0)
signalBearColor = color.rgb(255, 0, 0)

// ────────────────────────────────────────────────────────────────────────────────
// MULTI-OSCILLATOR CALCULATIONS
// ────────────────────────────────────────────────────────────────────────────────

rsi = ta.rsi(rsiSource, rsiLength)

// Stoch RSI with K and D lines
stochRSIK = ta.stoch(rsi, rsi, rsi, 14)
stochRSID = ta.sma(stochRSIK, 3)

[macdLine, macdSignal, macdHist] = ta.macd(close, 12, 26, 9)
cci = ta.cci(close, 20)

// Money Flow Index
mfi = ta.mfi(close, 14)

// Williams %R
williamsR = ta.wpr(14)

// Composite oscillator for enhanced divergence detection
compositeOsc = (rsi + stochRSIK + ((macdHist + 100) / 2) + ((cci + 200) / 4) + mfi + ((williamsR + 100))) / 6

// Momentum indicators
rsiMomentum = ta.change(rsi, 3)
rsiAcceleration = ta.change(rsiMomentum, 2)

// Trend strength from multiple oscillators
bullishOscCount = (rsi > 50 ? 1 : 0) + (stochRSIK > 50 ? 1 : 0) + (macdHist > 0 ? 1 : 0) + (cci > 0 ? 1 : 0) + (mfi > 50 ? 1 : 0)
bearishOscCount = 5 - bullishOscCount

// ────────────────────────────────────────────────────────────────────────────────
// ENHANCED DIVERGENCE DETECTION WITH MULTI-OSCILLATOR SUPPORT
// ────────────────────────────────────────────────────────────────────────────────

// Pivot Detection on RSI and Composite Oscillator
pivotLowFound = not na(ta.pivotlow(rsi, pivotLeft, pivotRight))
pivotHighFound = not na(ta.pivothigh(rsi, pivotLeft, pivotRight))

compositePivotLowFound = not na(ta.pivotlow(compositeOsc, pivotLeft, pivotRight))
compositePivotHighFound = not na(ta.pivothigh(compositeOsc, pivotLeft, pivotRight))

// Pre-calculate bars since conditions for range checking
barsLowFound = ta.barssince(pivotLowFound)
barsHighFound = ta.barssince(pivotHighFound)
barsCompLowFound = ta.barssince(compositePivotLowFound)
barsCompHighFound = ta.barssince(compositePivotHighFound)

// Range check results
inRangeLow = minLookback <= barsLowFound and barsLowFound <= maxLookback
inRangeHigh = minLookback <= barsHighFound and barsHighFound <= maxLookback
inRangeCompLow = minLookback <= barsCompLowFound and barsCompLowFound <= maxLookback
inRangeCompHigh = minLookback <= barsCompHighFound and barsCompHighFound <= maxLookback

// Regular Bullish Divergence: Price LL + RSI HL
rsiHL = rsi[pivotRight] > ta.valuewhen(pivotLowFound, rsi[pivotRight], 1) and inRangeLow
priceLL = low[pivotRight] < ta.valuewhen(pivotLowFound, low[pivotRight], 1)
regularBullDiv = priceLL and rsiHL and pivotLowFound

// Hidden Bullish Divergence: Price HL + RSI LL
rsiLL = rsi[pivotRight] < ta.valuewhen(pivotLowFound, rsi[pivotRight], 1) and inRangeLow
priceHL = low[pivotRight] > ta.valuewhen(pivotLowFound, low[pivotRight], 1)
hiddenBullDiv = priceHL and rsiLL and pivotLowFound

// Regular Bearish Divergence: Price HH + RSI LH
rsiLH = rsi[pivotRight] < ta.valuewhen(pivotHighFound, rsi[pivotRight], 1) and inRangeHigh
priceHH = high[pivotRight] > ta.valuewhen(pivotHighFound, high[pivotRight], 1)
regularBearDiv = priceHH and rsiLH and pivotHighFound

// Hidden Bearish Divergence: Price LH + RSI HH
rsiHH = rsi[pivotRight] > ta.valuewhen(pivotHighFound, rsi[pivotRight], 1) and inRangeHigh
priceLH = high[pivotRight] < ta.valuewhen(pivotHighFound, high[pivotRight], 1)
hiddenBearDiv = priceLH and rsiHH and pivotHighFound

// Composite Oscillator Divergences for Confirmation
compHL = compositeOsc[pivotRight] > ta.valuewhen(compositePivotLowFound, compositeOsc[pivotRight], 1) and inRangeCompLow
compLH = compositeOsc[pivotRight] < ta.valuewhen(compositePivotHighFound, compositeOsc[pivotRight], 1) and inRangeCompHigh

// Enhanced divergence with multi-oscillator confirmation
enhancedBullDiv = regularBullDiv and compHL
enhancedBearDiv = regularBearDiv and compLH

// Divergence Strength Score (0-100)
divStrength = 0.0
divStrength := regularBullDiv or hiddenBullDiv ? 
              (enhancedBullDiv ? 100 : regularBullDiv ? 75 : 50) :
              regularBearDiv or hiddenBearDiv ?
              (enhancedBearDiv ? 100 : regularBearDiv ? 75 : 50) : 0

// ────────────────────────────────────────────────────────────────────────────────
// ENHANCED PNR FILTER WITH DYNAMIC ZONES
// ────────────────────────────────────────────────────────────────────────────────

pnrSrc = pnrSource == "RSI" ? rsi : close
pnrValueLow = ta.percentile_nearest_rank(pnrSrc, pnrLength, pnrLow)
pnrValueHigh = ta.percentile_nearest_rank(pnrSrc, pnrLength, pnrHigh)

// Dynamic PNR zones based on volatility
atr = ta.atr(14)
atrPercent = (atr / close) * 100
volatilityMultiplier = atrPercent > 2 ? 1.5 : atrPercent > 1 ? 1.2 : 1.0

pnrLowAdjusted = pnrValueLow * volatilityMultiplier
pnrHighAdjusted = pnrValueHigh / volatilityMultiplier

pnrBullSignal = ta.crossover(pnrSrc, pnrLowAdjusted)
pnrBearSignal = ta.crossunder(pnrSrc, pnrHighAdjusted)

// PNR Zone Gradient Coloring
pnrZoneColor = pnrSrc > pnrHighAdjusted ? color.from_gradient(pnrSrc, pnrHighAdjusted, pnrHighAdjusted * 1.2, pnrHighColor, color.new(bearDivColor, 0)) :
               pnrSrc < pnrLowAdjusted ? color.from_gradient(pnrSrc, pnrLowAdjusted * 0.8, pnrLowAdjusted, color.new(bullDivColor, 0), pnrLowColor) :
               color.from_gradient(pnrSrc, pnrLowAdjusted, pnrHighAdjusted, pnrLowColor, pnrHighColor)

// ────────────────────────────────────────────────────────────────────────────────
// ENHANCED PLOTTING WITH GRADIENT COLORS
// ────────────────────────────────────────────────────────────────────────────────

// RSI Line with gradient based on momentum
rsiGradientColor = rsiMomentum > 2 ? color.from_gradient(rsi, 50, 100, color.new(rsiColor, 50), color.new(bullDivColor, 0)) :
                   rsiMomentum < -2 ? color.from_gradient(rsi, 0, 50, color.new(bearDivColor, 0), color.new(rsiColor, 50)) :
                   rsiColor

plot(rsi, "RSI", rsiGradientColor, 3)

// Stoch RSI K and D lines
stochKColor = color.from_gradient(stochRSIK, 0, 100, color.rgb(255, 100, 100), color.rgb(100, 255, 100))
plot(stochRSIK, "Stoch RSI K", stochKColor, 2)
plot(stochRSID, "Stoch RSI D", color.new(color.orange, 30), 1, plot.style_line)

// MACD Histogram scaled to fit (offset to -100)
macdHistScaled = macdHist * 5
macdHistColor = macdHist > 0 ? color.from_gradient(macdHist, 0, 2, color.new(bullDivColor, 70), bullDivColor) : color.from_gradient(macdHist, -2, 0, bearDivColor, color.new(bearDivColor, 70))
plot(macdHistScaled - 100, "MACD Histogram", macdHistColor, 3, plot.style_histogram)

// MFI Line
mfiColor = color.from_gradient(mfi, 0, 100, color.rgb(255, 50, 50), color.rgb(50, 255, 50))
plot(mfi, "MFI", mfiColor, 1, plot.style_circles)

// Composite Oscillator with enhanced gradient
compColor = compositeOsc > 60 ? color.new(bullDivColor, 40) : compositeOsc < 40 ? color.new(bearDivColor, 40) : color.new(color.orange, 60)
plot(compositeOsc, "Composite Oscillator", compColor, 2)

// RSI Levels and Zones
hline(50, "Middle", rsiMidColor, hline.style_dotted)
obLevel = hline(70, "Overbought", obColor, hline.style_dotted)
osLevel = hline(30, "Oversold", osColor, hline.style_dotted)
hline(80, "Extreme OB", color.new(bearDivColor, 60), hline.style_solid)
hline(20, "Extreme OS", color.new(bullDivColor, 60), hline.style_solid)
fill(obLevel, osLevel, bgColor, title="Background")

// Stoch RSI levels
hline(80, "Stoch OB", color.new(color.red, 80), hline.style_dotted)
hline(20, "Stoch OS", color.new(color.green, 80), hline.style_dotted)

// Background zones for extreme conditions
bgcolor(rsi > 80 ? color.new(bearDivColor, 92) : na, title="Extreme Overbought Zone")
bgcolor(rsi < 20 ? color.new(bullDivColor, 92) : na, title="Extreme Oversold Zone")
bgcolor(stochRSIK > 90 and stochRSID > 90 ? color.new(color.red, 95) : na, title="Stoch Extreme OB")
bgcolor(stochRSIK < 10 and stochRSID < 10 ? color.new(color.green, 95) : na, title="Stoch Extreme OS")

// Momentum acceleration zones
bgcolor(rsiAcceleration > 5 ? color.new(bullDivColor, 97) : na, title="Strong Bullish Momentum")
bgcolor(rsiAcceleration < -5 ? color.new(bearDivColor, 97) : na, title="Strong Bearish Momentum")

// Divergence Lines and Labels with Enhanced Visuals
bullDivLine = plot(showRegularBull and pivotLowFound ? rsi[pivotRight] : na, 
                   offset=-pivotRight, title="Regular Bullish", 
                   linewidth=3, 
                   color=regularBullDiv ? (enhancedBullDiv ? color.new(bullDivColor, 0) : color.new(bullDivColor, 30)) : color.new(color.white, 100))

hiddenBullDivLine = plot(showHiddenBull and pivotLowFound ? rsi[pivotRight] : na, 
                          offset=-pivotRight, title="Hidden Bullish", 
                          linewidth=2, color=hiddenBullDiv ? hiddenBullColor : color.new(color.white, 100))

bearDivLine = plot(showRegularBear and pivotHighFound ? rsi[pivotRight] : na, 
                   offset=-pivotRight, title="Regular Bearish", 
                   linewidth=3, 
                   color=regularBearDiv ? (enhancedBearDiv ? color.new(bearDivColor, 0) : color.new(bearDivColor, 30)) : color.new(color.white, 100))

hiddenBearDivLine = plot(showHiddenBear and pivotHighFound ? rsi[pivotRight] : na, 
                          offset=-pivotRight, title="Hidden Bearish", 
                          linewidth=2, color=hiddenBearDiv ? hiddenBearColor : color.new(color.white, 100))

// Enhanced Divergence Labels - Regular Bull
plotshape(showRegularBull and regularBullDiv and enhancedBullDiv ? rsi[pivotRight] : na, 
          offset=-pivotRight, title="Strong Bull Div", 
          text="STRONG\nBULL", 
          style=shape.labelup, location=location.absolute, 
          color=color.new(bullDivColor, 0), 
          textcolor=color.white, size=size.normal)

plotshape(showRegularBull and regularBullDiv and not enhancedBullDiv ? rsi[pivotRight] : na, 
          offset=-pivotRight, title="Bull Div", 
          text="Bull", 
          style=shape.labelup, location=location.absolute, 
          color=bullDivColor, 
          textcolor=color.white, size=size.small)

plotshape(showHiddenBull and hiddenBullDiv ? rsi[pivotRight] : na, 
          offset=-pivotRight, title="Hidden Bull Div Label", 
          text="H Bull", style=shape.labelup, location=location.absolute, 
          color=hiddenBullColor, textcolor=color.white, size=size.small)

// Enhanced Divergence Labels - Regular Bear
plotshape(showRegularBear and regularBearDiv and enhancedBearDiv ? rsi[pivotRight] : na, 
          offset=-pivotRight, title="Strong Bear Div", 
          text="STRONG\nBEAR", 
          style=shape.labeldown, location=location.absolute, 
          color=color.new(bearDivColor, 0), 
          textcolor=color.white, size=size.normal)

plotshape(showRegularBear and regularBearDiv and not enhancedBearDiv ? rsi[pivotRight] : na, 
          offset=-pivotRight, title="Bear Div", 
          text="Bear", 
          style=shape.labeldown, location=location.absolute, 
          color=bearDivColor, 
          textcolor=color.white, size=size.small)

plotshape(showHiddenBear and hiddenBearDiv ? rsi[pivotRight] : na, 
          offset=-pivotRight, title="Hidden Bear Div Label", 
          text="H Bear", style=shape.labeldown, location=location.absolute, 
          color=hiddenBearColor, textcolor=color.white, size=size.small)

// Enhanced PNR Filter with Gradient
pnrLowPlot = plot(usePNRFilter ? pnrLowAdjusted : na, "PNR Low", pnrLowColor, 2)
pnrHighPlot = plot(usePNRFilter ? pnrHighAdjusted : na, "PNR High", pnrHighColor, 2)
fill(pnrLowPlot, pnrHighPlot, color.new(pnrZoneColor, 85), title="PNR Zone")
plot(usePNRFilter ? pnrSrc : na, "PNR Source", pnrZoneColor, 2)

// PNR Signals with Enhanced Visuals
plotchar(usePNRFilter and pnrBullSignal ? pnrSrc : na, 
         title="PNR Bull Signal", char="▲", location=location.absolute, 
         color=signalBullColor, size=size.small)

plotchar(usePNRFilter and pnrBearSignal ? pnrSrc : na, 
         title="PNR Bear Signal", char="▼", location=location.absolute, 
         color=signalBearColor, size=size.small)

// ────────────────────────────────────────────────────────────────────────────────
// ENHANCED INFORMATION TABLE
// ────────────────────────────────────────────────────────────────────────────────

var table infoTable = table.new(position.top_right, 2, 11, 
                                 bgcolor=color.new(color.black, 85), 
                                 frame_color=color.new(color.gray, 50), 
                                 frame_width=1, 
                                 border_width=1, 
                                 border_color=color.new(color.gray, 50))

if barstate.islast
    table.cell(infoTable, 0, 0, "Metric", bgcolor=color.new(color.gray, 70), text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, "Value", bgcolor=color.new(color.gray, 70), text_color=color.white, text_size=size.small)
    
    table.cell(infoTable, 0, 1, "RSI", text_color=rsiColor, text_size=size.small)
    table.cell(infoTable, 1, 1, str.tostring(rsi, "#.##"), text_color=color.white, text_size=size.small)
    
    rsiStatus = rsi > 70 ? "OB" : rsi < 30 ? "OS" : "NEU"
    rsiStatusColor = rsi > 70 ? color.new(bearDivColor, 30) : rsi < 30 ? color.new(bullDivColor, 30) : color.new(color.gray, 70)
    
    table.cell(infoTable, 0, 2, "Status", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 2, rsiStatus, bgcolor=rsiStatusColor, text_color=color.white, text_size=size.small)
    
    table.cell(infoTable, 0, 3, "Stoch K", text_color=color.yellow, text_size=size.small)
    table.cell(infoTable, 1, 3, str.tostring(stochRSIK, "#.#"), text_color=color.white, text_size=size.small)
    
    table.cell(infoTable, 0, 4, "MFI", text_color=color.aqua, text_size=size.small)
    table.cell(infoTable, 1, 4, str.tostring(mfi, "#.#"), text_color=color.white, text_size=size.small)
    
    pnrStatus = pnrSrc > pnrHighAdjusted ? "HIGH" : pnrSrc < pnrLowAdjusted ? "LOW" : "MID"
    pnrStatusColor = pnrSrc > pnrHighAdjusted ? color.new(bearDivColor, 30) : 
                     pnrSrc < pnrLowAdjusted ? color.new(bullDivColor, 30) : color.new(color.gray, 70)
    
    table.cell(infoTable, 0, 5, "PNR", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 5, pnrStatus, bgcolor=pnrStatusColor, text_color=color.white, text_size=size.small)
    
    table.cell(infoTable, 0, 6, "Div Strength", text_color=color.white, text_size=size.small)
    divStrengthColor = divStrength >= 75 ? color.new(color.yellow, 30) : 
                       divStrength >= 50 ? color.new(color.orange, 30) : color.new(color.gray, 70)
    table.cell(infoTable, 1, 6, str.tostring(divStrength, "#") + "%", bgcolor=divStrengthColor, text_color=color.white, text_size=size.small)
    
    table.cell(infoTable, 0, 7, "Composite", text_color=color.orange, text_size=size.small)
    table.cell(infoTable, 1, 7, str.tostring(compositeOsc, "#.#"), text_color=color.white, text_size=size.small)
    
    table.cell(infoTable, 0, 8, "MACD Hist", text_color=color.fuchsia, text_size=size.small)
    macdHistStatus = macdHist > 0 ? "BULL" : "BEAR"
    macdHistColor = macdHist > 0 ? color.new(bullDivColor, 30) : color.new(bearDivColor, 30)
    table.cell(infoTable, 1, 8, macdHistStatus, bgcolor=macdHistColor, text_color=color.white, text_size=size.small)
    
    table.cell(infoTable, 0, 9, "Momentum", text_color=color.white, text_size=size.small)
    momentumText = rsiMomentum > 2 ? "STRONG ↑" : rsiMomentum > 0 ? "UP ↑" : rsiMomentum < -2 ? "STRONG ↓" : rsiMomentum < 0 ? "DOWN ↓" : "FLAT"
    momentumColor = rsiMomentum > 2 ? color.new(bullDivColor, 20) : rsiMomentum > 0 ? color.new(bullDivColor, 50) : rsiMomentum < -2 ? color.new(bearDivColor, 20) : rsiMomentum < 0 ? color.new(bearDivColor, 50) : color.new(color.gray, 70)
    table.cell(infoTable, 1, 9, momentumText, bgcolor=momentumColor, text_color=color.white, text_size=size.small)
    
    table.cell(infoTable, 0, 10, "Osc Align", text_color=color.white, text_size=size.small)
    alignText = bullishOscCount >= 4 ? "BULL " + str.tostring(bullishOscCount) + "/5" : bearishOscCount >= 4 ? "BEAR " + str.tostring(bearishOscCount) + "/5" : "MIXED"
    alignColor = bullishOscCount >= 4 ? color.new(bullDivColor, 30) : bearishOscCount >= 4 ? color.new(bearDivColor, 30) : color.new(color.gray, 70)
    table.cell(infoTable, 1, 10, alignText, bgcolor=alignColor, text_color=color.white, text_size=size.small)

// ────────────────────────────────────────────────────────────────────────────────
// ENHANCED ALERTS
// ────────────────────────────────────────────────────────────────────────────────

alertcondition(regularBullDiv, "Regular Bullish Divergence", "Regular Bullish Divergence Detected")
alertcondition(hiddenBullDiv, "Hidden Bullish Divergence", "Hidden Bullish Divergence Detected")
alertcondition(regularBearDiv, "Regular Bearish Divergence", "Regular Bearish Divergence Detected")
alertcondition(hiddenBearDiv, "Hidden Bearish Divergence", "Hidden Bearish Divergence Detected")
alertcondition(enhancedBullDiv, "STRONG Bullish Divergence", "Multi-Oscillator Confirmed Bullish Divergence")
alertcondition(enhancedBearDiv, "STRONG Bearish Divergence", "Multi-Oscillator Confirmed Bearish Divergence")
alertcondition(pnrBullSignal, "PNR Bullish Signal", "PNR crossed above low percentile")
alertcondition(pnrBearSignal, "PNR Bearish Signal", "PNR crossed below high percentile")
alertcondition(rsi < 20, "RSI Extreme Oversold", "RSI below 20 - Extreme oversold condition")
alertcondition(rsi > 80, "RSI Extreme Overbought", "RSI above 80 - Extreme overbought condition")
