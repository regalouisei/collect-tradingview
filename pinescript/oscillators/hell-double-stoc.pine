//@version=5
indicator(title="CM_Stochastic_MTF", shorttitle="CM_Stoch_MTF", overlay=false)

// === Inputs ===
len = input.int(14, minval=1, title="Length for Main Stochastic")
smoothK = input.int(3, minval=1, title="SmoothK for Main Stochastic")
smoothD = input.int(3, minval=1, title="SmoothD for Main Stochastic")
upLine = input.int(80, minval=50, maxval=90, title="Upper Line Value?")
lowLine = input.int(20, minval=10, maxval=50, title="Lower Line Value?")
sml = input.bool(true, title="Show Mid Line?")
sl = input.bool(true, title="Show Signals on Chart?")

useCurrentRes = input.bool(true, title="Use Current Chart Resolution?")
resCustom = input.timeframe("60", title="Custom Timeframe for Main Stoch")

ssStoch = input.bool(false, title="Show 2nd Stoch?")
resCustom2 = input.timeframe("D", title="Custom Timeframe for 2nd Stoch")
useCurrentRes2 = input.bool(false, title="Use 2nd Stoch on Current Chart Timeframe?")

// === Resolutions ===
res = useCurrentRes ? timeframe.period : resCustom
res2 = useCurrentRes2 ? timeframe.period : resCustom2

// === Main Stochastic Calculation ===
k_main = ta.sma(ta.stoch(close, high, low, len), smoothK)
d_main = ta.sma(k_main, smoothD)
outK = request.security(syminfo.tickerid, res, k_main)
outD = request.security(syminfo.tickerid, res, d_main)

// === 2nd Stochastic Calculation (20, 12, 3) ===
k_second = ta.sma(ta.stoch(close, high, low, 20), 12)
d_second = ta.sma(k_second, 3)
outK2 = request.security(syminfo.tickerid, res2, k_second)
outD2 = request.security(syminfo.tickerid, res2, d_second)

// === Cross Definitions ===
crossUp = (outK[1] < outD[1] and outK[1] < lowLine) and (outK > outD)
crossDn = (outK[1] > outD[1] and outK[1] > upLine) and (outK < outD)
crossUpAll = outK[1] < outD[1] and outK > outD
crossDownAll = outK[1] > outD[1] and outK < outD

// === Plots ===
// Main Stochastic
plot(outK, title="Stoch K", color=color.blue, linewidth=1)
plot(outD, title="Stoch D", color=color.red, linewidth=1)

// Optional 2nd Stoch
plot(ssStoch ? outK2 : na, title="2nd Stoch K", color=color.green, linewidth=1)
plot(ssStoch ? outD2 : na, title="2nd Stoch D", color=color.yellow, linewidth=1)

// Upper, Lower, Mid Lines
p1 = plot(upLine, title="Upper Line", color=color.black, linewidth=1)
p2 = plot(lowLine, title="Lower Line", color=color.black, linewidth=1)
plot(sml ? 50 : na, title="Mid Line", color=color.black, linewidth=1, style=plot.style_line)

// Buy/Sell Signals without letters
plotshape(sl and crossUp, title="Buy Signal Strict", style=shape.labelup, location=location.bottom, color=color.lime)
plotshape(sl and crossDn, title="Sell Signal Strict", style=shape.labeldown, location=location.top, color=color.red)
plotshape(sl and crossUpAll, title="Buy Signal Any Cross", style=shape.labelup, location=location.bottom, color=color.lime)
plotshape(sl and crossDownAll, title="Sell Signal Any Cross", style=shape.labeldown, location=location.top, color=color.red)

// Fill area between upper and lower lines
fill(p1, p2, color=color.silver, transp=70)
