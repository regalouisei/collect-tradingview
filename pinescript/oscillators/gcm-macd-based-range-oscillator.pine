//@version=6
indicator('GCM MACD based Range Oscillator', 'GCM MRO', overlay = false, precision = 2)

// ==========================================
// ─── INPUTS ───
// ==========================================

// ~~ Range Oscillator Inputs
grp_ro = 'Range Oscillator Settings'
length = input.int(50, minval = 1, title = 'Range Length', group = grp_ro)
mult   = input.float(2.0, minval = 0.1, title = 'Range Width Multiplier', group = grp_ro)

// ~~ MACD Inputs
grp_macd = 'MACD Settings'
fast_length = input.int(12, title = "Fast Length", group = grp_macd)
slow_length = input.int(26, title = "Slow Length", group = grp_macd)
src = input(close, title = "Source", group = grp_macd)
signal_length = input.int(9, title = "Signal Smoothing", minval = 1, maxval = 50, group = grp_macd)
sma_source = input.string("EMA", title = "Oscillator MA Type", options = ["SMA", "EMA"], group = grp_macd)
sma_signal = input.string("EMA", title = "Signal Line MA Type", options = ["SMA", "EMA"], group = grp_macd)

// ~~ Style Inputs
grp_style = 'Common Color Settings'
col_rise = input.color(#37ff0c, title = 'Rising (Highlighted Green)', group = grp_style)
col_fall = input.color(#ff0014, title = 'Falling (Highlighted Red)', group = grp_style)
fill_transp = input.int(60, "Fill Transparency", minval = 0, maxval = 100, group = grp_style)
marks_count = input.int(3, "High/Low Marks Count", minval = 0, group = grp_style, tooltip = "Number of recent bars to show the High/Low marks on. Historical marks are deleted.")

// ~~ Special Features Inputs
grp_special = 'Special Features'
use_barcolor = input.bool(true, "Color Main Chart Bars?", group = grp_special)
show_breakouts = input.bool(true, "Show JMA Signals?", group = grp_special, tooltip = "Shows a Star when the JMA changes slope/color")

// ~~ JMA Settings (Defaults: 14, 10, 2)
grp_jma = "JMA Settings (Breakout Logic)"
jma_len = input.int(14, "JMA Length", group = grp_jma)
jma_phase = input.int(10, "JMA Phase", group = grp_jma)
jma_power = input.float(2.0, "JMA Power", group = grp_jma)

// ==========================================
// ─── CALCULATION: MACD ───
// ==========================================

fast_ma = sma_source == "SMA" ? ta.sma(src, fast_length) : ta.ema(src, fast_length)
slow_ma = sma_source == "SMA" ? ta.sma(src, slow_length) : ta.ema(src, slow_length)
macd = fast_ma - slow_ma
signal = sma_signal == "SMA" ? ta.sma(macd, signal_length) : ta.ema(macd, signal_length)
hist = macd - signal

histColor = hist >= hist[1] ? col_rise : col_fall

// ==========================================
// ─── CALCULATION: RANGE OSCILLATOR ───
// ==========================================

atrRaw   = nz(ta.atr(2000), ta.atr(200))
rangeATR = atrRaw * mult

sumWeightedClose = 0.0
sumWeights = 0.0

for i = 0 to length - 1 by 1
    if bar_index > length
        delta = math.abs(close[i] - close[i + 1])
        w = delta / close[i + 1]
        sumWeightedClose := sumWeightedClose + close[i] * w
        sumWeights := sumWeights + w

ma = sumWeights != 0 ? sumWeightedClose / sumWeights : na

osc_raw = rangeATR != 0 ? 100 * (close - ma) / rangeATR : na
osc_raw_h = rangeATR != 0 ? 100 * (high - ma) / rangeATR : na
osc_raw_l = rangeATR != 0 ? 100 * (low - ma) / rangeATR : na

// ==========================================
// ─── FITTING / NORMALIZATION ───
// ==========================================

scaling_lookback = 100
max_hist_amp = ta.highest(math.abs(hist), scaling_lookback)
max_hist_amp := max_hist_amp == 0 ? 1 : max_hist_amp

osc_fitted = (osc_raw / 100.0) * max_hist_amp
osc_fitted_h = (osc_raw_h / 100.0) * max_hist_amp
osc_fitted_l = (osc_raw_l / 100.0) * max_hist_amp

is_rising = osc_fitted >= osc_fitted[1]
oscColor = is_rising ? col_rise : col_fall

// ==========================================
// ─── CALCULATION: JURIK MOVING AVERAGE (JMA) ───
// ==========================================

// JMA Math Implementation
var float e0 = 0.0
var float e1 = 0.0
var float e2 = 0.0
var float jma_val = 0.0

// Phase ratio calculation
phaseRatio = jma_phase < -100 ? 0.5 : jma_phase > 100 ? 2.5 : jma_phase / 100 + 1.5

// Alpha / Beta calculation
beta = 0.45 * (jma_len - 1) / (0.45 * (jma_len - 1) + 2)
alpha = math.pow(beta, jma_power)

// JMA Loop logic
if bar_index > 0
    e0 := (1 - alpha) * src + alpha * nz(e0[1])
    e1 := (src - e0) * (1 - beta) + beta * nz(e1[1])
    e2 := (e0 + phaseRatio * e1 - nz(jma_val[1])) * math.pow(1 - alpha, 2) + math.pow(alpha, 2) * nz(e2[1])
    jma_val := e2 + nz(jma_val[1])

// Determine JMA Slope/Color
jma_rising = jma_val > jma_val[1]

// Detect Change of Color Point (Slope Flip)
jma_flip_up = jma_rising and not jma_rising[1] // Turned Green
jma_flip_dn = not jma_rising and jma_rising[1] // Turned Red

// ==========================================
// ─── PLOTTING ───
// ==========================================

p_hist = plot(hist, title = "MACD Histogram Line", style = plot.style_line, color = histColor, linewidth = 2)
p_ro = plot(osc_fitted, 'Range Oscillator (Fitted)', color = oscColor, linewidth = 2)

// 3. RO High and Low Points (Marks)
// Strict Logic: Only show if bar_index is within the last 'marks_count' bars.
// Everything else is set to 'na', effectively deleting historical marks.
show_marks = bar_index > last_bar_index - marks_count

plot_h = show_marks ? osc_fitted_h : na
plot_l = show_marks ? osc_fitted_l : na

plotcandle(plot_h, plot_h, plot_h, plot_h, title = "RO High Mark", color = oscColor, bordercolor = oscColor, wickcolor = oscColor)
plotcandle(plot_l, plot_l, plot_l, plot_l, title = "RO Low Mark", color = oscColor, bordercolor = oscColor, wickcolor = oscColor)

fill(p_ro, p_hist, color = color.new(oscColor, fill_transp), title = "Fill RO to MACD")

// Horizontal Lines
h_upper = hline(0.75, "Upper Band", color = #4caf50, linestyle = hline.style_solid, linewidth = 1)
h_lower = hline(-0.75, "Lower Band", color = #f23645, linestyle = hline.style_solid, linewidth = 1)
hline(0, "Zero Line", color = #b8b8b8, linestyle = hline.style_dotted, linewidth = 1)
fill(h_upper, h_lower, color = color.new(color.yellow, 80), title = "Band Background Fill")

// ==========================================
// ─── SIGNALS & VISUALS ───
// ==========================================

// A. Bar Coloring (Based on Oscillator Slope)
barcolor(use_barcolor ? oscColor : na, title = "Main Chart Bar Color")

// B. Plot JMA Change of Color Signals
show_up = jma_flip_up and show_breakouts
show_dn = jma_flip_dn and show_breakouts

plotshape(show_up, title = "JMA Turns Bullish", style = shape.circle, location = location.top, color = col_rise, size = size.tiny, display = display.all)
plotshape(show_dn, title = "JMA Turns Bearish", style = shape.circle, location = location.bottom, color = col_fall, size = size.tiny, display = display.all)

// C. Alerts
alertcondition(is_rising != is_rising[1], title = "Oscillator Trend Flip", message = "GCM MRO: Oscillator Slope Changed")
alertcondition(show_up, title = "JMA Bullish Flip", message = "GCM MRO: JMA turned Green (Buy Signal)")
alertcondition(show_dn, title = "JMA Bearish Flip", message = "GCM MRO: JMA turned Red (Sell Signal)")
