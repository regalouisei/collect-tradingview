//@version=6
indicator("Super Oscillator", overlay=false, max_labels_count=500)

//====================================================
// Presets automáticos por instrumento
//====================================================
autoPreset  = input.bool(true, "Auto preset por instrumento", group="Presets")
showSignal  = input.bool(true, "Mostrar línea señal", group="Presets")
useRSI      = input.string("RSI", "Motor", options=["RSI","CCI"], group="Presets")

// Manual (solo si autoPreset = false)
rsiLen_m    = input.int(14, "RSI Len", minval=2, group="Manual")
cciLen_m    = input.int(20, "CCI Len", minval=2, group="Manual")
smoothLen_m = input.int(8,  "Suavizado (EMA)", minval=1, group="Manual")
sigLen_m    = input.int(5,  "Señal (EMA)", minval=1, group="Manual")
upper_m     = input.float(45,  "Zona alta (+)", step=0.5, group="Manual")
lower_m     = input.float(-45, "Zona baja (-)", step=0.5, group="Manual")
dead_m      = input.float(12,  "Zona muerta (+/-)", step=0.5, group="Manual")

// Detectar instrumento
tkr = str.upper(syminfo.ticker)
isNQ = str.contains(tkr, "NQ") or str.contains(tkr, "MNQ")
isYM = str.contains(tkr, "YM") or str.contains(tkr, "MYM")
isGC = str.contains(tkr, "GC") or str.contains(tkr, "MGC")

// Presets recomendados (1 minuto)
rsiLen_p    = isNQ ? 14 : isYM ? 14 : isGC ? 12 : 14
cciLen_p    = isNQ ? 20 : isYM ? 20 : isGC ? 18 : 20
smoothLen_p = isNQ ? 9  : isYM ? 8  : isGC ? 10 : 8
sigLen_p    = isNQ ? 6  : isYM ? 5  : isGC ? 7  : 5
upper_p     = isNQ ? 50 : isYM ? 45 : isGC ? 40 : 45
lower_p     = -upper_p
dead_p      = isNQ ? 14 : isYM ? 12 : isGC ? 10 : 12

// Aplicar auto o manual
rsiLen    = autoPreset ? rsiLen_p    : rsiLen_m
cciLen    = autoPreset ? cciLen_p    : cciLen_m
smoothLen = autoPreset ? smoothLen_p : smoothLen_m
sigLen    = autoPreset ? sigLen_p    : sigLen_m
upper     = autoPreset ? upper_p     : upper_m
lower     = autoPreset ? lower_p     : lower_m
dead      = autoPreset ? dead_p      : dead_m

//====================================================
// Núcleo del oscilador: centrado en 0
//====================================================
float core =
     useRSI == "RSI"
     ? (ta.rsi(close, rsiLen) - 50.0) * 2.0      // RSI 0..100 -> -100..+100
     : ta.cci(close, cciLen) / 2.0               // CCI típico +/-200 -> aprox +/-100

osc  = ta.ema(core, smoothLen)
sig  = ta.ema(osc, sigLen)

//====================================================
// Colores por zonas
//====================================================
inUpper = osc >= upper
inLower = osc <= lower
inDead  = math.abs(osc) <= dead

col =
     inUpper ? color.red :
     inLower ? color.lime :
     inDead  ? color.aqua :
     (osc > 0 ? color.new(color.red, 35) : color.new(color.lime, 35))

//====================================================
// Niveles (DINÁMICOS) - NO hline()
//====================================================
p0   = plot(0.0,   "0",          color=color.new(color.gray, 70), linewidth=1)
pUp  = plot(upper, "Upper",      color=color.new(color.red, 55),  linewidth=1)
pLo  = plot(lower, "Lower",      color=color.new(color.lime, 55), linewidth=1)

pD1  = plot(dead,  "+Dead",      color=color.new(color.aqua, 70), linewidth=1)
pD2  = plot(-dead, "-Dead",      color=color.new(color.aqua, 70), linewidth=1)
fill(pD1, pD2, color=color.new(color.aqua, 90), title="Dead zone")

//====================================================
// Plots del oscilador
//====================================================
plot(osc, "Osc", color=col, linewidth=2)
plot(showSignal ? sig : na, "Signal", color=color.new(color.white, 35), linewidth=1)

//====================================================
// Alertas útiles (scalping 1M)
//====================================================
// 1) Salida de sobreventa/sobrecompra (regreso al “medio”)
alertcondition(ta.crossover(osc, lower), "Sale de sobreventa", "Osc cruzó arriba de la zona baja")
alertcondition(ta.crossunder(osc, upper), "Sale de sobrecompra", "Osc cruzó abajo de la zona alta")

// 2) Cruce con la señal (momentum)
alertcondition(ta.crossover(osc, sig), "Cruce alcista (osc>sig)", "Osc cruzó arriba de Signal")
alertcondition(ta.crossunder(osc, sig), "Cruce bajista (osc<sig)", "Osc cruzó abajo de Signal")
