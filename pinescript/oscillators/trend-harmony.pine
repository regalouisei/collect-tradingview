// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
//@version=6
indicator("Trend Harmony", overlay = false)

//------- 1. Helper Functions -------
formatTF(tf) =>
    float minutes = str.tonumber(tf)
    string result = tf
    if not na(minutes)
        if minutes < 60
            result := str.tostring(minutes) + "m"
        else if minutes < 1440
            result := str.tostring(math.round(minutes / 60, 1)) + "H"
        else
            result := str.tostring(math.round(minutes / 1440, 1)) + "D"
    else
        switch tf
            "D" => "1D"
            "W" => "1W"
            "M" => "1M"
            => tf
    result

// Function to handle table row logic
add_row(tbl, row, tf, rsi, emaS, emaB, col, show) =>
    if show
        priceAboveFast = close > emaS
        priceAboveSlow = close > emaB
        isBullish      = emaS > emaB
        
        // Custom RSI Color Logic: 0-30 Green, 50-70 Green, else Red
        color rsiCol = (rsi >= 0 and rsi <= 30) or (rsi >= 50 and rsi <= 70) ? color.green : color.red
        
        table.cell(tbl, 0, row, formatTF(tf), text_color=col)
        table.cell(tbl, 1, row, str.tostring(math.round(rsi)), text_color=rsiCol) // Applied updated color here
        
        table.cell(tbl, 2, row, priceAboveFast ? "â–²" : "â–¼", text_color=(priceAboveFast ? color.green : color.red))
        table.cell(tbl, 3, row, priceAboveSlow ? "â–²" : "â–¼", text_color=(priceAboveSlow ? color.green : color.red))
        table.cell(tbl, 4, row, isBullish ? "Bullish" : "Bearish", text_color=(isBullish ? color.green : color.red))
        row + 1
    else
        row

//------- 2. Settings -------
rsiLen  = input.int(14, "RSI Length", group="Calculation Parameters")
ema1Len = input.int(20, "Fast EMA", group="Calculation Parameters")
ema2Len = input.int(50, "Slow EMA", group="Calculation Parameters")

tf1 = input.timeframe("15", "TF 1", inline="tf1"), show1 = input.bool(true, "", inline="tf1"), color1 = input.color(color.green, "", inline="tf1")
tf2 = input.timeframe("60", "TF 2", inline="tf2"), show2 = input.bool(true, "", inline="tf2"), color2 = input.color(color.blue,  "", inline="tf2")
tf3 = input.timeframe("240", "TF 3", inline="tf3"), show3 = input.bool(true, "", inline="tf3"), color3 = input.color(color.orange, "", inline="tf3")
tf4 = input.timeframe("D", "TF 4",  inline="tf4"), show4 = input.bool(true, "", inline="tf4"), color4 = input.color(color.red,    "", inline="tf4")

tableBg = input.color(color.new(#0d0d0e, 10), "Dashboard Bg")

//------- 3. Data Calculations -------
[r1, e1_S, e1_B] = request.security(syminfo.tickerid, tf1, [ta.rsi(close, rsiLen), ta.ema(close, ema1Len), ta.ema(close, ema2Len)])
[r2, e2_S, e2_B] = request.security(syminfo.tickerid, tf2, [ta.rsi(close, rsiLen), ta.ema(close, ema1Len), ta.ema(close, ema2Len)])
[r3, e3_S, e3_B] = request.security(syminfo.tickerid, tf3, [ta.rsi(close, rsiLen), ta.ema(close, ema1Len), ta.ema(close, ema2Len)])
[r4, e4_S, e4_B] = request.security(syminfo.tickerid, tf4, [ta.rsi(close, rsiLen), ta.ema(close, ema1Len), ta.ema(close, ema2Len)])

//------- 4. Plotting -------
plot(show1 ? r1 : na, color=color1, title="RSI TF1", linewidth=2)
plot(show2 ? r2 : na, color=color2, title="RSI TF2", linewidth=2)
plot(show3 ? r3 : na, color=color3, title="RSI TF3", linewidth=2)
plot(show4 ? r4 : na, color=color4, title="RSI TF4", linewidth=2)

// RSI Levels
h70 = hline(70, "Upper Band", color=color.new(#555761, 10), linestyle=hline.style_dashed)
h50 = hline(50, "Middle Line", color=color.new(#555761, 10), linestyle=hline.style_dashed) 
h30 = hline(30, "Lower Band", color=color.new(#555761, 10), linestyle=hline.style_dashed)
fill(h30, h70, color=color.new(#549dd8, 85), title="RSI Background")

//------- 5. Multi-TF Harmony Logic -------
trendScore = 0
trendScore += (show1 ? (e1_S > e1_B ? 1 : -1) : 0)
trendScore += (show2 ? (e2_S > e2_B ? 1 : -1) : 0)
trendScore += (show3 ? (e3_S > e3_B ? 1 : -1) : 0)
trendScore += (show4 ? (e4_S > e4_B ? 1 : -1) : 0)

activeCount = (show1 ? 1 : 0) + (show2 ? 1 : 0) + (show3 ? 1 : 0) + (show4 ? 1 : 0)

isOverbought = (show1 and r1 > 70) or (show2 and r2 > 70) or (show3 and r3 > 70) or (show4 and r4 > 70)
isOversold   = (show1 and r1 < 30) or (show2 and r2 < 30) or (show3 and r3 < 30) or (show4 and r4 < 30)

string summaryStatus = "Mixed / Neutral"
color  summaryCol    = color.rgb(54, 55, 56)

if trendScore == activeCount
    summaryStatus := isOverbought ? "âš ï¸ OVERBOUGHT BULL (CAUTION)" : "ğŸš€ FULL BULL HARMONY"
    summaryCol    := isOverbought ? color.orange : color.green
else if trendScore == -activeCount
    summaryStatus := isOversold ? "âš ï¸ OVERSOLD BEAR (CAUTION)" : "ğŸ“‰ FULL BEAR HARMONY"
    summaryCol    := isOversold ? color.orange : color.red

//------- 6. Table Display -------
var tbl = table.new(position.bottom_right, 5, 7, bgcolor=tableBg, border_width=1, border_color=color.rgb(58, 60, 68))

if barstate.islast
    table.clear(tbl, 0, 0, 4, 6)
    table.cell(tbl, 0, 0, "TF", text_color=color.white)
    table.cell(tbl, 1, 0, "RSI", text_color=color.white)
    table.cell(tbl, 2, 0, "EMA " + str.tostring(ema1Len), text_color=color.white)
    table.cell(tbl, 3, 0, "EMA " + str.tostring(ema2Len), text_color=color.white)
    table.cell(tbl, 4, 0, "EMA Trend", text_color=color.white)
    
    int r = 1
    r := add_row(tbl, r, tf1, r1, e1_S, e1_B, color1, show1)
    r := add_row(tbl, r, tf2, r2, e2_S, e2_B, color2, show2)
    r := add_row(tbl, r, tf3, r3, e3_S, e3_B, color3, show3)
    r := add_row(tbl, r, tf4, r4, e4_S, e4_B, color4, show4)
    
    table.cell(tbl, 0, r, "SUMMARY", text_color=color.white, text_size=size.small)
    table.cell(tbl, 1, r, summaryStatus, bgcolor=summaryCol, text_color=color.white, text_size=size.small)
    table.merge_cells(tbl, 1, r, 4, r)
