//@version=6
indicator("Supercharged MA Momentum Oscillator (v6,Secondary Levels)", overlay=false, max_labels_count=500)

// === Inputs ===
maLength        = input.int(20, "MA Length")
src             = input.source(close, "Source")
smooth          = input.int(5,  "Smoothing of Momentum")
atrLength       = input.int(14, "ATR Length for Threshold")
thresholdFactor = input.float(0.006, "Threshold Factor")

dotSize = size.tiny

// Secondary level inputs
upperLevel = input.float(0.02, "Upper Momentum Level")
lowerLevel = input.float(-0.02, "Lower Momentum Level")

// === Calculations ===
ma = ta.sma(src, maLength)
slope = ma - ma[1]
normSlope = slope / ma * 1000
mom = ta.ema(normSlope, smooth)
oppMom = -mom

atr = ta.atr(atrLength)
longLevel  = atr * thresholdFactor
shortLevel = -atr * thresholdFactor

// === Plots ===
plot(mom,        color=color.blue,   linewidth=2, title="Momentum")
plot(oppMom,     color=color.orange, linewidth=2, title="Opposite Momentum")
plot(longLevel,  color=color.new(color.green,50), linewidth=1, title="Long Threshold")
plot(shortLevel, color=color.new(color.red,50),   linewidth=1, title="Short Threshold")
plot(0,          color=color.gray, linewidth=1, title="Zero Line")

// Secondary levels plotted as series lines (with dashed style)
plot(upperLevel, title="Upper Level Line", color=color.yellow, linewidth=1, linestyle=plot.linestyle_dashed)
plot(lowerLevel, title="Lower Level Line", color=color.yellow, linewidth=1, linestyle=plot.linestyle_dashed)

// === Buy/Sell conditions ===
longCond  = mom >= longLevel  and mom >= upperLevel
shortCond = mom <= shortLevel and mom <= lowerLevel

var bool inLong  = false
var bool inShort = false

// Plot dots on momentum line
plotshape(series=longCond and not inLong ? mom : na, style=shape.circle, location=location.absolute, color=color.green, size=dotSize)
plotshape(series=shortCond and not inShort ? mom : na, style=shape.circle, location=location.absolute, color=color.red,   size=dotSize)

// Track current state
if longCond and not inLong
    inLong := true
    inShort := false
else if not longCond
    inLong := false

if shortCond and not inShort
    inShort := true
    inLong := false
else if not shortCond
    inShort := false
