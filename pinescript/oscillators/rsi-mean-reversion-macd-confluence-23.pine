//@version=6
indicator(title="RSI + Mean Reversion + MACD Confluence (2/3)", 
         shorttitle="RMM 2/3", 
         overlay=true, 
         max_labels_count=500,
         max_lines_count=500)

// ═══════════════════════════════════════════════════════════════
//  RSI + MEAN REVERSION + MACD CONFLUENCE INDICATOR
//  For: Stocks / Equities
//  Logic: Buy/Sell signals fire when AT LEAST 2 out of 3 align
// ═══════════════════════════════════════════════════════════════

// ── INPUTS ──────────────────────────────────────────────────────

// RSI Settings
rsi_group       = "RSI Settings"
rsi_length      = input.int(14,    title="RSI Length",           group=rsi_group, minval=2)
rsi_oversold    = input.int(35,    title="RSI Oversold Level",   group=rsi_group, minval=1,  maxval=49)
rsi_overbought  = input.int(65,    title="RSI Overbought Level", group=rsi_group, minval=51, maxval=99)
rsi_source      = input.source(close, title="RSI Source",        group=rsi_group)

// Mean Reversion Settings
mr_group        = "Mean Reversion Settings"
mr_length       = input.int(20,    title="Bollinger Band Length",     group=mr_group, minval=2)
mr_mult         = input.float(2.0, title="Bollinger Band Multiplier", group=mr_group, minval=0.1, step=0.1)

// MACD Settings
macd_group      = "MACD Settings"
macd_fast       = input.int(12,    title="MACD Fast Length",    group=macd_group, minval=1)
macd_slow       = input.int(26,    title="MACD Slow Length",    group=macd_group, minval=1)
macd_signal     = input.int(9,     title="MACD Signal Length",  group=macd_group, minval=1)

// Display Settings
disp_group      = "Display Settings"
show_bb         = input.bool(true,  title="Show Bollinger Bands",     group=disp_group)
show_signals    = input.bool(true,  title="Show Buy/Sell Labels",     group=disp_group)
show_bg         = input.bool(true,  title="Highlight Signal Bars",    group=disp_group)
show_dashboard  = input.bool(true,  title="Show Signal Dashboard",    group=disp_group)

// Alert Settings
alert_group     = "Alert Settings"
alert_buy       = input.bool(true,  title="Enable Buy Alerts",        group=alert_group)
alert_sell      = input.bool(true,  title="Enable Sell Alerts",       group=alert_group)


// ── RSI CALCULATION ─────────────────────────────────────────────

rsi_val = ta.rsi(rsi_source, rsi_length)

// RSI signal: bullish if oversold, bearish if overbought
rsi_bull = rsi_val <= rsi_oversold
rsi_bear = rsi_val >= rsi_overbought


// ── MEAN REVERSION (BOLLINGER BANDS) ───────────────────────────

bb_basis = ta.sma(close, mr_length)
bb_dev   = mr_mult * ta.stdev(close, mr_length)
bb_upper = bb_basis + bb_dev
bb_lower = bb_basis - bb_dev

// Mean reversion signal: bullish if price below lower band, bearish if above upper
mr_bull = close <= bb_lower
mr_bear = close >= bb_upper

// Bollinger Band plots
bb_basis_plot = plot(show_bb ? bb_basis : na, title="BB Basis", color=color.new(color.gray, 50), linewidth=1)
bb_upper_plot = plot(show_bb ? bb_upper : na, title="BB Upper", color=color.new(color.red,  40), linewidth=1)
bb_lower_plot = plot(show_bb ? bb_lower : na, title="BB Lower", color=color.new(color.teal, 40), linewidth=1)

fill(bb_upper_plot, bb_lower_plot, 
     color=color.new(color.blue, 93), 
     title="BB Fill")


// ── MACD CALCULATION ────────────────────────────────────────────

[macd_line, signal_line, hist_line] = ta.macd(close, macd_fast, macd_slow, macd_signal)

// MACD signal: bullish if MACD crosses above signal (momentum turning up)
//              bearish if MACD crosses below signal (momentum turning down)
macd_bull = ta.crossover(macd_line,  signal_line)
macd_bear = ta.crossunder(macd_line, signal_line)

// For confluence scoring, also track general direction
macd_bull_zone = macd_line > signal_line
macd_bear_zone = macd_line < signal_line


// ── CONFLUENCE SIGNALS ──────────────────────────────────────────

// RELAXED: At least 2 out of 3 must align (more frequent signals)
// Buy  = At least 2 of: RSI oversold, price at/below lower BB, MACD bullish crossover
// Sell = At least 2 of: RSI overbought, price at/above upper BB, MACD bearish crossover

buy_count  = (rsi_bull ? 1 : 0) + (mr_bull ? 1 : 0) + (macd_bull ? 1 : 0)
sell_count = (rsi_bear ? 1 : 0) + (mr_bear ? 1 : 0) + (macd_bear ? 1 : 0)

buy_signal  = buy_count >= 2
sell_signal = sell_count >= 2

// ── PARTIAL CONFLUENCE SCORE (for dashboard) ────────────────────
// Count how many conditions are bullish / bearish right now
bull_score = (rsi_bull ? 1 : 0) + (mr_bull ? 1 : 0) + (macd_bull_zone ? 1 : 0)
bear_score = (rsi_bear ? 1 : 0) + (mr_bear ? 1 : 0) + (macd_bear_zone ? 1 : 0)


// ── SIGNAL LABELS ───────────────────────────────────────────────

if show_signals and buy_signal
    // Build label text showing which 2 or 3 fired
    label_text = "▲ BUY (2/3+)\n"
    label_text := label_text + (rsi_bull ? "RSI " : "")
    label_text := label_text + (mr_bull ? "MR " : "")
    label_text := label_text + (macd_bull ? "MACD" : "")
    
    label.new(bar_index, low, 
              text=label_text, 
              style=label.style_label_up, 
              color=color.new(color.teal, 0),
              textcolor=color.white,
              size=size.normal,
              yloc=yloc.belowbar)

if show_signals and sell_signal
    // Build label text showing which 2 or 3 fired
    label_text = "▼ SELL (2/3+)\n"
    label_text := label_text + (rsi_bear ? "RSI " : "")
    label_text := label_text + (mr_bear ? "MR " : "")
    label_text := label_text + (macd_bear ? "MACD" : "")
    
    label.new(bar_index, high, 
              text=label_text, 
              style=label.style_label_down, 
              color=color.new(color.red, 0),
              textcolor=color.white,
              size=size.normal,
              yloc=yloc.abovebar)


// ── BAR HIGHLIGHT ───────────────────────────────────────────────

bar_color = 
     buy_signal  ? color.new(color.teal, 70) : 
     sell_signal ? color.new(color.red,  70) : 
     na

bgcolor(show_bg ? bar_color : na, title="Signal Bar Highlight")


// ── DASHBOARD TABLE ─────────────────────────────────────────────

if show_dashboard and barstate.islast
    var table dash = table.new(
         position.top_right, 
         columns=2, rows=8, 
         bgcolor=color.new(color.black, 20),
         border_color=color.new(color.gray, 60),
         border_width=1,
         frame_color=color.new(color.gray, 40),
         frame_width=1)

    // Header
    table.cell(dash, 0, 0, "INDICATOR",  
               text_color=color.new(color.white, 20), 
               text_size=size.small,
               bgcolor=color.new(color.navy, 20))
    table.cell(dash, 1, 0, "STATUS",     
               text_color=color.new(color.white, 20), 
               text_size=size.small,
               bgcolor=color.new(color.navy, 20))

    // RSI Row
    rsi_status = rsi_bull ? "OVERSOLD ▲" : rsi_bear ? "OVERBOUGHT ▼" : "NEUTRAL —"
    rsi_col    = rsi_bull ? color.teal    : rsi_bear ? color.red       : color.gray
    table.cell(dash, 0, 1, "RSI (" + str.tostring(rsi_length) + ")",
               text_color=color.white, text_size=size.small)
    table.cell(dash, 1, 1, rsi_status + "  " + str.tostring(math.round(rsi_val, 1)),
               text_color=rsi_col, text_size=size.small)

    // Mean Reversion Row
    mr_status = mr_bull ? "BELOW BAND ▲" : mr_bear ? "ABOVE BAND ▼" : "INSIDE BAND —"
    mr_col    = mr_bull ? color.teal      : mr_bear ? color.red       : color.gray
    table.cell(dash, 0, 2, "Mean Rev (" + str.tostring(mr_length) + ")",
               text_color=color.white, text_size=size.small)
    table.cell(dash, 1, 2, mr_status,
               text_color=mr_col, text_size=size.small)

    // MACD Row
    macd_status = macd_bull ? "CROSS UP ▲" : macd_bear ? "CROSS DOWN ▼" : macd_bull_zone ? "ABOVE SIG —" : "BELOW SIG —"
    macd_col    = macd_bull ? color.teal   : macd_bear ? color.red        : macd_bull_zone ? color.new(color.teal, 40) : color.new(color.red, 40)
    table.cell(dash, 0, 3, "MACD (" + str.tostring(macd_fast) + "/" + str.tostring(macd_slow) + "/" + str.tostring(macd_signal) + ")",
               text_color=color.white, text_size=size.small)
    table.cell(dash, 1, 3, macd_status,
               text_color=macd_col, text_size=size.small)

    // Divider row
    table.cell(dash, 0, 4, "─────────────", text_color=color.new(color.gray, 50), text_size=size.tiny)
    table.cell(dash, 1, 4, "─────────────", text_color=color.new(color.gray, 50), text_size=size.tiny)

    // Bull Score
    bull_bar = bull_score == 3 ? "███ 3/3" : bull_score == 2 ? "██░ 2/3" : bull_score == 1 ? "█░░ 1/3" : "░░░ 0/3"
    table.cell(dash, 0, 5, "BULL SCORE",
               text_color=color.white, text_size=size.small)
    table.cell(dash, 1, 5, bull_bar,
               text_color=bull_score == 3 ? color.teal : color.new(color.teal, 50), text_size=size.small)

    // Bear Score
    bear_bar = bear_score == 3 ? "███ 3/3" : bear_score == 2 ? "██░ 2/3" : bear_score == 1 ? "█░░ 1/3" : "░░░ 0/3"
    table.cell(dash, 0, 6, "BEAR SCORE",
               text_color=color.white, text_size=size.small)
    table.cell(dash, 1, 6, bear_bar,
               text_color=bear_score == 3 ? color.red : color.new(color.red, 50), text_size=size.small)

    // Confluence Signal
    signal_text  = buy_signal ? "◆ BUY SIGNAL" : sell_signal ? "◆ SELL SIGNAL" : "  No Signal"
    signal_color = buy_signal ? color.teal       : sell_signal ? color.red        : color.gray
    table.cell(dash, 0, 7, "CONFLUENCE",
               text_color=color.white, text_size=size.small,
               bgcolor=color.new(color.black, 40))
    table.cell(dash, 1, 7, signal_text,
               text_color=signal_color, text_size=size.small,
               bgcolor=color.new(color.black, 40))


// ── SIGNAL PLOT (required for v6) ──────────────────────────────

// Plot signal state: 1 = buy signal, -1 = sell signal, 0 = no signal
signal_state = buy_signal ? 1 : sell_signal ? -1 : 0
plot(signal_state, title="Signal State", display=display.none)


// ── ALERTS ──────────────────────────────────────────────────────

if alert_buy and buy_signal
    alert("RMM BUY SIGNAL — RSI + Mean Reversion + MACD all aligned BULLISH on " + syminfo.ticker, 
          alert.freq_once_per_bar_close)

if alert_sell and sell_signal
    alert("RMM SELL SIGNAL — RSI + Mean Reversion + MACD all aligned BEARISH on " + syminfo.ticker, 
          alert.freq_once_per_bar_close)
