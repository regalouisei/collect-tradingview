//@version=5
indicator("BTC Perps USD Liquidity Regime v2 (Optimized)", overlay=false)

// USD liquidity regime for BTCUSDT perpetual futures traders
// OPTIMIZED: Removed UUP redundancy, rebalanced weights, faster responsiveness
// Blue index + red EMA from DXY/yields/VIX composite (daily)
// Green background/histogram = Risk-On (weak USD = long tailwind)
// Red = Risk-Off (strong USD = caution longs)
// Educational tool — regime bias only
// by @frank_vergaram

smoothPeriod = input.int(14, "Smoothing (EMA)", minval=1)
normPeriod = input.int(100, "Normalization Period", minval=50, maxval=300)

// Daily composite (yields require daily)
dxy = request.security("TVC:DXY", "D", close)
vix = request.security("CBOE:VIX", "D", close)
us10 = request.security("FRED:DGS10", "D", close)

// Faster normalization (100 bars vs 200)
normalize(src, period) => 
    h = ta.highest(src, period)
    l = ta.lowest(src, period)
    h == l ? 0.5 : (src - l) / (h - l)

// Optimized weights: DXY 40%, US10Y 30%, VIX 30%
// Removed UUP (redundant with DXY), increased VIX weight (crypto is pure risk)
index = (normalize(dxy, normPeriod) * 0.4) + (normalize(us10, normPeriod) * 0.3) + (normalize(vix, normPeriod) * 0.3)
smooth = ta.ema(index, smoothPeriod)  // EMA instead of SMA for faster response

risk_on = index < smooth  // Lower index = weaker USD = Risk-On

// Plots
plot(index, color=color.new(color.blue, 0), title="USD Liquidity Index", linewidth=3)
plot(smooth, color=color.new(color.red, 0), title="Trend (SMA)", linewidth=2)

// Histogram for strength
hist = index - smooth
plot(hist, color=risk_on ? color.green : color.red, style=plot.style_histogram, linewidth=4, title="Regime Strength")

// Background
bgcolor(risk_on ? color.new(color.green, 85) : color.new(color.red, 85))

// Table — enhanced with component breakdown
var table t = table.new(position.bottom_right, 2, 8, bgcolor=color.new(color.black, 80), border_width=1)

if barstate.islast
    table.cell(t, 0, 0, "BTC Perps Liquidity v2 (Optimized)", text_color=color.white, bgcolor=color.new(color.blue, 50))
    table.cell(t, 1, 0, "Context", text_color=color.white, bgcolor=color.new(color.blue, 50))
    
    table.cell(t, 0, 1, "Current Regime", text_color=risk_on ? color.green : color.red)
    regimeStrength = math.abs(hist) * 100
    table.cell(t, 1, 1, risk_on ? "Risk-On (long tailwind)" : "Risk-Off (caution longs)", text_color=risk_on ? color.green : color.red)
    
    table.cell(t, 0, 2, "Regime Strength", text_color=color.white)
    table.cell(t, 1, 2, str.tostring(regimeStrength, "#.##") + "%", text_color=regimeStrength > 5 ? color.orange : color.white)
    
    table.cell(t, 0, 3, "Index Value", text_color=color.blue)
    table.cell(t, 1, 3, str.tostring(index, "#.###") + " vs " + str.tostring(smooth, "#.###"), text_color=color.blue)
    
    table.cell(t, 0, 4, "Components", text_color=color.white)
    table.cell(t, 1, 4, "DXY 40% | US10Y 30% | VIX 30%", text_color=color.orange)
    
    table.cell(t, 0, 5, "Optimization", text_color=color.white)
    table.cell(t, 1, 5, "EMA" + str.tostring(smoothPeriod) + " | Norm" + str.tostring(normPeriod), text_color=color.gray)
    
    table.cell(t, 0, 6, "Green Rule", text_color=color.green)
    table.cell(t, 1, 6, "Favor longs / Use as entry filter", text_color=color.green)
    
    table.cell(t, 0, 7, "Red Rule", text_color=color.red)
    table.cell(t, 1, 7, "Caution longs / Short bias OK", text_color=color.red)

// Alerts on regime cross
alertcondition(ta.cross(index, smooth), title="Regime Shift", message="USD Liquidity Regime shift — check chart for new bias")
