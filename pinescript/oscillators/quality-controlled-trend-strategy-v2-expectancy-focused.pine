//@version=6
strategy(
    "Quality-Controlled Trend Strategy v2 (Expectancy Focused)",
    overlay = true,
    initial_capital = 10000,
    commission_type = strategy.commission.percent,
    commission_value = 0.04
)


// ───────── Inputs
fastEmaLen = input.int(50,  "Fast EMA")
slowEmaLen = input.int(200, "Slow EMA")
rsiLen     = input.int(14,  "RSI Length")
atrLen     = input.int(14,  "ATR Length")
rr         = input.float(2.5, "Risk : Reward", step = 0.1)
cooldown   = input.int(10, "Bars Between Trades")


// ───────── Indicators (computed once)
emaFast = ta.ema(close, fastEmaLen)
emaSlow = ta.ema(close, slowEmaLen)
rsiVal  = ta.rsi(close, rsiLen)
atrVal  = ta.atr(atrLen)


// ───────── Trend Strength Filter
emaSlope = emaFast - emaFast[5]


bullTrend = emaFast > emaSlow and emaSlope > 0
bearTrend = emaFast < emaSlow and emaSlope < 0


// ───────── Volatility Filter (avoid dead markets)
volOk = atrVal > ta.sma(atrVal, 20)


// ───────── Pullback Logic
longPullback  = bullTrend and low <= emaFast and close > emaFast
shortPullback = bearTrend and high >= emaFast and close < emaFast


// ───────── Momentum Filter
longMomentum  = rsiVal > 50 and rsiVal < 65
shortMomentum = rsiVal < 50 and rsiVal > 35


// ───────── Trade Cooldown
var int lastTradeBar = na
canTrade = na(lastTradeBar) or bar_index - lastTradeBar > cooldown


// ───────── Final Signals (non-repainting)
longSignal  = barstate.isconfirmed and volOk and canTrade and longPullback and longMomentum
shortSignal = barstate.isconfirmed and volOk and canTrade and shortPullback and shortMomentum


// ───────── Entries
if longSignal and strategy.position_size == 0
    strategy.entry("Long", strategy.long)
    lastTradeBar := bar_index


if shortSignal and strategy.position_size == 0
    strategy.entry("Short", strategy.short)
    lastTradeBar := bar_index


// ───────── Risk Management (structure-aware)
longStop  = emaFast - atrVal * 1.2
longLimit = close + atrVal * rr


shortStop  = emaFast + atrVal * 1.2
shortLimit = close - atrVal * rr


strategy.exit("Long Exit",  from_entry="Long",  stop=longStop,  limit=longLimit)
strategy.exit("Short Exit", from_entry="Short", stop=shortStop, limit=shortLimit)


// ───────── Visuals
plot(emaFast, title="EMA 50", color=color.orange)
plot(emaSlow, title="EMA 200", color=color.blue)
