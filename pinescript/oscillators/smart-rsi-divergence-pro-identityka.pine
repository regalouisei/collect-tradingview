//@version=5
indicator("Smart RSI Divergence Pro [identityKa]", overlay=false, max_lines_count=100, max_labels_count=100)

// ==========================================
// 1. USER INPUTS (GLOBAL ENGLISH)
// ==========================================
grp1 = "âš™ï¸ Pro Divergence Engine"
rsi_len = input.int(14, "RSI Length", group=grp1)
lbR = input.int(5, "Pivot Lookback Right", minval=1, group=grp1, tooltip="Bars to confirm a pivot after it happens.")
lbL = input.int(5, "Pivot Lookback Left", minval=1, group=grp1, tooltip="Bars required before a pivot point.")
filter_ob_os = input.bool(true, "Filter: Only Show OB/OS Divergences", group=grp1, tooltip="Only shows divergences that occur within Overbought (>70) or Oversold (<30) zones for higher quality signals.")
show_main_signals = input.bool(true, "Show Signals on Main Chart", group=grp1, tooltip="Displays BUY/SELL labels on price candles in addition to the sub-window lines.")

grp2 = "ðŸŽ¨ identityKa Visual Theme"
col_bull = input.color(#00ffbb, "Bullish Div (Neon Green)", group=grp2)
col_bear = input.color(#ff1744, "Bearish Div (Neon Red)", group=grp2)
col_rsi = input.color(color.gray, "RSI Base Color", group=grp2)

// ==========================================
// 2. RSI CALCULATION & SUB-WINDOW VISUALS
// ==========================================
rsi = ta.rsi(close, rsi_len)
rsi_color = rsi > 70 ? col_bear : rsi < 30 ? col_bull : col_rsi

// Anti-Scale Bug Plots
plot(rsi, "RSI Wave", color=rsi_color, linewidth=2)
ob_line = plot(70, "OB Level", color=color.new(col_bear, 50), style=plot.style_circles)
os_line = plot(30, "OS Level", color=color.new(col_bull, 50), style=plot.style_circles)
fill(ob_line, plot(100, display=display.none), color=color.new(col_bear, 90), title="OB Zone")
fill(os_line, plot(0, display=display.none), color=color.new(col_bull, 90), title="OS Zone")

// ==========================================
// 3. DIVERGENCE LOGIC ENGINE
// ==========================================
plFound = not na(ta.pivotlow(rsi, lbL, lbR))
phFound = not na(ta.pivothigh(rsi, lbL, lbR))

var line[] rsi_lines = array.new_line()
var label[] rsi_labels = array.new_label()

// Triggers for main chart signals
bool fire_bull = false
bool fire_bear = false

// --- BULLISH DIVERGENCE ---
if plFound
    prev_pl_bar = bar_index[lbR]
    prev_pl_rsi = rsi[lbR]
    prev_pl_price = low[lbR]
    for i = 1 to 50
        if not na(ta.pivotlow(rsi, lbL, lbR)[i])
            old_pl_bar = bar_index[lbR + i]
            old_pl_rsi = rsi[lbR + i]
            old_pl_price = low[lbR + i]
            bool is_bull = old_pl_price > prev_pl_price and old_pl_rsi < prev_pl_rsi
            bool filter_pass = not filter_ob_os or (prev_pl_rsi < 30 and old_pl_rsi < 30)

            if is_bull and filter_pass
                // Sub-window drawings
                l = line.new(old_pl_bar, old_pl_rsi, prev_pl_bar, prev_pl_rsi, color=col_bull, width=2, style=line.style_dotted)
                lbl = label.new(prev_pl_bar, prev_pl_rsi, "BULL", color=color.new(col_bull, 85), textcolor=col_bull, style=label.style_label_up, size=size.small)
                array.push(rsi_lines, l)
                array.push(rsi_labels, lbl)
                // Trigger main signal
                fire_bull := true
                alert("identityKa: Bullish Divergence Detected!", alert.freq_once_per_bar)
            break

// --- BEARISH DIVERGENCE ---
if phFound
    prev_ph_bar = bar_index[lbR]
    prev_ph_rsi = rsi[lbR]
    prev_ph_price = high[lbR]
    for i = 1 to 50
        if not na(ta.pivothigh(rsi, lbL, lbR)[i])
            old_ph_bar = bar_index[lbR + i]
            old_ph_rsi = rsi[lbR + i]
            old_ph_price = high[lbR + i]
            bool is_bear = old_ph_price < prev_ph_price and old_ph_rsi > prev_ph_rsi
            bool filter_pass = not filter_ob_os or (prev_ph_rsi > 70 and old_ph_rsi > 70)

            if is_bear and filter_pass
                // Sub-window drawings
                l = line.new(old_ph_bar, old_ph_rsi, prev_ph_bar, prev_ph_rsi, color=col_bear, width=2, style=line.style_dotted)
                lbl = label.new(prev_ph_bar, prev_ph_rsi, "BEAR", color=color.new(col_bear, 85), textcolor=col_bear, style=label.style_label_down, size=size.small)
                array.push(rsi_lines, l)
                array.push(rsi_labels, lbl)
                // Trigger main signal
                fire_bear := true
                alert("identityKa: Bearish Divergence Detected!", alert.freq_once_per_bar)
            break

// Cleanup
max_divs_shown = 10
if array.size(rsi_lines) > max_divs_shown
    line.delete(array.shift(rsi_lines))
    label.delete(array.shift(rsi_labels))

// ==========================================
// 4. MAIN CHART SIGNAL LABELS (HYBRID MODE)
// ==========================================
// This securely plots labels on the main chart price bars without breaking the sub-window scale.
plotshape(show_main_signals and fire_bull ? low : na, title="Main Chart Bull Label", style=shape.labelup, location=location.belowbar, color=col_bull, textcolor=color.black, text="BUY\nDIV", size=size.tiny)
plotshape(show_main_signals and fire_bear ? high : na, title="Main Chart Bear Label", style=shape.labeldown, location=location.abovebar, color=col_bear, textcolor=color.white, text="SELL\nDIV", size=size.tiny)
