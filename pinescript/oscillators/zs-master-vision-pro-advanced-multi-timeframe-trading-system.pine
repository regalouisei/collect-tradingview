//@version=5

// @description ZS Master Vision Pro - Advanced Multi-Timeframe Trading System
// @author Zakaria Safri
// @version 2.0

indicator(
     title = "ZS Master Vision Pro - Advanced Multi-Timeframe Trading System",
     shorttitle = "ZS Vision Pro âš¡",
     overlay = true,
     max_bars_back = 5000,
     max_lines_count = 500,
     max_labels_count = 500
 )

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Color themes
var color COLOR_THEME_PRO_BUY          = #00ff88
var color COLOR_THEME_PRO_SELL         = #ff1744
var color COLOR_THEME_PRO_STRONG_BUY   = #00e676
var color COLOR_THEME_PRO_STRONG_SELL  = #d50000

var color COLOR_THEME_CLASSIC_BUY          = #26a69a
var color COLOR_THEME_CLASSIC_SELL         = #ef5350
var color COLOR_THEME_CLASSIC_STRONG_BUY   = #00897b
var color COLOR_THEME_CLASSIC_STRONG_SELL  = #c62828

var color COLOR_THEME_CYBER_BUY          = #00ffff
var color COLOR_THEME_CYBER_SELL         = #ff00ff
var color COLOR_THEME_CYBER_STRONG_BUY   = #00d4ff
var color COLOR_THEME_CYBER_STRONG_SELL  = #d400ff

var color COLOR_THEME_OCEAN_BUY          = #00b8d4
var color COLOR_THEME_OCEAN_SELL         = #ff6e40
var color COLOR_THEME_OCEAN_STRONG_BUY   = #0091ea
var color COLOR_THEME_OCEAN_STRONG_SELL  = #ff3d00

var color COLOR_THEME_SUNSET_BUY          = #ffd740
var color COLOR_THEME_SUNSET_SELL         = #ff5722
var color COLOR_THEME_SUNSET_STRONG_BUY   = #ffc400
var color COLOR_THEME_SUNSET_STRONG_SELL  = #e64a19

// Signal type constants
var string SIGNAL_TYPE_BUY    = "B"
var string SIGNAL_TYPE_SELL   = "S"
var string SIGNAL_TYPE_NONE   = "N"

// Magic numbers
int   STRONG_SIGNAL_LOOKBACK  = 5
float STRONG_ZONE_DIVISOR     = 8.0
int   WT_SMOOTH_PERIOD        = 4
float WT_CHANNEL_MULTIPLIER   = 0.015
int   HA_OSC_LENGTH           = 8

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Core Algorithm â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var GRP_CORE = "ğŸ¯ Core Algorithm"
i_source            = input(close, "Source", group = GRP_CORE)
i_trendPeriod       = input.int(180, "Trend Period", minval = 1, group = GRP_CORE,
     tooltip = "Period for highest/lowest calculation. Higher = longer term trends")
i_atrPeriod         = input.int(155, "ATR Period", minval = 1, group = GRP_CORE)
i_atrMultiplier     = input.float(2.1, "ATR Multiplier", step = 0.1, minval = 0.1, group = GRP_CORE,
     tooltip = "Sensitivity multiplier. Higher = less signals but stronger")
i_signalMode        = input.string("Type A", "Signal Mode", options = ["Type A", "Type B"], group = GRP_CORE,
     tooltip = "Type A: Directional crossover/under | Type B: Any cross")
i_useSrcSmoothing   = input.bool(false, "Smooth Source with EMA", group = GRP_CORE)
i_srcSmoothPeriod   = input.int(3, "Source Smoothing Period", minval = 1, group = GRP_CORE)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Visual Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var GRP_VISUAL = "ğŸ¨ Visual Settings"
i_colorBars         = input.bool(true, "Color Bars", group = GRP_VISUAL)
i_showBackground    = input.bool(true, "Show Trend Background", group = GRP_VISUAL)
i_bgTransparency    = input.int(95, "Background Transparency", minval = 0, maxval = 100, group = GRP_VISUAL)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Signal System â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var GRP_SIGNALS = "âš¡ Signal System"
i_signalsView       = input.string("All", "Signals Display",
     options = ["All", "Buy/Sell", "Strong", "None"], group = GRP_SIGNALS)
i_signalShape       = input.string("Labels", "Signal Shape",
     options = ["Labels", "Arrows", "Triangles"], group = GRP_SIGNALS)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Color Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var GRP_COLORS = "ğŸ¨ Color Scheme"
i_colorTheme        = input.string("Pro", "Color Theme",
     options = ["Pro", "Classic", "Cyberpunk", "Ocean", "Sunset"], group = GRP_COLORS)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Moving Averages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var GRP_MA = "ğŸ“ˆ Moving Averages"
i_showClouds        = input.bool(true, "Show EMA Clouds", group = GRP_MA)
i_maType            = input.string("EMA", "MA Type", options = ["EMA", "SMA"], group = GRP_MA)
i_showLines         = input.bool(false, "Show MA Lines", group = GRP_MA)
i_cloudOffset       = input.int(0, "Cloud Offset", minval = 0, group = GRP_MA)

i_cloud1Fast        = input.int(5, "Cloud 1 - Fast", group = GRP_MA, inline = "c1")
i_cloud1Slow        = input.int(13, "Slow", group = GRP_MA, inline = "c1")
i_showCloud1        = input.bool(true, "Show", group = GRP_MA, inline = "c1")

i_cloud2Fast        = input.int(21, "Cloud 2 - Fast", group = GRP_MA, inline = "c2")
i_cloud2Slow        = input.int(55, "Slow", group = GRP_MA, inline = "c2")
i_showCloud2        = input.bool(true, "Show", group = GRP_MA, inline = "c2")

i_cloud3Fast        = input.int(89, "Cloud 3 - Fast", group = GRP_MA, inline = "c3")
i_cloud3Slow        = input.int(144, "Slow", group = GRP_MA, inline = "c3")
i_showCloud3        = input.bool(false, "Show", group = GRP_MA, inline = "c3")

i_cloud4Fast        = input.int(7, "Cloud 4 - Fast", group = GRP_MA, inline = "c4")
i_cloud4Slow        = input.int(21, "Slow", group = GRP_MA, inline = "c4")
i_showCloud4        = input.bool(true, "Show", group = GRP_MA, inline = "c4")

i_cloud5Fast        = input.int(50, "Cloud 5 - Fast", group = GRP_MA, inline = "c5")
i_cloud5Slow        = input.int(200, "Slow", group = GRP_MA, inline = "c5")
i_showCloud5        = input.bool(true, "Show", group = GRP_MA, inline = "c5")

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Support & Resistance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var GRP_SR = "ğŸ“ Support & Resistance"
i_showSR            = input.bool(true, "Show S/R Levels", group = GRP_SR)
i_pivotLeft         = input.int(15, "Pivot Left Bars", minval = 1, group = GRP_SR, inline = "pivot")
i_pivotRight        = input.int(15, "Right Bars", minval = 1, group = GRP_SR, inline = "pivot")

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Wave Trend Oscillator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var GRP_WT = "ğŸŒŠ Wave Trend Oscillator"
i_showOscInfo       = input.bool(true, "Show Oscillator Info", group = GRP_WT)
i_wtChannelLen      = input.int(10, "Channel Length", minval = 1, group = GRP_WT, inline = "wt")
i_wtAvgLen          = input.int(21, "Average Length", minval = 1, group = GRP_WT, inline = "wt")
i_wtReaction        = input.int(2, "Direction Reaction", minval = 1, group = GRP_WT,
     tooltip = "Bars required to confirm direction change")

i_obExtreme         = input.int(65, "Extreme Overbought", group = GRP_WT, inline = "ob")
i_obLevel           = input.int(53, "Overbought", group = GRP_WT, inline = "ob")
i_osLevel           = input.int(-53, "Oversold", group = GRP_WT, inline = "os")
i_osExtreme         = input.int(-65, "Extreme Oversold", group = GRP_WT, inline = "os")

i_smartBuyOnly      = input.bool(true, "Only Smart Buy Reversals", group = GRP_WT)
i_smartSellOnly     = input.bool(true, "Only Smart Sell Reversals", group = GRP_WT)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Divergence Scanner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var GRP_DIV = "ğŸ” Divergence Scanner"
i_showDivergence    = input.bool(true, "Enable Divergence Detection", group = GRP_DIV)
i_divRegBull        = input.bool(true, "Regular Bullish", group = GRP_DIV, inline = "div1")
i_divRegBear        = input.bool(true, "Regular Bearish", group = GRP_DIV, inline = "div1")
i_divHidBull        = input.bool(true, "Hidden Bullish", group = GRP_DIV, inline = "div2")
i_divHidBear        = input.bool(true, "Hidden Bearish", group = GRP_DIV, inline = "div2")
i_divLabels         = input.bool(true, "Show Labels", group = GRP_DIV)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Market Bias â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var GRP_HA = "ğŸ“Š Market Bias (Heikin Ashi)"
i_showMarketBias    = input.bool(true, "Show Market Bias", group = GRP_HA)
i_haPeriod          = input.int(7, "Period", minval = 1, group = GRP_HA, inline = "ha")
i_haSmoothing       = input.int(10, "Smoothing", minval = 1, group = GRP_HA, inline = "ha")

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Momentum â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var GRP_MOM = "âš¡ Momentum System"
i_showMomentum      = input.bool(true, "Show Momentum Info", group = GRP_MOM)
i_momPeriod         = input.int(50, "Period", minval = 1, group = GRP_MOM, inline = "mom")
i_momResponse       = input.float(0.9, "Responsiveness", minval = 0.0, maxval = 1.0, group = GRP_MOM, inline = "mom")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// @function Get theme colors based on selection
// @returns [buy, sell, strongBuy, strongSell]
f_getThemeColors() =>
    var color buy = na
    var color sell = na
    var color strongBuy = na
    var color strongSell = na
    
    switch i_colorTheme
        "Pro" =>
            [COLOR_THEME_PRO_BUY, COLOR_THEME_PRO_SELL, COLOR_THEME_PRO_STRONG_BUY, COLOR_THEME_PRO_STRONG_SELL]
        "Classic" =>
            [COLOR_THEME_CLASSIC_BUY, COLOR_THEME_CLASSIC_SELL, COLOR_THEME_CLASSIC_STRONG_BUY, COLOR_THEME_CLASSIC_STRONG_SELL]
        "Cyberpunk" =>
            [COLOR_THEME_CYBER_BUY, COLOR_THEME_CYBER_SELL, COLOR_THEME_CYBER_STRONG_BUY, COLOR_THEME_CYBER_STRONG_SELL]
        "Ocean" =>
            [COLOR_THEME_OCEAN_BUY, COLOR_THEME_OCEAN_SELL, COLOR_THEME_OCEAN_STRONG_BUY, COLOR_THEME_OCEAN_STRONG_SELL]
        "Sunset" =>
            [COLOR_THEME_SUNSET_BUY, COLOR_THEME_SUNSET_SELL, COLOR_THEME_SUNSET_STRONG_BUY, COLOR_THEME_SUNSET_STRONG_SELL]
        =>
            [COLOR_THEME_PRO_BUY, COLOR_THEME_PRO_SELL, COLOR_THEME_PRO_STRONG_BUY, COLOR_THEME_PRO_STRONG_SELL]

// @function Calculate moving average
// @param src Source series
// @param len Length
// @returns MA value
f_ma(float src, int len) =>
    i_maType == "EMA" ? ta.ema(src, len) : ta.sma(src, len)

// @function Check if top fractal exists
// @param src Source series
// @returns bool
f_isTopFractal(float src) =>
    src[4] < src[2] and src[3] < src[2] and src[2] > src[1] and src[2] > src[0]

// @function Check if bottom fractal exists
// @param src Source series
// @returns bool
f_isBottomFractal(float src) =>
    src[4] > src[2] and src[3] > src[2] and src[2] < src[1] and src[2] < src[0]

// @function Detect fractal type
// @param src Source series
// @returns 1 for top, -1 for bottom, 0 for none
f_fractalize(float src) =>
    f_isTopFractal(src) ? 1 : f_isBottomFractal(src) ? -1 : 0

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VARIABLES INITIALIZATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var string g_lastSignal = SIGNAL_TYPE_NONE
var float  g_trendLine = na
var float  g_wormValue = na
var table  g_infoTable = na

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALCULATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Theme Colors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[buyColor, sellColor, strongBuyColor, strongSellColor] = f_getThemeColors()

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Source Processing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
sourceProcessed = i_useSrcSmoothing ? ta.ema(i_source, i_srcSmoothPeriod) : i_source

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Core Algorithm â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
highestHigh = ta.highest(sourceProcessed, i_trendPeriod)
lowestLow = ta.lowest(sourceProcessed, i_trendPeriod)
priceRange = highestHigh - lowestLow

// Initialize trend line
g_trendLine := bar_index <= i_trendPeriod ? (highestHigh + lowestLow) / 2 : g_trendLine[1]

// ATR and epsilon
atrValue = ta.atr(i_atrPeriod)[1]
epsilon = i_atrMultiplier * atrValue

// Signal detection
isChangeUp = i_signalMode == "Type B" ? 
     ta.cross(sourceProcessed, g_trendLine + epsilon) : 
     ta.crossover(sourceProcessed, g_trendLine + epsilon) or sourceProcessed > g_trendLine + epsilon

isChangeDown = i_signalMode == "Type B" ? 
     ta.cross(sourceProcessed, g_trendLine - epsilon) : 
     ta.crossunder(sourceProcessed, g_trendLine - epsilon) or sourceProcessed < g_trendLine - epsilon

// Strong zone detection
isInStrongBuyZone = open < lowestLow + priceRange / STRONG_ZONE_DIVISOR and open >= lowestLow
isInStrongSellZone = open > highestHigh - priceRange / STRONG_ZONE_DIVISOR and open <= highestHigh

isStrongBuy = isInStrongBuyZone
for i = 1 to STRONG_SIGNAL_LOOKBACK - 1
    isStrongBuy := isStrongBuy or isInStrongBuyZone[i]

isStrongSell = isInStrongSellZone
for i = 1 to STRONG_SIGNAL_LOOKBACK - 1
    isStrongSell := isStrongSell or isInStrongSellZone[i]

// Update trend line
g_trendLine := (isChangeUp or isChangeDown) and g_trendLine != g_trendLine[1] ? g_trendLine : 
     isChangeUp ? g_trendLine + epsilon : 
     isChangeDown ? g_trendLine - epsilon : g_trendLine[1]

// Update last signal
g_lastSignal := isChangeUp ? SIGNAL_TYPE_BUY : 
     isChangeDown ? SIGNAL_TYPE_SELL : g_lastSignal[1]

// Colors
currentColor = g_lastSignal == SIGNAL_TYPE_BUY ? buyColor : sellColor
bgColor = g_lastSignal == SIGNAL_TYPE_BUY ? 
     color.new(buyColor, i_bgTransparency) : 
     color.new(sellColor, i_bgTransparency)

// Signal shapes
buyShape = i_signalShape == "Labels" ? shape.labelup : 
     i_signalShape == "Arrows" ? shape.arrowup : shape.triangleup
sellShape = i_signalShape == "Labels" ? shape.labeldown : 
     i_signalShape == "Arrows" ? shape.arrowdown : shape.triangledown

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Moving Averages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
maFast1 = f_ma(sourceProcessed, i_cloud1Fast)
maSlow1 = f_ma(sourceProcessed, i_cloud1Slow)
maFast2 = f_ma(sourceProcessed, i_cloud2Fast)
maSlow2 = f_ma(sourceProcessed, i_cloud2Slow)
maFast3 = f_ma(sourceProcessed, i_cloud3Fast)
maSlow3 = f_ma(sourceProcessed, i_cloud3Slow)
maFast4 = f_ma(sourceProcessed, i_cloud4Fast)
maSlow4 = f_ma(sourceProcessed, i_cloud4Slow)
maFast5 = f_ma(sourceProcessed, i_cloud5Fast)
maSlow5 = f_ma(sourceProcessed, i_cloud5Slow)

// Cloud colors
cloudColor1 = maFast1 >= maSlow1 ? color.new(buyColor, 80) : color.new(sellColor, 80)
cloudColor2 = maFast2 >= maSlow2 ? color.new(buyColor, 85) : color.new(sellColor, 85)
cloudColor3 = maFast3 >= maSlow3 ? color.new(buyColor, 88) : color.new(sellColor, 88)
cloudColor4 = maFast4 >= maSlow4 ? color.new(buyColor, 85) : color.new(sellColor, 85)
cloudColor5 = maFast5 >= maSlow5 ? color.new(buyColor, 90) : color.new(sellColor, 90)

// Line colors
maFastColor1 = maFast1 >= maFast1[1] ? color.new(buyColor, 30) : color.new(sellColor, 30)
maFastColor2 = maFast2 >= maFast2[1] ? color.new(buyColor, 30) : color.new(sellColor, 30)
maFastColor3 = maFast3 >= maFast3[1] ? color.new(buyColor, 30) : color.new(sellColor, 30)
maFastColor4 = maFast4 >= maFast4[1] ? color.new(buyColor, 30) : color.new(sellColor, 30)
maFastColor5 = maFast5 >= maFast5[1] ? color.new(buyColor, 30) : color.new(sellColor, 30)

maSlowColor1 = maSlow1 >= maSlow1[1] ? color.new(buyColor, 0) : color.new(sellColor, 0)
maSlowColor2 = maSlow2 >= maSlow2[1] ? color.new(buyColor, 0) : color.new(sellColor, 0)
maSlowColor3 = maSlow3 >= maSlow3[1] ? color.new(buyColor, 0) : color.new(sellColor, 0)
maSlowColor4 = maSlow4 >= maSlow4[1] ? color.new(buyColor, 0) : color.new(sellColor, 0)
maSlowColor5 = maSlow5 >= maSlow5[1] ? color.new(buyColor, 0) : color.new(sellColor, 0)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Support & Resistance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
pivotHigh = fixnan(ta.pivothigh(i_pivotLeft, i_pivotRight)[1])
pivotLow = fixnan(ta.pivotlow(i_pivotLeft, i_pivotRight)[1])

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Wave Trend Oscillator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ap = hlc3
esa = ta.ema(ap, i_wtChannelLen)
d = ta.ema(math.abs(ap - esa), i_wtChannelLen)
ci = (ap - esa) / (WT_CHANNEL_MULTIPLIER * d)
tci = ta.ema(ci, i_wtAvgLen)

wt1 = tci
wt2 = ta.sma(wt1, WT_SMOOTH_PERIOD)

// Direction with proper ta.falling call outside ternary
wtRising = ta.rising(wt1, i_wtReaction)
wtFalling = ta.falling(wt1, i_wtReaction)

wtDirection = 0
wtDirection := wtRising ? 1 : wtFalling ? -1 : wtDirection[1]

// WT signals
wtBullishCross = ta.crossover(wt1, wt2) and wt1 <= i_osLevel and i_smartBuyOnly
wtBearishCross = ta.crossunder(wt1, wt2) and wt1 >= i_obLevel and i_smartSellOnly

// WT status
wtStatus = wt1 > i_obExtreme ? "âš ï¸ EXTREME OB" : 
     wt1 > i_obLevel ? "ğŸ“Š OVERBOUGHT" : 
     wt1 < i_osExtreme ? "âš ï¸ EXTREME OS" : 
     wt1 < i_osLevel ? "ğŸ“Š OVERSOLD" : "â– NEUTRAL"

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Heikin Ashi Market Bias â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
haOpen = ta.ema(open, i_haPeriod)
haClose = ta.ema(close, i_haPeriod)
haHigh = ta.ema(high, i_haPeriod)
haLow = ta.ema(low, i_haPeriod)

haCloseCalc = (haOpen + haHigh + haLow + haClose) / 4
haOpenCalc = (haOpen + haClose) / 2
haOpenFinal = na(haOpenCalc[1]) ? (haOpen + haClose) / 2 : (haOpenCalc[1] + haCloseCalc[1]) / 2
haHighFinal = math.max(haHigh, math.max(haOpenFinal, haCloseCalc))
haLowFinal = math.min(haLow, math.min(haOpenFinal, haCloseCalc))

haOpenSmooth = ta.ema(haOpenFinal, i_haSmoothing)
haCloseSmooth = ta.ema(haCloseCalc, i_haSmoothing)
haHighSmooth = ta.ema(haHighFinal, i_haSmoothing)
haLowSmooth = ta.ema(haLowFinal, i_haSmoothing)

oscBias = 100 * (haCloseSmooth - haOpenSmooth)
oscSmooth = ta.ema(oscBias, HA_OSC_LENGTH)

haTrend = oscBias > 0 ? "BULLISH" : "BEARISH"
haStrength = oscBias >= oscSmooth ? "STRONG" : "WEAK"
haColor = oscBias > 0 and oscBias >= oscSmooth ? color.new(strongBuyColor, 0) : 
     oscBias > 0 ? color.new(buyColor, 50) : 
     oscBias <= oscSmooth ? color.new(sellColor, 0) : color.new(sellColor, 50)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Divergence Detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
fractalTop = f_fractalize(wt1) > 0 ? wt1[2] : na
fractalBottom = f_fractalize(wt1) < 0 ? wt1[2] : na

highPrev = ta.valuewhen(fractalTop, wt1[2], 0)[2]
highPrice = ta.valuewhen(fractalTop, high[2], 0)[2]
lowPrev = ta.valuewhen(fractalBottom, wt1[2], 0)[2]
lowPrice = ta.valuewhen(fractalBottom, low[2], 0)[2]

divRegularBearish = i_showDivergence and fractalTop and high[2] > highPrice and wt1[2] < highPrev and i_divRegBear
divHiddenBearish = i_showDivergence and fractalTop and high[2] < highPrice and wt1[2] > highPrev and i_divHidBear
divRegularBullish = i_showDivergence and fractalBottom and low[2] < lowPrice and wt1[2] > lowPrev and i_divRegBull
divHiddenBullish = i_showDivergence and fractalBottom and low[2] > lowPrice and wt1[2] < lowPrev and i_divHidBull

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Momentum â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
stdDev = ta.stdev(close, 50) * i_momResponse

g_wormValue := bar_index == 0 ? close : g_wormValue[1]

if bar_index > 0
    diff = close - g_wormValue[1]
    delta = math.abs(diff) > stdDev ? math.sign(diff) * stdDev : diff
    g_wormValue := g_wormValue[1] + delta

maMom = ta.sma(close, i_momPeriod)
rawMomentum = (g_wormValue - maMom) / g_wormValue
currentMed = rawMomentum
minMed = ta.lowest(currentMed, i_momPeriod)
maxMed = ta.highest(currentMed, i_momPeriod)

temp = (currentMed - minMed) / (maxMed - minMed)
momValue = 0.5 * 2
momValue *= (temp - 0.5 + 0.5 * nz(momValue[1]))
momValue := momValue > 0.9999 ? 0.9999 : momValue
momValue := momValue < -0.9999 ? -0.9999 : momValue

temp2 = (1 + momValue) / (1 - momValue)
momentum = 0.25 * math.log(temp2)
momentum += 0.5 * nz(momentum[1])

momTrend = momentum > 0 ? "BULLISH" : "BEARISH"
momState = momentum > nz(momentum[1]) ? "GROWING â–²" : "FALLING â–¼"
momColor = momentum > 0 and momentum > nz(momentum[1]) ? color.new(buyColor, 0) : 
     momentum > 0 ? color.new(buyColor, 50) : 
     momentum < nz(momentum[1]) ? color.new(sellColor, 0) : color.new(sellColor, 50)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLOTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Background â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
bgcolor(i_showBackground ? bgColor : na, title = "Trend Background")

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Signals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Buy signals
isBuySignal = isChangeUp and g_lastSignal[1] != SIGNAL_TYPE_BUY and isStrongBuy == false
isStrongBuySignal = isChangeUp and g_lastSignal[1] != SIGNAL_TYPE_BUY and isStrongBuy == true

// Sell signals
isSellSignal = isChangeDown and g_lastSignal[1] != SIGNAL_TYPE_SELL and isStrongSell == false
isStrongSellSignal = isChangeDown and g_lastSignal[1] != SIGNAL_TYPE_SELL and isStrongSell == true

// Plot buy signals
plotshape(
     i_signalShape == "Labels" and (i_signalsView == "All" or i_signalsView == "Buy/Sell") and isBuySignal,
     title = "Buy Signal",
     style = buyShape,
     location = location.belowbar,
     color = currentColor,
     text = "BUY ğŸš€",
     textcolor = color.white,
     size = size.normal
 )

plotshape(
     i_signalShape == "Labels" and (i_signalsView == "All" or i_signalsView == "Strong") and isStrongBuySignal,
     title = "Strong Buy Signal",
     style = buyShape,
     location = location.belowbar,
     color = strongBuyColor,
     text = "STRONG BUY âš¡",
     textcolor = color.white,
     size = size.normal
 )

// Plot sell signals
plotshape(
     i_signalShape == "Labels" and (i_signalsView == "All" or i_signalsView == "Buy/Sell") and isSellSignal,
     title = "Sell Signal",
     style = sellShape,
     location = location.abovebar,
     color = currentColor,
     text = "SELL ğŸ»",
     textcolor = color.white,
     size = size.normal
 )

plotshape(
     i_signalShape == "Labels" and (i_signalsView == "All" or i_signalsView == "Strong") and isStrongSellSignal,
     title = "Strong Sell Signal",
     style = sellShape,
     location = location.abovebar,
     color = strongSellColor,
     text = "STRONG SELL âš¡",
     textcolor = color.white,
     size = size.normal
 )

// Arrows/Triangles
plotshape(
     i_signalShape != "Labels" and (i_signalsView == "All" or i_signalsView == "Buy/Sell") and isBuySignal,
     title = "Buy Arrow",
     style = buyShape,
     location = location.belowbar,
     color = currentColor,
     size = size.small
 )

plotshape(
     i_signalShape != "Labels" and (i_signalsView == "All" or i_signalsView == "Strong") and isStrongBuySignal,
     title = "Strong Buy Arrow",
     style = buyShape,
     location = location.belowbar,
     color = strongBuyColor,
     size = size.small
 )

plotshape(
     i_signalShape != "Labels" and (i_signalsView == "All" or i_signalsView == "Buy/Sell") and isSellSignal,
     title = "Sell Arrow",
     style = sellShape,
     location = location.abovebar,
     color = currentColor,
     size = size.small
 )

plotshape(
     i_signalShape != "Labels" and (i_signalsView == "All" or i_signalsView == "Strong") and isStrongSellSignal,
     title = "Strong Sell Arrow",
     style = sellShape,
     location = location.abovebar,
     color = strongSellColor,
     size = size.small
 )

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Bar Colors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
barcolor(i_colorBars ? currentColor : na, title = "Bar Color")

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ EMA Clouds â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
p1 = plot(i_showClouds and i_showCloud1 ? maFast1 : na,
     color = i_showLines ? maFastColor1 : na,
     linewidth = 2,
     offset = i_cloudOffset,
     title = "Cloud 1 Fast")
p2 = plot(i_showClouds and i_showCloud1 ? maSlow1 : na,
     color = i_showLines ? maSlowColor1 : na,
     linewidth = 2,
     offset = i_cloudOffset,
     title = "Cloud 1 Slow")
fill(p1, p2, color = cloudColor1, title = "Cloud 1 Fill")

p3 = plot(i_showClouds and i_showCloud2 ? maFast2 : na,
     color = i_showLines ? maFastColor2 : na,
     linewidth = 2,
     offset = i_cloudOffset,
     title = "Cloud 2 Fast")
p4 = plot(i_showClouds and i_showCloud2 ? maSlow2 : na,
     color = i_showLines ? maSlowColor2 : na,
     linewidth = 2,
     offset = i_cloudOffset,
     title = "Cloud 2 Slow")
fill(p3, p4, color = cloudColor2, title = "Cloud 2 Fill")

p5 = plot(i_showClouds and i_showCloud3 ? maFast3 : na,
     color = i_showLines ? maFastColor3 : na,
     linewidth = 2,
     offset = i_cloudOffset,
     title = "Cloud 3 Fast")
p6 = plot(i_showClouds and i_showCloud3 ? maSlow3 : na,
     color = i_showLines ? maSlowColor3 : na,
     linewidth = 2,
     offset = i_cloudOffset,
     title = "Cloud 3 Slow")
fill(p5, p6, color = cloudColor3, title = "Cloud 3 Fill")

p7 = plot(i_showClouds and i_showCloud4 ? maFast4 : na,
     color = i_showLines ? maFastColor4 : na,
     linewidth = 2,
     offset = i_cloudOffset,
     title = "Cloud 4 Fast")
p8 = plot(i_showClouds and i_showCloud4 ? maSlow4 : na,
     color = i_showLines ? maSlowColor4 : na,
     linewidth = 2,
     offset = i_cloudOffset,
     title = "Cloud 4 Slow")
fill(p7, p8, color = cloudColor4, title = "Cloud 4 Fill")

p9 = plot(i_showClouds and i_showCloud5 ? maFast5 : na,
     color = i_showLines ? maFastColor5 : na,
     linewidth = 3,
     offset = i_cloudOffset,
     title = "Cloud 5 Fast")
p10 = plot(i_showClouds and i_showCloud5 ? maSlow5 : na,
     color = i_showLines ? maSlowColor5 : na,
     linewidth = 3,
     offset = i_cloudOffset,
     title = "Cloud 5 Slow")
fill(p9, p10, color = cloudColor5, title = "Cloud 5 Fill")

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Support & Resistance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
plot(
     i_showSR and not na(pivotHigh) and not ta.change(pivotHigh) ? pivotHigh : na,
     color = color.new(sellColor, 0),
     linewidth = 2,
     offset = -(i_pivotRight + 1),
     title = "Resistance"
 )

plot(
     i_showSR and not na(pivotLow) and not ta.change(pivotLow) ? pivotLow : na,
     color = color.new(buyColor, 0),
     linewidth = 2,
     offset = -(i_pivotRight + 1),
     title = "Support"
 )

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Divergence Labels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
plotshape(
     divRegularBearish and i_divLabels,
     title = "Regular Bearish Divergence",
     text = "ğŸ» BEAR",
     style = shape.labeldown,
     location = location.abovebar,
     color = color.new(sellColor, 0),
     textcolor = color.white,
     size = size.small
 )

plotshape(
     divHiddenBearish and i_divLabels,
     title = "Hidden Bearish Divergence",
     text = "ğŸ”» H.BEAR",
     style = shape.labeldown,
     location = location.abovebar,
     color = color.new(strongSellColor, 0),
     textcolor = color.white,
     size = size.small
 )

plotshape(
     divRegularBullish and i_divLabels,
     title = "Regular Bullish Divergence",
     text = "ğŸ‚ BULL",
     style = shape.labelup,
     location = location.belowbar,
     color = color.new(buyColor, 0),
     textcolor = color.white,
     size = size.small
 )

plotshape(
     divHiddenBullish and i_divLabels,
     title = "Hidden Bullish Divergence",
     text = "ğŸ”º H.BULL",
     style = shape.labelup,
     location = location.belowbar,
     color = color.new(strongBuyColor, 0),
     textcolor = color.white,
     size = size.small
 )

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if barstate.islast and (i_showOscInfo or i_showMomentum or i_showMarketBias)
    
    g_infoTable := table.new(
         position = position.top_right,
         columns = 2,
         rows = 10,
         bgcolor = color.new(#000000, 10),
         frame_color = color.new(currentColor, 50),
         frame_width = 2,
         border_width = 1,
         border_color = color.new(currentColor, 70)
     )
    
    // Header
    table.cell(g_infoTable, 0, 0, "âš¡ ZS VISION PRO",
         text_color = color.white,
         text_size = size.normal,
         bgcolor = color.new(currentColor, 20),
         text_halign = text.align_center)
    table.merge_cells(g_infoTable, 0, 0, 1, 0)
    
    row = 1
    
    // Trend
    table.cell(g_infoTable, 0, row, "ğŸ“Š TREND",
         text_color = color.new(color.white, 30),
         text_size = size.small,
         bgcolor = color.new(#000000, 20))
    table.cell(g_infoTable, 1, row,
         g_lastSignal == SIGNAL_TYPE_BUY ? "ğŸŸ¢ BULLISH" : "ğŸ”´ BEARISH",
         text_color = currentColor,
         text_size = size.normal,
         bgcolor = color.new(currentColor, 90),
         text_halign = text.align_right)
    row += 1
    
    // Market Bias
    if i_showMarketBias
        table.cell(g_infoTable, 0, row, "ğŸ“ˆ BIAS",
             text_color = color.new(color.white, 30),
             text_size = size.small,
             bgcolor = color.new(#000000, 20))
        table.cell(g_infoTable, 1, row, haTrend + " | " + haStrength,
             text_color = haColor,
             text_size = size.small,
             bgcolor = color.new(haColor, 90),
             text_halign = text.align_right)
        row += 1
    
    // Wave Trend
    if i_showOscInfo
        table.cell(g_infoTable, 0, row, "ğŸŒŠ WAVE",
             text_color = color.new(color.white, 30),
             text_size = size.small,
             bgcolor = color.new(#000000, 20))
        table.cell(g_infoTable, 1, row, wtStatus,
             text_color = wt1 > 0 ? buyColor : sellColor,
             text_size = size.small,
             bgcolor = color.new(wt1 > 0 ? buyColor : sellColor, 90),
             text_halign = text.align_right)
        row += 1
        
        table.cell(g_infoTable, 0, row, "WT Value",
             text_color = color.new(color.white, 30),
             text_size = size.small,
             bgcolor = color.new(#000000, 20))
        table.cell(g_infoTable, 1, row, str.tostring(wt1, "#.##"),
             text_color = color.white,
             text_size = size.small,
             bgcolor = color.new(#000000, 20),
             text_halign = text.align_right)
        row += 1
    
    // Momentum
    if i_showMomentum
        table.cell(g_infoTable, 0, row, "âš¡ MOMENTUM",
             text_color = color.new(color.white, 30),
             text_size = size.small,
             bgcolor = color.new(#000000, 20))
        table.cell(g_infoTable, 1, row, momTrend,
             text_color = momColor,
             text_size = size.small,
             bgcolor = color.new(momColor, 90),
             text_halign = text.align_right)
        row += 1
        
        table.cell(g_infoTable, 0, row, "State",
             text_color = color.new(color.white, 30),
             text_size = size.small,
             bgcolor = color.new(#000000, 20))
        table.cell(g_infoTable, 1, row, momState,
             text_color = color.white,
             text_size = size.small,
             bgcolor = color.new(#000000, 20),
             text_halign = text.align_right)
        row += 1
    
    // Footer
    table.cell(g_infoTable, 0, row, "Created by Zakaria Safri",
         text_color = color.new(color.white, 50),
         text_size = size.tiny,
         bgcolor = color.new(#000000, 20),
         text_halign = text.align_center)
    table.merge_cells(g_infoTable, 0, row, 1, row)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

alertcondition(
     isBuySignal,
     title = "Buy Signal",
     message = "ZS Vision Pro: BUY Signal on {{ticker}} at {{close}}"
 )

alertcondition(
     isSellSignal,
     title = "Sell Signal",
     message = "ZS Vision Pro: SELL Signal on {{ticker}} at {{close}}"
 )

alertcondition(
     isStrongBuySignal,
     title = "Strong Buy Signal",
     message = "ZS Vision Pro: STRONG BUY Signal on {{ticker}} at {{close}}"
 )

alertcondition(
     isStrongSellSignal,
     title = "Strong Sell Signal",
     message = "ZS Vision Pro: STRONG SELL Signal on {{ticker}} at {{close}}"
 )

alertcondition(
     divRegularBullish,
     title = "Bullish Divergence",
     message = "ZS Vision Pro: Bullish Divergence on {{ticker}}"
 )

alertcondition(
     divRegularBearish,
     title = "Bearish Divergence",
     message = "ZS Vision Pro: Bearish Divergence on {{ticker}}"
 )

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// END OF SCRIPT
// @version 2.0
// @author Zakaria Safri
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
