// This Pine Script‚Ñ¢ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
//@version=6
indicator("Order Flow Imbalance Heatmap", "OF Heatmap", overlay=false, max_boxes_count=500, max_lines_count=100, max_labels_count=100)

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üî• ORDER FLOW IMBALANCE HEATMAP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//
// Volume delta analysis using OHLCV-based approximation of order flow:
//   ‚Ä¢ Buy/Sell volume estimation from candle structure
//   ‚Ä¢ Cumulative delta with divergence detection
//   ‚Ä¢ Imbalance ratio visualization (stacked columns)
//   ‚Ä¢ Absorption detection: high volume + small body = institutional activity
//   ‚Ä¢ Exhaustion signals: extreme delta after extended moves
//   ‚Ä¢ Heatmap-style coloring by imbalance intensity
//
// WHY THIS MATTERS:
//   Real order flow requires tick data. This indicator approximates it using
//   candle anatomy (body position, wick ratios, close location) to estimate
//   aggressive buying vs selling. Surprisingly accurate on liquid instruments.
//
// HOW TO USE:
//   1. Add below your price chart (separate pane)
//   2. Green bars = net buying pressure; Red bars = net selling pressure
//   3. Color intensity shows imbalance strength (brighter = more one-sided)
//   4. ‚ö° markers = absorption events (big volume, small move = trapped traders)
//   5. üîÑ markers = delta divergence from price (reversal warning)
//   6. Background colors show cumulative delta trend
//
// Author: OpenClaw Trading Systems
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ‚îÄ INPUTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

g_delta = "Delta Estimation"
method        = input.string("Candle Anatomy", "Estimation Method", 
               options=["Candle Anatomy", "Close Location"], group=g_delta,
               tooltip="Candle Anatomy uses body/wick ratios. Close Location uses position of close within the range.")
smooth_len    = input.int(1, "Delta Smoothing",              minval=1, maxval=10, group=g_delta)

g_imbal = "Imbalance Detection"
imbal_thresh  = input.float(2.0, "Imbalance Ratio Threshold", minval=1.3, maxval=5.0, step=0.1, group=g_imbal,
               tooltip="Buy/Sell ratio above this = significant imbalance")
stack_count   = input.int(3, "Stacked Imbalances (consecutive)", minval=2, maxval=10, group=g_imbal,
               tooltip="Number of consecutive imbalanced bars to flag")

g_absorb = "Absorption Detection"
absorb_vol_m  = input.float(2.0, "Absorption Volume Multiplier", minval=1.3, maxval=5.0, step=0.1, group=g_absorb)
absorb_body   = input.float(30.0, "Max Body % of Range",         minval=10.0, maxval=50.0, step=5.0, group=g_absorb,
               tooltip="Small body relative to range indicates absorption")

g_diverg = "Divergence"
diverg_len    = input.int(10, "Divergence Lookback",          minval=5, maxval=30, group=g_diverg)
cum_delta_len = input.int(20, "Cumulative Delta Period",      minval=5, maxval=100, group=g_diverg)

g_exhaust = "Exhaustion"
exhaust_len   = input.int(14, "Exhaustion Lookback",          minval=5, maxval=50, group=g_exhaust)
exhaust_mult  = input.float(2.5, "Exhaustion Std Dev Mult",   minval=1.5, maxval=4.0, step=0.1, group=g_exhaust)

g_vis = "Visuals"
col_buy       = input.color(#00C853, "Buy Pressure Color",    group=g_vis)
col_sell      = input.color(#FF1744, "Sell Pressure Color",    group=g_vis)
show_cum      = input.bool(true,     "Show Cumulative Delta",  group=g_vis)
show_absorb   = input.bool(true,     "Show Absorption Markers",group=g_vis)
show_diverg   = input.bool(true,     "Show Divergence Markers",group=g_vis)
show_exhaust  = input.bool(true,     "Show Exhaustion Markers",group=g_vis)
show_panel    = input.bool(true,     "Show Info Panel",        group=g_vis)

// ‚îÄ‚îÄ‚îÄ DELTA ESTIMATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// Method 1: Candle Anatomy ‚Äî uses body/wick structure
candle_anatomy_delta() =>
    rng = high - low
    if rng == 0
        [volume * 0.5, volume * 0.5, 0.0]
    else
        body = math.abs(close - open)
        body_pct = body / rng
        
        upper_wick = high - math.max(open, close)
        lower_wick = math.min(open, close) - low
        
        is_green = close >= open
        
        // Core idea: body direction + wick rejection = aggression estimate
        // Large body + small opposing wick = strong aggression
        // Small body + large wicks = indecision / absorption
        if is_green
            // Green candle: buying aggression proportional to body size and lower wick support
            buy_pct = 0.5 + (body_pct * 0.3) + (rng > 0 ? lower_wick / rng * 0.1 : 0) - (rng > 0 ? upper_wick / rng * 0.1 : 0)
            buy_pct := math.max(0.2, math.min(0.85, buy_pct))
            bv = volume * buy_pct
            sv = volume - bv
            [bv, sv, bv - sv]
        else
            // Red candle: selling aggression proportional to body size and upper wick resistance
            sell_pct = 0.5 + (body_pct * 0.3) + (rng > 0 ? upper_wick / rng * 0.1 : 0) - (rng > 0 ? lower_wick / rng * 0.1 : 0)
            sell_pct := math.max(0.2, math.min(0.85, sell_pct))
            sv = volume * sell_pct
            bv = volume - sv
            [bv, sv, bv - sv]

// Method 2: Close Location Value ‚Äî where close falls within the range
close_location_delta() =>
    rng = high - low
    if rng == 0
        [volume * 0.5, volume * 0.5, 0.0]
    else
        clv = (close - low) / rng  // 0 = closed at low, 1 = closed at high
        bv = volume * clv
        sv = volume * (1 - clv)
        [bv, sv, bv - sv]

[buy_vol, sell_vol, raw_delta] = switch method
    "Candle Anatomy"  => candle_anatomy_delta()
    "Close Location"  => close_location_delta()

delta = smooth_len > 1 ? ta.sma(raw_delta, smooth_len) : raw_delta

// ‚îÄ‚îÄ‚îÄ CUMULATIVE DELTA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

cum_delta = ta.cum(delta)
cum_delta_sma = ta.sma(cum_delta, cum_delta_len)
cum_delta_rising = cum_delta > cum_delta_sma

// ‚îÄ‚îÄ‚îÄ IMBALANCE DETECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

imbal_ratio = sell_vol > 0 ? buy_vol / sell_vol : (buy_vol > 0 ? 999.0 : 1.0)
is_buy_imbal  = imbal_ratio >= imbal_thresh
is_sell_imbal = imbal_ratio <= (1.0 / imbal_thresh)

// Stacked imbalances
buy_stack  = 0
sell_stack = 0
for j = 0 to stack_count - 1
    if is_buy_imbal[j]
        buy_stack += 1
    if is_sell_imbal[j]
        sell_stack += 1

stacked_buy  = buy_stack  >= stack_count
stacked_sell = sell_stack >= stack_count

// ‚îÄ‚îÄ‚îÄ ABSORPTION DETECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

vol_avg = ta.sma(volume, 20)
rng = high - low
body = math.abs(close - open)
body_pct = rng > 0 ? (body / rng * 100) : 50

is_absorption = volume > vol_avg * absorb_vol_m and body_pct < absorb_body
absorb_bull = is_absorption and close >= open  // High vol, small body, green = buying absorbed sellers
absorb_bear = is_absorption and close < open   // High vol, small body, red = selling absorbed buyers

// ‚îÄ‚îÄ‚îÄ DIVERGENCE DETECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

price_higher_high = high > ta.highest(high, diverg_len)[1]
price_lower_low   = low  < ta.lowest(low,   diverg_len)[1]
delta_sma = ta.sma(delta, diverg_len)

// Bearish divergence: price makes HH but delta is declining
bear_diverg = price_higher_high and delta_sma < delta_sma[diverg_len]
// Bullish divergence: price makes LL but delta is rising
bull_diverg = price_lower_low and delta_sma > delta_sma[diverg_len]

// ‚îÄ‚îÄ‚îÄ EXHAUSTION DETECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

delta_avg  = ta.sma(delta, exhaust_len)
delta_std  = ta.stdev(delta, exhaust_len)
buy_exhaustion  = delta > delta_avg + delta_std * exhaust_mult
sell_exhaustion = delta < delta_avg - delta_std * exhaust_mult

// ‚îÄ‚îÄ‚îÄ HEATMAP COLORING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// Color intensity based on imbalance strength
intensity = math.min(math.abs(imbal_ratio - 1.0) / (imbal_thresh - 1.0), 1.0) * 100
// Clamp transparency: strong imbalance = more opaque (lower transparency)
transp = math.round(math.max(10, 80 - intensity * 0.7))

delta_color = delta >= 0 ? color.new(col_buy, transp) : color.new(col_sell, transp)

// ‚îÄ‚îÄ‚îÄ PLOTTING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// Main delta histogram
plot(delta, "Delta", color=delta_color, style=plot.style_columns, linewidth=2)

// Zero line
hline(0, "Zero", color=color.new(color.gray, 70), linestyle=hline.style_dotted)

// Cumulative delta as line overlay
plot(show_cum ? cum_delta : na, "Cumulative Delta", color=cum_delta_rising ? color.new(col_buy, 40) : color.new(col_sell, 40), linewidth=2)
plot(show_cum ? cum_delta_sma : na, "Cum Delta SMA", color=color.new(color.gray, 50), linewidth=1)

// ‚îÄ‚îÄ‚îÄ SIGNAL MARKERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// Absorption
plotshape(show_absorb and absorb_bull, "Bull Absorption", shape.diamond, location.bottom, color.new(col_buy, 20), size=size.tiny)
plotshape(show_absorb and absorb_bear, "Bear Absorption", shape.diamond, location.top, color.new(col_sell, 20), size=size.tiny)

// Stacked imbalances
plotshape(stacked_buy,  "Stacked Buy Imbalance",  shape.arrowup,   location.bottom, col_buy,  size=size.small)
plotshape(stacked_sell, "Stacked Sell Imbalance",  shape.arrowdown, location.top,    col_sell, size=size.small)

// Divergence
plotshape(show_diverg and bull_diverg, "Bull Divergence", shape.labelup,   location.bottom, color.new(col_buy,  30), text="DIV", textcolor=color.white, size=size.tiny)
plotshape(show_diverg and bear_diverg, "Bear Divergence", shape.labeldown, location.top,    color.new(col_sell, 30), text="DIV", textcolor=color.white, size=size.tiny)

// Exhaustion
plotshape(show_exhaust and buy_exhaustion,  "Buy Exhaustion",  shape.xcross, location.top,    color.new(color.orange, 20), size=size.tiny)
plotshape(show_exhaust and sell_exhaustion, "Sell Exhaustion",  shape.xcross, location.bottom, color.new(color.orange, 20), size=size.tiny)

// Background for cumulative delta trend
bgcolor(show_cum ? (cum_delta_rising ? color.new(col_buy, 95) : color.new(col_sell, 95)) : na, title="Cum Delta Trend")

// ‚îÄ‚îÄ‚îÄ INFO PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

if show_panel and barstate.islast
    t = table.new(position.top_right, 2, 8, bgcolor=color.new(#0d1117, 10),
                  border_width=1, border_color=color.new(#30363d, 20))
    
    hdr = color.new(#161b22, 10)
    table.cell(t, 0, 0, "OF Heatmap", text_color=color.white, text_size=size.small, bgcolor=hdr)
    table.cell(t, 1, 0, "",           bgcolor=hdr)
    
    table.cell(t, 0, 1, "Delta",        text_color=color.gray, text_size=size.tiny)
    dc = delta >= 0 ? col_buy : col_sell
    table.cell(t, 1, 1, str.tostring(math.round(delta)), text_color=dc, text_size=size.tiny)
    
    table.cell(t, 0, 2, "Buy Vol",      text_color=color.gray, text_size=size.tiny)
    table.cell(t, 1, 2, str.tostring(math.round(buy_vol)), text_color=col_buy, text_size=size.tiny)
    
    table.cell(t, 0, 3, "Sell Vol",     text_color=color.gray, text_size=size.tiny)
    table.cell(t, 1, 3, str.tostring(math.round(sell_vol)), text_color=col_sell, text_size=size.tiny)
    
    table.cell(t, 0, 4, "Imbal Ratio",  text_color=color.gray, text_size=size.tiny)
    ir_col = is_buy_imbal ? col_buy : is_sell_imbal ? col_sell : color.gray
    table.cell(t, 1, 4, str.tostring(imbal_ratio, '#.##') + "√ó", text_color=ir_col, text_size=size.tiny)
    
    table.cell(t, 0, 5, "Cum Delta",    text_color=color.gray, text_size=size.tiny)
    cd_col = cum_delta_rising ? col_buy : col_sell
    table.cell(t, 1, 5, (cum_delta_rising ? "‚Üë " : "‚Üì ") + str.tostring(math.round(cum_delta)), text_color=cd_col, text_size=size.tiny)
    
    table.cell(t, 0, 6, "Absorption",   text_color=color.gray, text_size=size.tiny)
    abs_txt = absorb_bull ? "BULL ‚óÜ" : absorb_bear ? "BEAR ‚óÜ" : "‚Äî"
    abs_col = absorb_bull ? col_buy : absorb_bear ? col_sell : color.gray
    table.cell(t, 1, 6, abs_txt, text_color=abs_col, text_size=size.tiny)
    
    table.cell(t, 0, 7, "Vol vs Avg",   text_color=color.gray, text_size=size.tiny)
    vr = vol_avg > 0 ? volume / vol_avg : 1.0
    vc = vr > 2 ? color.lime : vr > 1.2 ? color.yellow : color.gray
    table.cell(t, 1, 7, str.tostring(vr, '#.##') + "√ó", text_color=vc, text_size=size.tiny)

// ‚îÄ‚îÄ‚îÄ ALERTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

alertcondition(stacked_buy,           "Stacked Buy Imbalance",  "Consecutive buy imbalances detected ‚Äî strong buying pressure")
alertcondition(stacked_sell,          "Stacked Sell Imbalance", "Consecutive sell imbalances detected ‚Äî strong selling pressure")
alertcondition(absorb_bull,           "Bullish Absorption",     "High volume absorption at support ‚Äî potential reversal up")
alertcondition(absorb_bear,           "Bearish Absorption",     "High volume absorption at resistance ‚Äî potential reversal down")
alertcondition(bull_diverg,           "Bullish Delta Divergence","Price making new lows but buying pressure increasing")
alertcondition(bear_diverg,           "Bearish Delta Divergence","Price making new highs but buying pressure declining")
alertcondition(buy_exhaustion,        "Buy Exhaustion",         "Extreme buying ‚Äî potential blowoff top")
alertcondition(sell_exhaustion,       "Sell Exhaustion",        "Extreme selling ‚Äî potential capitulation bottom")

// ‚îÄ‚îÄ‚îÄ DATA EXPORTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

plot(buy_vol,      "Buy Volume",       display=display.data_window, color=color.new(color.white, 100))
plot(sell_vol,     "Sell Volume",       display=display.data_window, color=color.new(color.white, 100))
plot(imbal_ratio,  "Imbalance Ratio",   display=display.data_window, color=color.new(color.white, 100))
plot(cum_delta,    "Cumulative Delta",   display=display.data_window, color=color.new(color.white, 100))
