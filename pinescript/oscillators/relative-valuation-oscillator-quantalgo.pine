// This script is licensed under Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International
// https://creativecommons.org/licenses/by-nc-sa/4.0/

//@version=6
indicator('Relative Valuation Oscillator [QuantAlgo]', overlay=false, precision=2, timeframe='', timeframe_gaps=true)

//              ╔════════════════════════════════╗              //
//              ║      USER-DEFINED SETTINGS     ║              //
//              ╚════════════════════════════════╝              //

var string calculation_settings = '════════ Calculation Parameters ════════'
var string visual_settings = '════════ Visualization Settings ════════'

tooltip_lookback = 'Period for calculating the mean log price and standard deviation, which forms the foundation of the valuation measurement. Shorter periods (14-21) make the oscillator highly reactive to recent price changes, generating more frequent signals - ideal for short-term trading and scalping where you want to catch quick over/undervaluation events. Medium periods (34-55) provide balanced sensitivity that captures meaningful deviations while filtering out daily noise - suitable for swing trading and most market conditions. Longer periods (89-144) create a stable baseline focused on long-term fair value, generating fewer but higher-conviction signals - best for position trading and identifying major market extremes. Standard value is 34 for balanced performance across most timeframes.'
tooltip_threshold = 'Multiplier for standard deviation to define extreme over/undervaluation zones. Lower values (1.0-1.5) mark boundaries closer to fair value, generating more frequent signals as price reaches mild deviations - useful for range-bound markets and mean reversion strategies where you want early warning of stretched conditions. Higher values (2.5-4.0) mark boundaries at extreme statistical deviations, generating rare but high-conviction signals - suitable for trending markets where you only want alerts at truly overbought/oversold extremes. Standard value is 2.0, representing statistically significant deviations that occur roughly 5% of the time in normal distributions.'
tooltip_preset = 'Select a predefined configuration optimized for different trading styles and market conditions.'
tooltip_preset_details = 'Default (34, 2.0): Standard configuration suitable for swing trading on 4H and daily charts. Medium lookback captures meaningful trend deviations, 2.0 threshold marks statistically significant extremes. Generates quality signals without excessive noise, ideal for most traders and market conditions.\n\nFast Response (21, 1.5): Aggressive configuration for intraday trading and scalping on 5min-1H charts. Shorter lookback reacts quickly to price shifts, lower threshold generates more frequent signals at mild deviations. Best for active traders who can monitor positions closely and trade mean reversion in ranging markets.\n\nSmooth Trend (60, 2): Conservative configuration for position trading and macro analysis on daily-weekly charts. Extended lookback establishes stable fair value baseline, higher threshold only signals at extreme statistical outliers. Best for patient investors seeking major market extremes with minimal false signals.'
tooltip_color_preset = 'Pre-configured color schemes optimized for different chart themes and visual preferences. Classic uses traditional green/red. Aqua provides ocean-inspired blues and oranges. Cosmic offers futuristic cyan and purple. Cyber features warm orange and cool cyan contrast. Neon delivers high-contrast yellow and magenta for maximum visibility. Custom allows full color customization.'
tooltip_bullish = 'Color for undervalued conditions when the oscillator falls below the negative threshold. This represents statistical undervaluation - price has deviated significantly below its mean on a logarithmic scale, suggesting potential buying opportunities for mean reversion traders. Historically, such extremes have preceded upward corrections, though timing can vary. Use vibrant colors to highlight these attractive entry zones.'
tooltip_bearish = 'Color for overvalued conditions when the oscillator exceeds the positive threshold. This represents statistical overvaluation - price has deviated significantly above its mean, suggesting caution or potential shorting opportunities. Markets can remain overvalued during strong trends, so combine with other indicators for confirmation. Use warning colors to signal elevated risk zones.'
tooltip_neutral = 'Color for fair value range when the oscillator remains between thresholds. This represents normal price behavior within expected statistical bounds - neither stretched high nor low. In this zone, price is trading near its fundamental mean value. Use neutral, subdued colors to indicate balanced conditions where trending or range-bound strategies may be more appropriate than mean reversion.'
tooltip_bg_signals = 'Enable/disable background highlighting for extreme valuation zones. When enabled, chart background is tinted with bullish color during undervaluation (below negative threshold) and bearish color during overvaluation (above positive threshold). This creates immediate visual context of valuation extremes without requiring constant oscillator monitoring. Disable if you prefer clean charts or use other background coloring indicators.'
tooltip_bg_transparency = 'Transparency level for background highlighting. Higher values (80-95) create subtle background tints that provide context without overwhelming the chart - useful when running multiple indicators or preferring minimalist visuals. Lower values (50-70) create prominent highlighting for stronger emphasis on extreme conditions - useful for visual traders who want instant recognition of valuation extremes. Adjust based on chart theme and personal preference.'
tooltip_overlay_signals = 'Enable/disable signal markers on the main price chart when valuation reaches extreme thresholds. When enabled, small circles appear above price bars during overvaluation and below bars during undervaluation, allowing you to see extreme conditions directly on price action without switching between panels. This visual overlay helps correlate statistical extremes with specific price levels, candlestick patterns, and support/resistance zones. Disable to reduce chart clutter or if you prefer monitoring extremes only via the oscillator panel and background highlighting.'

lookback_period = input.int(34, 'Lookback Period', group=calculation_settings, tooltip=tooltip_lookback)
threshold_mult = input.float(2.0, 'Deviation Threshold', minval=0.5, step=0.1, group=calculation_settings, tooltip=tooltip_threshold)
presetConfig = input.string('Default', 'Preset Configuration', options=['Default', 'Fast Response', 'Smooth Trend'], group=calculation_settings, tooltip=tooltip_preset + '\n\n' + tooltip_preset_details)

colorPreset = input.string('Custom', 'Color Preset', options=['Classic', 'Aqua', 'Cosmic', 'Cyber', 'Neon', 'Custom'], group=visual_settings, tooltip=tooltip_color_preset)
bullishInput = input.color(#00ffaa, 'Undervalued Color', group=visual_settings, tooltip=tooltip_bullish)
bearishInput = input.color(#ff0000, 'Overvalued Color', group=visual_settings, tooltip=tooltip_bearish)
neutralInput = input.color(#787b86, 'Fair Value Color', group=visual_settings, tooltip=tooltip_neutral)

enableOverlaySignals = input.bool(true, 'Show Valuation Extremes', group=visual_settings, tooltip=tooltip_overlay_signals)
enableBgSignals = input.bool(false, 'Enable Background Signals', group=visual_settings, tooltip=tooltip_bg_signals)
bgTransparency = input.int(70, 'Background Transparency', minval=0, maxval=100, group=visual_settings, tooltip=tooltip_bg_transparency)

if presetConfig == 'Fast Response'
    lookback_period := 21
    threshold_mult := 1.5
else if presetConfig == 'Smooth Trend'
    lookback_period := 60
    threshold_mult := 2

[bullish, bearish, neutral] = switch colorPreset
    'Classic' => [#00ff00, #ff0000, #787b86]
    'Aqua' => [#00d4ff, #ff8c00, #5f6368]
    'Cosmic' => [#49ffce, #9932cc, #6b6d76]
    'Cyber' => [#00cccc, #ff6600, #7a7d85]
    'Neon' => [#ffff00, #ff00ff, #808080]
    'Custom' => [bullishInput, bearishInput, neutralInput]

//              ╔════════════════════════════════╗              //
//              ║        CORE CALCULATION        ║              //
//              ╚════════════════════════════════╝              //

log_price = math.log(close)
mean_log_price = ta.sma(log_price, lookback_period)
standard_deviation = ta.stdev(log_price, lookback_period)
valuation_score = (log_price - mean_log_price) / standard_deviation

is_overvalued = valuation_score > threshold_mult
is_undervalued = valuation_score < -threshold_mult

oscillator_color = is_overvalued ? bearish : 
                   is_undervalued ? bullish : 
                   color.new(neutral, 50)

overvalued_cross = ta.crossover(valuation_score, threshold_mult)
undervalued_cross = ta.crossunder(valuation_score, -threshold_mult)
cross_above_zero = ta.crossover(valuation_score, 0)
cross_below_zero = ta.crossunder(valuation_score, 0)

//              ╔════════════════════════════════╗              //
//              ║          VISUALIZATION         ║              //
//              ╚════════════════════════════════╝              //

upper_threshold = plot(threshold_mult, 'Overvalued Threshold', color=color.new(bearish, 60), linewidth=3)
lower_threshold = plot(-threshold_mult, 'Undervalued Threshold', color=color.new(bullish, 60), linewidth=3)

fill(upper_threshold, lower_threshold, color=color.new(neutral, 100), title='Fair Value Zone')

main_plot = plot(valuation_score, 'Valuation Score', color=oscillator_color, linewidth=2)

fair_value_line = plot(0, 'Fair Value', color=color.new(neutral, 80), linewidth=1)

fill(main_plot, fair_value_line, 
     top_value=0.5, bottom_value=-0.5, 
     top_color=color.new(bearish, 80), 
     bottom_color=color.new(bullish, 80), 
     title='Valuation Glow')
     
plotshape(is_overvalued ? valuation_score : na, 'Overvalued Signal (Bottom Panel)', shape.circle, location.absolute, bearish, size=size.tiny)
plotshape(is_undervalued ? valuation_score : na, 'Undervalued Signal (Bottom Panel)', shape.circle, location.absolute, bullish, size=size.tiny)

plotshape(enableOverlaySignals and is_overvalued ? valuation_score : na, 'Overvalued Signal (Top Panel)', shape.circle, location.abovebar, bearish, size=size.tiny, force_overlay=true)
plotshape(enableOverlaySignals and is_undervalued ? valuation_score : na, 'Undervalued Signal (Top Panel)', shape.circle, location.belowbar, bullish, size=size.tiny, force_overlay=true)

bgcolor(enableBgSignals and is_overvalued ? color.new(bearish, bgTransparency) : na, force_overlay=true, title='Overvalued Background')
bgcolor(enableBgSignals and is_undervalued ? color.new(bullish, bgTransparency) : na, force_overlay=true, title='Undervalued Background')

//              ╔════════════════════════════════╗              //
//              ║             ALERTS             ║              //
//              ╚════════════════════════════════╝              //

alertcondition(overvalued_cross, title='Overvalued Threshold Crossed', message='Relative Valuation Oscillator: OVERVALUED threshold crossed on {{exchange}}:{{ticker}} - {{interval}}. Price may be statistically stretched to the upside.')
alertcondition(undervalued_cross, title='Undervalued Threshold Crossed', message='Relative Valuation Oscillator: UNDERVALUED threshold crossed on {{exchange}}:{{ticker}} - {{interval}}. Price may be statistically stretched to the downside.')
alertcondition(cross_above_zero, title='Crossed Above Fair Value (0)', message='Relative Valuation Oscillator: Crossed ABOVE Fair Value (0) on {{exchange}}:{{ticker}} - {{interval}}. Transitioning to overvaluation zone.')
alertcondition(cross_below_zero, title='Crossed Below Fair Value (0)', message='Relative Valuation Oscillator: Crossed BELOW Fair Value (0) on {{exchange}}:{{ticker}} - {{interval}}. Transitioning to undervaluation zone.')
alertcondition(overvalued_cross or undervalued_cross, title='Any Extreme Valuation', message='Relative Valuation Oscillator: Extreme valuation detected! Check chart {{exchange}}:{{ticker}} - {{interval}}')

//              ╔════════════════════════════════╗              //
//              ║           CREATED BY           ║              //
//              ╚════════════════════════════════╝              //

// ██████╗ ██╗   ██╗ █████╗ ███╗   ██╗████████╗     █████╗ ██╗      ██████╗  ██████╗ 
//██╔═══██╗██║   ██║██╔══██╗████╗  ██║╚══██╔══╝    ██╔══██╗██║     ██╔════╝ ██╔═══██╗
//██║   ██║██║   ██║███████║██╔██╗ ██║   ██║       ███████║██║     ██║  ███╗██║   ██║
//██║▄▄ ██║██║   ██║██╔══██║██║╚██╗██║   ██║       ██╔══██║██║     ██║   ██║██║   ██║
//╚██████╔╝╚██████╔╝██║  ██║██║ ╚████║   ██║       ██║  ██║███████╗╚██████╔╝╚██████╔╝
// ╚══▀▀═╝  ╚═════╝ ╚═╝  ╚═╝╚═╝  ╚═══╝   ╚═╝       ╚═╝  ╚═╝╚══════╝ ╚═════╝  ╚═════╝
