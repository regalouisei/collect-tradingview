//@version=5
indicator("Diodato 'All Stars Align' Signal", shorttitle="ASA Signal", overlay=true, max_labels_count=500)

// ┌─────────────────────────────────────────────────────────────────────────┐
// │ Inputs                                                                  │
// └─────────────────────────────────────────────────────────────────────────┘
// ── Trigger Thresholds
stcoOsLevel     = input.float(140.0, "STCO Oversold Level", group="Trigger Thresholds")
declPanicLevel  = input.float(65.0, "3-DMA % Declines Panic Level", group="Trigger Thresholds")
stochOversold   = input.float(20.0, "Stochastic Oversold Level", group="Trigger Thresholds")

// ── Data Sources & Stochastic Settings
useUnchData   = input.bool(true, "Use Unchanged Issues/Volume?", group="Data Sources")
stochLen      = input.int(14, "Stochastic Length", group="Stochastic Settings", inline="s1")
stochKsmooth  = input.int(3, "%K Smoothing", group="Stochastic Settings", inline="s1")
stochDsmooth  = input.int(3, "%D Smoothing", group="Stochastic Settings", inline="s2")


// ┌─────────────────────────────────────────────────────────────────────────┐
// │ Calculations (Performed in the background)                              │
// └─────────────────────────────────────────────────────────────────────────┘
// ── Fetch Data
advn = request.security("ADVN", timeframe.period, close)
decn = request.security("DECN", timeframe.period, close)
uvol = request.security("UVOL", timeframe.period, close)
dvol = request.security("DVOL", timeframe.period, close)
uncn = useUnchData ? request.security("UNCH.US", timeframe.period, close) : 0.0
uncv = useUnchData ? request.security("UNCV", timeframe.period, close) : 0.0

// ── Calculate 3-DMA % Declines
totalIssues  = advn + decn + (useUnchData ? uncn : 0)
tradedIssues = useUnchData ? (totalIssues - uncn) : (advn + decn)
declPct      = tradedIssues > 0 ? (decn / tradedIssues) * 100.0 : na
decl3        = ta.sma(declPct, 3)

// ── Calculate STCO
uv10    = ta.sma(uvol, 10)
dv10    = ta.sma(dvol, 10)
uncv10  = useUnchData ? ta.sma(uncv, 10) : 0.0
effV10  = (uv10 + dv10 + uncv10) - uncv10
volBandST = effV10 > 0 ? uv10 / effV10 : na
adv10   = ta.sma(advn, 10)
dec10   = ta.sma(decn, 10)
uncn10  = useUnchData ? ta.sma(uncn, 10) : 0.0
effI10  = (adv10 + dec10 + uncn10) - uncn10
brdBandST = effI10 > 0 ? adv10 / effI10 : na
stco = 100.0 * (volBandST + brdBandST)

// ── Calculate Slow Stochastic
fastK = ta.stoch(close, high, low, stochLen)
slowK = ta.sma(fastK, stochKsmooth)
slowD = ta.sma(slowK, stochDsmooth)

// ── Define Trigger Conditions
stochIsOversold = slowK <= stochOversold
declIsPanic     = decl3 >= declPanicLevel
stcoIsOversold  = stco <= stcoOsLevel

supplyDemandTriggered = declIsPanic or stcoIsOversold
allStarsAlign = stochIsOversold and supplyDemandTriggered
allStarsAlignHit = allStarsAlign and not allStarsAlign[1]


// ┌─────────────────────────────────────────────────────────────────────────┐
// │ Plotting                                                                │
// └─────────────────────────────────────────────────────────────────────────┘
// Changed plotshape to a green cross with no label
plotshape(allStarsAlignHit, title="'All Stars Align' Signal",
     style=shape.cross, location=location.belowbar, 
     color=color.green, size=size.small)
