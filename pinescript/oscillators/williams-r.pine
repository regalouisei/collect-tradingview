//@version=5
indicator(title="Williams %R – Session Adjusted", shorttitle="%R", format=format.price, precision=2, timeframe="", timeframe_gaps=true)

// ──────────────── Input Settings ────────────────
period = input.int(14, "Period (days)", minval=1, maxval=100, group="Williams %R Settings", tooltip="Lookback period for the %R calculation (in trading days).")
src = input.source(close, "Source", group="Williams %R Settings", tooltip="Price source for calculation (close by default).")

session_duration_hours = input.float(8.5, "Session Duration (hours)", minval=0.1, step=0.1, group="Session Settings", tooltip="Enter the trading session length in hours for the symbol (e.g., 8.5 for FTSEMIB, 6.5 for US equities, 24 for crypto).")

// ──────────────── Style Settings ────────────────
color_main = input.color(color.new(#7E57C2, 0), "Main %R Color", group="Style")
color_upper = input.color(color.new(#787B86, 0), "Overbought Line Color", group="Style")
color_lower = input.color(color.new(#787B86, 0), "Oversold Line Color", group="Style")
color_middle = input.color(color.new(#787B86, 0), "Middle Line Color", group="Style")
color_fill = input.color(color.new(#7E57C2, 90), "Background Fill Color", group="Style")

// Calculate candles per trading day
var float timeframe_seconds = timeframe.in_seconds(timeframe.period)
var float session_seconds = session_duration_hours * 3600
var int candles_per_day = int(math.ceil(session_seconds / timeframe_seconds))

// ──────────────── Williams %R Calculation ────────────────
// Use the adjusted period (in candles) to make it session-aware
highest_high = ta.highest(high, period * candles_per_day)
lowest_low = ta.lowest(low, period * candles_per_day)
williams_r = 100 * (src - highest_high) / (highest_high - lowest_low)

// ──────────────── Plots ────────────────
plot(williams_r, title="Williams %R MOD", color=color_main, linewidth=1)

upper = hline(-20, "Overbought", color=color_upper, linestyle=hline.style_dashed)
middle = hline(-50, "Middle", color=color_middle, linestyle=hline.style_dotted)
lower = hline(-80, "Oversold", color=color_lower, linestyle=hline.style_dashed)

fill(upper, lower, title="Overbought/Oversold Zone", color=color_fill)
