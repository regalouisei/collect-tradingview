//@version=5
indicator("Strength Relative to XXX [Hysteresis Smoothed]", overlay=false)

btc_symbol = input.symbol("BITFINEX:BTCUSD", title="Compare to (any symbol)")
len = input.int(10, title="MA Length", minval=1)
rel_threshold = input.float(0.05, title="Relative Hysteresis Threshold", minval=0.01, step=0.01)

cur_s = close
btc_s = request.security(btc_symbol, timeframe.period, close)

diff = cur_s / btc_s
diff_sma = ta.sma(diff, len)
diff_os = diff - diff_sma

bool raw_green = diff >= diff_sma

var color current_color = na
if na(current_color)
    current_color := raw_green ? color.green : color.red
else
    float thresh = diff * rel_threshold
    if diff_os > thresh
        current_color := color.green
    else if diff_os < -thresh
        current_color := color.red
    // else hold previous

// ALERT SIGNAL — PLOTTED FIRST AND FULLY HIDDEN (best method)
int alert_signal = current_color == color.green ? 1 : -1
plot(alert_signal, title="Alert Signal", display = display.none)
// This is {{plot_0}} in alerts — completely invisible on chart, 100% reliable

// Visual elements — fully visible as before
plot(0, color=color.black, title="Zero Line", linewidth=1)
plot(diff_os, color=color.black, title="Oscillator", linewidth=2)
fill(plot(0), plot(diff_os), color=current_color, transp=0, title="Strength Fill")

// Color price bars based on relative strength (green = outperforming, red = underperforming)
barcolor(current_color)
