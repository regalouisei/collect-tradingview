//@version=6
indicator("Luxy Sector & Industry RS Analyzer", shorttitle = "Luxy RS Analyzer", overlay=true)

// ============================================================================
// VERSION & DISCLAIMER
// ============================================================================
// Version: 2.3.0
// Author: OrenLuxy
//
// DISCLAIMER:
// This indicator is for educational and informational purposes only.
// It should not be considered as financial advice or a recommendation to buy or sell.
// Past performance does not guarantee future results.
// Trading involves risk and may not be suitable for all investors.
// Always do your own research and consult with a financial advisor before making investment decisions.
// ============================================================================
//
// METHODOLOGY:
// This indicator uses Relative Strength (RS) analysis principles, comparing
// stock performance against its sector ETF, industry ETF, and the broader market (SPY).
//
// Multi-Level Hierarchy Analysis:
// Market (SPY) → Sector (XLK, XLF, etc.) → Industry (IGV, SMH, IBB, etc.) → Stock
//
// The indicator automatically detects:
// - Sector ETF based on stock's sector classification
// - Industry ETF based on stock's industry classification (30+ industries mapped)
// - Industry Leaders for each specific industry
//
// RS SCORE CALCULATION:
// The score consists of two parts: BASE SCORE + MODIFIERS
//
// BASE SCORE (0-100):
// Starts at 50 (neutral) and adds weighted RS performance values.
//
// For STOCKS (with Industry data):
//   - Sector RS: 60% weight (1M: 24%, 3M: 18%, 6M: 12%, 1Y: 6%)
//   - Industry RS: 40% weight (1M: 16%, 3M: 12%, 6M: 8%, 1Y: 4%)
//
// For OTHER ASSETS (Crypto, Forex, etc.):
//   - Benchmark RS: 100% weight (1M: 40%, 3M: 30%, 6M: 20%, 1Y: 10%)
//
// MODIFIERS (displayed separately):
//   - Hot Sector: +5 (Sector outperforming Market in 1M and 3M)
//   - Hot Industry: +5 (Industry outperforming Sector in 1M and 3M)
//   - Improving Momentum: +5 (1M RS > 3M RS)
//   - Declining Momentum: -5 (1M RS < 3M RS)
//
// FINAL SCORE = Base Score + Modifiers (capped 0-100)
//
// RS methodology is based on classical technical analysis concepts.
// ============================================================================

// ============================================================================
// SECTOR & INDUSTRY RS ANALYZER - Multi-Level Relative Strength Analysis
// ============================================================================
// This indicator provides in-depth analysis of a stock's performance relative
// to its sector ETF, industry ETF, industry leaders, and the broader market (SPY).
// Features automatic ETF/leader mapping with manual override options.
// ============================================================================

// ============================================================================
// STYLE CONFIGURATION
// ============================================================================

// Performance Colors
COLOR_BRIGHT_GREEN = color.lime
COLOR_BRIGHT_RED = #ff5252
COLOR_STANDARD_GREEN = color.lime
COLOR_STANDARD_RED = #ff5252
COLOR_NEUTRAL = #cacaca

// Table Background Colors
COLOR_BG_DATA_CELL = #1a1a1a           // Main data cells
COLOR_BG_HEADER = #0f1419              // Column headers and labels
COLOR_BG_TITLE = #1a1a2e               // Main title row
COLOR_BG_SUBTITLE = #16213e            // Subtitle/info row
COLOR_BG_SECTION_RS = #1a4d4d          // RS section header
COLOR_BG_SECTION_RATING = #4a1a1a      // Rating section header

// Row Label Background Colors
COLOR_BG_STOCK_ROW = #1e3a5f           // Stock/Asset row
COLOR_BG_SECTOR_ROW = #663300          // Sector/Benchmark row
COLOR_BG_MARKET_ROW = #4a1a4a          // Market (SPY) row
COLOR_BG_LEADER_ROW = #5a1a5a          // Sector Leader row
COLOR_BG_INDUSTRY_ROW = #1a5a1a        // Industry ETF row
COLOR_BG_IND_LEADER_ROW = #2a6a2a      // Industry Leader row

// RS Text Colors
COLOR_TEXT_RS_PRIMARY = #ffff00        // vs Sector, vs Market, vs Leader
COLOR_TEXT_RS_ROTATION = #00ffff       // Sector vs Market (rotation)
COLOR_TEXT_RS_INDUSTRY = #90ee90       // vs Industry, vs Industry Leader
COLOR_TEXT_IND_VS_SECTOR = #87ceeb     // Industry vs Sector

// Warning Colors
COLOR_WARNING = #ff6600
COLOR_INFO = #0066cc

// Table Border
COLOR_TABLE_BORDER = #333333           // Border lines between cells
TABLE_BORDER_WIDTH = 1                  // Border thickness (0 = no borders)

// Display Settings
show_table = input.bool(true, "Show Performance Table", group="Display", tooltip="Show/Hide Main Table\n\nTurn the entire performance table on or off.\nWhen off, only chart remains visible.\n\nUse this to reduce clutter when you\njust want the chart view.")
table_position = input.string("Top Right", "Table Position", options=["Top Right", "Top Center", "Top Left", "Middle Left", "Middle Center", "Middle Right", "Bottom Left", "Bottom Center", "Bottom Right"], group="Display", inline="table_layout")
table_size = input.string("Small", "Table Size", options=["Tiny", "Small", "Normal", "Large"], group="Display", inline="table_layout", tooltip="Table Position & Size\n\nPosition: Where table appears on chart\n  (9 locations available)\n\nSize: How large the table displays\n  tiny = Very compact\n  small = Balanced (recommended)\n  normal = Larger text\n  large = Maximum readability")

// Market Benchmark Settings
custom_market_benchmark = input.symbol("", "Custom Market Benchmark", group="Display", tooltip="Custom Market Benchmark\n\nOverride the default market index (SPY) with any other index.\n\nExamples:\n- AMEX:SPY (Default S&P 500)\n- NASDAQ:QQQ (Nasdaq 100)\n- AMEX:IWM (Russell 2000)\n- AMEX:VTI (Total Market)\n- DJI (Dow Jones)\n- FTSE:UKX (FTSE 100)\n- XETR:DAX (DAX)\n- INDEX:NKY (Nikkei 225)\n\nLeave empty to use automatic detection:\n- Stocks/ETFs: SPY\n- Crypto: Total Market Cap\n- Forex: DXY\n- Commodities: DBC")

// Timeframe Settings
timeframe_mode = input.string("Chart Timeframe", "Analysis Timeframe", options=["Chart Timeframe", "1 Hour", "4 Hours", "Daily", "Weekly"], group="Timeframe", tooltip="Analysis Timeframe\n\nWhich timeframe to use for all calculations.\n\nChart Timeframe (recommended):\n  Uses whatever timeframe your chart is on\n  (most flexible option)\n\nFixed Timeframes (1H, 4H, Daily, Weekly):\n  Forces calculations to use that specific\n  timeframe regardless of chart setting.\n\nMost users should use Chart Timeframe.")

// Filtering Settings
min_rs_score = input.float(0.0, "Minimum RS Score", minval=0.0, maxval=100.0, step=5.0, group="Filtering", inline="filter")
show_filter_warning = input.bool(true, "Show Warning", group="Filtering", inline="filter", tooltip="RS Score Filter\n\nOnly show stocks above this RS Score.\n\nSet to 0 = Show all stocks\nSet to 70 = Only strong stocks (70+)\n\nWhen a stock doesn't meet the filter,\na warning message will display instead\nof the table (if 'Show Warning' is on).\n\nUse this to focus only on quality stocks!")

// Alert Settings
enable_alerts = input.bool(false, "Divergence Alerts", group="Alerts", inline="alerts1")
divergence_threshold = input.float(5.0, "Threshold (%)", minval=1.0, maxval=20.0, group="Alerts", inline="alerts1", tooltip="Divergence Alerts\n\nGet notified when stock performance\ndiverges significantly from its sector.\n\nBullish: Stock beating sector by threshold\nBearish: Stock losing to sector by threshold\n\nExample with 5% threshold:\nStock +10%, Sector +3% = +7% difference\n  → Bullish alert fires!\n\nUseful for catching breakouts early.")
enable_rs_score_alerts = input.bool(false, "RS Score Alerts", group="Alerts", inline="alerts2")
rs_alert_threshold = input.float(70.0, "Threshold", minval=50.0, maxval=90.0, step=5.0, group="Alerts", inline="alerts2", tooltip="RS Score Alerts\n\nGet notified when RS Score crosses\nabove or below your threshold.\n\nDefault 70 = Alert on strong stocks\nSet to 80 = Alert only on very strong\nSet to 60 = Alert on above-average\n\nFires when score crosses the level\n(not just when it's above/below).")

// Sector Analysis Settings
use_custom_sector_etf = input.bool(false, "Use Custom Sector ETF", group="Sector Analysis", inline="sector_etf")
custom_sector_etf = input.symbol("", "ETF Symbol", group="Sector Analysis", inline="sector_etf", tooltip="Custom Sector ETF\n\nOverride automatic sector ETF detection.\n\nExamples:\n- XLK for Technology\n- XLF for Financials\n- XLV for Healthcare\n- XLE for Energy\n\nLeave empty for automatic detection\nbased on stock's sector classification.")

use_custom_leader = input.bool(false, "Use Custom Sector Leader", group="Sector Analysis", inline="sector_leader")
custom_leader_symbol = input.symbol("", "Symbol", group="Sector Analysis", inline="sector_leader", tooltip="Custom Sector Leader\n\nOverride automatic sector leader detection.\n\nChoose the strongest stock in the sector.\n\nExamples:\n- AAPL for Technology\n- JPM for Financials\n- UNH for Healthcare\n\nLeave empty for automatic detection.")

// Industry Analysis Settings
use_custom_industry = input.bool(false, "Use Custom Industry ETF", group="Industry Analysis", inline="industry_etf")
custom_industry_etf = input.symbol("", "Symbol", group="Industry Analysis", inline="industry_etf", tooltip="Custom Industry ETF\n\nOverride automatic industry ETF detection.\n\nExamples:\n- IGV for Software\n- IBB for Biotech\n- SMH for Semiconductors\n- XHB for Homebuilders\n\nLeave empty for automatic detection\nbased on stock's industry classification.")

show_industry_analysis = input.bool(true, "Show Industry Analysis in Table", group="Industry ", tooltip="Industry Analysis Toggle\n\nWhen enabled, adds Industry-level analysis\nto the performance table.\n\nThis provides more granular comparison\nthan just Sector analysis.\n\nExample: Software (industry) within\nTechnology (sector)")
use_custom_industry_leader = input.bool(false, "Use Custom Industry Leader", group="Industry Analysis", inline="industry_leader")
custom_industry_leader = input.symbol("", "Symbol", group="Industry Analysis", inline="industry_leader", tooltip="Custom Industry Leader\n\nOverride automatic industry leader detection.\n\nChoose the strongest stock in the specific industry.\n\nExamples:\n- NVDA for Semiconductors\n- AMGN for Biotech\n- LLY for Pharmaceuticals\n\nLeave empty for automatic detection.")


// Data Mode Settings
show_realtime_indicator = input.bool(true, "Show Real-time Indicator ⏳", group="Display", tooltip="Real-time Visual Indicator\n\nIMPORTANT: All data uses lookahead=off,\nso values NEVER repaint regardless of this setting.\n\nWhen ON (default):\n  ⏳ Shows clock icon in header\n  Indicates table updates every tick\n  Values reflect current bar state\n  Good for: Active monitoring\n\nWhen OFF:\n  ✅ No visual indicator (cleaner look)\n  Table still updates every tick\n  Data remains equally reliable\n  Good for: Clean screenshots\n\nThis setting ONLY affects the ⏳ icon,\nnot the data or update frequency.")

// ============================================================================
// ASSET TYPE DETECTION
// ============================================================================

// Automatic asset type detection
asset_type = syminfo.type

// Extract ticker from custom benchmark for comparisons
custom_benchmark_ticker = custom_market_benchmark != "" ?
                          str.upper(array.get(str.split(custom_market_benchmark, ":"), array.size(str.split(custom_market_benchmark, ":")) - 1)) :
                          ""

// Check if current symbol is a major market ETF/index that should be treated as market benchmark
current_ticker_check = str.upper(syminfo.ticker)
is_major_market_etf = (custom_market_benchmark != "" and str.contains(current_ticker_check, custom_benchmark_ticker)) or
                      str.contains(current_ticker_check, "SPY") or
                      str.contains(current_ticker_check, "SPX") or
                      str.contains(current_ticker_check, "QQQ") or
                      str.contains(current_ticker_check, "DIA") or
                      str.contains(current_ticker_check, "IWM") or
                      str.contains(current_ticker_check, "VTI") or
                      str.contains(current_ticker_check, "VOO")

is_stock = asset_type == "stock" and not is_major_market_etf
is_crypto = asset_type == "crypto"
is_forex = asset_type == "forex"
is_commodity = asset_type == "futures" or asset_type == "cfd"
is_index = asset_type == "index" or asset_type == "fund" or is_major_market_etf

// Asset type display name
asset_type_display = is_stock ? "Stock" :
                     is_crypto ? "Crypto" :
                     is_forex ? "Forex" :
                     is_commodity ? "Commodity" :
                     is_index ? "Index" :
                     "Other"

// ============================================================================
// SECTOR ETF & LEADER MAPPING
// ============================================================================

get_sector_etf(string sector) =>
    string etf_symbol = ""
    string sector_lower = str.lower(sector)

    // Technology (catches: Technology, Electronic Technology, Technology Services, etc.)
    if str.contains(sector_lower, "technolog")
        etf_symbol := "AMEX:XLK"
    // Financial (catches: Financial, Finance, Financial Services, etc.)
    else if str.contains(sector_lower, "financ")
        etf_symbol := "AMEX:XLF"
    // Healthcare (catches: Healthcare, Health Care, Health Services, Health Technology, etc.)
    else if str.contains(sector_lower, "health")
        etf_symbol := "AMEX:XLV"
    // Energy (catches: Energy, Energy Minerals, etc.)
    else if str.contains(sector_lower, "energy")
        etf_symbol := "AMEX:XLE"
    // Consumer (catches: Consumer Cyclical, Consumer Defensive, Consumer Services, Consumer Non-Cyclical, etc.)
    else if str.contains(sector_lower, "consumer")
        // Distinguish between Consumer Cyclical and Consumer Defensive
        if str.contains(sector_lower, "cyclical") or str.contains(sector_lower, "discretionary")
            etf_symbol := "AMEX:XLY"
        else if str.contains(sector_lower, "defensive") or str.contains(sector_lower, "staples") or str.contains(sector_lower, "non-cyclical")
            etf_symbol := "AMEX:XLP"
        else
            etf_symbol := "AMEX:XLY"  // Default to cyclical
    // Industrial (catches: Industrial, Industrials, Industrial Services, etc.)
    else if str.contains(sector_lower, "industr")
        etf_symbol := "AMEX:XLI"
    // Basic Materials (catches: Basic Materials, Materials, etc.)
    else if str.contains(sector_lower, "material")
        etf_symbol := "AMEX:XLB"
    // Real Estate
    else if str.contains(sector_lower, "real estate")
        etf_symbol := "AMEX:XLRE"
    // Utilities
    else if str.contains(sector_lower, "utilit")
        etf_symbol := "AMEX:XLU"
    // Communication Services (catches: Communication, Communications, Telecommunications, etc.)
    else if str.contains(sector_lower, "communicat") or str.contains(sector_lower, "telecom")
        etf_symbol := "AMEX:XLC"
    // Transportation (may fall under Industrials - XLI)
    else if str.contains(sector_lower, "transportation")
        etf_symbol := "AMEX:XLI"
    // Retail Trade (may fall under Consumer Cyclical - XLY)
    else if str.contains(sector_lower, "retail")
        etf_symbol := "AMEX:XLY"
    // Distribution Services (may fall under Industrials - XLI)
    else if str.contains(sector_lower, "distribution")
        etf_symbol := "AMEX:XLI"

    etf_symbol

// Get sector leader stock
get_sector_leader(string sector) =>
    string leader = ""
    string sector_lower = str.lower(sector)

    // Technology sector leaders
    if str.contains(sector_lower, "technolog")
        leader := "NASDAQ:AAPL"  // Apple - Tech leader
    // Financial sector leaders
    else if str.contains(sector_lower, "financ")
        leader := "NYSE:JPM"  // JPMorgan Chase - Financial leader
    // Healthcare sector leaders
    else if str.contains(sector_lower, "health")
        leader := "NYSE:UNH"  // UnitedHealth - Healthcare leader
    // Energy sector leaders
    else if str.contains(sector_lower, "energy")
        leader := "NYSE:XOM"  // ExxonMobil - Energy leader
    // Consumer sector leaders
    else if str.contains(sector_lower, "consumer")
        if str.contains(sector_lower, "cyclical") or str.contains(sector_lower, "discretionary")
            leader := "NASDAQ:AMZN"  // Amazon - Consumer Discretionary leader
        else if str.contains(sector_lower, "defensive") or str.contains(sector_lower, "staples")
            leader := "NYSE:WMT"  // Walmart - Consumer Staples leader
        else
            leader := "NASDAQ:AMZN"  // Default to Amazon
    // Industrial sector leaders
    else if str.contains(sector_lower, "industr")
        leader := "NYSE:CAT"  // Caterpillar - Industrial leader
    // Materials sector leaders
    else if str.contains(sector_lower, "material")
        leader := "NYSE:APD"  // Air Products - Materials leader
    // Real Estate sector leaders
    else if str.contains(sector_lower, "real estate")
        leader := "NYSE:PLD"  // Prologis - Real Estate leader
    // Utilities sector leaders
    else if str.contains(sector_lower, "utilit")
        leader := "NYSE:NEE"  // NextEra Energy - Utilities leader
    // Communication Services sector leaders
    else if str.contains(sector_lower, "communicat") or str.contains(sector_lower, "telecom")
        leader := "NASDAQ:META"  // Meta - Communication Services leader
    // Transportation
    else if str.contains(sector_lower, "transportation")
        leader := "NYSE:UPS"  // UPS - Transportation leader
    // Retail
    else if str.contains(sector_lower, "retail")
        leader := "NASDAQ:AMZN"  // Amazon - Retail leader

    leader

// Get industry ETF based on industry name
get_industry_etf(string industry) =>
    string etf_symbol = ""
    string industry_lower = str.lower(industry)

    // TECHNOLOGY INDUSTRIES
    if str.contains(industry_lower, "software") and (str.contains(industry_lower, "application") or str.contains(industry_lower, "infrastructure"))
        etf_symbol := "AMEX:IGV"
    else if str.contains(industry_lower, "software")
        etf_symbol := "AMEX:IGV"
    else if str.contains(industry_lower, "semiconductor")
        etf_symbol := "NASDAQ:SMH"
    else if str.contains(industry_lower, "internet") or str.contains(industry_lower, "cloud")
        etf_symbol := "NASDAQ:SKYY"
    else if str.contains(industry_lower, "cyber") or (str.contains(industry_lower, "security") and str.contains(industry_lower, "software"))
        etf_symbol := "NASDAQ:HACK"
    else if str.contains(industry_lower, "biotech")
        etf_symbol := "NASDAQ:IBB"
    else if str.contains(industry_lower, "pharmac") or str.contains(industry_lower, "drug")
        etf_symbol := "AMEX:XPH"
    else if str.contains(industry_lower, "medical device") or str.contains(industry_lower, "medical equipment")
        etf_symbol := "AMEX:IHI"
    else if str.contains(industry_lower, "health") and str.contains(industry_lower, "service")
        etf_symbol := "AMEX:IHF"
    else if str.contains(industry_lower, "bank") and not str.contains(industry_lower, "regional")
        etf_symbol := "AMEX:KBE"
    else if str.contains(industry_lower, "regional") and str.contains(industry_lower, "bank")
        etf_symbol := "AMEX:KRE"
    else if str.contains(industry_lower, "insurance")
        etf_symbol := "AMEX:KIE"
    else if str.contains(industry_lower, "asset management") or str.contains(industry_lower, "investment")
        etf_symbol := "AMEX:IAI"
    else if str.contains(industry_lower, "oil") and (str.contains(industry_lower, "exploration") or str.contains(industry_lower, "production"))
        etf_symbol := "AMEX:XOP"
    else if str.contains(industry_lower, "oil") and (str.contains(industry_lower, "equipment") or str.contains(industry_lower, "service"))
        etf_symbol := "AMEX:XES"
    else if str.contains(industry_lower, "solar") or str.contains(industry_lower, "clean") or str.contains(industry_lower, "renewable")
        etf_symbol := "NASDAQ:TAN"
    else if str.contains(industry_lower, "retail")
        etf_symbol := "AMEX:XRT"
    else if str.contains(industry_lower, "homebuilder") or str.contains(industry_lower, "residential construction")
        etf_symbol := "AMEX:XHB"
    else if str.contains(industry_lower, "restaurant") or str.contains(industry_lower, "food service")
        etf_symbol := "AMEX:PBJ"
    else if str.contains(industry_lower, "apparel") or str.contains(industry_lower, "fashion")
        etf_symbol := "AMEX:XRT"
    else if str.contains(industry_lower, "aerospace") or str.contains(industry_lower, "defense")
        etf_symbol := "AMEX:ITA"
    else if str.contains(industry_lower, "transport") or str.contains(industry_lower, "trucking") or str.contains(industry_lower, "logistics")
        etf_symbol := "AMEX:IYT"
    else if str.contains(industry_lower, "airline")
        etf_symbol := "AMEX:JETS"
    else if str.contains(industry_lower, "construction") or str.contains(industry_lower, "engineering")
        etf_symbol := "AMEX:PKB"
    else if str.contains(industry_lower, "gold")
        etf_symbol := "AMEX:GDX"
    else if str.contains(industry_lower, "metal") or str.contains(industry_lower, "mining")
        etf_symbol := "AMEX:XME"
    else if str.contains(industry_lower, "steel")
        etf_symbol := "AMEX:SLX"
    else if str.contains(industry_lower, "chemical")
        etf_symbol := "AMEX:XLB"
    else if str.contains(industry_lower, "reit")
        etf_symbol := "AMEX:VNQ"
    else if str.contains(industry_lower, "media") or str.contains(industry_lower, "entertainment") or str.contains(industry_lower, "broadcast")
        etf_symbol := "AMEX:XLC"  // Communication Services sector ETF as media proxy
    else if str.contains(industry_lower, "telecom")
        etf_symbol := "AMEX:IYZ"

    etf_symbol

// Get industry leader stock
get_industry_leader(string industry) =>
    string leader = ""
    string industry_lower = str.lower(industry)

    if str.contains(industry_lower, "software") and str.contains(industry_lower, "application")
        leader := "NASDAQ:MSFT"
    else if str.contains(industry_lower, "software") and str.contains(industry_lower, "infrastructure")
        leader := "NASDAQ:ORCL"
    else if str.contains(industry_lower, "software")
        leader := "NASDAQ:MSFT"
    else if str.contains(industry_lower, "semiconductor")
        leader := "NASDAQ:NVDA"
    else if str.contains(industry_lower, "internet")
        leader := "NASDAQ:GOOGL"
    else if str.contains(industry_lower, "cloud")
        leader := "NASDAQ:AMZN"
    else if str.contains(industry_lower, "cyber") or str.contains(industry_lower, "security")
        leader := "NASDAQ:CRWD"
    else if str.contains(industry_lower, "biotech")
        leader := "NASDAQ:AMGN"
    else if str.contains(industry_lower, "pharmac") or str.contains(industry_lower, "drug")
        leader := "NYSE:LLY"
    else if str.contains(industry_lower, "medical device") or str.contains(industry_lower, "medical equipment")
        leader := "NYSE:MDT"
    else if str.contains(industry_lower, "health") and str.contains(industry_lower, "service")
        leader := "NYSE:UNH"
    else if str.contains(industry_lower, "bank") and not str.contains(industry_lower, "regional")
        leader := "NYSE:JPM"
    else if str.contains(industry_lower, "regional")
        leader := "NYSE:PNC"
    else if str.contains(industry_lower, "insurance")
        leader := "NYSE:BRK.B"
    else if str.contains(industry_lower, "asset management") or str.contains(industry_lower, "investment")
        leader := "NYSE:BLK"
    else if str.contains(industry_lower, "oil") and (str.contains(industry_lower, "exploration") or str.contains(industry_lower, "production"))
        leader := "NYSE:COP"
    else if str.contains(industry_lower, "oil") and (str.contains(industry_lower, "equipment") or str.contains(industry_lower, "service"))
        leader := "NYSE:SLB"
    else if str.contains(industry_lower, "solar")
        leader := "NASDAQ:ENPH"
    else if str.contains(industry_lower, "clean") or str.contains(industry_lower, "renewable")
        leader := "NYSE:NEE"
    else if str.contains(industry_lower, "retail") and str.contains(industry_lower, "internet")
        leader := "NASDAQ:AMZN"
    else if str.contains(industry_lower, "retail")
        leader := "NYSE:WMT"
    else if str.contains(industry_lower, "homebuilder") or str.contains(industry_lower, "residential construction")
        leader := "NYSE:DHI"
    else if str.contains(industry_lower, "restaurant")
        leader := "NYSE:MCD"
    else if str.contains(industry_lower, "apparel")
        leader := "NYSE:NKE"
    else if str.contains(industry_lower, "aerospace") or str.contains(industry_lower, "defense")
        leader := "NYSE:LMT"
    else if str.contains(industry_lower, "airline")
        leader := "NYSE:DAL"
    else if str.contains(industry_lower, "transport") or str.contains(industry_lower, "trucking")
        leader := "NYSE:UNP"
    else if str.contains(industry_lower, "construction")
        leader := "NYSE:CAT"
    else if str.contains(industry_lower, "gold")
        leader := "NYSE:NEM"
    else if str.contains(industry_lower, "metal") or str.contains(industry_lower, "mining")
        leader := "NYSE:FCX"
    else if str.contains(industry_lower, "steel")
        leader := "NYSE:NUE"
    else if str.contains(industry_lower, "chemical")
        leader := "NYSE:APD"
    else if str.contains(industry_lower, "reit")
        leader := "NYSE:PLD"
    else if str.contains(industry_lower, "media") or str.contains(industry_lower, "entertainment")
        leader := "NYSE:DIS"
    else if str.contains(industry_lower, "telecom")
        leader := "NYSE:T"

    leader

// Get alternative industry leader if primary is current symbol
get_alternative_industry_leader(string industry) =>
    string alt_leader = ""
    string industry_lower = str.lower(industry)
    // Note: syminfo.ticker returns clean ticker without exchange prefix (e.g., "NVDA" not "NASDAQ:NVDA")

    if str.contains(industry_lower, "software")
        alt_leader := syminfo.ticker == "MSFT" ? "NYSE:CRM" : syminfo.ticker == "CRM" ? "NASDAQ:ADBE" : syminfo.ticker == "ADBE" ? "NASDAQ:NOW" : "NASDAQ:ADBE"
    else if str.contains(industry_lower, "semiconductor")
        alt_leader := syminfo.ticker == "NVDA" ? "NASDAQ:AMD" : syminfo.ticker == "AMD" ? "NASDAQ:AVGO" : syminfo.ticker == "AVGO" ? "NASDAQ:QCOM" : "NASDAQ:AVGO"
    else if str.contains(industry_lower, "biotech")
        alt_leader := syminfo.ticker == "AMGN" ? "NASDAQ:GILD" : syminfo.ticker == "GILD" ? "NASDAQ:VRTX" : syminfo.ticker == "VRTX" ? "NASDAQ:BIIB" : "NASDAQ:VRTX"
    else if str.contains(industry_lower, "pharmac")
        alt_leader := syminfo.ticker == "LLY" ? "NYSE:PFE" : syminfo.ticker == "PFE" ? "NYSE:JNJ" : syminfo.ticker == "JNJ" ? "NYSE:MRK" : "NYSE:JNJ"
    else if str.contains(industry_lower, "bank")
        alt_leader := syminfo.ticker == "JPM" ? "NYSE:BAC" : syminfo.ticker == "BAC" ? "NYSE:WFC" : syminfo.ticker == "WFC" ? "NYSE:C" : "NYSE:WFC"
    else if str.contains(industry_lower, "oil")
        alt_leader := syminfo.ticker == "COP" ? "NYSE:EOG" : syminfo.ticker == "EOG" ? "NYSE:PXD" : syminfo.ticker == "PXD" ? "NYSE:CVX" : "NYSE:EOG"
    else if str.contains(industry_lower, "retail")
        alt_leader := syminfo.ticker == "WMT" ? "NYSE:TGT" : syminfo.ticker == "TGT" ? "NASDAQ:COST" : syminfo.ticker == "COST" ? "NYSE:HD" : "NASDAQ:COST"

    alt_leader

// ============================================================================
// MULTI-ASSET BENCHMARK FUNCTIONS
// ============================================================================

// Get crypto benchmark (Total Crypto Market Cap)
get_crypto_benchmark() =>
    "CRYPTOCAP:TOTAL"

// Get forex benchmark (based on base currency)
get_forex_benchmark() =>
    string benchmark = "TVC:DXY"  // Default to US Dollar Index
    string base = syminfo.basecurrency

    // Check base currency and return appropriate index
    if base == "EUR"
        benchmark := "TVC:EXY"  // Euro Index
    else if base == "GBP"
        benchmark := "TVC:BXY"  // British Pound Index
    else if base == "JPY"
        benchmark := "TVC:JXY"  // Japanese Yen Index
    else if base == "AUD"
        benchmark := "TVC:AXY"  // Australian Dollar Index
    else if base == "CAD"
        benchmark := "TVC:CXY"  // Canadian Dollar Index
    else if base == "CHF"
        benchmark := "TVC:SXY"  // Swiss Franc Index
    else
        benchmark := "TVC:DXY"  // Default to Dollar Index

    benchmark

// Get commodity benchmark (Gold as primary commodity benchmark)
get_commodity_benchmark() =>
    "AMEX:GLD"  // SPDR Gold Trust ETF

// Get index benchmark
get_index_benchmark() =>
    // Get the default market symbol
    default_market = custom_market_benchmark != "" ? custom_market_benchmark : "AMEX:SPY"

    // Extract ticker from custom benchmark for comparison
    custom_ticker = custom_market_benchmark != "" ? str.upper(array.get(str.split(custom_market_benchmark, ":"), array.size(str.split(custom_market_benchmark, ":")) - 1)) : ""

    // If current symbol is the benchmark itself, return empty (can't compare to itself)
    current_is_benchmark = (custom_market_benchmark != "" and (str.contains(str.upper(syminfo.ticker), custom_ticker) or syminfo.ticker == custom_market_benchmark)) or (custom_market_benchmark == "" and (str.contains(str.upper(syminfo.ticker), "SPY") or str.contains(str.upper(syminfo.ticker), "SPX") or str.contains(str.upper(syminfo.ticker), "VOO") or str.contains(str.upper(syminfo.ticker), "VTI")))

    current_is_benchmark ? "" : default_market

// Universal benchmark getter - calls appropriate function based on asset type
get_benchmark_symbol() =>
    string benchmark = ""

    if is_stock
        // Check if custom sector ETF is enabled
        if use_custom_sector_etf and custom_sector_etf != ""
            benchmark := custom_sector_etf
        else
            benchmark := get_sector_etf(syminfo.sector)
    else if is_crypto
        benchmark := get_crypto_benchmark()
    else if is_forex
        benchmark := get_forex_benchmark()
    else if is_commodity
        benchmark := get_commodity_benchmark()
    else if is_index
        benchmark := get_index_benchmark()
    else
        benchmark := ""  // Unknown asset type

    benchmark

// ============================================================================
// MULTI-ASSET LEADER FUNCTIONS
// ============================================================================

// Get crypto leader (Bitcoin)
get_crypto_leader() =>
    "BINANCE:BTCUSDT"  // Bitcoin as crypto market leader

// Get forex leader (major pair based on base currency)
get_forex_leader() =>
    string leader = "FX:EURUSD"  // Default with prefix
    string base = syminfo.basecurrency
    string quote = syminfo.currency

    // Build current ticker without prefix for comparison
    current_forex_pair = base + quote

    // Return the most liquid major pair for each currency
    if base == "EUR"
        leader := current_forex_pair == "EURUSD" ? "" : "FX:EURUSD"
    else if base == "GBP"
        leader := current_forex_pair == "GBPUSD" ? "" : "FX:GBPUSD"
    else if base == "JPY"
        leader := current_forex_pair == "USDJPY" ? "" : "FX:USDJPY"
    else if base == "AUD"
        leader := current_forex_pair == "AUDUSD" ? "" : "FX:AUDUSD"
    else if base == "USD"
        leader := current_forex_pair == "EURUSD" ? "" : "FX:EURUSD"  // Compare USD pairs to EUR/USD
    else if base == "NZD"
        leader := current_forex_pair == "NZDUSD" ? "" : "FX:NZDUSD"
    else if base == "CAD"
        leader := current_forex_pair == "USDCAD" ? "" : "FX:USDCAD"
    else if base == "CHF"
        leader := current_forex_pair == "USDCHF" ? "" : "FX:USDCHF"
    else
        leader := "FX:EURUSD"

    leader

// Get commodity leader (Gold as primary commodity)
get_commodity_leader() =>
    "COMEX:GC1!"  // Gold futures - most liquid commodity

// Get index leader
get_index_leader() =>
    // Get the default market symbol
    default_market = custom_market_benchmark != "" ? custom_market_benchmark : "AMEX:SPY"

    // Extract ticker from custom benchmark for comparison
    custom_ticker = custom_market_benchmark != "" ? str.upper(array.get(str.split(custom_market_benchmark, ":"), array.size(str.split(custom_market_benchmark, ":")) - 1)) : ""

    // If current symbol is the benchmark itself, return empty (can't compare to itself)
    current_is_benchmark = (custom_market_benchmark != "" and (str.contains(str.upper(syminfo.ticker), custom_ticker) or syminfo.ticker == custom_market_benchmark)) or (custom_market_benchmark == "" and (str.contains(str.upper(syminfo.ticker), "SPY") or str.contains(str.upper(syminfo.ticker), "SPX") or str.contains(str.upper(syminfo.ticker), "VOO") or str.contains(str.upper(syminfo.ticker), "VTI")))

    current_is_benchmark ? "" : default_market

// Get alternative leader if primary leader is the current symbol
get_alternative_leader(string sector) =>
    string alt_leader = ""
    string sector_lower = str.lower(sector)

    // Technology alternatives
    if str.contains(sector_lower, "technolog")
        alt_leader := syminfo.ticker == "AAPL" ? "NASDAQ:MSFT" : "NASDAQ:NVDA"
    // Financial alternatives
    else if str.contains(sector_lower, "financ")
        alt_leader := syminfo.ticker == "JPM" ? "NYSE:BAC" : "NYSE:WFC"
    // Healthcare alternatives
    else if str.contains(sector_lower, "health")
        alt_leader := syminfo.ticker == "UNH" ? "NYSE:JNJ" : "NYSE:LLY"
    // Energy alternatives
    else if str.contains(sector_lower, "energy")
        alt_leader := syminfo.ticker == "XOM" ? "NYSE:CVX" : "NYSE:COP"
    // Consumer alternatives
    else if str.contains(sector_lower, "consumer")
        if str.contains(sector_lower, "cyclical") or str.contains(sector_lower, "discretionary")
            alt_leader := syminfo.ticker == "AMZN" ? "NASDAQ:TSLA" : "NYSE:HD"
        else
            alt_leader := syminfo.ticker == "WMT" ? "NYSE:PG" : "NYSE:KO"
    // Industrial alternatives
    else if str.contains(sector_lower, "industr")
        alt_leader := syminfo.ticker == "CAT" ? "NYSE:BA" : "NYSE:GE"
    // Materials alternatives
    else if str.contains(sector_lower, "material")
        alt_leader := syminfo.ticker == "APD" ? "NYSE:SHW" : "NYSE:ECL"
    // Real Estate alternatives
    else if str.contains(sector_lower, "real estate")
        alt_leader := syminfo.ticker == "PLD" ? "NYSE:AMT" : "NYSE:EQIX"
    // Utilities alternatives
    else if str.contains(sector_lower, "utilit")
        alt_leader := syminfo.ticker == "NEE" ? "NYSE:DUK" : "NYSE:SO"
    // Communication alternatives
    else if str.contains(sector_lower, "communicat") or str.contains(sector_lower, "telecom")
        alt_leader := syminfo.ticker == "META" ? "NASDAQ:GOOGL" : "NYSE:DIS"

    alt_leader

// Universal leader getter - calls appropriate function based on asset type
get_leader_symbol() =>
    string leader = ""

    // Check if custom leader is enabled and not empty
    if use_custom_leader and custom_leader_symbol != ""
        leader := custom_leader_symbol
    else if is_stock
        leader := get_sector_leader(syminfo.sector)
        // Check if leader is the current symbol, use alternative if so
        if leader != "" and str.contains(leader, ":")
            leader_parts = str.split(leader, ":")
            leader_ticker_temp = array.size(leader_parts) > 1 ? array.get(leader_parts, 1) : ""
            if leader_ticker_temp == syminfo.ticker
                leader := get_alternative_leader(syminfo.sector)
    else if is_crypto
        leader := get_crypto_leader()
        // If current symbol is BTC, use ETH as alternative
        if str.contains(str.upper(syminfo.ticker), "BTC")
            leader := "BINANCE:ETHUSDT"
    else if is_forex
        leader := get_forex_leader()
    else if is_commodity
        leader := get_commodity_leader()
    else if is_index
        leader := get_index_leader()
    else
        leader := ""  // Unknown asset type

    leader

// ============================================================================
// GET BENCHMARK, LEADER, AND MARKET SYMBOL
// ============================================================================

// Get appropriate benchmark and leader based on asset type
benchmark_symbol = get_benchmark_symbol()
leader_symbol = get_leader_symbol()

// Get appropriate market benchmark based on asset type
// Use custom benchmark if provided, otherwise use defaults
market_symbol = custom_market_benchmark != "" ? custom_market_benchmark : is_crypto ? "CRYPTOCAP:TOTAL" : is_forex ? "TVC:DXY" : is_commodity ? "AMEX:DBC" : "AMEX:SPY"  // Default for stocks and indices

// Get industry ETF and leader symbols (only for stocks)
get_industry_etf_symbol() =>
    string industry_etf = ""
    if is_stock and show_industry_analysis
        if use_custom_industry and custom_industry_etf != ""
            industry_etf := custom_industry_etf
        else
            industry_etf := get_industry_etf(syminfo.industry)
    industry_etf

get_industry_leader_symbol() =>
    string ind_leader = ""
    if is_stock and show_industry_analysis
        if use_custom_industry_leader and custom_industry_leader != ""
            ind_leader := custom_industry_leader
        else
            ind_leader := get_industry_leader(syminfo.industry)
            // Check if leader is current symbol
            if ind_leader != "" and str.contains(ind_leader, ":")
                ind_leader_parts = str.split(ind_leader, ":")
                ind_leader_ticker_temp = array.size(ind_leader_parts) > 1 ? array.get(ind_leader_parts, 1) : ""
                if ind_leader_ticker_temp == syminfo.ticker
                    ind_leader := get_alternative_industry_leader(syminfo.industry)
    ind_leader

industry_etf_symbol = get_industry_etf_symbol()
industry_leader_symbol = get_industry_leader_symbol()

// ============================================================================
// HELPER FUNCTION - Compare symbols intelligently
// ============================================================================

// Compare two symbols to check if they refer to the same asset
// Handles different formats (e.g., "AMEX:SPY" vs "SPY" vs current ticker)
is_same_symbol(string symbol1, string symbol2) =>
    if symbol1 == "" or symbol2 == ""
        false
    else
        // Extract ticker from full symbol (e.g., "AMEX:SPY" -> "SPY")
        parts1 = str.split(symbol1, ":")
        ticker1 = array.size(parts1) > 1 ? str.upper(array.get(parts1, 1)) : str.upper(symbol1)

        parts2 = str.split(symbol2, ":")
        ticker2 = array.size(parts2) > 1 ? str.upper(array.get(parts2, 1)) : str.upper(symbol2)

        // Also check current symbol ticker
        current = str.upper(syminfo.ticker)

        // Return true if any tickers match
        ticker1 == ticker2 or symbol1 == symbol2

// ============================================================================
// DETERMINE WHICH ROWS ARE RELEVANT
// ============================================================================

// Check if current ticker is the market benchmark (e.g., SPY comparing to SPY)
current_ticker_upper = str.upper(syminfo.ticker)
market_ticker_parts = str.split(market_symbol, ":")
market_ticker = array.size(market_ticker_parts) > 1 ? str.upper(array.get(market_ticker_parts, 1)) : str.upper(market_symbol)

// Check if current symbol matches market benchmark
is_market_benchmark = str.contains(current_ticker_upper, market_ticker) or
                      (is_index and (str.contains(current_ticker_upper, "SPY") or
                                     str.contains(current_ticker_upper, "SPX") or
                                     str.contains(current_ticker_upper, "SP500"))) or
                      is_same_symbol(syminfo.tickerid, market_symbol)

// Extract ticker from benchmark_symbol for comparison
benchmark_ticker_parts = str.split(benchmark_symbol, ":")
benchmark_ticker = array.size(benchmark_ticker_parts) > 1 ? str.upper(array.get(benchmark_ticker_parts, 1)) : str.upper(benchmark_symbol)

// Extract ticker from leader_symbol for comparison
leader_ticker_parts = str.split(leader_symbol, ":")
leader_ticker = array.size(leader_ticker_parts) > 1 ? str.upper(array.get(leader_ticker_parts, 1)) : str.upper(leader_symbol)

// Check if benchmark is valid and different from current asset
has_valid_benchmark = benchmark_symbol != "" and
                      benchmark_symbol != syminfo.tickerid and
                      benchmark_ticker != current_ticker_upper and
                      not is_same_symbol(benchmark_symbol, market_symbol)

// Check if leader is valid and different from current asset
has_valid_leader = leader_symbol != "" and
                   leader_symbol != syminfo.tickerid and
                   leader_ticker != current_ticker_upper and
                   not is_same_symbol(leader_symbol, market_symbol) and
                   not is_same_symbol(leader_symbol, benchmark_symbol)

// Check if benchmark vs market comparison makes sense
benchmark_different_from_market = benchmark_symbol != "" and
                                   not is_same_symbol(benchmark_symbol, market_symbol) and
                                   not is_market_benchmark

// Determine which rows to show (true = show, false = hide row)
show_market_row = not is_market_benchmark
show_vs_market_row = not is_market_benchmark
show_benchmark_row = has_valid_benchmark
show_vs_benchmark_row = has_valid_benchmark
show_benchmark_vs_market_row = has_valid_benchmark and benchmark_different_from_market and not is_market_benchmark
show_leader_row = has_valid_leader
show_vs_leader_row = has_valid_leader

// Industry-specific row visibility
industry_etf_ticker_parts = str.split(industry_etf_symbol, ":")
industry_etf_ticker = array.size(industry_etf_ticker_parts) > 1 ? str.upper(array.get(industry_etf_ticker_parts, 1)) : str.upper(industry_etf_symbol)

industry_leader_ticker_parts = str.split(industry_leader_symbol, ":")
industry_leader_ticker = array.size(industry_leader_ticker_parts) > 1 ? str.upper(array.get(industry_leader_ticker_parts, 1)) : str.upper(industry_leader_symbol)

has_valid_industry_etf = industry_etf_symbol != "" and industry_etf_ticker != current_ticker_upper and not is_same_symbol(industry_etf_symbol, benchmark_symbol) and not is_same_symbol(industry_etf_symbol, market_symbol)

has_valid_industry_leader = industry_leader_symbol != "" and industry_leader_ticker != current_ticker_upper and not is_same_symbol(industry_leader_symbol, leader_symbol) and not is_same_symbol(industry_leader_symbol, benchmark_symbol)

show_industry_etf_row = show_industry_analysis and is_stock and has_valid_industry_etf
show_vs_industry_row = show_industry_analysis and is_stock and has_valid_industry_etf
show_industry_vs_sector_row = show_industry_analysis and is_stock and has_valid_industry_etf and has_valid_benchmark
show_industry_leader_row = show_industry_analysis and is_stock and has_valid_industry_leader
show_vs_industry_leader_row = show_industry_analysis and is_stock and has_valid_industry_leader

// ============================================================================
// TIMEFRAME SELECTION
// ============================================================================

selected_tf = timeframe_mode == "Chart Timeframe" ? timeframe.period :
              timeframe_mode == "1 Hour" ? "60" :
              timeframe_mode == "4 Hours" ? "240" :
              timeframe_mode == "Daily" ? "D" :
              "W"  // Weekly

// Determine effective timeframe type (for bars_back calculations)
// When "Chart Timeframe" is selected, detect the timeframe type automatically
effective_tf_type = timeframe_mode == "Chart Timeframe" ? (selected_tf == "60" or selected_tf == "1H" ? "1 Hour" : selected_tf == "240" or selected_tf == "4H" ? "4 Hours" : selected_tf == "D" or selected_tf == "1D" or timeframe.isdaily ? "Daily" : selected_tf == "W" or selected_tf == "1W" or timeframe.isweekly ? "Weekly" : "Daily") : timeframe_mode

// ============================================================================
// TIME PERIOD DEFINITIONS (bars back for each timeframe)
// ============================================================================

// Calculate bars back based on timeframe
// 1 Hour: ~6.5 trading hours per day
// 4 Hours: ~1.6 bars per day
// Daily: 1 bar per day
// Weekly: ~0.2 bars per day

bars_1m = effective_tf_type == "1 Hour" ? 160 :    // 1M: ~30 days * 6.5 hours
          effective_tf_type == "4 Hours" ? 40 :    // 1M: ~30 days * 1.6 bars
          effective_tf_type == "Daily" ? 21 :      // 1M: ~21 trading days
          4                                         // 1M: ~4 weeks

bars_3m = effective_tf_type == "1 Hour" ? 480 :    // 3M: ~90 days * 6.5 hours
          effective_tf_type == "4 Hours" ? 120 :   // 3M: ~90 days * 1.6 bars
          effective_tf_type == "Daily" ? 63 :      // 3M: ~63 trading days
          13                                        // 3M: ~13 weeks

bars_6m = effective_tf_type == "1 Hour" ? 960 :    // 6M: ~180 days * 6.5 hours
          effective_tf_type == "4 Hours" ? 240 :   // 6M: ~180 days * 1.6 bars
          effective_tf_type == "Daily" ? 126 :     // 6M: ~126 trading days
          26                                        // 6M: ~26 weeks

bars_1y = effective_tf_type == "1 Hour" ? 1920 :   // 1Y: ~360 days * 6.5 hours
          effective_tf_type == "4 Hours" ? 480 :   // 1Y: ~360 days * 1.6 bars
          effective_tf_type == "Daily" ? 252 :     // 1Y: ~252 trading days
          52                                        // 1Y: ~52 weeks

// ============================================================================
// CALCULATE PERFORMANCE FOR ALL PERIODS (OPTIMIZED)
// ============================================================================

// OPTIMIZED: Use helper function for batch performance calculations
calc_all_periods() =>
    perf_1m = close[0] != 0 and not na(close[bars_1m]) and close[bars_1m] != 0 ? ((close[0] - close[bars_1m]) / close[bars_1m]) * 100 : na
    perf_3m = close[0] != 0 and not na(close[bars_3m]) and close[bars_3m] != 0 ? ((close[0] - close[bars_3m]) / close[bars_3m]) * 100 : na
    perf_6m = close[0] != 0 and not na(close[bars_6m]) and close[bars_6m] != 0 ? ((close[0] - close[bars_6m]) / close[bars_6m]) * 100 : na
    perf_1y = close[0] != 0 and not na(close[bars_1y]) and close[bars_1y] != 0 ? ((close[0] - close[bars_1y]) / close[bars_1y]) * 100 : na
    [perf_1m, perf_3m, perf_6m, perf_1y]

// Stock Performance (single call for all 4 periods)
[stock_perf_1m, stock_perf_3m, stock_perf_6m, stock_perf_1y] = request.security(syminfo.tickerid, selected_tf, calc_all_periods(), lookahead=barmerge.lookahead_off)

// Benchmark Performance (single call for all 4 periods - optimized)
var float benchmark_perf_1m = na
var float benchmark_perf_3m = na
var float benchmark_perf_6m = na
var float benchmark_perf_1y = na
if benchmark_symbol != ""
    [temp_bm_1m, temp_bm_3m, temp_bm_6m, temp_bm_1y] = request.security(benchmark_symbol, selected_tf, calc_all_periods(), lookahead=barmerge.lookahead_off)
    benchmark_perf_1m := temp_bm_1m
    benchmark_perf_3m := temp_bm_3m
    benchmark_perf_6m := temp_bm_6m
    benchmark_perf_1y := temp_bm_1y

// Market Performance (single call for all 4 periods)
[market_perf_1m, market_perf_3m, market_perf_6m, market_perf_1y] = request.security(market_symbol, selected_tf, calc_all_periods(), lookahead=barmerge.lookahead_off)

// Leader Performance (single call for all 4 periods - optimized)
var float leader_perf_1m = na
var float leader_perf_3m = na
var float leader_perf_6m = na
var float leader_perf_1y = na
if leader_symbol != ""
    [temp_ld_1m, temp_ld_3m, temp_ld_6m, temp_ld_1y] = request.security(leader_symbol, selected_tf, calc_all_periods(), lookahead=barmerge.lookahead_off)
    leader_perf_1m := temp_ld_1m
    leader_perf_3m := temp_ld_3m
    leader_perf_6m := temp_ld_6m
    leader_perf_1y := temp_ld_1y

// Industry ETF Performance (single call for all 4 periods - optimized)
var float industry_etf_perf_1m = na
var float industry_etf_perf_3m = na
var float industry_etf_perf_6m = na
var float industry_etf_perf_1y = na
if industry_etf_symbol != ""
    [temp_ie_1m, temp_ie_3m, temp_ie_6m, temp_ie_1y] = request.security(industry_etf_symbol, selected_tf, calc_all_periods(), lookahead=barmerge.lookahead_off)
    industry_etf_perf_1m := temp_ie_1m
    industry_etf_perf_3m := temp_ie_3m
    industry_etf_perf_6m := temp_ie_6m
    industry_etf_perf_1y := temp_ie_1y

// Industry Leader Performance (single call for all 4 periods - optimized)
var float industry_leader_perf_1m = na
var float industry_leader_perf_3m = na
var float industry_leader_perf_6m = na
var float industry_leader_perf_1y = na
if industry_leader_symbol != ""
    [temp_il_1m, temp_il_3m, temp_il_6m, temp_il_1y] = request.security(industry_leader_symbol, selected_tf, calc_all_periods(), lookahead=barmerge.lookahead_off)
    industry_leader_perf_1m := temp_il_1m
    industry_leader_perf_3m := temp_il_3m
    industry_leader_perf_6m := temp_il_6m
    industry_leader_perf_1y := temp_il_1y

// ============================================================================
// DATA VALIDATION - Hide rows if symbol data is invalid/unavailable
// ============================================================================

// Check if Industry ETF actually has valid data (not all NA)
has_valid_industry_etf_data = not na(industry_etf_perf_1m) or not na(industry_etf_perf_3m) or not na(industry_etf_perf_6m) or not na(industry_etf_perf_1y)

// Check if Industry Leader actually has valid data (not all NA)
has_valid_industry_leader_data = not na(industry_leader_perf_1m) or not na(industry_leader_perf_3m) or not na(industry_leader_perf_6m) or not na(industry_leader_perf_1y)

// Update visibility flags to include data validation
// This ensures rows are hidden if symbol is invalid or data unavailable
show_industry_etf_row := show_industry_etf_row and has_valid_industry_etf_data
show_vs_industry_row := show_vs_industry_row and has_valid_industry_etf_data
show_industry_vs_sector_row := show_industry_vs_sector_row and has_valid_industry_etf_data
show_industry_leader_row := show_industry_leader_row and has_valid_industry_leader_data
show_vs_industry_leader_row := show_vs_industry_leader_row and has_valid_industry_leader_data

// ============================================================================
// RELATIVE STRENGTH CALCULATIONS
// ============================================================================

// Asset vs Benchmark (Stock vs Sector, Crypto vs Market, etc.)
rs_vs_benchmark_1m = not na(stock_perf_1m) and not na(benchmark_perf_1m) ? stock_perf_1m - benchmark_perf_1m : na
rs_vs_benchmark_3m = not na(stock_perf_3m) and not na(benchmark_perf_3m) ? stock_perf_3m - benchmark_perf_3m : na
rs_vs_benchmark_6m = not na(stock_perf_6m) and not na(benchmark_perf_6m) ? stock_perf_6m - benchmark_perf_6m : na
rs_vs_benchmark_1y = not na(stock_perf_1y) and not na(benchmark_perf_1y) ? stock_perf_1y - benchmark_perf_1y : na

// Asset vs Market (Stock vs SPY, Crypto vs TOTAL, Forex vs DXY, etc.)
rs_vs_market_1m = not na(stock_perf_1m) and not na(market_perf_1m) ? stock_perf_1m - market_perf_1m : na
rs_vs_market_3m = not na(stock_perf_3m) and not na(market_perf_3m) ? stock_perf_3m - market_perf_3m : na
rs_vs_market_6m = not na(stock_perf_6m) and not na(market_perf_6m) ? stock_perf_6m - market_perf_6m : na
rs_vs_market_1y = not na(stock_perf_1y) and not na(market_perf_1y) ? stock_perf_1y - market_perf_1y : na

// Benchmark vs Market (Sector vs SPY, etc.)
benchmark_vs_market_1m = not na(benchmark_perf_1m) and not na(market_perf_1m) ? benchmark_perf_1m - market_perf_1m : na
benchmark_vs_market_3m = not na(benchmark_perf_3m) and not na(market_perf_3m) ? benchmark_perf_3m - market_perf_3m : na
benchmark_vs_market_6m = not na(benchmark_perf_6m) and not na(market_perf_6m) ? benchmark_perf_6m - market_perf_6m : na
benchmark_vs_market_1y = not na(benchmark_perf_1y) and not na(market_perf_1y) ? benchmark_perf_1y - market_perf_1y : na

// Stock vs Leader
rs_vs_leader_1m = not na(stock_perf_1m) and not na(leader_perf_1m) ? stock_perf_1m - leader_perf_1m : na
rs_vs_leader_3m = not na(stock_perf_3m) and not na(leader_perf_3m) ? stock_perf_3m - leader_perf_3m : na
rs_vs_leader_6m = not na(stock_perf_6m) and not na(leader_perf_6m) ? stock_perf_6m - leader_perf_6m : na
rs_vs_leader_1y = not na(stock_perf_1y) and not na(leader_perf_1y) ? stock_perf_1y - leader_perf_1y : na

// Stock vs Industry ETF
rs_vs_industry_1m = not na(stock_perf_1m) and not na(industry_etf_perf_1m) ? stock_perf_1m - industry_etf_perf_1m : na
rs_vs_industry_3m = not na(stock_perf_3m) and not na(industry_etf_perf_3m) ? stock_perf_3m - industry_etf_perf_3m : na
rs_vs_industry_6m = not na(stock_perf_6m) and not na(industry_etf_perf_6m) ? stock_perf_6m - industry_etf_perf_6m : na
rs_vs_industry_1y = not na(stock_perf_1y) and not na(industry_etf_perf_1y) ? stock_perf_1y - industry_etf_perf_1y : na

// Industry ETF vs Sector ETF (to see if industry is leading/lagging within sector)
industry_vs_sector_1m = not na(industry_etf_perf_1m) and not na(benchmark_perf_1m) ? industry_etf_perf_1m - benchmark_perf_1m : na
industry_vs_sector_3m = not na(industry_etf_perf_3m) and not na(benchmark_perf_3m) ? industry_etf_perf_3m - benchmark_perf_3m : na
industry_vs_sector_6m = not na(industry_etf_perf_6m) and not na(benchmark_perf_6m) ? industry_etf_perf_6m - benchmark_perf_6m : na
industry_vs_sector_1y = not na(industry_etf_perf_1y) and not na(benchmark_perf_1y) ? industry_etf_perf_1y - benchmark_perf_1y : na

// Stock vs Industry Leader
rs_vs_industry_leader_1m = not na(stock_perf_1m) and not na(industry_leader_perf_1m) ? stock_perf_1m - industry_leader_perf_1m : na
rs_vs_industry_leader_3m = not na(stock_perf_3m) and not na(industry_leader_perf_3m) ? stock_perf_3m - industry_leader_perf_3m : na
rs_vs_industry_leader_6m = not na(stock_perf_6m) and not na(industry_leader_perf_6m) ? stock_perf_6m - industry_leader_perf_6m : na
rs_vs_industry_leader_1y = not na(stock_perf_1y) and not na(industry_leader_perf_1y) ? stock_perf_1y - industry_leader_perf_1y : na

// ============================================================================
// MOMENTUM INDICATORS
// ============================================================================

// RS Momentum (change in RS over time)
rs_momentum_improving = not na(rs_vs_benchmark_1m) and not na(rs_vs_benchmark_3m) and rs_vs_benchmark_1m > rs_vs_benchmark_3m
rs_momentum_declining = not na(rs_vs_benchmark_1m) and not na(rs_vs_benchmark_3m) and rs_vs_benchmark_1m < rs_vs_benchmark_3m

// Sector Rotation Signal (Sector outperforming market)
sector_rotation_bullish = not na(benchmark_vs_market_1m) and benchmark_vs_market_1m > 0 and not na(benchmark_vs_market_3m) and benchmark_vs_market_3m > 0

// ============================================================================
// DIVERGENCE DETECTION
// ============================================================================

// Price vs Sector Divergence
bullish_divergence = false
bearish_divergence = false

if not na(rs_vs_benchmark_1m) and enable_alerts and barstate.isconfirmed
    // Bullish: Stock outperforming sector significantly
    if rs_vs_benchmark_1m > divergence_threshold and close > close[bars_1m]
        bullish_divergence := true
    // Bearish: Stock underperforming sector significantly
    if rs_vs_benchmark_1m < -divergence_threshold and close < close[bars_1m]
        bearish_divergence := true

// ============================================================================
// CONSECUTIVE DAYS ABOVE/BELOW SECTOR
// ============================================================================

// Track consecutive days of outperformance/underperformance
var int days_above_sector = 0
var int days_below_sector = 0

if barstate.isconfirmed
    bool_outperforming = not na(rs_vs_benchmark_1m) and rs_vs_benchmark_1m > 0
    bool_underperforming = not na(rs_vs_benchmark_1m) and rs_vs_benchmark_1m < 0

    if bool_outperforming
        days_above_sector := days_above_sector + 1
        days_below_sector := 0
    else if bool_underperforming
        days_below_sector := days_below_sector + 1
        days_above_sector := 0
    else
        days_above_sector := 0
        days_below_sector := 0

// ============================================================================
// BETA CALCULATION (Stock vs Sector)
// ============================================================================

// Calculate Beta using correlation and standard deviation
// Beta = Correlation(Stock, Sector) * (StdDev(Stock) / StdDev(Sector))
// Note: These calculations must be outside conditional blocks for Pine Script consistency
stock_returns = ta.change(close) / close[1] * 100
benchmark_close = benchmark_symbol != "" ? request.security(benchmark_symbol, selected_tf, close, lookahead=barmerge.lookahead_off) : close
benchmark_returns = ta.change(benchmark_close) / benchmark_close[1] * 100
correlation = ta.correlation(stock_returns, benchmark_returns, 20)
stock_stddev = ta.stdev(stock_returns, 20)
benchmark_stddev = ta.stdev(benchmark_returns, 20)

float beta_vs_sector = benchmark_symbol != "" and not na(correlation) and not na(stock_stddev) and not na(benchmark_stddev) and benchmark_stddev != 0 ?
                       correlation * (stock_stddev / benchmark_stddev) : na

// ============================================================================
// RS SCORING SYSTEM (0-100)
// ============================================================================

// Calculate weighted RS score
calculate_rs_score() =>
    float score = 50.0  // Start at neutral
    int valid_periods = 0

    // For STOCKS: Split weights between Sector (60%) and Industry (40%)
    // For OTHER assets: Use full weight on benchmark (100%)

    // Check if we have ACTUAL Industry RS data (not just the flag)
    bool has_actual_industry_data = not na(rs_vs_industry_1m) or not na(rs_vs_industry_3m) or not na(rs_vs_industry_6m) or not na(rs_vs_industry_1y)

    if is_stock and show_vs_industry_row and has_actual_industry_data
        // STOCK WITH INDUSTRY DATA: Sector gets 60%, Industry gets 40%

        // Sector RS contribution (60% of total weight)
        if show_vs_benchmark_row and not na(rs_vs_benchmark_1m)
            score := score + (rs_vs_benchmark_1m * 0.24)  // 1M: 24% (40% * 0.6)
            valid_periods := valid_periods + 1
        if show_vs_benchmark_row and not na(rs_vs_benchmark_3m)
            score := score + (rs_vs_benchmark_3m * 0.18)  // 3M: 18% (30% * 0.6)
            valid_periods := valid_periods + 1
        if show_vs_benchmark_row and not na(rs_vs_benchmark_6m)
            score := score + (rs_vs_benchmark_6m * 0.12)  // 6M: 12% (20% * 0.6)
            valid_periods := valid_periods + 1
        if show_vs_benchmark_row and not na(rs_vs_benchmark_1y)
            score := score + (rs_vs_benchmark_1y * 0.06)  // 1Y: 6% (10% * 0.6)
            valid_periods := valid_periods + 1

        // Industry RS contribution (40% of total weight)
        if not na(rs_vs_industry_1m)
            score := score + (rs_vs_industry_1m * 0.16)  // 1M: 16% (40% * 0.4)
            valid_periods := valid_periods + 1
        if not na(rs_vs_industry_3m)
            score := score + (rs_vs_industry_3m * 0.12)  // 3M: 12% (30% * 0.4)
            valid_periods := valid_periods + 1
        if not na(rs_vs_industry_6m)
            score := score + (rs_vs_industry_6m * 0.08)  // 6M: 8% (20% * 0.4)
            valid_periods := valid_periods + 1
        if not na(rs_vs_industry_1y)
            score := score + (rs_vs_industry_1y * 0.04)  // 1Y: 4% (10% * 0.4)
            valid_periods := valid_periods + 1
    else
        // NON-STOCK or NO INDUSTRY DATA: Benchmark gets full 100% weight
        if show_vs_benchmark_row and not na(rs_vs_benchmark_1m)
            score := score + (rs_vs_benchmark_1m * 0.40)  // 1M: 40% weight (most recent)
            valid_periods := valid_periods + 1
        if show_vs_benchmark_row and not na(rs_vs_benchmark_3m)
            score := score + (rs_vs_benchmark_3m * 0.30)  // 3M: 30% weight
            valid_periods := valid_periods + 1
        if show_vs_benchmark_row and not na(rs_vs_benchmark_6m)
            score := score + (rs_vs_benchmark_6m * 0.20)  // 6M: 20% weight
            valid_periods := valid_periods + 1
        if show_vs_benchmark_row and not na(rs_vs_benchmark_1y)
            score := score + (rs_vs_benchmark_1y * 0.10)  // 1Y: 10% weight (least recent)
            valid_periods := valid_periods + 1

    // Cap base score to 0-100 range
    score := math.max(0, math.min(100, score))

    score

// Calculate modifiers (bonuses and penalties) - returns total modifier value
calculate_modifiers() =>
    float modifiers = 0.0

    // Bonus for hot sector (sector outperforming market)
    if show_benchmark_vs_market_row and sector_rotation_bullish
        modifiers := modifiers + 5.0

    // Bonus for hot industry (industry outperforming sector) - only for stocks with industry data
    bool has_actual_industry_data = not na(rs_vs_industry_1m) or not na(rs_vs_industry_3m) or not na(rs_vs_industry_6m) or not na(rs_vs_industry_1y)
    if is_stock and show_vs_industry_row and has_actual_industry_data
        if show_industry_vs_sector_row and not na(industry_vs_sector_1m) and industry_vs_sector_1m > 0 and not na(industry_vs_sector_3m) and industry_vs_sector_3m > 0
            modifiers := modifiers + 5.0

    // Bonus for improving momentum
    if show_vs_benchmark_row and rs_momentum_improving
        modifiers := modifiers + 5.0

    // Penalty for declining momentum
    if show_vs_benchmark_row and rs_momentum_declining
        modifiers := modifiers - 5.0

    modifiers

// Get modifier breakdown as simple icons
// 🔥 = bonus (+5), 📉 = penalty (-5), ➡️ = neutral
get_modifier_text() =>
    bool has_actual_industry_data = not na(rs_vs_industry_1m) or not na(rs_vs_industry_3m) or not na(rs_vs_industry_6m) or not na(rs_vs_industry_1y)
    bool hot_sector = show_benchmark_vs_market_row and sector_rotation_bullish
    bool hot_industry = is_stock and show_vs_industry_row and has_actual_industry_data and show_industry_vs_sector_row and not na(industry_vs_sector_1m) and industry_vs_sector_1m > 0 and not na(industry_vs_sector_3m) and industry_vs_sector_3m > 0
    bool momentum_up = show_vs_benchmark_row and rs_momentum_improving
    bool momentum_down = show_vs_benchmark_row and rs_momentum_declining
    int bonus_count = (hot_sector ? 1 : 0) + (hot_industry ? 1 : 0) + (momentum_up ? 1 : 0)
    bool has_penalty = momentum_down
    string result = has_penalty ? "📉" : bonus_count >= 3 ? "🔥🔥🔥" : bonus_count == 2 ? "🔥🔥" : bonus_count == 1 ? "🔥" : "➡️"
    result

// Calculate consistency (how many periods are positive) - ONLY count relevant periods
calculate_consistency() =>
    int positive_count = 0
    int total_count = 0

    // Sector RS consistency
    if show_vs_benchmark_row and not na(rs_vs_benchmark_1m)
        total_count := total_count + 1
        if rs_vs_benchmark_1m > 0
            positive_count := positive_count + 1
    if show_vs_benchmark_row and not na(rs_vs_benchmark_3m)
        total_count := total_count + 1
        if rs_vs_benchmark_3m > 0
            positive_count := positive_count + 1
    if show_vs_benchmark_row and not na(rs_vs_benchmark_6m)
        total_count := total_count + 1
        if rs_vs_benchmark_6m > 0
            positive_count := positive_count + 1
    if show_vs_benchmark_row and not na(rs_vs_benchmark_1y)
        total_count := total_count + 1
        if rs_vs_benchmark_1y > 0
            positive_count := positive_count + 1

    // Industry RS consistency (only for stocks with industry data)
    if is_stock and show_vs_industry_row
        if not na(rs_vs_industry_1m)
            total_count := total_count + 1
            if rs_vs_industry_1m > 0
                positive_count := positive_count + 1
        if not na(rs_vs_industry_3m)
            total_count := total_count + 1
            if rs_vs_industry_3m > 0
                positive_count := positive_count + 1
        if not na(rs_vs_industry_6m)
            total_count := total_count + 1
            if rs_vs_industry_6m > 0
                positive_count := positive_count + 1
        if not na(rs_vs_industry_1y)
            total_count := total_count + 1
            if rs_vs_industry_1y > 0
                positive_count := positive_count + 1

    total_count > 0 ? (positive_count / total_count) * 100 : 0.0

// Get letter grade based on score
get_grade(float score) =>
    string grade = ""
    if score >= 90
        grade := "A+"
    else if score >= 85
        grade := "A"
    else if score >= 80
        grade := "A-"
    else if score >= 75
        grade := "B+"
    else if score >= 70
        grade := "B"
    else if score >= 65
        grade := "B-"
    else if score >= 60
        grade := "C+"
    else if score >= 55
        grade := "C"
    else if score >= 50
        grade := "C-"
    else if score >= 45
        grade := "D+"
    else if score >= 40
        grade := "D"
    else
        grade := "F"
    grade

// Get grade color
get_grade_color(string grade) =>
    color grade_color = #d3d2d2
    if str.contains(grade, "A")
        grade_color := color.new(COLOR_BRIGHT_GREEN, 0)
    else if str.contains(grade, "B")
        grade_color := color.new(COLOR_STANDARD_GREEN, 0)
    else if str.contains(grade, "C")
        grade_color := color.new(color.yellow, 0)
    else if str.contains(grade, "D")
        grade_color := color.new(color.orange, 0)
    else
        grade_color := color.new(COLOR_STANDARD_RED, 0)
    grade_color

// Calculate all metrics
rs_base_score = calculate_rs_score()
rs_modifiers = calculate_modifiers()
modifier_text = get_modifier_text()
rs_score = math.max(0, math.min(100, rs_base_score + rs_modifiers))  // Final score with modifiers
consistency_score = calculate_consistency()
grade = get_grade(rs_score)
grade_color = get_grade_color(grade)

// Check if stock passes RS Score filter
passes_filter = min_rs_score == 0.0 or rs_score >= min_rs_score

// Trend strength (average absolute RS)
avg_rs = not na(rs_vs_benchmark_1m) and not na(rs_vs_benchmark_3m) and not na(rs_vs_benchmark_6m) and not na(rs_vs_benchmark_1y) ?
         (math.abs(rs_vs_benchmark_1m) + math.abs(rs_vs_benchmark_3m) + math.abs(rs_vs_benchmark_6m) + math.abs(rs_vs_benchmark_1y)) / 4 : na

// ============================================================================
// ADDITIONAL USEFUL METRICS
// ============================================================================

// Volatility comparison (using ATR ratio)
stock_atr = ta.atr(14)
benchmark_atr = benchmark_symbol != "" ? request.security(benchmark_symbol, selected_tf, ta.atr(14), lookahead=barmerge.lookahead_off) : na
volatility_ratio = not na(benchmark_atr) and benchmark_atr != 0 ? stock_atr / benchmark_atr : na

// Volume analysis (relative volume)
stock_volume = request.security(syminfo.tickerid, selected_tf, volume, lookahead=barmerge.lookahead_off)
avg_volume = request.security(syminfo.tickerid, selected_tf, ta.sma(volume, 20), lookahead=barmerge.lookahead_off)
relative_volume = not na(avg_volume) and avg_volume != 0 ? stock_volume / avg_volume : na

// Price position vs highs (52-week high equivalent for all timeframes)
bars_52w = effective_tf_type == "1 Hour" ? 1920 :    // 1 year in hourly bars
           effective_tf_type == "4 Hours" ? 480 :    // 1 year in 4H bars
           effective_tf_type == "Daily" ? 252 :      // 1 year in daily bars
           52                                         // 1 year in weekly bars
highest_price = ta.highest(close, bars_52w)
price_vs_high = not na(highest_price) and highest_price != 0 ? (close / highest_price) * 100 : na

// ============================================================================
// PERFORMANCE TABLE
// ============================================================================

format_perf(float val) =>
    if na(val)
        "N/A"
    else
        str.tostring(val, "#.##") + "%"

get_color(float val) =>
    if na(val)
        color.new(COLOR_NEUTRAL, 0)
    else if val > 0
        color.new(COLOR_BRIGHT_GREEN, 0)
    else if val < 0
        color.new(COLOR_BRIGHT_RED, 0)
    else
        color.new(COLOR_NEUTRAL, 0)

// ============================================================================
// DATA STORAGE FOR TABLE UPDATE CONTROL
// ============================================================================

// Determine if we should update the table data
// - When show_realtime_indicator = true: Update on every tick (barstate.islast)
// - When show_realtime_indicator = false: Update only on bar close (barstate.isconfirmed)
bool should_update_data = show_realtime_indicator or barstate.isconfirmed

// Store table data in variables that persist between bars
// This allows us to always show the table (on barstate.islast) while controlling when the data updates
var float stored_stock_perf_1m = na
var float stored_stock_perf_3m = na
var float stored_stock_perf_6m = na
var float stored_stock_perf_1y = na
var float stored_benchmark_perf_1m = na
var float stored_benchmark_perf_3m = na
var float stored_benchmark_perf_6m = na
var float stored_benchmark_perf_1y = na
var float stored_market_perf_1m = na
var float stored_market_perf_3m = na
var float stored_market_perf_6m = na
var float stored_market_perf_1y = na
var float stored_leader_perf_1m = na
var float stored_leader_perf_3m = na
var float stored_leader_perf_6m = na
var float stored_leader_perf_1y = na
var float stored_rs_vs_benchmark_1m = na
var float stored_rs_vs_benchmark_3m = na
var float stored_rs_vs_benchmark_6m = na
var float stored_rs_vs_benchmark_1y = na
var float stored_rs_vs_market_1m = na
var float stored_rs_vs_market_3m = na
var float stored_rs_vs_market_6m = na
var float stored_rs_vs_market_1y = na
var float stored_rs_vs_leader_1m = na
var float stored_rs_vs_leader_3m = na
var float stored_rs_vs_leader_6m = na
var float stored_rs_vs_leader_1y = na
var float stored_rs_score = na
var float stored_rs_base_score = na
var float stored_rs_modifiers = na
var string stored_modifier_text = ""
var float stored_correlation = na
var float stored_beta_vs_sector = na

// Industry stored variables
var float stored_industry_etf_perf_1m = na
var float stored_industry_etf_perf_3m = na
var float stored_industry_etf_perf_6m = na
var float stored_industry_etf_perf_1y = na
var float stored_industry_leader_perf_1m = na
var float stored_industry_leader_perf_3m = na
var float stored_industry_leader_perf_6m = na
var float stored_industry_leader_perf_1y = na
var float stored_rs_vs_industry_1m = na
var float stored_rs_vs_industry_3m = na
var float stored_rs_vs_industry_6m = na
var float stored_rs_vs_industry_1y = na
var float stored_industry_vs_sector_1m = na
var float stored_industry_vs_sector_3m = na
var float stored_industry_vs_sector_6m = na
var float stored_industry_vs_sector_1y = na
var float stored_rs_vs_industry_leader_1m = na
var float stored_rs_vs_industry_leader_3m = na
var float stored_rs_vs_industry_leader_6m = na
var float stored_rs_vs_industry_leader_1y = na

// Update stored data when appropriate
if should_update_data
    stored_stock_perf_1m := stock_perf_1m
    stored_stock_perf_3m := stock_perf_3m
    stored_stock_perf_6m := stock_perf_6m
    stored_stock_perf_1y := stock_perf_1y
    stored_benchmark_perf_1m := benchmark_perf_1m
    stored_benchmark_perf_3m := benchmark_perf_3m
    stored_benchmark_perf_6m := benchmark_perf_6m
    stored_benchmark_perf_1y := benchmark_perf_1y
    stored_market_perf_1m := market_perf_1m
    stored_market_perf_3m := market_perf_3m
    stored_market_perf_6m := market_perf_6m
    stored_market_perf_1y := market_perf_1y
    stored_leader_perf_1m := leader_perf_1m
    stored_leader_perf_3m := leader_perf_3m
    stored_leader_perf_6m := leader_perf_6m
    stored_leader_perf_1y := leader_perf_1y
    stored_rs_vs_benchmark_1m := rs_vs_benchmark_1m
    stored_rs_vs_benchmark_3m := rs_vs_benchmark_3m
    stored_rs_vs_benchmark_6m := rs_vs_benchmark_6m
    stored_rs_vs_benchmark_1y := rs_vs_benchmark_1y
    stored_rs_vs_market_1m := rs_vs_market_1m
    stored_rs_vs_market_3m := rs_vs_market_3m
    stored_rs_vs_market_6m := rs_vs_market_6m
    stored_rs_vs_market_1y := rs_vs_market_1y
    stored_rs_vs_leader_1m := rs_vs_leader_1m
    stored_rs_vs_leader_3m := rs_vs_leader_3m
    stored_rs_vs_leader_6m := rs_vs_leader_6m
    stored_rs_vs_leader_1y := rs_vs_leader_1y
    stored_rs_score := rs_score
    stored_rs_base_score := rs_base_score
    stored_rs_modifiers := rs_modifiers
    stored_modifier_text := modifier_text
    stored_correlation := correlation
    stored_beta_vs_sector := beta_vs_sector
    // Industry data
    stored_industry_etf_perf_1m := industry_etf_perf_1m
    stored_industry_etf_perf_3m := industry_etf_perf_3m
    stored_industry_etf_perf_6m := industry_etf_perf_6m
    stored_industry_etf_perf_1y := industry_etf_perf_1y
    stored_industry_leader_perf_1m := industry_leader_perf_1m
    stored_industry_leader_perf_3m := industry_leader_perf_3m
    stored_industry_leader_perf_6m := industry_leader_perf_6m
    stored_industry_leader_perf_1y := industry_leader_perf_1y
    stored_rs_vs_industry_1m := rs_vs_industry_1m
    stored_rs_vs_industry_3m := rs_vs_industry_3m
    stored_rs_vs_industry_6m := rs_vs_industry_6m
    stored_rs_vs_industry_1y := rs_vs_industry_1y
    stored_industry_vs_sector_1m := industry_vs_sector_1m
    stored_industry_vs_sector_3m := industry_vs_sector_3m
    stored_industry_vs_sector_6m := industry_vs_sector_6m
    stored_industry_vs_sector_1y := industry_vs_sector_1y
    stored_rs_vs_industry_leader_1m := rs_vs_industry_leader_1m
    stored_rs_vs_industry_leader_3m := rs_vs_industry_leader_3m
    stored_rs_vs_industry_leader_6m := rs_vs_industry_leader_6m
    stored_rs_vs_industry_leader_1y := rs_vs_industry_leader_1y

// Display filter warning if stock doesn't pass
if show_table and barstate.islast and not passes_filter and show_filter_warning
    var table warning_table = table.new(
         position = table_position == "Top Left" ? position.top_left :
                   table_position == "Top Center" ? position.top_center :
                   table_position == "Top Right" ? position.top_right :
                   table_position == "Middle Left" ? position.middle_left :
                   table_position == "Middle Center" ? position.middle_center :
                   table_position == "Middle Right" ? position.middle_right :
                   table_position == "Bottom Left" ? position.bottom_left :
                   table_position == "Bottom Center" ? position.bottom_center :
                   position.bottom_right,
         columns = 1,
         rows = 4,
         border_width = 2,
         border_color = COLOR_TABLE_BORDER)

    txt_size = table_size == "Tiny" ? size.tiny :
               table_size == "Small" ? size.small :
               table_size == "Normal" ? size.normal :
               size.large

    // Determine warning reason
    warning_icon = not has_valid_benchmark ? "ℹ️" : "⚠️"
    warning_title = not has_valid_benchmark ? "INFO" : "FILTER WARNING"
    warning_color = not has_valid_benchmark ? color.new(COLOR_INFO, 0) : color.new(COLOR_WARNING, 0)
    
    table.clear(warning_table, 0, 0, 0, 3)
    table.cell(warning_table, 0, 0, warning_icon + " " + warning_title, text_color=color.white, bgcolor=warning_color, text_size=txt_size)
    table.cell(warning_table, 0, 1, "RS Score: " + str.tostring(stored_rs_score, "#.#") + " / 100", text_color=not has_valid_benchmark ? color.yellow : color.new(COLOR_BRIGHT_RED, 0), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size)
    
    if not has_valid_benchmark
        table.cell(warning_table, 0, 2, "No valid benchmark", text_color=color.yellow, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size)
        table.cell(warning_table, 0, 3, "RS Score defaults to 50 (neutral)", text_color=color.gray, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size)
    else
        table.cell(warning_table, 0, 2, "Below minimum: " + str.tostring(min_rs_score, "#.#"), text_color=color.orange, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size)
        table.cell(warning_table, 0, 3, "Adjust filter or choose stronger asset", text_color=color.gray, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size)

// Calculate position outside if block
position_value = table_position == "Top Left" ? position.top_left :
                 table_position == "Top Center" ? position.top_center :
                 table_position == "Top Right" ? position.top_right :
                 table_position == "Middle Left" ? position.middle_left :
                 table_position == "Middle Center" ? position.middle_center :
                 table_position == "Middle Right" ? position.middle_right :
                 table_position == "Bottom Left" ? position.bottom_left :
                 table_position == "Bottom Center" ? position.bottom_center :
                 position.bottom_right

// Initialize table once (var = created only on first bar)
var table perf_table = table.new(position_value, columns = 6, rows = 25, border_width = TABLE_BORDER_WIDTH, border_color = COLOR_TABLE_BORDER)

// Always render table on last bar (keeps it visible) using stored data
// The stored data only updates based on show_realtime_indicator setting
if show_table and barstate.islast and passes_filter

    // Table size
    txt_size = table_size == "Tiny" ? size.tiny :
               table_size == "Small" ? size.small :
               table_size == "Normal" ? size.normal :
               size.large

    // Clear entire table to prevent leftover cells from previous render
    table.clear(perf_table, 0, 0, 5, 24)

    // Dynamic Row Counter - tracks next available row
    var int current_row = 0
    current_row := 0

    // Header Row - Universal title for all asset types
    table.cell(perf_table, 0, current_row, "RELATIVE STRENGTH ANALYZER", text_color=color.white, bgcolor=color.new(COLOR_BG_TITLE, 0), text_size=txt_size)
    table.merge_cells(perf_table, 0, current_row, 5, current_row)
    current_row += 1

    // Subtitle with timeframe and sector
    tf_text = timeframe_mode == "Chart Timeframe" ? selected_tf :
              timeframe_mode == "1 Hour" ? "1H" :
              timeframe_mode == "4 Hours" ? "4H" :
              timeframe_mode == "Daily" ? "Daily" :
              "Weekly"
    // Dynamic asset type display
    asset_info = is_stock ? (syminfo.sector != "" ? syminfo.sector + (syminfo.industry != "" ? " | " + syminfo.industry : "") : "Stock") :
                 is_crypto ? "Crypto" :
                 is_forex ? "Forex" :
                 is_commodity ? "Commodity" :
                 is_index ? "Index" :
                 "Asset"
    benchmark_text = benchmark_symbol != "" ? asset_info + " (" + benchmark_symbol + ")" : asset_info

    // Comprehensive tooltip explaining asset type and calculations
    sector_vs_industry_explainer = is_stock and show_industry_analysis ?
                     "\n📊 SECTOR vs INDUSTRY:\n" +
                     "SECTOR = Broad category (11 total)\n" +
                     "Example: Technology (XLK)\n" +
                     "Includes: Software, Hardware, Semiconductors\n\n" +
                     "INDUSTRY = Specific subsector (60+ total)\n" +
                     "Example: Software (IGV)\n" +
                     "More focused: Only software companies\n\n" +
                     "WHY BOTH MATTER:\n" +
                     "- Sector shows overall group trend\n" +
                     "- Industry shows peer comparison\n" +
                     "Best stocks beat BOTH! 🚀\n" : ""

    header_tooltip = "📊 ASSET TYPE: " + asset_type_display + "\n\n" +
                     "🎯 COMPARISONS USED:\n" +
                     "• Benchmark: " + (benchmark_symbol != "" ? benchmark_symbol : "None") + "\n" +
                     "• Market: " + market_symbol + "\n" +
                     "• Leader: " + (leader_symbol != "" ? leader_symbol : "None") + "\n" +
                     (show_industry_analysis and is_stock ? "• Industry ETF: " + (industry_etf_symbol != "" ? industry_etf_symbol : "None") + "\n• Industry Leader: " + (industry_leader_symbol != "" ? industry_leader_symbol : "None") + "\n\n" : "\n") +
                     sector_vs_industry_explainer +
                     "📈 WHAT THIS MEANS:\n" +
                     (is_stock ? "This STOCK is compared to:\n- Its sector ETF (benchmark)\n- SPY (broad market)\n- The sector's leading stock\n- Industry ETF (more specific)\n- Industry leading stock" :
                      is_crypto ? "This CRYPTO is compared to:\n- Total crypto market cap\n- Bitcoin (or ETH if viewing BTC)\n- Overall crypto market trend" :
                      is_forex ? "This FOREX PAIR is compared to:\n- Its currency index (DXY, EXY, etc.)\n- Dollar Index (DXY)\n- Major pair for the currency" :
                      is_commodity ? "This COMMODITY is compared to:\n- Broad commodities index (DBC)\n- Its sector ETF\n- Gold (primary commodity)" :
                      is_index ? "This INDEX is compared to:\n- SPY (if applicable)\n- Broad market benchmark\n- SPY as leader" :
                      "This asset is compared to available benchmarks") + "\n\n" +
                     "⚠️ NOTE:\n" +
                     "Rows marked (N/A) or (Self) are not applicable\nfor this asset type (e.g., SPY vs SPY).\n\n" +
                     "All RS calculations show outperformance (+)\nor underperformance (-) relative to benchmarks."

    data_mode_indicator = show_realtime_indicator ? " ⏳" : ""
    header_tooltip_with_mode = header_tooltip + "\n\nDisplay Mode: " + (show_realtime_indicator ? "⏳ Real-time indicator shown" : "✅ Clean view (no indicator)") + "\n\nNote: All data uses lookahead=off\nso values NEVER repaint!"
    table.cell(perf_table, 0, current_row, syminfo.ticker + " | " + benchmark_text + " | " + tf_text + data_mode_indicator, text_color=color.white, bgcolor=color.new(COLOR_BG_SUBTITLE, 0), text_size=txt_size, tooltip=header_tooltip_with_mode)
    table.merge_cells(perf_table, 0, current_row, 5, current_row)
    current_row += 1

    // Dynamic labels based on asset type
    asset_label = is_crypto ? "Crypto" : is_forex ? "Pair" : is_commodity ? "Commodity" : is_index ? "Index" : "Stock"
    benchmark_label = is_crypto ? "Market" : is_forex ? "Index" : is_commodity ? "Sector" : is_index ? "Benchmark" : "Sector"

    // Get market label dynamically based on custom benchmark or defaults
    default_market_label = is_crypto ? "Total Crypto" : is_forex ? "DXY" : is_commodity ? "Commodities" : "SPY"

    // Extract symbol name for custom benchmark
    market_display_name = custom_market_benchmark != "" ?
                          str.upper(array.get(str.split(custom_market_benchmark, ":"), array.size(str.split(custom_market_benchmark, ":")) - 1)) :
                          default_market_label

    market_label = market_display_name
    leader_label = is_crypto ? "BTC" : is_forex ? "Major" : is_commodity ? "Gold" : is_index ? market_display_name : "Leader"

    // Column Headers
    table.cell(perf_table, 0, current_row, "COMPARED TO", text_color=color.white, bgcolor=color.new(COLOR_BG_HEADER, 0), text_size=txt_size, tooltip="Labels for each measurement")
    table.cell(perf_table, 1, current_row, "1M", text_color=color.white, bgcolor=color.new(COLOR_BG_HEADER, 0), text_size=txt_size, tooltip="1 Month Performance\nLast ~21 trading days")
    table.cell(perf_table, 2, current_row, "3M", text_color=color.white, bgcolor=color.new(COLOR_BG_HEADER, 0), text_size=txt_size, tooltip="3 Month Performance\nLast ~63 trading days")
    table.cell(perf_table, 3, current_row, "6M", text_color=color.white, bgcolor=color.new(COLOR_BG_HEADER, 0), text_size=txt_size, tooltip="6 Month Performance\nLast ~126 trading days")
    table.cell(perf_table, 4, current_row, "1Y", text_color=color.white, bgcolor=color.new(COLOR_BG_HEADER, 0), text_size=txt_size, tooltip="1 Year Performance\nLast ~252 trading days")
    table.cell(perf_table, 5, current_row, "Status", text_color=color.white, bgcolor=color.new(COLOR_BG_HEADER, 0), text_size=txt_size, tooltip="Quick Status Indicator\n📈 = Positive 3M\n📉 = Negative 3M")
    current_row += 1

    // Asset Performance Row - Always displayed
    table.cell(perf_table, 0, current_row, asset_label, text_color=color.white, bgcolor=color.new(COLOR_BG_STOCK_ROW, 0), text_size=txt_size, tooltip="Current " + asset_label + " Performance\n\nShows how much the price changed\nover each time period.\n\nGreen = Price went up\nRed = Price went down")
    table.cell(perf_table, 1, current_row, format_perf(stored_stock_perf_1m), text_color=get_color(stored_stock_perf_1m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Stock 1-Month Return\n\nPrice change over last ~21 trading days.\n\nExample: +5.2% means stock is up 5.2%\nfrom 1 month ago.")
    table.cell(perf_table, 2, current_row, format_perf(stored_stock_perf_3m), text_color=get_color(stored_stock_perf_3m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Stock 3-Month Return\n\nPrice change over last ~63 trading days\n(one quarter).")
    table.cell(perf_table, 3, current_row, format_perf(stored_stock_perf_6m), text_color=get_color(stored_stock_perf_6m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Stock 6-Month Return\n\nPrice change over last ~126 trading days\n(half year).")
    table.cell(perf_table, 4, current_row, format_perf(stored_stock_perf_1y), text_color=get_color(stored_stock_perf_1y), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Stock 1-Year Return\n\nPrice change over last ~252 trading days\n(full year).")
    stock_status = not na(stored_stock_perf_3m) and stored_stock_perf_3m > 0 ? "📈" : not na(stored_stock_perf_3m) ? "📉" : "⚪"
    table.cell(perf_table, 5, current_row, stock_status, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Stock Trend Indicator\n\nBased on 3-month performance:\n📈 = Uptrend (positive)\n📉 = Downtrend (negative)\n⚪ = No data")
    current_row += 1

    // Benchmark Performance Row - CONDITIONAL (only if benchmark exists)
    if show_benchmark_row
        benchmark_tooltip = benchmark_label + " Performance\n\nThe overall " + str.lower(benchmark_label) + "'s price movement.\nUsed as benchmark to compare your " + str.lower(asset_label) + ".\n\nIf " + str.lower(asset_label) + " beats " + str.lower(benchmark_label) + " = outperforming\nIf " + str.lower(asset_label) + " loses to " + str.lower(benchmark_label) + " = underperforming"
        table.cell(perf_table, 0, current_row, benchmark_label, text_color=color.white, bgcolor=color.new(COLOR_BG_SECTOR_ROW, 0), text_size=txt_size, tooltip=benchmark_tooltip)
        table.cell(perf_table, 1, current_row, format_perf(stored_benchmark_perf_1m), text_color=get_color(stored_benchmark_perf_1m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Sector 1-Month Return\n\nCompare with Stock's 1M above:\nStock higher = Outperforming sector\nStock lower = Underperforming sector")
        table.cell(perf_table, 2, current_row, format_perf(stored_benchmark_perf_3m), text_color=get_color(stored_benchmark_perf_3m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Sector 3-Month Return\n\nHow the overall sector performed\nover the past quarter.")
        table.cell(perf_table, 3, current_row, format_perf(stored_benchmark_perf_6m), text_color=get_color(stored_benchmark_perf_6m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Sector 6-Month Return\n\nSector's half-year performance trend.")
        table.cell(perf_table, 4, current_row, format_perf(stored_benchmark_perf_1y), text_color=get_color(stored_benchmark_perf_1y), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Sector 1-Year Return\n\nSector's annual performance.")
        sector_status = not na(stored_benchmark_perf_3m) and stored_benchmark_perf_3m > 0 ? "📈" : not na(stored_benchmark_perf_3m) ? "📉" : "⚪"
        table.cell(perf_table, 5, current_row, sector_status, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Sector Trend\n\n📈 = Sector rising\n📉 = Sector falling\n⚪ = No data")
        current_row += 1

    // Market Performance Row - CONDITIONAL (only if not the market benchmark itself)
    if show_market_row
        market_tooltip = market_label + " Performance\n\nRepresents the overall " + (is_stock ? "US stock market" : is_crypto ? "crypto market" : is_forex ? "dollar index" : "market") + ".\nThe ultimate benchmark for all " + str.lower(asset_label) + "s."
        table.cell(perf_table, 0, current_row, market_label, text_color=color.white, bgcolor=color.new(COLOR_BG_MARKET_ROW, 0), text_size=txt_size, tooltip=market_tooltip)
        table.cell(perf_table, 1, current_row, format_perf(stored_market_perf_1m), text_color=get_color(stored_market_perf_1m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip=market_display_name + " 1-Month Return\n\nHow the broad market\nperformed this month.\n\nBeat this = Beating the market")
        table.cell(perf_table, 2, current_row, format_perf(stored_market_perf_3m), text_color=get_color(stored_market_perf_3m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip=market_display_name + " 3-Month Return\n\nMarket's quarterly performance.")
        table.cell(perf_table, 3, current_row, format_perf(stored_market_perf_6m), text_color=get_color(stored_market_perf_6m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip=market_display_name + " 6-Month Return\n\nMarket's half-year trend.")
        table.cell(perf_table, 4, current_row, format_perf(stored_market_perf_1y), text_color=get_color(stored_market_perf_1y), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip=market_display_name + " 1-Year Return\n\nMarket's annual performance.")
        spy_status = not na(stored_market_perf_3m) and stored_market_perf_3m > 0 ? "📈" : not na(stored_market_perf_3m) ? "📉" : "⚪"
        table.cell(perf_table, 5, current_row, spy_status, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Market Trend\n\n📈 = Bull market (rising)\n📉 = Bear market (falling)\n⚪ = No data")
        current_row += 1

    // Leader Performance Row - CONDITIONAL (only if leader exists and is different)
    if show_leader_row
        leader_parts = str.split(leader_symbol, ":")
        leader_ticker_display = leader_symbol != "" and array.size(leader_parts) > 1 ? array.get(leader_parts, 1) : "N/A"
        leader_description = is_stock ? "The strongest, biggest stock in " + str.lower(benchmark_label) :
                             is_crypto ? "Bitcoin - the crypto market leader" :
                             is_forex ? "The major pair for this currency" :
                             is_commodity ? "Gold - the primary commodity" :
                             "The benchmark leader"
        table.cell(perf_table, 0, current_row, leader_label + ": " + leader_ticker_display, text_color=color.white, bgcolor=color.new(COLOR_BG_LEADER_ROW, 0), text_size=txt_size, tooltip=leader_label + "\n\n" + leader_description + "\n\nThis is the " + str.lower(asset_label) + " to beat!")
        table.cell(perf_table, 1, current_row, format_perf(stored_leader_perf_1m), text_color=get_color(stored_leader_perf_1m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Leader 1-Month Return\n\nIf your stock beats this,\nyou're outperforming the sector's\nstrongest player!")
        table.cell(perf_table, 2, current_row, format_perf(stored_leader_perf_3m), text_color=get_color(stored_leader_perf_3m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Leader 3-Month Return\n\nHow the top stock in the sector\nperformed quarterly.")
        table.cell(perf_table, 3, current_row, format_perf(stored_leader_perf_6m), text_color=get_color(stored_leader_perf_6m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Leader 6-Month Return\n\nLeading stock's half-year trend.")
        table.cell(perf_table, 4, current_row, format_perf(stored_leader_perf_1y), text_color=get_color(stored_leader_perf_1y), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Leader 1-Year Return\n\nTop stock's annual performance.")
        leader_status = not na(stored_leader_perf_3m) and stored_leader_perf_3m > 0 ? "📈" : not na(stored_leader_perf_3m) ? "📉" : "⚪"
        table.cell(perf_table, 5, current_row, leader_status, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Leader Trend\n\n📈 = Leader rising\n📉 = Leader falling\n⚪ = No data")
        current_row += 1

    // Industry ETF Performance Row - CONDITIONAL (only for stocks with valid industry ETF)
    if show_industry_etf_row
        industry_etf_parts = str.split(industry_etf_symbol, ":")
        industry_etf_ticker_display = industry_etf_symbol != "" and array.size(industry_etf_parts) > 1 ? array.get(industry_etf_parts, 1) : "N/A"
        industry_name_display = syminfo.industry != "" ? syminfo.industry : "Industry"
        table.cell(perf_table, 0, current_row, "Industry: " + industry_etf_ticker_display, text_color=color.white, bgcolor=color.new(COLOR_BG_INDUSTRY_ROW, 0), text_size=txt_size, tooltip="Industry ETF Performance\n\n" + industry_name_display + "\n\nMore specific than sector.\nShows how the specific industry\nperforms within the broader sector.\n\nETF: " + industry_etf_symbol)
        table.cell(perf_table, 1, current_row, format_perf(stored_industry_etf_perf_1m), text_color=get_color(stored_industry_etf_perf_1m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Industry ETF 1-Month Return\n\nHow the specific industry\nperformed this month.")
        table.cell(perf_table, 2, current_row, format_perf(stored_industry_etf_perf_3m), text_color=get_color(stored_industry_etf_perf_3m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Industry ETF 3-Month Return\n\nQuarterly industry performance.")
        table.cell(perf_table, 3, current_row, format_perf(stored_industry_etf_perf_6m), text_color=get_color(stored_industry_etf_perf_6m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Industry ETF 6-Month Return\n\nHalf-year industry trend.")
        table.cell(perf_table, 4, current_row, format_perf(stored_industry_etf_perf_1y), text_color=get_color(stored_industry_etf_perf_1y), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Industry ETF 1-Year Return\n\nAnnual industry performance.")
        industry_etf_status = not na(stored_industry_etf_perf_3m) and stored_industry_etf_perf_3m > 0 ? "📈" : not na(stored_industry_etf_perf_3m) ? "📉" : "⚪"
        table.cell(perf_table, 5, current_row, industry_etf_status, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Industry Trend\n\n📈 = Industry rising\n📉 = Industry falling\n⚪ = No data")
        current_row += 1

    // Industry Leader Performance Row - CONDITIONAL
    if show_industry_leader_row
        industry_leader_parts = str.split(industry_leader_symbol, ":")
        industry_leader_ticker_display = industry_leader_symbol != "" and array.size(industry_leader_parts) > 1 ? array.get(industry_leader_parts, 1) : "N/A"
        table.cell(perf_table, 0, current_row, "Ind. Leader: " + industry_leader_ticker_display, text_color=color.white, bgcolor=color.new(COLOR_BG_IND_LEADER_ROW, 0), text_size=txt_size, tooltip="Industry Leader\n\nThe strongest stock in the\nspecific industry (not just sector).\n\nMore precise comparison than\nsector leader.\n\nSymbol: " + industry_leader_symbol)
        table.cell(perf_table, 1, current_row, format_perf(stored_industry_leader_perf_1m), text_color=get_color(stored_industry_leader_perf_1m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Industry Leader 1-Month Return\n\nTop stock in your industry's\nmonthly performance.")
        table.cell(perf_table, 2, current_row, format_perf(stored_industry_leader_perf_3m), text_color=get_color(stored_industry_leader_perf_3m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Industry Leader 3-Month Return\n\nQuarterly performance of the\nindustry's leading stock.")
        table.cell(perf_table, 3, current_row, format_perf(stored_industry_leader_perf_6m), text_color=get_color(stored_industry_leader_perf_6m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Industry Leader 6-Month Return\n\nHalf-year trend of industry leader.")
        table.cell(perf_table, 4, current_row, format_perf(stored_industry_leader_perf_1y), text_color=get_color(stored_industry_leader_perf_1y), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Industry Leader 1-Year Return\n\nAnnual performance of\nindustry's top stock.")
        industry_leader_status = not na(stored_industry_leader_perf_3m) and stored_industry_leader_perf_3m > 0 ? "📈" : not na(stored_industry_leader_perf_3m) ? "📉" : "⚪"
        table.cell(perf_table, 5, current_row, industry_leader_status, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Industry Leader Trend\n\n📈 = Leader rising\n📉 = Leader falling\n⚪ = No data")
        current_row += 1

    // Separator
    table.cell(perf_table, 0, current_row, "RELATIVE STRENGTH", text_color=color.white, bgcolor=color.new(COLOR_BG_SECTION_RS, 0), text_size=txt_size)
    table.merge_cells(perf_table, 0, current_row, 5, current_row)
    current_row += 1

    // Asset vs Benchmark RS - CONDITIONAL (only if benchmark exists)
    if show_vs_benchmark_row
        vs_benchmark_tooltip = "Relative Strength vs " + benchmark_label + "\n\nHow much " + str.lower(asset_label) + " outperformed (+)\nor underperformed (-) its " + str.lower(benchmark_label) + ".\n\nPositive = Beating " + str.lower(benchmark_label) + " ✅\nNegative = Losing to " + str.lower(benchmark_label) + " ❌"
        table.cell(perf_table, 0, current_row, "vs " + benchmark_label, text_color=color.new(COLOR_TEXT_RS_PRIMARY, 0), bgcolor=color.new(COLOR_BG_HEADER, 0), text_size=txt_size, tooltip=vs_benchmark_tooltip)
        table.cell(perf_table, 1, current_row, format_perf(stored_rs_vs_benchmark_1m), text_color=get_color(stored_rs_vs_benchmark_1m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="1M RS vs Sector\n\nStock return minus Sector return.\n\nExample:\nStock +5%, Sector +2% = +3% RS\n(stock winning!)\n\nWeighted 40% in RS Score")
        table.cell(perf_table, 2, current_row, format_perf(stored_rs_vs_benchmark_3m), text_color=get_color(stored_rs_vs_benchmark_3m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="3M RS vs Sector\n\nQuarterly relative performance.\nPositive = Stock stronger than sector\n\nWeighted 30% in RS Score")
        table.cell(perf_table, 3, current_row, format_perf(stored_rs_vs_benchmark_6m), text_color=get_color(stored_rs_vs_benchmark_6m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="6M RS vs Sector\n\nHalf-year relative performance.\nShows mid-term strength vs sector.\n\nWeighted 20% in RS Score")
        table.cell(perf_table, 4, current_row, format_perf(stored_rs_vs_benchmark_1y), text_color=get_color(stored_rs_vs_benchmark_1y), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="1Y RS vs Sector\n\nAnnual relative performance.\nShows long-term strength vs sector.\n\nWeighted 10% in RS Score")
        rs_sector_status = rs_momentum_improving ? "🚀" : rs_momentum_declining ? "⚠️" : "➡️"
        table.cell(perf_table, 5, current_row, rs_sector_status, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="RS Momentum\n\n🚀 = Improving (1M > 3M)\n   Getting stronger!\n⚠️ = Declining (1M < 3M)\n   Getting weaker\n➡️ = Stable")
        current_row += 1

    // Asset vs Market RS - CONDITIONAL (only if not the market benchmark itself)
    if show_vs_market_row
        vs_market_tooltip = "Relative Strength vs " + market_label + "\n\nHow much " + str.lower(asset_label) + " outperformed (+)\nor underperformed (-) " + market_label + ".\n\nPositive = Beating market ✅\nNegative = Losing to market ❌"
        table.cell(perf_table, 0, current_row, "vs " + market_label, text_color=color.new(COLOR_TEXT_RS_PRIMARY, 0), bgcolor=color.new(COLOR_BG_HEADER, 0), text_size=txt_size, tooltip=vs_market_tooltip)
        table.cell(perf_table, 1, current_row, format_perf(stored_rs_vs_market_1m), text_color=get_color(stored_rs_vs_market_1m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="1M RS vs " + market_display_name + "\n\nStock return minus " + market_display_name + " return.\nShows if stock is beating\nthe market this month.")
        table.cell(perf_table, 2, current_row, format_perf(stored_rs_vs_market_3m), text_color=get_color(stored_rs_vs_market_3m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="3M RS vs " + market_display_name + "\n\nQuarterly market performance.\nPositive = Outperforming " + market_display_name)
        table.cell(perf_table, 3, current_row, format_perf(stored_rs_vs_market_6m), text_color=get_color(stored_rs_vs_market_6m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="6M RS vs " + market_display_name + "\n\nHalf-year market performance.\nShows if stock beat market\nover 6 months.")
        table.cell(perf_table, 4, current_row, format_perf(stored_rs_vs_market_1y), text_color=get_color(stored_rs_vs_market_1y), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="1Y RS vs " + market_display_name + "\n\nAnnual market performance.\nLong-term strength vs " + market_display_name + ".")
        rs_spy_status = not na(stored_rs_vs_market_3m) and stored_rs_vs_market_3m > 5 ? "💪" : not na(stored_rs_vs_market_3m) and stored_rs_vs_market_3m < -5 ? "⚠️" : "⚖️"
        table.cell(perf_table, 5, current_row, rs_spy_status, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Market Strength\n\n💪 = Beating market by >5%\n⚠️ = Losing to market by >5%\n⚖️ = Neutral (within ±5%)")
        current_row += 1

    // Benchmark vs Market RS - CONDITIONAL (only if benchmark exists AND different from market)
    if show_benchmark_vs_market_row
        rotation_label = is_stock ? "Sector Rotation" : is_crypto ? "Market Momentum" : is_forex ? "Currency Strength" : "Category Trend"
        benchmark_vs_market_tooltip = rotation_label + "\n\nHow the entire " + str.lower(benchmark_label) + " performs\nvs " + market_label + ".\n\nPositive = Hot " + str.lower(benchmark_label) + " 🔥\nNegative = Cold " + str.lower(benchmark_label) + " ❄️"
        table.cell(perf_table, 0, current_row, benchmark_label + " vs " + market_label, text_color=color.new(COLOR_TEXT_RS_ROTATION, 0), bgcolor=color.new(COLOR_BG_HEADER, 0), text_size=txt_size, tooltip=benchmark_vs_market_tooltip)
        table.cell(perf_table, 1, current_row, format_perf(benchmark_vs_market_1m), text_color=get_color(benchmark_vs_market_1m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="1M Sector Rotation\n\nSector return minus " + market_display_name + " return.\nPositive = Sector outperforming market\nthis month.")
        table.cell(perf_table, 2, current_row, format_perf(benchmark_vs_market_3m), text_color=get_color(benchmark_vs_market_3m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="3M Sector Rotation\n\nShows if sector is hot (positive)\nor cold (negative) this quarter.")
        table.cell(perf_table, 3, current_row, format_perf(benchmark_vs_market_6m), text_color=get_color(benchmark_vs_market_6m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="6M Sector Rotation\n\nHalf-year sector strength vs market.\nHelps identify sector trends.")
        table.cell(perf_table, 4, current_row, format_perf(benchmark_vs_market_1y), text_color=get_color(benchmark_vs_market_1y), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="1Y Sector Rotation\n\nAnnual sector strength vs market.\nIdentifies long-term sector leadership.")
        rotation_status = not na(benchmark_vs_market_3m) and benchmark_vs_market_3m > 5 ? "🔥" : not na(benchmark_vs_market_3m) and benchmark_vs_market_3m < -5 ? "❄️" : "➡️"
        table.cell(perf_table, 5, current_row, rotation_status, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Sector Rotation\n\n🔥 = Hot sector (>5% vs market)\n❄️ = Cold sector (<-5% vs market)\n➡️ = Neutral (within ±5%)")
        current_row += 1

    // Asset vs Leader RS - CONDITIONAL (only if leader exists and is different)
    if show_vs_leader_row
        table.cell(perf_table, 0, current_row, "vs " + leader_label, text_color=color.new(COLOR_TEXT_RS_PRIMARY, 0), bgcolor=color.new(COLOR_BG_HEADER, 0), text_size=txt_size, tooltip="Relative Strength vs " + leader_label + "\n\nHow " + str.lower(asset_label) + " performs vs " + str.lower(leader_label) + ".\n\nPositive = Beating the leader 💎\nNegative = Trailing the leader")
        table.cell(perf_table, 1, current_row, format_perf(stored_rs_vs_leader_1m), text_color=get_color(stored_rs_vs_leader_1m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="1M RS vs Leader\n\nStock return minus Leader return.\nPositive = You're outperforming\nthe sector's strongest stock!")
        table.cell(perf_table, 2, current_row, format_perf(stored_rs_vs_leader_3m), text_color=get_color(stored_rs_vs_leader_3m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="3M RS vs Leader\n\nQuarterly performance vs leader.\nShows if you're gaining or losing\nground vs the top dog.")
        table.cell(perf_table, 3, current_row, format_perf(stored_rs_vs_leader_6m), text_color=get_color(stored_rs_vs_leader_6m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="6M RS vs Leader\n\nHalf-year comparison to\nsector's strongest stock.")
        table.cell(perf_table, 4, current_row, format_perf(stored_rs_vs_leader_1y), text_color=get_color(stored_rs_vs_leader_1y), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="1Y RS vs Leader\n\nAnnual performance vs leader.\nLong-term strength comparison.")
        rs_leader_status = not na(stored_rs_vs_leader_3m) and stored_rs_vs_leader_3m > 0 ? "💎" : not na(stored_rs_vs_leader_3m) and stored_rs_vs_leader_3m < -10 ? "⚠️" : "🔁"
        table.cell(perf_table, 5, current_row, rs_leader_status, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Leader Comparison\n\n💎 = Beating the leader\n   (rare and very strong!)\n⚠️ = Trailing leader by >10%\n🔁 = On par with leader")
        current_row += 1

    // Stock vs Industry ETF RS - CONDITIONAL
    if show_vs_industry_row
        table.cell(perf_table, 0, current_row, "vs Industry", text_color=color.new(COLOR_TEXT_RS_INDUSTRY, 0), bgcolor=color.new(COLOR_BG_HEADER, 0), text_size=txt_size, tooltip="Relative Strength vs Industry ETF\n\nHow stock performs vs its specific industry.\n\nPositive = Beating industry ✅\nNegative = Losing to industry ❌\n\nMore precise than sector comparison.")
        table.cell(perf_table, 1, current_row, format_perf(stored_rs_vs_industry_1m), text_color=get_color(stored_rs_vs_industry_1m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="1M RS vs Industry\n\nStock return minus Industry ETF return.\nShows if stock is beating its peers.")
        table.cell(perf_table, 2, current_row, format_perf(stored_rs_vs_industry_3m), text_color=get_color(stored_rs_vs_industry_3m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="3M RS vs Industry\n\nQuarterly relative performance\nwithin the industry.")
        table.cell(perf_table, 3, current_row, format_perf(stored_rs_vs_industry_6m), text_color=get_color(stored_rs_vs_industry_6m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="6M RS vs Industry\n\nHalf-year strength vs industry peers.")
        table.cell(perf_table, 4, current_row, format_perf(stored_rs_vs_industry_1y), text_color=get_color(stored_rs_vs_industry_1y), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="1Y RS vs Industry\n\nAnnual performance vs industry.\nLong-term industry leadership.")
        rs_industry_status = not na(stored_rs_vs_industry_3m) and stored_rs_vs_industry_3m > 5 ? "🌟" : not na(stored_rs_vs_industry_3m) and stored_rs_vs_industry_3m < -5 ? "⚠️" : "➡️"
        table.cell(perf_table, 5, current_row, rs_industry_status, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Industry RS Status\n\n🌟 = Beating industry by >5%\n   (Industry leader!)\n⚠️ = Losing to industry by >5%\n➡️ = On par with industry")
        current_row += 1

    // Industry vs Sector RS - CONDITIONAL
    if show_industry_vs_sector_row
        table.cell(perf_table, 0, current_row, "Industry vs Sector", text_color=color.new(COLOR_TEXT_IND_VS_SECTOR, 0), bgcolor=color.new(COLOR_BG_HEADER, 0), text_size=txt_size, tooltip="Industry vs Sector Performance\n\nIs this industry leading or lagging\nwithin its sector?\n\nPositive = Hot industry 🔥\nNegative = Cold industry ❄️")
        table.cell(perf_table, 1, current_row, format_perf(stored_industry_vs_sector_1m), text_color=get_color(stored_industry_vs_sector_1m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="1M Industry vs Sector\n\nIs the industry outperforming\nthe broader sector this month?")
        table.cell(perf_table, 2, current_row, format_perf(stored_industry_vs_sector_3m), text_color=get_color(stored_industry_vs_sector_3m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="3M Industry vs Sector\n\nQuarterly industry rotation\nwithin the sector.")
        table.cell(perf_table, 3, current_row, format_perf(stored_industry_vs_sector_6m), text_color=get_color(stored_industry_vs_sector_6m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="6M Industry vs Sector\n\nHalf-year industry strength\nvs sector average.")
        table.cell(perf_table, 4, current_row, format_perf(stored_industry_vs_sector_1y), text_color=get_color(stored_industry_vs_sector_1y), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="1Y Industry vs Sector\n\nAnnual industry performance\nvs sector. Shows long-term trends.")
        industry_rotation_status = not na(stored_industry_vs_sector_3m) and stored_industry_vs_sector_3m > 5 ? "🔥" : not na(stored_industry_vs_sector_3m) and stored_industry_vs_sector_3m < -5 ? "❄️" : "➡️"
        table.cell(perf_table, 5, current_row, industry_rotation_status, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Industry Rotation Status\n\n🔥 = Hot industry (>5% vs sector)\n❄️ = Cold industry (<-5% vs sector)\n➡️ = Neutral")
        current_row += 1

    // Stock vs Industry Leader RS - CONDITIONAL
    if show_vs_industry_leader_row
        table.cell(perf_table, 0, current_row, "vs Ind. Leader", text_color=color.new(COLOR_TEXT_RS_INDUSTRY, 0), bgcolor=color.new(COLOR_BG_HEADER, 0), text_size=txt_size, tooltip="Relative Strength vs Industry Leader\n\nHow stock performs vs the\ntop stock in its industry.\n\nPositive = Beating industry leader 💎\nNegative = Trailing industry leader")
        table.cell(perf_table, 1, current_row, format_perf(stored_rs_vs_industry_leader_1m), text_color=get_color(stored_rs_vs_industry_leader_1m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="1M RS vs Industry Leader\n\nStock return minus Industry Leader return.\nVery impressive if positive!")
        table.cell(perf_table, 2, current_row, format_perf(stored_rs_vs_industry_leader_3m), text_color=get_color(stored_rs_vs_industry_leader_3m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="3M RS vs Industry Leader\n\nQuarterly comparison to\nindustry's best performer.")
        table.cell(perf_table, 3, current_row, format_perf(stored_rs_vs_industry_leader_6m), text_color=get_color(stored_rs_vs_industry_leader_6m), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="6M RS vs Industry Leader\n\nHalf-year strength vs industry top dog.")
        table.cell(perf_table, 4, current_row, format_perf(stored_rs_vs_industry_leader_1y), text_color=get_color(stored_rs_vs_industry_leader_1y), bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="1Y RS vs Industry Leader\n\nAnnual performance vs\nindustry leader.")
        rs_ind_leader_status = not na(stored_rs_vs_industry_leader_3m) and stored_rs_vs_industry_leader_3m > 0 ? "💎" : not na(stored_rs_vs_industry_leader_3m) and stored_rs_vs_industry_leader_3m < -10 ? "⚠️" : "🔁"
        table.cell(perf_table, 5, current_row, rs_ind_leader_status, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Industry Leader Comparison\n\n💎 = Beating industry leader\n   (Exceptional!)\n⚠️ = Trailing by >10%\n🔁 = On par with leader")
        current_row += 1

    // Separator
    table.cell(perf_table, 0, current_row, "OVERALL RATING & ANALYSIS", text_color=color.white, bgcolor=color.new(COLOR_BG_SECTION_RATING, 0), text_size=txt_size)
    table.merge_cells(perf_table, 0, current_row, 5, current_row)
    current_row += 1

    // Scoring Row (Row 13)
    // Recalculate grade and grade_color based on stored_rs_score for display
    stored_grade = get_grade(stored_rs_score)
    stored_grade_color = get_grade_color(stored_grade)

    // Build score display with base, modifiers, and final
    base_score_text = str.tostring(stored_rs_base_score, "#.#")
    modifier_display = stored_rs_modifiers >= 0 ? "+" + str.tostring(stored_rs_modifiers, "#") : str.tostring(stored_rs_modifiers, "#")
    modifier_color = stored_rs_modifiers > 0 ? COLOR_STANDARD_GREEN : stored_rs_modifiers < 0 ? COLOR_STANDARD_RED : COLOR_NEUTRAL
    score_text = str.tostring(stored_rs_score, "#.#") + " / 100"
    consistency_text = str.tostring(consistency_score, "#") + "%"
    consistency_color = consistency_score >= 75 ? COLOR_STANDARD_GREEN : consistency_score >= 50 ? color.yellow : COLOR_STANDARD_RED

    // Build dynamic RS Score tooltip
    rs_score_tooltip = "RS Score Breakdown:\n\n"
    if is_stock and show_vs_industry_row
        // STOCK WITH INDUSTRY DATA
        rs_score_tooltip := rs_score_tooltip + "Base: 50 (neutral)\n\n"
        rs_score_tooltip := rs_score_tooltip + "SECTOR RS (60% weight):\n"
        rs_score_tooltip := rs_score_tooltip + "• 1M: " + format_perf(stored_rs_vs_benchmark_1m) + " × 24% = " + (not na(stored_rs_vs_benchmark_1m) ? str.tostring(stored_rs_vs_benchmark_1m * 0.24, "#.#") : "N/A") + "\n"
        rs_score_tooltip := rs_score_tooltip + "• 3M: " + format_perf(stored_rs_vs_benchmark_3m) + " × 18% = " + (not na(stored_rs_vs_benchmark_3m) ? str.tostring(stored_rs_vs_benchmark_3m * 0.18, "#.#") : "N/A") + "\n"
        rs_score_tooltip := rs_score_tooltip + "• 6M: " + format_perf(stored_rs_vs_benchmark_6m) + " × 12% = " + (not na(stored_rs_vs_benchmark_6m) ? str.tostring(stored_rs_vs_benchmark_6m * 0.12, "#.#") : "N/A") + "\n"
        rs_score_tooltip := rs_score_tooltip + "• 1Y: " + format_perf(stored_rs_vs_benchmark_1y) + " × 6% = " + (not na(stored_rs_vs_benchmark_1y) ? str.tostring(stored_rs_vs_benchmark_1y * 0.06, "#.#") : "N/A") + "\n\n"
        rs_score_tooltip := rs_score_tooltip + "INDUSTRY RS (40% weight):\n"
        rs_score_tooltip := rs_score_tooltip + "• 1M: " + format_perf(stored_rs_vs_industry_1m) + " × 16% = " + (not na(stored_rs_vs_industry_1m) ? str.tostring(stored_rs_vs_industry_1m * 0.16, "#.#") : "N/A") + "\n"
        rs_score_tooltip := rs_score_tooltip + "• 3M: " + format_perf(stored_rs_vs_industry_3m) + " × 12% = " + (not na(stored_rs_vs_industry_3m) ? str.tostring(stored_rs_vs_industry_3m * 0.12, "#.#") : "N/A") + "\n"
        rs_score_tooltip := rs_score_tooltip + "• 6M: " + format_perf(stored_rs_vs_industry_6m) + " × 8% = " + (not na(stored_rs_vs_industry_6m) ? str.tostring(stored_rs_vs_industry_6m * 0.08, "#.#") : "N/A") + "\n"
        rs_score_tooltip := rs_score_tooltip + "• 1Y: " + format_perf(stored_rs_vs_industry_1y) + " × 4% = " + (not na(stored_rs_vs_industry_1y) ? str.tostring(stored_rs_vs_industry_1y * 0.04, "#.#") : "N/A") + "\n\n"
        if show_benchmark_vs_market_row and sector_rotation_bullish
            rs_score_tooltip := rs_score_tooltip + "✅ Bonus: Hot sector (+5)\n"
        if show_industry_vs_sector_row and not na(industry_vs_sector_1m) and industry_vs_sector_1m > 0 and not na(industry_vs_sector_3m) and industry_vs_sector_3m > 0
            rs_score_tooltip := rs_score_tooltip + "✅ Bonus: Hot industry (+5)\n"
        if rs_momentum_improving
            rs_score_tooltip := rs_score_tooltip + "✅ Bonus: Improving momentum (+5)\n"
        if rs_momentum_declining
            rs_score_tooltip := rs_score_tooltip + "❌ Penalty: Declining momentum (-5)\n"
    else if show_vs_benchmark_row
        // NON-STOCK OR NO INDUSTRY DATA
        rs_score_tooltip := rs_score_tooltip + "Base: 50 (neutral)\n\n"
        rs_score_tooltip := rs_score_tooltip + "Weighted RS Components:\n"
        rs_score_tooltip := rs_score_tooltip + "• 1M: " + format_perf(stored_rs_vs_benchmark_1m) + " × 40% = " + (not na(stored_rs_vs_benchmark_1m) ? str.tostring(stored_rs_vs_benchmark_1m * 0.40, "#.#") : "N/A") + "\n"
        rs_score_tooltip := rs_score_tooltip + "• 3M: " + format_perf(stored_rs_vs_benchmark_3m) + " × 30% = " + (not na(stored_rs_vs_benchmark_3m) ? str.tostring(stored_rs_vs_benchmark_3m * 0.30, "#.#") : "N/A") + "\n"
        rs_score_tooltip := rs_score_tooltip + "• 6M: " + format_perf(stored_rs_vs_benchmark_6m) + " × 20% = " + (not na(stored_rs_vs_benchmark_6m) ? str.tostring(stored_rs_vs_benchmark_6m * 0.20, "#.#") : "N/A") + "\n"
        rs_score_tooltip := rs_score_tooltip + "• 1Y: " + format_perf(stored_rs_vs_benchmark_1y) + " × 10% = " + (not na(stored_rs_vs_benchmark_1y) ? str.tostring(stored_rs_vs_benchmark_1y * 0.10, "#.#") : "N/A") + "\n\n"
        if show_benchmark_vs_market_row and sector_rotation_bullish
            rs_score_tooltip := rs_score_tooltip + "✅ Bonus: Hot sector (+5)\n"
        if rs_momentum_improving
            rs_score_tooltip := rs_score_tooltip + "✅ Bonus: Improving momentum (+5)\n"
        if rs_momentum_declining
            rs_score_tooltip := rs_score_tooltip + "❌ Penalty: Declining momentum (-5)\n"
    else
        rs_score_tooltip := rs_score_tooltip + "No benchmark available\n"
        rs_score_tooltip := rs_score_tooltip + "Score defaults to 50 (neutral)\n\n"
        rs_score_tooltip := rs_score_tooltip + "This asset cannot be compared\n"
        rs_score_tooltip := rs_score_tooltip + "to a sector or benchmark.\n"
    rs_score_tooltip := rs_score_tooltip + "\nFinal Score: " + str.tostring(stored_rs_score, "#.#") + " / 100"
    
    // RS Score Row - Final score with breakdown
    modifier_tooltip = "Score Breakdown:\n\nBase: " + base_score_text + "\nModifiers: " + modifier_display + "\nFinal: " + str.tostring(stored_rs_score, "#.#") + "\n\nActive: " + stored_modifier_text
    table.cell(perf_table, 0, current_row, "RS Score", text_color=color.white, bgcolor=color.new(COLOR_BG_HEADER, 0), text_size=txt_size, tooltip="Relative Strength Score (0-100)\n\nFinal Score = Base + Modifiers\n\nFor STOCKS:\n  Sector RS: 60% weight\n  Industry RS: 40% weight\n\nFor OTHER ASSETS:\n  Benchmark RS: 100% weight")
    table.cell(perf_table, 1, current_row, score_text, text_color=stored_grade_color, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip=rs_score_tooltip)
    table.cell(perf_table, 2, current_row, "Grade", text_color=color.white, bgcolor=color.new(COLOR_BG_HEADER, 0), text_size=txt_size, tooltip="Letter Grade\n\nA+ (90+) = Exceptional\nA (85-89) = Excellent\nB (70-84) = Good\nC (50-69) = Average\nD (40-49) = Weak\nF (<40) = Poor")
    table.cell(perf_table, 3, current_row, stored_grade, text_color=stored_grade_color, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Your Stock's Grade\n\nBased on Final RS Score.")
    table.cell(perf_table, 4, current_row, "Consistency", text_color=color.white, bgcolor=color.new(COLOR_BG_HEADER, 0), text_size=txt_size, tooltip="Consistency Score\n\n75%+ = Very consistent\n50-74% = Moderate\n<50% = Inconsistent")
    table.cell(perf_table, 5, current_row, consistency_text, text_color=consistency_color, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="How Reliably Asset Outperforms")
    current_row += 1

    // Base & Modifiers Row - Shows breakdown
    table.cell(perf_table, 0, current_row, "Base", text_color=color.white, bgcolor=color.new(COLOR_BG_HEADER, 0), text_size=txt_size, tooltip="Base RS Score\n\nScore before modifiers.\nCalculated from weighted RS values.\nStarts at 50 (neutral)")
    table.cell(perf_table, 1, current_row, base_score_text, text_color=stored_grade_color, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Base Score = " + base_score_text + "\n\nBefore bonuses/penalties.")
    table.cell(perf_table, 2, current_row, "Modifiers", text_color=color.white, bgcolor=color.new(COLOR_BG_HEADER, 0), text_size=txt_size, tooltip="Score Modifiers\n\nBonuses (+5 each):\n• Hot Sector\n• Hot Industry\n• Improving Momentum\n\nPenalties (-5):\n• Declining Momentum")
    table.cell(perf_table, 3, current_row, modifier_display, text_color=modifier_color, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip=modifier_tooltip)
    table.cell(perf_table, 4, current_row, "Active", text_color=color.white, bgcolor=color.new(COLOR_BG_HEADER, 0), text_size=txt_size, tooltip="Active Modifiers Icons\n\nEach 🔥 = +5 bonus points\n📉 = -5 penalty points\n➡️ = No modifiers (neutral)\n\nBONUSES (+5 each):\n• Hot Sector: Sector beats Market\n  in both 1M and 3M\n• Hot Industry: Industry beats Sector\n  in both 1M and 3M\n• Improving Momentum: 1M RS > 3M RS\n\nPENALTY (-5):\n• Declining Momentum: 1M RS < 3M RS")
    table.cell(perf_table, 5, current_row, stored_modifier_text, text_color=modifier_color, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Current Active Modifiers\n\n🔥🔥🔥 = 3 bonuses (+15)\n🔥🔥 = 2 bonuses (+10)\n🔥 = 1 bonus (+5)\n➡️ = Neutral (0)\n📉 = Penalty (-5)\n\nYour status: " + stored_modifier_text)
    current_row += 1

    // Additional Metrics Row 1 - Always displayed
    avg_rs_text = not na(avg_rs) ? str.tostring(avg_rs, "#.#") + "%" : "N/A"
    price_high_text = not na(price_vs_high) ? str.tostring(price_vs_high, "#.#") + "%" : "N/A"
    price_high_color = not na(price_vs_high) and price_vs_high >= 95 ? COLOR_STANDARD_GREEN : not na(price_vs_high) and price_vs_high >= 80 ? color.yellow : color.white
    rel_vol_text = not na(relative_volume) ? str.tostring(relative_volume, "#.##") + "x" : "N/A"
    rel_vol_color = not na(relative_volume) and relative_volume > 1.5 ? COLOR_BRIGHT_GREEN : color.white

    table.cell(perf_table, 0, current_row, "Avg RS Strength", text_color=color.white, bgcolor=color.new(COLOR_BG_HEADER, 0), text_size=txt_size, tooltip="Average RS Strength\n\nAverage absolute value of all\nRS vs Sector readings.\n\nShows overall magnitude of\nrelative strength (+ or -)")
    table.cell(perf_table, 1, current_row, avg_rs_text, text_color=color.white, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Average RS Magnitude\n\nHigher values = Stronger divergence\nfrom sector (either direction).")
    table.cell(perf_table, 2, current_row, "Price vs 52W High", text_color=color.white, bgcolor=color.new(COLOR_BG_HEADER, 0), text_size=txt_size, tooltip="Price vs 52-Week High\n\nHow close current price is to\nits 52-week high.\n\n95%+ (green) = Near highs\n80-94% (yellow) = Pullback\n<80% = Deep pullback")
    table.cell(perf_table, 3, current_row, price_high_text, text_color=price_high_color, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Current price as % of 52W high\n\nStrong stocks stay near\ntheir highs (95%+).")
    table.cell(perf_table, 4, current_row, "Rel. Volume", text_color=color.white, bgcolor=color.new(COLOR_BG_HEADER, 0), text_size=txt_size, tooltip="Relative Volume\n\nCurrent volume vs 20-period average\n\n1.5x+ (green) = High interest\n1.0x = Average\n<1.0x = Low volume")
    table.cell(perf_table, 5, current_row, rel_vol_text, text_color=rel_vol_color, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Volume Multiplier\n\nHigh relative volume (1.5x+)\nconfirms price moves with\nstrong participation.")
    current_row += 1

    // Additional Metrics Row 2 - CONDITIONAL (only show Days Above/Below if benchmark exists)
    if show_benchmark_row
        beta_text = not na(stored_beta_vs_sector) ? str.tostring(stored_beta_vs_sector, "#.##") : "N/A"
        beta_info = not na(stored_beta_vs_sector) and stored_beta_vs_sector > 1.2 ? " (High)" : not na(stored_beta_vs_sector) and stored_beta_vs_sector < 0.8 ? " (Low)" : ""
        days_above_text = str.tostring(days_above_sector) + " days"
        days_above_color = days_above_sector >= 10 ? color.new(COLOR_BRIGHT_GREEN, 0) : days_above_sector >= 5 ? color.yellow : color.white
        days_below_text = str.tostring(days_below_sector) + " days"
        days_below_color = days_below_sector >= 10 ? color.new(COLOR_BRIGHT_RED, 0) : days_below_sector >= 5 ? color.orange : color.white

        table.cell(perf_table, 0, current_row, "Beta vs Sector", text_color=color.white, bgcolor=color.new(COLOR_BG_HEADER, 0), text_size=txt_size, tooltip="Beta vs Sector\n\nMeasures stock's volatility\nrelative to sector.\n\nBeta > 1.0 = More volatile\nBeta < 1.0 = Less volatile\nBeta = 1.0 = Moves with sector")
        table.cell(perf_table, 1, current_row, beta_text + beta_info, text_color=color.white, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Beta Coefficient\n\nHigher beta = Stock moves more\naggressively than sector.\n\nUseful for risk assessment.")
        table.cell(perf_table, 2, current_row, "Days Above Sector", text_color=color.white, bgcolor=color.new(COLOR_BG_HEADER, 0), text_size=txt_size, tooltip="Days Above Sector\n\nConsecutive days (bars) stock\nhas outperformed sector.\n\nLonger streaks = Sustained strength")
        table.cell(perf_table, 3, current_row, days_above_text, text_color=days_above_color, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Consecutive Bars Outperforming\n\nGreen (10+) = Strong uptrend\nYellow (5-9) = Building momentum\nWhite (1-4) = Early strength\n0 = Not currently outperforming")
        table.cell(perf_table, 4, current_row, "Days Below Sector", text_color=color.white, bgcolor=color.new(COLOR_BG_HEADER, 0), text_size=txt_size, tooltip="Days Below Sector\n\nConsecutive days (bars) stock\nhas underperformed sector.\n\nLonger streaks = Sustained weakness")
        table.cell(perf_table, 5, current_row, days_below_text, text_color=days_below_color, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Consecutive Bars Underperforming\n\nRed (10+) = Sustained weakness\nOrange (5-9) = Losing momentum\nWhite (1-4) = Minor weakness\n0 = ✅ Not underperforming (Good!)")
        current_row += 1

    // Overall Row - Always displayed
    insight = ""
    if stored_grade == "A+" or stored_grade == "A"
        insight := "🌟 Strong Leader"
    else if stored_grade == "A-" or stored_grade == "B+"
        insight := "✅ Above Average"
    else if stored_grade == "B" or stored_grade == "B-"
        insight := "➡️ Average"
    else if stored_grade == "C+" or stored_grade == "C"
        insight := "⚠️ Below Average"
    else
        insight := "❌ Underperformer"

    table.cell(perf_table, 0, current_row, "Overall", text_color=color.white, bgcolor=color.new(COLOR_BG_HEADER, 0), text_size=txt_size, tooltip="Overall Stock Assessment\n\nQuick summary combining grade and RS Score.\nTells you at a glance how strong this\nstock is compared to its sector.")
    table.cell(perf_table, 1, current_row, insight, text_color=stored_grade_color, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Stock Quality Rating\n\n🌟 Strong Leader (A/A+)\n   Top tier stock, crushing it!\n\n✅ Above Average (A-/B+)\n   Solid performer, better than most\n\n➡️ Average (B/B-)\n   Middle of the pack\n\n⚠️ Below Average (C/C+)\n   Struggling, watch carefully\n\n❌ Underperformer (D/F)\n   Weak stock, underperforming badly")
    table.merge_cells(perf_table, 1, current_row, 5, current_row)
    current_row += 1

    // Recommendation Row - Always displayed (uses stored values for consistency with Overall rating)
    // Thresholds aligned with Grade levels: A=80+, B=70+, C=60+, D=50+, F<50
    recommendation = ""
    rec_color = color.gray
    if stored_rs_score >= 80 and consistency_score >= 75 and sector_rotation_bullish
        recommendation := "🚀 STRONG BUY SETUP"
        rec_color := color.new(COLOR_BRIGHT_GREEN, 0)
    else if stored_rs_score >= 70 and consistency_score >= 50
        recommendation := "✅ BULLISH"
        rec_color := color.new(COLOR_STANDARD_GREEN, 0)
    else if stored_rs_score >= 60
        recommendation := "➡️ NEUTRAL"
        rec_color := color.new(color.yellow, 0)
    else if stored_rs_score >= 50
        recommendation := "⚠️ WEAK"
        rec_color := color.new(color.orange, 0)
    else
        recommendation := "❌ AVOID"
        rec_color := color.new(COLOR_STANDARD_RED, 0)

    table.cell(perf_table, 0, current_row, recommendation, text_color=rec_color, bgcolor=color.new(COLOR_BG_DATA_CELL, 0), text_size=txt_size, tooltip="Trading Signal & Setup Quality\n\n🚀 STRONG BUY SETUP\n   RS Score 80+, Consistency 75%+,\n   AND sector is hot (bullish rotation)\n   = Perfect setup! (A grade)\n\n✅ BULLISH\n   RS Score 70+, Consistency 50%+\n   = Strong performer (B grade)\n\n➡️ NEUTRAL\n   RS Score 60+\n   = Average performance (C grade)\n\n⚠️ WEAK\n   RS Score 50+\n   = Below average (D grade)\n\n❌ AVOID\n   RS Score <50\n   = Failing stock (F grade)\n\n⚠️ Educational only - NOT financial advice!")
    table.merge_cells(perf_table, 0, current_row, 5, current_row)
    current_row += 1

// ============================================================================
// ALERTS
// ============================================================================

// RS Score threshold alerts
var float prev_rs_score = na
rs_score_crossed_above = false
rs_score_crossed_below = false

if enable_rs_score_alerts and barstate.isconfirmed
    if not na(prev_rs_score) and not na(rs_score)
        // Crossed above threshold (bullish)
        if prev_rs_score < rs_alert_threshold and rs_score >= rs_alert_threshold
            rs_score_crossed_above := true
        // Crossed below threshold (bearish)
        if prev_rs_score >= rs_alert_threshold and rs_score < rs_alert_threshold
            rs_score_crossed_below := true
    prev_rs_score := rs_score

alertcondition(bullish_divergence, "Bullish Divergence", "Stock significantly outperforming sector!")
alertcondition(bearish_divergence, "Bearish Divergence", "Stock significantly underperforming sector!")
alertcondition(sector_rotation_bullish, "Sector Rotation Bullish", "Sector showing strong rotation - bullish for sector stocks!")
alertcondition(rs_score_crossed_above, "RS Score Crossed Above Threshold", "RS Score crossed above threshold - Strong stock detected!")
alertcondition(rs_score_crossed_below, "RS Score Crossed Below Threshold", "RS Score dropped below threshold - Weakening strength!")

//END 18:30 16/11/2025 - Added comprehensive Industry analysis with ETF mapping, Industry Leader, and RS calculations
//UPDATE 16/11/2025 - Integrated Industry RS into RS Score calculation (60% Sector + 40% Industry for stocks), added Sector Analysis input group, updated tooltips and documentation
//UPDATE 29/11/2025 - Separated score into Base Score + Modifiers display. Modifiers now shown separately with icons (🔥Sector, 🔥Industry, 📈/📉Momentum). Added new table row for Grade & Consistency.
