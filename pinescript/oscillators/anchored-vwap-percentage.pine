//@version=5
indicator("Anchored VWAP Percentage", shorttitle="AVWAP", overlay=false, precision=4)

_asset = input.string("BITCOIN", "Asset", options=['ALTCOINS', 'BITCOIN', 'ETHEREUM', 'FOREX', 'INDICES'], group="Asset Selection")
_c_bull = input.color(color.rgb(0, 255, 100), "Bullish Color", group="Colors")
_c_bear = input.color(color.rgb(255, 0, 50), "Bearish Color", group="Colors")

var string anchor_tf = na
var float p85_threshold = 0.0

_m = timeframe.multiplier
_is_min = timeframe.isminutes
_is_day = timeframe.isdaily

if _asset == "ALTCOINS"
    if _m == 1 and _is_min
        anchor_tf := "480"
        p85_threshold := 0.83
    if _m == 5 and _is_min
        anchor_tf := "480"
        p85_threshold := 0.79
    if _m == 15 and _is_min
        anchor_tf := "W"
        p85_threshold := 4.16
    if _m == 30 and _is_min
        anchor_tf := "W"
        p85_threshold := 4.15
    if _m == 60
        anchor_tf := "W"
        p85_threshold := 4.14
    if _m == 120
        anchor_tf := "M"
        p85_threshold := 8.56
    if _m == 240
        anchor_tf := "M"
        p85_threshold := 8.49
    if _m == 720
        anchor_tf := "12M"
        p85_threshold := 30.04
    if _is_day
        anchor_tf := "12M"
        p85_threshold := 29.80
if _asset == "BITCOIN"
    if _m == 1 and _is_min
        anchor_tf := "480"
        p85_threshold := 0.46
    if _m == 5 and _is_min
        anchor_tf := "480"
        p85_threshold := 0.43
    if _m == 15 and _is_min
        anchor_tf := "W"
        p85_threshold := 3.03
    if _m == 30 and _is_min
        anchor_tf := "W"
        p85_threshold := 3.02
    if _m == 60
        anchor_tf := "W"
        p85_threshold := 2.99
    if _m == 120
        anchor_tf := "M"
        p85_threshold := 7.15
    if _m == 240
        anchor_tf := "M"
        p85_threshold := 7.08
    if _m == 720
        anchor_tf := "12M"
        p85_threshold := 32.09
    if _is_day
        anchor_tf := "12M"
        p85_threshold := 32.05
if _asset == "ETHEREUM"
    if _m == 1 and _is_min
        anchor_tf := "480"
        p85_threshold := 0.63
    if _m == 5 and _is_min
        anchor_tf := "480"
        p85_threshold := 0.60
    if _m == 15 and _is_min
        anchor_tf := "W"
        p85_threshold := 3.92
    if _m == 30 and _is_min
        anchor_tf := "W"
        p85_threshold := 3.91
    if _m == 60
        anchor_tf := "W"
        p85_threshold := 3.89
    if _m == 120
        anchor_tf := "M"
        p85_threshold := 8.80
    if _m == 240
        anchor_tf := "M"
        p85_threshold := 8.74
    if _m == 720
        anchor_tf := "12M"
        p85_threshold := 45.75
    if _is_day
        anchor_tf := "12M"
        p85_threshold := 45.35
if _asset == "FOREX"
    if _m == 1 and _is_min
        anchor_tf := "480"
        p85_threshold := 0.07
    if _m == 5 and _is_min
        anchor_tf := "480"
        p85_threshold := 0.07
    if _m == 15 and _is_min
        anchor_tf := "W"
        p85_threshold := 0.33
    if _m == 30 and _is_min
        anchor_tf := "W"
        p85_threshold := 0.33
    if _m == 60
        anchor_tf := "W"
        p85_threshold := 0.32
    if _m == 120
        anchor_tf := "M"
        p85_threshold := 0.75
    if _m == 240
        anchor_tf := "M"
        p85_threshold := 0.75
    if _m == 720
        anchor_tf := "12M"
        p85_threshold := 3.06
    if _is_day
        anchor_tf := "12M"
        p85_threshold := 3.05
if _asset == "INDICES"
    if _m == 1 and _is_min
        anchor_tf := "480"
        p85_threshold := 0.22
    if _m == 5 and _is_min
        anchor_tf := "480"
        p85_threshold := 0.22
    if _m == 15 and _is_min
        anchor_tf := "W"
        p85_threshold := 1.04
    if _m == 30 and _is_min
        anchor_tf := "W"
        p85_threshold := 1.04
    if _m == 60
        anchor_tf := "W"
        p85_threshold := 1.03
    if _m == 120
        anchor_tf := "M"
        p85_threshold := 2.42
    if _m == 240
        anchor_tf := "M"
        p85_threshold := 2.40
    if _m == 720
        anchor_tf := "12M"
        p85_threshold := 9.35
    if _is_day
        anchor_tf := "12M"
        p85_threshold := 9.34

var float cumVol = 0.0
var float cumPV = 0.0
var int lastAnchorBar = 0

newPeriod = timeframe.change(anchor_tf)

if newPeriod
    lastAnchorBar := bar_index
    cumVol := 0.0
    cumPV := 0.0

if bar_index >= lastAnchorBar
    cumVol := cumVol + volume
    cumPV := cumPV + close * volume

float vwap_val = cumVol != 0 ? cumPV / cumVol : close
float pct = (close - vwap_val) / vwap_val * 100

_hist_color = pct > 0 ? _c_bull : _c_bear
plot(pct, "% Distance", color=_hist_color, style=plot.style_columns, histbase=0)
plot(0, "Zero Line", color=color.gray, linewidth=2)
plot(p85_threshold, "+P85", color=color.new(_c_bull, 50), linewidth=2, style=plot.style_line)
plot(-p85_threshold, "-P85", color=color.new(_c_bear, 50), linewidth=2, style=plot.style_line)

bgcolor(pct > p85_threshold ? color.new(_c_bull, 92) : na, title="Overbought Zone")
bgcolor(pct < -p85_threshold ? color.new(_c_bear, 92) : na, title="Oversold Zone")
