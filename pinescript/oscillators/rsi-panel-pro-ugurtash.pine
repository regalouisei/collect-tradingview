//@version=6
indicator("RSI Panel Pro 1.2 [UgurTash]", overlay=false)

// ==================== RSI SETTINGS ====================
rsi_length     = input.int(14,  title="RSI Length",       minval=2,  maxval=50)
rsi_source     = input.source(close, title="RSI Source")
rsi_overbought = input.int(70,  title="Overbought Level", minval=60, maxval=90)
rsi_oversold   = input.int(30,  title="Oversold Level",   minval=10, maxval=40)

// ==================== SMOOTHING ====================
show_signal   = input.bool(true, title="Show Signal Line (EMA of RSI)")
signal_length = input.int(9,    title="Signal Line Length", minval=2, maxval=20)

// ==================== SIGNAL MODE ====================
grp_sig = "Signal Mode"
simpleSignal   = input.bool(true,  title="Simple Mode (Momentum + HL/LH filtered)", group=grp_sig)
advancedSignal = input.bool(false, title="Advanced Mode (Simple + EMA Trend Filter)", group=grp_sig)
signal_size    = input.string("small", title="Signal Label Size", options=["tiny","small","normal","large","huge"], group=grp_sig)

// Advanced mode settings
grp_adv = "Advanced Mode Settings"
ema_length = input.int(200, title="Trend EMA Length", minval=10, maxval=500, group=grp_adv,
     tooltip="Advanced mode: price must be on correct side of this EMA to confirm signal direction")

// ==================== COLORS ====================
rsi_color_up   = input.color(color.new(color.green, 0),  title="RSI Color (Rising)")
rsi_color_down = input.color(color.new(color.red,   0),  title="RSI Color (Falling)")
ob_color       = input.color(color.new(color.red,   80), title="Overbought Zone Color")
os_color       = input.color(color.new(color.green, 80), title="Oversold Zone Color")

// ==================== PIVOT MARKERS ====================
show_div_markers = input.bool(true, title="Show Pivot Markers on RSI")
pivot_left_p     = input.int(5,    title="Pivot Left",  minval=1, maxval=20)
pivot_right_p    = input.int(5,    title="Pivot Right", minval=0, maxval=20)

// ==================== HISTOGRAM + STATS ====================
show_histogram = input.bool(true, title="Show RSI Histogram")
show_stats     = input.bool(true, title="Show Stats Panel")

// ==================== CALCULATIONS ====================
rsi        = ta.rsi(rsi_source, rsi_length)
signal     = ta.ema(rsi, signal_length)
rsi_rising = rsi > rsi[1]
rsi_color  = rsi_rising ? rsi_color_up : rsi_color_down
ema_trend  = ta.ema(close, ema_length)

// ==================== SIMPLE MODE ====================
rsiMomentum  = ta.change(rsi)
prevRsiLow   = ta.valuewhen(ta.crossover(rsi,  rsi_oversold),   rsi, 1)
prevRsiHigh  = ta.valuewhen(ta.crossunder(rsi, rsi_overbought), rsi, 1)
lowest5      = ta.lowest(close,  5)
highest5     = ta.highest(close, 5)
bullCondSimple = ta.crossover(rsi,  rsi_oversold)   and rsiMomentum >  0.5 and rsi > prevRsiLow  and close > lowest5
bearCondSimple = ta.crossunder(rsi, rsi_overbought) and rsiMomentum < -0.5 and rsi < prevRsiHigh and close < highest5

// ==================== ADVANCED MODE ====================
// Simple mode + EMA trend filter
// Bull: price above EMA (uptrend), Bear: price below EMA (downtrend)
trend_bull  = close > ema_trend
trend_bear  = close < ema_trend
bullCondAdv = bullCondSimple and trend_bull
bearCondAdv = bearCondSimple and trend_bear

// ==================== ACTIVE SIGNALS ====================
bullCond = simpleSignal ? bullCondSimple : advancedSignal ? bullCondAdv : false
bearCond = simpleSignal ? bearCondSimple : advancedSignal ? bearCondAdv : false

// ==================== PLOTS ====================
h1 = hline(rsi_overbought, "Overbought", color=color.new(color.red,   50), linestyle=hline.style_dashed, linewidth=1)
h2 = hline(rsi_oversold,   "Oversold",   color=color.new(color.green, 50), linestyle=hline.style_dashed, linewidth=1)
hline(50, "Midline", color=color.new(color.gray, 60), linestyle=hline.style_dotted, linewidth=1)
fill(h1, h2, color=color.new(color.gray, 92))
ob_fill_top = hline(100, display=display.none)
os_fill_bot = hline(0,   display=display.none)
fill(h1, ob_fill_top, color=ob_color)
fill(h2, os_fill_bot, color=os_color)

rsiPlot     = plot(rsi, "RSI", color=rsi_color, linewidth=2)
midLinePlot = plot(50,  color=na, editable=false, display=display.none)
plot(show_signal ? signal : na, "Signal", color=color.new(color.orange, 0), linewidth=1)
fill(rsiPlot, midLinePlot, 100, 70, top_color=color.new(color.green, 0),   bottom_color=color.new(color.green, 100), title="Overbought Gradient")
fill(rsiPlot, midLinePlot, 30,  0,  top_color=color.new(color.red,   100), bottom_color=color.new(color.red,   0),   title="Oversold Gradient")

rsi_hist   = rsi - 50
hist_color = rsi_hist >= 0 ? color.new(color.green, 60) : color.new(color.red, 60)
plot(show_histogram ? rsi_hist : na, "RSI Hist", color=hist_color, style=plot.style_histogram, linewidth=3)

pivot_high_rsi = ta.pivothigh(rsi, pivot_left_p, pivot_right_p)
pivot_low_rsi  = ta.pivotlow(rsi,  pivot_left_p, pivot_right_p)
plot(show_div_markers and not na(pivot_high_rsi) ? rsi[pivot_right_p] : na,
     "RSI Pivot High", color=color.new(color.red,   0), style=plot.style_circles, linewidth=4, offset=-pivot_right_p)
plot(show_div_markers and not na(pivot_low_rsi)  ? rsi[pivot_right_p] : na,
     "RSI Pivot Low",  color=color.new(color.green, 0), style=plot.style_circles, linewidth=4, offset=-pivot_right_p)

// ==================== SIGNAL SHAPES ====================
plotshape(bullCond and signal_size == "tiny"   ? rsi : na, title="Bull tiny",   text="Bull", style=shape.labelup,   location=location.absolute, color=color.green, textcolor=color.white, size=size.tiny)
plotshape(bullCond and signal_size == "small"  ? rsi : na, title="Bull small",  text="Bull", style=shape.labelup,   location=location.absolute, color=color.green, textcolor=color.white, size=size.small)
plotshape(bullCond and signal_size == "normal" ? rsi : na, title="Bull normal", text="Bull", style=shape.labelup,   location=location.absolute, color=color.green, textcolor=color.white, size=size.normal)
plotshape(bullCond and signal_size == "large"  ? rsi : na, title="Bull large",  text="Bull", style=shape.labelup,   location=location.absolute, color=color.green, textcolor=color.white, size=size.large)
plotshape(bullCond and signal_size == "huge"   ? rsi : na, title="Bull huge",   text="Bull", style=shape.labelup,   location=location.absolute, color=color.green, textcolor=color.white, size=size.huge)
plotshape(bearCond and signal_size == "tiny"   ? rsi : na, title="Bear tiny",   text="Bear", style=shape.labeldown, location=location.absolute, color=color.red,   textcolor=color.white, size=size.tiny)
plotshape(bearCond and signal_size == "small"  ? rsi : na, title="Bear small",  text="Bear", style=shape.labeldown, location=location.absolute, color=color.red,   textcolor=color.white, size=size.small)
plotshape(bearCond and signal_size == "normal" ? rsi : na, title="Bear normal", text="Bear", style=shape.labeldown, location=location.absolute, color=color.red,   textcolor=color.white, size=size.normal)
plotshape(bearCond and signal_size == "large"  ? rsi : na, title="Bear large",  text="Bear", style=shape.labeldown, location=location.absolute, color=color.red,   textcolor=color.white, size=size.large)
plotshape(bearCond and signal_size == "huge"   ? rsi : na, title="Bear huge",   text="Bear", style=shape.labeldown, location=location.absolute, color=color.red,   textcolor=color.white, size=size.huge)

// ==================== BACKGROUND ====================
bgcolor(rsi > rsi_overbought ? color.new(color.red, 93) : rsi < rsi_oversold ? color.new(color.green, 93) : na)

// ==================== ALERTS ====================
alertcondition(bullCond, title="Bullish Signal", message="RSI Bullish Signal")
alertcondition(bearCond, title="Bearish Signal", message="RSI Bearish Signal")

// ==================== STATS PANEL ====================
if show_stats and barstate.islast
    var table t = table.new(position.top_right, 2, 8,
         bgcolor=color.new(color.gray, 90),
         frame_width=2, frame_color=color.new(color.blue, 50),
         border_width=1, border_color=color.new(color.gray, 70))
    table.cell(t, 0, 0, "RSI PANEL PRO", bgcolor=color.new(color.blue, 60), text_color=color.white, text_size=size.small)
    table.merge_cells(t, 0, 0, 1, 0)
    table.cell(t, 0, 1, "RSI:",       text_color=color.white, text_size=size.tiny)
    table.cell(t, 1, 1, str.tostring(rsi, "#.##"), text_color=rsi > rsi_overbought ? color.red : rsi < rsi_oversold ? color.green : color.white, text_size=size.tiny)
    table.cell(t, 0, 2, "Signal:",    text_color=color.white, text_size=size.tiny)
    table.cell(t, 1, 2, str.tostring(signal, "#.##"), text_color=color.orange, text_size=size.tiny)
    table.cell(t, 0, 3, "Momentum:",  text_color=color.white, text_size=size.tiny)
    table.cell(t, 1, 3, str.tostring(rsiMomentum, "#.##"), text_color=rsiMomentum > 0 ? color.green : color.red, text_size=size.tiny)
    table.cell(t, 0, 4, "Mode:",      text_color=color.white, text_size=size.tiny)
    table.cell(t, 1, 4, simpleSignal ? "Simple" : advancedSignal ? "Advanced" : "Off", text_color=color.yellow, text_size=size.tiny)
    table.cell(t, 0, 5, "Trend EMA:", text_color=color.white, text_size=size.tiny)
    table.cell(t, 1, 5, close > ema_trend ? "Bull" : "Bear", text_color=close > ema_trend ? color.green : color.red, text_size=size.tiny)
    table.cell(t, 0, 6, "EMA Value:", text_color=color.white, text_size=size.tiny)
    table.cell(t, 1, 6, str.tostring(ema_trend, format.mintick), text_color=color.aqua, text_size=size.tiny)
    table.cell(t, 0, 7, "Last Signal:", text_color=color.white, text_size=size.tiny)
    table.cell(t, 1, 7, bullCond ? "BULL" : bearCond ? "BEAR" : "-", text_color=bullCond ? color.green : bearCond ? color.red : color.gray, text_size=size.tiny)
