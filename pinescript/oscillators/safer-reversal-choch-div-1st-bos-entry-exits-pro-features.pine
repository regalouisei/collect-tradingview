// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © jeffreykgibson3

//@version=6
indicator("Safer Reversal: CHoCH + Div → 1st BoS Entry + Exits & Pro Features", overlay=true, max_labels_count=500)



// ── Inputs ────────────────────────────────────────────────────────────────

showBull       = input.bool(true,  "Show Bullish Signals")

showBear       = input.bool(true,  "Show Bearish Signals")

rsiLen         = input.int(14,     "RSI Length")

leftBars       = input.int(5,      "Pivot Left Bars")

rightBars      = input.int(5,      "Pivot Right Bars")

requireDiv     = input.bool(true,  "Require Divergence for Setup")

useVolFilter   = input.bool(true,  "Require Above-Avg Volume on Entry BoS")

volLookback    = input.int(20,     "Volume Avg Lookback")

noBoSExitBars  = input.int(15,     "Bars Without BoS → Fade/Exit Alert")

rsiExitOB      = input.int(80,     "RSI Overbought Exit Level (Longs)")

rsiExitOS      = input.int(20,     "RSI Oversold Exit Level (Shorts)")



// ── Calculations ──────────────────────────────────────────────────────────

rsi = ta.rsi(close, rsiLen)

avgVol = ta.sma(volume, volLookback)

highVol = volume > avgVol * 1.2  // 20% above avg for confirmation



priceLow  = ta.pivotlow(low,  leftBars, rightBars)

priceHigh = ta.pivothigh(high, leftBars, rightBars)

rsiLow    = ta.pivotlow(rsi, leftBars, rightBars)

rsiHigh   = ta.pivothigh(rsi, leftBars, rightBars)



// Last pivots

var float lastPLow  = na

var float lastPHigh = na

var float lastRLow  = na

var float lastRHigh = na



if not na(priceLow)

    lastPLow  := priceLow

    lastRLow  := rsiLow

if not na(priceHigh)

    lastPHigh := priceHigh

    lastRHigh := rsiHigh



// Divergence

bullDiv = showBull and not na(priceLow) and not na(lastPLow[1]) and low < lastPLow[1] and rsi > lastRLow[1]

bearDiv = showBear and not na(priceHigh) and not na(lastPHigh[1]) and high > lastPHigh[1] and rsi < lastRHigh[1]



// CHoCH

bullCHoCH = showBull and close > lastPHigh[1] and not na(lastPHigh[1]) and close[1] <= lastPHigh[1]

bearCHoCH = showBear and close < lastPLow[1]  and not na(lastPLow[1])  and close[1] >= lastPLow[1]



// Setup

potentialBullSetup = bullCHoCH and (not requireDiv or bullDiv)

potentialBearSetup = bearCHoCH and (not requireDiv or bearDiv)



// Trend / Trade State

var bool waitingForBullEntry = false

var bool waitingForBearEntry = false

var bool inBullTrade         = false

var bool inBearTrade         = false

var int  entryBarBull        = na

var int  entryBarBear        = na

var int  lastBoSBarBull      = na

var int  lastBoSBarBear      = na



if potentialBullSetup

    waitingForBullEntry := true

    waitingForBearEntry := false

    inBullTrade         := false

    inBearTrade         := false



if potentialBearSetup

    waitingForBearEntry := true

    waitingForBullEntry := false

    inBullTrade         := false

    inBearTrade         := false



// BoS

bullBoS = close > lastPHigh and not na(lastPHigh[1])

bearBoS = close < lastPLow  and not na(lastPLow[1])



// Entry

buyEntry  = waitingForBullEntry and bullBoS and (not useVolFilter or highVol)

sellEntry = waitingForBearEntry and bearBoS and (not useVolFilter or highVol)



// Update states on entry + reset waiting

if buyEntry

    waitingForBullEntry := false

    inBullTrade         := true

    inBearTrade         := false

    entryBarBull        := bar_index

    lastBoSBarBull      := bar_index



if sellEntry

    waitingForBearEntry := false

    inBearTrade         := true

    inBullTrade         := false

    entryBarBear        := bar_index

    lastBoSBarBear      := bar_index



// Continuation BoS (update last BoS bar)

if inBullTrade and bullBoS

    lastBoSBarBull := bar_index

if inBearTrade and bearBoS

    lastBoSBarBear := bar_index



// Exits / Warnings

opposingCHoCH_Bull = inBullTrade and bearCHoCH  // Exit long on bearish CHoCH

opposingCHoCH_Bear = inBearTrade and bullCHoCH  // Exit short on bullish CHoCH



noMoreBoS_Bull = inBullTrade and (bar_index - lastBoSBarBull > noBoSExitBars)

noMoreBoS_Bear = inBearTrade and (bar_index - lastBoSBarBear > noBoSExitBars)



rsiExitLong = inBullTrade and rsi > rsiExitOB

rsiExitShort = inBearTrade and rsi < rsiExitOS



// Labels

if potentialBullSetup

    label.new(bar_index, low, "Potential BUY Setup", color=color.new(color.green,60), textcolor=color.green, style=label.style_label_up, size=size.tiny)

if potentialBearSetup

    label.new(bar_index, high, "Potential SELL Setup", color=color.new(color.red,60), textcolor=color.red, style=label.style_label_down, size=size.tiny)



if buyEntry

    label.new(bar_index, low, "ENTER BUY\n1st BoS", color=color.green, textcolor=color.white, style=label.style_label_up, size=size.small)

if sellEntry

    label.new(bar_index, high, "ENTER SELL\n1st BoS", color=color.red, textcolor=color.white, style=label.style_label_down, size=size.small)



if inBullTrade and bullBoS

    label.new(bar_index, low, "Hold/Continue BUY\nBoS + Trail?", color=color.lime, textcolor=color.black, style=label.style_label_up, size=size.tiny)

if inBearTrade and bearBoS

    label.new(bar_index, high, "Hold/Continue SELL\nBoS + Trail?", color=color.maroon, textcolor=color.white, style=label.style_label_down, size=size.tiny)



if opposingCHoCH_Bull

    label.new(bar_index, high, "EXIT BUY\nOpposing CHoCH", color=color.orange, textcolor=color.black, style=label.style_label_down, size=size.small)

if opposingCHoCH_Bear

    label.new(bar_index, low, "EXIT SELL\nOpposing CHoCH", color=color.orange, textcolor=color.black, style=label.style_label_up, size=size.small)



if noMoreBoS_Bull

    label.new(bar_index, high, "FADE/EXIT BUY\nNo BoS " + str.tostring(noBoSExitBars) + " bars", color=color.purple, textcolor=color.white, style=label.style_label_down, size=size.tiny)

if noMoreBoS_Bear

    label.new(bar_index, low, "FADE/EXIT SELL\nNo BoS " + str.tostring(noBoSExitBars) + " bars", color=color.purple, textcolor=color.white, style=label.style_label_up, size=size.tiny)



// Alerts

if buyEntry

    alert("ENTER BUY - Confirmed 1st BoS after setup!", alert.freq_once_per_bar_close)

if sellEntry

    alert("ENTER SELL - Confirmed 1st BoS after setup!", alert.freq_once_per_bar_close)

if opposingCHoCH_Bull

    alert("EXIT BUY - Opposing Bearish CHoCH detected!", alert.freq_once_per_bar_close)

if opposingCHoCH_Bear

    alert("EXIT SELL - Opposing Bullish CHoCH detected!", alert.freq_once_per_bar_close)

if noMoreBoS_Bull

    alert("FADE/EXIT BUY - No new BoS in " + str.tostring(noBoSExitBars) + " bars. Momentum fading?", alert.freq_once_per_bar_close)

if noMoreBoS_Bear

    alert("FADE/EXIT SELL - No new BoS in " + str.tostring(noBoSExitBars) + " bars. Momentum fading?", alert.freq_once_per_bar_close)



// Visuals

plotshape(priceHigh, "Swing High", style=shape.circle, location=location.abovebar, color=color.red, size=size.tiny)

plotshape(priceLow, "Swing Low", style=shape.circle, location=location.belowbar, color =color.green, size=size.tiny)

plot(rsi, "RSI", color=#7E57C2, linewidth=1)

hline(70, "OB", color=color.red)


hline(30, "OS", color=color.green)
plot(close)
