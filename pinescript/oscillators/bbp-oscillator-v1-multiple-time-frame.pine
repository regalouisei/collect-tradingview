//@version=6
indicator("Bull Bear Power Minimal + HTF/LTF Filter", shorttitle="BBP+", overlay=false, max_lines_count=500, max_labels_count=500)

// ─────────────── INPUTS ───────────────
bbpLength      = input.int(13, "BBP Length")
emaTrendLength = input.int(50, "EMA Trend (Current TF)")

htf_tf         = input.timeframe("D", "HTF Timeframe")
htf_emaLength  = input.int(50, "HTF EMA Length")
useHTF         = input.bool(true, "Enable HTF Filter?")   // Ana trend filtresi

ltf_tf         = input.timeframe("60", "LTF Timeframe")
useLTF         = input.bool(false, "Enable LTF Filter?")  // Sadece filtre opsiyonu

showSignals    = input.bool(true, "Show Signals")

// ─────────────── CURRENT TF CALC ───────────────
emaClose     = ta.ema(close, bbpLength)
bullPower    = high - emaClose
bearPower    = low - emaClose
bbp          = bullPower + bearPower
bbpChange    = bbp - bbp[1]
emaTrend     = ta.ema(close, emaTrendLength)
bearishTrend = close < emaTrend

// ─────────────── HIGHER TF TREND ───────────────
htf_close     = request.security(syminfo.tickerid, htf_tf, close)
htf_ema       = request.security(syminfo.tickerid, htf_tf, ta.ema(htf_close, htf_emaLength))
htf_bearTrend = htf_close < htf_ema

// ─────────────── LOWER TF FILTER (LTF) ───────────────
ltf_bbp       = request.security(syminfo.tickerid, ltf_tf, high - ta.ema(close, bbpLength) + low - ta.ema(close, bbpLength))
ltf_bbpChange = ltf_bbp - ltf_bbp[1]
ltf_filter    = useLTF ? (ltf_bbpChange < 0 and ltf_bbp > 0) : true  // sadece momentum düşüşü kontrolü

// ─────────────── PLOTS ───────────────
// Minimalist BBP histogram
plot(bbp, color = bbp >= 0 ? #089981 : #f23645, title="BBPower", style = plot.style_columns)
hline(0, "Zero line", color=color.gray, linestyle=hline.style_dashed, linewidth=1)

// HTF filtered bearish signal (LTF sadece filtre olarak kullanılır)
bearSignal = showSignals and bearishTrend and bbpChange < 0 and bbp > 0 and (useHTF ? htf_bearTrend : true) and ltf_filter
plotshape(bearSignal, title="Bearish Signal (HTF)", style=shape.triangledown, 
     location=location.top, color=#f23645, size=size.small, text="▼")

// ─────────────── ALERTS ───────────────
alertcondition(bearSignal, title="Bearish Alert (HTF)", message="BBP bearish signal detected (HTF filtered)")
