//@version=6
indicator("MACD + Stochastic 14 Scenarios", overlay=true, max_labels_count=500)

// ============================================================================
// INPUT PARAMETERS
// ============================================================================

// MACD Settings
macd_fast = input.int(12, "MACD Fast Length", minval=1)
macd_slow = input.int(26, "MACD Slow Length", minval=1)
macd_signal = input.int(9, "MACD Signal Length", minval=1)

// Stochastic Settings
stoch_k = input.int(14, "Stochastic K Length", minval=1)
stoch_d = input.int(3, "Stochastic D Length", minval=1)
stoch_smooth = input.int(3, "Stochastic Smoothing", minval=1)

// Display Settings
show_strong = input.bool(true, "Show Strong Signals", group="Signal Display")
show_moderate = input.bool(true, "Show Moderate Signals", group="Signal Display")
show_weak = input.bool(true, "Show Weak Signals", group="Signal Display")
show_labels = input.bool(true, "Show Signal Labels", group="Signal Display")
show_table = input.bool(true, "Show Info Table", group="Signal Display")

// ============================================================================
// INDICATOR CALCULATIONS
// ============================================================================

// MACD Calculation
[macd_line, signal_line, hist] = ta.macd(close, macd_fast, macd_slow, macd_signal)

// Stochastic Calculation
k = ta.sma(ta.stoch(close, high, low, stoch_k), stoch_smooth)
d = ta.sma(k, stoch_d)

// ============================================================================
// CROSSOVER DETECTION
// ============================================================================

// Stochastic Crossovers
stoch_cross_up = ta.crossover(k, d)        // %K crosses above %D
stoch_cross_down = ta.crossunder(k, d)     // %K crosses below %D
stoch_already_up = k > d and not stoch_cross_up    // %K already above %D
stoch_already_down = k < d and not stoch_cross_down // %K already below %D

// MACD Crossovers
macd_cross_up = ta.crossover(macd_line, signal_line)      // MACD crosses above signal
macd_cross_down = ta.crossunder(macd_line, signal_line)   // MACD crosses below signal
macd_already_up = macd_line > signal_line and not macd_cross_up     // MACD already above signal
macd_already_down = macd_line < signal_line and not macd_cross_down // MACD already below signal

// ============================================================================
// 16 SCENARIO DETECTION
// ============================================================================

// STRONG SIGNALS
scenario_1 = stoch_cross_up and macd_cross_up      // Strong Buy
scenario_7 = stoch_cross_down and macd_cross_down  // Strong Sell

// MODERATE SIGNALS
scenario_2 = stoch_cross_up and macd_already_up    // Moderate Buy
scenario_8 = stoch_cross_down and macd_already_down // Moderate Sell
scenario_9 = stoch_already_up and macd_cross_up    // Moderate Buy
scenario_10 = stoch_already_up and macd_already_up // Moderate Buy
scenario_15 = stoch_already_down and macd_cross_down // Moderate Sell
scenario_16 = stoch_already_down and macd_already_down // Moderate Sell

// WEAK SIGNALS
scenario_3 = stoch_cross_up and macd_cross_down    // Weak Buy
scenario_4 = stoch_cross_up and macd_already_down  // Weak Buy
scenario_5 = stoch_cross_down and macd_cross_up    // Weak Sell
scenario_6 = stoch_cross_down and macd_already_up  // Weak Sell
scenario_11 = stoch_already_up and macd_cross_down // Weak Sell
scenario_13 = stoch_already_down and macd_cross_up // Weak Buy

// ============================================================================
// AGGREGATE SIGNALS BY STRENGTH
// ============================================================================

// Strong Signals
strong_buy = scenario_1
strong_sell = scenario_7

// Moderate Signals
moderate_buy = scenario_2 or scenario_9 or scenario_10
moderate_sell = scenario_8 or scenario_15 or scenario_16

// Weak Signals
weak_buy = scenario_3 or scenario_4 or scenario_13
weak_sell = scenario_5 or scenario_6 or scenario_11

// ============================================================================
// PLOTTING SIGNALS ON CHART
// ============================================================================

// Strong Buy/Sell
plotshape(show_strong and strong_buy, "Strong Buy", shape.triangleup, location.belowbar,
         color.new(color.green, 0), size=size.large)
plotshape(show_strong and strong_sell, "Strong Sell", shape.triangledown, location.abovebar,
         color.new(color.red, 0), size=size.large)

// Moderate Buy/Sell
plotshape(show_moderate and moderate_buy, "Moderate Buy", shape.circle, location.belowbar,
         color.new(color.lime, 20), size=size.normal)
plotshape(show_moderate and moderate_sell, "Moderate Sell", shape.circle, location.abovebar,
         color.new(color.orange, 20), size=size.normal)

// Weak Buy/Sell
plotshape(show_weak and weak_buy, "Weak Buy", shape.xcross, location.belowbar,
         color.new(color.aqua, 40), size=size.small)
plotshape(show_weak and weak_sell, "Weak Sell", shape.xcross, location.abovebar,
         color.new(color.fuchsia, 40), size=size.small)

// ============================================================================
// SIGNAL LABELS
// ============================================================================

if show_labels
    // Strong Buy
    if strong_buy
        label.new(bar_index, low, "STRONG BUY\nScenario 1",
                 style=label.style_label_up, color=color.green,
                 textcolor=color.white, size=size.normal)

    // Strong Sell
    if strong_sell
        label.new(bar_index, high, "STRONG SELL\nScenario 7",
                 style=label.style_label_down, color=color.red,
                 textcolor=color.white, size=size.normal)

    // Moderate Buy
    if scenario_2
        label.new(bar_index, low, "MODERATE BUY\nScenario 2",
                 style=label.style_label_up, color=color.lime,
                 textcolor=color.black, size=size.small)
    if scenario_9
        label.new(bar_index, low, "MODERATE BUY\nScenario 9",
                 style=label.style_label_up, color=color.lime,
                 textcolor=color.black, size=size.small)
    if scenario_10
        label.new(bar_index, low, "MODERATE BUY\nScenario 10",
                 style=label.style_label_up, color=color.lime,
                 textcolor=color.black, size=size.small)

    // Moderate Sell
    if scenario_8
        label.new(bar_index, high, "MODERATE SELL\nScenario 8",
                 style=label.style_label_down, color=color.orange,
                 textcolor=color.white, size=size.small)
    if scenario_15
        label.new(bar_index, high, "MODERATE SELL\nScenario 15",
                 style=label.style_label_down, color=color.orange,
                 textcolor=color.white, size=size.small)
    if scenario_16
        label.new(bar_index, high, "MODERATE SELL\nScenario 16",
                 style=label.style_label_down, color=color.orange,
                 textcolor=color.white, size=size.small)

    // Weak Buy
    if scenario_3
        label.new(bar_index, low, "WEAK BUY\nScenario 3",
                 style=label.style_label_up, color=color.aqua,
                 textcolor=color.white, size=size.tiny)
    if scenario_4
        label.new(bar_index, low, "WEAK BUY\nScenario 4",
                 style=label.style_label_up, color=color.aqua,
                 textcolor=color.white, size=size.tiny)
    if scenario_13
        label.new(bar_index, low, "WEAK BUY\nScenario 13",
                 style=label.style_label_up, color=color.aqua,
                 textcolor=color.white, size=size.tiny)

    // Weak Sell
    if scenario_5
        label.new(bar_index, high, "WEAK SELL\nScenario 5",
                 style=label.style_label_down, color=color.fuchsia,
                 textcolor=color.white, size=size.tiny)
    if scenario_6
        label.new(bar_index, high, "WEAK SELL\nScenario 6",
                 style=label.style_label_down, color=color.fuchsia,
                 textcolor=color.white, size=size.tiny)
    if scenario_11
        label.new(bar_index, high, "WEAK SELL\nScenario 11",
                 style=label.style_label_down, color=color.fuchsia,
                 textcolor=color.white, size=size.tiny)

// ============================================================================
// INFO TABLE
// ============================================================================

if show_table
    var table info_table = table.new(position.top_right, 2, 8,
                                     border_width=1, border_color=color.gray)

    // Current scenario detection
    current_scenario = ""
    current_signal = ""
    signal_color = color.gray

    if scenario_1
        current_scenario := "Scenario 1"
        current_signal := "STRONG BUY"
        signal_color := color.green
    else if scenario_2
        current_scenario := "Scenario 2"
        current_signal := "MODERATE BUY"
        signal_color := color.lime
    else if scenario_3
        current_scenario := "Scenario 3"
        current_signal := "WEAK BUY"
        signal_color := color.aqua
    else if scenario_4
        current_scenario := "Scenario 4"
        current_signal := "WEAK BUY"
        signal_color := color.aqua
    else if scenario_5
        current_scenario := "Scenario 5"
        current_signal := "WEAK SELL"
        signal_color := color.fuchsia
    else if scenario_6
        current_scenario := "Scenario 6"
        current_signal := "WEAK SELL"
        signal_color := color.fuchsia
    else if scenario_7
        current_scenario := "Scenario 7"
        current_signal := "STRONG SELL"
        signal_color := color.red
    else if scenario_8
        current_scenario := "Scenario 8"
        current_signal := "MODERATE SELL"
        signal_color := color.orange
    else if scenario_9
        current_scenario := "Scenario 9"
        current_signal := "MODERATE BUY"
        signal_color := color.lime
    else if scenario_10
        current_scenario := "Scenario 10"
        current_signal := "MODERATE BUY"
        signal_color := color.lime
    else if scenario_11
        current_scenario := "Scenario 11"
        current_signal := "WEAK SELL"
        signal_color := color.fuchsia
    else if scenario_13
        current_scenario := "Scenario 13"
        current_signal := "WEAK BUY"
        signal_color := color.aqua
    else if scenario_15
        current_scenario := "Scenario 15"
        current_signal := "MODERATE SELL"
        signal_color := color.orange
    else if scenario_16
        current_scenario := "Scenario 16"
        current_signal := "MODERATE SELL"
        signal_color := color.orange
    else
        current_scenario := "None"
        current_signal := "NO SIGNAL"
        signal_color := color.gray

    // Table headers
    table.cell(info_table, 0, 0, "MACD + Stoch", bgcolor=color.new(color.blue, 70),
              text_color=color.white, text_size=size.normal)
    table.cell(info_table, 1, 0, "14 Scenarios", bgcolor=color.new(color.blue, 70),
              text_color=color.white, text_size=size.normal)

    // Current signal
    table.cell(info_table, 0, 1, "Current Signal:", text_color=color.white,
              text_size=size.small)
    table.cell(info_table, 1, 1, current_signal, bgcolor=signal_color,
              text_color=color.white, text_size=size.normal)

    // Scenario number
    table.cell(info_table, 0, 2, "Scenario:", text_color=color.white,
              text_size=size.small)
    table.cell(info_table, 1, 2, current_scenario, text_color=color.white,
              text_size=size.small)

    // MACD status
    macd_status = macd_cross_up ? "Cross Up" :
                 macd_cross_down ? "Cross Down" :
                 macd_already_up ? "Above Signal" : "Below Signal"
    table.cell(info_table, 0, 3, "MACD:", text_color=color.white,
              text_size=size.small)
    table.cell(info_table, 1, 3, macd_status, text_color=color.white,
              text_size=size.small)

    // Stochastic status
    stoch_status = stoch_cross_up ? "Cross Up" :
                  stoch_cross_down ? "Cross Down" :
                  stoch_already_up ? "Above %D" : "Below %D"
    table.cell(info_table, 0, 4, "Stochastic:", text_color=color.white,
              text_size=size.small)
    table.cell(info_table, 1, 4, stoch_status, text_color=color.white,
              text_size=size.small)

    // Signal counts
    table.cell(info_table, 0, 5, "Signal Counts:", text_color=color.yellow,
              text_size=size.small)
    table.cell(info_table, 1, 5, "", text_size=size.small)

    // Count occurrences on visible bars
    var int strong_buy_count = 0
    var int strong_sell_count = 0
    var int moderate_buy_count = 0
    var int moderate_sell_count = 0

    if strong_buy
        strong_buy_count += 1
    if strong_sell
        strong_sell_count += 1
    if moderate_buy
        moderate_buy_count += 1
    if moderate_sell
        moderate_sell_count += 1

    table.cell(info_table, 0, 6, "Strong: " + str.tostring(strong_buy_count) + " / " + str.tostring(strong_sell_count),
              text_color=color.white, text_size=size.tiny)
    table.cell(info_table, 1, 6, "Moderate: " + str.tostring(moderate_buy_count) + " / " + str.tostring(moderate_sell_count),
              text_color=color.white, text_size=size.tiny)

// ============================================================================
// ALERTS
// ============================================================================

// Alert conditions
alertcondition(strong_buy, "Strong Buy Signal", "STRONG BUY - Scenario 1: Both MACD and Stochastic cross bullish!")
alertcondition(strong_sell, "Strong Sell Signal", "STRONG SELL - Scenario 7: Both MACD and Stochastic cross bearish!")
alertcondition(moderate_buy, "Moderate Buy Signal", "MODERATE BUY - Stochastic or MACD confirms bullish trend")
alertcondition(moderate_sell, "Moderate Sell Signal", "MODERATE SELL - Stochastic or MACD confirms bearish trend")
alertcondition(weak_buy, "Weak Buy Signal", "WEAK BUY - Mixed signals with bullish bias")
alertcondition(weak_sell, "Weak Sell Signal", "WEAK SELL - Mixed signals with bearish bias")
