//@version=5
// MIZAN TRINITY OSCILLATOR [MTO]
// Philosophy: Velocity (CCI), Money (CMF), and Mass (OBV) synthesized into a single frequency.
indicator("Mizan Trinity Oscillator", shorttitle="Mizan-TO", overlay=false)

// ==========================================
// 1. SETTINGS
// ==========================================
// --- TRINITY WEIGHTS ---
grp_w = "1. Trinity Synthesis Weights"
w_cci = input.float(0.35, "Velocity (CCI) Weight", minval=0.0, step=0.05, group=grp_w)
w_cmf = input.float(0.45, "Money Flow (CMF) Weight", minval=0.0, step=0.05, group=grp_w)
w_obv = input.float(0.20, "Mass (OBV) Weight", minval=0.0, step=0.05, group=grp_w)

// --- SENSITIVITY ---
grp_s = "2. Sensitivity Settings"
len_main = input.int(14, "Main Period", group=grp_s)
smooth   = input.int(3, "Smoothing (WMA)", minval=1, group=grp_s)
use_turb = input.bool(true, "Turbulence Filter (Gray Zone)", group=grp_s)

// ==========================================
// 2. DATA NORMALIZATION (0-100 SCALE)
// ==========================================
// A. VELOCITY (CCI)
cci_raw = ta.cci(close, len_main)
// CCI is usually between -200/+200. Compressing to 0-100.
norm_cci = (math.min(math.max(cci_raw, -200), 200) + 200) / 400 * 100

// B. MONEY (CMF) - Manual Calculation
mfm     = high != low ? ((close - low) - (high - close)) / (high - low) : 0.0
cmf_num = math.sum(mfm * volume, 20)
cmf_den = math.sum(volume, 20)
cmf_val = cmf_den != 0 ? cmf_num / cmf_den : 0
// CMF is between -0.5/+0.5. Compressing to 0-100.
norm_cmf = (math.min(math.max(cmf_val, -0.5), 0.5) + 0.5) * 100

// C. MASS (OBV Momentum)
obv_raw = ta.obv
obv_roc = ta.roc(obv_raw, 10) // 10-bar Rate of Change

// OBV Normalization
obv_highest = ta.highest(obv_roc, 100)
obv_lowest  = ta.lowest(obv_roc, 100)
norm_obv = (obv_roc - obv_lowest) / (math.max(obv_highest - obv_lowest, syminfo.mintick)) * 100

// ==========================================
// 3. TRINITY ENGINE (L-SCORE SYNTHESIS)
// ==========================================
// Formula: (Velocity * w1) + (Money * w2) + (Mass * w3)
raw_score = (norm_cci * w_cci) + (norm_cmf * w_cmf) + (norm_obv * w_obv)

// Mizan Effect (Smoothing)
mto_val = ta.wma(raw_score, smooth)

// ==========================================
// 4. QUALITY CONTROL (TURBULENCE & SILENCE)
// ==========================================
// Turbulence Calculation (Measuring oscillator noise)
osc_noise = math.abs(ta.change(mto_val))
avg_noise = ta.sma(osc_noise, 20)
is_turb = use_turb ? (osc_noise > (avg_noise * 2.0)) : false

// Volume Check (Low volume filter)
vol_check = volume < (ta.sma(volume, 50) * 0.7)

// SILENCE DECISION
is_silent = is_turb or vol_check

// ==========================================
// 5. VISUALIZATION
// ==========================================
// SOLUTION: Two separate plots. One for Active (Thick), one for Silent (Thin).

// 1. ACTIVE MODE (Colored & Thick) - Draws only if NOT silent
active_color = mto_val > mto_val[1] ? #00bcd4 : #ff9800
plot(is_silent ? na : mto_val, "Mizan Active", color=active_color, linewidth=3)

// 2. SILENT MODE (Gray & Thin) - Draws only if SILENT
plot(is_silent ? mto_val : na, "Mizan Silent", color=color.new(color.gray, 30), linewidth=1)

// Reference Lines
hline(80, "Overbought", color=color.gray, linestyle=hline.style_dotted)
hline(20, "Oversold", color=color.gray, linestyle=hline.style_dotted)
hline(50, "Equilibrium (50)", color=color.new(color.white, 80))

// Zone Filling
fill_col = mto_val > 80 ? color.new(#00bcd4, 80) : (mto_val < 20 ? color.new(#ff9800, 80) : na)
bgcolor(fill_col, title="Extreme Zones")

// ==========================================
// 6. DASHBOARD
// ==========================================
if barstate.islast
    var table pnl = table.new(position.top_right, 2, 2, bgcolor=color.new(color.black, 50))
    
    // Status Logic
    status = is_silent ? "SILENT (Noise)" : (mto_val > 50 ? "POSITIVE FLOW" : "NEGATIVE FLOW")
    c_stat = is_silent ? color.gray : (mto_val > 50 ? #00bcd4 : #ff9800)
    
    // Panel Draw
    table.cell(pnl, 0, 0, "TRINITY SCORE", text_color=color.gray, text_size=size.small)
    table.cell(pnl, 1, 0, str.tostring(mto_val, "#.1"), text_color=active_color, text_size=size.normal)
    
    table.cell(pnl, 0, 1, "MODE", text_color=color.gray, text_size=size.small)
    table.cell(pnl, 1, 1, status, text_color=c_stat, text_size=size.small)
