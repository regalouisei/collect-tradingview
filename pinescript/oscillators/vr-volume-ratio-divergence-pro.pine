//@version=5
indicator(title="VR Pro: Designer Edition (Fix)", shorttitle="VR Pro", format=format.price, precision=2)

// ==========================================
// 1. 參數設定 (Settings)
// ==========================================
// --- 計算參數 ---
group_calc = "核心計算"
length = input.int(26, minval=1, title="VR 週期", group=group_calc)

// --- 顏色與外觀 ---
group_vis = "視覺設計"
color_area_bull = input.color(color.new(color.red, 75), "多方填充 (Bull Area)", group=group_vis)
color_area_bear = input.color(color.new(color.green, 75), "空方填充 (Bear Area)", group=group_vis)
show_line = input.bool(true, "顯示主線", group=group_vis)

// --- HUD 面板設定 ---
group_hud = "右側資訊面板 (HUD)"
show_hud = input.bool(true, "啟用面板", group=group_hud)
hud_size = input.string("Normal", "面板大小", options=["Small", "Normal", "Large"], group=group_hud)
hud_pos_v = input.string("Middle", "垂直位置", options=["Top", "Middle", "Bottom"], group=group_hud)

// --- 關鍵水位 ---
group_lvl = "關鍵水位"
base_level = 100
low_level = input.int(40, title="底部 (Oversold)", group=group_lvl)
bull_level = input.int(260, title="強勢 (Bullish)", group=group_lvl)
high_level = input.int(450, title="頭部 (Overbought)", group=group_lvl)

// --- 背離偵測 ---
group_div = "背離訊號"
lbL = input.int(5, title="Pivot Left", group=group_div)
lbR = input.int(2, title="Pivot Right", group=group_div)

// ==========================================
// 2. 核心邏輯 (Calculation)
// ==========================================
is_up = close > close[1]
is_down = close < close[1]
is_flat = close == close[1]

up_vol = is_up ? volume : 0
down_vol = is_down ? volume : 0
flat_vol = is_flat ? volume : 0

qu = math.sum(up_vol, length)
qd = math.sum(down_vol, length)
qf = math.sum(flat_vol, length)

numerator = qu + (qf / 2)
denominator = qd + (qf / 2)
vr = denominator != 0 ? (numerator / denominator) * 100 : 0

// ==========================================
// 3. 繪圖 (Plotting)
// ==========================================
p_base = plot(base_level, "Base", color=color.new(color.gray, 100), display=display.none)

line_col = vr >= vr[1] ? color.red : color.green
p_vr = plot(vr, "VR Line", color=show_line ? line_col : na, linewidth=2)

fill(p_vr, p_base, color = vr >= base_level ? color_area_bull : color_area_bear, title="Area Fill")

hline(low_level, "Low", color=color.new(color.green, 50), linestyle=hline.style_solid)
hline(bull_level, "Bull", color=color.new(color.orange, 50), linestyle=hline.style_dashed)
hline(high_level, "High", color=color.new(color.red, 50), linestyle=hline.style_solid)

// ==========================================
// 4. 背離偵測 (Divergence)
// ==========================================
pl = ta.pivotlow(vr, lbL, lbR)
ph = ta.pivothigh(vr, lbL, lbR)

var float old_vr_low = na
var float old_price_low = na
bool bull_div = false
if (not na(pl))
    if (not na(old_vr_low) and vr[lbR] > old_vr_low and close[lbR] < old_price_low)
        bull_div := true
    old_vr_low := vr[lbR]
    old_price_low := close[lbR]

var float old_vr_high = na
var float old_price_high = na
bool bear_div = false
if (not na(ph))
    if (not na(old_vr_high) and vr[lbR] < old_vr_high and close[lbR] > old_price_high)
        bear_div := true
    old_vr_high := vr[lbR]
    old_price_high := close[lbR]

// --- 修正 plotshape 語法 ---
// 使用 location.absolute 是錯誤的。我們應該使用 location.belowbar/abovebar 來讓標籤出現在 K 線圖上，
// 或者使用 location.absolute 來讓它出現在指標視窗中。
// 這裡我們讓標籤顯示在指標線附近，所以使用 location.absolute 是合適的。
// 關鍵修正：移除無效的 style 參數值，改用 shape.labelup/labeldown 的字串名稱，並修正 offset 參數。

// 底背離標記 (Buy)
plotshape(bull_div ? vr[lbR] : na, title="Bull Div", 
     style=shape.labelup, 
     location=location.absolute, 
     color=color.new(color.red, 20), 
     textcolor=color.white, 
     text="B", 
     size=size.tiny, 
     offset=-lbR)

// 頂背離標記 (Sell)
plotshape(bear_div ? vr[lbR] : na, title="Bear Div", 
     style=shape.labeldown, 
     location=location.absolute, 
     color=color.new(color.green, 20), 
     textcolor=color.white, 
     text="S", 
     size=size.tiny, 
     offset=-lbR)


// ==========================================
// 5. 設計師面板 (Designer HUD)
// ==========================================
if show_hud and barstate.islast
    vr_cur = vr
    vr_prev = vr[1]
    diff = vr_cur - vr_prev
    diff_pct = (diff / vr_prev) * 100
    
    is_positive = diff >= 0
    hud_color = is_positive ? color.red : color.green
    symbol = is_positive ? "▲" : "▼"
    
    txt_title = "VR (" + str.tostring(length) + ")"
    txt_val = str.tostring(vr_cur, "#.00")
    sign_str = is_positive ? "+" : "" 
    txt_diff = symbol + " " + str.tostring(math.abs(diff), "#.00") + " (" + sign_str + str.tostring(diff_pct, "#.1") + "%)"

    pos_input = hud_pos_v == "Top" ? position.top_right : hud_pos_v == "Bottom" ? position.bottom_right : position.middle_right
    
    size_title = hud_size == "Small" ? size.tiny : hud_size == "Large" ? size.normal : size.small
    size_val   = hud_size == "Small" ? size.normal : hud_size == "Large" ? size.huge : size.large
    size_sub   = hud_size == "Small" ? size.tiny : hud_size == "Large" ? size.normal : size.small

    var table hud = table.new(pos_input, 1, 3, bgcolor=color.new(color.black, 100), border_width=0)
    
    table.cell(hud, 0, 0, txt_title, text_color=color.gray, text_size=size_title, text_halign=text.align_right)
    table.cell(hud, 0, 1, txt_val, text_color=hud_color, text_size=size_val, text_halign=text.align_right)
    table.cell(hud, 0, 2, txt_diff, text_color=hud_color, text_size=size_sub, text_halign=text.align_right)
