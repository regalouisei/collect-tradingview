//@version=5
indicator(title="www.Apex-Wallet.fr - Average Directional Index (ADX)", overlay=false)

// ---------- INPUTS ----------
modeOpt   = input.string(defval="Day-Trading", title="Mode de Trading", options=["Scalping", "Day-Trading", "Swing-trading"])
showTrend = input.bool(defval=true, title="Afficher la tendance")

// ---------- PARAMS PAR MODE ----------
var int   adxLen = 14
var float adxThr = 25.0
if modeOpt == "Scalping"
    adxLen := 7
    adxThr := 20.0
else if modeOpt == "Day-Trading"
    adxLen := 14
    adxThr := 25.0
else
    adxLen := 21
    adxThr := 30.0

// ---------- CALCUL DMI/ADX (Wilder) ----------
calcDMI(len) =>
    up   = high - high[1]
    down = low[1] - low
    plusDM  = (up > down and up > 0) ? up : 0.0
    minusDM = (down > up and down > 0) ? down : 0.0
    tr1 = high - low
    tr2 = math.abs(high - close[1])
    tr3 = math.abs(low - close[1])
    tr  = math.max(tr1, math.max(tr2, tr3))
    trRma    = ta.rma(tr, len)
    plusRma  = ta.rma(plusDM, len)
    minusRma = ta.rma(minusDM, len)
    pdi = trRma != 0 ? 100.0 * plusRma / trRma : 0.0
    mdi = trRma != 0 ? 100.0 * minusRma / trRma : 0.0
    dx  = (pdi + mdi != 0) ? 100.0 * math.abs(pdi - mdi) / (pdi + mdi) : 0.0
    adx = ta.rma(dx, len)
    [adx, pdi, mdi]

[adx, pdi, mdi] = calcDMI(adxLen)

// ---------- LOGIQUE TENDANCE ----------
strong  = adx >= adxThr
bull    = strong and pdi > mdi
bear    = strong and mdi > pdi
rang    = not bull and not bear

// ---------- COULEURS ----------
greenRGB = color.rgb(0, 255, 0)
redRGB   = color.rgb(255, 0, 0)

// ---------- TRACES ----------
plot(adx, title="ADX", linewidth=showTrend ? 2 : 1, color=showTrend ? (bull ? greenRGB : bear ? redRGB : color.white) : color.white)
plot(pdi, title="+DI", color=color.new(color.green, showTrend ? 50 : 0))
plot(mdi, title="-DI", color=color.new(color.red,   showTrend ? 50 : 0))

// ---------- NIVEAUX ORANGE + ETIQUETTES ----------
orange25 = color.new(color.orange, 75)  // 25% d'opacitÃ©
orange50 = color.new(color.orange, 50)  // 50% d'opacitÃ©
orange75 = color.new(color.orange, 25)  // 75% d'opacitÃ©
hline(20, "Phase de Consolidation", color=orange25)
hline(25, "Tendance",               color=orange50)
hline(50, "ExtrÃªmement forte",      color=orange75)

// Util: label (bg + texte paramÃ©trables)
f_setLabel(_lbl, _y, _text, _bg, _txtcol) =>
    l = na(_lbl) ? label.new(x=bar_index, y=_y, text=_text, xloc=xloc.bar_index, style=label.style_label_left, textcolor=_txtcol, color=_bg) : _lbl
    label.set_x(l, bar_index)
    label.set_y(l, _y)
    label.set_text(l, _text)
    label.set_color(l, _bg)
    label.set_textcolor(l, _txtcol)
    l

// Ã‰tiquettes fixes des niveaux
var label lbl20 = na
var label lbl25 = na
var label lbl50 = na
lbl20 := f_setLabel(lbl20, 20, "ğ—£ğ—µğ—®ğ˜€ğ—² ğ—±ğ—² ğ—–ğ—¼ğ—»ğ˜€ğ—¼ğ—¹ğ—¶ğ—±ğ—®ğ˜ğ—¶ğ—¼ğ—»", orange25, color.white)
lbl25 := f_setLabel(lbl25, 25, "ğ—§ğ—²ğ—»ğ—±ğ—®ğ—»ğ—°ğ—²",               orange50, color.white)
lbl50 := f_setLabel(lbl50, 50, "ğ—˜ğ˜…ğ˜ğ—¿ğ—²ğ—ºğ—²ğ—ºğ—²ğ—»ğ˜ ğ—³ğ—¼ğ—¿ğ˜ğ—²",      orange75, color.white)

// ---------- Ã‰TIQUETTES DE TENDANCE ----------
var label trendLbl    = na
var label rangeLblTop = na
var label rangeLblBot = na
if showTrend
    // Textes
    bullTxtBold  = "Haussier (^)"
    bearTxtBold  = "Baissier (v)"
    rangeTxtBold = "Phase de consolidation ou Range (<->)"

    // Couleurs texte
    txtGreen  = color.rgb(0, 255, 0)
    txtRed    = color.rgb(255, 0, 0)
    txtOrange = color.orange

    lblTxt = bull ? bullTxtBold : bear ? bearTxtBold : rangeTxtBold
    bgCol  = color.new(color.white, 25)                 // 75% d'opacitÃ© (transparence 25)
    txtCol = bull ? txtGreen : bear ? txtRed : txtOrange

    trendLbl := f_setLabel(trendLbl, adx, lblTxt, bgCol, txtCol)

    if rang
        // DÃ©calage sur l'Ã©chelle ADX pour simuler un "gras"
        adxDy = 1.0
        rangeLblTop := f_setLabel(rangeLblTop, adx + adxDy, lblTxt, bgCol, txtCol)
        rangeLblBot := f_setLabel(rangeLblBot, adx - adxDy, lblTxt, bgCol, txtCol)
    else
        if not na(rangeLblTop)
            label.delete(rangeLblTop), rangeLblTop := na
        if not na(rangeLblBot)
            label.delete(rangeLblBot), rangeLblBot := na
else
    if not na(trendLbl)
        label.delete(trendLbl), trendLbl := na
    if not na(rangeLblTop)
        label.delete(rangeLblTop), rangeLblTop := na
    if not na(rangeLblBot)
        label.delete(rangeLblBot), rangeLblBot := na

// ---------- AUCUN PANNEAU LATERAL ----------
var table panel = na
if not na(panel)
    table.clear(panel, 0, 0, 0, 0)  // sÃ©curitÃ©
