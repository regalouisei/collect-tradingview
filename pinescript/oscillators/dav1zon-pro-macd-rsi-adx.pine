//@version=5
indicator("Dav1zoN PRO: MACD + RSI + ADX", overlay=false)

//━━━━━━━━━━━━━━━━━━━
// TIMEFRAME RANGE
// < 4H  => ±150
// ≥ 4H  => ±400
//━━━━━━━━━━━━━━━━━━━
tfSeconds  = timeframe.in_seconds()
is4HOrMore = tfSeconds >= 14400

rangeSmall = input.float(150.0, "Range (<4H) ±", step=10)
rangeBig   = input.float(400.0, "Range (≥4H) ±", step=10)
targetR    = is4HOrMore ? rangeBig : rangeSmall

//━━━━━━━━━━━━━━━━━━━
// HELPERS: auto-scale + soft limit (no flat lines)
//━━━━━━━━━━━━━━━━━━━
scaleLen   = input.int(200, "Auto-Scale Lookback", minval=20)
softness   = input.float(1.20, "Soft Limit Strength", step=0.05) // higher = less limiting
minDenom   = input.float(1e-6, "Min Denominator", step=1e-6)

// soft limiter using atan (smooth, never hard-flats)
softLimit(x, rng, soft) =>
    // atan output in (-pi/2, +pi/2), normalize to (-1, +1)
    rng * (2.0 / math.pi) * math.atan(x / (rng * soft))

// auto-scale a series to fit target range using recent max abs
autoScale(x, rng, len) =>
    m = ta.highest(math.abs(x), len)
    d = math.max(m, minDenom)
    x * (rng / d)

//━━━━━━━━━━━━━━━━━━━
// MACD HISTOGRAM (4 COLORS) + NORMALIZED + AUTO-SCALED
//━━━━━━━━━━━━━━━━━━━
macdFast   = input.int(12, "MACD Fast", minval=1)
macdSlow   = input.int(26, "MACD Slow", minval=1)
macdSignal = input.int(9,  "MACD Signal", minval=1)

macdNormLen = input.int(100, "MACD Normalize Length", minval=20)

// raw macd hist (for color logic)
[_, _, histRaw] = ta.macd(close, macdFast, macdSlow, macdSignal)

// normalize by volatility of hist (keeps it proportional across TF)
histVol = ta.stdev(histRaw, macdNormLen)
histN   = histVol > 0 ? (histRaw / histVol) : 0.0

// auto-scale MACD into ~70% of target range so RSI/ADX still visible
macdRng = targetR * 0.70

histScaled = autoScale(histN, macdRng, scaleLen)
histFinal  = softLimit(histScaled, macdRng, softness)

// MACD 4-color logic (100% Pine-safe)
macdColor = histRaw >= 0 ? (histRaw > histRaw[1] ? color.lime : color.green) : (histRaw < histRaw[1] ? color.red : color.maroon)

// Plot MACD histogram (single-line call to avoid parser issues)
plot(histFinal, title="MACD Histogram (Pro Scaled)", style=plot.style_columns, color=macdColor)

//━━━━━━━━━━━━━━━━━━━
// RSI (SMOOTH, CENTERED, AUTO-SCALED, COLOR ZONES)
// No hard cap => no flat lines
//━━━━━━━━━━━━━━━━━━━
rsiLen   = input.int(14, "RSI Length", minval=1)
rsiOB    = input.float(70.0, "RSI Overbought", step=0.5)
rsiOS    = input.float(30.0, "RSI Oversold", step=0.5)

rsiSmoothSmall = input.int(14, "RSI Smooth (<4H)", minval=1)
rsiSmoothBig   = input.int(9,  "RSI Smooth (≥4H)", minval=1)
rsiSmooth      = is4HOrMore ? rsiSmoothBig : rsiSmoothSmall

rsiPower = input.float(16.0, "RSI Base Power", step=0.5)

rsiRaw = ta.rsi(close, rsiLen)
rsiSm  = ta.ema(rsiRaw, rsiSmooth)

// centered oscillator
rsiOscRaw = (rsiSm - 50.0) * rsiPower

// auto-scale RSI to full target range, then soft-limit (smooth edges)
rsiScaled = autoScale(rsiOscRaw, targetR, scaleLen)
rsiFinal  = softLimit(rsiScaled, targetR, softness)

rsiColor = rsiSm >= rsiOB ? color.green : rsiSm <= rsiOS ? color.red : color.yellow
plot(rsiFinal, title="RSI (Auto-Scaled)", color=rsiColor, linewidth=2)


//━━━━━━━━━━━━━━━━━━━
// ADX (SMOOTH, CENTERED, AUTO-SCALED)
// No hard cap => no flat lines
//━━━━━━━━━━━━━━━━━━━
diLen     = input.int(14, "DI Length", minval=1)
adxSmooth = input.int(14, "ADX Smoothing (ta.dmi)", minval=1)
adxBase   = input.float(20.0, "ADX Baseline", step=0.5)

adxEmaSmall = input.int(14, "ADX Smooth (<4H)", minval=1)
adxEmaBig   = input.int(10, "ADX Smooth (≥4H)", minval=1)
adxEmaLen   = is4HOrMore ? adxEmaBig : adxEmaSmall

adxPower = input.float(20.0, "ADX Base Power", step=0.5)

[_, _, adxRaw] = ta.dmi(diLen, adxSmooth)
adxSm = ta.ema(adxRaw, adxEmaLen)

// centered adx oscillator
adxOscRaw = (adxSm - adxBase) * adxPower

// auto-scale + soft-limit
adxScaled = autoScale(adxOscRaw, targetR, scaleLen)
adxFinal  = softLimit(adxScaled, targetR, softness)

plot(adxFinal, title="ADX (Auto-Scaled)", color=color.white, linewidth=2)
