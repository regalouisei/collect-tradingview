//@version=6
indicator("MAG8 Breadth RSI (AVGO)", shorttitle="MAG8 RSI Breadth", overlay=false, max_lines_count=500)

// ── Inputs ─────────────────────────────────────────────────────────────────────
tickers_input = input.string("MSFT,AAPL,GOOGL,TSLA,AMZN,META,NVDA,AVGO", "MAG8 Tickers", tooltip="AVGO replaces NFLX")
rsi_len       = input.int(14, "RSI Length", minval=1)
ob_level      = input.int(70, "Overbought", minval=50, maxval=100)
os_level      = input.int(30, "Oversold", minval=0, maxval=50)
extreme_cnt   = input.int(6, "Extreme Threshold", minval=1, maxval=8)

// ── Split tickers ──────────────────────────────────────────────────────────────
var string[] tickers = str.split(tickers_input, ",")

// ── Pre-compute RSI values (no function wrapper) ───────────────────────────────
rsi_vals = array.new<float>()
if barstate.isconfirmed
    array.clear(rsi_vals)
    for ticker in tickers
        rsi_val = request.security(ticker, timeframe.period, ta.rsi(close, rsi_len), lookahead=barmerge.lookahead_off)
        array.push(rsi_vals, rsi_val)

// ── Count OB / OS ─────────────────────────────────────────────────────────────
countOB = 0
countOS = 0
if array.size(rsi_vals) > 0
    for i = 0 to array.size(rsi_vals) - 1
        val = array.get(rsi_vals, i)
        if not na(val)
            countOB += val > ob_level ? 1 : 0
            countOS += val < os_level ? 1 : 0

// ── Plot ───────────────────────────────────────────────────────────────────────
plot(countOB, "Overbought", color=color.red, linewidth=2)
plot(countOS, "Oversold", color=color.green, linewidth=2)
hline(extreme_cnt, "Threshold", color=color.orange, linestyle=hline.style_dashed)

// ── Background ─────────────────────────────────────────────────────────────────
bgcolor(countOB >= extreme_cnt ? color.new(color.red, 90) : countOS >= extreme_cnt ? color.new(color.green, 90) : na)

// ── Alert messages (simple string) ────────────────────────────────────────────
ob_alert_msg = "≥6 MAG8 stocks RSI > 70"
os_alert_msg = "≥6 MAG8 stocks RSI < 30"

// ── Alerts ─────────────────────────────────────────────────────────────────────
alertcondition(countOB >= extreme_cnt, title="MAG8 Overbought", message=ob_alert_msg)
alertcondition(countOS >= extreme_cnt, title="MAG8 Oversold", message=os_alert_msg)
