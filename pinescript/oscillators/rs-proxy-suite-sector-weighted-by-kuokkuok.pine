//@version=6
indicator("RS Proxy Suite (Sector-Weighted) - by kuokkuok", shorttitle="RS Proxy (Sector-Weighted)", overlay=false, max_bars_back=5000)

// ==========================================
// 1. Parameter Settings
// ==========================================
grp_source = "Data Source"
index_spx = input.symbol("SP:SPX", "Market Index SPX", group=grp_source)
price_src = input.source(close, "Calculation Price", group=grp_source)

grp_len = "RS Momentum Periods (Adjustable)"
len_short = input.int(63,  "Short Term (Default 63 days)", minval=10, group=grp_len)
len_mid   = input.int(126, "Medium Term (Default 126 days)", minval=20, group=grp_len)
len_long  = input.int(252, "Long Term (Default 252 days)", minval=50, group=grp_len)

grp_weight = "Momentum Weights"
w_short = input.float(0.4, "Short Term Weight", step=0.05, group=grp_weight)
w_mid   = input.float(0.2, "Medium Term Weight", step=0.05, group=grp_weight)
w_long  = input.float(0.4, "Long Term Weight", step=0.05, group=grp_weight)

grp_sector_weights = "Sector Weights"
wt_xlk  = input.float(1.5, "XLK Weight (Technology)", step=0.1, group=grp_sector_weights)
wt_soxx = input.float(1.3, "SOXX Weight (Semiconductors)", step=0.1, group=grp_sector_weights)
wt_xly  = input.float(1.2, "XLY Weight (Consumer Discretionary)", step=0.1, group=grp_sector_weights)
wt_xlc  = input.float(1.1, "XLC Weight (Communication Services)", step=0.1, group=grp_sector_weights)
wt_xlg  = input.float(1.3, "XLG Weight (Large Cap Growth)", step=0.1, group=grp_sector_weights)
wt_xli  = input.float(1.0, "XLI Weight (Industrials)", step=0.1, group=grp_sector_weights)
wt_xlf  = input.float(1.0, "XLF Weight (Financials)", step=0.1, group=grp_sector_weights)
wt_xlb  = input.float(0.9, "XLB Weight (Materials)", step=0.1, group=grp_sector_weights)
wt_xle  = input.float(0.9, "XLE Weight (Energy)", step=0.1, group=grp_sector_weights)
wt_xlv  = input.float(0.8, "XLV Weight (Health Care)", step=0.1, group=grp_sector_weights)
wt_xlp  = input.float(0.8, "XLP Weight (Consumer Staples)", step=0.1, group=grp_sector_weights)
wt_xlu  = input.float(0.7, "XLU Weight (Utilities)", step=0.1, group=grp_sector_weights)
wt_xlre = input.float(0.7, "XLRE Weight (Real Estate)", step=0.1, group=grp_sector_weights)
wt_ppa  = input.float(0.9, "PPA Weight (Aerospace & Defense)", step=0.1, group=grp_sector_weights)

grp_visual = "Visualization Settings"
show_rs_line = input.bool(false, "Show RS Line", group=grp_visual)
show_blue_dot = input.bool(true, "Show RS Leading Divergence (Blue Dot)", group=grp_visual)
show_dashboard = input.bool(true, "Show Dashboard", group=grp_visual)
dashboard_loc = input.string("Bottom Right", "Dashboard Position", options=["Top Right", "Bottom Right", "Top Left", "Bottom Left"], group=grp_visual)

// ==========================================
// 2. Utility Functions
// ==========================================
f_perf(src, len) =>
    na(src[len]) ? na : (src - src[len]) / src[len] * 100

f_score(src) =>
    na(src[len_long]) ? na : f_perf(src, len_short) * w_short + f_perf(src, len_mid) * w_mid + f_perf(src, len_long) * w_long

f_percentile_weighted(val, arr, wts) =>
    total = 0.0
    count = 0.0
    for i = 0 to array.size(arr) - 1
        wt = array.get(wts, i)
        total += wt
        if val > array.get(arr, i)
            count += wt
    count / total

// ==========================================
// 3. Individual Stock RS Momentum Score
// ==========================================
score_stock = f_score(price_src)

// ==========================================
// 4. Market Proxy Universe (Multi-Index)
// ==========================================
spx_close = request.security(index_spx, timeframe.period, close)

score_spx = f_score(spx_close)

// --- ETF prices ---
xlk  = request.security("AMEX:XLK",  timeframe.period, close)
soxx = request.security("NASDAQ:SOXX", timeframe.period, close)
xly  = request.security("AMEX:XLY",  timeframe.period, close)
xlc  = request.security("AMEX:XLC",  timeframe.period, close)
xlg  = request.security("AMEX:XLG",  timeframe.period, close)

xli  = request.security("AMEX:XLI",  timeframe.period, close)
xlf  = request.security("AMEX:XLF",  timeframe.period, close)
xlb  = request.security("AMEX:XLB",  timeframe.period, close)
xle  = request.security("AMEX:XLE",  timeframe.period, close)

xlv  = request.security("AMEX:XLV",  timeframe.period, close)
xlp  = request.security("AMEX:XLP",  timeframe.period, close)
xlu  = request.security("AMEX:XLU",  timeframe.period, close)
xlre = request.security("AMEX:XLRE", timeframe.period, close)

ppa  = request.security("AMEX:PPA",  timeframe.period, close)

// --- scores ---
var float[] scores = array.new_float()
var float[] weights = array.new_float()

array.clear(scores), array.clear(weights)

// Growth / Core
array.push(scores, f_score(xlk)),  array.push(weights, wt_xlk)
array.push(scores, f_score(soxx)), array.push(weights, wt_soxx)
array.push(scores, f_score(xly)),  array.push(weights, wt_xly)
array.push(scores, f_score(xlc)),  array.push(weights, wt_xlc)
array.push(scores, f_score(xlg)),  array.push(weights, wt_xlg)

// Cyclical
array.push(scores, f_score(xli)),  array.push(weights, wt_xli)
array.push(scores, f_score(xlf)),  array.push(weights, wt_xlf)
array.push(scores, f_score(xlb)),  array.push(weights, wt_xlb)
array.push(scores, f_score(xle)),  array.push(weights, wt_xle)

// Defensive
array.push(scores, f_score(xlv)),  array.push(weights, wt_xlv)
array.push(scores, f_score(xlp)),  array.push(weights, wt_xlp)
array.push(scores, f_score(xlu)),  array.push(weights, wt_xlu)
array.push(scores, f_score(xlre)), array.push(weights, wt_xlre)

// Policy
array.push(scores, f_score(ppa)),  array.push(weights, wt_ppa)

// ==========================================
// 5. RS Proxy Rating (1â€“99)
// ==========================================
rs_proxy = f_percentile_weighted(score_stock, scores, weights)
rs_rating = math.round(rs_proxy * 98 + 1)

// ==========================================
// 6. RS Line (Retain Original Structure)
// ==========================================
rs_line = price_src / spx_close
rs_ma_20 = ta.sma(rs_line, 20)
rs_ma_50 = ta.sma(rs_line, 50)

// ==========================================
// 7. Blue Dot (RS Leading Divergence)
// ==========================================
price_new_high = price_src >= ta.highest(price_src, 20)[1]
rs_new_high = rs_line >= ta.highest(rs_line, 20)[1]
blue_dot = rs_new_high and not price_new_high and rs_line > rs_ma_50 and volume > ta.sma(volume, 50)

// ==========================================
// 8. Visualization
// ==========================================
//rs_line_norm = rs_line / ta.sma(rs_line, 50)
//plot(show_rs_line ? rs_line_norm : na, title="RS Line", color=color.black, linewidth=2)
plot(show_rs_line ? rs_line * 5000 : na, title="RS Line", color=color.black, linewidth=2)
plot(show_rs_line ? rs_ma_50 * 5000 : na, title="RS MA 50", color=color.new(color.gray, 0))

plotshape(show_blue_dot and blue_dot, title="Blue Dot", style=shape.circle,
     location=location.top, size=size.tiny, color=color.new(#00e5ff, 0))

// ==========================================
// 9. Dashboard
// ==========================================
var table dash = table.new(dashboard_loc == "Bottom Left" ? position.bottom_left : dashboard_loc == "Top Right" ? position.top_right : dashboard_loc == "Bottom Right" ? position.bottom_right : position.top_left, 2, 4, border_width=1)


if show_dashboard and barstate.islast
    col_rating = rs_rating >= 80 ? color.new(color.green, 20) :
                 rs_rating >= 50 ? color.new(color.yellow, 0) :
                                   color.new(color.red, 20)

    table.cell(dash, 0, 0, "RS Proxy", bgcolor=color.gray, text_color=color.white, text_size = size.small)
    table.cell(dash, 1, 0, "Status",   bgcolor=color.gray, text_color=color.white, text_size = size.small)

    table.cell(dash, 0, 1, "RS Rating", bgcolor=color.gray, text_color=color.white, text_size = size.small)
    table.cell(dash, 1, 1, str.tostring(rs_rating), bgcolor=col_rating, text_color=color.white, text_size = size.small)

    table.cell(dash, 0, 2, "RS Trend", bgcolor=color.gray, text_color=color.white, text_size = size.small)
    table.cell(dash, 1, 2, rs_line > rs_ma_50 ? "Strong" : "Weak",
               bgcolor=rs_line > rs_ma_50 ? color.new(color.green,20) : color.new(color.red,20), text_color=color.white, text_size = size.small)

    table.cell(dash, 0, 3, "Blue Dot", bgcolor=color.gray, text_color=color.white, text_size = size.small)
    table.cell(dash, 1, 3, blue_dot ? "Present" : "None",
               bgcolor=blue_dot ? color.green : color.new(color.red,20), text_color=color.white, text_size = size.small)
