//@version=6
indicator(title = 'Williams AD + Selectable MA (v5)', shorttitle = 'Williams AD+MA', overlay = false)

// â”€â”€ Inputs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
len = input.int(14, minval = 1, title = 'MA Length')
maType = input.string('SMA', options = ['SMA', 'EMA', 'HMA'], title = 'MA Type')

upColor = input.color(color.new(color.red, 0), 'Fill Color (WAD > MA)')
downColor = input.color(color.new(color.blue, 0), 'Fill Color (WAD < MA)')
fillTransp = input.int(70, minval = 0, maxval = 100, title = 'Fill Transparency (0=ë¶ˆíˆ¬ëª…)')
showLine = input.bool(true, title = 'Show WAD Line')
wadLineWidth = input.int(1, minval = 1, maxval = 5, title = 'WAD Line Width')
showMA = input.bool(true, title = 'Show MA Line')
maLineColor = input.color(color.new(color.orange, 0), 'MA Line Color')
maLineWidth = input.int(2, minval = 1, maxval = 5, title = 'MA Line Width')

// ğŸ”” ê³¨ë“ ì¢… ì˜µì…˜
showGoldenBell = input.bool(true, title = 'Show Golden Bell on Golden Cross + Rising Volume')
volRiseLen = input.int(5, minval = 2, title = 'Rising Volume Lookback (bars)')
bellColor = input.color(color.rgb(255, 215, 0), title = 'Golden Bell Color') // #FFD700
bellSizeStr = input.string('Small', options = ['Tiny', 'Small', 'Normal', 'Large'], title = 'Bell Size')

// â”€â”€ Williams Accumulation/Distribution â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
hline(0, 'Zero', color = color.new(color.blue, 30))

var float wad = na
wad := close > nz(close[1], 0.0) ? nz(wad[1], 0.0) + close - low[1] : close < nz(close[1], 0.0) ? nz(wad[1], 0.0) + close - high[1] : 0.0

// â”€â”€ HMA helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
hma(src, length) =>
    _l = math.max(1, length)
    _l2 = math.max(1, int(math.round(_l / 2.0)))
    _lr = math.max(1, int(math.round(math.sqrt(_l))))
    ta.wma(2.0 * ta.wma(src, _l2) - ta.wma(src, _l), _lr)

// â”€â”€ Selectable MA on WAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
wadMA = maType == 'SMA' ? ta.sma(wad, len) : maType == 'EMA' ? ta.ema(wad, len) : hma(wad, len)

// â”€â”€ Oscillator fill color (MA ê¸°ì¤€) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
isUp = wad >= wadMA
lineCol = isUp ? upColor : downColor
fillCol = color.new(lineCol, fillTransp)

// â”€â”€ Plots (ë©´ ì±„ì›€ + ë¼ì¸) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
pW = plot(wad, title = 'WAD (for fill)', display = display.none)
pMAfill = plot(wadMA, title = 'MA  (for fill)', display = display.none)
fill(pW, pMAfill, color = fillCol, title = 'WAD Area (MA-based)')

plot(showLine ? wad : na, title = 'Williams AD', color = lineCol, linewidth = math.max(1, wadLineWidth))
plot(showMA ? wadMA : na, title = 'MA of Williams AD', color = maLineColor, linewidth = math.max(1, maLineWidth))

// â”€â”€ ğŸ”” Golden Cross + Rising Volume (ì—°ì† ìƒìŠ¹) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
goldenCross = ta.crossover(wad, wadMA)
risingVol = ta.rising(volume, volRiseLen)
goldenBell = showGoldenBell and goldenCross and risingVol

// size íŒŒë¼ë¯¸í„°ëŠ” const ì—¬ì•¼ í•˜ë¯€ë¡œ ì‚¬ì´ì¦ˆë³„ë¡œ ë¶„ê¸°í•´ ê·¸ë¦¬ê¸°
plotshape(goldenBell and bellSizeStr == 'Tiny', title = 'Golden Bell (Tiny)', style = shape.labelup, text = 'ğŸ””', color = bellColor, textcolor = color.black, size = size.tiny, location = location.bottom)
plotshape(goldenBell and bellSizeStr == 'Small', title = 'Golden Bell (Small)', style = shape.labelup, text = 'ğŸ””', color = bellColor, textcolor = color.black, size = size.small, location = location.bottom)
plotshape(goldenBell and bellSizeStr == 'Normal', title = 'Golden Bell (Normal)', style = shape.labelup, text = 'ğŸ””', color = bellColor, textcolor = color.black, size = size.normal, location = location.bottom)
plotshape(goldenBell and bellSizeStr == 'Large', title = 'Golden Bell (Large)', style = shape.labelup, text = 'ğŸ””', color = bellColor, textcolor = color.black, size = size.large, location = location.bottom)

alertcondition(goldenBell, title = 'Golden Cross + Rising Volume', message = 'Golden Cross with rising volume for last N bars')
