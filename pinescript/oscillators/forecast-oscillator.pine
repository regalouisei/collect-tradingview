//@version=5
indicator("Forecast Oscillator", shorttitle="FOSC+", overlay=false)

// PARAMÈTRES (optimisé NAS100)
length       = input.int(14, "Length LinReg")
smooth_len   = input.int(4, "Lissage EMA FOSC (réduit bruit 1min)")
src          = input.source(close, "Source")

use_vol      = input.bool(true, "Filtre Volume Spike (top pour NAS100)")
vol_mult     = input.float(1.15, "Volume Multiplier")

show_signals = input.bool(true, "Signaux Buy/Sell")

// CALCUL FOSC AMÉLIORÉ
lin_reg = ta.linreg(src, length, 0)
fosc_raw = 100 * (src - lin_reg) / src
fosc = smooth_len > 0 ? ta.ema(fosc_raw, smooth_len) : fosc_raw

// NIVEAUX DYNAMIQUES (mieux que fixed pour vol NAS100)
std_dev = ta.stdev(fosc_raw, length)
overbought = std_dev * 1.5
oversold   = -std_dev * 1.5

// VOLUME FILTER
vol_sma = ta.sma(volume, 20)
vol_ok = use_vol ? (volume > vol_sma * vol_mult) : true

// SIGNAUX (crossover zero + extrêmes dynamiques + volume)
buy_signal  = (ta.crossover(fosc, oversold) or (ta.crossover(fosc, 0) and fosc < 0)) and vol_ok
sell_signal = (ta.crossunder(fosc, overbought) or (ta.crossunder(fosc, 0) and fosc > 0)) and vol_ok

// AFFICHAGE
fosc_color = fosc >= 0 ? color.new(#00ffbb, 0) : color.new(#ff0055, 0)
plot(fosc, "FOSC", color=fosc_color, linewidth=2)
hline(0, "Zero", color=color.gray, linestyle=hline.style_dotted)
plot(overbought, "Overbought Dyn", color=color.red, style=plot.style_circles, linewidth=1)
plot(oversold, "Oversold Dyn", color=color.green, style=plot.style_circles, linewidth=1)

// Histogram momentum
plot(fosc - fosc[1], "Momentum Hist", color=fosc_color, style=plot.style_columns, transp=60)

// Signaux
plotshape(show_signals and buy_signal, title="FOSC Buy", location=location.bottom, color=#00ffbb, style=shape.triangleup, size=size.small)
plotshape(show_signals and sell_signal, title="FOSC Sell", location=location.top, color=#ff0055, style=shape.triangledown, size=size.small)

// Alerts
alertcondition(buy_signal, "FOSC Buy", "FOSC Oversold Buy on {{ticker}}")
alertcondition(sell_signal, "FOSC Sell", "FOSC Overbought Sell on {{ticker}}")
