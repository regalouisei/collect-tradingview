//@version=6
indicator("WVF Bottom + RSI EMA", overlay=false)

//──────────────────────────────────────────────────────────────────────────────
// PRESETS (Daily)
//──────────────────────────────────────────────────────────────────────────────
grpP   = "Presets (Daily)"
preset = input.string(defval="CUSTOM", title="Preset", options=[
     "CUSTOM",
     "BTC D - CAPITULATION (55/2.5/252/0.90 | RSI 20/10)",
     "BTC D - REACTIVE (34/2.0/200/0.85 | RSI 14/10)",
     "BTC D - TREND BIASED (55/2.5/252/0.95 | RSI 20/14)",
     "EQUITY D - LARGE/MEGA (34/2.0/100/0.85 | RSI 14/10)",
     "EQUITY D - GROWTH/VOL (55/2.5/126/0.90 | RSI 20/10)",
     "EQUITY D - SMALL/MID (22/2.0/50/0.85 | RSI 14/7)"
], group=grpP)

winBars = input.int(defval=10, title="Green valid only if crossover happens within N bars from last red", minval=0, maxval=200, group=grpP)

//──────────────────────────────────────────────────────────────────────────────
// CUSTOM INPUTS
//──────────────────────────────────────────────────────────────────────────────
grpW = "WVF (Bottom) - Custom"
pd   = input.int(defval=22,  title="WVF Lookback highest close", minval=1, group=grpW)
bbl  = input.int(defval=20,  title="WVF BB length", minval=1, group=grpW)
mult = input.float(defval=2.0, title="WVF BB stdev mult", minval=0.1, maxval=10, step=0.1, group=grpW)
lb   = input.int(defval=50,  title="WVF range lookback", minval=1, group=grpW)
ph   = input.float(defval=0.85, title="WVF rangeHigh factor", minval=0.0, maxval=2.0, step=0.01, group=grpW)

grpR = "RSI/EMA (Rise) - Custom"
src  = input.source(defval=close, title="Source", group=grpR)
len  = input.int(defval=20, title="RSI Length", minval=1, group=grpR)
len2 = input.int(defval=10, title="EMA of RSI Length", minval=1, group=grpR)
riseMode = input.string(defval="State (RSI>EMA)", title="Green mode", options=["Crossover only", "State (RSI>EMA)"], group=grpR)

//──────────────────────────────────────────────────────────────────────────────
// VISUAL SETTINGS
//──────────────────────────────────────────────────────────────────────────────
grpV = "Visual"
showRibbon    = input.bool(defval=true,  title="Show state ribbon (fill)", group=grpV)
showStateLine = input.bool(defval=false, title="Show state step-line (optional)", group=grpV)
showMarkers   = input.bool(defval=true,  title="Show markers", group=grpV)

stateLevel = input.float(defval=1.0, title="State level (height)", minval=0.1, step=0.1, group=grpV)
baseLevel  = input.float(defval=0.0, title="Base level", group=grpV)

ribbonTransp = input.int(defval=85, title="Green/Amber ribbon transparency (0 solid → 100 invisible)", minval=0, maxval=100, group=grpV)

// Red shadow (bottom)
showBottomShadow = input.bool(defval=true, title="Show red bottom shadow (fill)", group=grpV)
bottomShadowH    = input.float(defval=0.8, title="Red shadow height (below base)", minval=0.1, step=0.1, group=grpV)
bottomTransp     = input.int(defval=88, title="Red shadow transparency (0 solid → 100 invisible)", minval=0, maxval=100, group=grpV)

//──────────────────────────────────────────────────────────────────────────────
// APPLY PRESET (effective params)
//──────────────────────────────────────────────────────────────────────────────
pdEff =
     preset == "BTC D - CAPITULATION (55/2.5/252/0.90 | RSI 20/10)" ? 55 :
     preset == "BTC D - REACTIVE (34/2.0/200/0.85 | RSI 14/10)"     ? 34 :
     preset == "BTC D - TREND BIASED (55/2.5/252/0.95 | RSI 20/14)" ? 55 :
     preset == "EQUITY D - LARGE/MEGA (34/2.0/100/0.85 | RSI 14/10)"? 34 :
     preset == "EQUITY D - GROWTH/VOL (55/2.5/126/0.90 | RSI 20/10)"? 55 :
     preset == "EQUITY D - SMALL/MID (22/2.0/50/0.85 | RSI 14/7)"   ? 22 : pd

bblEff = bbl

multEff =
     preset == "BTC D - CAPITULATION (55/2.5/252/0.90 | RSI 20/10)" ? 2.5 :
     preset == "BTC D - REACTIVE (34/2.0/200/0.85 | RSI 14/10)"     ? 2.0 :
     preset == "BTC D - TREND BIASED (55/2.5/252/0.95 | RSI 20/14)" ? 2.5 :
     preset == "EQUITY D - LARGE/MEGA (34/2.0/100/0.85 | RSI 14/10)"? 2.0 :
     preset == "EQUITY D - GROWTH/VOL (55/2.5/126/0.90 | RSI 20/10)"? 2.5 :
     preset == "EQUITY D - SMALL/MID (22/2.0/50/0.85 | RSI 14/7)"   ? 2.0 : mult

lbEff =
     preset == "BTC D - CAPITULATION (55/2.5/252/0.90 | RSI 20/10)" ? 252 :
     preset == "BTC D - REACTIVE (34/2.0/200/0.85 | RSI 14/10)"     ? 200 :
     preset == "BTC D - TREND BIASED (55/2.5/252/0.95 | RSI 20/14)" ? 252 :
     preset == "EQUITY D - LARGE/MEGA (34/2.0/100/0.85 | RSI 14/10)"? 100 :
     preset == "EQUITY D - GROWTH/VOL (55/2.5/126/0.90 | RSI 20/10)"? 126 :
     preset == "EQUITY D - SMALL/MID (22/2.0/50/0.85 | RSI 14/7)"   ? 50 : lb

phEff =
     preset == "BTC D - CAPITULATION (55/2.5/252/0.90 | RSI 20/10)" ? 0.90 :
     preset == "BTC D - REACTIVE (34/2.0/200/0.85 | RSI 14/10)"     ? 0.85 :
     preset == "BTC D - TREND BIASED (55/2.5/252/0.95 | RSI 20/14)" ? 0.95 :
     preset == "EQUITY D - LARGE/MEGA (34/2.0/100/0.85 | RSI 14/10)"? 0.85 :
     preset == "EQUITY D - GROWTH/VOL (55/2.5/126/0.90 | RSI 20/10)"? 0.90 :
     preset == "EQUITY D - SMALL/MID (22/2.0/50/0.85 | RSI 14/7)"   ? 0.85 : ph

rsiLenEff =
     preset == "BTC D - CAPITULATION (55/2.5/252/0.90 | RSI 20/10)" ? 20 :
     preset == "BTC D - REACTIVE (34/2.0/200/0.85 | RSI 14/10)"     ? 14 :
     preset == "BTC D - TREND BIASED (55/2.5/252/0.95 | RSI 20/14)" ? 20 :
     preset == "EQUITY D - LARGE/MEGA (34/2.0/100/0.85 | RSI 14/10)"? 14 :
     preset == "EQUITY D - GROWTH/VOL (55/2.5/126/0.90 | RSI 20/10)"? 20 :
     preset == "EQUITY D - SMALL/MID (22/2.0/50/0.85 | RSI 14/7)"   ? 14 : len

emaRsiLenEff =
     preset == "BTC D - CAPITULATION (55/2.5/252/0.90 | RSI 20/10)" ? 10 :
     preset == "BTC D - REACTIVE (34/2.0/200/0.85 | RSI 14/10)"     ? 10 :
     preset == "BTC D - TREND BIASED (55/2.5/252/0.95 | RSI 20/14)" ? 14 :
     preset == "EQUITY D - LARGE/MEGA (34/2.0/100/0.85 | RSI 14/10)"? 10 :
     preset == "EQUITY D - GROWTH/VOL (55/2.5/126/0.90 | RSI 20/10)"? 10 :
     preset == "EQUITY D - SMALL/MID (22/2.0/50/0.85 | RSI 14/7)"   ? 7  : len2

//──────────────────────────────────────────────────────────────────────────────
// WVF calc (bottom)
//──────────────────────────────────────────────────────────────────────────────
hhClose   = ta.highest(close, pdEff)
wvf       = hhClose != 0.0 ? ((hhClose - low) / hhClose) * 100.0 : na
midLine   = ta.sma(wvf, bblEff)
sDev      = multEff * ta.stdev(wvf, bblEff)
upperBand = midLine + sDev
rangeHigh = ta.highest(wvf, lbEff) * phEff
bottomSignal = (wvf >= upperBand) or (wvf >= rangeHigh)

// Track last red bar
var int lastBottomBar = na
if bottomSignal
    lastBottomBar := bar_index

//──────────────────────────────────────────────────────────────────────────────
// RSI + EMA(RSI) calc (rise validated within window)
//──────────────────────────────────────────────────────────────────────────────
up   = ta.rma(math.max(ta.change(src), 0), rsiLenEff)
down = ta.rma(-math.min(ta.change(src), 0), rsiLenEff)
rsi  = down == 0 ? 100 : up == 0 ? 0 : 100 - (100 / (1 + up / down))
emaRSI = ta.ema(rsi, emaRsiLenEff)

riseCross   = ta.crossover(rsi, emaRSI)
riseCrossDn = ta.crossunder(rsi, emaRSI)

inWindow       = (winBars == 0) ? (bottomSignal and riseCross) : (not na(lastBottomBar) and (bar_index - lastBottomBar <= winBars))
validRiseCross = riseCross and inWindow

var bool inRise = false
if validRiseCross
    inRise := true
if riseCrossDn
    inRise := false
if inRise and not (rsi > emaRSI)
    inRise := false

riseForVis = (riseMode == "Crossover only") ? validRiseCross : inRise

//──────────────────────────────────────────────────────────────────────────────
// VISUAL: green/amber ribbon + red shadow + markers (red only on last bar)
//──────────────────────────────────────────────────────────────────────────────
stateActive = riseForVis
stateLine   = stateActive ? stateLevel : na

pBase = plot(baseLevel, title="Base", display=display.none)

// Green/Amber ribbon above base
pState = plot(showRibbon ? stateLine : na, title="State (fill)", style=plot.style_stepline, linewidth=1, color=color.new(color.lime, 0), display=display.none)
ribbonColor = (bottomSignal and stateActive) ? color.new(color.orange, ribbonTransp) : color.new(color.lime, ribbonTransp)
fill(pBase, pState, color=ribbonColor)

// Red shadow below base
bottomLine = bottomSignal ? (baseLevel - bottomShadowH) : na
pBottom = plot(showBottomShadow ? bottomLine : na, title="Bottom shadow (fill)", style=plot.style_stepline, linewidth=1, color=color.new(color.red, 0), display=display.none)
fill(pBase, pBottom, color=color.new(color.red, bottomTransp))

// Optional visible step-line
plot(showStateLine ? (stateActive ? stateLevel : baseLevel) : na, title="STATE line", style=plot.style_stepline, linewidth=3, color=color.lime)

// ── MARKERS ──
// Only last bar of a red cluster: (current not red) AND (previous red) => place marker on previous bar via offset=-1
bottomEnded = (not bottomSignal) and bottomSignal[1]
plotshape(showMarkers and bottomEnded, title="Bottom marker (last bar only)", style=shape.triangledown, location=location.top, size=size.tiny, color=color.red, offset=-1)

// Green marker stays on the valid crossover bar
plotshape(showMarkers and validRiseCross, title="Rise start", style=shape.triangleup, location=location.bottom, size=size.tiny, color=color.lime)

// Alerts
alertcondition(bottomSignal,     title="Bottom signal (WVF)", message="WVF bottom/panic signal on {{ticker}} @ {{interval}}")
alertcondition(validRiseCross,   title="Rise START (validated crossover)", message="RSI crossed above EMA(RSI) within window after last WVF bottom on {{ticker}} @ {{interval}}")
alertcondition(riseCross,        title="Rise crossover (raw)", message="RSI crossed above EMA(RSI) on {{ticker}} @ {{interval}}")
