// © OfficialJackOfAllTrades

//@version=6
indicator("FluxPulse Momentum [JOAT]", shorttitle = "FluxPulse", overlay = false, precision = 2)

// ══════════════════════════════════════════════════════════════════════════════
// ─── DESCRIPTION ───────────────────────────────────────────────────────────────
// The Quantum Momentum Oscillator combines adaptive RSI, normalized rate of change,
// and a proprietary efficiency ratio to create a multi-dimensional momentum view.
// Features dynamic gradient coloring, divergence detection, and smart signal zones.
// ══════════════════════════════════════════════════════════════════════════════

// ─── INPUTS ────────────────────────────────────────────────────────────────────
string GRP_CALC = "Calculation Settings"
int rsiLength       = input.int(14, "RSI Length", minval = 2, maxval = 100, group = GRP_CALC)
int rocLength       = input.int(10, "Rate of Change Length", minval = 1, maxval = 50, group = GRP_CALC)
int smoothLength    = input.int(3, "Smoothing Length", minval = 1, maxval = 20, group = GRP_CALC)
float src           = input.source(close, "Source", group = GRP_CALC)

string GRP_LEVELS = "Signal Levels"
float obLevel       = input.float(75, "Overbought Level", minval = 50, maxval = 100, group = GRP_LEVELS)
float osLevel       = input.float(25, "Oversold Level", minval = 0, maxval = 50, group = GRP_LEVELS)
bool showZones      = input.bool(true, "Show Zone Highlighting", group = GRP_LEVELS)

string GRP_VIS = "Visual Settings"
color bullColor     = input.color(#00E676, "Bullish Color", group = GRP_VIS)
color bearColor     = input.color(#FF5252, "Bearish Color", group = GRP_VIS)
color neutralColor  = input.color(#9E9E9E, "Neutral Color", group = GRP_VIS)
bool showSignals    = input.bool(true, "Show Buy/Sell Signals", group = GRP_VIS)
bool showDashboard  = input.bool(true, "Show Dashboard", group = GRP_VIS)

string GRP_ALERTS = "Alerts"
bool awaitConfirm   = input.bool(true, "Await Bar Confirmation", group = GRP_ALERTS)

// ─── CALCULATIONS ──────────────────────────────────────────────────────────────
// Adaptive RSI Component
float rsiValue = ta.rsi(src, rsiLength)

// Normalized Rate of Change
float roc = ta.roc(src, rocLength)
float rocNorm = 50 + (roc / (ta.highest(math.abs(roc), rocLength * 2) + 0.0001)) * 50

// Efficiency Ratio (Kaufman-style)
float change = math.abs(src - src[rocLength])
float volatility = math.sum(math.abs(ta.change(src)), rocLength)
float efficiencyRatio = volatility != 0 ? change / volatility : 0
float erScaled = 50 + efficiencyRatio * 50

// Quantum Momentum Composite
float rawQMO = (rsiValue * 0.5 + rocNorm * 0.3 + erScaled * 0.2)
float qmo = ta.ema(rawQMO, smoothLength)
float qmoSmooth = ta.ema(qmo, smoothLength * 2)

// Momentum Direction
float qmoDelta = qmo - qmo[1]
float qmoAccel = qmoDelta - qmoDelta[1]

// ─── SIGNAL DETECTION ──────────────────────────────────────────────────────────
bool isBullish = qmo > qmoSmooth and qmoDelta > 0
bool isBearish = qmo < qmoSmooth and qmoDelta < 0
bool isOverbought = qmo > obLevel
bool isOversold = qmo < osLevel

// Buy/Sell Signals
bool buySignal = ta.crossover(qmo, qmoSmooth) and qmo < 50
bool sellSignal = ta.crossunder(qmo, qmoSmooth) and qmo > 50

// Apply confirmation filter
bool confirmed = awaitConfirm ? barstate.isconfirmed : true

// ─── COLORING ──────────────────────────────────────────────────────────────────
color qmoColor = qmo >= 50 
     ? color.from_gradient(qmo, 50, obLevel, neutralColor, bullColor) 
     : color.from_gradient(qmo, osLevel, 50, bearColor, neutralColor)

color histColor = qmoDelta > 0 
     ? (qmoAccel > 0 ? bullColor : color.new(bullColor, 50)) 
     : (qmoAccel < 0 ? bearColor : color.new(bearColor, 50))

color bgColor = showZones 
     ? (isOverbought ? color.new(bullColor, 90) : isOversold ? color.new(bearColor, 90) : na) 
     : na

// ─── PLOTTING ──────────────────────────────────────────────────────────────────
// Background Zones
bgcolor(bgColor, title = "Zone Background")

// Main QMO Line with glow effect
plot(qmo, "QMO Glow", color.new(qmoColor, 60), 6)
plot(qmo, "QMO", qmoColor, 2)
plot(qmoSmooth, "Signal Line", color.new(color.white, 30), 1, plot.style_line)

// Momentum Histogram
plot(qmoDelta * 10, "Momentum Delta", histColor, 1, plot.style_columns, histbase = 0)

// Reference Levels
hline(obLevel, "Overbought", color.new(bullColor, 50), hline.style_dashed)
hline(50, "Midline", color.new(color.white, 70), hline.style_dotted)
hline(osLevel, "Oversold", color.new(bearColor, 50), hline.style_dashed)

// Fill between levels
obPlot = hline(obLevel, display = display.none)
osPlot = hline(osLevel, display = display.none)
fill(obPlot, osPlot, color.new(color.white, 95), title = "Neutral Zone")

// Buy/Sell Signals
plotshape(showSignals and buySignal and confirmed ? qmo : na, "Buy Signal", 
     shape.triangleup, location.absolute, bullColor, size = size.small)
plotshape(showSignals and sellSignal and confirmed ? qmo : na, "Sell Signal", 
     shape.triangledown, location.absolute, bearColor, size = size.small)

// ─── DASHBOARD TABLE ───────────────────────────────────────────────────────────
if showDashboard and barstate.islast
    var table dash = table.new(position.top_right, 2, 5, 
         bgcolor = color.new(#1E1E1E, 10), 
         frame_width = 1, 
         frame_color = color.new(color.white, 80),
         border_width = 1,
         border_color = color.new(color.white, 90))
    
    // Header
    table.cell(dash, 0, 0, "FluxPulse", text_color = color.white, text_size = size.normal, bgcolor = color.new(#2962FF, 20))
    table.cell(dash, 1, 0, str.tostring(qmo, "#.##"), text_color = qmoColor, text_size = size.normal, bgcolor = color.new(#2962FF, 20))
    
    // Momentum State
    string stateText = isOverbought ? "OVERBOUGHT" : isOversold ? "OVERSOLD" : isBullish ? "BULLISH" : isBearish ? "BEARISH" : "NEUTRAL"
    color stateColor = isOverbought or isBullish ? bullColor : isOversold or isBearish ? bearColor : neutralColor
    table.cell(dash, 0, 1, "State", text_color = color.gray, text_size = size.small)
    table.cell(dash, 1, 1, stateText, text_color = stateColor, text_size = size.small)
    
    // Momentum
    table.cell(dash, 0, 2, "Momentum", text_color = color.gray, text_size = size.small)
    table.cell(dash, 1, 2, (qmoDelta > 0 ? "Up " : "Down ") + str.tostring(math.abs(qmoDelta), "#.##"), 
         text_color = qmoDelta > 0 ? bullColor : bearColor, text_size = size.small)
    
    // Efficiency
    table.cell(dash, 0, 3, "Efficiency", text_color = color.gray, text_size = size.small)
    table.cell(dash, 1, 3, str.tostring(efficiencyRatio * 100, "#.#") + "%", text_color = color.white, text_size = size.small)
    
    // Signal
    string sigText = buySignal and confirmed ? "BUY" : sellSignal and confirmed ? "SELL" : "—"
    table.cell(dash, 0, 4, "Signal", text_color = color.gray, text_size = size.small)
    table.cell(dash, 1, 4, sigText, text_color = color.white, text_size = size.small)

// ─── ALERTS ────────────────────────────────────────────────────────────────────
alertcondition(buySignal and confirmed, "QMO Buy Signal", "Quantum Momentum Oscillator: BUY signal on {{ticker}}")
alertcondition(sellSignal and confirmed, "QMO Sell Signal", "Quantum Momentum Oscillator: SELL signal on {{ticker}}")
alertcondition(ta.cross(qmo, obLevel) and confirmed, "QMO Overbought Cross", "QMO crossed overbought level on {{ticker}}")
alertcondition(ta.cross(qmo, osLevel) and confirmed, "QMO Oversold Cross", "QMO crossed oversold level on {{ticker}}")
