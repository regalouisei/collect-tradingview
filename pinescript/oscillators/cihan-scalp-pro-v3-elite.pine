//@version=5
indicator("CIHAN SCALP PRO v3 ELITE", overlay = true)

//─────────────────────
// 1) GİRDİLER
//─────────────────────
// EMA ayarları
fastLen  = input.int(8,  "EMA 8 (momentum)", minval = 1)
midLen   = input.int(21, "EMA 21 (kısa trend)", minval = 1)
slowLen  = input.int(50, "EMA 50 (orta trend)", minval = 1)
longLen  = input.int(100,"EMA 100 (filtre)",   minval = 1)

// RSI filtresi (daha sıkı)
rsiLen       = input.int(14, "RSI Periyodu", minval = 1)
rsiLongMin   = input.float(55.0, "Long için minimum RSI", step = 0.5)
rsiShortMax  = input.float(45.0, "Short için maksimum RSI", step = 0.5)

// ATR filtresi (ölü piyasa engeli)
atrLen   = input.int(14, "ATR Periyodu", minval = 1)
minAtr   = input.float(0.25, "Min ATR", step = 0.05)

// Hacim filtresi (daha sıkı)
useVolFilter  = input.bool(true, "Hacim filtresi kullan")
volLen        = input.int(20, "Hacim ortalaması", minval = 1)
volMult       = input.float(1.0, "Hacim katsayısı", step = 0.05, minval = 0.1)

// Mum yapısı (daha güçlü body)
bodyRatioMin  = input.float(0.55, "Min Body oranı (Body/Range)", step = 0.05, minval = 0.1, maxval = 0.95)

// Aynı barda tekrar sinyal verme
avoidSameBar  = input.bool(true, "Aynı barda tek sinyal")

//─────────────────────
// 2) HESAPLAMALAR
//─────────────────────
// EMA'lar
emaFast  = ta.ema(close, fastLen)
emaMid   = ta.ema(close, midLen)
emaSlow  = ta.ema(close, slowLen)
emaLong  = ta.ema(close, longLen)

// Trend (daha sıkı: 21 > 50 > 100)
bullTrend = emaMid > emaSlow and emaSlow > emaLong
bearTrend = emaMid < emaSlow and emaSlow < emaLong

// RSI
rsi = ta.rsi(close, rsiLen)

// ATR
atr = ta.atr(atrLen)
atrOK = atr > minAtr

// Hacim
volMA = ta.sma(volume, volLen)
volOK = useVolFilter ? volume > volMA * volMult : true

// Mum yapısı
body    = math.abs(close - open)
range_  = high - low
upperW  = high - math.max(open, close)
lowerW  = math.min(open, close) - low

bodyStrong = range_ > 0 and (body / range_) >= bodyRatioMin
wicksSmall = upperW <= body and lowerW <= body

// Momentum yönü (EMA8 de trendle aynı tarafta)
longMomentum  = close > open and emaFast > emaMid and bodyStrong and wicksSmall
shortMomentum = close < open and emaFast < emaMid and bodyStrong and wicksSmall

// Ek fiyat konumu filtresi (yüksek doğruluk için)
// Long: fiyat EMA21 ve EMA50'nin üzerinde
// Short: fiyat EMA21 ve EMA50'nin altında
priceLongOK  = close > emaMid and close > emaSlow
priceShortOK = close < emaMid and close < emaSlow

//─────────────────────
// 3) SİNYAL ŞARTLARI (ELITE)
//─────────────────────
// Long: trend yukarı + momentum yukarı + RSI güçlü + ATR/Hacim OK + fiyat EMA21/50 üzerinde
longRaw  = bullTrend and longMomentum  and rsi >= rsiLongMin  and atrOK and volOK and priceLongOK

// Short: trend aşağı + momentum aşağı + RSI zayıf + ATR/Hacim OK + fiyat EMA21/50 altında
shortRaw = bearTrend and shortMomentum and rsi <= rsiShortMax and atrOK and volOK and priceShortOK

// Aynı barda tekrar sinyal engeli
var int lastLongBar  = na
var int lastShortBar = na

longSignal  = longRaw  and (not avoidSameBar or na(lastLongBar)  or bar_index > lastLongBar)
shortSignal = shortRaw and (not avoidSameBar or na(lastShortBar) or bar_index > lastShortBar)

if longSignal
    lastLongBar := bar_index

if shortSignal
    lastShortBar := bar_index

// ATR tabanlı SL (bilgi amaçlı)
longSL  = longSignal  ? close - atr * 1.3 : na
shortSL = shortSignal ? close + atr * 1.3 : na

longSLline  = ta.valuewhen(longSignal,  longSL,  0)
shortSLline = ta.valuewhen(shortSignal, shortSL, 0)

//─────────────────────
// 4) GRAFİK GÖRÜNÜMÜ
//─────────────────────
// EMA'lar
plot(emaFast, "EMA 8",   color = color.teal)
plot(emaMid,  "EMA 21",  color = color.orange)
plot(emaSlow, "EMA 50",  color = color.red)
plot(emaLong, "EMA 100", color = color.new(color.gray, 40))

// Trend arka planı (hafif)
bgcolor(
     bullTrend ? color.new(color.lime, 92) :
     bearTrend ? color.new(color.red,  92) :
     na)

// Long / Short etiketleri
plotshape(longSignal,
     title     = "LONG",
     style     = shape.labelup,
     location  = location.belowbar,
     color     = color.new(color.lime, 0),
     text      = "LONG",
     textcolor = color.black,
     size      = size.tiny)

plotshape(shortSignal,
     title     = "SHORT",
     style     = shape.labeldown,
     location  = location.abovebar,
     color     = color.new(color.red, 0),
     text      = "SELL",
     textcolor = color.white,
     size      = size.tiny)

// SL çizgileri
plot(longSLline,  "LONG SL (ATR)",  color = color.new(color.lime, 70),  style = plot.style_linebr)
plot(shortSLline, "SHORT SL (ATR)", color = color.new(color.red,  70),  style = plot.style_linebr)

//─────────────────────
// 5) ALARMLAR
//─────────────────────
alertcondition(longSignal,  title = "CIHAN SCALP PRO ELITE LONG",  message = "CIHAN SCALP PRO v3 ELITE LONG | {{ticker}} | {{interval}} | Fiyat: {{close}}")
alertcondition(shortSignal, title = "CIHAN SCALP PRO ELITE SHORT", message = "CIHAN SCALP PRO v3 ELITE SHORT | {{ticker}} | {{interval}} | Fiyat: {{close}}")
