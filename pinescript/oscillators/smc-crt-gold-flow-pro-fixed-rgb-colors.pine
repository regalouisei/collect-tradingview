//@version=5
indicator("SMC + CRT Gold Flow PRO — Fixed RGB Colors", overlay=true)

// === EMA для тренда ===
emaFast = ta.ema(close, 50)
emaSlow = ta.ema(close, 200)
plot(emaFast, color=color.rgb(0,128,128), title="EMA 50")      // teal
plot(emaSlow, color=color.rgb(255,165,0), title="EMA 200")    // orange

bullish = emaFast > emaSlow
bearish = emaFast < emaSlow

// === VWAP ===
vwap = ta.vwap(hlc3)
plot(vwap, color=color.rgb(0,0,200), title="VWAP") // blue

// === Объёмный фильтр ===
volAvg = ta.sma(volume, 20)
highVol = volume > volAvg * 1.5  // 50% выше среднего объёма

// === Break of Structure (BOS) ===
bosLookback = 10
bosUp  = high > ta.highest(high[1], bosLookback)
bosDown= low  < ta.lowest(low[1], bosLookback)

plotshape(bosUp,  title="BOS Up",   style=shape.triangleup,   color=color.rgb(50,205,50),  location=location.belowbar, size=size.tiny, text="BOS↑")
plotshape(bosDown,title="BOS Down", style=shape.triangledown, color=color.rgb(255,0,0),    location=location.abovebar, size=size.tiny, text="BOS↓")

// === Equal High / Low (простая метрика) ===
equalThreshold = syminfo.mintick * 10
equalHigh = math.abs(high - high[1]) <= equalThreshold
equalLow  = math.abs(low  - low[1]) <= equalThreshold
plotshape(equalHigh, title="Equal High", style=shape.circle, color=color.rgb(255,0,255), location=location.abovebar, size=size.tiny, text="EH")
plotshape(equalLow,  title="Equal Low",  style=shape.circle, color=color.rgb(0,255,255),   location=location.belowbar, size=size.tiny, text="EL")

// === FVG (простой детектор импульсного пробела) ===
fvgUp   = low > high[2]   // пробел вверх (бычий имбаланс)
fvgDown = high < low[2]   // пробел вниз (медвежий имбаланс)
bgcolor(fvgUp ? color.new(color.rgb(0,180,0), 85) : na)
bgcolor(fvgDown ? color.new(color.rgb(180,0,0), 85) : na)

// === Order Block (автоматическое простое определение) ===
// Логика: при BOS запоминаем свечу перед импульсом как OB (упрощённый подход)
var box lastOB = na
if bosUp
    obTop  = high[1]
    obBot  = low[1]
    if not na(lastOB)
        box.delete(lastOB)
    lastOB := box.new(left=bar_index - 5, right=bar_index + 2, top=obTop, bottom=obBot,
                      bgcolor=color.new(color.rgb(255,255,0), 80),
                      border_color=color.rgb(255,215,0))
if bosDown
    obTop  = high[1]
    obBot  = low[1]
    if not na(lastOB)
        box.delete(lastOB)
    lastOB := box.new(left=bar_index - 5, right=bar_index + 2, top=obTop, bottom=obBot,
                      bgcolor=color.new(color.rgb(255,255,0), 80),
                      border_color=color.rgb(255,215,0))

// === Входы с фильтрацией объёмов и VWAP ===
// Условия: тренд по EMA, BOS в сторону тренда, цена над/под EMA и VWAP, и объём повышен
buySignal  = bullish and bosUp   and close > emaFast and close > vwap and highVol
sellSignal = bearish and bosDown and close < emaFast and close < vwap and highVol

plotshape(buySignal,  title="BUY Signal",  style=shape.labelup,   color=color.rgb(0,200,0),  text="BUY",  location=location.belowbar, size=size.small)
plotshape(sellSignal, title="SELL Signal", style=shape.labeldown, color=color.rgb(200,0,0),  text="SELL", location=location.abovebar, size=size.small)

// === TP / SL (простая логика) ===
rewardRatio = 3.0
var float lastSL = na
var float lastTP = na

if buySignal
    lastSL := low - syminfo.mintick * 5
    lastTP := close + (close - lastSL) * rewardRatio
    line.new(bar_index, lastSL, bar_index + 10, lastSL, color=color.rgb(200,0,0), style=line.style_dotted, width=1)
    line.new(bar_index, lastTP, bar_index + 10, lastTP, color=color.rgb(0,150,0), style=line.style_dotted, width=1)

if sellSignal
    lastSL := high + syminfo.mintick * 5
    lastTP := close - (lastSL - close) * rewardRatio
    line.new(bar_index, lastSL, bar_index + 10, lastSL, color=color.rgb(200,0,0), style=line.style_dotted, width=1)
    line.new(bar_index, lastTP, bar_index + 10, lastTP, color=color.rgb(0,150,0), style=line.style_dotted, width=1)

// === Алёрты ===
alertcondition(buySignal,  title="BUY SMC CRT",  message="SMC CRT: Покупка подтверждена (тренд+VWAP+объём).")
alertcondition(sellSignal, title="SELL SMC CRT", message="SMC CRT: Продажа подтверждена (тренд+VWAP+объём).")
