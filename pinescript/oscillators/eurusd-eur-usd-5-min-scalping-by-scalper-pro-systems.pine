// This Pine ScriptÂ® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© billal-kashif
//@version=5
indicator("EUR/USD: EUR USD 5 MIN SCALPING", overlay=true)
// --- 1. SETTINGS ---
emaFastLen    = input.int(9, title="Fast EMA (Green)", group="Strategy")
emaSlowLen    = input.int(21, title="Slow EMA (Red)", group="Strategy")
emaTrendLen   = input.int(200, title="Trend EMA (Black)", group="Strategy")
rsiLen        = input.int(14, title="RSI Length", group="Strategy")
swingLookback = input.int(4, title="Swing Lookback (Bars for SL)", group="Risk Management")
rewardRatio   = input.float(1.5, title="Risk:Reward Ratio", group="Risk Management")

// --- 2. INDICATOR CALCULATIONS ---
emaFast  = ta.ema(close, emaFastLen)
emaSlow  = ta.ema(close, emaSlowLen)
emaTrend = ta.ema(close, emaTrendLen)
rsiValue = ta.rsi(close, rsiLen)

// Track Swing Highs/Lows for every bar
swingLow  = ta.lowest(low, swingLookback)
swingHigh = ta.highest(high, swingLookback)

// Plot Indicators
plot(emaFast, color=color.green, title="EMA 9")
plot(emaSlow, color=color.red, title="EMA 21")
plot(emaTrend, color=color.black, title="EMA 200", linewidth=2)

// --- 3. TRADE STATE MANAGEMENT (The Brain) ---
// We use 'var' variables to remember data between candles
var bool  inTrade      = false
var string tradeType   = "NONE" // "LONG" or "SHORT"
var float entryPrice   = 0.0
var float tpPrice      = 0.0
var float slPrice      = 0.0
var int   entryTime    = 0

// --- 4. SIGNAL GENERATION ---
// Conditions
bool longCond  = (not inTrade) and (close > emaTrend) and ta.crossover(emaFast, emaSlow) and (rsiValue > 50)
bool shortCond = (not inTrade) and (close < emaTrend) and ta.crossunder(emaFast, emaSlow) and (rsiValue < 50)

// --- 5. EXECUTION LOGIC ---

// >> CHECK FOR EXITS (If we are in a trade)
if inTrade
    if tradeType == "LONG"
        // Check if TP Hit
        if high >= tpPrice
            label.new(bar_index, high, text="âœ… TP HIT\n" + str.format_time(time, "HH:mm"), color=color.green, style=label.style_label_down, textcolor=color.white, size=size.small)
            inTrade := false
        // Check if SL Hit
        else if low <= slPrice
            label.new(bar_index, low, text="âŒ SL HIT\n" + str.format_time(time, "HH:mm"), color=color.red, style=label.style_label_up, textcolor=color.white, size=size.small)
            inTrade := false
            
    else if tradeType == "SHORT"
        // Check if TP Hit
        if low <= tpPrice
            label.new(bar_index, low, text="âœ… TP HIT\n" + str.format_time(time, "HH:mm"), color=color.green, style=label.style_label_up, textcolor=color.white, size=size.small)
            inTrade := false
        // Check if SL Hit
        else if high >= slPrice
            label.new(bar_index, high, text="âŒ SL HIT\n" + str.format_time(time, "HH:mm"), color=color.red, style=label.style_label_down, textcolor=color.white, size=size.small)
            inTrade := false

// >> CHECK FOR ENTRIES (If we are NOT in a trade)
if longCond
    inTrade := true
    tradeType := "LONG"
    entryPrice := close
    entryTime := time
    slPrice := swingLow
    float risk = entryPrice - slPrice
    tpPrice := entryPrice + (risk * rewardRatio)
    
    // Create the Info Box
    string txt = "ðŸŸ¢ BUY SIGNAL\nTime: " + str.format_time(time, "HH:mm") + "\nEntry: " + str.tostring(entryPrice) + "\nTP: " + str.tostring(tpPrice) + "\nSL: " + str.tostring(slPrice)
    label.new(bar_index, low, text=txt, color=color.green, style=label.style_label_up, textcolor=color.white)

if shortCond
    inTrade := true
    tradeType := "SHORT"
    entryPrice := close
    entryTime := time
    slPrice := swingHigh
    float risk = slPrice - entryPrice
    tpPrice := entryPrice - (risk * rewardRatio)
    
    // Create the Info Box
    string txt = "ðŸ”´ SELL SIGNAL\nTime: " + str.format_time(time, "HH:mm") + "\nEntry: " + str.tostring(entryPrice) + "\nTP: " + str.tostring(tpPrice) + "\nSL: " + str.tostring(slPrice)
    label.new(bar_index, high, text=txt, color=color.red, style=label.style_label_down, textcolor=color.white)
