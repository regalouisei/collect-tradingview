//@version=5
indicator("Sniper Pro: RSI Heatmap Tips", shorttitle="Sniper RSI Heat", overlay=false)

// --- הגדרות ---
lengthVFI   = input.int(130, title="VFI Length")
lengthEMA   = input.int(150, title="Trend Wall (EMA 150)") 
smooth      = input.int(3, title="VFI Smoothing Factor") 
breakoutLen = input.int(3, title="Micro Breakout Lookback")
rsiLen      = input.int(14, title="RSI Tip Length") // הגדרה חדשה ל-RSI

// --- חישובים ---
emaVal = ta.ema(close, lengthEMA)

// חישוב VFI
typical = hlc3
inter = math.log(typical) - math.log(typical[1])
vinter = ta.stdev(inter, 30)
coefVFI = 0.2
cutoff = coefVFI * vinter * close
vave = ta.sma(volume, lengthVFI)[1]
vmax = vave * 2.5
vc = volume < vmax ? volume : vmax
mf = typical - typical[1]
vcp = mf > cutoff ? vc : mf < -cutoff ? -vc : 0
vfi_raw = ta.sma(vcp, lengthVFI) / vave
vfi = ta.sma(vfi_raw, smooth)

// חישוב RSI (לטמפרטורה בקצוות)
rsiVal = ta.rsi(close, rsiLen)

// --- לוגיקת הצלף (מומנטום) ---
is_rising = vfi > vfi[1]
is_positive = vfi > 0

// בפריצה אנחנו מחפשים כוח (Rising)
raw_long_condition = is_positive and is_rising 
raw_short_condition = not is_positive and not is_rising 

// --- לוגיקת הפריצה המהירה (Micro Breakout) ---
is_breaking_resistance = close >= ta.highest(high[1], breakoutLen)
is_breaking_support = close <= ta.lowest(low[1], breakoutLen)

// --- המוח: שילוב הכל ---
var int state = 0 
final_long = false
final_short = false

// בדיקת לונג מהירה
if raw_long_condition and close > emaVal and is_breaking_resistance
    if state != 1 
        final_long := true
        state := 1 

// בדיקת שורט מהירה
if raw_short_condition and close < emaVal and is_breaking_support
    if state != -1 
        final_short := true
        state := -1 

// --- עיצוב צבעי בסיס להיסטוגרמה ---
hist_col = color.gray
if close > emaVal 
    hist_col := is_positive ? (is_rising ? color.green : color.lime) : color.new(color.gray, 60)
else 
    hist_col := not is_positive ? (not is_rising ? color.maroon : color.red) : color.new(color.gray, 60)

// פלוט ההיסטוגרמה (הבסיס)
plot(vfi, title="Sniper VFI", color=hist_col, style=plot.style_columns, linewidth=1)
hline(0, "Zero Line", color=color.gray)

// --- לוגיקת RSI Heatmap לקצוות (התוספת החדשה) ---

// צבע ברירת מחדל לטיפ (שקוף לגמרי)
tip_col = color.new(color.gray, 100)

if rsiVal > 70
    // אזור קניית יתר: הופך לכתום
    // משתמשים בגרדיאנט: ככל שמתקרבים ל-100, הכתום נהיה חזק יותר (פחות שקוף)
    tip_col := color.from_gradient(rsiVal, 70, 100, color.new(color.orange, 70), color.new(color.orange, 0))
else if rsiVal < 30
    // אזור מכירת יתר: הופך ללבן
    // משתמשים בגרדיאנט: ככל שמתקרבים ל-0, הלבן נהיה חזק יותר
    tip_col := color.from_gradient(rsiVal, 0, 30, color.new(color.white, 0), color.new(color.white, 70))

// פלוט הטיפים: עיגולים קטנים שיושבים בדיוק על קצה העמודה
// location.absolute ממקם אותם בדיוק בערך של ה-VFI
plotshape(vfi, title="RSI Tip Heatmap", style=shape.circle, location=location.absolute, color=tip_col, size=size.tiny)


// --- הסיגנלים המהירים על קו ישר ---
plotshape(final_long ? 0 : na, title="Sniper Long", style=shape.labelup, location=location.absolute, color=color.lime, size=size.small, text="L", textcolor=color.black)
plotshape(final_short ? 0 : na, title="Sniper Short", style=shape.labeldown, location=location.absolute, color=color.red, size=size.small, text="S", textcolor=color.white)
