//@version=5
indicator("EMA with RSI Color (Custom Lengths)", overlay=true)

// ===== EMA Timeframe Settings =====
useChartTF = input.bool(true, "Use chart timeframe for EMA?")
emaTFInput = input.timeframe("60", "Custom EMA timeframe", options=["1","5","60","240","D","W"])
emaTF = useChartTF ? timeframe.period : emaTFInput

// ===== EMA Length Settings =====
emaLen1 = input.int(20,  "EMA Length 1", minval=1)
emaLen2 = input.int(60,  "EMA Length 2", minval=1)
emaLen3 = input.int(120, "EMA Length 3", minval=1)

// ===== RSI Settings =====
useRSIOnEmaTF = input.bool(true, "Use same timeframe for RSI as EMA?")
rsiLength = input.int(14, "RSI Length", minval=1)
rsiLow    = input.float(30.0, "RSI Oversold Level", step=0.1)
rsiHigh   = input.float(70.0, "RSI Overbought Level", step=0.1)

// ===== Color Settings =====
ema1ColorNormal = input.color(color.black, "EMA 1 Normal Color")
ema2ColorNormal = input.color(color.blue,   "EMA 2 Normal Color")
ema3ColorNormal = input.color(color.purple, "EMA 3 Normal Color")

emaColorRSILow  = input.color(color.lime, "EMA Color when RSI < Oversold")
emaColorRSIHigh = input.color(color.red,  "EMA Color when RSI > Overbought")

// ===== EMA Calculations =====
ema1 = request.security(syminfo.tickerid, emaTF, ta.ema(close, emaLen1))
ema2 = request.security(syminfo.tickerid, emaTF, ta.ema(close, emaLen2))
ema3 = request.security(syminfo.tickerid, emaTF, ta.ema(close, emaLen3))

// ===== RSI Calculation =====
rsiTF  = useRSIOnEmaTF ? emaTF : timeframe.period
rsiVal = request.security(syminfo.tickerid, rsiTF, ta.rsi(close, rsiLength))

// ===== EMA Color Function =====
getEmaColor(normalColor) =>
    color out = normalColor
    if rsiVal < rsiLow
        out := emaColorRSILow
    else if rsiVal > rsiHigh
        out := emaColorRSIHigh
    out

// ===== Plot =====
plot(ema1, title="EMA 1", color=getEmaColor(ema1ColorNormal), linewidth=2)
plot(ema2, title="EMA 2", color=getEmaColor(ema2ColorNormal), linewidth=2)
plot(ema3, title="EMA 3", color=getEmaColor(ema3ColorNormal), linewidth=2)
