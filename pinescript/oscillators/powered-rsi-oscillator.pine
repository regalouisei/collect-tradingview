// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © ASSAF-ALGOS

//@version=5
indicator("powered rsi oscillator", shorttitle="powered rsi oscillator", overlay=false, max_lines_count=300, max_labels_count=300)

//────────────────────────────
// Inputs
//────────────────────────────
length   = input.int(14, "RSI Length")
ob       = input.int(80, "Overbought")
os       = input.int(20, "Oversold")

pivotLen = input.int(5, "Pivot Length", minval=1)

showRegBull = input.bool(true, "Show Regular Bullish")
showRegBear = input.bool(true, "Show Regular Bearish")
showHidBull = input.bool(true, "Show Hidden Bullish")
showHidBear = input.bool(true, "Show Hidden Bearish")

//────────────────────────────
// Functions
//────────────────────────────
WiMA(src, length) =>
    float ma = na
    ma := (src + nz(ma[1]) * (length - 1)) / length
    ma

calc_rsi_volume(fv, length) =>
    up = fv > fv[1] ? math.abs(fv - fv[1]) * volume : 0.0
    dn = fv < fv[1] ? math.abs(fv - fv[1]) * volume : 0.0
    upt = WiMA(up, length)
    dnt = WiMA(dn, length)
    100 * (upt / (upt + dnt))

//────────────────────────────
// RSI Volume Calculation
//────────────────────────────
rsi_v = calc_rsi_volume(close, length)

//────────────────────────────
// Pivots (Price & Oscillator)
//────────────────────────────
priceLow  = ta.pivotlow(low, pivotLen, pivotLen)
priceHigh = ta.pivothigh(high, pivotLen, pivotLen)

oscLow  = ta.pivotlow(rsi_v, pivotLen, pivotLen)
oscHigh = ta.pivothigh(rsi_v, pivotLen, pivotLen)

// Store previous pivots
var float prevPriceLow  = na
var float prevOscLow    = na
var int   prevLowBar    = na

var float prevPriceHigh = na
var float prevOscHigh   = na
var int   prevHighBar   = na

//────────────────────────────
// Bullish Divergences
//────────────────────────────
if not na(priceLow) and not na(oscLow)
    currBar = bar_index - pivotLen

    // Regular Bullish: Price LL, Osc HL
    if showRegBull and not na(prevPriceLow) and priceLow < prevPriceLow and oscLow > prevOscLow
        line.new(prevLowBar, prevOscLow, currBar, oscLow, color=color.lime, width=2)
        label.new(currBar, oscLow, "Reg Bull", style=label.style_label_up, color=color.lime, textcolor=color.black)

    // Hidden Bullish: Price HL, Osc LL
    if showHidBull and not na(prevPriceLow) and priceLow > prevPriceLow and oscLow < prevOscLow
        line.new(prevLowBar, prevOscLow, currBar, oscLow, color=color.teal, width=2)
        label.new(currBar, oscLow, "Hid Bull", style=label.style_label_up, color=color.teal, textcolor=color.black)

    prevPriceLow := priceLow
    prevOscLow   := oscLow
    prevLowBar   := currBar

//────────────────────────────
// Bearish Divergences
//────────────────────────────
if not na(priceHigh) and not na(oscHigh)
    currBar = bar_index - pivotLen

    // Regular Bearish: Price HH, Osc LH
    if showRegBear and not na(prevPriceHigh) and priceHigh > prevPriceHigh and oscHigh < prevOscHigh
        line.new(prevHighBar, prevOscHigh, currBar, oscHigh, color=color.red, width=2)
        label.new(currBar, oscHigh, "Reg Bear", style=label.style_label_down, color=color.red, textcolor=color.white)

    // Hidden Bearish: Price LH, Osc HH
    if showHidBear and not na(prevPriceHigh) and priceHigh < prevPriceHigh and oscHigh > prevOscHigh
        line.new(prevHighBar, prevOscHigh, currBar, oscHigh, color=color.orange, width=2)
        label.new(currBar, oscHigh, "Hid Bear", style=label.style_label_down, color=color.orange, textcolor=color.black)

    prevPriceHigh := priceHigh
    prevOscHigh   := oscHigh
    prevHighBar   := currBar

//────────────────────────────
// Plots
//────────────────────────────
h_ob = hline(ob, "Overbought", color=color.red)
h_os = hline(os, "Oversold", color=color.green)
h_mid = hline(50, "Mid", color=color.gray)

fill(h_ob, h_os, color=color.new(color.red, 85))
plot(rsi_v, color=color.red, linewidth=1, title="RSI Volume")
