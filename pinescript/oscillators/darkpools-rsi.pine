// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0
// © DarkPoolCrypto 

//@version=6
indicator("DarkPool's RSi ",  overlay=false) , max_labels_count=500

// Input parameters
rsi_length = input.int(14, title="RSI Length", minval=1)
rsi_source = input.source(close, title="RSI Source")
lookback = input.int(5, title="Pivot Lookback", minval=1, maxval=15)
show_table = input.bool(true, title="Show Divergence Table")
bullish_color = input.color(color.green, title="Bullish Divergence Color")
bearish_color = input.color(color.red, title="Bearish Divergence Color")

// Calculate RSI
rsi = ta.rsi(rsi_source, rsi_length)

// Plot RSI
plot(rsi, title="RSI", color=color.black, linewidth=2)
hline(70, "Overbought", color=color.red, linestyle=hline.style_dashed)
hline(50, "Midline", color=color.gray, linestyle=hline.style_dotted)
hline(30, "Oversold", color=color.green, linestyle=hline.style_dashed)

// Find pivot highs and lows
ph = ta.pivothigh(rsi, lookback, lookback)
pl = ta.pivotlow(rsi, lookback, lookback)

// Variables to store pivot points
var float last_ph_price = na
var float last_ph_rsi = na
var int last_ph_bar = na
var float last_pl_price = na
var float last_pl_rsi = na
var int last_pl_bar = na

// Variables for divergence signals
var bool bullish_signal = false
var bool bearish_signal = false
var bool bullish_div_active = false
var bool bearish_div_active = false

// Check for bearish divergence
bearish_divergence = false
if not na(ph)
    current_ph_price = high[lookback]
    current_ph_rsi = ph
    current_ph_bar = bar_index - lookback
    
    // Check for bearish divergence (price higher high, RSI lower high)
    if not na(last_ph_price) and not na(last_ph_rsi)
        if current_ph_price > last_ph_price and current_ph_rsi < last_ph_rsi
            bearish_divergence := true
            bearish_signal := true
            bearish_div_active := true
            // Draw line connecting the RSI highs
            line.new(last_ph_bar, last_ph_rsi, current_ph_bar, current_ph_rsi, color=bearish_color, width=2, style=line.style_solid)
    
    // Update last pivot high values
    last_ph_price := current_ph_price
    last_ph_rsi := current_ph_rsi
    last_ph_bar := current_ph_bar

// Check for bullish divergence
bullish_divergence = false
if not na(pl)
    current_pl_price = low[lookback]
    current_pl_rsi = pl
    current_pl_bar = bar_index - lookback
    
    // Check for bullish divergence (price lower low, RSI higher low)
    if not na(last_pl_price) and not na(last_pl_rsi)
        if current_pl_price < last_pl_price and current_pl_rsi > last_pl_rsi
            bullish_divergence := true
            bullish_signal := true
            bullish_div_active := true
            // Draw line connecting the RSI lows
            line.new(last_pl_bar, last_pl_rsi, current_pl_bar, current_pl_rsi, color=bullish_color, width=2, style=line.style_solid)
    
    // Update last pivot low values
    last_pl_price := current_pl_price
    last_pl_rsi := current_pl_rsi
    last_pl_bar := current_pl_bar

// Reset divergence activity after some bars
if bullish_div_active and not na(last_pl_bar) and bar_index > last_pl_bar + 10
    bullish_div_active := false
if bearish_div_active and not na(last_ph_bar) and bar_index > last_ph_bar + 10
    bearish_div_active := false

// Plot divergence markers
plotshape(bullish_divergence, title="Bullish Divergence", location=location.absolute, style=shape.triangleup, size=size.small, color=bullish_color, offset=-lookback)
plotshape(bearish_divergence, title="Bearish Divergence", location=location.absolute, style=shape.triangledown, size=size.small, color=bearish_color, offset=-lookback)

// Plot background colors for active divergences
bgcolor(bullish_div_active ? color.new(bullish_color, 95) : na, title="Bullish Divergence Background")
bgcolor(bearish_div_active ? color.new(bearish_color, 95) : na, title="Bearish Divergence Background")

// Optional table to show current divergence status
if show_table
    var table div_table = table.new(position.bottom_right, 2, 3, bgcolor=color.white, border_width=1)
    
    if barstate.islast
        table.cell(div_table, 0, 0, "Divergence", text_color=color.black, bgcolor=color.gray)
        table.cell(div_table, 1, 0, "Status", text_color=color.black, bgcolor=color.gray)
        
        bull_status = bullish_div_active ? "ACTIVE" : "None"
        bear_status = bearish_div_active ? "ACTIVE" : "None"
        
        table.cell(div_table, 0, 1, "Bullish", text_color=color.black, bgcolor=color.white)
        table.cell(div_table, 1, 1, bull_status, 
                  text_color=bullish_div_active ? color.white : color.black, 
                  bgcolor=bullish_div_active ? bullish_color : color.white)
        
        table.cell(div_table, 0, 2, "Bearish", text_color=color.black, bgcolor=color.white)
        table.cell(div_table, 1, 2, bear_status, 
                  text_color=bearish_div_active ? color.white : color.black, 
                  bgcolor=bearish_div_active ? bearish_color : color.white)

// Alert conditions
alertcondition(bullish_signal, title="Bullish Divergence", message="RSI Bullish Divergence Detected")
alertcondition(bearish_signal, title="Bearish Divergence", message="RSI Bearish Divergence Detected")

// Reset signals
bullish_signal := false
bearish_signal := false
