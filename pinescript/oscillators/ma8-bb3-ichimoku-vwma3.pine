//@version=5
indicator("통합 상단 지표 v5.4 (MA8 + BB3 + Ichimoku + VWMA3)", overlay=true)

// ==========================================
// 1. 이동평균선 (MA) - 8개 설정
// ==========================================
grp_ma = "이동평균선 (8개 상세 설정)"
f_ma(type, src, len) => type == "SMA" ? ta.sma(src, len) : ta.ema(src, len)

// MA 설정들 (MA1 ~ MA8)
show_ma1 = input.bool(true, "MA 1", inline="ma1", group=grp_ma), ma1_type = input.string("SMA", "", options=["SMA", "EMA"], inline="ma1", group=grp_ma), ma1_len = input.int(5, "", inline="ma1", group=grp_ma), ma1_src = input.source(close, "", inline="ma1", group=grp_ma), ma1_col = input.color(color.blue, "", inline="ma1", group=grp_ma)
plot(show_ma1 ? f_ma(ma1_type, ma1_src, ma1_len) : na, "MA 1", color=ma1_col)

show_ma2 = input.bool(true, "MA 2", inline="ma2", group=grp_ma), ma2_type = input.string("SMA", "", options=["SMA", "EMA"], inline="ma2", group=grp_ma), ma2_len = input.int(10, "", inline="ma2", group=grp_ma), ma2_src = input.source(close, "", inline="ma2", group=grp_ma), ma2_col = input.color(color.orange, "", inline="ma2", group=grp_ma)
plot(show_ma2 ? f_ma(ma2_type, ma2_src, ma2_len) : na, "MA 2", color=ma2_col)

show_ma3 = input.bool(true, "MA 3", inline="ma3", group=grp_ma), ma3_type = input.string("SMA", "", options=["SMA", "EMA"], inline="ma3", group=grp_ma), ma3_len = input.int(20, "", inline="ma3", group=grp_ma), ma3_src = input.source(close, "", inline="ma3", group=grp_ma), ma3_col = input.color(color.red, "", inline="ma3", group=grp_ma)
plot(show_ma3 ? f_ma(ma3_type, ma3_src, ma3_len) : na, "MA 3", color=ma3_col)

show_ma4 = input.bool(true, "MA 4", inline="ma4", group=grp_ma), ma4_type = input.string("SMA", "", options=["SMA", "EMA"], inline="ma4", group=grp_ma), ma4_len = input.int(60, "", inline="ma4", group=grp_ma), ma4_src = input.source(close, "", inline="ma4", group=grp_ma), ma4_col = input.color(color.green, "", inline="ma4", group=grp_ma)
plot(show_ma4 ? f_ma(ma4_type, ma4_src, ma4_len) : na, "MA 4", color=ma4_col)

show_ma5 = input.bool(false, "MA 5", inline="ma5", group=grp_ma), ma5_type = input.string("EMA", "", options=["SMA", "EMA"], inline="ma5", group=grp_ma), ma5_len = input.int(120, "", inline="ma5", group=grp_ma), ma5_src = input.source(close, "", inline="ma5", group=grp_ma), ma5_col = input.color(color.purple, "", inline="ma5", group=grp_ma)
plot(show_ma5 ? f_ma(ma5_type, ma5_src, ma5_len) : na, "MA 5", color=ma5_col)

show_ma6 = input.bool(false, "MA 6", inline="ma6", group=grp_ma), ma6_type = input.string("EMA", "", options=["SMA", "EMA"], inline="ma6", group=grp_ma), ma6_len = input.int(200, "", inline="ma6", group=grp_ma), ma6_src = input.source(close, "", inline="ma6", group=grp_ma), ma6_col = input.color(color.aqua, "", inline="ma6", group=grp_ma)
plot(show_ma6 ? f_ma(ma6_type, ma6_src, ma6_len) : na, "MA 6", color=ma6_col)

show_ma7 = input.bool(false, "MA 7", inline="ma7", group=grp_ma), ma7_type = input.string("SMA", "", options=["SMA", "EMA"], inline="ma7", group=grp_ma), ma7_len = input.int(240, "", inline="ma7", group=grp_ma), ma7_src = input.source(close, "", inline="ma7", group=grp_ma), ma7_col = input.color(color.yellow, "", inline="ma7", group=grp_ma)
plot(show_ma7 ? f_ma(ma7_type, ma7_src, ma7_len) : na, "MA 7", color=ma7_col)

show_ma8 = input.bool(false, "MA 8", inline="ma8", group=grp_ma), ma8_type = input.string("SMA", "", options=["SMA", "EMA"], inline="ma8", group=grp_ma), ma8_len = input.int(480, "", inline="ma8", group=grp_ma), ma8_src = input.source(close, "", inline="ma8", group=grp_ma), ma8_col = input.color(color.gray, "", inline="ma8", group=grp_ma)
plot(show_ma8 ? f_ma(ma8_type, ma8_src, ma8_len) : na, "MA 8", color=ma8_col)

// ==========================================
// 2. 볼린저 밴드 (BB) - 3개 (명칭 수정 및 배경 최적화)
// ==========================================
grp_bb = "볼린저 밴드 (3개)"
f_bb(src, len, mult) =>
    basis = ta.sma(src, len)
    dev = mult * ta.stdev(src, len)
    [basis, basis + dev, basis - dev]

// BB 1
show_bb1 = input.bool(false, "BB 1 활성화", group=grp_bb)
bb1_len  = input.int(20, "길이", inline="bb1", group=grp_bb)
bb1_mult = input.float(2.0, "승수", inline="bb1", group=grp_bb)
color_bg1 = input.color(color.new(color.blue, 90), "배경색", inline="bb1", group=grp_bb)
[b1, u1, l1] = f_bb(close, bb1_len, bb1_mult)
p1_u = plot(show_bb1 ? u1 : na, "BB1 상한선", color=color.new(color.blue, 50))
p1_l = plot(show_bb1 ? l1 : na, "BB1 하한선", color=color.new(color.blue, 50))
fill(p1_u, p1_l, color=show_bb1 ? color_bg1 : na, title="BB1 배경 채우기")

// BB 2
show_bb2 = input.bool(false, "BB 2 활성화", group=grp_bb)
bb2_len  = input.int(20, "길이", inline="bb2", group=grp_bb)
bb2_mult = input.float(3.0, "승수", inline="bb2", group=grp_bb)
color_bg2 = input.color(color.new(color.red, 90), "배경색", inline="bb2", group=grp_bb)
[b2, u2, l2] = f_bb(close, bb2_len, bb2_mult)
p2_u = plot(show_bb2 ? u2 : na, "BB2 상한선", color=color.new(color.red, 50))
p2_l = plot(show_bb2 ? l2 : na, "BB2 하한선", color=color.new(color.red, 50))
fill(p2_u, p2_l, color=show_bb2 ? color_bg2 : na, title="BB2 배경 채우기")

// BB 3
show_bb3 = input.bool(false, "BB 3 활성화", group=grp_bb)
bb3_len  = input.int(20, "길이", inline="bb3", group=grp_bb)
bb3_mult = input.float(1.0, "승수", inline="bb3", group=grp_bb)
color_bg3 = input.color(color.new(color.green, 90), "배경색", inline="bb3", group=grp_bb)
[b3, u3, l3] = f_bb(close, bb3_len, bb3_mult)
p3_u = plot(show_bb3 ? u3 : na, "BB3 상한선", color=color.new(color.green, 50))
p3_l = plot(show_bb3 ? l3 : na, "BB3 하한선", color=color.new(color.green, 50))
fill(p3_u, p3_l, color=show_bb3 ? color_bg3 : na, title="BB3 배경 채우기")

// ==========================================
// 3. 일목균형표 (Ichimoku Cloud)
// ==========================================
grp_ichi = "일목균형표"
show_ichi = input.bool(false, "일목균형표 활성화", group=grp_ichi)
tenkan_len = input.int(9, "전환선", group=grp_ichi)
kijun_len = input.int(26, "기준선", group=grp_ichi)
senkou_b_len = input.int(52, "선행스팬 B", group=grp_ichi)
displacement = input.int(26, "변위", group=grp_ichi)
donchian(len) => math.avg(ta.highest(len), ta.lowest(len))
tenkan = donchian(tenkan_len), kijun = donchian(kijun_len), senkou_a = math.avg(tenkan, kijun), senkou_b = donchian(senkou_b_len)

plot(show_ichi ? tenkan : na, "전환선", color=color.blue)
plot(show_ichi ? kijun : na, "기준선", color=color.red)
plot(show_ichi ? close : na, "후행스팬", color=color.teal, offset = -displacement + 1)
p_sa = plot(show_ichi ? senkou_a[displacement - 1] : na, "선행스팬 A", color=color.new(color.green, 50), offset=displacement-1)
p_sb = plot(show_ichi ? senkou_b[displacement - 1] : na, "선행스팬 B", color=color.new(color.red, 50), offset=displacement-1)
fill(p_sa, p_sb, color=show_ichi ? (senkou_a > senkou_b ? color.new(color.green, 92) : color.new(color.red, 92)) : na, title="일목 구름 배경")

// ==========================================
// 4. VWMA - 3개
// ==========================================
grp_vwma = "VWMA (3개)"
show_vw1 = input.bool(false, "VWMA 1", inline="vw1", group=grp_vwma), vw1_len = input.int(20, "", inline="vw1", group=grp_vwma)
plot(show_vw1 ? ta.vwma(close, vw1_len) : na, "VWMA 1", color=color.orange, linewidth=2)
show_vw2 = input.bool(false, "VWMA 2", inline="vw2", group=grp_vwma), vw2_len = input.int(60, "", inline="vw2", group=grp_vwma)
plot(show_vw2 ? ta.vwma(close, vw2_len) : na, "VWMA 2", color=color.blue, linewidth=2)
show_vw3 = input.bool(false, "VWMA 3", inline="vw3", group=grp_vwma), vw3_len = input.int(120, "", inline="vw3", group=grp_vwma)
plot(show_vw3 ? ta.vwma(close, vw3_len) : na, "VWMA 3", color=color.purple, linewidth=2)
