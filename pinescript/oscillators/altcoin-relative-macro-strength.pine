//@version=6
indicator("Altcoin Relative Macro Strength", shorttitle="Altcoin Macro Strength", overlay=false)

// User inputs
lookbackPeriod = input.int(21, "Lookback Period (bars)", minval=1, tooltip="Number of bars to look back for ratio change calculation. Daily: 21-30, Weekly: 4, Monthly: 1")
macroSlopeScale = input.float(3.0, "Macro Slope Scale", minval=0.5, maxval=10.0, step=0.5, tooltip="Multiplier to make macro slope line more visible")

// Fetch TOTAL3ES (Altcoin market cap excluding BTC and ETH)
total3es = request.security("CRYPTOCAP:total3es", timeframe.period, close)

// Fetch Global Liquidity components
usbcoi = request.security("ECONOMICS:USBCOI", timeframe.period, close)
uscbbs = request.security("ECONOMICS:USCBBS", timeframe.period, close)
rrpontsyd = request.security("FRED:RRPONTSYD", timeframe.period, close)
wtregen = request.security("FRED:WTREGEN", timeframe.period, close)
usm2 = request.security("ECONOMICS:USM2", timeframe.period, close)
cnm2 = request.security("ECONOMICS:CNM2", timeframe.period, close)

// Fetch IWM (Russell 2000 ETF - small cap stocks)
iwm = request.security("AMEX:IWM", timeframe.period, close)

// Calculate Global Macro (PMI * Global Liquidity * IWM)
globalLiquidity = uscbbs - rrpontsyd - wtregen + usm2 + cnm2
globalMacro = usbcoi * globalLiquidity * iwm

// Calculate the ratio
ratio = total3es / globalMacro

// Get the AVERAGE ratio over the lookback period
ratioLookback = ta.sma(ratio, lookbackPeriod)

// Calculate ratio percentage change over lookback period
ratioChange = ((ratio - ratioLookback) / ratioLookback) * 100

// Calculate slope of Global Macro using AVERAGE
globalMacroLookback = ta.sma(globalMacro, lookbackPeriod)
macroSlope = ((globalMacro - globalMacroLookback) / globalMacroLookback) * 100

// Scale the macro slope for better visibility
macroSlopeScaled = macroSlope * macroSlopeScale

// ===== MACRO TREND =====
macroSlopeUp = macroSlope > 0
macroSlopeTrendUp = macroSlope > macroSlope[1]

// Color scheme: Teal (bullish), Gray (neutral), Purple (bearish)
string macroTrend = ""
color macroTrendColor = color.gray

if macroSlopeUp and macroSlopeTrendUp
    macroTrend := "BULLISH ▲"
    macroTrendColor := #00BCD4  // Teal/Cyan
else if macroSlopeUp and not macroSlopeTrendUp
    macroTrend := "NEUTRAL →"
    macroTrendColor := #9E9E9E  // Gray
else if not macroSlopeUp and macroSlopeTrendUp
    macroTrend := "NEUTRAL →"
    macroTrendColor := #9E9E9E  // Gray
else
    macroTrend := "BEARISH ▼"
    macroTrendColor := #E91E63  // Pink/Magenta

// ===== VALUATION INDICATOR =====
string valuationLevel = ""
color valuationColor = color.gray

if not na(ratioChange)
    if ratioChange >= 80
        valuationLevel := "EXTREME PREMIUM"
        valuationColor := #B71C1C  // Dark Red
    else if ratioChange >= 50
        valuationLevel := "LARGE PREMIUM"
        valuationColor := #E53935  // Red
    else if ratioChange >= 25
        valuationLevel := "PREMIUM"
        valuationColor := #FF8A65  // Light Orange
    else if ratioChange >= 0
        valuationLevel := "FAIR VALUE"
        valuationColor := #FFD54F  // Amber
    else if ratioChange >= -10
        valuationLevel := "DISCOUNT"
        valuationColor := #81C784  // Light Green
    else if ratioChange >= -25
        valuationLevel := "DEEP DISCOUNT"
        valuationColor := #4CAF50  // Green
    else
        valuationLevel := "EXTREME DISCOUNT"
        valuationColor := #1B5E20  // Dark Green
else
    valuationLevel := "CALCULATING..."

// Plot histogram - Lime green (positive) / Coral red (negative)
plot(ratioChange, title="TOTAL3/Macro Ratio Change %", 
     color=ratioChange >= 0 ? #66BB6A : #EF5350, 
     linewidth=2, style=plot.style_histogram)

// Plot macro slope line
macroSlopeLine = plot(macroSlopeScaled, title="Macro Slope % (Scaled)", 
                      color=macroTrendColor, 
                      linewidth=3, style=plot.style_line)

// Zero line for fills
zeroLinePlot = plot(0, title="Zero", color=color.new(color.white, 100), linewidth=1)

// Fill with transparency
fill(macroSlopeLine, zeroLinePlot, 
     color=color.new(macroTrendColor, 75), 
     title="Macro Slope Fill")

// Zero line
hline(0, "Zero Line", color=color.white, linestyle=hline.style_solid, linewidth=2)

// Reference lines with subtle colors
hline(80, "+80%", color=color.new(#66BB6A, 70), linestyle=hline.style_dashed)
hline(50, "+50%", color=color.new(#66BB6A, 70), linestyle=hline.style_dashed)
hline(-25, "-25%", color=color.new(#EF5350, 70), linestyle=hline.style_dashed)
hline(-40, "-40%", color=color.new(#EF5350, 70), linestyle=hline.style_dashed)

// Info table
var table infoTable = table.new(position.top_right, 2, 5, bgcolor=color.new(#1E1E1E, 15), border_width=1)
if barstate.islast
    table.cell(infoTable, 0, 0, "Alts/Macro Change:", text_color=#BDBDBD, text_size=size.normal)
    table.cell(infoTable, 1, 0, str.tostring(ratioChange, "#.##") + "%", 
               text_color=ratioChange >= 0 ? #66BB6A : #EF5350, text_size=size.large)
    
    table.cell(infoTable, 0, 1, "Macro Trend:", text_color=#BDBDBD, text_size=size.normal)
    table.cell(infoTable, 1, 1, macroTrend, 
               text_color=color.white, bgcolor=macroTrendColor, text_size=size.normal)
    
    table.cell(infoTable, 0, 2, "Macro Slope:", text_color=#BDBDBD)
    table.cell(infoTable, 1, 2, str.tostring(macroSlope, "#.##") + "%", 
               text_color=macroTrendColor)
    
    table.cell(infoTable, 0, 3, "Altcoin Valuation:", text_color=#BDBDBD)
    table.cell(infoTable, 1, 3, valuationLevel, 
               text_color=color.white, bgcolor=valuationColor, text_size=size.normal)
    
    table.cell(infoTable, 0, 4, "Alts Mcap:", text_color=#BDBDBD)
    table.cell(infoTable, 1, 4, str.tostring(total3es / 1e9, "#,###.##") + "B", text_color=#BDBDBD)
