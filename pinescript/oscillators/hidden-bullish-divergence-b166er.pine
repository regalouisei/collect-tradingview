// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © B166ERcrypto

//@version=6

indicator("Hidden Bullish Divergence [xAI]", shorttitle="HBD", overlay=true, max_lines_count=500, max_labels_count=500)

// === INPUTS ===
rsiLength = input.int(14, "RSI Length", minval=1)
lookback  = input.int(5,  "Pivot Lookback", minval=1)
minDist   = input.int(20, "Min Bars Between Pivots", minval=5)
showLines = input.bool(true, "Show Divergence Lines")
showLabel = input.bool(true, "Show Labels")
alertOn   = input.bool(true, "Enable Alerts")

// === RSI ===
rsi = ta.rsi(close, rsiLength)

// === PIVOT DETECTION ===
priceLow = ta.pivotlow(low, lookback, lookback)
rsiLow   = ta.pivotlow(rsi, lookback, lookback)

// === VARIABLES ===
var float lastPriceLow  = na
var float prevPriceLow  = na
var int   lastPriceBar  = na
var int   prevPriceBar  = na

var float lastRsiLow    = na
var float prevRsiLow    = na
var int   lastRsiBar    = na
var int   prevRsiBar    = na

// === UPDATE PRICE PIVOTS ===
if not na(priceLow)
    prevPriceLow := lastPriceLow
    prevPriceBar := lastPriceBar
    lastPriceLow := priceLow
    lastPriceBar := bar_index

// === UPDATE RSI PIVOTS ===
if not na(rsiLow)
    prevRsiLow := lastRsiLow
    prevRsiBar := lastRsiBar
    lastRsiLow := rsiLow
    lastRsiBar := bar_index

// === HIDDEN BULLISH DIVERGENCE ===
isHiddenBullish = false
if not na(prevPriceLow) and not na(lastPriceLow) and not na(prevRsiLow) and not na(lastRsiLow)
    if lastPriceLow > prevPriceLow and lastRsiLow < prevRsiLow and (lastPriceBar - prevPriceBar >= minDist)
        isHiddenBullish := true

// === PLOT ARROW ===
plotshape(isHiddenBullish and bar_index == lastPriceBar, title="HBD", location=location.belowbar, color=color.green, style=shape.triangleup, size=size.small, text="HBD", textcolor=color.white)

// === DRAW LINES (Fixed: No yloc) ===
var line priceLine = na
var line rsiLine   = na

if isHiddenBullish and bar_index == lastPriceBar
    if not na(priceLine) 
        line.delete(priceLine)
    if not na(rsiLine)   
        line.delete(rsiLine)
    
    priceLine := line.new(prevPriceBar, prevPriceLow, lastPriceBar, lastPriceLow, color=color.green, width=2, style=line.style_dashed)
    rsiLine   := line.new(prevRsiBar, prevRsiLow, lastRsiBar, lastRsiLow, color=color.red, width=2, style=line.style_dashed)

// === LABEL ===
if showLabel and isHiddenBullish and bar_index == lastPriceBar
    label.new(bar_index, low, "Hidden Bullish", color=color.green, textcolor=color.white, style=label.style_label_up, size=size.small, yloc=yloc.belowbar)

// === ALERT ===
if alertOn and isHiddenBullish and bar_index == lastPriceBar
    alert("Hidden Bullish Divergence on " + syminfo.ticker, alert.freq_once_per_bar)

// === RSI PLOT (Lower Pane) ===
plot(rsi, "RSI", color=#7E57C2)
hline(70, "Overbought", color=color.gray, linestyle=hline.style_dotted)
hline(30, "Oversold",   color=color.gray, linestyle=hline.style_dotted)
hline(50, "Midline",    color=color.gray, linestyle=hline.style_dashed)

// === DEBUG: Highlight RSI pivot lows ===
bgcolor(not na(rsiLow) ? color.new(color.purple, 90) : na)
