// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © agahakanaga (RSI port by M365 Copilot)

//@version=6
indicator("HaP RSI", shorttitle="HaP RSI", timeframe="", timeframe_gaps=true)

// --- INPUTS ---
sourceInput  = input.source(close, "Source")
rsiLenInput  = input.int(10, "RSI Length")        // Default 10
sigLenInput  = input.int(9,  "Signal Length")     // Default 9
oscTypeInput = input.string("EMA", "Oscillator MA Type", ["EMA", "SMA"])
sigTypeInput = input.string("EMA", "Signal MA Type",     ["EMA", "SMA"])
obLevel      = input.int(70, "Overbought Level")  // 70
osLevel      = input.int(30, "Oversold Level")    // 30

// --- FUNCTIONS ---
f_dema(src, len) =>
    ema1 = ta.ema(src, len)
    ema2 = ta.ema(ema1, len)
    2.0 * ema1 - ema2

ma(src, len, maType) =>
    maType == "EMA" ? ta.ema(src, len) : ta.sma(src, len)

// RSI computed using selected MA type (EMA/SMA) for avg gains/losses (mirrors MACD flexibility)
f_rsi(src, len, maType) =>
    ch  = ta.change(src)
    up  = math.max(ch, 0.0)
    dn  = -math.min(ch, 0.0)
    upMA = ma(up, len, maType)
    dnMA = ma(dn, len, maType)
    rs = dnMA == 0.0 ? 0.0 : upMA / dnMA
    dnMA == 0.0 ? 100.0 : (100.0 - (100.0 / (1.0 + rs)))

// --- 1) STANDARD RSI + SIGNAL (same structure as MACD core) ---
rsi    = f_rsi(sourceInput, rsiLenInput, oscTypeInput)
signal = ma(rsi, sigLenInput, sigTypeInput)
hist   = rsi - signal  // Hidden histogram for parity with MACD

// --- 2) DEMA RSI for dot logic (same concept as your MACD DEMA section) ---
rsi_dema_line    = f_dema(rsi, rsiLenInput)
dema_signal_line = f_dema(rsi_dema_line, sigLenInput)

// --- CONDITIONS & CROSSES (mirrored naming/logic) ---
dema_ustunde             = rsi_dema_line > dema_signal_line
dema_signal_egim_pozitif = dema_signal_line > dema_signal_line[1]
buy_condition            = dema_ustunde and dema_signal_egim_pozitif
is_first_signal          = buy_condition and not buy_condition[1]

// Exit dot: previous bar had buy_condition, current bar does not
orange_dot_condition     = buy_condition[1] and not buy_condition

// RSI vs Signal crosses (hidden by default)
bull_cross = ta.crossover(rsi, signal)
bear_cross = ta.crossunder(rsi, signal)

// --- DOT COLORS (same logic but using RSI slope) ---
dot_color = is_first_signal ? color.blue : buy_condition ? (rsi > rsi[1] ? color.green : color.orange) : na

// --- PLOTS ---
hline(50, "Midline (50)", color=color.new(color.gray, 50))

// Hidden histogram (to mirror MACD script)
hColor = hist >= 0 ? (hist > hist[1] ? #26a69a : #b2dfdb) : (hist > hist[1] ? #ffcdd2 : #ff5252)
plot(hist, "Histogram", hColor, style=plot.style_columns, display=display.none)

// Main oscillator and signal lines
plot(rsi,    "RSI",    color=color.black, linewidth=1)
plot(signal, "Signal", color=#ff6d00,     linewidth=1)

// 1) DEMA-based dots (Blue first, Green/Orange ongoing)
plotshape(buy_condition ? rsi : na,
     title="HaP Signal Dot",
     style=shape.circle,
     location=location.absolute,
     color=dot_color,
     size=size.tiny)

// Exit dot (Red when condition ends)
plotshape(orange_dot_condition ? rsi : na,
     title="HaP Exit",
     style=shape.circle,
     location=location.absolute,
     color=color.red,
     size=size.tiny)

// 3) Cross markers (hidden by default, parity with MACD)
plotshape(bull_cross ? rsi : na,
     title="RSI Up Cross",
     style=shape.triangleup,
     location=location.absolute,
     color=color.lime,
     size=size.small, display=display.none)

plotshape(bear_cross ? rsi : na,
     title="RSI Down Cross",
     style=shape.triangledown,
     location=location.absolute,
     color=color.red,
     size=size.small, display=display.none)

// Guide lines for 70/30 (no fills, keeps chart clean)
plot(obLevel, "Overbought", color=color.new(color.red, 80))
plot(osLevel, "Oversold",   color=color.new(color.green, 80))

// --- Optional Alerts (matching your MACD concept; remove if not used) ---
alertcondition(is_first_signal,      "RSI First Signal",  "RSI DEMA crossover with rising DEMA signal (first bar).")
alertcondition(buy_condition,        "RSI Ongoing Long",  "RSI DEMA above DEMA signal and DEMA signal rising.")
alertcondition(orange_dot_condition, "RSI Exit",          "Previous bar had buy condition; current bar does not.")
alertcondition(bull_cross,           "RSI Cross Up",      "RSI crossed above its signal.")
alertcondition(bear_cross,           "RSI Cross Down",    "RSI crossed below its signal.")
