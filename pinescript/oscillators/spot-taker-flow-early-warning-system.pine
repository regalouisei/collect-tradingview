//@version=6
// Modified by sabritonyali: Universal Spot Flow & Early Warning System
// This version automatically adapts to any asset (BTC, ETH, etc.)
indicator("Universal Spot Flow Intel", overlay=true, precision=2)

// --- INPUTS ---
len = input.int(20, title="VWMA Period", minval=1)

groupL1 = "Exchange Selection (On/Off)"
showBN = input.bool(true,  "Binance (Yellow)", group=groupL1)
showCB = input.bool(true,  "Coinbase (Blue)", group=groupL1)
showBB = input.bool(true,  "Bybit (Orange)", group=groupL1)
showKR = input.bool(true,  "Kraken (Purple)", group=groupL1)

// --- DYNAMIC DATA FETCHING FUNCTION ---
// Automatically finds the correct ticker for the current asset
f_get_dynamic_vwma(_exchange, _suffix, _len) =>
    // Constructing the ticker: e.g., BINANCE: + ETH + USDT
    string _ticker = _exchange + ":" + syminfo.basecurrency + _suffix
    [s_close, s_vol] = request.security(_ticker, timeframe.period, [close, volume], ignore_invalid_symbol=true)
    ta.vwma(s_close, _len)

// Fetching data dynamically
// Note: USDT for most, USD for Coinbase/Kraken as per market standard
bn_line = showBN ? f_get_dynamic_vwma("BINANCE", "USDT", len) : na
cb_line = showCB ? f_get_dynamic_vwma("COINBASE", "USD",  len) : na
bb_line = showBB ? f_get_dynamic_vwma("BYBIT",   "USDT", len) : na
kr_line = showKR ? f_get_dynamic_vwma("KRAKEN",  "USDT", len) : na

// --- PLOTTING ---
plot(close, title="Futures Price (Base)", color=color.new(color.gray, 50), linewidth=1)
plot(bn_line, title="Binance Spot", color=color.yellow, linewidth=2)
plot(cb_line, title="Coinbase Spot", color=color.blue,   linewidth=2)
plot(bb_line, title="Bybit Spot",   color=color.orange, linewidth=2)
plot(kr_line, title="Kraken Spot",  color=color.purple, linewidth=2)

// --- AGGREGATED L1 LOGIC ---
float sum_lines = 0.0
int count_active = 0

if not na(bn_line) 
    sum_lines += bn_line
    count_active += 1
if not na(cb_line) 
    sum_lines += cb_line
    count_active += 1
if not na(bb_line) 
    sum_lines += bb_line
    count_active += 1
if not na(kr_line) 
    sum_lines += kr_line
    count_active += 1

float avg_l1 = count_active > 0 ? sum_lines / count_active : na

// Crossovers
bool xUp = ta.crossover(close, avg_l1)
bool xDn = ta.crossunder(close, avg_l1)

// Trend States
bool is_real_pump = not na(avg_l1) and close > avg_l1
bool is_fake_trend = not na(avg_l1) and close < avg_l1

// Alert Messaging
var string ready_msg = "Neutral"
var color ready_color = color.gray

if xUp
    ready_msg := "ðŸš€ READY FOR LONG"
    ready_color := color.lime
else if xDn
    ready_msg := "ðŸ”» READY FOR SHORT"
    ready_color := color.red
else if close > avg_l1
    ready_msg := "LONG BIAS"
    ready_color := color.green
else if close < avg_l1
    ready_msg := "SHORT BIAS"
    ready_color := color.maroon

// --- DASHBOARD TABLE ---
var table alertTable = table.new(position.bottom_right, 1, 2, bgcolor=color.new(color.black, 70), border_width=1)

if barstate.islast
    table.cell(alertTable, 0, 0, is_real_pump ? "REAL TREND" : "FAKE TREND", text_color=is_real_pump ? color.green : color.red)
    table.cell(alertTable, 0, 1, ready_msg, text_color=ready_color)

// Visual Background Confirmation
bgcolor(is_real_pump ? color.new(color.green, 92) : is_fake_trend ? color.new(color.red, 92) : na)
