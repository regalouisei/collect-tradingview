//@version=6
indicator("Buy & Sell Entry Signals v8 (Hard-anchored labels)", overlay=true)

// — Inputs —
lengthEMA1    = input.int(9,   "Fast EMA", minval=1)
lengthEMA2    = input.int(21,  "Slow EMA", minval=1)
lengthRSI     = input.int(14,  "RSI Length", minval=1)
rsiOverbought = input.int(65,  "RSI Overbought", minval=1)
rsiOversold   = input.int(35,  "RSI Oversold",  minval=1)
lengthLR      = input.int(100, "Linear Regression Length", minval=2)
lengthTTM     = input.int(20,  "TTM Squeeze Length",       minval=1)
offsetTicks   = input.int(4,   "Marker offset (ticks)",     minval=0)
confirmBars   = input.bool(true, "Require confirmed bars (no live shifting)")
showShapes    = input.bool(true, "Show plotshape arrows (backup)")

// — Base indicators —
ema9     = ta.ema(close, lengthEMA1)
ema21    = ta.ema(close, lengthEMA2)
rsiVal   = ta.rsi(close, lengthRSI)
volumeMA = ta.sma(volume, 20)

// — Regression channel —
useLen   = math.min(lengthLR, bar_index + 1)
lr       = ta.linreg(close, useLen, 0)
lrStdDev = ta.stdev(close, useLen)
lrStdDev := na(lrStdDev) ? 0.0 : lrStdDev
lrTop    = lr + 2.0 * lrStdDev
lrBottom = lr - 2.0 * lrStdDev

pTop    = plot(lrTop,    "LR Top",    color=color.new(color.blue, 70), style=plot.style_linebr)
pBottom = plot(lrBottom, "LR Bottom", color=color.new(color.blue, 70), style=plot.style_linebr)
fill(pTop, pBottom, color=color.new(color.blue, 90))

// — Momentum / Volume —
histRaw   = close - ta.ema(close, lengthTTM)
hist      = ta.ema(histRaw, 5)
histWeak  = hist < hist[1]
histStrong= hist > hist[1]
volFade   = volume < volumeMA
volSurge  = volume > volumeMA

// — Confirmation toggle —
isOkBar = confirmBars ? barstate.isconfirmed : true

// — Signals —
shortCondition = isOkBar and close > ema9 and ema9 >= ema21 and close > lrTop * 0.98 and histWeak   and volFade  and rsiVal > rsiOverbought
buyCondition   = isOkBar and close < ema9 and ema9 <= ema21 and close < lrBottom * 1.02 and histStrong and volSurge and rsiVal < rsiOversold

// — Price positions —
tick   = syminfo.mintick
yShort = high + tick * offsetTicks
yBuy   = low  - tick * offsetTicks

// — Labels (anchored to price & bar) —
if shortCondition
    label.new(bar_index, yShort, "SHORT", xloc=xloc.bar_index, yloc=yloc.price,
              style=label.style_label_down, color=color.red, textcolor=color.white, size=size.small)

if buyCondition
    label.new(bar_index, yBuy, "BUY", xloc=xloc.bar_index, yloc=yloc.price,
              style=label.style_label_up, color=color.green, textcolor=color.white, size=size.small)

// — Global plotshape (must be outside any block) —
plotshape(showShapes and shortCondition, title="SHORT ▼", style=shape.triangledown, location=location.abovebar,
          color=color.red, size=size.tiny)
plotshape(showShapes and buyCondition, title="BUY ▲", style=shape.triangleup, location=location.belowbar,
          color=color.green, size=size.tiny)

// — Baseline plots —
plot(ema9,  "EMA 9",  color=color.new(color.blue, 40))
plot(ema21, "EMA 21", color=color.new(color.purple, 40))
