//@version=5
indicator("Pro Cumulative Volume RSI", shorttitle="Pro Vol RSI", overlay=false)

// ============================================
// ğŸ“Š INPUTS - User Settings
// ============================================
group_basic = "ğŸ¯ Basic Settings"
rsi_len = input.int(14, "RSI Period", minval=1, group=group_basic, tooltip="Number of periods for RSI calculation")

group_visual = "ğŸ¨ Visual Settings"
show_histogram = input.bool(true, "Histogram Mode", group=group_visual, tooltip="Display as histogram (line only if disabled)")
show_bg = input.bool(true, "Background Coloring", group=group_visual, tooltip="Color background based on pressure direction")
bg_transparency = input.int(92, "Background Transparency", minval=70, maxval=98, group=group_visual)

group_signals = "ğŸ”” Signal Settings"
show_crossover = input.bool(true, "Crossover Signals", group=group_signals, tooltip="Show signals when lines cross")
show_divergence = input.bool(true, "Divergence Detection", group=group_signals, tooltip="Automatically detect price-indicator divergences")
div_lookback = input.int(5, "Divergence Lookback", minval=3, maxval=20, group=group_signals, tooltip="Lookback period for divergence detection")
signal_sensitivity = input.string("Medium", "Signal Sensitivity", options=["Low", "Medium", "High"], group=group_signals)

group_levels = "ğŸ“ Level Lines"
show_levels = input.bool(true, "Show Level Lines", group=group_levels)
ob_level = input.int(70, "Overbought Level", minval=50, maxval=90, group=group_levels)
os_level = input.int(30, "Oversold Level", minval=10, maxval=50, group=group_levels)

// ============================================
// ğŸ“ˆ CALCULATIONS - Core Logic
// ============================================

// Buying & Selling Volume Calculation
is_flat = high == low
BV = is_flat ? 0 : volume * (close - low) / (high - low)
SV = is_flat ? 0 : volume * (high - close) / (high - low)

// RSI Logic - For Buying Volume
BV_up = math.max(BV - SV, 0)
BV_down = math.max(SV - BV, 0)

// RSI Logic - For Selling Volume  
SV_up = math.max(SV - BV, 0)
SV_down = math.max(BV - SV, 0)

// Wilder's Moving Average (RMA)
BV_avg_up = ta.rma(BV_up, rsi_len)
BV_avg_down = ta.rma(BV_down, rsi_len)
SV_avg_up = ta.rma(SV_up, rsi_len)
SV_avg_down = ta.rma(SV_down, rsi_len)

// RS Calculation
RS_BV = BV_avg_down == 0 ? 0 : BV_avg_up / BV_avg_down
RS_SV = SV_avg_down == 0 ? 0 : SV_avg_up / SV_avg_down

// RSI Formula
RSI_BV = 100 - (100 / (1 + RS_BV))
RSI_SV = 100 - (100 / (1 + RS_SV))

// Momentum (Difference)
momentum = RSI_BV - RSI_SV

// ============================================
// ğŸ¯ SIGNAL DETECTION
// ============================================

// Crossover/Crossunder Signals
sensitivity_threshold = signal_sensitivity == "High" ? 2 : signal_sensitivity == "Medium" ? 5 : 10

bullish_cross = ta.crossover(RSI_BV, RSI_SV) and math.abs(momentum) > sensitivity_threshold
bearish_cross = ta.crossunder(RSI_BV, RSI_SV) and math.abs(momentum) > sensitivity_threshold

// Strong Buy/Sell Zones
strong_buying = RSI_BV > ob_level and RSI_SV < os_level
strong_selling = RSI_SV > ob_level and RSI_BV < os_level

// ============================================
// ğŸ“Š DIVERGENCE DETECTION
// ============================================

// Find pivot points
pivotHigh_price = ta.pivothigh(high, div_lookback, div_lookback)
pivotLow_price = ta.pivotlow(low, div_lookback, div_lookback)
pivotHigh_rsi = ta.pivothigh(RSI_BV, div_lookback, div_lookback)
pivotLow_rsi = ta.pivotlow(RSI_BV, div_lookback, div_lookback)

// Bullish Divergence (Price declining but RSI rising)
var float last_low_price = na
var float last_low_rsi = na
var int last_low_bar = na

bullish_div = false
if not na(pivotLow_price) and not na(pivotLow_rsi)
    if not na(last_low_price) and not na(last_low_rsi)
        // Price lower low, RSI higher low
        if low[div_lookback] < last_low_price and RSI_BV[div_lookback] > last_low_rsi
            bullish_div := true
    last_low_price := low[div_lookback]
    last_low_rsi := RSI_BV[div_lookback]
    last_low_bar := bar_index - div_lookback

// Bearish Divergence (Price rising but RSI declining)
var float last_high_price = na
var float last_high_rsi = na
var int last_high_bar = na

bearish_div = false
if not na(pivotHigh_price) and not na(pivotHigh_rsi)
    if not na(last_high_price) and not na(last_high_rsi)
        // Price higher high, RSI lower high
        if high[div_lookback] > last_high_price and RSI_BV[div_lookback] < last_high_rsi
            bearish_div := true
    last_high_price := high[div_lookback]
    last_high_rsi := RSI_BV[div_lookback]
    last_high_bar := bar_index - div_lookback

// ============================================
// ğŸ¨ VISUAL OUTPUTS
// ============================================

// Colors
color_buy = color.new(#00ff88, 0)
color_sell = color.new(#ff3366, 0)
color_buy_hist = color.new(#00ff88, 30)
color_sell_hist = color.new(#ff3366, 30)
color_neutral = color.new(color.gray, 50)

// Main Lines or Histograms
// Histogram - only show if enabled
plot(show_histogram ? RSI_BV : na, "Buying Volume Histogram", color=color_buy_hist, style=plot.style_histogram, linewidth=3)
plot(show_histogram ? RSI_SV : na, "Selling Volume Histogram", color=color_sell_hist, style=plot.style_histogram, linewidth=3)

// Main Lines - always show
plot(RSI_BV, "Buying Volume RSI", color=color_buy, linewidth=show_histogram ? 2 : 3)
plot(RSI_SV, "Selling Volume RSI", color=color_sell, linewidth=show_histogram ? 2 : 3)

// Momentum line (optional - additional info)
// plot(momentum + 50, "Momentum", color=color.new(color.blue, 70), linewidth=1, style=plot.style_area)

// Level Lines
hline(show_levels ? ob_level : na, "Overbought", color=color.new(color.red, 50), linestyle=hline.style_dotted)
hline(show_levels ? os_level : na, "Oversold", color=color.new(color.green, 50), linestyle=hline.style_dotted)
hline(50, "Midline", color=color.new(color.gray, 70), linestyle=hline.style_dashed)

// Background Coloring
bg_color = momentum > 20 ? color.new(color.green, bg_transparency) :
           momentum < -20 ? color.new(color.red, bg_transparency) :
           momentum > 0 ? color.new(color.green, bg_transparency + 5) :
           color.new(color.red, bg_transparency + 5)

bgcolor(show_bg ? bg_color : na, title="Pressure Direction")

// ============================================
// ğŸ”” SIGNAL VISUALIZATION
// ============================================

// Crossover Signals
plotshape(show_crossover and bullish_cross, 
          title="Bullish Signal", 
          style=shape.triangleup, 
          location=location.bottom, 
          color=color.new(color.lime, 0), 
          size=size.small,
          text="BUY")

plotshape(show_crossover and bearish_cross, 
          title="Bearish Signal", 
          style=shape.triangledown, 
          location=location.top, 
          color=color.new(color.red, 0), 
          size=size.small,
          text="SELL")

// Divergence Signals
plotshape(show_divergence and bullish_div, 
          title="Bullish Divergence", 
          style=shape.circle, 
          location=location.bottom, 
          color=color.new(color.yellow, 0), 
          size=size.tiny,
          text="DIV+")

plotshape(show_divergence and bearish_div, 
          title="Bearish Divergence", 
          style=shape.circle, 
          location=location.top, 
          color=color.new(color.orange, 0), 
          size=size.tiny,
          text="DIV-")

// Strong Zone Markers
plotshape(strong_buying, 
          title="Strong Buying Zone", 
          style=shape.diamond, 
          location=location.top, 
          color=color.new(color.aqua, 30), 
          size=size.tiny)

plotshape(strong_selling, 
          title="Strong Selling Zone", 
          style=shape.diamond, 
          location=location.bottom, 
          color=color.new(color.fuchsia, 30), 
          size=size.tiny)

// ============================================
// ğŸ“‹ INFO TABLE
// ============================================

if barstate.islast
    var table info_table = table.new(position.top_right, 2, 6, 
                                      border_width=1, 
                                      border_color=color.gray,
                                      frame_width=1,
                                      frame_color=color.gray)
    
    // Header
    table.cell(info_table, 0, 0, "ğŸ“Š STATUS", 
               bgcolor=color.new(color.blue, 70), 
               text_color=color.white, 
               text_size=size.small)
    table.cell(info_table, 1, 0, "VALUE", 
               bgcolor=color.new(color.blue, 70), 
               text_color=color.white,
               text_size=size.small)
    
    // Buying RSI
    table.cell(info_table, 0, 1, "Buying RSI", 
               text_color=color.white,
               text_size=size.small)
    table.cell(info_table, 1, 1, str.tostring(RSI_BV, "#.##"), 
               bgcolor=RSI_BV > 50 ? color.new(color.green, 80) : color.new(color.gray, 80),
               text_color=color.white,
               text_size=size.small)
    
    // Selling RSI
    table.cell(info_table, 0, 2, "Selling RSI", 
               text_color=color.white,
               text_size=size.small)
    table.cell(info_table, 1, 2, str.tostring(RSI_SV, "#.##"), 
               bgcolor=RSI_SV > 50 ? color.new(color.red, 80) : color.new(color.gray, 80),
               text_color=color.white,
               text_size=size.small)
    
    // Momentum
    table.cell(info_table, 0, 3, "Momentum", 
               text_color=color.white,
               text_size=size.small)
    momentum_text = momentum > 20 ? "ğŸŸ¢ Strong Buy" :
                   momentum > 5 ? "ğŸŸ¢ Buy" :
                   momentum < -20 ? "ğŸ”´ Strong Sell" :
                   momentum < -5 ? "ğŸ”´ Sell" : "âšª Neutral"
    table.cell(info_table, 1, 3, momentum_text, 
               text_color=color.white,
               text_size=size.small)
    
    // Status
    table.cell(info_table, 0, 4, "Pressure", 
               text_color=color.white,
               text_size=size.small)
    status_text = strong_buying ? "ğŸ’ª Very Strong Buy" :
                 strong_selling ? "ğŸ’ª Very Strong Sell" :
                 RSI_BV > ob_level ? "âš ï¸ Overbought" :
                 RSI_SV > ob_level ? "âš ï¸ Oversold" :
                 momentum > 0 ? "âœ… Buyer Pressure" : "âŒ Seller Pressure"
    table.cell(info_table, 1, 4, status_text, 
               text_color=color.white,
               text_size=size.small)
    
    // Last Signal
    table.cell(info_table, 0, 5, "Last Signal", 
               text_color=color.white,
               text_size=size.small)
    last_signal = bullish_cross ? "ğŸ”¼ BUY" :
                 bearish_cross ? "ğŸ”½ SELL" :
                 bullish_div ? "ğŸ“ˆ DIV+" :
                 bearish_div ? "ğŸ“‰ DIV-" : "â¸ï¸ Wait"
    table.cell(info_table, 1, 5, last_signal, 
               text_color=color.white,
               text_size=size.small)

// ============================================
// ğŸ”” ALERTS
// ============================================

alertcondition(bullish_cross, "Bullish Crossover", "ğŸŸ¢ Buying volume RSI crossed above Selling volume RSI!")
alertcondition(bearish_cross, "Bearish Crossover", "ğŸ”´ Selling volume RSI crossed above Buying volume RSI!")
alertcondition(strong_buying, "Strong Buying Zone", "ğŸ’ª Strong buying pressure detected!")
alertcondition(strong_selling, "Strong Selling Zone", "ğŸ’ª Strong selling pressure detected!")
alertcondition(bullish_div, "Bullish Divergence", "ğŸ“ˆ Bullish Divergence detected!")
alertcondition(bearish_div, "Bearish Divergence", "ğŸ“‰ Bearish Divergence detected!")
