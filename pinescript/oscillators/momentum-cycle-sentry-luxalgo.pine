// This work is licensed under a Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0) https://creativecommons.org/licenses/by-nc-sa/4.0/
// Â© LuxAlgo

//@version=6
indicator("Momentum Cycle Sentry [LuxAlgo]", "LuxAlgo - Momentum Cycle Sentry", overlay = false)

//---------------------------------------------------------------------------------------------------------------------}
// Constants
//---------------------------------------------------------------------------------------------------------------------{
color BULL_COLOR = #089981
color BEAR_COLOR = #f23645

//---------------------------------------------------------------------------------------------------------------------}
// Inputs
//---------------------------------------------------------------------------------------------------------------------{
int   lengthInput      = input.int(20, "Base Length", minval = 1, group = "Settings")
int   smoothingInput   = input.int(5, "Smoothing", minval = 1, group = "Settings")
float magnitudeInput   = input.float(1.0, "Magnitude", minval = 0.1, step = 0.1, group = "Settings")
int   retraceLenInput  = input.int(2, "Retracement Sensitivity", minval = 1, group = "Settings")

// OB/OS Settings (Double Bands)
int   obLengthInput    = input.int(50, "OB/OS Lookback", minval = 1, group = "Extreme Zones")
float obMultInnerInput = input.float(2.0, "Inner Multiplier", minval = 0.1, step = 0.1, group = "Extreme Zones")
float obMultOuterInput = input.float(3.0, "Outer Multiplier", minval = 0.1, step = 0.1, group = "Extreme Zones")

// Visual Inputs
color bullColorInput   = input.color(BULL_COLOR, "Bullish Color", group = "Visuals")
color bearColorInput   = input.color(BEAR_COLOR, "Bearish Color", group = "Visuals")
int   baseTransparency = input.int(80, "Base Transparency", minval = 0, maxval = 100, group = "Visuals")
bool  colorBarsInput   = input.bool(true, "Color Candles", group = "Visuals")

//---------------------------------------------------------------------------------------------------------------------}
// Calculations
//---------------------------------------------------------------------------------------------------------------------{
// Base momentum calculation
float mom = ta.mom(close, lengthInput)

// Function to calculate a smoothed, symmetric layer
getLayer(int len) =>
    float layer = ta.ema(mom, len) * magnitudeInput
    [layer, -layer]

// Calculate 5 layers for the glow effect
[p1, m1] = getLayer(smoothingInput)
[p2, m2] = getLayer(smoothingInput * 2)
[p3, m3] = getLayer(smoothingInput * 3)
[p4, m4] = getLayer(smoothingInput * 4)
[p5, m5] = getLayer(smoothingInput * 5)

// Dynamic OB/OS Calculation (Double Bands)
float stdevVal = ta.stdev(p1, obLengthInput)
float obInner  = stdevVal * obMultInnerInput
float obOuter  = stdevVal * obMultOuterInput
float osInner  = -obInner
float osOuter  = -obOuter

// Trend & Retracement Logic
bool isUptrend   = p1 > 0
bool isDowntrend = p1 < 0
bool fallingP1   = ta.falling(p1, retraceLenInput)
bool risingP1    = ta.rising(p1, retraceLenInput)
bool isRetracing = (isUptrend and fallingP1) or (isDowntrend and risingP1)

// Determine Final Color logic
color baseColor  = isUptrend ? bullColorInput : bearColorInput
color trendColor = isRetracing ? color.new(baseColor, 60) : baseColor

//---------------------------------------------------------------------------------------------------------------------}
// Visuals
//---------------------------------------------------------------------------------------------------------------------{
// Zero Line
plot(0, "Zero Line", color.new(chart.fg_color, 80))

// Double OB/OS Levels with Fill Gradient
pObInner = plot(obInner, "OB Inner", color.new(bullColorInput, 80), style = plot.style_linebr)
pObOuter = plot(obOuter, "OB Outer", color.new(bullColorInput, 60), style = plot.style_linebr)
fill(pObInner, pObOuter, obOuter, obInner, color.new(bullColorInput, 95), color.new(bullColorInput, 85), title = "OB Corridor")

pOsInner = plot(osInner, "OS Inner", color.new(bearColorInput, 80), style = plot.style_linebr)
pOsOuter = plot(osOuter, "OS Outer", color.new(bearColorInput, 60), style = plot.style_linebr)
fill(pOsInner, pOsOuter, osInner, osOuter, color.new(bearColorInput, 85), color.new(bearColorInput, 95), title = "OS Corridor")

// Plot Oscillator Layers and Fills
pp5 = plot(p5, display = display.none)
mm5 = plot(m5, display = display.none)
fill(pp5, mm5, color.new(trendColor, baseTransparency + 15), title = "Outer Glow")

pp4 = plot(p4, display = display.none)
mm4 = plot(m4, display = display.none)
fill(pp4, mm4, color.new(trendColor, baseTransparency + 10), title = "Fill 4")

pp1 = plot(p1, "Fast Line", color.new(trendColor, 40), display = display.none)
mm1 = plot(m1, "Fast Line Mirror", color.new(trendColor, 40), display = display.none)
fill(pp1, mm1, color.new(trendColor, baseTransparency - 10), title = "Inner Core")

// --- Retracement Highlight Markers ---
// Dots following the actual curve of the oscillator during a pullback
plot(isRetracing ? p1 : na, "Retrace Curve Trace", color.new(chart.fg_color, 20), style = plot.style_circles, linewidth = 2)
plot(isRetracing ? m1 : na, "Retrace Curve Mirror", color.new(chart.fg_color, 20), style = plot.style_circles, linewidth = 2)

// Zero Line Heartbeat Markers
plot(not isRetracing ? 0 : na, "Trend Continuous", trendColor, style = plot.style_circles, linewidth = 1)
plot(isRetracing ? 0 : na, "Retrace Zero Cross", trendColor, style = plot.style_cross, linewidth = 2)

// Candle Coloring
barcolor(colorBarsInput ? trendColor : na, title = "Momentum Candle Color")

//---------------------------------------------------------------------------------------------------------------------}
