//@version=6
indicator("[blackcat] L3 Enhanced KDJ Indicator", shorttitle="L3 KDJ+", overlay=false, max_bars_back=5000, max_labels_count = 500)

//**
//* [Script Summary]
//* Indicator Name: Enhanced KDJ
//* Indicator Type: Sub-chart Indicator
//* Core Function: Improved KDJ indicator combined with main force accumulation analysis for more accurate buy/sell signals
//* 
//* [Buy/Sell Signal Generation Logic]
//* - Main Force Accumulation Signal (Purple Bar): Displayed when main force accumulation indicator is greater than 0, indicating main force funds entering the market
//* - Golden Cross: Displayed when J line crosses above K line, indicating buy signal
//* - Death Cross: Displayed when J line crosses below K line, indicating sell signal
//* - Overbought: J value exceeds 90, indicating pullback from high level
//* - Oversold: J value falls below 10, indicating oversold condition
//* - KDJ Three-line Cross: The cross relationship of K, D, J lines is used to determine buy/sell timing
//* - Zero Line: 0 is the bull/bear boundary line
//* - Low Line: -10 is the oversold reference line
//*/

// ============== INPUT PARAMETERS ==============
// KDJ Parameters
kdjPeriodN = input.int(18, "KDJ Period N", minval=1)
kdjM1 = input.int(4, "K Line Smoothing", minval=1)
kdjM2 = input.int(4, "D Line Smoothing", minval=1)

// Visualization Settings
showKColorMode = input.bool(true, "K Line Color Mode", group="Color Settings")
showDColorMode = input.bool(true, "D Line Color Mode", group="Color Settings")
showJColorMode = input.bool(true, "J Line Color Mode", group="Color Settings")

// Label Settings
showBuyLabel = input.bool(true, "Show Buy Signal Labels", group="Label Settings")
showSellLabel = input.bool(true, "Show Sell Signal Labels", group="Label Settings")
showAlertLabels = input.bool(true, "Show Alert Labels", group="Label Settings")

// Alert Settings
alertOnCrossover = input.bool(true, "Alert on Crossover", group="Alert Settings")
alertOnOverbought = input.bool(true, "Alert on Overbought (>90)", group="Alert Settings")
alertOnOversold = input.bool(true, "Alert on Oversold (<10)", group="Alert Settings")
alertOnMainForce = input.bool(true, "Alert on Main Force Entry", group="Alert Settings")

// ============== COLOR DEFINITIONS ==============
// Custom colors for enhanced visualization
colorKBullish = #00E676  // Green for bullish K
colorKBearish = #FF9800  // Orange for bearish K
colorKOversold = #2979FF // Blue for oversold K
colorDNormal = #FFEB3B   // Yellow for normal D
colorDOverbought = #F44336 // Red for overbought D
colorDOversold = #9C27B0 // Purple for oversold D
colorJNormal = #F44336   // Red for normal J
colorJOverbought = #D32F2F // Dark red for overbought J
colorJOversold = #E91E63 // Pink for oversold J
colorBuySignal = #00E676 // Bright green for buy signals
colorSellSignal = #FF1744 // Bright red for sell signals
colorMainForce = #9C27B0 // Purple for main force entry
colorAlert = #FF5722     // Orange for alerts

// ============== VOLATILITY & MAIN FORCE CALCULATIONS ==============
// Get previous day's lowest price
prevDayLow = low[1]

// Calculate rsiVolatilityIndicator: RSI-related volatility indicator
rsiVolatilityIndicator = ta.sma(math.abs(low - prevDayLow), 3) / ta.sma(math.max(low - prevDayLow, 0), 3) * 100

// Calculate adjustedVolatility: Adjusted volatility using conditional judgment
adjustedVolatility = ta.ema(close > close[1] ? rsiVolatilityIndicator * 10 : rsiVolatilityIndicator / 10, 3)

// Calculate lowestPrice38: Lowest value of lowest price within 38 days
lowestPrice38 = ta.lowest(low, 38)

// Calculate highestAdjustedVolatility38: Highest value of adjustedVolatility within 38 days
highestAdjustedVolatility38 = ta.highest(adjustedVolatility, 38)

// calculate is90DayLow: Determine if it's the 90-day lowest price
is90DayLow = ta.lowest(low, 90) > 0 ? 1 : 0

// Calculate mainForceAccumulation: Comprehensive analysis based on adjustedVolatility and highestAdjustedVolatility38
mainForceAccumulation = ta.ema(low <= lowestPrice38 ? (adjustedVolatility + highestAdjustedVolatility38 * 2) / 2 : 0, 3) / 618 * is90DayLow

// ============== KDJ CALCULATIONS ==============
// Calculate rsv21: RSV value for 21-day period
rsv21 = ((close - ta.lowest(low, 21)) / (ta.highest(high, 21) - ta.lowest(low, 21))) * 100

// Calculate smoothedRsv21: 13-day smoothed moving average of rsv21
smoothedRsv21 = ta.sma(rsv21, 13)

// Main Force Accumulation: Using mainForceAccumulation
mainForceAccumulationLine = mainForceAccumulation

// Calculate rsv: Unmatured random value, (close-n day lowest price)/(n day highest price-n day lowest price)×100
rsv = (close - ta.lowest(low, kdjPeriodN)) / (ta.highest(high, kdjPeriodN) - ta.lowest(low, kdjPeriodN)) * 100

// Calculate kLine: m1-day smoothed moving average of RSV
kLine = ta.sma(rsv, kdjM1)

// Calculate dLine: m2-day smoothed moving average of K line
dLine = ta.sma(kLine, kdjM2)

// Calculate jLine: 3×K-2×D, used to determine overbought/oversold
jLine = 3 * kLine - 2 * dLine

// ============== DYNAMIC COLOR CALCULATIONS ==============
// Calculate dynamic colors based on K, D, J values
kColor = showKColorMode ? (kLine > 50 ? colorKBullish : kLine < 20 ? colorKOversold : colorKBearish) : color.green
dColor = showDColorMode ? (dLine > 50 ? colorDOverbought : dLine < 20 ? colorDOversold : colorDNormal) : color.yellow
jColor = showJColorMode ? (jLine > 90 ? colorJOverbought : jLine < 10 ? colorJOversold : colorJNormal) : color.red

// ============== PLOTTING ==============
// Draw main force accumulation line in blue
plot(mainForceAccumulationLine, color=color.blue, title="Main Force Accumulation")

// When main force accumulation indicator is greater than 0, draw columns with purple color
plot(mainForceAccumulation > 0 ? mainForceAccumulation : na, style=plot.style_columns, color=color.new(colorMainForce, 70), title="Main Force Columns")

// Draw K line with dynamic color
plot(kLine, color=kColor, title="K Line")

// Draw D line with dynamic color
plot(dLine, color=dColor, title="D Line")

// Draw J line with dynamic color
plot(jLine, color=jColor, title="J Line")

// ============== SIGNAL DETECTION ==============
// Cross signals
crossoverSignal = ta.crossover(jLine, kLine)
crossunderSignal = ta.crossunder(jLine, kLine)

// Overbought/Oversold signals
overboughtSignal = ta.crossunder(jLine, 90)
oversoldSignal = ta.crossunder(jLine, 10)

// Main force entry signal
mainForceEntry = mainForceAccumulation > 0

// ============== LABELS ==============
// Buy signal: J crosses above K (Golden Cross)
if showBuyLabel and crossoverSignal
    label.new(bar_index, jLine, "Golden Cross", color=colorBuySignal, textcolor=color.white, style=label.style_label_up, size=size.normal)

// Sell signal: J crosses below K (Death Cross)
if showSellLabel and crossunderSignal
    label.new(bar_index, jLine, "Death Cross", color=colorSellSignal, textcolor=color.white, style=label.style_label_down, size=size.normal)

// Overbought warning
if showAlertLabels and overboughtSignal
    label.new(bar_index, jLine, "Overbought", color=color.red, textcolor=color.white, style=label.style_label_down, size=size.normal)

// Oversold warning
if showAlertLabels and oversoldSignal
    label.new(bar_index, jLine, "Oversold", color=color.blue, textcolor=color.white, style=label.style_label_up, size=size.normal)

// Main force entry signal - Displayed as columns
plot(mainForceEntry ? mainForceAccumulationLine * 15 : na, style=plot.style_columns, color=color.new(colorMainForce, 60), title="Main Force Entry")

// ============== ALERT CONDITIONS ==============
// Create alert condition for KDJ Crossover (Golden Cross/Death Cross)
alertcondition(crossoverSignal, title="KDJ Golden Cross", message="KDJ Golden Cross - Buy Signal\nK: {{k}}\nD: {{d}}\nJ: {{j}}")

alertcondition(crossunderSignal, title="KDJ Death Cross", message="KDJ Death Cross - Sell Signal\nK: {{k}}\nD: {{d}}\nJ: {{j}}")

// Create alert condition for Overbought
alertcondition(overboughtSignal, title="KDJ Overbought", message="KDJ Overbought - Warning Signal\nJ Value: {{j}}")

// Create alert condition for Oversold
alertcondition(oversoldSignal, title="KDJ Oversold", message="KDJ Oversold - Attention Signal\nJ Value: {{j}}")

// Create alert condition for Main Force Entry
alertcondition(mainForceEntry, title="Main Force Capital Entry", message="Main Force Capital Entry - Buy Signal\nMain Force Capital: {{mainForce}}")

// Trigger alerts when conditions are met
if alertOnCrossover and crossoverSignal
    alert("KDJ Golden Cross - Buy Signal", alert.freq_once_per_bar_close)

if alertOnCrossover and crossunderSignal
    alert("KDJ Death Cross - Sell Signal", alert.freq_once_per_bar_close)

if alertOnOverbought and overboughtSignal
    alert("KDJ Overbought - Warning Signal", alert.freq_once_per_bar_close)

if alertOnOversold and oversoldSignal
    alert("KDJ Oversold - Attention Signal", alert.freq_once_per_bar_close)

if alertOnMainForce and mainForceEntry
    alert("Main Force Capital Entry - Buy Signal", alert.freq_once_per_bar_close)

// ============== REFERENCE LINES ==============
// Set zero reference line to 0
zeroLine = 0

// Draw zero line in yellow dotted line
hline(zeroLine, "Zero Line", color=color.yellow, linestyle=hline.style_dotted)

// Set low reference line to -10
lowReferenceLine = -10

// Draw low line in yellow dotted line
hline(lowReferenceLine, "Low Reference Line", color=color.yellow, linestyle=hline.style_dotted)

// ============== INFORMATION PANEL ==============
// Create info panel to display current state
var table infoPanel = table.new(position.top_right, 3, 5, bgcolor=color.new(#1e1e1e, 0), border_width=1, border_color=color.gray)

if barstate.islast
    // Row 1: KDJ Status
    table.cell(infoPanel, 0, 0, "KDJ Status", text_color=color.white, bgcolor=color.new(#333333, 100))
    table.cell(infoPanel, 1, 0, str.tostring(kLine, "#.##"), text_color=kColor, bgcolor=color.new(#333333, 100))
    table.cell(infoPanel, 2, 0, str.tostring(dLine, "#.##"), text_color=dColor, bgcolor=color.new(#333333, 100))
    table.cell(infoPanel, 0, 1, "J Value", text_color=color.white, bgcolor=color.new(#333333, 100))
    table.cell(infoPanel, 1, 1, str.tostring(jLine, "#.##"), text_color=jColor, bgcolor=color.new(#333333, 100))
    table.cell(infoPanel, 2, 1, str.tostring(mainForceAccumulationLine, "#.##"), text_color=color.blue, bgcolor=color.new(#333333, 100))

    // Row 2: Signal Status
    table.cell(infoPanel, 0, 2, "Current Signal", text_color=color.white, bgcolor=color.new(#333333, 100))
    table.cell(infoPanel, 1, 2, crossoverSignal ? "Golden Cross" : crossunderSignal ? "Death Cross" : (overboughtSignal ? "Overbought" : oversoldSignal ? "Oversold" : "None"), text_color=crossoverSignal ? colorBuySignal : crossunderSignal ? colorSellSignal : overboughtSignal ? color.red : oversoldSignal ? color.blue : color.gray, bgcolor=color.new(#333333, 100))
    table.cell(infoPanel, 2, 2, mainForceEntry ? "Main Force Entry" : "-", text_color=mainForceEntry ? colorMainForce : color.gray, bgcolor=color.new(#333333, 100))

    // Row 3: KDJ Level
    table.cell(infoPanel, 0, 3, "KDJ Level", text_color=color.white, bgcolor=color.new(#333333, 100))
    table.cell(infoPanel, 1, 3, kLine > 80 ? "Overbought" : kLine < 20 ? "Oversold" : "Normal", text_color=kLine > 80 ? color.red : kLine < 20 ? color.blue : color.green, bgcolor=color.new(#333333, 100))
    table.cell(infoPanel, 2, 3, dLine > 80 ? "Overbought" : dLine < 20 ? "Oversold" : "Normal", text_color=dLine > 80 ? color.red : dLine < 20 ? color.blue : color.green, bgcolor=color.new(#333333, 100))

    // Row 4: Main Force
    table.cell(infoPanel, 0, 4, "Main Force Capital", text_color=color.white, bgcolor=color.new(#333333, 100))
    table.cell(infoPanel, 1, 4, mainForceAccumulation > 0 ? "Entering" : "-", text_color=mainForceAccumulation > 0 ? colorMainForce : color.gray, bgcolor=color.new(#333333, 100))
    table.cell(infoPanel, 2, 4, str.tostring(mainForceAccumulation, "#.##"), text_color=color.blue, bgcolor=color.new(#333333, 100))
