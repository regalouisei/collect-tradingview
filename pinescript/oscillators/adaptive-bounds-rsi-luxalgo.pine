// This work is licensed under a Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0) https://creativecommons.org/licenses/by-nc-sa/4.0/
// Â© LuxAlgo

//@version=6
indicator("Adaptive Bounds RSI [LuxAlgo]", "LuxAlgo - Adaptive Bounds RSI", overlay = false)

//---------------------------------------------------------------------------------------------------------------------}
// Constants
//---------------------------------------------------------------------------------------------------------------------{
color BULL_COLOR = #089981
color BEAR_COLOR = #f23645
color NEUT_COLOR = #787b86
color RSI_COLOR  = #7e57c2

//---------------------------------------------------------------------------------------------------------------------}
// Inputs
//---------------------------------------------------------------------------------------------------------------------{
int   rsiLenInput    = input.int(14, "RSI Length", minval = 1, group = "Oscillator Settings")
float alphaInput     = input.float(0.1, "Learning Rate (K-Means)", minval = 0.001, maxval = 1.0, step = 0.001, group = "K-Means Settings", tooltip = "Controls how quickly the centroids adapt to new RSI data.")

// Styling Inputs
color bullColorInput = input.color(BULL_COLOR, "Lower Bound Color (OS)", group = "Visuals")
color bearColorInput = input.color(BEAR_COLOR, "Upper Bound Color (OB)", group = "Visuals")
autoRsiColorInput = input.bool(true, "Auto RSI Color", group = "Visuals")
rsiColorInput     = input.color(RSI_COLOR, "RSI Color", group = "Visuals")

//---------------------------------------------------------------------------------------------------------------------}
// K-Means Logic
//---------------------------------------------------------------------------------------------------------------------{
// Calculate RSI
float rsiValue = ta.rsi(close, rsiLenInput)

// Initialize Centroids (representing Deep Discount, Bearish, Neutral, Bullish, Extreme Premium)
var float c1 = 20.0
var float c2 = 40.0
var float c3 = 50.0
var float c4 = 60.0
var float c5 = 80.0

// Online 1D K-Means Update
if not na(rsiValue)
    // Find closest centroid
    float d1 = math.abs(rsiValue - c1)
    float d2 = math.abs(rsiValue - c2)
    float d3 = math.abs(rsiValue - c3)
    float d4 = math.abs(rsiValue - c4)
    float d5 = math.abs(rsiValue - c5)
    
    float minDist = math.min(d1, d2, d3, d4, d5)
    
    // Update the winning centroid using manual linear interpolation
    if minDist == d1
        c1 += (rsiValue - c1) * alphaInput
    else if minDist == d2
        c2 += (rsiValue - c2) * alphaInput
    else if minDist == d3
        c3 += (rsiValue - c3) * alphaInput
    else if minDist == d4
        c4 += (rsiValue - c4) * alphaInput
    else
        c5 += (rsiValue - c5) * alphaInput

// Classification (Regime)
int regime = rsiValue <= c1 ? -2 : rsiValue <= c2 ? -1 : rsiValue <= c3 ? 0 : rsiValue <= c4 ? 1 : 2

// Regime Transitions for Alerts
bool regimeFlip = regime != regime[1] and regime[1] == 0

// Signal Logic (Crossings)
var bool canShowLower = true
var bool canShowUpper = true

// Reset logic: Allow another marker of the same style only if RSI crosses 50
if ta.cross(rsiValue, 50)
    canShowLower := true
    canShowUpper := true

bool lowerSignal = ta.crossunder(rsiValue, c1) and canShowLower
bool upperSignal = ta.crossover(rsiValue, c5) and canShowUpper

if lowerSignal
    canShowLower := false

if upperSignal
    canShowUpper := false

//---------------------------------------------------------------------------------------------------------------------}
// Plots & Visuals
//---------------------------------------------------------------------------------------------------------------------{
// Center Line
p_mid = plot(50, "Center Line", color = NEUT_COLOR, style = plot.style_linebr, display = display.none)
hline(50, "Reference Midline", color = color.new(NEUT_COLOR, 50), linestyle = hline.style_dotted)

// Adaptive Bounds (Centroids)
p_c5 = plot(c5, "Upper Bound (C5)", color = bearColorInput, style = plot.style_line, linewidth = 1)
p_c1 = plot(c1, "Lower Bound (C1)", color = bullColorInput, style = plot.style_line, linewidth = 1)

// RSI Plot
color rsiColor = autoRsiColorInput ? chart.fg_color : rsiColorInput
p_rsi = plot(rsiValue, "Adaptive RSI", color = rsiColor, linewidth = 1)

// Dot Markers on RSI
plot(lowerSignal ? rsiValue : na, "Lower Cross Marker", color = bullColorInput, style = plot.style_circles, linewidth = 2)
plot(upperSignal ? rsiValue : na, "Upper Cross Marker", color = bearColorInput, style = plot.style_circles, linewidth = 2)

// Vertical Gradient Fills from Bounds to 50
fill(p_c5, p_mid, c5, 50, color.new(bearColorInput, 85), color.new(bearColorInput, 100), "Upper Bound Gradient")
fill(p_mid, p_c1, 50, c1, color.new(bullColorInput, 100), color.new(bullColorInput, 85), "Lower Bound Gradient")

//---------------------------------------------------------------------------------------------------------------------}
// Alerts
//---------------------------------------------------------------------------------------------------------------------{
alertcondition(regimeFlip, "Regime Flip", "The market has transitioned from a Neutral state to a trending cluster.")
alertcondition(lowerSignal, "Lower Bound Cross", "RSI has crossed under the adaptive lower bound.")
alertcondition(upperSignal, "Upper Bound Cross", "RSI has crossed over the adaptive upper bound.")

//---------------------------------------------------------------------------------------------------------------------}
