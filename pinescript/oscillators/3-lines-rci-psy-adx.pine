//@version=6
indicator("3 Lines RCI + Psy + ADX (統合版)", overlay=false, max_lines_count=500)

//=== パラメータ ===//
rciShortLen = input.int(9, "RCI 短期")
rciMidLen   = input.int(26, "RCI 中期")
rciLongLen  = input.int(52, "RCI 長期")
psyLen      = input.int(12, "サイコロジカル期間")
psyOverbought = input.int(75, "サイコロジカル買われすぎ")
psyOversold   = input.int(25, "サイコロジカル売られすぎ")
rciOverHeat   = input.int(80, "RCI 過熱ライン")

// ADX パラメータ
adxLen = input.int(14, "ADX期間")
adxWeak = input.int(20, "ADX弱いトレンド閾値")
adxMid  = input.int(30, "ADX中間トレンド閾値")

//=== RCI 計算関数 ===//
rci(src, length) =>
    if bar_index < length
        na
    else
        arr = array.new_float(length, 0)
        for i = 0 to length - 1
            array.set(arr, i, src[i])
        ranks = array.new_float(length, 0)
        for i = 0 to length - 1
            rank = 1.0
            val_i = array.get(arr, i)
            for j = 0 to length - 1
                val_j = array.get(arr, j)
                if val_j > val_i
                    rank += 1
            array.set(ranks, i, rank)
        sum_d = 0.0
        for i = 0 to length - 1
            d = i - (array.get(ranks, i)-1)
            sum_d += d * d
        rci_val = 100 * (1 - 6 * sum_d / (length * (length*length -1)))
        math.max(-100, math.min(100, rci_val))

//=== RCI 計算 ===//
rciShort = rci(close, rciShortLen)
rciMid   = rci(close, rciMidLen)
rciLong  = rci(close, rciLongLen)

//=== サイコロジカル計算（修正版） ===//
psyCount = 0
for i = 1 to psyLen
    if close[i-1] > close[i]
        psyCount += 1
psy = 100.0 * psyCount / psyLen

// サイコロジカル棒グラフ
float psySignal = na
color psyColor = color.new(color.gray, 0)
if psy > psyOverbought
    psySignal := (psy - psyOverbought) / (100 - psyOverbought) * 100
    psyColor := color.new(color.red, 0)
else if psy < psyOversold
    psySignal := (psy - psyOversold) / psyOversold * 100
    psyColor := color.new(color.green, 0)
else
    psySignal := na

//=== RCIライン表示 ===//
plot(rciShort, "RCI 短期", color=color.new(color.red, 0))
plot(rciMid,   "RCI 中期", color=color.new(color.blue, 0))
plot(rciLong,  "RCI 長期", color=color.new(color.green, 0))

// 固定ゾーン表示（+80～+100 赤、-80～-100 緑）
topZoneLine1 = hline(rciOverHeat, "", color=color.new(color.red, 0))
topZoneLine2 = hline(100, "", color=color.new(color.red, 0))
fill(topZoneLine1, topZoneLine2, color=color.new(color.red, 80))

bottomZoneLine1 = hline(-rciOverHeat, "", color=color.new(color.green, 0))
bottomZoneLine2 = hline(-100, "", color=color.new(color.green, 0))
fill(bottomZoneLine1, bottomZoneLine2, color=color.new(color.green, 80))

// 過熱ライン
hline(rciOverHeat, "RCI +80ライン", color=color.red, linestyle=hline.style_dotted)
hline(-rciOverHeat, "RCI -80ライン", color=color.green, linestyle=hline.style_dotted)
hline(0, "ゼロライン", color=color.gray)

// サイコロジカル棒グラフ
plot(psySignal, "サイコロジカルシグナル", style=plot.style_columns, color=psyColor, linewidth=3)

//=== ADX計算 (DI+/DI-から算出) ===//
upMove = high - high[1]
downMove = low[1] - low
plusDM = (upMove > downMove and upMove > 0) ? upMove : 0
minusDM = (downMove > upMove and downMove > 0) ? downMove : 0

// True Range 計算
tr1 = high - low
tr2 = math.abs(high - close[1])
tr3 = math.abs(low - close[1])
tr = math.max(tr1, math.max(tr2, tr3))
smTR = ta.rma(tr, adxLen)

smPlusDM = ta.rma(plusDM, adxLen)
smMinusDM = ta.rma(minusDM, adxLen)

plusDI = 100 * smPlusDM / smTR
minusDI = 100 * smMinusDM / smTR

dx = 100 * math.abs(plusDI - minusDI) / (plusDI + minusDI)
adxVal = ta.rma(dx, adxLen)

// ADX段階色分け
adxColor = adxVal < adxWeak ? color.blue : adxVal < adxMid ? color.yellow : color.red

plot(adxVal, "ADX", color=adxColor, linewidth=2)
hline(adxMid, "中間閾値", color=color.gray, linestyle=hline.style_dotted)
