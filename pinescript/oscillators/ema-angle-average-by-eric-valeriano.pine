//@version=5
indicator("EMA Angle Average Trend", overlay=true)

// ===== INPUTS =====
emaLength      = input.int(50, "EMA Length", minval=1)
angleLookback  = input.int(10, "Angle Lookback Bars", minval=1)
angleAvgPeriod = input.int(5,  "Angle Average Bars", minval=1)

neutralDeg     = input.float(3.0, "Neutral Threshold ± Degrees", minval=0.0, step=0.1)
bgOpacity      = input.int(85, "Background Opacity 0–100", minval=0, maxval=100)

showEmaLine    = input.bool(true, "Show EMA")
showAnglePlots = input.bool(false, "Show Angle Plots")

// ===== EMA =====
emaValue = ta.ema(close, emaLength)

// ===== ANGLE + AVERAGE =====
emaDelta    = emaValue - emaValue[angleLookback]
emaAngleRad = math.atan(emaDelta / angleLookback)
emaAngleDeg = emaAngleRad * 180.0 / math.pi
avgEmaAngle = ta.sma(emaAngleDeg, angleAvgPeriod)

// ===== STATE =====
isBull = avgEmaAngle > neutralDeg
isBear = avgEmaAngle < -neutralDeg

string stateText = "Neutral"
if isBull
    stateText := "Bull"
else if isBear
    stateText := "Bear"

// ===== BACKGROUND COLOR =====
color bgCol = color.new(color.gray, bgOpacity)
if isBull
    bgCol := color.new(color.green, bgOpacity)
else if isBear
    bgCol := color.new(color.red, bgOpacity)
bgcolor(bgCol)

// ===== LABEL COLOR =====
color labelBg = color.new(color.gray, 65)
if isBull
    labelBg := color.new(color.green, 65)
else if isBear
    labelBg := color.new(color.red, 65)

// ===== EMA PLOT =====
plot(showEmaLine ? emaValue : na, "EMA", color=color.aqua, linewidth=2)

// ===== LABEL ATTACHED TO EMA (STABLE) =====
var label stateLabel = na

if barstate.islast
    if na(stateLabel)
        stateLabel := label.new(bar_index, emaValue, stateText, xloc.bar_index, yloc.price, labelBg, label.style_label_left, color.white, size.normal)
    else
        label.set_xy(stateLabel, bar_index, emaValue)
        label.set_text(stateLabel, stateText)
        label.set_color(stateLabel, labelBg)
        label.set_textcolor(stateLabel, color.white)
        label.set_style(stateLabel, label.style_label_left)

// ===== OPTIONAL ANGLE PLOTS =====
plot(showAnglePlots ? emaAngleDeg : na, "EMA Angle Raw", color=color.gray)
plot(showAnglePlots ? avgEmaAngle : na, "EMA Angle Averaged", color=color.orange, linewidth=2)
hline(showAnglePlots ? 0 : na)
hline(showAnglePlots ? neutralDeg : na)
hline(showAnglePlots ? -neutralDeg : na)
