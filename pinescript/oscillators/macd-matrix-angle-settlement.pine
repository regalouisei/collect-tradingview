//@version=5
indicator("MACD Matrix: Angle & Settlement (Auto-Formatted)", overlay=true)

// --- CONFIGURATION ---
// Default values matching your setup
tf1_in = input.timeframe("3", "TF-2")
tf2_in = input.timeframe("15", "TF-1")
tf3_in = input.timeframe("60", "TF (Trend)")
tf4_in = input.timeframe("240", "TF+1")
tf5_in = input.timeframe("960", "TF+2")

fastLen = input.int(12, "Fast Len")
slowLen = input.int(26, "Slow Len")
sigLen  = input.int(9, "Signal Len")
angle_mult = input.float(1.0, "Angle Sensitivity", step=0.1)

// --- HELPER: FORMAT TIMEFRAME STRING ---
// Converts "60" -> "1h", "240" -> "4h", "D" -> "1D"
f_format_tf(_tf) =>
    // If it contains "D", "W", "M" (Daily/Weekly/Monthly), return as is
    if str.contains(_tf, "D") or str.contains(_tf, "W") or str.contains(_tf, "M")
        _tf
    else
        // It's minutes. Convert to int.
        min_val = str.tonumber(_tf)
        if na(min_val)
            _tf // Fallback if something weird happens
        else if min_val >= 60 and min_val % 60 == 0
            // If strictly divisible by 60, show as Hours
            str.tostring(min_val / 60) + "h"
        else
            // Otherwise show as Minutes
            str.tostring(min_val) + "m"

// --- 1. CORE CALCULATION ---
f_calc_data() =>
    fast = ta.ema(close, fastLen)
    slow = ta.ema(close, slowLen)
    mLine = fast - slow
    sLine = ta.ema(mLine, sigLen)
    
    change = mLine - mLine[1]
    angle_rad = math.atan(change * angle_mult)
    angle_deg = angle_rad * (180 / math.pi)
    
    prev_change = mLine[1] - mLine[2]
    prev_angle_rad = math.atan(prev_change * angle_mult)
    prev_angle_deg = prev_angle_rad * (180 / math.pi)

    [mLine, sLine, angle_deg, prev_angle_deg]

// --- 2. PROCESS DATA ---
f_process_tf(_tf) =>
    [m, s, ang, p_ang] = request.security(syminfo.tickerid, _tf, f_calc_data())
    
    is_pos = m > 0
    is_pco = m > s
    
    status_txt = "Flat"
    status_col = color.gray
    
    if math.abs(ang) > math.abs(p_ang)
        status_txt := "STEEP"
        status_col := ang > 0 ? color.green : color.red
    else
        status_txt := "SETTLE"
        status_col := ang > 0 ? color.new(color.green, 40) : color.new(color.red, 40)
            
    [is_pos, is_pco, ang, status_txt, status_col]

// --- 3. DRAW ROW ---
f_fill_row(_tbl, _r, _tf_raw, _pos, _pco, _ang, _stat, _col) =>
    // Format the name using our helper function
    tf_label = f_format_tf(_tf_raw)
    
    table.cell(_tbl, 0, _r, tf_label, text_color=color.white)
    table.cell(_tbl, 1, _r, _pos ? "> 0" : "< 0", text_color=_pos ? color.green : color.red)
    table.cell(_tbl, 2, _r, _pco ? "PCO" : "NCO", text_color=_pco ? color.green : color.red)
    
    ang_str = (_ang > 0 ? "+" : "") + str.tostring(math.round(_ang, 1)) + "°"
    table.cell(_tbl, 3, _r, ang_str, text_color=color.yellow)
    table.cell(_tbl, 4, _r, _stat, text_color=color.white, bgcolor=_col)

// --- EXECUTE ---
[t1_pos, t1_pco, t1_ang, t1_stat, t1_col] = f_process_tf(tf1_in)
[t2_pos, t2_pco, t2_ang, t2_stat, t2_col] = f_process_tf(tf2_in)
[t3_pos, t3_pco, t3_ang, t3_stat, t3_col] = f_process_tf(tf3_in)
[t4_pos, t4_pco, t4_ang, t4_stat, t4_col] = f_process_tf(tf4_in)
[t5_pos, t5_pco, t5_ang, t5_stat, t5_col] = f_process_tf(tf5_in)

// --- DRAW TABLE ---
var tbl = table.new(position.top_right, 5, 6, border_width=1, frame_color=color.gray, bgcolor=color.black)

if barstate.islast
    // Headers
    table.cell(tbl, 0, 0, "TF", text_color=color.white, bgcolor=color.new(color.gray, 20))
    table.cell(tbl, 1, 0, "Zone", text_color=color.white, bgcolor=color.new(color.gray, 20))
    table.cell(tbl, 2, 0, "Cross", text_color=color.white, bgcolor=color.new(color.gray, 20))
    table.cell(tbl, 3, 0, "Deg (°)", text_color=color.yellow, bgcolor=color.new(color.gray, 20))
    table.cell(tbl, 4, 0, "State", text_color=color.white, bgcolor=color.new(color.gray, 20))

    // Fill Rows
    f_fill_row(tbl, 1, tf1_in, t1_pos, t1_pco, t1_ang, t1_stat, t1_col)
    f_fill_row(tbl, 2, tf2_in, t2_pos, t2_pco, t2_ang, t2_stat, t2_col)
    f_fill_row(tbl, 3, tf3_in, t3_pos, t3_pco, t3_ang, t3_stat, t3_col)
    f_fill_row(tbl, 4, tf4_in, t4_pos, t4_pco, t4_ang, t4_stat, t4_col)
    f_fill_row(tbl, 5, tf5_in, t5_pos, t5_pco, t5_ang, t5_stat, t5_col)
