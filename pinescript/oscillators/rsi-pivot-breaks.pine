// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0
// © Uncle_the_shooter

//@version=6
indicator('RSI Pivot Breaks', overlay=false, max_lines_count=500, max_bars_back=1000)

// INPUTS
rsiLength = input.int(14, 'RSI Length')
maLen     = input.int(14, 'RSI MA Length')
maType    = input.string('EMA', 'RSI MA Type', options=['SMA','EMA','RMA','WMA'])

// OB / OS LINES
obLine = input.int(70, 'OB Line Level')
osLine = input.int(30, 'OS Line Level')

// PIVOT LENGTH
left  = input.int(5, 'Pivot Left', minval=1)
right = input.int(5, 'Pivot Right', minval=1)

// NEW FILTERS FOR PIVOTS 
// Pivot High
hiFilterMin = input.int(0, 'Pivot High Min Level')
hiFilterMax = input.int(60, 'Pivot High Max Level')

// Pivot Low
loFilterMin = input.int(40, 'Pivot Low Min Level')
loFilterMax = input.int(100, 'Pivot Low Max Level')

// PIVOT SOURCE
pivotSourceOpt = input.string('RSI', 'Pivot Source', options=['RSI','MA RSI'])

// INPUTS – toggle visualization
showRsiSignal = input.bool(true, 'Show RSI Signal')
showMaRsi     = input.bool(true, 'Show MA RSI')

// GRADIENTS
useGradient = input.bool(true, 'Gradient')
gradTransp  = input.int(80, 'Gradient Transparency', minval=0, maxval=100)

// HIGHLIGHT COLORS
bullishColor = input.color(color.new(color.green, 70), 'Bullish Highlight Color')
bearishColor = input.color(color.new(color.red, 70), 'Bearish Highlight Color')

// COLORS – OTHER (GROUP "Colors")
rsiBullCol = input.color(color.rgb(6, 162, 47), 'RSI Bull Color', group = 'Colors')
rsiBearCol = input.color(color.rgb(207, 23, 23), 'RSI Bear Color', group = 'Colors')
maColor    = input.color(color.rgb(192, 204, 22), 'RSI MA Color', group = 'Colors')
obColor    = input.color(color.rgb(207, 23, 23), 'OB Line Color', group = 'Colors')
osColor    = input.color(color.rgb(6, 162, 47), 'OS Line Color', group = 'Colors')
midColor   = input.color(#676b7a, 'Mid Line Color', group = 'Colors')

maxLines = 500

// RSI + MA 
rsi = ta.rsi(close, rsiLength)

maRsi = switch maType
    'SMA' => ta.sma(rsi, maLen)
    'EMA' => ta.ema(rsi, maLen)
    'RMA' => ta.rma(rsi, maLen)
    'WMA' => ta.wma(rsi, maLen)

pivotSrc = pivotSourceOpt == 'MA RSI' ? maRsi : rsi

// DYNAMIC COLORS
rsiBaseCol = showRsiSignal ? (rsi >= 50 ? rsiBullCol : rsiBearCol) : na
maPlotCol  = showMaRsi ? maColor : na

// PLOTS 
plot(rsi, 'RSI', color = rsiBaseCol, linewidth = 2)
plot(rsi, color = showRsiSignal ? color.new(rsiBaseCol, 70) : na, linewidth = 5)
plot(rsi, color = showRsiSignal ? color.new(rsiBaseCol, 80) : na, linewidth = 8)

plot(maRsi, 'RSI MA', color = maPlotCol, linewidth = 2)

// OB / OS / MID LINES
p_ob = plot(obLine, 'OB', color = obColor, linewidth = 1)
p_os = plot(osLine, 'OS', color = osColor, linewidth = 1)

p_mid = plot(50, display = display.none)
hline(50, 'MID', color = midColor, linestyle = hline.style_dashed, linewidth = 1)

// ARRAYS 
var array<line>  hiLines = array.new_line()
var array<float> hiLvl   = array.new_float()
var array<bool>  hiLive  = array.new_bool()

var array<line>  loLines = array.new_line()
var array<float> loLvl   = array.new_float()
var array<bool>  loLive  = array.new_bool()

// PIVOTS
ph = ta.pivothigh(pivotSrc, left, right)
pl = ta.pivotlow(pivotSrc, left, right)

// CREATE HIGH LINES (filtered by hiFilterMin / hiFilterMax)
if not na(ph) and ph >= hiFilterMin and ph <= hiFilterMax
    int x = bar_index - right
    l = line.new(x, ph, x + 1, ph, extend = extend.right, color = obColor, width = 2)
    array.push(hiLines, l)
    array.push(hiLvl, ph)
    array.push(hiLive, true)

// CREATE LOW LINES (filtered by loFilterMin / loFilterMax) 
if not na(pl) and pl >= loFilterMin and pl <= loFilterMax
    int x = bar_index - right
    l = line.new(x, pl, x + 1, pl, extend = extend.right, color = osColor, width = 2)
    array.push(loLines, l)
    array.push(loLvl, pl)
    array.push(loLive, true)

// RING BUFFER (cleanup)
while array.size(hiLines) > maxLines
    line.delete(array.shift(hiLines))
    array.shift(hiLvl)
    array.shift(hiLive)

while array.size(loLines) > maxLines
    line.delete(array.shift(loLines))
    array.shift(loLvl)
    array.shift(loLive)

// BREAK LOGIC + HIGHLIGHT
bool highlightBull = false
bool highlightBear = false

int hc = array.size(hiLines)
if hc > 0
    for j = 0 to hc - 1
        int i = hc - 1 - j
        if array.get(hiLive, i)
            float lvl = array.get(hiLvl, i)
            line ln = array.get(hiLines, i)
            if pivotSrc > lvl
                line.set_x2(ln, bar_index)
                line.set_extend(ln, extend.none)
                array.set(hiLive, i, false)
                highlightBull := true

int lc = array.size(loLines)
if lc > 0
    for j = 0 to lc - 1
        int i = lc - 1 - j
        if array.get(loLive, i)
            float lvl = array.get(loLvl, i)
            line ln = array.get(loLines, i)
            if pivotSrc < lvl
                line.set_x2(ln, bar_index)
                line.set_extend(ln, extend.none)
                array.set(loLive, i, false)
                highlightBear := true

bgcolor(highlightBull ? bullishColor : na)
bgcolor(highlightBear ? bearishColor : na)

// GRADIENT AREAS 
p_top = plot(100, display = display.none)
p_bot = plot(0,   display = display.none)

gradObColor = color.new(obColor, gradTransp)
gradOsColor = color.new(osColor, gradTransp)
transpWhite = color.new(color.white, 100)

// OB area
fill(p_ob, p_top, useGradient ? obLine : na, useGradient ? 100 : na, gradObColor, transpWhite)
fill(p_top, p_ob, useGradient ? 100 : na, useGradient ? obLine : na, transpWhite, gradObColor)

// OS area
fill(p_os, p_bot, useGradient ? osLine : na, useGradient ? 0 : na, gradOsColor, transpWhite)
fill(p_bot, p_os, useGradient ? 0 : na, useGradient ? osLine : na, transpWhite, gradOsColor)

// MID
grayStrong = color.new(midColor, 85)
grayWeak   = color.new(midColor, 100)

fill(p_os, p_mid, useGradient ? osLine : na, useGradient ? 50 : na, grayStrong, grayWeak)
fill(p_mid, p_os, useGradient ? 50 : na, useGradient ? osLine : na, grayWeak, grayStrong)

fill(p_mid, p_ob, useGradient ? 50 : na, useGradient ? obLine : na, grayWeak, grayStrong)
fill(p_ob, p_mid, useGradient ? obLine : na, useGradient ? 50 : na, grayStrong, grayWeak)

// ALERTS 
// Bullish pivot break
if highlightBull
    alert('RSI (' + pivotSourceOpt + ') broke above pivot high', alert.freq_once_per_bar_close)

// Bearish pivot break
if highlightBear
    alert('RSI (' + pivotSourceOpt + ') broke below pivot low', alert.freq_once_per_bar_close)

// RSI crossing OB/OS
if ta.crossover(pivotSrc, obLine)
    alert('RSI (' + pivotSourceOpt + ') crossed above OB', alert.freq_once_per_bar_close)

if ta.crossunder(pivotSrc, osLine)
    alert('RSI (' + pivotSourceOpt + ') crossed below OS', alert.freq_once_per_bar_close)
