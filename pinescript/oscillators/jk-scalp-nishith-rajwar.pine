//@version=6
indicator("JK Scalp - Nishith Rajwar", overlay=false, shorttitle="JK Scalp [NR]", max_lines_count=500, max_labels_count=500, max_boxes_count=500)
// -----------------------------------------------------------------------------

// -----------------------------------------------------------------------------

// Inputs: Stochastic Settings
// -----------------------------------------------------------------------------
grp_stoch = "Stochastic Parameters"
fast_len  = input.int(9,  "Fast (9,3) Length",  group=grp_stoch)
fast_sm   = input.int(3,  "Fast Smoothing",     group=grp_stoch)
med_len   = input.int(14, "Medium (14,3) Length", group=grp_stoch)
med_sm    = input.int(3,  "Medium Smoothing",   group=grp_stoch)
slow_len  = input.int(44, "Slow (44,3) Length", group=grp_stoch)
slow_sm   = input.int(3,  "Slow Smoothing",     group=grp_stoch)
trend_len = input.int(60, "Trend (60,10,10) Length", group=grp_stoch)
trend_smK = input.int(10, "Trend Smooth K",     group=grp_stoch)
trend_smD = input.int(10, "Trend Smooth D",     group=grp_stoch)
// -----------------------------------------------------------------------------
// Inputs: Trade Logic
// -----------------------------------------------------------------------------
grp_logic  = "Logic & Filters"
use_div    = input.bool(true, "Detect Divergences", group=grp_logic)
use_flag   = input.bool(true, "Detect Flags",       group=grp_logic)
div_look   = input.int(5,     "Divergence Lookback", group=grp_logic, tooltip="Pivot lookback period")
risk_mult  = input.float(1.5, "ATR SL Multiplier",  group=grp_logic)
atr_len    = input.int(14,    "ATR Length",         group=grp_logic)
// -----------------------------------------------------------------------------
// Inputs: Visuals - Oscillator Pane
// -----------------------------------------------------------------------------
grp_vis_osc = "Visuals (Oscillator Pane)"
c_bg_top    = input.color(color.new(#ff5252, 90), "OB Zone Fill", group=grp_vis_osc)
c_bg_bot    = input.color(color.new(#4caf50, 90), "OS Zone Fill", group=grp_vis_osc)
// Fast Line
c_fast      = input.color(#ffd600, "Fast Line Color", group=grp_vis_osc)
w_fast      = input.int(2, "Fast Width", group=grp_vis_osc)
// Medium Line
c_med       = input.color(#ff9800, "Medium Line Color", group=grp_vis_osc)
w_med       = input.int(1, "Medium Width", group=grp_vis_osc)
// Slow Line
c_slow      = input.color(#00bcd4, "Slow Line Color", group=grp_vis_osc)
w_slow      = input.int(1, "Slow Width", group=grp_vis_osc)
// Trend Line
c_trend     = input.color(#ffffff, "Trend Line Color", group=grp_vis_osc)
w_trend     = input.int(3, "Trend Width", group=grp_vis_osc)
show_glow   = input.bool(true, "Enable Line Glows", group=grp_vis_osc)
// -----------------------------------------------------------------------------
// Inputs: Visuals - Chart Overlay
// -----------------------------------------------------------------------------
grp_vis_main = "Visuals (Main Chart)"
show_signals = input.bool(true, "Show Entry Signals", group=grp_vis_main)
c_long       = input.color(#00e676, "Long Color", group=grp_vis_main)
c_short      = input.color(#ff1744, "Short Color", group=grp_vis_main)
show_super   = input.bool(true, "Show Super Signals", group=grp_vis_main)
show_divs    = input.bool(true, "Show Divergence Lines", group=grp_vis_main)
show_sl      = input.bool(true, "Show Risk Zones (SL)", group=grp_vis_main)
// =============================================================================
// CALCULATIONS
// =============================================================================
// --- Stochastics ---
calc_stoch(len, sm) =>
    k = ta.stoch(close, high, low, len)
    d = ta.sma(k, sm)
    d
// Fast (9,3)
fast_k = ta.stoch(close, high, low, fast_len)
fast   = ta.sma(fast_k, fast_sm)
// Medium (14,3)
med    = calc_stoch(med_len, med_sm)
// Slow (44,3)
slow   = calc_stoch(slow_len, slow_sm)
// Trend (60,10,10) - Full Stoch
trend_k = ta.stoch(close, high, low, trend_len)
trend_d = ta.sma(trend_k, trend_smK)
trend   = ta.sma(trend_d, trend_smD)
// Levels
ob_lvl = 80
os_lvl = 20
mid_lvl = 50
// --- Quad Rotation ---
// Bullish: All rising, Trend supporting, exiting OS
bull_rot = fast > fast[1] and med > med[1] and slow > slow[1] and trend > trend[1] and
           (trend > mid_lvl or trend > trend[1]) and fast[1] <= os_lvl + 10
// Bearish: All falling, Trend supporting, exiting OB
bear_rot = fast < fast[1] and med < med[1] and slow < slow[1] and trend < trend[1] and
           (trend < mid_lvl or trend < trend[1]) and fast[1] >= ob_lvl - 10
// --- Divergences (Fast Stoch vs Price) ---
var float bull_piv_price = na
var float bull_piv_stoch = na
var float bear_piv_price = na
var float bear_piv_stoch = na
bull_div = false
bear_div = false
if use_div
    // Bullish
    lo_piv = ta.pivotlow(low, div_look, div_look)
    if not na(lo_piv)
        bull_piv_price := lo_piv
        bull_piv_stoch := fast[div_look] // aligned with pivot
    
    // Check div: Current Price < Pivot Price AND Current Stoch > Pivot Stoch
    // Plus rotation context: Fast turned up
    if low < bull_piv_price and fast > bull_piv_stoch and fast < os_lvl + 15 and fast > fast[1]
        bull_div := true
    // Bearish
    hi_piv = ta.pivothigh(high, div_look, div_look)
    if not na(hi_piv)
        bear_piv_price := hi_piv
        bear_piv_stoch := fast[div_look]
    
    if high > bear_piv_price and fast < bear_piv_stoch and fast > ob_lvl - 15 and fast < fast[1]
        bear_div := true
// --- Flags ---
bull_flag = false
bear_flag = false
if use_flag
    // Bull Flag: Trend strong (>80), Fast dipped and turning up
    bull_flag := trend > ob_lvl and trend[1] > ob_lvl and fast[1] <= os_lvl + 25 and fast > fast[1]
    
    // Bear Flag: Trend weak (<20), Fast popped and turning down
    bear_flag := trend < os_lvl and trend[1] < os_lvl and fast[1] >= ob_lvl - 25 and fast < fast[1]
// --- Super Signals ---
// Combine Rotation + Divergence
super_long  = bull_rot and bull_div
super_short = bear_rot and bear_div
// --- Final Entry Conditions ---
// Rotation + (Div OR Flag)
go_long  = bull_rot and (bull_div or bull_flag) and fast > fast[1]
go_short = bear_rot and (bear_div or bear_flag) and fast < fast[1]
// --- Risk Management (SL) ---
// Use Swing High/Low or ATR
atr_val = ta.atr(atr_len)
lo_swing = ta.lowest(low, 10)[1]
hi_swing = ta.highest(high, 10)[1]
long_sl = risk_mult > 0 ? math.min(lo_swing, close - risk_mult * atr_val) : lo_swing
short_sl = risk_mult > 0 ? math.max(hi_swing, close + risk_mult * atr_val) : hi_swing
// =============================================================================
// VISUALS: OSCILLATOR PANE
// =============================================================================
// 1. Dynamic Background Zones
h_ob = hline(ob_lvl, "OB", color.new(color.gray, 50), linestyle=hline.style_dotted)
h_os = hline(os_lvl, "OS", color.new(color.gray, 50), linestyle=hline.style_dotted)
h_mid = hline(mid_lvl, "Mid", color.new(color.gray, 80), linestyle=hline.style_dotted)
fill(h_ob, hline(100), title="OB Fill", color=c_bg_top)
fill(h_os, hline(0), title="OS Fill", color=c_bg_bot)
// 2. Plot Stochastics with Glow Effect
// Fast color shifts based on momentum
col_fast_dyn = fast > fast[1] ? #ffd600 : #f57f17 // Bright Yellow -> Darker Yellow
// Explicitly unrolled plots (fixing "plot in local scope" error)
plot(show_glow ? fast : na, "Fast Glow Outer", color=color.new(col_fast_dyn, 80), linewidth=w_fast + 4)
plot(show_glow ? fast : na, "Fast Glow Inner", color=color.new(col_fast_dyn, 60), linewidth=w_fast + 2)
plot(fast,  "Fast (9)",  col_fast_dyn, w_fast)
plot(show_glow ? med : na, "Med Glow Outer", color=color.new(c_med, 80), linewidth=w_med + 4)
plot(show_glow ? med : na, "Med Glow Inner", color=color.new(c_med, 60), linewidth=w_med + 2)
plot(med,   "Medium (14)", c_med,        w_med)
plot(show_glow ? slow : na, "Slow Glow Outer", color=color.new(c_slow, 80), linewidth=w_slow + 4)
plot(show_glow ? slow : na, "Slow Glow Inner", color=color.new(c_slow, 60), linewidth=w_slow + 2)
plot(slow,  "Slow (44)",   c_slow,       w_slow)
plot(show_glow ? trend : na, "Trend Glow Outer", color=color.new(c_trend, 80), linewidth=w_trend + 4)
plot(show_glow ? trend : na, "Trend Glow Inner", color=color.new(c_trend, 60), linewidth=w_trend + 2)
plot(trend, "Trend (60)",  c_trend,      w_trend)
// 3. Optional Cloud between Fast and Trend
fill(plot(fast, display=display.none), plot(trend, display=display.none), 
     color = fast > trend ? color.new(c_long, 90) : color.new(c_short, 90), title="Trend Cloud")
// =============================================================================
// VISUALS: MAIN CHART (Force Overlay)
// =============================================================================
// Explicitly unrolled plotshapes (fixing "plotshape in local scope" error)
// Long
plotshape(show_signals and go_long, "Long Aura", shape.circle, location.belowbar, 
          color=color.new(c_long, 85), size=size.normal, force_overlay=true)
plotshape(show_signals and go_long, "Long Diamond", shape.diamond, location.belowbar,
          color=color.new(c_long, 30), size=size.small, force_overlay=true)
plotshape(show_signals and go_long, "Long Core", shape.triangleup, location.belowbar,
          color=c_long, size=size.tiny, force_overlay=true)
// Short
plotshape(show_signals and go_short, "Short Aura", shape.circle, location.abovebar, 
          color=color.new(c_short, 85), size=size.normal, force_overlay=true)
plotshape(show_signals and go_short, "Short Diamond", shape.diamond, location.abovebar,
          color=color.new(c_short, 30), size=size.small, force_overlay=true)
plotshape(show_signals and go_short, "Short Core", shape.triangledown, location.abovebar,
          color=c_short, size=size.tiny, force_overlay=true)
// Super Signals
if show_super and super_long
    label.new(bar_index, low, "SUPER LONG", xloc=xloc.bar_index, yloc=yloc.belowbar, 
              color=color.new(c_long, 10), style=label.style_label_up, textcolor=color.white, 
              force_overlay=true, size=size.normal)
    
if show_super and super_short
    label.new(bar_index, high, "SUPER SHORT", xloc=xloc.bar_index, yloc=yloc.abovebar, 
              color=color.new(c_short, 10), style=label.style_label_down, textcolor=color.white, 
              force_overlay=true, size=size.normal)
// Divergence Lines (On Chart)
if show_divs and bull_div
    // Line connecting pivot to current
    l = line.new(bar_index[div_look], bull_piv_price, bar_index, low, 
             color=color.new(c_long, 30), width=2, style=line.style_solid, force_overlay=true)
    label.new(bar_index, low, "Div", color=color.new(c_long, 100), textcolor=c_long, 
              style=label.style_none, yloc=yloc.belowbar, force_overlay=true)
if show_divs and bear_div
    l = line.new(bar_index[div_look], bear_piv_price, bar_index, high, 
             color=color.new(c_short, 30), width=2, style=line.style_solid, force_overlay=true)
    label.new(bar_index, high, "Div", color=color.new(c_short, 100), textcolor=c_short, 
              style=label.style_none, yloc=yloc.abovebar, force_overlay=true)
// SL Risk Zones (Visualized on Signal)
if show_sl and (go_long or go_short)
    // Draw limit lines
    sl_price = go_long ? long_sl : short_sl
    
    l_sl = line.new(bar_index, sl_price, bar_index + 10, sl_price, 
             color=color.new(color.red, 40), style=line.style_dashed, width=1, force_overlay=true)
    
    // Optional: Box fill from entry to SL
    // entry = close. We can draw a small box to show risk magnitude
    b_risk = box.new(bar_index, close, bar_index + 5, sl_price, 
             border_color=color.new(color.gray, 100), bgcolor=color.new(color.red, 90), force_overlay=true)
// =============================================================================
// DASHBOARD
// =============================================================================
// Simple status tracking
var table tbl = table.new(position.top_right, 2, 2, bgcolor=color.new(color.black, 50), frame_color=color.gray, frame_width=1)
if barstate.islast
    status_txt = "NEUTRAL"
    status_col = color.gray
    
    if bull_rot
        status_txt := "BULLISH QUAD"
        status_col := c_long
    else if bear_rot
        status_txt := "BEARISH QUAD"
        status_col := c_short
    
    table.cell(tbl, 0, 0, "Rotation", text_color=color.white, text_size=size.small)
    table.cell(tbl, 1, 0, status_txt, text_color=status_col, text_size=size.small, bgcolor=color.new(status_col, 90))
