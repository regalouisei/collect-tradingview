//@version=5
indicator("DF Advanced Sector & RS Analysis", overlay=true)

// ==========================================
// 1. INPUTS & SETTINGS
// ==========================================
table_pos = input.string("Bottom Left", "Table Position", options=["Top Right", "Bottom Right", "Top Left", "Bottom Left"])
text_size = input.string("Small", "Text Size", options=["Tiny", "Small", "Normal", "Large"])
fin_mode  = input.string("TTM", "Financials Mode", options=["TTM", "Quarterly"], tooltip="TTM = Trailing 12 Months (Smoother)\nQuarterly = Most Recent Quarter vs Same Quarter Last Year (Volatile)")

// Colors
col_header = #1e3a8a 
col_label  = #2a2e39 
col_green  = #26a69a 
col_blue   = #2962ff 
col_red    = #ef5350 
col_grey   = #787b86 
col_text   = color.white

// Map Position
t_pos = table_pos == "Top Right" ? position.top_right : table_pos == "Bottom Right" ? position.bottom_right : table_pos == "Top Left" ? position.top_left : position.bottom_left
t_size = text_size == "Tiny" ? size.tiny : text_size == "Small" ? size.small : text_size == "Normal" ? size.normal : size.large

// ==========================================
// 2. CALCULATIONS
// ==========================================

// --- A. ASSET DETECTION & BENCHMARK ---
is_crypto = syminfo.type == "crypto"
is_forex  = syminfo.type == "forex"
is_stock  = syminfo.type == "stock" or syminfo.type == "fund" or syminfo.type == "dr"
is_inverse_usd = is_forex and str.endswith(syminfo.ticker, "USD") 

var string benchmark_ticker = "SPY" 
var string benchmark_label = "SPY"

if is_crypto
    benchmark_ticker := "BTCUSD"
    benchmark_label := "BTC"
else if is_forex
    benchmark_ticker := "TVC:DXY"
    benchmark_label := "DXY"
else 
    benchmark_ticker := "SPY"
    benchmark_label := "SPY"

// --- B. SECTOR LOGIC ---
var string sector_ticker = "SPY" 
var string sector_name_display = "Market"
curr_sector = syminfo.sector

if is_crypto
    sector_ticker := "CRYPTOCAP:TOTAL"
    sector_name_display := "Crypto Mkt"
else if is_forex
    sector_ticker := "TVC:DXY"
    sector_name_display := "USD Index"
else
    if curr_sector == "Energy"
        sector_ticker := "XLE"
        sector_name_display := "Energy (XLE)"
    else if curr_sector == "Finance"
        sector_ticker := "XLF"
        sector_name_display := "Finance (XLF)"
    else if curr_sector == "Technology" or curr_sector == "Electronic Technology" or curr_sector == "Technology Services"
        sector_ticker := "XLK"
        sector_name_display := "Tech (XLK)"
    else if curr_sector == "Health Services" or curr_sector == "Health Technology"
        sector_ticker := "XLV"
        sector_name_display := "Health (XLV)"
    else if curr_sector == "Consumer Non-Durables"
        sector_ticker := "XLP"
        sector_name_display := "Staples (XLP)"
    else if curr_sector == "Consumer Durables" or curr_sector == "Retail Trade" or curr_sector == "Distribution Services"
        sector_ticker := "XLY"
        sector_name_display := "Discret. (XLY)"
    else if curr_sector == "Utilities"
        sector_ticker := "XLU"
        sector_name_display := "Utilities (XLU)"
    else if curr_sector == "Process Industries" or curr_sector == "Non-Energy Minerals" or curr_sector == "Producer Manufacturing"
        sector_ticker := "XLB"
        sector_name_display := "Materials (XLB)"
    else if curr_sector == "Industrial Services" or curr_sector == "Transportation"
        sector_ticker := "XLI"
        sector_name_display := "Industrials (XLI)"
    else if curr_sector == "Commercial Services" or curr_sector == "Communications"
        sector_ticker := "XLC"
        sector_name_display := "Comm. (XLC)"
    else
        sector_ticker := "SPY"
        sector_name_display := "Market (SPY)"

// --- C. EARNINGS & VOLUME ---
next_earnings_time = is_stock ? earnings.future_time : na
days_to_er = not na(next_earnings_time) ? (next_earnings_time - timenow) / 86400000 : na

er_txt = "N/A"
if not na(days_to_er)
    days_rounded = math.round(days_to_er)
    er_txt := days_rounded >= 0 ? str.tostring(days_rounded) + "d" : "0d"

avg_vol = ta.sma(volume, 50)
vol_txt = avg_vol >= 1000000 ? str.tostring(avg_vol / 1000000, "#.1") + "M" : 
          avg_vol >= 1000 ? str.tostring(avg_vol / 1000, "#.0") + "K" : 
          str.tostring(avg_vol)

er_bg_color = (not na(days_to_er) and days_to_er <= 5 and days_to_er > -2) ? col_red : col_label

// --- D. RS RATING & ALPHA ---
base = request.security(benchmark_ticker, "D", close, ignore_invalid_symbol=true)
rs_score = ta.rsi(close / base, 14) 
rs_val = math.round(rs_score)
rs_col = rs_val > 70 ? col_green : rs_val < 40 ? col_red : col_label

roc_stock = ta.roc(close, 20)
roc_bench = request.security(benchmark_ticker, "D", ta.roc(close, 20), ignore_invalid_symbol=true)
alpha     = roc_stock - roc_bench
alpha_txt = (alpha > 0 ? "+" : "") + str.tostring(alpha, "#.0") + "%"
alpha_col = alpha > 0 ? col_green : col_red

// --- E. SECTOR COMPARISON ---
roc_sector = request.security(sector_ticker, "D", ta.roc(close, 20), ignore_invalid_symbol=true)
sec_perf   = roc_stock - roc_sector 
sec_txt    = (sec_perf > 0 ? "+" : "") + str.tostring(sec_perf, "#.0") + "%"
sec_col    = sec_perf > 0 ? col_green : col_red

sec_close_now = request.security(sector_ticker, "D", close, ignore_invalid_symbol=true)
sec_sma50     = request.security(sector_ticker, "D", ta.sma(close, 50), ignore_invalid_symbol=true)

bool sector_is_bullish = sec_close_now > sec_sma50
bool favorable_sector_trend = is_inverse_usd ? not sector_is_bullish : sector_is_bullish
string sec_trend_display_txt = favorable_sector_trend ? "UP" : "DOWN"
sec_trend_col = favorable_sector_trend ? col_green : col_red

// --- F. FINANCIALS (DYNAMIC: TTM or QUARTERLY) ---
period_id = fin_mode == "TTM" ? "TTM" : "FQ" 

f_eps_raw = request.financial(syminfo.tickerid, "EARNINGS_PER_SHARE_DILUTED", period_id, ignore_invalid_symbol=true)
f_rev_raw = request.financial(syminfo.tickerid, "TOTAL_REVENUE", period_id, ignore_invalid_symbol=true)

// Get Current values
eps_now = request.security(syminfo.tickerid, "D", f_eps_raw, ignore_invalid_symbol=true)
rev_now = request.security(syminfo.tickerid, "D", f_rev_raw, ignore_invalid_symbol=true)

// Get Previous values (252 bars ago = 1 year ago)
eps_prev = request.security(syminfo.tickerid, "D", f_eps_raw[252], ignore_invalid_symbol=true) 
rev_prev = request.security(syminfo.tickerid, "D", f_rev_raw[252], ignore_invalid_symbol=true)

// --- VALUATION FIX ---
f_eps_ttm_fixed = request.financial(syminfo.tickerid, "EARNINGS_PER_SHARE_DILUTED", "TTM", ignore_invalid_symbol=true)
eps_ttm_fixed = request.security(syminfo.tickerid, "D", f_eps_ttm_fixed, ignore_invalid_symbol=true)
pe_ratio = (not na(eps_ttm_fixed) and eps_ttm_fixed > 0) ? close / eps_ttm_fixed : na

float eps_growth = na
float rev_growth = na

// Calculate Growth
if is_stock and not na(eps_now) and not na(eps_prev) and eps_prev != 0
    eps_growth := ((eps_now - eps_prev) / math.abs(eps_prev)) * 100

if is_stock and not na(rev_now) and not na(rev_prev) and rev_prev != 0
    rev_growth := ((rev_now - rev_prev) / rev_prev) * 100

// Volatility for non-stocks
atr_val = ta.atr(14)
atr_pct = (atr_val / close) * 100
dist_200 = ((close - ta.sma(close, 200)) / ta.sma(close, 200)) * 100

// --- G. SETUP QUALITY ---
sma50 = ta.sma(close, 50)
sma200 = ta.sma(close, 200)
setup_grade = close > sma50 and sma50 > sma200 ? "A+" : close > sma50 ? "B" : "C"

// ==========================================
// 3. SCORING ALGORITHM
// ==========================================
float score_accum = 0.0
float max_possible = 0.0

// 1. RS Rating
score_accum += nz(rs_val)
max_possible += 100

// 2. Trend Quality
if setup_grade == "A+"
    score_accum += 30
else if setup_grade == "B"
    score_accum += 15
max_possible += 30

// 3. Alpha
if alpha > 0
    score_accum += 20
max_possible += 20

// 4. Sector Trend
if favorable_sector_trend
    score_accum += 20
max_possible += 20

// 5. Financials
if is_stock
    max_possible += 40 
    if not na(eps_growth) and eps_growth > 20
        score_accum += 20
    else if not na(eps_growth) and eps_growth > 0
        score_accum += 10
    if not na(rev_growth) and rev_growth > 20
        score_accum += 20
    else if not na(rev_growth) and rev_growth > 0
        score_accum += 10
else
    max_possible += 40
    if dist_200 > 0
        score_accum += 20
    if atr_pct > 0.1
        score_accum += 20

final_score = math.round((score_accum / max_possible) * 100)

score_color = final_score >= 70 ? col_green : final_score >= 50 ? col_grey : col_red
verdict_txt = final_score >= 70 ? "STRONG" : final_score >= 50 ? "NEUTRAL" : "RISK"
verdict_col = final_score >= 70 ? col_green : final_score >= 50 ? col_grey : col_red

// ==========================================
// 4. TABLE DRAWING
// ==========================================
var tbl = table.new(t_pos, 2, 14, border_width=1, border_color=color.gray)

if barstate.islast
    // Header
    table.cell(tbl, 0, 0, "ðŸ“Š " + syminfo.ticker, bgcolor=col_header, text_color=col_text, text_size=t_size, text_halign=text.align_left)
    table.cell(tbl, 1, 0, "Analysis", bgcolor=col_header, text_color=col_text, text_size=t_size)

    // Info
    info_text = is_stock ? "ER: " + er_txt + "  |  Vol: " + vol_txt : "Vol: " + vol_txt
    table.cell(tbl, 0, 1, info_text, bgcolor=er_bg_color, text_color=col_text, text_size=t_size)
    table.merge_cells(tbl, 0, 1, 1, 1) 

    // RS Rating
    table.cell(tbl, 0, 2, "RS Rating", bgcolor=col_label, text_color=col_text, text_size=t_size, text_halign=text.align_left)
    table.cell(tbl, 1, 2, str.tostring(rs_val), bgcolor=rs_col, text_color=col_text, text_size=t_size)

    // Alpha
    table.cell(tbl, 0, 3, "vs " + benchmark_label + " (Alpha)", bgcolor=col_label, text_color=col_text, text_size=t_size, text_halign=text.align_left)
    table.cell(tbl, 1, 3, alpha_txt, bgcolor=alpha_col, text_color=col_text, text_size=t_size)

    // Sector Trend
    table.cell(tbl, 0, 4, "Sector: " + sector_name_display, bgcolor=col_label, text_color=col_text, text_size=t_size, text_halign=text.align_left)
    table.cell(tbl, 1, 4, sec_trend_display_txt, bgcolor=sec_trend_col, text_color=col_text, text_size=t_size) 

    // vs Sector
    table.cell(tbl, 0, 5, "vs Sector", bgcolor=col_label, text_color=col_text, text_size=t_size, text_halign=text.align_left)
    table.cell(tbl, 1, 5, sec_txt, bgcolor=sec_col, text_color=col_text, text_size=t_size)

    // Financials (Rows 6 & 7)
    if is_stock
        label_suffix = fin_mode == "TTM" ? " (TTM)" : " (Qtr)"
        
        table.cell(tbl, 0, 6, "EPS Growth" + label_suffix, bgcolor=col_label, text_color=col_text, text_size=t_size, text_halign=text.align_left)
        eps_display_txt = not na(eps_growth) ? str.tostring(eps_growth, "#") + "%" : "N/A"
        eps_display_col = not na(eps_growth) ? (eps_growth > 25 ? col_green : eps_growth < 0 ? col_red : col_label) : col_label
        table.cell(tbl, 1, 6, eps_display_txt, bgcolor=eps_display_col, text_color=col_text, text_size=t_size)

        table.cell(tbl, 0, 7, "Rev Growth" + label_suffix, bgcolor=col_label, text_color=col_text, text_size=t_size, text_halign=text.align_left)
        rev_display_txt = not na(rev_growth) ? str.tostring(rev_growth, "#") + "%" : "N/A"
        rev_display_col = not na(rev_growth) ? (rev_growth > 25 ? col_green : rev_growth < 0 ? col_red : col_label) : col_label
        table.cell(tbl, 1, 7, rev_display_txt, bgcolor=rev_display_col, text_color=col_text, text_size=t_size)
    else
        table.cell(tbl, 0, 6, "Volatility (ATR)", bgcolor=col_label, text_color=col_text, text_size=t_size, text_halign=text.align_left)
        table.cell(tbl, 1, 6, str.tostring(atr_val, "#.####"), bgcolor=col_blue, text_color=col_text, text_size=t_size)

        table.cell(tbl, 0, 7, "Dist to 200MA", bgcolor=col_label, text_color=col_text, text_size=t_size, text_halign=text.align_left)
        dist_txt = (dist_200 > 0 ? "+" : "") + str.tostring(dist_200, "#.1") + "%"
        dist_col = dist_200 > 0 ? col_green : col_red
        table.cell(tbl, 1, 7, dist_txt, bgcolor=dist_col, text_color=col_text, text_size=t_size)

    // --- DYNAMIC ROWS ---
    // Start counter at 8 because rows 0-7 are already drawn
    int r_idx = 8

    // Valuation (Only if Stock)
    if is_stock
        table.cell(tbl, 0, r_idx, "P/E Ratio (TTM)", bgcolor=col_label, text_color=col_text, text_size=t_size, text_halign=text.align_left)
        pe_text = not na(pe_ratio) ? str.tostring(pe_ratio, "#.1") : (not na(eps_ttm_fixed) and eps_ttm_fixed <= 0 ? "Loss" : "N/A")
        table.cell(tbl, 1, r_idx, pe_text, bgcolor=col_label, text_color=col_text, text_size=t_size)
        r_idx := r_idx + 1 // Increment index

    // Setup Quality
    table.cell(tbl, 0, r_idx, "Setup Quality", bgcolor=col_label, text_color=col_text, text_size=t_size, text_halign=text.align_left)
    table.cell(tbl, 1, r_idx, setup_grade, bgcolor=col_green, text_color=col_text, text_size=t_size)
    r_idx := r_idx + 1

    // Score
    table.cell(tbl, 0, r_idx, "Overall Score", bgcolor=score_color, text_color=col_text, text_size=t_size)
    table.merge_cells(tbl, 0, r_idx, 0, r_idx) 
    table.cell(tbl, 1, r_idx, str.tostring(final_score), bgcolor=score_color, text_color=col_text, text_size=t_size)
    r_idx := r_idx + 1

    // Verdict
    table.cell(tbl, 0, r_idx, "VERDICT", bgcolor=verdict_col, text_color=col_text, text_size=t_size)
    table.cell(tbl, 1, r_idx, verdict_txt, bgcolor=verdict_col, text_color=col_text, text_size=t_size)
