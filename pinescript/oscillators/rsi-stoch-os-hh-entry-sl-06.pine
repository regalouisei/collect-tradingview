//@version=6
strategy("RSI & Stoch OS + HH Entry + SL 0.6%", overlay=true)

// --- Inputs ---
rsiLen     = input.int(14, "RSI Length")
rsiOS      = input.int(30, "RSI Oversold Level")

stochLen   = input.int(14, "Stochastic Length")
stochK     = input.int(3, "Stoch %K Smooth")
stochD     = input.int(3, "Stoch %D Smooth")
stochOS    = input.int(20, "Stoch Oversold Level")
stochOB    = input.int(90, "Stoch Overbought Level")

// อัปเดตค่า SL เป็น 0.6%
slPercent  = input.float(0.6, "Stop Loss (%)", step=0.1)

// --- Calculations ---
rsiVal = ta.rsi(close, rsiLen)
k = ta.sma(ta.stoch(close, high, low, stochLen), stochK)

// --- Logic ---

// 1. เช็คโซน Oversold (จากแท่งก่อนหน้า)
isOversold = (rsiVal[1] <= rsiOS) and (k[1] <= stochOS)

// 2. เงื่อนไขเข้าซื้อ: เคย OS แล้วแท่งปัจจุบันทำ Higher High (High > High ก่อนหน้า)
buyCondition = isOversold and (high > high[1])

// 3. เงื่อนไข TP: Stochastic (%K) เข้าโซน Overbought
tpCondition = k >= stochOB

// --- Strategy Execution ---

// เข้าซื้อ
if (buyCondition)
    strategy.entry("Long", strategy.long, comment="Buy (OS+HH)")

// ส่วนการจัดการออเดอร์ (Exit Strategy)
if (strategy.position_size > 0)
    
    // 1. Stop Loss: Fixed -0.6% จากราคาทุน
    float stopLevel = strategy.position_avg_price * (1 - (slPercent / 100))
    strategy.exit("Exit SL", "Long", stop = stopLevel, comment_loss="SL -0.6%")

    // 2. Take Profit: เมื่อ Stoch เข้าโซน Overbought
    if (tpCondition)
        strategy.close("Long", comment="TP (Stoch OB)")

// --- Visuals ---
plotshape(buyCondition, title="Buy Signal", location=location.belowbar, color=color.green, style=shape.triangleup, size=size.small)
hline(rsiOS, "RSI OS", color=color.blue, linestyle=hline.style_dotted)
hline(stochOS, "Stoch OS", color=color.red, linestyle=hline.style_dotted)
