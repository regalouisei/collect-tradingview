//@version=5
indicator("Oscillator Matrix [R2D2]", shorttitle="Osc Matrix", overlay=false)

// ==========================================
// ðŸ”¶ SETTINGS
// ==========================================
grp_hw = "Hyper Wave Settings"
hw_len1 = input.int(10, "Channel Length", group=grp_hw)
hw_len2 = input.int(21, "Average Length", group=grp_hw)
show_hw = input.bool(true, "Show Hyper Wave Ribbon", group=grp_hw)

grp_mf = "Money Flow Settings"
mf_len  = input.int(60, "Money Flow Length", group=grp_mf)
mf_mult = input.float(3.0, "Sensitivity", group=grp_mf)
show_mf = input.bool(true, "Show Money Flow", group=grp_mf)

grp_sig = "Signal Settings"
show_div = input.bool(true, "Show Divergences", group=grp_sig)
show_rev = input.bool(true, "Show Reversal Dots", group=grp_sig)

// ==========================================
// ðŸ”¶ CALCULATIONS
// ==========================================

// --- 1. Hyper Wave (WaveTrend Logic) ---
// The Hyper Wave is typically a "WaveTrend" oscillator (ESA/D momentum).
ap  = hlc3
esa = ta.ema(ap, hw_len1)
d   = ta.ema(math.abs(ap - esa), hw_len1)
ci  = (ap - esa) / (0.015 * d)
tci = ta.ema(ci, hw_len2)

wt1 = tci
wt2 = ta.sma(wt1, 4)

// Colors for Hyper Wave
hw_color_bull = #00ffbb // Teal
hw_color_bear = #ff1100 // Red
curr_hw_color = wt1 >= wt2 ? hw_color_bull : hw_color_bear

// --- 2. Money Flow (Smoothed Momentum) ---
// Simulating the "Smart Money Flow" using a smoothed RSI/MFI logic centered at 0.
mf_rsi = ta.rsi(close, mf_len) - 50
mf_vol = ta.ema(mf_rsi, 3) * mf_mult

// Money Flow Colors (Green/Red with "Overflow" opacity logic)
mf_bull_col = color.new(hw_color_bull, 60)
mf_bear_col = color.new(hw_color_bear, 60)
mf_curr_col = mf_vol >= 0 ? mf_bull_col : mf_bear_col

// Thresholds (Dynamic Lines above/below Money Flow)
// These represent the "Activity Lines" mentioned in the docs
mf_thresh_upper = ta.sma(math.abs(mf_vol), 50) * 1.5
mf_thresh_lower = -1 * mf_thresh_upper

// ==========================================
// ðŸ”¶ PLOTTING
// ==========================================

// --- Confluence Zones (Top Bar) ---
// Displays bullish if both Money Flow and Hyper Wave are aligned
var color conf_col = na
bool is_bull_confluence = (mf_vol > 0) and (wt1 > wt2)
bool is_bear_confluence = (mf_vol < 0) and (wt1 < wt2)

if is_bull_confluence
    conf_col := hw_color_bull
else if is_bear_confluence
    conf_col := hw_color_bear
else
    conf_col := color.new(color.gray, 50)

// Plot the Confluence Bar at the top (using a fixed high value or plotshape)
plot(115, "Confluence Top Line", color=conf_col, linewidth=4, style=plot.style_columns, histbase=110)


// --- Money Flow Plots ---
plot(show_mf ? mf_vol : na, "Money Flow", color=mf_curr_col, style=plot.style_area)
plot(show_mf ? mf_thresh_upper : na, "MF Threshold Upper", color=color.new(color.gray, 50))
plot(show_mf ? mf_thresh_lower : na, "MF Threshold Lower", color=color.new(color.gray, 50))


// --- Hyper Wave Plots ---
// The Ribbon Effect
p1 = plot(show_hw ? wt1 : na, "HW Fast", color=color.new(#ffffff, 50), linewidth=1)
p2 = plot(show_hw ? wt2 : na, "HW Slow", color=color.new(#ffffff, 80), linewidth=1)
fill(p1, p2, color=color.new(curr_hw_color, 70), title="Hyper Wave Ribbon")


// ==========================================
// ðŸ”¶ SIGNALS & DIVERGENCES
// ==========================================

// --- Reversal Dots (High Frequency) ---
// Triggered on Hyper Wave Crossovers
cross_up = ta.crossover(wt1, wt2)
cross_dn = ta.crossunder(wt1, wt2)

// Only show dots if they happen in significant areas (optional filter, here we show all like the image)
plotshape(show_rev and cross_up ? wt2 - 5 : na, "Reversal Up", shape.circle, location.absolute, hw_color_bull, size=size.tiny)
plotshape(show_rev and cross_dn ? wt2 + 5 : na, "Reversal Down", shape.circle, location.absolute, hw_color_bear, size=size.tiny)

// --- Real-Time Divergences (Simplified) ---
// Looking for price Lower Lows while Oscillator makes Higher Lows (Bullish)
// Looking for price Higher Highs while Oscillator makes Lower Highs (Bearish)

lookback = 5
src = wt1

// Bullish Divergence
lo = ta.lowest(src, lookback)
is_lowest = src == lo
price_lo = low
var float last_osc_lo = na
var float last_price_lo = na
bool bull_div = false

if is_lowest
    if src > last_osc_lo and low < last_price_lo
        bull_div := true
    last_osc_lo := src
    last_price_lo := low

// Bearish Divergence
hi = ta.highest(src, lookback)
is_highest = src == hi
var float last_osc_hi = na
var float last_price_hi = na
bool bear_div = false

if is_highest
    if src < last_osc_hi and high > last_price_hi
        bear_div := true
    last_osc_hi := src
    last_price_hi := high

// Plot Divergence Arrows (Large "Strong" Signals)
plotshape(show_div and bull_div, "Bullish Divergence", shape.triangleup, location.bottom, hw_color_bull, size=size.small)
plotshape(show_div and bear_div, "Bearish Divergence", shape.triangledown, location.top, hw_color_bear, size=size.small)

// Zero Lines & Boundaries
hline(0, "Zero Line", color=color.new(color.gray, 50))
hline(60, "Overbought", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(-60, "Oversold", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
