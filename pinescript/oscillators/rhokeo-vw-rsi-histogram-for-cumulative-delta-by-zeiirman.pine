//@version=6
indicator("Rhokeo-VW-RSI Histogram", shorttitle="VW-RSI for Cumulative Delta", overlay=false)

//============================================================
// VW-RSI SETTINGS
//============================================================

group_vwrsi = "VW-RSI Settings"
rsi_price = input.source(ohlc4, title="RSI Price Source", group=group_vwrsi)
rsi_length = input.int(9, "RSI Length", minval=1, group=group_vwrsi)
rsi_maTypeInput = input.string("EMA", "RSI MA Type", options=["SMA", "EMA", "SMMA (RMA)", "WMA", "VWMA"], group=group_vwrsi)
rsi_maLengthInput = input.int(14, "RSI MA Length", minval=1, group=group_vwrsi)

//============================================================
// LEVEL SETTINGS
//============================================================

group_levels = "Level Settings"
obLevel = input.float(0.7, "Overbought Shading Level", minval=0.1, maxval=0.99, group=group_levels)
osLevel = input.float(-0.7, "Oversold Shading Level", minval=-0.99, maxval=-0.1, group=group_levels)
vwrsi_obLevel = input.float(0.4, "VW-RSI OB Level", minval=0.1, maxval=0.99, group=group_levels)
vwrsi_osLevel = input.float(-0.4, "VW-RSI OS Level", minval=-0.99, maxval=-0.1, group=group_levels)

//============================================================
// HISTOGRAM COLOR SETTINGS
//============================================================

group_hist_colors = "Histogram Colors"
hist_color_above_ob = input.color(color.aqua, "Above OB (Strong Bull)", group=group_hist_colors)
hist_color_above_zero = input.color(color.blue, "Above Zero (Weak Bull)", group=group_hist_colors)
hist_color_below_zero = input.color(color.maroon, "Below Zero (Weak Bear)", group=group_hist_colors)
hist_color_below_os = input.color(color.red, "Below OS (Strong Bear)", group=group_hist_colors)

//============================================================
// LINE & SHADING COLOR SETTINGS
//============================================================

group_lines = "Lines & Shading"
zeroUpColor = input.color(color.new(color.lime, 0), "Zero Line Bull Color", group=group_lines)
zeroDnColor = input.color(color.new(color.red, 0), "Zero Line Bear Color", group=group_lines)
ob_shade_color = input.color(color.new(color.red, 85), "OB Shading Color", group=group_lines)
os_shade_color = input.color(color.new(color.green, 85), "OS Shading Color", group=group_lines)
ceiling_floor_color = input.color(color.new(color.gray, 85), "Ceiling/Floor Color", group=group_lines)
ob_line_color = input.color(color.new(color.red, 70), "OB Line Color", group=group_lines)
os_line_color = input.color(color.new(color.lime, 70), "OS Line Color", group=group_lines)

//============================================================
// HELPER FUNCTIONS
//============================================================

rsi_maFunc(_type, _src, _len) =>
    switch _type
        "SMA"  => ta.sma(_src, _len)
        "EMA"  => ta.ema(_src, _len)
        "SMMA (RMA)" => ta.rma(_src, _len)
        "WMA"  => ta.wma(_src, _len)
        "VWMA" => ta.vwma(_src, _len)
        => ta.ema(_src, _len)

clamp(x, lo, hi) =>
    x < lo ? lo : x > hi ? hi : x

//============================================================
// VW-RSI CALCULATION (NORMALIZED TO -1/+1 RANGE)
//============================================================

price_change = rsi_price - rsi_price[1]
vw_gain = price_change > 0 ? price_change * volume : 0.0
vw_loss = price_change < 0 ? math.abs(price_change) * volume : 0.0

avg_vw_gain = ta.rma(vw_gain, rsi_length)
avg_vw_loss = ta.rma(vw_loss, rsi_length)

rs = avg_vw_loss == 0 ? 999999.0 : avg_vw_gain / avg_vw_loss
vw_rsi_0_100 = 100.0 - (100.0 / (1.0 + rs))

// Normalize from 0-100 to -1 to +1 range
vw_rsi_normalized = (vw_rsi_0_100 - 50.0) / 50.0

// Apply MA smoothing to the normalized VW-RSI (this creates the smooth histogram)
vw_rsi_smoothed = rsi_maFunc(rsi_maTypeInput, vw_rsi_normalized, rsi_maLengthInput)

// Clamp to ensure it stays within -1 to +1
vw_rsi_clamped = clamp(vw_rsi_smoothed, -1.0, 1.0)

//============================================================
// HISTOGRAM COLORING (4 ZONES)
//============================================================

// Zone 1: Above OB level (Strong Bull)
// Zone 2: Between 0 and OB level (Weak Bull)
// Zone 3: Between OS level and 0 (Weak Bear)
// Zone 4: Below OS level (Strong Bear)

hist_color = vw_rsi_clamped >= vwrsi_obLevel ? hist_color_above_ob :
             vw_rsi_clamped >= 0 ? hist_color_above_zero :
             vw_rsi_clamped >= vwrsi_osLevel ? hist_color_below_zero :
             hist_color_below_os

//============================================================
// PLOTTING
//============================================================

// Ceiling and Floor Lines (+1 / -1)
hline(1, "Ceiling", color=ceiling_floor_color)
hline(-1, "Floor", color=ceiling_floor_color)

// OB/OS Shading (+0.7 to +1 and -0.7 to -1)
pOB = plot(obLevel, "OB Level", color=color.new(color.red, 100), display=display.none)
pTOP = plot(1.0, "", color=color.new(color.red, 100), display=display.none)
pOS = plot(osLevel, "OS Level", color=color.new(color.lime, 100), display=display.none)
pBOT = plot(-1.0, "", color=color.new(color.lime, 100), display=display.none)
fill(pOB, pTOP, color=ob_shade_color)
fill(pOS, pBOT, color=os_shade_color)

// OB/OS Lines (+0.4 / -0.4)
hline(vwrsi_obLevel, "VW-RSI OB", color=ob_line_color, linestyle=hline.style_dashed)
hline(vwrsi_osLevel, "VW-RSI OS", color=os_line_color, linestyle=hline.style_dashed)

// Zero Line (color changes based on VW-RSI position)
zeroColor = vw_rsi_clamped >= 0 ? zeroUpColor : zeroDnColor
plot(0, title="Zero Line", color=zeroColor, linewidth=2)

// VW-RSI Histogram (smoothed)
plot(vw_rsi_clamped, title="VW-RSI Histogram", color=hist_color, style=plot.style_histogram, linewidth=4)
