// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Stef Jonker
//@version=6

indicator("Trend Following Reflectometry", shorttitle="TFR", overlay=false)


// ═══════════════════════════════════════════════════════════════════════════════════════════════════════
// INPUTS
// ═══════════════════════════════════════════════════════════════════════════════════════════════════════
G_Z0 = "Z₀ Settings"
G_ZL = "ZL Settings"

fastLen = input.int(defval = 14, title = "Fast MA", minval = 5, group = G_ZL)
slowLen = input.int(defval = 50, title = "Slow MA", minval = 20, group = G_ZL)

z0Len = input.int(defval = 100, title = "Impedance Z₀", minval = 50, tooltip = "Length selection for Z₀", group = G_Z0)
z0Src = input.source(defval = close, title = "Z₀ Source", tooltip = "Source selection for the impedance source Z₀", group = G_Z0)

// ═══════════════════════════════════════════════════════════════════════════════════════════════════════
// TRUE IMPEDANCE MATCHING (FORCED LONG/SHORT)
// ═══════════════════════════════════════════════════════════════════════════════════════════════════════

// 1. CHARACTERISTIC IMPEDANCE (Z₀) - MARKET NORM
z0 = ta.atr(z0Len) / ta.sma(z0Src, z0Len) * 100

// 2. LOAD IMPEDANCE (Z_L) - TREND STRENGTH
fastMA = ta.ema(close, fastLen)
slowMA = ta.ema(close, slowLen)
momentum = (fastMA - slowMA) / slowMA * 100
zL = math.abs(momentum)

// 3. REFLECTION COEFFICIENT (Γ) GAMMA
gamma = (zL - z0) / (zL + z0)

// 4. VSWR - TREND PURITY (Voltage Standing Wave Ratio)
vswr = zL > z0 ? (1 + math.abs(gamma)) / (1 - math.abs(gamma)) : 1.0

// 5. IMPEDANCE OSCILLATOR
echo = gamma * z0 * 0.7
oscillator = momentum + echo

// ═══════════════════════════════════════════════════════════════════════════════════════════════════════
// FORCED LONG/SHORT
// ═══════════════════════════════════════════════════════════════════════════════════════════════════════
long = oscillator > 0 and barstate.isconfirmed
short = oscillator <= 0 and barstate.isconfirmed

// ═══════════════════════════════════════════════════════════════════════════════════════════════════════
// PURE IMPEDANCE OSCILLATOR
// ═══════════════════════════════════════════════════════════════════════════════════════════════════════

// ALWAYS COLORED COLUMNS
barColor = long ? color.rgb(103, 58, 183) : short ? color.rgb(233, 30, 99) : na
plot(oscillator, "Impedance", barColor, 4, plot.style_columns)


// ═══════════════════════════════════════════════════════════════════════════════════════════════════════
// FORCED POSITION DASHBOARD
// ═══════════════════════════════════════════════════════════════════════════════════════════════════════
if barstate.islast
    tbl = table.new(position.top_right, 1, 4, bgcolor=color.new(#1a1a1a, 0), border_width=0)
    
    // POSITION (ALWAYS LONG OR SHORT)
    position = long ? "LONG" : "SHORT"
    table.cell(tbl, 0, 0, position, 
               text_color=long ? color.lime : color.red, 
               text_size=size.normal)
    
    // VSWR
    // This ratio measures how well the Impedance of the load matches the impedance of the source
    table.cell(tbl, 0, 1, "VSWR: " + str.tostring(vswr, "0.0"), 
               text_color=color.yellow, 
               text_size=size.normal)
    
    // Gamma
    // This measures the reflection coefficient, which represents the ratio of the reflected wave to the incident wave
    table.cell(tbl, 0, 2, "Gamma: " + str.tostring(gamma, "0.00"), 
               text_color=color.purple, 
               text_size=size.normal)
    
    // Z Ratio
    // The relationship between the impedance of two different components or systems, calculated by dividing one impedance by the other
    zRatio = zL / z0
    table.cell(tbl, 0, 3, "Z ratio: " + str.tostring(zRatio, "0.0"), 
               text_color=color.aqua, 
               text_size=size.normal)
