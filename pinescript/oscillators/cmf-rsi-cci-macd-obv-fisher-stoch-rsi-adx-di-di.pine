//@version=6
indicator("8 ind Hakkaya — CMF, RSI, CCI, MACD, OBV, Fisher, Stoch RSI, ADX (+DI/-DI)", overlay=false, max_labels_count=500)

//================ INPUTS =================
grpMain = "Göstergeler"
showCMF   = input.bool(true,  "CMF Kullan", group=grpMain)
showRSI   = input.bool(true,  "RSI Kullan", group=grpMain)
showCCI   = input.bool(true,  "CCI Kullan", group=grpMain)
showMACD  = input.bool(false, "MACD Kullan", group=grpMain)
showOBV   = input.bool(false, "OBV Kullan", group=grpMain)
showFISH  = input.bool(false, "Fisher Kullan", group=grpMain)
showSTOCH = input.bool(false, "Stoch RSI Kullan", group=grpMain)
showADX   = input.bool(false, "ADX (+DI/-DI) Kullan", group=grpMain)

//================ GÖRSEL AYARLAR =================
grpStyle = "Renk & Stil"
clrCMF   = input.color(color.teal,    "CMF Rengi", group=grpStyle)
clrRSI   = input.color(color.orange,  "RSI Rengi", group=grpStyle)
clrCCI   = input.color(color.fuchsia, "CCI Rengi", group=grpStyle)
clrMACD  = input.color(color.blue,    "MACD Rengi", group=grpStyle)
clrOBV   = input.color(color.purple,  "OBV Rengi", group=grpStyle)
clrFISH  = input.color(color.green,   "Fisher Rengi", group=grpStyle)
clrSTOCH = input.color(color.lime,    "Stoch RSI Rengi", group=grpStyle)
clrADX   = input.color(color.red,     "ADX Rengi", group=grpStyle)
clrDIpos = input.color(color.lime,    "DI+ Rengi", group=grpStyle)
clrDIneg = input.color(color.fuchsia, "DI- Rengi", group=grpStyle)

tablePos = input.string("Yukarı", "Tablo Konumu", options=["Yukarı","Aşağı"], group=grpStyle)

// Çizgi ayarları
grpLines = "Referans Çizgileri"
showMidLine   = input.bool(true, "Orta Çizgi Göster (0)", group=grpLines)
midLineValue  = input.float(0.0, "Orta Çizgi Değeri", group=grpLines)
clrMidLine    = input.color(color.gray, "Orta Çizgi Rengi", group=grpLines)
lwMidLine     = input.int(1, "Orta Çizgi Kalınlık", minval=1, maxval=3, group=grpLines)

showTopLine   = input.bool(true, "Üst Çizgi Göster (+100)", group=grpLines)
topLineValue  = input.float(100.0, "Üst Çizgi Değeri", group=grpLines)
clrTopLine    = input.color(color.new(color.green, 0), "Üst Çizgi Rengi", group=grpLines)
lwTopLine     = input.int(1, "Üst Çizgi Kalınlık", minval=1, maxval=3, group=grpLines)

showBottomLine = input.bool(true, "Alt Çizgi Göster (-100)", group=grpLines)
bottomLineValue = input.float(-100.0, "Alt Çizgi Değeri", group=grpLines)
clrBottomLine   = input.color(color.new(color.red, 0), "Alt Çizgi Rengi", group=grpLines)
lwBottomLine    = input.int(1, "Alt Çizgi Kalınlık", minval=1, maxval=3, group=grpLines)

// Yeni 50 çizgisi
showMid50     = input.bool(true, "50 Çizgisi Göster", group=grpLines)
mid50Value    = input.float(50.0, "50 Çizgi Değeri", group=grpLines)
clrMid50      = input.color(color.blue, "50 Çizgi Rengi", group=grpLines)
lwMid50       = input.int(1, "50 Çizgi Kalınlık", minval=1, maxval=3, group=grpLines)
// Ek Referans Çizgileri (80 / 20 / Yedek 50)
grpRefX     = "Ek Referans Çizgileri (StochRSI tarzı)"
showRefX    = input.bool(true,  "Ek Referans Çizgilerini Göster", group=grpRefX)
refX_upper  = input.float(80.0, "Üst (80)",   step=0.1, group=grpRefX)
refX_lower  = input.float(20.0, "Alt (20)",   step=0.1, group=grpRefX)
refX_spare  = input.float(50.0, "Yedek (50)", step=0.1, group=grpRefX)
refX_colU   = input.color(color.new(color.red,    0), "Üst Renk",   group=grpRefX)
refX_colL   = input.color(color.new(color.green,  0), "Alt Renk",   group=grpRefX)
refX_colS   = input.color(color.new(color.orange, 0), "Yedek Renk", group=grpRefX)
refX_width  = input.int(1, "Çizgi Kalınlığı", minval=1, maxval=4, group=grpRefX)
//================ HELPER FUNC =================
normalize(src, minVal, maxVal) =>
    (src - ta.lowest(src, 100)) / math.max(ta.highest(src, 100) - ta.lowest(src, 100), 0.0001) * (maxVal - minVal) + minVal

//================ İNDİKATÖRLER =================
// CMF
cmfLen = input.int(20, "CMF Periyot", group="CMF")
mfMult = ((close - low) - (high - close)) / (high - low)
mfMult := na(mfMult) ? 0 : mfMult
mfVol  = mfMult * volume
cmf = ta.sma(mfVol, cmfLen) / ta.sma(volume, cmfLen)
cmfNorm = normalize(cmf, -100, 100)

// RSI (Standart)
rsiLen = input.int(14, "RSI Periyot", group="RSI")
rsi = ta.rsi(close, rsiLen)

// CCI (Standart)
cciLen = input.int(20, "CCI Periyot", group="CCI")
smaCci = ta.sma(hlc3, cciLen)
meanDev = ta.sma(math.abs(hlc3 - smaCci), cciLen)
cci = (hlc3 - smaCci) / (0.015 * meanDev)

// MACD
fast = input.int(12, "MACD Fast", group="MACD")
slow = input.int(26, "MACD Slow", group="MACD")
sig  = input.int(9,  "MACD Signal", group="MACD")
macdLine = ta.ema(close, fast) - ta.ema(close, slow)
macdSignal = ta.ema(macdLine, sig)
macdHist = macdLine - macdSignal
macdNorm = normalize(macdHist, -100, 100)

// OBV
obv = ta.cum(math.sign(close - close[1]) * volume)
obvNorm = normalize(obv, -100, 100)

// Fisher
fishLen = input.int(9, "Fisher Periyot", group="Fisher")
maxH = ta.highest(high, fishLen)
minL = ta.lowest(low, fishLen)
var float val = na
val := 0.66 * ((close - minL) / math.max(maxH - minL, 0.001) - 0.5) + 0.67 * nz(val[1])
fish = 0.5 * math.log((1 + val) / math.max(1 - val, 0.001))
fishNorm = normalize(fish, -100, 100)

// Stoch RSI
stochLen = input.int(14, "Stoch RSI Periyot", group="Stoch RSI")
stochRsi = ta.stoch(close, high, low, stochLen)
stochNorm = normalize(stochRsi, -100, 100)

// ADX (+DI/-DI)
adxLen = input.int(14, "ADX Periyot", group="ADX")
[plusDI, minusDI, adxVal] = ta.dmi(adxLen, adxLen)
adxNorm    = normalize(adxVal, -100, 100)
plusDINorm = normalize(plusDI, -100, 100)
minusDINorm= normalize(minusDI, -100, 100)

//================ PLOTLAR =================
plot(showCMF   ? cmfNorm   : na, color=clrCMF,   linewidth=2, title="CMF (Norm)")
plot(showRSI   ? rsi       : na, color=clrRSI,   linewidth=2, title="RSI (Standart)")
plot(showCCI   ? cci       : na, color=clrCCI,   linewidth=2, title="CCI (Standart)")
plot(showMACD  ? macdNorm  : na, color=clrMACD,  linewidth=2, title="MACD (Norm)")
plot(showOBV   ? obvNorm   : na, color=clrOBV,   linewidth=2, title="OBV (Norm)")
plot(showFISH  ? fishNorm  : na, color=clrFISH,  linewidth=2, title="Fisher (Norm)")
plot(showSTOCH ? stochNorm : na, color=clrSTOCH, linewidth=2, title="Stoch RSI (Norm)")
plot(showADX   ? adxNorm    : na, color=clrADX,   linewidth=2, title="ADX (Norm)")
plot(showADX   ? plusDINorm : na, color=clrDIpos, linewidth=2, title="DI+ (Norm)")
plot(showADX   ? minusDINorm: na, color=clrDIneg, linewidth=2, title="DI- (Norm)")
// Ek Referans Çizgileri (plot ile; show/hide var)
plot(showRefX ? refX_upper : na, title="Ek Ref Üst (80)",   color=refX_colU, linewidth=refX_width)
plot(showRefX ? refX_lower : na, title="Ek Ref Alt (20)",   color=refX_colL, linewidth=refX_width)
plot(showRefX ? refX_spare : na, title="Ek Ref Yedek (50)", color=refX_colS, linewidth=refX_width)
// Referans çizgileri (0, ±100)
plot(showMidLine    ? midLineValue    : na, title="Orta Çizgi", color=clrMidLine,    linewidth=lwMidLine)
plot(showTopLine    ? topLineValue    : na, title="Üst Çizgi",  color=clrTopLine,   linewidth=lwTopLine)
plot(showBottomLine ? bottomLineValue : na, title="Alt Çizgi",  color=clrBottomLine,linewidth=lwBottomLine)

//================ 50 ÇİZGİSİ (line.new ile) =================
var line mid50 = na
if barstate.islast
    if showMid50
        line.delete(mid50)
        mid50 := line.new(bar_index-500, mid50Value, bar_index, mid50Value, extend=extend.right, color=clrMid50, style=line.style_dashed, width=lwMid50)
    else
        line.delete(mid50)

//================ TABLO (kaydırmalı) =================
grpTbl = "Tablo Ayarları"
tableCorner   = input.string("Sağ Alt", "Tablo Köşesi", options=["Sağ Alt","Sağ Üst","Sol Alt","Sol Üst"], group=grpTbl)
padTopRows    = input.int(0, "Üst Boşluk (satır)",   minval=0, maxval=50, group=grpTbl)
padBottomRows = input.int(4, "Alt Boşluk (satır)",   minval=0, maxval=50, group=grpTbl)
xShiftCols    = input.int(1, "Sağdan İçeri Kaydır (kolon)", minval=0, maxval=10, group=grpTbl)

// Köşe pozisyonu
pos = tableCorner == "Sağ Alt" ? position.bottom_right :
      tableCorner == "Sağ Üst" ? position.top_right    :
      tableCorner == "Sol Alt" ? position.bottom_left  :
                                 position.top_left

// Tablo boyutları (bol bırak)
var T_ROWS = 40
var T_COLS = 6

// Tek tablo nesnesi
var table t = table.new(pos, T_COLS, T_ROWS, border_width=1)

// İçerik sayısı
contentCount = 0
contentCount += showCMF   ? 1 : 0
contentCount += showRSI   ? 1 : 0
contentCount += showCCI   ? 1 : 0
contentCount += showMACD  ? 1 : 0
contentCount += showOBV   ? 1 : 0
contentCount += showFISH  ? 1 : 0
contentCount += showSTOCH ? 1 : 0
if showADX
    contentCount += 3  // ADX, DI+, DI-

// Başlangıç satırı (alt köşedeysek alttan yukarı)
isBottom = (pos == position.bottom_right or pos == position.bottom_left)
startRowTop    = padTopRows
startRowBottom = math.max(0, T_ROWS - padBottomRows - contentCount)

// Yatay içeri kaydırma (y-ölçeğini kapatmasın)
startCol = math.min(T_COLS - 1, xShiftCols)

if barstate.islast
    // Bazı sürümlerde parametre ZORUNLU
    table.clear(t, 0, 0)

    row = isBottom ? startRowBottom : startRowTop
    col = startCol

    if showCMF
        table.cell(t, col, row, "CMF: " + str.tostring(cmfNorm, "#.##"), text_color=clrCMF), row += 1
    if showRSI
        table.cell(t, col, row, "RSI: " + str.tostring(rsi, "#.##"), text_color=clrRSI), row += 1
    if showCCI
        table.cell(t, col, row, "CCI: " + str.tostring(cci, "#.##"), text_color=clrCCI), row += 1
    if showMACD
        table.cell(t, col, row, "MACD: " + str.tostring(macdNorm, "#.##"), text_color=clrMACD), row += 1
    if showOBV
        table.cell(t, col, row, "OBV: " + str.tostring(obvNorm, "#.##"), text_color=clrOBV), row += 1
    if showFISH
        table.cell(t, col, row, "Fisher: " + str.tostring(fishNorm, "#.##"), text_color=clrFISH), row += 1
    if showSTOCH
        table.cell(t, col, row, "Stoch RSI: " + str.tostring(stochNorm, "#.##"), text_color=clrSTOCH), row += 1
    if showADX
        table.cell(t, col, row, "ADX: " + str.tostring(adxNorm, "#.##"), text_color=clrADX), row += 1
        table.cell(t, col, row, "DI+: " + str.tostring(plusDINorm, "#.##"), text_color=clrDIpos), row += 1
        table.cell(t, col, row, "DI-: " + str.tostring(minusDINorm, "#.##"), text_color=clrDIneg), row += 1
