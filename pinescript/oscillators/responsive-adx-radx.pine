// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © EMA34TRADER
//@version=5
indicator("Responsive ADX (RADX)", shorttitle="RADX Pro", overlay=false, max_lines_count=500)

// ── Inputs ─────────────────────
len = input.int(9, "ADX Length", minval=7, maxval=20)
smoothDI = input.bool(true, "Lightly smooth +DI/-DI (recommended)")
thWeak   = input.int(15, "Weak → Trending")
thStrong = input.int(20, "Strong Trend")

// Colors
colPlus  = color.new(#00EFFF, 0)
colMinus = color.new(#FF0080, 0)
colADX   = color.new(#FFD700, 0)

// ── Standard Wilder TR & DM (nothing fancy) ─────────────────────
tr  = ta.tr(true)
up  = high - high[1]
dn  = low[1] - low
plusDM  = up > dn and up > 0 ? up : 0
minusDM = dn > up and dn > 0 ? dn : 0

// ── Wilder smoothing (ta.rma) on TR and DMs — this is the correct way ─────
smTR    = ta.rma(tr,      len)
smPlus  = ta.rma(plusDM,  len)
smMinus = ta.rma(minusDM, len)

// ── +DI & -DI (optionally very lightly smoothed for cleaner crosses) ────
rawPlus  = smPlus  / smTR * 100
rawMinus = smMinus / smTR * 100

DIPlus  = smoothDI ? ta.ema(rawPlus,  5) : rawPlus
DIMinus = smoothDI ? ta.ema(rawMinus, 5) : rawMinus

// ── DX → ADX using a slightly faster smoothing (Hull-style but safe) ─────
dx    = math.abs(DIPlus - DIMinus) / (DIPlus + DIMinus) * 100
fastADX = ta.ema(dx, len) == 0 ? 50 : ta.wma(2*ta.wma(dx, len/2) - ta.wma(dx, len), math.round(math.sqrt(len)))

// ── Hidden plots for dynamic alert messages ─────────────────────────────
plot(thWeak,   title="WeakToTrend Level", display=display.none)
plot(thStrong, title="Strong Trend Level", display=display.none)
plot(fastADX,  title="Fast ADX Value", display=display.none)

// ── Plots ───────────────────────────────────────────────────────────────
p1 = plot(DIPlus,  "+DI",  color=colPlus,  linewidth=2)
p2 = plot(DIMinus, "-DI",  color=colMinus, linewidth=2)
p3 = plot(fastADX, "Fast ADX", color=colADX, linewidth=3)

fill(p1, p2, color = DIPlus > DIMinus ? color.new(#00EFFF, 90) : color.new(#FF0080, 90))

hline(0,   "0",   color=color.gray)
hline(thWeak,   "Trending", color=color.orange)
hline(thStrong, "Strong",  color=color.white)
hline(100, "100", color=color.gray)

// ── Background only when real trend exists ───────────────────────────────
bullTrend = DIPlus > DIMinus and fastADX > thWeak
bearTrend = DIMinus > DIPlus and fastADX > thWeak
bgcolor(bullTrend ? color.new(#00EFFF, 90) : na)
bgcolor(bearTrend ? color.new(#FF0080, 90) : na)

// ── Table ───────────────────────────────────────────────────────────────
var table t = table.new(position.top_right, 1, 4, bgcolor=#1e1e2d, border_width=1)
if barstate.islastconfirmedhistory
    table.cell(t, 0, 0, "Fast ADX", text_color=#FFD700)
    table.cell(t, 0, 1, str.tostring(fastADX, "#.0"), text_color=fastADX>thStrong?color.yellow:color.white)
    table.cell(t, 0, 2, DIPlus>DIMinus?"BULL":"BEAR", text_color=DIPlus>DIMinus?colPlus:colMinus)
    table.cell(t, 0, 3, fastADX>thStrong?"STRONG":fastADX>thWeak?"TREND":"FLAT", text_color=fastADX>thStrong?color.lime:color.gray)

// ── Fixed v5-compliant alerts (no more errors!) ─────────────────────────
alertcondition(ta.crossover(fastADX, thWeak),   title="Trend Starting", 
               message="Fast ADX crossed above Trending level ({{plot('WeakToTrend Level')}}) on {{ticker}} {{interval}}")
alertcondition(ta.crossover(fastADX, thStrong), title="Strong Trend",   
               message="STRONG TREND — Fast ADX crossed above {{plot('Strong Trend Level')}} (now {{plot('Fast ADX Value')}}) on {{ticker}} {{interval}}")
alertcondition(ta.crossover(DIPlus, DIMinus),   title="+DI Bullish Cross", 
               message="+DI crossed above -DI → Potential bullish trend on {{ticker}} {{interval}}")
alertcondition(ta.crossover(DIMinus, DIPlus),   title="-DI Bearish Cross", 
               message="-DI crossed above +DI → Potential bearish trend on {{ticker}} {{interval}}")
