//@version=5
indicator("Ichimoku_RSI_MACD_Clean", overlay=true)

// ===== Inputs =====
convLen = input.int(9, "Tenkan", minval=1)
baseLen = input.int(26, "Kijun", minval=1)
spanBLen = input.int(52, "Span B", minval=1)
displacement = input.int(26, "Cloud displacement", minval=0)

rsiLen = input.int(14, "RSI length", minval=2)
rsiBullLv = input.float(55.0, "RSI bull >=", step=0.1)
rsiBearLv = input.float(45.0, "RSI bear <=", step=0.1)

fastLen = input.int(12, "MACD fast", minval=1)
slowLen = input.int(26, "MACD slow", minval=1)
sigLen = input.int(9, "MACD signal", minval=1)

requireCloudBreak = input.bool(true, "Require price outside cloud")
useChikouFilter = input.bool(true, "Use Chikou filter")
strictSignals = input.bool(true, "Strict: TK cross + RSI + MACD")
confirmOnClose = input.bool(true, "Use last closed bar in realtime")

// ===== Ichimoku (safe) =====
tenkan = (ta.highest(high, convLen) + ta.lowest(low, convLen)) / 2.0
kijun = (ta.highest(high, baseLen) + ta.lowest(low, baseLen)) / 2.0
spanA = (tenkan + kijun) / 2.0
spanB = (ta.highest(high, spanBLen) + ta.lowest(low, spanBLen)) / 2.0

needed = math.max(baseLen, spanBLen)
enough = bar_index >= needed

// Chikou: price shifted back baseLen (guarded)
chikou = enough ? close[baseLen] : na

// Trend state
top = math.max(spanA, spanB)
bot = math.min(spanA, spanB)
bullTrend = enough and close > top
bearTrend = enough and close < bot

// ===== Momentum (use closed bar in realtime if selected) =====
src = confirmOnClose and barstate.isrealtime ? close[1] : close

rsi = ta.rsi(src, rsiLen)
rsiBull = rsi >= rsiBullLv
rsiBear = rsi <= rsiBearLv

macdLine = ta.ema(src, fastLen) - ta.ema(src, slowLen)
macdSignal = ta.ema(macdLine, sigLen)
macdHist = macdLine - macdSignal
macdBull = macdLine > macdSignal and macdHist >= 0
macdBear = macdLine < macdSignal and macdHist <= 0

// Tenkan/Kijun cross
crossUp = ta.crossover(tenkan, kijun)
crossDn = ta.crossunder(tenkan, kijun)

// Filters
chikouBullOk = not useChikouFilter or (enough and chikou > high[baseLen])
chikouBearOk = not useChikouFilter or (enough and chikou < low[baseLen])
trendBullOk = not requireCloudBreak or bullTrend
trendBearOk = not requireCloudBreak or bearTrend

// ===== Signals =====
bullCore = enough and crossUp and rsiBull and macdBull and chikouBullOk and trendBullOk
bearCore = enough and crossDn and rsiBear and macdBear and chikouBearOk and trendBearOk

bullSignal = strictSignals ? bullCore : (enough and crossUp and (rsiBull or macdBull) and chikouBullOk and trendBullOk)
bearSignal = strictSignals ? bearCore : (enough and crossDn and (rsiBear or macdBear) and chikouBearOk and trendBearOk)

// ===== Plots =====
plot(tenkan, "Tenkan", color=color.new(color.blue, 0), linewidth=2)
plot(kijun, "Kijun", color=color.new(color.orange, 0), linewidth=2)

aPlot = plot(spanA, "Span A", color=color.new(color.green, 0), offset=displacement)
bPlot = plot(spanB, "Span B", color=color.new(color.red, 0), offset=displacement)
fill(aPlot, bPlot, color=spanA >= spanB ? color.new(color.green, 85) : color.new(color.red, 85))

bgcolor(bullSignal ? color.new(color.green, 92) : bearSignal ? color.new(color.red, 92) : na)

plotshape(bullSignal, title="BUY", style=shape.triangleup, location=location.belowbar, color=color.new(color.green, 0), size=size.tiny, text="BUY")
plotshape(bearSignal, title="SELL", style=shape.triangledown, location=location.abovebar, color=color.new(color.red, 0), size=size.tiny, text="SELL")

// ===== Alerts =====
alertcondition(bullSignal, title="BUY (Ichimoku+RSI+MACD)", message="BUY: all filters aligned")
alertcondition(bearSignal, title="SELL (Ichimoku+RSI+MACD)", message="SELL: all filters aligned")
