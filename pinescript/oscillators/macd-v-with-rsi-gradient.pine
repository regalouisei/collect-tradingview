//@version=6
indicator("MACD-V with RSI Gradient", overlay=false)

// — Inputs
fastLength = input.int(12, title="Fast EMA")
slowLength = input.int(26, title="Slow EMA")
signalLength = input.int(9, title="Signal EMA")
atrLength = input.int(26, title="ATR Length")

// — Core Calculations
fastEMA = ta.ema(close, fastLength)
slowEMA = ta.ema(close, slowLength)
atr = ta.atr(atrLength)
atrSafe = math.max(atr, 0.0001)

macdv = ((fastEMA - slowEMA) / atrSafe) * 100
signal = ta.ema(macdv, signalLength)
histogram = macdv - signal

// — Histogram Coloring Logic
color histColor = na
if histogram >= 0 and histogram > histogram[1]
    histColor := color.lime
else if histogram >= 0 and histogram <= histogram[1]
    histColor := color.green
else if histogram < 0 and histogram < histogram[1]
    histColor := color.red
else
    histColor := color.fuchsia

// — RSI Gradient Background Function (Built-in Colors)
getRSIColor(rsiValue) =>
    color result = na
    if rsiValue >= 75
        result := color.new(#0ee916, 20)
    else if rsiValue >= 70
        result := color.new(#0ee015, 40)
    else if rsiValue >= 60
        result := color.new(#0fe616, 80)
    else if rsiValue >= 50
        result := color.new(#787b86, 95)
    else if rsiValue >= 40
        result := color.new(#787b86, 95)
    else if rsiValue >= 30
        result := color.new(#ec3d3d, 60)
    else
        result := color.new(#f53636, 40)
    result

// — Apply RSI Gradient Background
rsi = ta.rsi(close, 14)
bgcolor(getRSIColor(rsi), title="RSI Gradient Zone")

// — Plot Histogram FIRST (behind lines)
plot(histogram, title="Histogram", style=plot.style_columns, color=histColor)

// — Plot Lines SECOND (on top)
plot(macdv, title="MACD-V", color=color.blue, linewidth=2)
plot(signal, title="Signal", color=color.orange, linewidth=2)
