//@version=5
indicator("Fib Oscillator", overlay=false, max_labels_count=500)

// === INPUTS ===
atrLength   = input.int(14, title="ATR Period")
minLookback = input.int(20, title="Min Lookback")
maxLookback = input.int(100, title="Max Lookback")
isInverse   = input.bool(false, title="Inverse Candle Chart")

// === ATR & LOOKBACK ===
atr           = ta.atr(atrLength)
lookbackRaw   = ta.sma(atr, 10) / ta.sma(close, 10) * 500
lookbackValid = na(lookbackRaw) ? minLookback : math.max(minLookback, math.min(int(lookbackRaw), maxLookback))
lookback      = lookbackValid > 0 ? lookbackValid : minLookback

// === ADJUST HIGH/LOW ===
high_ = isInverse ? -low : high
low_  = isInverse ? -high : low
hi    = ta.highest(high_, lookback)
lo    = ta.lowest(low_, lookback)
hi    := isInverse ? -hi : hi
lo    := isInverse ? -lo : lo

// === MAJOR FIB LEVELS (constants, in percent) ===
fib0   = 0.0
fib236 = 23.6
fib382 = 38.2
fib50  = 50.0
fib618 = 61.8
fib786 = 78.6
fib100 = 100.0

// === OSCILLATOR CALCULATION (Position % in Fib Range) ===
osc = (close - lo) / (hi - lo) * 100

// === PLOT OSCILLATOR ===
plot(osc, title="Fib Position Oscillator", color=color.new(color.blue, 0), linewidth=2)

// === DRAW HORIZONTAL LEVELS (hline requires compile-time constant) ===
hline(fib0,   title="Fib 0%",   color=color.gray,                linestyle=hline.style_dotted)
hline(fib236, title="Fib 23.6%",color=color.new(color.lime, 0), linestyle=hline.style_dotted)
hline(fib382, title="Fib 38.2%",color=color.new(color.aqua, 0), linestyle=hline.style_dotted)
hline(fib50,  title="Fib 50%",  color=color.new(color.fuchsia,0),linestyle=hline.style_dotted)
hline(fib618, title="Fib 61.8%",color=color.new(color.orange,0), linestyle=hline.style_dotted)
hline(fib786, title="Fib 78.6%",color=color.new(color.red,0),    linestyle=hline.style_dotted)
hline(fib100, title="Fib 100%", color=color.gray,                linestyle=hline.style_dotted)

// === ALERTS (Major Levels Only) ===
alertcondition(ta.crossover(osc, fib236), title="Cross Above 23.6%", message="Oscillator crossed above Fib 23.6%")
alertcondition(ta.crossunder(osc, fib236), title="Cross Below 23.6%", message="Oscillator crossed below Fib 23.6%")

alertcondition(ta.crossover(osc, fib382), title="Cross Above 38.2%", message="Oscillator crossed above Fib 38.2%")
alertcondition(ta.crossunder(osc, fib382), title="Cross Below 38.2%", message="Oscillator crossed below Fib 38.2%")

alertcondition(ta.crossover(osc, fib50), title="Cross Above 50%", message="Oscillator crossed above Fib 50%")
alertcondition(ta.crossunder(osc, fib50), title="Cross Below 50%", message="Oscillator crossed below Fib 50%")

alertcondition(ta.crossover(osc, fib618), title="Cross Above 61.8%", message="Oscillator crossed above Fib 61.8%")
alertcondition(ta.crossunder(osc, fib618), title="Cross Below 61.8%", message="Oscillator crossed below Fib 61.8%")

alertcondition(ta.crossover(osc, fib786), title="Cross Above 78.6%", message="Oscillator crossed above Fib 78.6%")
alertcondition(ta.crossunder(osc, fib786), title="Cross Below 78.6%", message="Oscillator crossed below Fib 78.6%")
