//@version=5
indicator("HTF MACD Dual Zero Cross + First EMA Pullback + Trend Filter", overlay=true)

//────────────────────────────
// User Inputs
//────────────────────────────
htf          = input.timeframe("1H", "MACD Timeframe")
fastLen      = input.int(12, "MACD Fast Length", minval=1)
slowLen      = input.int(26, "MACD Slow Length", minval=1)
signalLen    = input.int(9, "MACD Signal Length", minval=1)
emaLen       = input.int(50, "Pullback EMA Length", minval=1)
useClosePull = input.bool(true, "Use Close for Pullback (else use Wick Touch)")
showSignals  = input.bool(true, "Show Buy/Sell Signals")

// Trend filter input
trendEMAlen  = input.int(50, "Trend EMA Length")
useTrendFilter = input.bool(true, "Use Trend Filter (ignore signals against trend)")

//────────────────────────────
// Compute HTF MACD
//────────────────────────────
fastEMA_htf  = request.security(syminfo.tickerid, htf, ta.ema(close, fastLen))
slowEMA_htf  = request.security(syminfo.tickerid, htf, ta.ema(close, slowLen))
macd_htf     = fastEMA_htf - slowEMA_htf
signal_htf   = request.security(syminfo.tickerid, htf, ta.ema(macd_htf, signalLen))
hist_htf     = macd_htf - signal_htf

//────────────────────────────
// MACD dual zero cross
//────────────────────────────
crossUpCond   = macd_htf > 0 and signal_htf > 0 and (macd_htf[1] <= 0 or signal_htf[1] <= 0)
crossDownCond = macd_htf < 0 and signal_htf < 0 and (macd_htf[1] >= 0 or signal_htf[1] >= 0)

//────────────────────────────
// EMA Pullback (on current TF)
//────────────────────────────
ema = ta.ema(close, emaLen)
priceTouchesEmaLong  = useClosePull ? (close <= ema) : (low <= ema)
priceTouchesEmaShort = useClosePull ? (close >= ema) : (high >= ema)

//────────────────────────────
// Trend filter
//────────────────────────────
trendEMA = ta.ema(close, trendEMAlen)
trendBull = close > trendEMA
trendBear = close < trendEMA

//────────────────────────────
// State logic: arm after HTF dual cross; fire once on first EMA touch
//────────────────────────────
var bool longArmed  = false
var bool shortArmed = false
var bool longFired  = false
var bool shortFired = false

if crossUpCond
    longArmed  := true
    longFired  := false
    shortArmed := false

if crossDownCond
    shortArmed := true
    shortFired := false
    longArmed  := false

longEntry  = longArmed  and not longFired  and priceTouchesEmaLong and (not useTrendFilter or trendBull)
shortEntry = shortArmed and not shortFired and priceTouchesEmaShort and (not useTrendFilter or trendBear)

if longEntry
    longFired := true
if shortEntry
    shortFired := true

//────────────────────────────
// Plotting
//────────────────────────────
plot(ema, title="Pullback EMA", color=color.orange)
plotshape(showSignals and longEntry,  title="Buy Entry",  style=shape.triangleup,
     color=color.new(color.lime, 0), location=location.belowbar, size=size.small, text="BUY")
plotshape(showSignals and shortEntry, title="Sell Entry", style=shape.triangledown,
     color=color.new(color.red, 0), location=location.abovebar, size=size.small, text="SELL")

// Trend EMA (optional)
plot(useTrendFilter ? trendEMA : na, title="Trend EMA", color=color.blue, linewidth=1)

//────────────────────────────
// Alerts
//────────────────────────────
alertcondition(longEntry,  title="Dual Zero Cross BUY",  message="MACD & Signal crossed above zero → First EMA Pullback BUY (Trend Confirmed)")
alertcondition(shortEntry, title="Dual Zero Cross SELL", message="MACD & Signal crossed below zero → First EMA Pullback SELL (Trend Confirmed)")
