//@version=6
indicator("MTF RSI Confluence (3 TFs) + Table + Alerts", overlay=false)

//----------------------------
// Inputs
//----------------------------
groupGen = "General"
src      = input.source(close, "Source", group=groupGen)
rsiLen   = input.int(14, "RSI Length", minval=1, maxval=200, group=groupGen)

groupTF1 = "Timeframe 1"
tf1      = input.timeframe("5", "TF1", group=groupTF1)
ob1      = input.float(70.0, "TF1 Overbought", minval=50.0, maxval=100.0, step=0.1, group=groupTF1)
os1      = input.float(30.0, "TF1 Oversold",  minval=0.0,  maxval=50.0,  step=0.1, group=groupTF1)

groupTF2 = "Timeframe 2"
tf2      = input.timeframe("15", "TF2", group=groupTF2)
ob2      = input.float(70.0, "TF2 Overbought", minval=50.0, maxval=100.0, step=0.1, group=groupTF2)
os2      = input.float(30.0, "TF2 Oversold",  minval=0.0,  maxval=50.0,  step=0.1, group=groupTF2)

groupTF3 = "Timeframe 3"
tf3      = input.timeframe("60", "TF3", group=groupTF3) // 1H = "60"
ob3      = input.float(70.0, "TF3 Overbought", minval=50.0, maxval=100.0, step=0.1, group=groupTF3)
os3      = input.float(30.0, "TF3 Oversold",  minval=0.0,  maxval=50.0,  step=0.1, group=groupTF3)

groupUI  = "Display"
showTable = input.bool(true, "Show Table", group=groupUI)
tblPosStr = input.string("Top Right", "Table Position", options=["Top Right","Top Left","Bottom Right","Bottom Left"], group=groupUI)

//----------------------------
// Helpers
//----------------------------
f_tblPos(string s) =>
    switch s
        "Top Left"     => position.top_left
        "Bottom Right" => position.bottom_right
        "Bottom Left"  => position.bottom_left
        => position.top_right

f_status(float r, float ob, float os) =>
    r >= ob ? 1 : r <= os ? -1 : 0

f_statusText(int st) =>
    st == 1 ? "OVERBOUGHT" : st == -1 ? "OVERSOLD" : "NEUTRAL"

f_statusColor(int st) =>
    st == 1 ? color.new(color.red, 0) : st == -1 ? color.new(color.lime, 0) : color.new(color.gray, 0)

f_cellBg(int st) =>
    st == 1 ? color.new(color.red, 85) : st == -1 ? color.new(color.lime, 85) : color.new(color.gray, 88)

//----------------------------
// MTF RSI (non-repainting via lookahead_off)
//----------------------------
rsiTf1 = request.security(syminfo.tickerid, tf1, ta.rsi(src, rsiLen), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
rsiTf2 = request.security(syminfo.tickerid, tf2, ta.rsi(src, rsiLen), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
rsiTf3 = request.security(syminfo.tickerid, tf3, ta.rsi(src, rsiLen), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)

//----------------------------
// Status + confluence signals (confirmed bars only)
//----------------------------
st1 = f_status(rsiTf1, ob1, os1)
st2 = f_status(rsiTf2, ob2, os2)
st3 = f_status(rsiTf3, ob3, os3)

allOverbought_raw = (st1 == 1) and (st2 == 1) and (st3 == 1)
allOversold_raw   = (st1 == -1) and (st2 == -1) and (st3 == -1)

// Use barstate.isconfirmed for non-repainting signals/alerts.
allOverbought = allOverbought_raw and barstate.isconfirmed
allOversold   = allOversold_raw and barstate.isconfirmed

//----------------------------
// Plots
//----------------------------
plot(rsiTf1, "RSI TF1", color=f_statusColor(st1), linewidth=2)
plot(rsiTf2, "RSI TF2", color=f_statusColor(st2), linewidth=2)
plot(rsiTf3, "RSI TF3", color=f_statusColor(st3), linewidth=2)

hline(70, "70", color=color.new(color.red, 70))
hline(50, "50", color=color.new(color.gray, 75))
hline(30, "30", color=color.new(color.lime, 70))

bgcolor(allOverbought ? color.new(color.red, 88) : allOversold ? color.new(color.lime, 88) : na, title="Confluence background")

//----------------------------
// Table
//----------------------------
var table t = na
if barstate.isfirst and showTable
    t := table.new(f_tblPos(tblPosStr), 4, 4, frame_color=color.new(color.gray, 70), border_color=color.new(color.gray, 70))
    table.cell(t, 0, 0, "TF", text_color=color.white, bgcolor=color.new(color.black, 0))
    table.cell(t, 1, 0, "RSI", text_color=color.white, bgcolor=color.new(color.black, 0))
    table.cell(t, 2, 0, "Status", text_color=color.white, bgcolor=color.new(color.black, 0))
    table.cell(t, 3, 0, "OB/OS", text_color=color.white, bgcolor=color.new(color.black, 0))

if barstate.islast
    if showTable
        if na(t)
            t := table.new(f_tblPos(tblPosStr), 4, 4, frame_color=color.new(color.gray, 70), border_color=color.new(color.gray, 70))
        // Row 1
        table.cell(t, 0, 1, tf1, text_color=color.white, bgcolor=color.new(color.black, 0))
        table.cell(t, 1, 1, str.tostring(rsiTf1, "#.##"), text_color=color.white, bgcolor=f_cellBg(st1))
        table.cell(t, 2, 1, f_statusText(st1), text_color=color.white, bgcolor=f_cellBg(st1))
        table.cell(t, 3, 1, str.tostring(ob1, "#.##") + " / " + str.tostring(os1, "#.##"), text_color=color.white, bgcolor=color.new(color.black, 0))
        // Row 2
        table.cell(t, 0, 2, tf2, text_color=color.white, bgcolor=color.new(color.black, 0))
        table.cell(t, 1, 2, str.tostring(rsiTf2, "#.##"), text_color=color.white, bgcolor=f_cellBg(st2))
        table.cell(t, 2, 2, f_statusText(st2), text_color=color.white, bgcolor=f_cellBg(st2))
        table.cell(t, 3, 2, str.tostring(ob2, "#.##") + " / " + str.tostring(os2, "#.##"), text_color=color.white, bgcolor=color.new(color.black, 0))
        // Row 3
        table.cell(t, 0, 3, tf3, text_color=color.white, bgcolor=color.new(color.black, 0))
        table.cell(t, 1, 3, str.tostring(rsiTf3, "#.##"), text_color=color.white, bgcolor=f_cellBg(st3))
        table.cell(t, 2, 3, f_statusText(st3), text_color=color.white, bgcolor=f_cellBg(st3))
        table.cell(t, 3, 3, str.tostring(ob3, "#.##") + " / " + str.tostring(os3, "#.##"), text_color=color.white, bgcolor=color.new(color.black, 0))
    else
        if not na(t)
            table.delete(t)
            t := na

//----------------------------
// Alerts
//----------------------------
alertcondition(allOversold,   title="MTF RSI: All Oversold (Confirmed)",   message="MTF RSI confluence: All 3 timeframes OVERSOLD (confirmed bar).")
alertcondition(allOverbought, title="MTF RSI: All Overbought (Confirmed)", message="MTF RSI confluence: All 3 timeframes OVERBOUGHT (confirmed bar).")
