// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © officialjackofalltrades

//@version=6
indicator("Zenith MACD Evolution", shorttitle="ZME [JOAT]", overlay=false, precision=2)

// ══════════════════════════════════════════════════════════════════════════════
// ZENITH MACD EVOLUTION - Volatility-Normalized Momentum Oscillator
// Advanced MACD with ATR normalization and divergence detection
// ══════════════════════════════════════════════════════════════════════════════

// ─────────────────────────────────────────────────────────────────────────────
// INPUTS
// ─────────────────────────────────────────────────────────────────────────────

var grpMACD = " MACD Settings"
int fastLength = input.int(12, "Fast EMA Length", minval=2, maxval=50, group=grpMACD)
int slowLength = input.int(26, "Slow EMA Length", minval=5, maxval=100, group=grpMACD)
int signalLength = input.int(9, "Signal Length", minval=2, maxval=30, group=grpMACD)
int atrNormLength = input.int(26, "ATR Normalization Period", minval=10, maxval=50, group=grpMACD)

var grpLevels = " Level Settings"
float overboughtLevel = input.float(150, "Overbought Zone", minval=50, maxval=300, step=10, group=grpLevels)
float oversoldLevel = input.float(-150, "Oversold Zone", minval=-300, maxval=-50, step=10, group=grpLevels)
float extremeLevel = input.float(200, "Extreme Level", minval=100, maxval=400, step=10, group=grpLevels)

var grpSignals = " Signal Options"
bool showClassicMACD = input.bool(false, "Show Classic MACD Lines", group=grpSignals)
bool showDivergence = input.bool(true, "Show Divergence Detection", group=grpSignals)
bool showCrossovers = input.bool(true, "Show Crossover Signals", group=grpSignals)
bool showMomentumShift = input.bool(true, "Show Momentum Shift", group=grpSignals)
int divergenceLookback = input.int(14, "Divergence Lookback", minval=5, maxval=30, group=grpSignals)

var grpColors = " Color Theme"
color histBullStrong = input.color(color.new(#26A69A, 0), "Histogram Bull Strong", group=grpColors)
color histBullWeak = input.color(color.new(#B2DFDB, 0), "Histogram Bull Weak", group=grpColors)
color histBearStrong = input.color(color.new(#FF5252, 0), "Histogram Bear Strong", group=grpColors)
color histBearWeak = input.color(color.new(#FFCDD2, 0), "Histogram Bear Weak", group=grpColors)
color macdLineColor = input.color(color.new(#2196F3, 0), "MACD Line", group=grpColors)
color signalLineColor = input.color(color.new(#FF9800, 0), "Signal Line", group=grpColors)
color overboughtColor = input.color(color.new(#E91E63, 0), "Overbought Signal", group=grpColors)
color oversoldColor = input.color(color.new(#00BCD4, 0), "Oversold Signal", group=grpColors)
color bullDivColor = input.color(color.new(#0A1C2C, 0), "Bullish Divergence", group=grpSignals)
color bearDivColor = input.color(color.new(#1E0E18, 0), "Bearish Divergence", group=grpSignals)

// ─────────────────────────────────────────────────────────────────────────────
// MACD CALCULATIONS
// ─────────────────────────────────────────────────────────────────────────────

// Classic MACD
[macdLine, signalLine, histLine] = ta.macd(close, fastLength, slowLength, signalLength)

// ATR for normalization
float atrValue = ta.atr(atrNormLength)

// Volatility-Normalized MACD (MACD-V concept)
float zenithMACD = atrValue != 0 ? (histLine / atrValue) * 100 : 0
float zenithSignal = ta.ema(zenithMACD, signalLength)
float zenithHist = zenithMACD

// Momentum direction and strength
bool histRising = zenithHist > zenithHist[1]
bool histFalling = zenithHist < zenithHist[1]

// Dynamic histogram coloring
color histColor = zenithHist >= 0 ? (histRising ? histBullStrong : histBullWeak) : (histFalling ? histBearStrong : histBearWeak)

// ─────────────────────────────────────────────────────────────────────────────
// LEVEL DETECTION
// ─────────────────────────────────────────────────────────────────────────────

bool isOverbought = zenithMACD > overboughtLevel
bool isOversold = zenithMACD < oversoldLevel
bool isExtremeBull = zenithMACD > extremeLevel
bool isExtremeBear = zenithMACD < -extremeLevel

// Zone transitions
bool enterOverbought = isOverbought and not isOverbought[1]
bool exitOverbought = not isOverbought and isOverbought[1]
bool enterOversold = isOversold and not isOversold[1]
bool exitOversold = not isOversold and isOversold[1]

// ─────────────────────────────────────────────────────────────────────────────
// CROSSOVER DETECTION
// ─────────────────────────────────────────────────────────────────────────────

bool zeroCrossUp = ta.crossover(zenithMACD, 0.0)
bool zeroCrossDn = ta.crossunder(zenithMACD, 0.0)
bool signalCrossUp = ta.crossover(macdLine, signalLine)
bool signalCrossDn = ta.crossunder(macdLine, signalLine)

// Momentum shift (histogram direction change)
bool momentumShiftBull = zenithHist > 0 and histRising and not histRising[1]
bool momentumShiftBear = zenithHist < 0 and histFalling and not histFalling[1]

// ─────────────────────────────────────────────────────────────────────────────
// DIVERGENCE DETECTION
// ─────────────────────────────────────────────────────────────────────────────

// Find pivot lows in price and MACD for bullish divergence
float priceLow = ta.lowest(low, divergenceLookback)
float macdLow = ta.lowest(zenithMACD, divergenceLookback)

// Find pivot highs in price and MACD for bearish divergence
float priceHigh = ta.highest(high, divergenceLookback)
float macdHigh = ta.highest(zenithMACD, divergenceLookback)

// Simple divergence logic
bool bullishDivergence = showDivergence and 
                          low <= priceLow and 
                          zenithMACD > macdLow and 
                          zenithMACD < 0 and
                          zenithMACD > zenithMACD[1]

bool bearishDivergence = showDivergence and 
                          high >= priceHigh and 
                          zenithMACD < macdHigh and 
                          zenithMACD > 0 and
                          zenithMACD < zenithMACD[1]

// ─────────────────────────────────────────────────────────────────────────────
// VISUALIZATION - HISTOGRAM
// ─────────────────────────────────────────────────────────────────────────────

plot(zenithHist, "Zenith Histogram", color=histColor, style=plot.style_columns, linewidth=2)

// ─────────────────────────────────────────────────────────────────────────────
// VISUALIZATION - CLASSIC LINES (Optional)
// ─────────────────────────────────────────────────────────────────────────────

plot(showClassicMACD ? zenithMACD : na, "Zenith MACD", color=macdLineColor, linewidth=2)
plot(showClassicMACD ? zenithSignal : na, "Zenith Signal", color=signalLineColor, linewidth=1)

// ─────────────────────────────────────────────────────────────────────────────
// VISUALIZATION - LEVELS
// ─────────────────────────────────────────────────────────────────────────────

hline(0, "Zero Line", color=color.new(#607D8B, 50), linestyle=hline.style_solid, linewidth=1)
hline(overboughtLevel, "Overbought", color=color.new(overboughtColor, 50), linestyle=hline.style_dashed)
hline(oversoldLevel, "Oversold", color=color.new(oversoldColor, 50), linestyle=hline.style_dashed)
hline(extremeLevel, "Extreme High", color=color.new(#F44336, 70), linestyle=hline.style_dotted)
hline(-extremeLevel, "Extreme Low", color=color.new(#4CAF50, 70), linestyle=hline.style_dotted)

// ─────────────────────────────────────────────────────────────────────────────
// VISUALIZATION - SIGNALS
// ─────────────────────────────────────────────────────────────────────────────

// Overbought/Oversold markers
plotshape(isExtremeBull ? zenithMACD * 1.05 : na, "Extreme Bull", shape.circle, location.absolute, overboughtColor, size=size.tiny)
plotshape(isExtremeBear ? zenithMACD * 1.05 : na, "Extreme Bear", shape.circle, location.absolute, oversoldColor, size=size.tiny)

// Crossover signals
plotshape(showCrossovers and zeroCrossUp ? 0 : na, "Zero Cross Up", shape.triangleup, location.absolute, color.new(#00E676, 0), size=size.tiny)
plotshape(showCrossovers and zeroCrossDn ? 0 : na, "Zero Cross Down", shape.triangledown, location.absolute, color.new(#FF5252, 0), size=size.tiny)

// Momentum shift signals
plotshape(showMomentumShift and momentumShiftBull ? zenithHist : na, "Mom Shift Bull", shape.diamond, location.absolute, color.new(#00BCD4, 0), size=size.tiny)
plotshape(showMomentumShift and momentumShiftBear ? zenithHist : na, "Mom Shift Bear", shape.diamond, location.absolute, color.new(#FF9800, 0), size=size.tiny)

// Divergence signals
plotshape(bullishDivergence ? zenithMACD : na, "Bull Divergence", shape.labelup, location.absolute, bullDivColor, size=size.tiny, text="DIV", textcolor=color.white)
plotshape(bearishDivergence ? zenithMACD : na, "Bear Divergence", shape.labeldown, location.absolute, bearDivColor, size=size.tiny, text="DIV", textcolor=color.white)

// ─────────────────────────────────────────────────────────────────────────────
// BACKGROUND HIGHLIGHTING
// ─────────────────────────────────────────────────────────────────────────────

bgcolor(isExtremeBull ? color.new(overboughtColor, 90) : na, title="Extreme Bull BG")
bgcolor(isExtremeBear ? color.new(oversoldColor, 90) : na, title="Extreme Bear BG")

// ─────────────────────────────────────────────────────────────────────────────
// INFO DASHBOARD
// ─────────────────────────────────────────────────────────────────────────────

var table zenithPanel = table.new(position.top_right, 3, 7, bgcolor=color.new(#05050A, 12), border_width=2, border_color=color.new(#5E2E91, 40))

if barstate.islast
    color headerBg = color.new(#1E88E5, 10)
    color labelBg = color.new(#0E111B, 70)
    color valueBg = color.new(#080C14, 60)
    color detailBg = color.new(#04070B, 80)
    
    // Header
    table.cell(zenithPanel, 0, 0, "ZENITH MACD", text_color=color.white, text_size=size.large, bgcolor=headerBg)
    table.cell(zenithPanel, 1, 0, "Value", text_color=color.white, text_size=size.small, bgcolor=color.new(#0D47A1, 40))
    table.cell(zenithPanel, 2, 0, "Detail", text_color=color.white, text_size=size.small, bgcolor=color.new(#0D47A1, 40))
    
    // Zenith Value
    table.cell(zenithPanel, 0, 1, "Zenith", text_color=color.gray, text_size=size.small, bgcolor=labelBg)
    table.cell(zenithPanel, 1, 1, str.tostring(zenithMACD, "#.#"), text_color=histColor, text_size=size.normal, bgcolor=valueBg)
    table.cell(zenithPanel, 2, 1, "Signal " + str.tostring(zenithSignal, "#.#"), text_color=histColor, text_size=size.small, bgcolor=detailBg)
    
    // Zone Status
    string zoneStatus = isExtremeBull ? " EXTREME OB" : 
                         isExtremeBear ? " EXTREME OS" :
                         isOverbought ? " OVERBOUGHT" : 
                         isOversold ? " OVERSOLD" : " NORMAL"
    color zoneColor = isOverbought or isExtremeBull ? overboughtColor : 
                       isOversold or isExtremeBear ? oversoldColor : color.green
    table.cell(zenithPanel, 0, 2, "Zone", text_color=color.gray, text_size=size.small, bgcolor=labelBg)
    table.cell(zenithPanel, 1, 2, zoneStatus, text_color=zoneColor, text_size=size.normal, bgcolor=valueBg)
    table.cell(zenithPanel, 2, 2, isExtremeBull ? "Trim Risk" : isExtremeBear ? "Accumulation" : "Monitor", text_color=zoneColor, text_size=size.small, bgcolor=detailBg)
    
    // Momentum Direction
    string momDir = histRising ? "RISING" : histFalling ? "FALLING" : "FLAT"
    color momColor = histRising ? histBullStrong : histFalling ? histBearStrong : color.gray
    table.cell(zenithPanel, 0, 3, "Momentum", text_color=color.gray, text_size=size.small, bgcolor=labelBg)
    table.cell(zenithPanel, 1, 3, momDir, text_color=momColor, text_size=size.normal, bgcolor=valueBg)
    table.cell(zenithPanel, 2, 3, histRising ? "Accel ↑" : histFalling ? "Cooling ↓" : "Balanced", text_color=momColor, text_size=size.small, bgcolor=detailBg)
    
    // Histogram Value
    table.cell(zenithPanel, 0, 4, "Histogram", text_color=color.gray, text_size=size.small, bgcolor=labelBg)
    table.cell(zenithPanel, 1, 4, str.tostring(zenithHist, "#.#"), text_color=histColor, text_size=size.normal, bgcolor=valueBg)
    table.cell(zenithPanel, 2, 4, "Δ " + str.tostring(zenithMACD - zenithSignal, "#.#"), text_color=histColor, text_size=size.small, bgcolor=detailBg)
    
    // ATR Value
    table.cell(zenithPanel, 0, 5, "ATR Norm", text_color=color.gray, text_size=size.small, bgcolor=labelBg)
    table.cell(zenithPanel, 1, 5, str.tostring(atrValue, format.mintick), text_color=color.white, text_size=size.normal, bgcolor=valueBg)
    table.cell(zenithPanel, 2, 5, str.tostring(atrNormLength) + " bars", text_color=color.gray, text_size=size.small, bgcolor=detailBg)
    
    // Classic MACD
    table.cell(zenithPanel, 0, 6, "Classic", text_color=color.gray, text_size=size.small, bgcolor=labelBg)
    table.cell(zenithPanel, 1, 6, str.tostring(macdLine, "#.####"), text_color=macdLineColor, text_size=size.normal, bgcolor=valueBg)
    table.cell(zenithPanel, 2, 6, "Signal " + str.tostring(signalLine, "#.####"), text_color=signalLineColor, text_size=size.small, bgcolor=detailBg)

// ─────────────────────────────────────────────────────────────────────────────
// ALERTS
// ─────────────────────────────────────────────────────────────────────────────

alertcondition(zeroCrossUp, "Zero Cross Up", "Zenith MACD: Bullish zero line cross!")
alertcondition(zeroCrossDn, "Zero Cross Down", "Zenith MACD: Bearish zero line cross!")
alertcondition(enterOverbought, "Enter Overbought", "Zenith MACD: Entering overbought zone!")
alertcondition(enterOversold, "Enter Oversold", "Zenith MACD: Entering oversold zone!")
alertcondition(exitOverbought, "Exit Overbought", "Zenith MACD: Exiting overbought - potential sell!")
alertcondition(exitOversold, "Exit Oversold", "Zenith MACD: Exiting oversold - potential buy!")
alertcondition(bullishDivergence, "Bullish Divergence", "Zenith MACD: Bullish divergence detected!")
alertcondition(bearishDivergence, "Bearish Divergence", "Zenith MACD: Bearish divergence detected!")
alertcondition(momentumShiftBull, "Momentum Shift Bull", "Zenith MACD: Bullish momentum shift!")
alertcondition(momentumShiftBear, "Momentum Shift Bear", "Zenith MACD: Bearish momentum shift!")
