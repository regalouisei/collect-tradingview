// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © @thebitcoinfrontier
//@version=6
indicator("Average Sentiment Oscillator", shorttitle="Advanced ASO (lead)")

// ================================
// === ORIGINAL ASO (UNVERÄNDERT)
// ================================

length = input.int(10, "Period?", minval=1, maxval=100)
mode   = input.int(0, "Calculation Method:", minval=0, maxval=20)

intrarange = high - low
grouplow   = ta.lowest(low, length)
grouphigh  = ta.highest(high, length)
groupopen  = open[length - 1]
grouprange = grouphigh - grouplow

K1 = intrarange == 0 ? 1 : intrarange
K2 = grouprange == 0 ? 1 : grouprange

intrabarbulls = ((((close - low) + (high - open)) / 2) * 100) / K1
groupbulls    = ((((close - grouplow) + (grouphigh - groupopen)) / 2) * 100) / K2

intrabarbears = ((((high - close) + (open - low)) / 2) * 100) / K1
groupbears    = ((((grouphigh - close) + (groupopen - grouplow)) / 2) * 100) / K2

TempBufferBulls = mode == 0 ? (intrabarbulls + groupbulls) / 2 : mode == 1 ? intrabarbulls : groupbulls
TempBufferBears = mode == 0 ? (intrabarbears + groupbears) / 2 : mode == 1 ? intrabarbears : groupbears

ASOBulls = ta.sma(TempBufferBulls, length)
ASOBears = ta.sma(TempBufferBears, length)

// Original ASO
plot(ASOBulls, color=color.blue, linewidth=1, title="ASO Bulls")
plot(ASOBears, color=color.red, linewidth=1, title="ASO Bears")

// ================================
// === ASO LEAD / LAG
// ================================

showASOLead = input.bool(false, "Show ASO Lead / Lag")
asoLeadBars = input.int(0, "ASO Lead Bars (+Lead / -Lag)")

ASOBullsLead = ASOBulls[asoLeadBars]
ASOBearsLead = ASOBears[asoLeadBars]

plot(showASOLead ? ASOBullsLead : na, "ASO Bulls Lead", color.new(color.blue, 60), 1)
plot(showASOLead ? ASOBearsLead : na, "ASO Bears Lead", color.new(color.red, 60), 1)

// ================================
// === ASO DELTA
// ================================

showASODelta = input.bool(false, "Show ASO Delta (Lead - Normal)")

ASODelta = ASOBullsLead - ASOBulls
plot(showASODelta ? ASODelta : na, "ASO Delta", color.yellow, 2)
hline(0, "Delta Zero Line", color.gray, hline.style_dotted)

// ================================
// === ZYKLUS EINSTELLUNGEN
// ================================

showSin = input.bool(true, "Show Sinus")
showCos = input.bool(false, "Show Cosinus")
showFib = input.bool(false, "Show Fib Sinus")

cycleLen  = input.int(120, "Cycle Length (Bars)", minval=10)
fibLevel  = input.float(1.618, "Fib Level")
phaseShift = input.int(0, "Phase Shift (Bars)", minval=-25, maxval=25)

// ================================
// === ASO FILTER
// ================================

useASOFilter = input.bool(false, "Use ASO Extrem Filter")
upperLevel   = input.int(70, "ASO Upper Level")
lowerLevel   = input.int(30, "ASO Lower Level")

asoExtreme = ASOBulls > upperLevel or ASOBears < lowerLevel
asoGate    = useASOFilter ? asoExtreme : true

// ================================
// === MTF
// ================================

useMTF = input.bool(false, "Use Higher Timeframe Cycle")
mtfTF  = input.timeframe("M", "MTF Timeframe")

mtfIndex = request.security(syminfo.tickerid, mtfTF, bar_index)

// ================================
// === PHASEN ROTATION
// ================================

useRotation = input.bool(false, "Use Phase Rotation")
rotationOpt = input.string("0°", "Rotation Angle", options=["0°","90°","180°","270°"])

rotation = rotationOpt == "90°" ? math.pi/2 :
           rotationOpt == "180°" ? math.pi :
           rotationOpt == "270°" ? math.pi*1.5 : 0.0

// ================================
// === PHASENBERECHNUNG
// ================================

idx = useMTF ? mtfIndex : bar_index
basePhase = 2 * math.pi * (idx + phaseShift) / cycleLen
phase = useRotation ? basePhase + rotation : basePhase

// ================================
// === ZYKLUS KURVEN
// ================================

baseAmp = 50.0

sinCurve = math.sin(phase) * baseAmp
cosCurve = math.cos(phase) * baseAmp
fibCurve = math.sin(phase) * baseAmp * fibLevel

plot(showSin and asoGate ? sinCurve : na, "Sinus Cycle", color.green, 2)
plot(showCos and asoGate ? cosCurve : na, "Cosinus Cycle", color.orange, 2)
plot(showFib and asoGate ? fibCurve : na, "Fib Sinus Cycle", color.purple, 2)

// ================================
// === KREISPROJEKTION
// ================================

showCircle = input.bool(false, "Show Cycle Circle Projection")
circleY = math.sin(phase) * baseAmp
plot(showCircle ? circleY : na, "Cycle Circle Projection", color.aqua, 2)
