//@version=6
indicator("Weekly Confluence Setup [Final v6]", overlay=true)

// === Trend Indicators ===
ema21 = ta.ema(close, 21)
sma50 = ta.sma(close, 50)
plot(ema21, color=color.orange, title="EMA 21")
plot(sma50, color=color.blue, title="SMA 50")

// === Anchored VWAP from Recent Swing Low (Safe Access) ===
swingPeriod = input.int(20, title="Swing Low Lookback")
swingLowIndex = ta.lowestbars(low, swingPeriod)
anchorPrice = swingLowIndex >= 0 and swingLowIndex < bar_index ? close[swingLowIndex] : na
vwap = na(anchorPrice) ? na : ta.vwap(anchorPrice)
plot(vwap, title="Anchored VWAP", color=color.teal)

// === Momentum Indicators ===
rsi = ta.rsi(close, 14)
[macdLine, signalLine, macdHist] = ta.macd(close, 12, 26, 9)

// === Confluence Logic ===
validData = not na(ema21) and not na(sma50) and not na(rsi) and not na(macdHist) and not na(vwap)
bullConfluence = validData and close > ema21 and close > sma50 and rsi > 50 and macdHist > 0 and close > vwap
bearConfluence = validData and close < ema21 and close < sma50 and rsi < 50 and macdHist < 0 and close < vwap

plotshape(bullConfluence, title="Bull Confluence", location=location.belowbar, color=color.green, style=shape.triangleup, size=size.small)
plotshape(bearConfluence, title="Bear Confluence", location=location.abovebar, color=color.red, style=shape.triangledown, size=size.small)

// === Alerts ===
alertcondition(bullConfluence, title="Bullish Confluence Alert", message="Bullish confluence detected on weekly chart")
alertcondition(bearConfluence, title="Bearish Confluence Alert", message="Bearish confluence detected on weekly chart")
