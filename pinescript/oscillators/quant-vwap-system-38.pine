//@version=6
indicator("Quant Z-Score Squeeze [Gold Edition]", shorttitle="Quant Cycler", overlay=false)

// -------------------------------------------------------------------------
// 1. INPUTS
// -------------------------------------------------------------------------
grp_sq = "Squeeze Engine"
squeeze_method = input.string("Smart Hybrid (Universal)", "Squeeze Model", 
     options=["Smart Hybrid (Universal)", "Classic Ratio (Scalping)", "Quant Z-Score (Swing)"], 
     group=grp_sq)

lookback     = input.int(100, "Lookback", group=grp_sq)
z_thresh     = input.float(-0.8, "Quant Threshold (Sigma)", step=0.1, group=grp_sq)
ratio_thresh = input.float(0.8, "Classic Threshold (Ratio)", step=0.05, group=grp_sq)
min_squeeze  = input.int(1, "Min Squeeze Bars", minval=1, group=grp_sq, tooltip="Increase to 2 or 3 to filter out single-dot noise.")

// Visual Styling
grp_vis = "Visual Styling"
len    = input.int(20, "Price Length", group=grp_vis)
c_bull_strong = input.color(#00ffbb, "Bull Strong", group=grp_vis)
c_bull_weak   = input.color(#005a42, "Bull Weak", group=grp_vis)
c_bear_strong = input.color(#ff1100, "Bear Strong", group=grp_vis)
c_bear_weak   = input.color(#800000, "Bear Weak", group=grp_vis)
c_sq          = input.color(color.yellow, "Squeeze Dot", group=grp_vis)
c_zero        = input.color(color.new(#00ffbb, 30), "Zero Glow", group=grp_vis)

// -------------------------------------------------------------------------
// 2. CALCULATIONS
// -------------------------------------------------------------------------
src = close
vwap_curr = ta.sma(src, len) 
stdev = ta.stdev(src, len)

// Price Z-Score (Momentum)
price_z_score = (src - vwap_curr) / stdev

// Squeeze Data
float raw_bw = (stdev * 4) / vwap_curr 
float bw_mean  = ta.sma(raw_bw, lookback)
float bw_stdev = ta.stdev(raw_bw, lookback)
float bw_z_score = (raw_bw - bw_mean) / bw_stdev
float bw_ratio_avg = ta.sma(raw_bw, 20)

// -------------------------------------------------------------------------
// 3. LOGIC SELECTION
// -------------------------------------------------------------------------
bool is_squeeze = false

// Engines
bool sq_quant = bw_z_score < z_thresh
bool sq_classic = raw_bw < (bw_ratio_avg * ratio_thresh)
// Hybrid: Classic Ratio OR Extreme Z-Score (-1.0)
bool sq_hybrid = sq_classic or (bw_z_score < -1.0)

// Selection
if squeeze_method == "Quant Z-Score (Swing)"
    is_squeeze := sq_quant
else if squeeze_method == "Classic Ratio (Scalping)"
    is_squeeze := sq_classic
else
    is_squeeze := sq_hybrid

// Noise Filter (FIXED: Added int() cast)
// math.sum returns a float, so we must cast it to int before assigning
int sq_count = int(math.sum(is_squeeze ? 1 : 0, min_squeeze))
bool is_valid_squeeze = sq_count >= min_squeeze

bool squeeze_fired = is_valid_squeeze[1] and not is_valid_squeeze

// -------------------------------------------------------------------------
// 4. ADVANCED COLORING
// -------------------------------------------------------------------------
// 4-State Momentum Logic
bool up = price_z_score > price_z_score[1]
bool positive = price_z_score > 0

color final_color = color.gray
if positive
    final_color := up ? c_bull_strong : c_bull_weak
else
    final_color := up ? c_bear_weak : c_bear_strong

// -------------------------------------------------------------------------
// 5. PLOTTING
// -------------------------------------------------------------------------
// Zones
h2 = hline(2, "Top Zone Start", color=color.new(color.gray, 100))
h3 = hline(3, "Top Zone End", color=color.new(color.gray, 100))
fill(h2, h3, color=color.new(c_bear_strong, 85), title="Bear Zone")

l2 = hline(-2, "Bot Zone Start", color=color.new(color.gray, 100))
l3 = hline(-3, "Bot Zone End", color=color.new(color.gray, 100))
fill(l2, l3, color=color.new(c_bull_strong, 85), title="Bull Zone")

// Zero Line
plot(0, "Zero Base", color=c_zero, linewidth=3)

// Main Line
plot(price_z_score, "Momentum", color=final_color, linewidth=2)

// Squeeze Dots
plot(is_valid_squeeze ? 0 : na, "Squeeze Active", color=c_sq, style=plot.style_circles, linewidth=5)

// Firing Signals
plotshape(squeeze_fired ? 0 : na, "Squeeze Fired", style=shape.diamond, location=location.absolute, color=color.white, size=size.tiny)

// -------------------------------------------------------------------------
// 6. ALERTS
// -------------------------------------------------------------------------
alertcondition(squeeze_fired, title="Squeeze Fired", message="Volatility Squeeze has fired!")
