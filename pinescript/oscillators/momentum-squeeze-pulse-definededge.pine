// This Pine Scriptâ„¢ code is subject to the terms of the Mozilla Public License 2.0
// Â© DefinedEdge
// https://mozilla.org/MPL/2.0/

//@version=5
indicator("Momentum Squeeze Pulse [DefinedEdge]",
     shorttitle = "Squeeze Pulse",
     overlay    = false,
     max_labels_count = 500)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MOMENTUM SQUEEZE PULSE [DefinedEdge]
//  Modern volatility compression detector with gradient momentum
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€ INPUTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string GRP_SQZ = "ğŸ”· Squeeze Detection"
int    i_bbLen    = input.int(20, "BB Length", minval=5, maxval=50, group=GRP_SQZ, tooltip="Bollinger Bands lookback. Standard: 20")
float  i_bbMult   = input.float(2.0, "BB Multiplier", minval=0.5, maxval=4.0, step=0.1, group=GRP_SQZ)
int    i_kcLen    = input.int(20, "KC Length", minval=5, maxval=50, group=GRP_SQZ, tooltip="Keltner Channel lookback. Standard: 20")
float  i_kcMultHi = input.float(1.0, "KC Tight Mult (High Squeeze)", minval=0.5, maxval=3.0, step=0.1, group=GRP_SQZ, tooltip="Tightest KC band. BB inside this = maximum compression")
float  i_kcMultMd = input.float(1.5, "KC Mid Mult (Mid Squeeze)", minval=0.5, maxval=3.0, step=0.1, group=GRP_SQZ)
float  i_kcMultLo = input.float(2.0, "KC Wide Mult (Low Squeeze)", minval=0.5, maxval=3.0, step=0.1, group=GRP_SQZ, tooltip="Widest KC band. BB inside this = mild compression")
int    i_minSqzLen = input.int(8, "Min Squeeze Duration (bars)", minval=1, maxval=50, group=GRP_SQZ, tooltip="Squeeze must last at least this many bars before FIRE signal is valid. Filters out weak micro-squeezes")

string GRP_MOM = "ğŸ”· Momentum"
int    i_momLen    = input.int(20, "Momentum Length", minval=5, maxval=50, group=GRP_MOM, tooltip="Linear regression length for momentum calculation")
int    i_momSmooth = input.int(5, "Pulse Line Smoothing", minval=2, maxval=20, group=GRP_MOM, tooltip="EMA smoothing for the pulse overlay line")

string GRP_VIZ = "ğŸ”· Display"
bool   i_showPulse   = input.bool(true, "Show Pulse Line", group=GRP_VIZ)
bool   i_showSignals = input.bool(true, "Show Fire Signals", group=GRP_VIZ)
bool   i_showDiverg  = input.bool(true, "Show Divergences", group=GRP_VIZ)
bool   i_showDash    = input.bool(true, "Show Dashboard", group=GRP_VIZ)

string GRP_COL = "ğŸ¨ Colors"
color  i_bullHot  = input.color(#00ff88, "Bull Accelerating", group=GRP_COL)
color  i_bullCool = input.color(#00bcd4, "Bull Decelerating", group=GRP_COL)
color  i_bearHot  = input.color(#ff0040, "Bear Accelerating", group=GRP_COL)
color  i_bearCool = input.color(#e040fb, "Bear Decelerating", group=GRP_COL)

string GRP_ALR = "ğŸ”” Alerts"
bool   i_alertFire = input.bool(true, "Squeeze Fire", group=GRP_ALR)
bool   i_alertFlip = input.bool(true, "Momentum Flip", group=GRP_ALR)
bool   i_alertDiv  = input.bool(true, "Divergence", group=GRP_ALR)

// â”€â”€â”€ SQUEEZE CALCULATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Bollinger Bands
float bbBasis = ta.sma(close, i_bbLen)
float bbDev   = i_bbMult * ta.stdev(close, i_bbLen)
float bbUpper = bbBasis + bbDev
float bbLower = bbBasis - bbDev

// Keltner Channels â€” three widths for squeeze intensity
float kcBasis = ta.sma(close, i_kcLen)
float atrVal  = ta.atr(i_kcLen)

// High squeeze (tightest KC)
float kcUpHi = kcBasis + i_kcMultHi * nz(atrVal)
float kcLoHi = kcBasis - i_kcMultHi * nz(atrVal)
// Mid squeeze
float kcUpMd = kcBasis + i_kcMultMd * nz(atrVal)
float kcLoMd = kcBasis - i_kcMultMd * nz(atrVal)
// Low squeeze (widest KC)
float kcUpLo = kcBasis + i_kcMultLo * nz(atrVal)
float kcLoLo = kcBasis - i_kcMultLo * nz(atrVal)

// Squeeze = BB fits inside KC
bool sqzHigh = bbUpper < kcUpHi and bbLower > kcLoHi
bool sqzMid  = bbUpper < kcUpMd and bbLower > kcLoMd
bool sqzLow  = bbUpper < kcUpLo and bbLower > kcLoLo
bool sqzOn   = sqzLow
bool sqzOff  = not sqzLow

// Intensity: 0=off, 1=low, 2=mid, 3=high
int sqzLevel = sqzHigh ? 3 : sqzMid ? 2 : sqzLow ? 1 : 0

// â”€â”€â”€ MOMENTUM CALCULATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

float highestHi = ta.highest(high, i_momLen)
float lowestLo  = ta.lowest(low, i_momLen)
float midline   = math.avg(math.avg(highestHi, lowestLo), ta.sma(close, i_momLen))
float mom       = ta.linreg(close - midline, i_momLen, 0)
float momEMA    = ta.ema(mom, i_momSmooth)

// Momentum state
bool momRising  = mom > nz(mom[1])
bool momFalling = mom < nz(mom[1])

// Normalized strength (0â€“100) for dashboard
float momAbs = math.abs(mom)
float momMax = ta.highest(momAbs, 200)
float momPct = momMax > 0 ? momAbs / momMax * 100.0 : 0.0

// â”€â”€â”€ SIGNAL DETECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Squeeze tracking (must be before fire detection)
var int sqzDuration      = 0
var int totalSqzDuration = 0
var int sqzCount         = 0
var int lastFireBar      = 0
var int lastFireDir      = 0

if sqzOn
    sqzDuration += 1

if sqzOff and sqzOn[1]
    sqzCount         += 1
    totalSqzDuration += sqzDuration

// Squeeze fire: transition from ON â†’ OFF (confirmed bar only) + minimum duration
bool sqzFire  = sqzOff and sqzOn[1] and sqzDuration >= i_minSqzLen and barstate.isconfirmed
bool bullFire = sqzFire and mom > 0
bool bearFire = sqzFire and mom < 0

// Reset duration after fire check
if sqzOff and sqzOn[1]
    sqzDuration := 0

// Momentum zero-line cross
bool momFlipBull = mom > 0 and mom[1] <= 0 and barstate.isconfirmed
bool momFlipBear = mom < 0 and mom[1] >= 0 and barstate.isconfirmed

// â”€â”€â”€ SQUEEZE TRACKING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if sqzFire
    lastFireBar := bar_index
    lastFireDir := mom > 0 ? 1 : -1

float avgSqzDur = sqzCount > 0 ? totalSqzDuration * 1.0 / sqzCount * 1.0 : 0.0

// Pressure gauge: duration Ã— intensity (higher = bigger expected move)
float pressure    = sqzOn ? sqzDuration * sqzLevel * 1.0 : 0.0
string pressureLbl = pressure >= 20 ? "EXTREME" : pressure >= 12 ? "HIGH" : pressure >= 6 ? "BUILDING" : pressure > 0 ? "LOW" : "â€”"
color  pressureCol = pressure >= 20 ? #ff0040 : pressure >= 12 ? #ff9800 : pressure >= 6 ? #ffeb3b : pressure > 0 ? #8b949e : #30363d

// â”€â”€â”€ DIVERGENCE DETECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

float momPH = ta.pivothigh(mom, 5, 5)
float momPL = ta.pivotlow(mom, 5, 5)

var float prevMomPH     = na
var float prevPrcAtPH   = na
var float prevMomPL     = na
var float prevPrcAtPL   = na

bool bearDiv = false
bool bullDiv = false

if not na(momPH)
    float prcHere = high[5]
    if not na(prevMomPH) and not na(prevPrcAtPH)
        if prcHere > prevPrcAtPH and momPH < prevMomPH
            bearDiv := true
    prevMomPH   := momPH
    prevPrcAtPH := prcHere

if not na(momPL)
    float prcHere = low[5]
    if not na(prevMomPL) and not na(prevPrcAtPL)
        if prcHere < prevPrcAtPL and momPL > prevMomPL
            bullDiv := true
    prevMomPL   := momPL
    prevPrcAtPL := prcHere

// â”€â”€â”€ COLOR ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

float gradVal = momMax > 0 ? math.min(momAbs / momMax, 1.0) : 0.0

color momColor = na
if mom >= 0
    if momRising
        momColor := color.from_gradient(gradVal, 0.0, 1.0, color.new(#0d3b2e, 30), i_bullHot)
    else
        momColor := color.from_gradient(gradVal, 0.0, 1.0, color.new(#0d2b3e, 50), i_bullCool)
else
    if momFalling
        momColor := color.from_gradient(gradVal, 0.0, 1.0, color.new(#3b0d1e, 30), i_bearHot)
    else
        momColor := color.from_gradient(gradVal, 0.0, 1.0, color.new(#2b0d3e, 50), i_bearCool)

// Squeeze dot colors
color dotColor = sqzHigh ? #ff0040 : sqzMid ? #ff9800 : sqzLow ? #ffeb3b : #00ff88
if sqzFire
    dotColor := color.white

// â”€â”€â”€ PLOTTING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Momentum histogram (gradient bars)
plot(mom, title="Momentum", style=plot.style_columns, color=momColor, linewidth=3)

// Pulse line
plot(i_showPulse ? momEMA : na, title="Pulse Line", color=color.new(color.white, 30), linewidth=2)

// Zero line
hline(0, "Zero", color=color.new(#30363d, 50), linestyle=hline.style_solid, linewidth=1)

// Squeeze intensity dots (on zero line)
plot(0, title="Squeeze Dots", style=plot.style_circles, color=dotColor, linewidth=4)

// Fire signals
plotshape(i_showSignals and bullFire, title="Bull Fire", location=location.bottom, style=shape.triangleup, color=#00ff88, size=size.small, text="FIRE", textcolor=#00ff88)
plotshape(i_showSignals and bearFire, title="Bear Fire", location=location.top, style=shape.triangledown, color=#ff0040, size=size.small, text="FIRE", textcolor=#ff0040)

// Momentum flip markers
plotshape(i_showSignals and momFlipBull, title="Mom Flip Bull", location=location.bottom, style=shape.circle, color=color.new(#00ff88, 50), size=size.tiny)
plotshape(i_showSignals and momFlipBear, title="Mom Flip Bear", location=location.top, style=shape.circle, color=color.new(#ff0040, 50), size=size.tiny)

// Divergence labels (placed at the pivot bar)
plotshape(i_showDiverg and bearDiv ? momPH : na, title="Bear Divergence", location=location.absolute, style=shape.diamond, color=#ff9800, size=size.tiny, text="DIV", textcolor=#ff9800, offset=-5)
plotshape(i_showDiverg and bullDiv ? momPL : na, title="Bull Divergence", location=location.absolute, style=shape.diamond, color=#00bcd4, size=size.tiny, text="DIV", textcolor=#00bcd4, offset=-5)

// â”€â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if i_showDash and barstate.islast
    var table dash = table.new(position.top_right, 3, 8, bgcolor=color.new(#0d1117, 0), border_width=1, border_color=color.new(#30363d, 0))

    // Row 0: Header
    table.cell(dash, 0, 0, "SQUEEZE PULSE", text_color=#00e5ff, text_size=size.normal, text_halign=text.align_left)
    table.merge_cells(dash, 0, 0, 1, 0)
    table.cell(dash, 2, 0, "DefinedEdge", text_color=color.new(#00e5ff, 50), text_size=size.normal, text_halign=text.align_right)

    // Row 1: Squeeze State
    string sqzStateTxt = sqzHigh ? "ğŸ”´ HIGH SQUEEZE" : sqzMid ? "ğŸŸ  MID SQUEEZE" : sqzLow ? "ğŸŸ¡ LOW SQUEEZE" : "ğŸŸ¢ NO SQUEEZE"
    color  sqzStateCol = sqzHigh ? #ff0040 : sqzMid ? #ff9800 : sqzLow ? #ffeb3b : #00ff88
    table.cell(dash, 0, 1, "State", text_color=#8b949e, text_size=size.normal, text_halign=text.align_left)
    table.cell(dash, 1, 1, sqzStateTxt, text_color=sqzStateCol, text_size=size.normal, text_halign=text.align_right)
    table.merge_cells(dash, 1, 1, 2, 1)

    // Row 2: Duration (only when in squeeze)
    string durTxt = sqzOn ? str.tostring(sqzDuration) + " bars" : "â€”"
    table.cell(dash, 0, 2, "Duration", text_color=#8b949e, text_size=size.normal, text_halign=text.align_left)
    table.cell(dash, 1, 2, durTxt, text_color=sqzOn ? color.white : #8b949e, text_size=size.normal, text_halign=text.align_right)
    table.merge_cells(dash, 1, 2, 2, 2)

    // Row 3: Momentum
    string momDirTxt = mom > 0 ? "â–² BULLISH" : mom < 0 ? "â–¼ BEARISH" : "â€” FLAT"
    color  momDirCol = mom > 0 ? i_bullHot : mom < 0 ? i_bearHot : #8b949e
    string momStrTxt = str.tostring(momPct, "#.0") + "%"
    table.cell(dash, 0, 3, "Momentum", text_color=#8b949e, text_size=size.normal, text_halign=text.align_left)
    table.cell(dash, 1, 3, momDirTxt, text_color=momDirCol, text_size=size.normal, text_halign=text.align_right)
    table.cell(dash, 2, 3, momStrTxt, text_color=momDirCol, text_size=size.normal, text_halign=text.align_right)

    // Row 4: Pressure Gauge
    table.cell(dash, 0, 4, "Pressure", text_color=#8b949e, text_size=size.normal, text_halign=text.align_left)
    table.cell(dash, 1, 4, pressureLbl, text_color=pressureCol, text_size=size.normal, text_halign=text.align_right)
    string pressureNum = sqzOn ? str.tostring(pressure, "#.0") : "â€”"
    table.cell(dash, 2, 4, pressureNum, text_color=pressureCol, text_size=size.normal, text_halign=text.align_right)

    // Row 5: Historical Stats
    string avgTxt = sqzCount > 0 ? str.tostring(avgSqzDur, "#.1") + " bars avg" : "â€”"
    table.cell(dash, 0, 5, "Squeezes", text_color=#8b949e, text_size=size.normal, text_halign=text.align_left)
    table.cell(dash, 1, 5, str.tostring(sqzCount), text_color=color.white, text_size=size.normal, text_halign=text.align_right)
    table.cell(dash, 2, 5, avgTxt, text_color=#8b949e, text_size=size.normal, text_halign=text.align_right)

    // Row 6: Last Fire
    int fireAgo = lastFireBar > 0 ? bar_index - lastFireBar : 0
    string fireTxt = fireAgo > 0 ? str.tostring(fireAgo) + " bars ago" : "â€”"
    string fireDir = lastFireDir == 1 ? " â–²" : lastFireDir == -1 ? " â–¼" : ""
    color  fireCol = lastFireDir == 1 ? i_bullHot : lastFireDir == -1 ? i_bearHot : #8b949e
    table.cell(dash, 0, 6, "Last Fire", text_color=#8b949e, text_size=size.normal, text_halign=text.align_left)
    table.cell(dash, 1, 6, fireTxt + fireDir, text_color=fireCol, text_size=size.normal, text_halign=text.align_right)
    table.merge_cells(dash, 1, 6, 2, 6)

    // Row 7: Footer
    table.cell(dash, 0, 7, "Compression + Gradient Momentum + Divergence", text_color=color.new(#8b949e, 50), text_size=size.normal, text_halign=text.align_left)
    table.merge_cells(dash, 0, 7, 2, 7)

// â”€â”€â”€ ALERTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

alertcondition(bullFire, "Bullish Squeeze Fire", "Squeeze fired BULLISH on {{ticker}} ({{interval}})")
alertcondition(bearFire, "Bearish Squeeze Fire", "Squeeze fired BEARISH on {{ticker}} ({{interval}})")
alertcondition(momFlipBull, "Momentum Flipped Bullish", "Momentum crossed above zero on {{ticker}}")
alertcondition(momFlipBear, "Momentum Flipped Bearish", "Momentum crossed below zero on {{ticker}}")
alertcondition(bearDiv, "Bearish Divergence", "Bearish momentum divergence detected on {{ticker}}")
alertcondition(bullDiv, "Bullish Divergence", "Bullish momentum divergence detected on {{ticker}}")
alertcondition(sqzOn and not sqzOn[1], "Squeeze Started", "Volatility squeeze started on {{ticker}}")
