//@version=5
indicator("1W&2W StochRSI Full BG1",shorttitle="1W/2W StochRSI BG1",overlay=false)
rsi_len=input.int(14,"RSI length",minval=1)
stoch_len=input.int(14,"Stoch length",minval=1)
k_smooth=input.int(3,"K smooth",minval=1)
d_smooth=input.int(3,"D smooth",minval=1)
show_2w=input.bool(true,"Show 2W")
near_dist=input.float(2,"Near distance",minval=0.1)
bg_transp=input.int(80,"BG transparency (0 opaque..255 transparent)",minval=0,maxval=255)
f_stochrsi_from_rsi(_rsi,_len,_ks,_ds)=>
    raw = ta.stoch(_rsi,_rsi,_rsi,_len)
    _k = ta.sma(raw,_ks)
    _d = ta.sma(_k,_ds)
    [_k,_d]
w_close=request.security(syminfo.tickerid,"W",close)
two_close=request.security(syminfo.tickerid,"2W",close)
w_rsi=ta.rsi(w_close,rsi_len)
two_rsi=ta.rsi(two_close,rsi_len)
[w_k,w_d]=f_stochrsi_from_rsi(w_rsi,stoch_len,k_smooth,d_smooth)
[t_k,t_d]=f_stochrsi_from_rsi(two_rsi,stoch_len,k_smooth,d_smooth)
plot(w_k,"1W %K",color=color.blue,linewidth=2)
plot(w_d,"1W %D",color=color.orange,linewidth=1)
plot(show_2w?t_k:na,"2W %K",color=color.green,linewidth=2)
plot(show_2w?t_d:na,"2W %D",color=color.red,linewidth=1)
hline(80,"OB",linestyle=hline.style_dotted)
hline(20,"OS",linestyle=hline.style_dotted)
hline(50,"Mid",linestyle=hline.style_dotted)
w_k_up=w_k>w_k[1]
t_k_up=t_k>t_k[1]
w_k_dn=w_k<w_k[1]
t_k_dn=t_k<t_k[1]
w_cross_up=ta.crossover(w_k,w_d)
t_cross_up=ta.crossover(t_k,t_d)
w_cross_dn=ta.crossunder(w_k,w_d)
t_cross_dn=ta.crossunder(t_k,t_d)
w_near_up=math.abs(w_k-w_d)<=near_dist and w_k_up
t_near_up=math.abs(t_k-t_d)<=near_dist and t_k_up
w_near_dn=math.abs(w_k-w_d)<=near_dist and w_k_dn
t_near_dn=math.abs(t_k-t_d)<=near_dist and t_k_dn
w_mom_up=w_k_up and w_k<40
t_mom_up=t_k_up and t_k<40
w_mom_dn=w_k_dn and w_k>60
t_mom_dn=t_k_dn and t_k>60
plotshape(w_mom_up,title="1W Yellow Up",location=location.bottom,style=shape.triangleup,color=color.yellow,size=size.tiny,text="Y")
plotshape(w_near_up,title="1W Amber Up",location=location.bottom,style=shape.triangleup,color=color.orange,size=size.tiny,text="A")
plotshape(w_cross_up,title="1W Green Up",location=location.bottom,style=shape.triangleup,color=color.green,size=size.tiny,text="G")
plotshape(show_2w?t_mom_up:na,title="2W Yellow Up",location=location.bottom,style=shape.triangleup,color=color.yellow,size=size.small,text="Y")
plotshape(show_2w?t_near_up:na,title="2W Amber Up",location=location.bottom,style=shape.triangleup,color=color.orange,size=size.small,text="A")
plotshape(show_2w?t_cross_up:na,title="2W Green Up",location=location.bottom,style=shape.triangleup,color=color.green,size=size.small,text="G")
plotshape(w_mom_dn,title="1W Yellow Down",location=location.top,style=shape.triangledown,color=color.yellow,size=size.tiny,text="y")
plotshape(w_near_dn,title="1W Amber Down",location=location.top,style=shape.triangledown,color=color.orange,size=size.tiny,text="a")
plotshape(w_cross_dn,title="1W Red Down",location=location.top,style=shape.triangledown,color=color.red,size=size.tiny,text="R")
plotshape(show_2w?t_mom_dn:na,title="2W Yellow Down",location=location.top,style=shape.triangledown,color=color.yellow,size=size.small,text="y")
plotshape(show_2w?t_near_dn:na,title="2W Amber Down",location=location.top,style=shape.triangledown,color=color.orange,size=size.small,text="a")
plotshape(show_2w?t_cross_dn:na,title="2W Red Down",location=location.top,style=shape.triangledown,color=color.red,size=size.small,text="R")
both_bull=w_cross_up and t_cross_up
both_bear=w_cross_dn and t_cross_dn
plotshape(both_bull,title="BOTH Bullish Diamond",location=location.bottom,style=shape.diamond,color=color.blue,size=size.large)
plotshape(both_bear,title="BOTH Bearish Diamond",location=location.top,style=shape.diamond,color=color.red,size=size.large)
bull_state=(w_k>w_d) or (t_k>t_d) or w_cross_up or t_cross_up
bear_state=(w_k<w_d) or (t_k<t_d) or w_cross_dn or t_cross_dn
bg= bull_state ? color.new(color.green,bg_transp) : (bear_state ? color.new(color.red,bg_transp) : na)
bgcolor(bg)
alertcondition(w_mom_up,"1W Momentum Up (Yellow)","1W: K slope up & K < 40")
alertcondition(w_near_up,"1W Near Up (Amber)","1W: K within near distance & slope up")
alertcondition(w_cross_up,"1W Cross Up (Green)","1W: Confirmed bullish cross")
alertcondition(t_mom_up,"2W Momentum Up (Yellow)","2W: K slope up & K < 40")
alertcondition(t_near_up,"2W Near Up (Amber)","2W: K within near distance & slope up")
alertcondition(t_cross_up,"2W Cross Up (Green)","2W: Confirmed bullish cross")
alertcondition(w_mom_dn,"1W Momentum Down (Yellow)","1W: K slope down & K > 60")
alertcondition(w_near_dn,"1W Near Down (Amber)","1W: K within near distance & slope down")
alertcondition(w_cross_dn,"1W Cross Down (Red)","1W: Confirmed bearish cross")
alertcondition(t_mom_dn,"2W Momentum Down (Yellow)","2W: K slope down & K > 60")
alertcondition(t_near_dn,"2W Near Down (Amber)","2W: K within near distance & slope down")
alertcondition(t_cross_dn,"2W Cross Down (Red)","2W: Confirmed bearish cross")
alertcondition(both_bull,"BOTH Bull Align (Blue Diamond)","Both 1W & 2W confirmed bullish cross")
alertcondition(both_bear,"BOTH Bear Align (Red Diamond)","Both 1W & 2W confirmed bearish cross")
