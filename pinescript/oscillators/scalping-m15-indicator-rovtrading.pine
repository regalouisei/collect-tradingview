//@version=6
indicator(title="Scalping m15 indicator RovTrading", shorttitle="Scalping m15 RovTrading", overlay=true)

// ================================
// Phần UT Bot
// ================================

// Inputs UT Bot
a = input.int(2,     title = "UT Bot - Key Value (Sensitivity)")
c = input.int(11,    title = "UT Bot - ATR Period")
h = input.bool(false, title = "UT Bot - Signals from Heikin Ashi Candles")

xATR  = ta.atr(c)
nLoss = a * xATR

src_ut = h ? request.security(ticker.heikinashi(syminfo.tickerid), timeframe.period, close, lookahead = barmerge.lookahead_off) : close

xATRTrailingStop = 0.0
xATRTrailingStop := src_ut > nz(xATRTrailingStop[1], 0) and src_ut[1] > nz(xATRTrailingStop[1], 0) ? math.max(nz(xATRTrailingStop[1]), src_ut - nLoss) :
   src_ut < nz(xATRTrailingStop[1], 0) and src_ut[1] < nz(xATRTrailingStop[1], 0) ? math.min(nz(xATRTrailingStop[1]), src_ut + nLoss) : 
   src_ut > nz(xATRTrailingStop[1], 0) ? src_ut - nLoss : src_ut + nLoss
 
pos = 0   
pos := src_ut[1] < nz(xATRTrailingStop[1], 0) and src_ut > nz(xATRTrailingStop[1], 0) ? 1 :
   src_ut[1] > nz(xATRTrailingStop[1], 0) and src_ut < nz(xATRTrailingStop[1], 0) ? -1 : nz(pos[1], 0) 
   
xcolor = pos == -1 ? color.red: pos == 1 ? color.green : color.blue 

ema_ut   = ta.ema(src_ut,1)
above = ta.crossover(ema_ut, xATRTrailingStop)
below = ta.crossover(xATRTrailingStop, ema_ut)

buy_ut  = src_ut > xATRTrailingStop and above
sell_ut = src_ut < xATRTrailingStop and below

barbuy  = src_ut > xATRTrailingStop
barsell = src_ut < xATRTrailingStop

// ================================
// Phần Linear Regression Candles
// ================================

signal_length = input.int(7, title="LinReg - Signal Smoothing", minval=1, maxval=200)
sma_signal = input.bool(true, title="LinReg - Simple MA (Signal Line)")
lin_reg = input.bool(true, title="LinReg - Enable Linear Regression")
linreg_length = input.int(11, title="LinReg - Linear Regression Length", minval=1, maxval=200)

bopen = lin_reg ? ta.linreg(open, linreg_length, 0) : open
bhigh = lin_reg ? ta.linreg(high, linreg_length, 0) : high
blow  = lin_reg ? ta.linreg(low, linreg_length, 0) : low
bclose = lin_reg ? ta.linreg(close, linreg_length, 0) : close

r = bopen < bclose

signal = sma_signal ? ta.sma(bclose, signal_length) : ta.ema(bclose, signal_length)

// ================================
// Hiển thị kết hợp
// ================================

// Hiển thị Linear Regression Candles
plotcandle(r ? bopen : na, r ? bhigh : na, r ? blow: na, r ? bclose : na, 
          title="LinReg Green Candles", color=color.green, wickcolor=color.green, 
          bordercolor=color.green, display=display.all)
plotcandle(r ? na : bopen, r ? na : bhigh, r ? na : blow, r ? na : bclose, 
          title="LinReg Red Candles", color=color.red, wickcolor=color.red, 
          bordercolor=color.red, display=display.all)

// Hiển thị đường signal
plot(signal, "LinReg Signal", color=color.yellow, linewidth=1)

// Hiển thị tín hiệu UT Bot
plotshape(buy_ut,  title="UT Buy",  text='UT Buy',  style=shape.labelup, 
         location=location.belowbar, color=color.lime, textcolor=color.white, 
         size=size.tiny)
plotshape(sell_ut, title="UT Sell", text='UT Sell', style=shape.labeldown, 
         location=location.abovebar, color=color.red, textcolor=color.white, 
         size=size.tiny)

// Màu nến theo UT Bot
barcolor(barbuy  ? color.green : na)
barcolor(barsell ? color.red   : na)

// Alert conditions
alertcondition(buy_ut,  "UT Bot Long",  "UT Bot Long")
alertcondition(sell_ut, "UT Bot Short", "UT Bot Short")
