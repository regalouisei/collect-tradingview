//@version=6
indicator("RSI (Smoothed) + RSI MA + HTF Gate + Histogram (Match Boost) [v2.3]", overlay=false)

//=============================
// Inputs
//=============================
grpRSI = "RSI"
src       = input.source(close, "RSI Source", group=grpRSI)
rsiLen    = input.int(14, "RSI Length", minval=1, group=grpRSI)
smoothLen = input.int(9, "RSI Smooth (RMA) Length", minval=1, group=grpRSI)

grpMA = "RSI Moving Average"
showMA   = input.bool(true, "Show RSI MA", group=grpMA)
maType   = input.string("RMA", "MA Type", options=["RMA","EMA","SMA","WMA"], group=grpMA)
maLen    = input.int(14, "MA Length", minval=1, group=grpMA)

grpLevels = "Levels"
show50   = input.bool(true, "Show 50", group=grpLevels)
show7030 = input.bool(true, "Show 70/30", group=grpLevels)
show6040 = input.bool(false, "Show 60/40", group=grpLevels)

grpStyle = "Style"
maFlatThr = input.float(0.05, "MA Flat Threshold", minval=0.0, step=0.01, group=grpStyle)
showLines = input.bool(true, "Show RSI/MA Lines", group=grpStyle)
rsiWidth  = input.int(2, "RSI Line Width", minval=1, maxval=5, group=grpStyle)
maWidth   = input.int(2, "MA Line Width",  minval=1, maxval=5, group=grpStyle)

grpGate = "HTF Color Gate (Complete Prohibition)"
useGate   = input.bool(true, "Enable HTF gate", group=grpGate)
gateTF    = input.timeframe("5", "HTF TF", group=grpGate)
bullThr   = input.float(51.0, "HTF Bull >=", step=0.1, group=grpGate)
bearThr   = input.float(49.0, "HTF Bear <=", step=0.1, group=grpGate)

//=============================
// Color Settings
//=============================
grpCols = "Colors (Line / Gate / Histogram)"
rsiBullCol = input.color(color.lime,   "RSI Bull Color (>=50)", group=grpCols)
rsiBearCol = input.color(color.red,    "RSI Bear Color (<50)", group=grpCols)
gateColor  = input.color(color.yellow, "Gate Color (Prohibited)", group=grpCols)

maUpCol   = input.color(color.lime,   "MA Up Color", group=grpCols)
maFlatCol = input.color(color.yellow, "MA Flat Color", group=grpCols)
maDnCol   = input.color(color.red,    "MA Down Color", group=grpCols)

grpHist = "Histogram"
showHist      = input.bool(true, "Show Histogram", group=grpHist)
histMode      = input.string("RSI-50", "Histogram Mode", options=["RSI-50","RSI-MA"], group=grpHist)
histScale     = input.float(1.0, "Histogram Scale (RSI-MA only)", minval=0.1, step=0.1, group=grpHist)

histUpCol     = input.color(color.lime, "Hist Up Color (default)", group=grpHist)
histDnCol     = input.color(color.red,  "Hist Down Color (default)", group=grpHist)
histBaseCol   = input.color(color.gray, "Hist Base Line Color", group=grpHist)
showHistBase  = input.bool(true, "Show Hist Base (50)", group=grpHist)

// ★薄さ（透明度）を完全に設定可能（0=濃い / 100=透明）
defaultTransp = input.int(45, "Default Opacity (0=solid, 100=off)", minval=0, maxval=100, group=grpHist)
boostTransp   = input.int(15, "Boost Opacity (0=solid, 100=off)",   minval=0, maxval=100, group=grpHist)

// Match Boost
grpMatch = "Histogram Color Change (When RSI & MA Same Color, NO Flat)"
useMatchBoost = input.bool(true, "Enable Match Color Boost", group=grpMatch)
matchBullCol  = input.color(color.aqua,    "Boost Color (Bull match)", group=grpMatch)
matchBearCol  = input.color(color.fuchsia, "Boost Color (Bear match)", group=grpMatch)

//=============================
// RSI + Smooth
//=============================
rsiRaw    = ta.rsi(src, rsiLen)
rsiSmooth = ta.rma(rsiRaw, smoothLen)

// HTF RSI smooth
htfRsiSmooth = request.security(syminfo.tickerid, gateTF, ta.rma(ta.rsi(src, rsiLen), smoothLen), barmerge.gaps_off, barmerge.lookahead_off)
htfBull = useGate and not na(htfRsiSmooth) and (htfRsiSmooth >= bullThr)
htfBear = useGate and not na(htfRsiSmooth) and (htfRsiSmooth <= bearThr)

// RSI MA
maCalc(_x, _len, _type) =>
    switch _type
        "RMA" => ta.rma(_x, _len)
        "EMA" => ta.ema(_x, _len)
        "SMA" => ta.sma(_x, _len)
        "WMA" => ta.wma(_x, _len)

rsiMA = showMA ? maCalc(rsiSmooth, maLen, maType) : na

// RSI line color (with gate)
baseBull = rsiSmooth >= 50
baseBear = rsiSmooth <  50
rsiColGated =
     htfBull ? (baseBear ? gateColor : rsiBullCol) :
     htfBear ? (baseBull ? gateColor : rsiBearCol) :
     (baseBull ? rsiBullCol : rsiBearCol)

// MA slope color
maDelta = rsiMA - rsiMA[1]
maState = maDelta > maFlatThr ? 1 : maDelta < -maFlatThr ? -1 : 0
maCol   = maState == 1 ? maUpCol : maState == 0 ? maFlatCol : maDnCol

// Histogram plot value (RSI scale around 50)
float histPlot = na
histPlot := histMode == "RSI-50" ? rsiSmooth : (50 + (rsiSmooth - rsiMA) * histScale)

// Default hist color (gate suppression)
histIsUp     = histPlot >= 50
histColBase  = histIsUp ? (htfBear ? gateColor : histUpCol) : (htfBull ? gateColor : histDnCol)

// Match boost decision
sameColor = showMA and not na(rsiMA) and (rsiColGated == maCol)
excludeState = (maState == 0) or (rsiColGated == gateColor)

matchBull = useMatchBoost and sameColor and not excludeState and (maState == 1)
matchBear = useMatchBoost and sameColor and not excludeState and (maState == -1)

histCol = matchBull ? matchBullCol : matchBear ? matchBearCol : histColBase
histT   = (matchBull or matchBear) ? boostTransp : defaultTransp

//=============================
// Plots
//=============================
hline(showHistBase ? 50 : na, "Hist Base (50)", color=color.new(histBaseCol, 40))
plot(showHist ? histPlot : na, "Histogram", style=plot.style_histogram, histbase=50, color=color.new(histCol, histT), linewidth=2)

plot(showLines ? rsiSmooth : na, "RSI (Smoothed)", color=rsiColGated, linewidth=rsiWidth)
plot(showLines ? rsiMA : na, "RSI MA", color=maCol, linewidth=maWidth)

hline(show50 ? 50 : na, "50", color=color.gray)
hline(show7030 ? 70 : na, "70", color=color.new(color.gray, 40))
hline(show7030 ? 30 : na, "30", color=color.new(color.gray, 40))
hline(show6040 ? 60 : na, "60", color=color.new(color.gray, 60))
hline(show6040 ? 40 : na, "40", color=color.new(color.gray, 60))
