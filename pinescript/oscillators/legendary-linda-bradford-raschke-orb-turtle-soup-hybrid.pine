//@version=6
strategy("Raschke-Inspired ORB + Turtle Soup Hybrid",
     overlay = true,
     initial_capital = 10000,
     currency = currency.USD,
     default_qty_type = strategy.percent_of_equity,
     default_qty_value = 1,
     commission_type = strategy.commission.percent,
     commission_value = 0.01,
     process_orders_on_close = true)

// ==========================
// INPUTS
// ==========================

orbBars        = input.int(6, "Opening Range Bars", minval = 1)
emaTrendLen    = input.int(30, "LBR Trend EMA", minval = 1)
oscFastLen     = input.int(3, "3/10 Fast EMA", minval = 1)
oscSlowLen     = input.int(10, "3/10 Slow EMA", minval = 1)
oscSignalLen   = input.int(16, "Oscillator Signal SMA", minval = 1)
lookbackSwing  = input.int(20, "Swing Lookback (Turtle Soup)", minval = 5)
timeStopBars   = input.int(20, "Time Stop (Bars)", minval = 1)

// ==========================
// CORE CALCULATIONS
// ==========================

// LBR 30 Trend
trendEMA = ta.ema(close, emaTrendLen)

// 3/10 Oscillator
emaFast = ta.ema(close, oscFastLen)
emaSlow = ta.ema(close, oscSlowLen)
oscRaw  = emaFast - emaSlow
osc     = ta.sma(oscRaw, oscSignalLen)

// ==========================
// OPENING RANGE (Fixed)
// ==========================

newSession = ta.change(time("D")) != 0  // convert to bool

var float orbHigh = na
var float orbLow  = na
var int   orbCount = 0

if newSession
    orbHigh := high
    orbLow  := low
    orbCount := 1
else if orbCount > 0 and orbCount < orbBars
    orbHigh := math.max(orbHigh, high)
    orbLow  := math.min(orbLow, low)
    orbCount += 1

// ==========================
// SWING LEVELS (Turtle Soup)
// ==========================

priorHigh = ta.highest(high, lookbackSwing)[1]
priorLow  = ta.lowest(low, lookbackSwing)[1]

// ==========================
// ENTRY CONDITIONS
// ==========================

// ORB Breakout
longORB  = orbCount >= orbBars and close > orbHigh and osc > 0 and close > trendEMA
shortORB = orbCount >= orbBars and close < orbLow  and osc < 0 and close < trendEMA

// Turtle Soup (False Break Reversal)
falseBreakHigh = high > priorHigh and close < priorHigh and osc < 0
falseBreakLow  = low < priorLow and close > priorLow and osc > 0

longTurtle  = falseBreakLow and close > trendEMA
shortTurtle = falseBreakHigh and close < trendEMA

longCondition  = longORB or longTurtle
shortCondition = shortORB or shortTurtle

// ==========================
// EXECUTION
// ==========================

if longCondition
    strategy.entry("Long", strategy.long)

if shortCondition
    strategy.entry("Short", strategy.short)

// ==========================
// DYNAMIC STRUCTURE TRAIL
// ==========================

longTrail  = ta.lowest(low, 5)
shortTrail = ta.highest(high, 5)

strategy.exit("Long Exit", from_entry = "Long", stop = longTrail)
strategy.exit("Short Exit", from_entry = "Short", stop = shortTrail)

// ==========================
// TIME STOP
// ==========================

var int entryBar = na

if strategy.position_size != 0 and na(entryBar)
    entryBar := bar_index

if strategy.position_size == 0
    entryBar := na

if not na(entryBar) and bar_index - entryBar >= timeStopBars
    strategy.close_all()

// ==========================
// PLOTS
// ==========================

plot(trendEMA, title="LBR 30 EMA", linewidth=2)
plot(orbHigh, title="ORB High", color=color.green)
plot(orbLow, title="ORB Low", color=color.red)
