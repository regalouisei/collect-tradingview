//@version=6
indicator("MFI + MTF Background Zone + Gradient (MTF Main)", shorttitle="MFI MTF Pro v2", overlay=false)

// --- Inputs ---
group_main = "Main MFI Ayarları"
tfMain = input.timeframe("", "Ana MFI Zaman Dilimi", group=group_main)
length = input.int(14, title="Length", minval=1, group=group_main)
// MFI için genelde 80/20 kullanılır, varsayılanları buna göre ayarladım.
osLevel  = input.int(20, minval=0, maxval=50, title="(Oversold)", group=group_main, inline = 'ab')
obLevel  = input.int(80, minval=50, maxval=100, title="(Overbought)", group=group_main, inline = 'ab')

group_mtf = "MTF MFI (Arka Plan) Ayarları"
tfInput = input.timeframe("1D", "MTF Zaman Dilimi", group=group_mtf)
mtfLength = input.int(14, title="MTF Length", minval=1, group=group_mtf)
// Arka plan sinyalleri için ayrı seviyeler
mtfObLevel = input.int(70, title="MTF (Oversold)", group=group_mtf, inline = 'ab2')
mtfOsLevel = input.int(30, title="MTF (Overbought)", group=group_mtf, inline = 'ab2')

group_div = "Uyumsuzluk (Divergence)"
showDivergences = input.bool(true, 'Uyumsuzlukları Göster', group=group_div, inline = 'y')
plotBull = input.bool(true, 'Bullish', group=group_div, inline = 'y')
plotBear = input.bool(true, 'Bearish', group=group_div, inline = 'y')
lbR = input.int(5, title = 'Pivot Right', group=group_div, inline = 'u')
lbL = input.int(5, title = 'Pivot Left', group=group_div, inline = 'u')
rangeUpper = input.int(60, title = 'Max Lookback', group=group_div, inline = 'u')
rangeLower = input.int(5, title = 'Min Lookback', group=group_div, inline = 'u')

// --- MFI Hesaplama Fonksiyonu (Verilen Koda Göre) ---
f_mfi(float _src, float _vol, int _len) =>
    // Orijinal kodun SMA tabanlı mantığı
    float change_src = ta.change(_src)
    float posFlow = _vol * (change_src > 0 ? _src : 0)
    float negFlow = _vol * (change_src < 0 ? _src : 0)
    
    // Orijinal kodda sum yerine sma kullanılmıştı, koruyoruz:
    float posAvg = ta.sma(posFlow, _len)
    float negAvg = ta.sma(negFlow, _len)
    
    float rs = negAvg == 0 ? 0 : posAvg / negAvg
    float result = negAvg == 0 ? 100 : 100 - (100 / (1 + rs))
    result

// --- HESAPLAMALAR ---

// 1. Ana MFI Çizgisi Hesaplaması
// Not: MFI Hacim ve HLC3 kullandığı için fonksiyona bunları gönderiyoruz.
mfiCurrent = request.security(syminfo.tickerid, tfMain, f_mfi(hlc3, volume, length))

// 2. MTF MFI (Arka Plan) Hesaplaması (Kendi ayarlarını kullanır)
mfiMTF = request.security(syminfo.tickerid, tfInput, f_mfi(hlc3, volume, mtfLength))


// --- GÖRSELLEŞTİRME ---

// MFI Renkleri: 80 üstü Kırmızı, 20 altı Yeşil, arası Gri
mfiColor = mfiCurrent > obLevel ? color.red : mfiCurrent < osLevel ? color.green : color.rgb(184, 182, 180)

mfiPlot = plot(mfiCurrent, title="MFI Çizgisi", linewidth=1, color=mfiColor)

midLinePlot = plot(50, color = na, editable = false, display = display.none)

h_max = hline(100, "Max", linestyle=hline.style_dotted, color=color.new(color.white, 100), display = display.none)
h_min = hline(0, "Min", linestyle=hline.style_dotted, color=color.new(color.white, 100), display = display.none)
h_ob  = hline(obLevel, "Aşırı Alım Seviyesi", linestyle=hline.style_dotted, color=color.gray)
h_os  = hline(osLevel, "Aşırı Satım Seviyesi", linestyle=hline.style_dotted, color=color.gray)
h_mid = hline(50, "Orta Seviye (50)", linestyle=hline.style_dotted, color=color.gray)

// --- GRADIENT (Ana Çizgi İçin) ---
// Sadece OB ve OS bölgelerinde dolgu görünür.

// 1. ÜST BÖLGE (OB Level - 100 arası): RED Gradient
fill(mfiPlot, midLinePlot, 100, obLevel, top_color = color.new(color.red, 0), bottom_color = color.new(color.red, 100), title="Aşırı Alım Gradient")

// 2. ALT BÖLGE (0 - OS Level arası): GREEN Gradient
fill(mfiPlot, midLinePlot, osLevel, 0, top_color = color.new(color.green, 100), bottom_color = color.new(color.green, 0), title="Aşırı Satım Gradient")


// --- MTF Arka Plan Rengi ---
// Kullanıcının girdiği MTF seviyelerine göre arka plan rengi değişir.
// Eğer MTF MFI > MTF OB Level ise Kırmızı, MTF MFI < MTF OS Level ise Yeşil.
zoneColor = mfiMTF > mtfObLevel ? color.new(color.red, 77) : mfiMTF < mtfOsLevel ? color.new(color.green, 77) : color.new(color.white, 100)

fill(h_ob, h_os, color=zoneColor, title="MTF Arka Plan Rengi")


// ===== Divergence (Uyumsuzluk) =====
bearColor = #f80909
bullColor = #08fc10
divergenceSmartColor = color.silver
noneColor = color.new(color.white, 100)

osc = mfiCurrent

// Pivotlar
plFound = not na(ta.pivotlow(osc, lbL, lbR))
phFound = not na(ta.pivothigh(osc, lbL, lbR))

_inRange(cond) =>
    bars = ta.barssince(cond == true)
    rangeLower <= bars and bars <= rangeUpper

//------------------------------------------------------------------------------
// Regular Bullish
oscHL = osc[lbR] > ta.valuewhen(plFound, osc[lbR], 1) and _inRange(plFound[1])
priceLL = low[lbR] < ta.valuewhen(plFound, low[lbR], 1) 
bullCond = showDivergences and plotBull and priceLL and oscHL and plFound

plot(showDivergences and plFound and showDivergences ? osc[lbR] : na, offset = -lbR, title = 'Regular Bullish Line', linewidth = 1, color = bullCond ? divergenceSmartColor : noneColor, display = display.pane)
plotshape(bullCond ? osc[lbR] : na, 'Bullish Circle', shape.circle, location.absolute, bullColor, offset = -lbR, size = size.tiny, display = display.pane)

//------------------------------------------------------------------------------
// Regular Bearish
oscLH = osc[lbR] < ta.valuewhen(phFound, osc[lbR], 1) and _inRange(phFound[1])
priceHH = high[lbR] > ta.valuewhen(phFound, high[lbR], 1) 
bearCond = showDivergences and plotBear and priceHH and oscLH and phFound

plot(showDivergences and phFound ? osc[lbR] : na, offset = -lbR, title = 'Regular Bearish Line', linewidth = 1, color = bearCond ? divergenceSmartColor : noneColor, display = display.pane)
plotshape(bearCond ? osc[lbR] : na, 'Bearish Circle', shape.circle, location.absolute, bearColor, offset = -lbR, size = size.tiny, display = display.pane)
