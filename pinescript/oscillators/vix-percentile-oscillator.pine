//@version=5
indicator("VIX Percentile Oscillator", shorttitle="VIX %Rank ", overlay=false)

// ═══════════════════════════════════════════════════════════════════════════
// INPUT PARAMETERS
// ═══════════════════════════════════════════════════════════════════════════

// Calculation Settings
lookbackPeriod = input.int(252, "Lookback Period", minval=20, maxval=1000, tooltip="Number of bars to calculate percentile (252 = 1 year for daily)", group="Calculation")
smoothing = input.int(3, "Smoothing Period", minval=1, maxval=50, group="Calculation")
vixSymbol = input.symbol("CBOE:VIX", "VIX Symbol", group="Calculation")

// Zone Thresholds
extremeSellThreshold = input.int(90, "Extreme Sell Threshold", minval=80, maxval=100, group="Zones")
sellThreshold = input.int(80, "Sell Threshold", minval=50, maxval=90, group="Zones")
buyThreshold = input.int(20, "Buy Threshold", minval=10, maxval=50, group="Zones")
extremeBuyThreshold = input.int(10, "Extreme Buy Threshold", minval=0, maxval=20, group="Zones")

// Display Options
showZones = input.bool(true, "Show Trading Zones", group="Display")
showFloatingText = input.bool(true, "Show Floating Zone Text", group="Display")
showTable = input.bool(true, "Show Statistics Table", group="Display")
showMomentum = input.bool(true, "Show Momentum Indicator", group="Display")
showHistogram = input.bool(true, "Show Histogram", group="Display")

// ═══════════════════════════════════════════════════════════════════════════
// CALCULATIONS
// ═══════════════════════════════════════════════════════════════════════════

// Get VIX data
vixClose = request.security(vixSymbol, timeframe.period, close, gaps=barmerge.gaps_off)
vixHigh = request.security(vixSymbol, timeframe.period, high, gaps=barmerge.gaps_off)
vixLow = request.security(vixSymbol, timeframe.period, low, gaps=barmerge.gaps_off)

// Calculate Percentile Rank
calcPercentileRank(src, len) =>
    rank = 0.0
    for i = 0 to len - 1
        if src > src[i]
            rank += 1
    rank / len * 100

// Calculate VIX Percentile
vixPercentile = calcPercentileRank(vixClose, lookbackPeriod)
vixPercentileSmooth = ta.sma(vixPercentile, smoothing)

// Momentum calculation (rate of change)
vixMomentum = ta.change(vixPercentileSmooth, 5)

// Calculate statistics
vixAvg = ta.sma(vixClose, lookbackPeriod)
vixStdDev = ta.stdev(vixClose, lookbackPeriod)
vixZScore = (vixClose - vixAvg) / vixStdDev

// Time in zones
var int barsInSellZone = 0
var int barsInBuyZone = 0
var int barsInNeutral = 0

if vixPercentileSmooth >= sellThreshold
    barsInSellZone += 1
    barsInBuyZone := 0
    barsInNeutral := 0
else if vixPercentileSmooth <= buyThreshold
    barsInBuyZone += 1
    barsInSellZone := 0
    barsInNeutral := 0
else
    barsInNeutral += 1
    barsInSellZone := 0
    barsInBuyZone := 0

// ═══════════════════════════════════════════════════════════════════════════
// ZONE DEFINITIONS
// ═══════════════════════════════════════════════════════════════════════════

extremeSellZone = vixPercentileSmooth >= extremeSellThreshold
sellZone = vixPercentileSmooth >= sellThreshold and vixPercentileSmooth < extremeSellThreshold
neutralZone = vixPercentileSmooth > buyThreshold and vixPercentileSmooth < sellThreshold
buyZone = vixPercentileSmooth <= buyThreshold and vixPercentileSmooth > extremeBuyThreshold
extremeBuyZone = vixPercentileSmooth <= extremeBuyThreshold

// ═══════════════════════════════════════════════════════════════════════════
// PLOTTING
// ═══════════════════════════════════════════════════════════════════════════

// Dynamic color based on percentile
lineColor = extremeSellZone ? color.new(color.red, 0) : sellZone ? color.new(color.orange, 0) : buyZone ? color.new(color.lime, 0) : extremeBuyZone ? color.new(color.green, 0) : color.new(color.gray, 0)

// Main oscillator line
plot(vixPercentileSmooth, "VIX Percentile", color=lineColor, linewidth=3)

// Histogram
histColor = vixPercentileSmooth >= 50 ? color.new(color.red, 70) : color.new(color.green, 70)
plot(showHistogram ? vixPercentileSmooth : na, "Histogram", color=histColor, style=plot.style_histogram, linewidth=1)

// Momentum indicator - scaled to fit 0-100 range
momentumScaled = showMomentum ? math.max(0, math.min(100, 50 + (vixMomentum * 5))) : na
plot(momentumScaled, "Momentum", color=color.new(color.purple, 50), linewidth=1, style=plot.style_line)

// Reference lines
hline(50, "Median", color=color.new(color.gray, 50), linestyle=hline.style_dotted)
hline(extremeSellThreshold, "Extreme Sell", color=color.new(color.maroon, 30), linestyle=hline.style_solid)
hline(sellThreshold, "Sell", color=color.new(color.red, 30), linestyle=hline.style_dashed)
hline(buyThreshold, "Buy", color=color.new(color.green, 30), linestyle=hline.style_dashed)
hline(extremeBuyThreshold, "Extreme Buy", color=color.new(color.teal, 30), linestyle=hline.style_solid)

// Background zones
bgcolor(showZones and extremeSellZone ? color.new(color.red, 85) : na)
bgcolor(showZones and sellZone ? color.new(color.orange, 92) : na)
bgcolor(showZones and buyZone ? color.new(color.lime, 92) : na)
bgcolor(showZones and extremeBuyZone ? color.new(color.green, 85) : na)

// Zone entry signals
plotshape(showZones and extremeSellZone and not extremeSellZone[1], style=shape.triangledown, location=location.top, color=color.red, size=size.normal, title="Extreme Sell Signal", text="EXTREME")

plotshape(showZones and sellZone and not sellZone[1] and not extremeSellZone[1], style=shape.triangledown, location=location.top, color=color.orange, size=size.small, title="Sell Signal")

plotshape(showZones and buyZone and not buyZone[1] and not extremeBuyZone[1], style=shape.triangleup, location=location.bottom, color=color.lime, size=size.small, title="Buy Signal")

plotshape(showZones and extremeBuyZone and not extremeBuyZone[1], style=shape.triangleup, location=location.bottom, color=color.green, size=size.normal, title="Extreme Buy Signal", text="EXTREME")

// ═══════════════════════════════════════════════════════════════════════════
// FLOATING TEXT LABELS
// ═══════════════════════════════════════════════════════════════════════════

var label zoneLabel = na
var label percentileLabel = na
var label cornerLabel = na

if barstate.islast and showFloatingText
    label.delete(zoneLabel)
    label.delete(percentileLabel)
    label.delete(cornerLabel)
    
    // Current percentile display
    momentumArrow = vixMomentum > 0 ? "UP" : vixMomentum < 0 ? "DN" : "FLAT"
    percentileText = "VIX: " + str.tostring(vixPercentileSmooth, "#.##") + "% " + momentumArrow
    percentileLabel := label.new(bar_index, vixPercentileSmooth, percentileText, style=label.style_label_left, color=lineColor, textcolor=color.white, size=size.normal)
    
    // Floating zone text
    zoneText = ""
    zoneTextColor = color.gray
    zoneYPosition = 50
    
    if extremeSellZone
        zoneText := "EXTREME OPTION SELLING ZONE"
        zoneTextColor := color.red
        zoneYPosition := 92
    else if sellZone
        zoneText := "OPTION SELLING ZONE"
        zoneTextColor := color.orange
        zoneYPosition := 85
    else if extremeBuyZone
        zoneText := "EXTREME OPTION BUYING ZONE"
        zoneTextColor := color.green
        zoneYPosition := 8
    else if buyZone
        zoneText := "OPTION BUYING ZONE"
        zoneTextColor := color.lime
        zoneYPosition := 15
    
    if zoneText != ""
        zoneLabel := label.new(bar_index - 10, zoneYPosition, zoneText, style=label.style_none, color=color.new(zoneTextColor, 100), textcolor=zoneTextColor, size=size.huge, textalign=text.align_center)
    
    // Corner reference labels
    cornerText = "Sell >80 | Extreme >90" + "\n" + "Buy <20 | Extreme <10"
    cornerLabel := label.new(bar_index, 100, cornerText, style=label.style_label_down, color=color.new(color.blue, 20), textcolor=color.white, size=size.small, textalign=text.align_left)

// ═══════════════════════════════════════════════════════════════════════════
// STATISTICS TABLE
// ═══════════════════════════════════════════════════════════════════════════

if showTable and barstate.islast
    var table statsTable = table.new(position.top_right, 2, 8, bgcolor=color.new(color.black, 85), border_width=1, border_color=color.gray)
    
    // Headers
    table.cell(statsTable, 0, 0, "Metric", text_color=color.white, text_size=size.small, bgcolor=color.new(color.blue, 70))
    table.cell(statsTable, 1, 0, "Value", text_color=color.white, text_size=size.small, bgcolor=color.new(color.blue, 70))
    
    // Data rows
    
    table.cell(statsTable, 0, 2, "Percentile", text_color=color.white, text_size=size.small)
    table.cell(statsTable, 1, 2, str.tostring(vixPercentileSmooth, "#.##") + "%", text_color=lineColor, text_size=size.small)
    
    table.cell(statsTable, 0, 3, "Z-Score", text_color=color.white, text_size=size.small)
    zScoreColor = math.abs(vixZScore) > 2 ? color.red : color.white
    table.cell(statsTable, 1, 3, str.tostring(vixZScore, "#.##"), text_color=zScoreColor, text_size=size.small)
    
    table.cell(statsTable, 0, 4, "Momentum", text_color=color.white, text_size=size.small)
    momColor = vixMomentum > 0 ? color.red : color.green
    table.cell(statsTable, 1, 4, str.tostring(vixMomentum, "#.##"), text_color=momColor, text_size=size.small)
    
    table.cell(statsTable, 0, 5, "Avg VIX", text_color=color.white, text_size=size.small)
    table.cell(statsTable, 1, 5, str.tostring(vixAvg, "#.##"), text_color=color.white, text_size=size.small)
    
    table.cell(statsTable, 0, 6, "Current Zone", text_color=color.white, text_size=size.small)
    zoneTextTable = extremeSellZone ? "EXTREME SELL" : sellZone ? "SELL" : extremeBuyZone ? "EXTREME BUY" : buyZone ? "BUY" : "NEUTRAL"
    table.cell(statsTable, 1, 6, zoneTextTable, text_color=lineColor, text_size=size.small)
    
    table.cell(statsTable, 0, 7, "Bars in Zone", text_color=color.white, text_size=size.small)
    barsText = extremeSellZone or sellZone ? str.tostring(barsInSellZone) : extremeBuyZone or buyZone ? str.tostring(barsInBuyZone) : str.tostring(barsInNeutral)
    table.cell(statsTable, 1, 7, barsText, text_color=color.white, text_size=size.small)

// ═══════════════════════════════════════════════════════════════════════════
// ALERTS
// ═══════════════════════════════════════════════════════════════════════════

alertcondition(ta.crossover(vixPercentileSmooth, extremeSellThreshold), "Extreme Selling Zone", "VIX entered EXTREME selling zone - Premium option selling opportunity!")

alertcondition(ta.crossover(vixPercentileSmooth, sellThreshold), "Selling Zone", "VIX entered selling zone - Consider selling options")

alertcondition(ta.crossunder(vixPercentileSmooth, buyThreshold), "Buying Zone", "VIX entered buying zone - Consider buying options")

alertcondition(ta.crossunder(vixPercentileSmooth, extremeBuyThreshold), "Extreme Buying Zone", "VIX entered EXTREME buying zone - Premium option buying opportunity!")

alertcondition(ta.cross(vixPercentileSmooth, 50), "Crossed Median", "VIX percentile crossed the 50% median level")

// ═══════════════════════════════════════════════════════════════════════════
// END OF SCRIPT
// ═══════════════════════════════════════════════════════════════════════════
