//@version=6
// Indicator: Squeeze Momentum Oscillator

indicator('Squeeze Momentum Oscillator', shorttitle = 'Squeeze', format = format.price, precision = 4) // Shortened title

// --- Inputs ---
source = input.source(close, 'Source')
bbLength = input.int(20, 'Bollinger Band Length')
bbMult = input.float(2.0, 'Bollinger Band StdDev', step = 0.1)
kcLength = input.int(20, 'Keltner Channel Length')
kcMult = input.float(2.0, 'Keltner Channel ATR Mult', step = 0.1)
momentumLength = input.int(20, 'Momentum Length')

// -- Feature Toggles --
useBreakoutColors = input.bool(true, 'Show Breakout Colors?')

// -- Color Inputs --
bullishIncreasingColor = input.color(color.new(color.green, 40), 'Bullish Increasing')
bullishDecreasingColor = input.color(color.new(color.green, 80), 'Bullish Decreasing')
bearishDecreasingColor = input.color(color.new(color.red, 40), 'Bearish Decreasing')
bearishIncreasingColor = input.color(color.new(color.red, 80), 'Bearish Increasing')

squeezeOnColor = input.color(color.new(color.red, 0), 'Squeeze ON')
squeezeOffColor = input.color(color.new(color.green, 50), 'Squeeze OFF')
bullishBreakoutColor = input.color(color.new(color.fuchsia, 0), 'Bullish Breakout')
bearishBreakoutColor = input.color(color.new(color.blue, 0), 'Bearish Breakout')


// --- Squeeze Calculations ---
float upperBB = ta.sma(source, bbLength) + bbMult * ta.stdev(source, bbLength)
float lowerBB = ta.sma(source, bbLength) - bbMult * ta.stdev(source, bbLength)
float upperKC = ta.ema(source, kcLength) + kcMult * ta.atr(kcLength)
float lowerKC = ta.ema(source, kcLength) - kcMult * ta.atr(kcLength)

bool inSqueeze = upperBB < upperKC and lowerBB > lowerKC

// --- Breakout & Momentum Calculations ---
bool squeezeReleaseUp = inSqueeze[1] and source > upperBB
bool squeezeReleaseDown = inSqueeze[1] and source < lowerBB
float basis = ta.sma(source, bbLength)
bool isSlopingUp = basis > basis[1]
bool isSlopingDown = basis < basis[1]

bool isBullishBreakout = squeezeReleaseUp and isSlopingUp
bool isBearishBreakout = squeezeReleaseDown and isSlopingDown

// --- Momentum Oscillator Value ---
// FIXED: Changed ta.avg to math.avg
float avgPrice = math.avg(ta.highest(high, momentumLength), ta.lowest(low, momentumLength))
float momentum = ta.linreg(source - avgPrice, momentumLength, 0)

// --- Color Logic ---
// -- Histogram Color --
color histColor = momentum >= 0 ? momentum > momentum[1] ? bullishIncreasingColor : bullishDecreasingColor : momentum < momentum[1] ? bearishDecreasingColor : bearishIncreasingColor

// -- Zero-Line Dot Color --
color dotColor = inSqueeze ? squeezeOnColor : useBreakoutColors and isBullishBreakout ? bullishBreakoutColor : useBreakoutColors and isBearishBreakout ? bearishBreakoutColor : squeezeOffColor

// --- Plotting ---
plot(momentum, 'Momentum', color = histColor, style = plot.style_histogram, linewidth = 4)
plot(0, 'Squeeze State', color = dotColor, style = plot.style_circles, linewidth = 4)
hline(0, 'Zero Line', color = color.new(color.gray, 50))
