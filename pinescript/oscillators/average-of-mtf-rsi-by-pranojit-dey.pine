//@version=5
indicator("MTF RSI Average", overlay = false)

// ───── INPUTS ─────

// Current TF RSI
showCurr  = input.bool(true,  "Show Current TF RSI")
currLen   = input.int(14,     "Current TF RSI Length")

// MTF 1
tf1   = input.timeframe("5",  "TF 1")
len1  = input.int(14,         "RSI Length TF 1")
show1 = input.bool(false,     "Show TF 1 RSI")

// MTF 2
tf2   = input.timeframe("15", "TF 2")
len2  = input.int(14,         "RSI Length TF 2")
show2 = input.bool(false,     "Show TF 2 RSI")

// MTF 3
tf3   = input.timeframe("30", "TF 3")
len3  = input.int(14,         "RSI Length TF 3")
show3 = input.bool(false,     "Show TF 3 RSI")

// MTF 4
tf4   = input.timeframe("60", "TF 4")
len4  = input.int(14,         "RSI Length TF 4")
show4 = input.bool(false,     "Show TF 4 RSI")

// Levels
obLevel  = input.int(70, "Overbought Level")
midLevel = input.int(50, "Mid Level")
osLevel  = input.int(30, "Oversold Level")

// Fill Colors
bullColor   = input.color(color.new(color.green, 80), "Overbought Fill Color")
bearColor   = input.color(color.new(color.red,   80), "Oversold Fill Color")

// ───── RSI CALCULATIONS ─────

// Current TF RSI (previous bar for full stability)
rsiCurr = ta.rsi(close, currLen)[1]

// MTF RSI — previous closed bar only
rsi1 = request.security(syminfo.tickerid, tf1, ta.rsi(close, len1)[1], lookahead = barmerge.lookahead_off)
rsi2 = request.security(syminfo.tickerid, tf2, ta.rsi(close, len2)[1], lookahead = barmerge.lookahead_off)
rsi3 = request.security(syminfo.tickerid, tf3, ta.rsi(close, len3)[1], lookahead = barmerge.lookahead_off)
rsi4 = request.security(syminfo.tickerid, tf4, ta.rsi(close, len4)[1], lookahead = barmerge.lookahead_off)

// ───── AVERAGE RSI ─────
avgRSI = (rsiCurr + rsi1 + rsi2 + rsi3 + rsi4) / 5.0

// ───── PLOTS ─────

// Average Line (Always Visible)
plot(avgRSI, title="Average RSI", linewidth=2)

// Optional individual plots
plot(showCurr ? rsiCurr : na, title="Current RSI")
plot(show1 ? rsi1 : na, title="TF1 RSI")
plot(show2 ? rsi2 : na, title="TF2 RSI")
plot(show3 ? rsi3 : na, title="TF3 RSI")
plot(show4 ? rsi4 : na, title="TF4 RSI")

// Levels
hOB  = hline(obLevel,  "Overbought")
hMID = hline(midLevel, "Mid")
hOS  = hline(osLevel,  "Oversold")

// ───── CONDITIONAL FILL COLOR ─────
fillColor =
     avgRSI <= osLevel ? bearColor :
     avgRSI >= obLevel ? bullColor :
     na

fill(hOB, hOS, color = fillColor)
