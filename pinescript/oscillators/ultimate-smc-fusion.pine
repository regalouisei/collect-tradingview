//@version=6
indicator("ðŸ’Ž ULTIMATE SMC FUSION ", overlay = true, max_labels_count = 500, max_lines_count = 500, max_boxes_count = 200)

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘       ðŸ’Ž ULTIMATE SMC FUSION  â€¢ CORE EDITION                             â•‘
// â•‘                                                                               â•‘
// â•‘  âœ¨ CORE FEATURES:                                                            â•‘
// â•‘  âœ… HTF OPTIMIZED - Enhanced logic for 30m, 1h, 4h (Reversals & RSI)           â•‘
// â•‘  âœ… NEON V2026 VISUALS - Glassmorphism stats & high-contrast UI               â•‘
// â•‘  âœ… SMC ENGINE - Complex structure and liquidity detection                     â•‘
// â•‘                 â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸŽ¨ NEON PREMIUM COLORS
//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

color_bull = #00FFBB
color_bear = #FF0077
color_accent = #7B1FA2

//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âš™ï¸ SETTINGS
//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Entry System
entry_mode = input.string("Balanced (Recommended)", "Entry Mode", options = ["Aggressive (More Signals)", "Balanced (Recommended)", "Conservative (Quality)"], group = "ðŸš€ Entry System")
show_tp_sl_lines = input.bool(true, "Show TP/SL Lines on Chart", group = "ðŸš€ Entry System")
show_labels = input.bool(true, "Show Signal Labels", group = "ðŸš€ Entry System")
enable_reversals = input.bool(true, "HTF Reversal Support (Pinbar/Engulfing)", group = "ðŸš€ Entry System")

// Patterns
enable_structure = input.bool(true, "Structure Breaks (BOS/CHoCH)", group = "ðŸŽ¯ Patterns")
enable_smc = input.bool(true, "SMC (OB/FVG/Liquidity)", group = "ðŸŽ¯ Patterns")
enable_divergence = input.bool(true, "RSI Divergence Detection", group = "ðŸŽ¯ Patterns")

// Filters
min_score = input.int(60, "Minimum Score (0-100)", minval = 1, group = "ðŸ”§ Filters")
tp1_pips = input.float(50, "TP1 (pips)", group = "ðŸŽ¯ Targets")
sl_pips = input.float(40, "Stop Loss (pips)", group = "ðŸŽ¯ Targets")

// Visuals
signal_size = input.string("Large", "Signal Size", options = ["Small", "Normal", "Large"], group = "ðŸŽ¨ Visuals")

//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ§  HELPERS
//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

pip_size = syminfo.type == "forex" ? 0.0001 : str.contains(syminfo.ticker, "XAU") ? 0.1 : 0.01
f_fmt(p) => str.tostring(p, format.mintick)

//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ“Š CALCULATIONS & LOGIC
//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ema_200 = ta.ema(close, 200)
ema_50 = ta.ema(close, 50)
vol_ma = ta.sma(volume, 20)
rsi_v = ta.rsi(close, 14)

// HTF Reversal Patterns
pin_bull = (high - low) > 3 * math.abs(open - close) and (high - math.max(open, close)) < (high - low) * 0.1
pin_bear = (high - low) > 3 * math.abs(open - close) and (math.min(open, close) - low) < (high - low) * 0.1
eng_bull = close > open and close[1] < open[1] and close > open[1] and open < close[1]
eng_bear = close < open and close[1] > open[1] and close < open[1] and open > close[1]

// Liquidity Sweep (PDH/PDL)
pdh = request.security(syminfo.tickerid, "D", high[1], lookahead = barmerge.lookahead_on)
pdl = request.security(syminfo.tickerid, "D", low[1], lookahead = barmerge.lookahead_on)
sweep_b = low < pdl and close > pdl
sweep_s = high > pdh and close < pdh

// Signal Scoring
bos_bull = enable_structure and close > ta.highest(high[1], 5) and close > ema_50
bos_bear = enable_structure and close < ta.lowest(low[1], 5) and close < ema_50
rev_bull = enable_reversals and (pin_bull or eng_bull) and (sweep_b or rsi_v < 35)
rev_bear = enable_reversals and (pin_bear or eng_bear) and (sweep_s or rsi_v > 65)

// ADX for Trend Strength
adx_len = 14
tr_v = math.max(high - low, math.max(math.abs(high - close[1]), math.abs(low - close[1])))
dm_p = high - high[1] > low[1] - low ? math.max(high - high[1], 0) : 0
dm_m = low[1] - low > high - high[1] ? math.max(low[1] - low, 0) : 0
tr_s = ta.rma(tr_v, adx_len), dm_ps = ta.rma(dm_p, adx_len), dm_ms = ta.rma(dm_m, adx_len)
adx_v = ta.rma(math.abs(dm_ps - dm_ms) / (dm_ps + dm_ms == 0 ? 1 : dm_ps + dm_ms) * 100, adx_len)

// Final Score Logic
calc_score(is_bull) =>
    float s = 40.0
    s += adx_v > 20 ? 15 : 0
    s += volume > vol_ma ? 15 : 0
    s += (is_bull ? bos_bull or rev_bull : bos_bear or rev_bear) ? 20 : 0
    s += (is_bull ? close > ema_200 : close < ema_200) ? 10 : 0
    math.min(s, 100)

score_b = calc_score(true), score_s = calc_score(false)
is_r = rev_bull or rev_bear
signal_mode = is_r ? "REVERSAL" : "SMC"

new_long = (score_b >= min_score) and not (score_b[1] >= min_score) and barstate.isconfirmed
new_short = (score_s >= min_score) and not (score_s[1] >= min_score) and barstate.isconfirmed

//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ’° TRADE LEVELS
//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

l_tp1 = close + (tp1_pips * pip_size)
l_sl = close - (sl_pips * pip_size)
s_tp1 = close - (tp1_pips * pip_size)
s_sl = close + (sl_pips * pip_size)

// Labels
if show_labels and (new_long or new_short)
    cur_score = new_long ? score_b : score_s
    label.new(bar_index, new_long ? low : high, (new_long ? "ðŸš€ LONG" : "ðŸ“‰ SHORT") + " " + signal_mode + " [" + str.tostring(math.round(cur_score)) + "]\nðŸŽ¯ " + f_fmt(new_long ? l_tp1 : s_tp1), style = new_long ? label.style_label_up : label.style_label_down, color = color.new(new_long ? color_bull : color_bear, 0), textcolor = new_long ? color.black : color.white, size = signal_size == "Large" ? size.large : size.normal)

plot(ema_50, color = color.new(color_bull, 50)), plot(ema_200, color = color.new(color_accent, 30), linewidth = 2)
barcolor(close > open ? color.new(color_bull, 50) : color.new(color_bear, 50))
