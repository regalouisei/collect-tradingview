//@version=6
indicator("Pair Correlation Oscillator (Overlay)", shorttitle="CorrPair")

// ---------------- USER INPUTS ----------------
sym_chart = syminfo.tickerid                     // Ticker 1: always the chart we're on
sym_other = input.symbol("TVC:DXY", "Ticker 2")  // Ticker 2: user input
length = input.int(500, "Correlation length (bars)", minval=2, maxval=5000)
useReturns = input.bool(true, "Use log returns (recommended)")

// ---------------- FETCH SERIES ----------------
// For the chart symbol we can use the local `close` (no request needed)
priceA = close
// For the user-specified ticker, fetch its close on the same timeframe
priceB = request.security(sym_other, timeframe.period, close,lookahead=barmerge.lookahead_off,gaps=barmerge.gaps_off)

// convert to log returns if requested (safer for correlation between different instruments)
to_log_return(x) => x > 0 and x[1] > 0 ? math.log(x) - math.log(x[1]) : na
seriesA = useReturns ? to_log_return(priceA) : priceA
seriesB = useReturns ? to_log_return(priceB) : priceB

// ---------------- CORRELATION ----------------
corr = ta.correlation(seriesA, seriesB, length)

// ---------------- PLOTTING ----------------
hline(0, "Zero", color=color.gray, linestyle=hline.style_dotted)
hline(1, "+1 (Perfect)", color=color.new(color.green, 90))
hline(-1, "-1 (Inverse)", color=color.new(color.red, 90))

// color logic (green positive, red negative, yellow near zero)
near_zero = math.abs(corr) < 0.15
base_color = corr >= 0 ? color.green : color.red
plot_color = near_zero ? color.yellow : base_color

// main line
plot(corr, title="Correlation (-1..1)", color=plot_color, linewidth=2)

// histogram (use color.new to set transparency)
plot(corr, title="Corr histogram", style=plot.style_columns, color=color.new(plot_color, 65))

// numeric label on last bar (rounded to 4 decimals)
if barstate.islast
    lbl_text = str.format("{0} ↔ {1} • Corr({2}) = {3}", 
                          syminfo.ticker, sym_other, length, 
                          math.round(corr * 10000) / 10000)
    label.new(bar_index, corr, lbl_text, 
              xloc=xloc.bar_index, yloc=yloc.price, 
              style=label.style_label_left, 
              color=color.new(color.blue, 85), 
              textcolor=color.white,
              tooltip="Correlation coefficient: +1 = perfect positive, -1 = perfect inverse, 0 = no correlation")
