//@version=6
indicator("Mentor Michael - Institutional Flow Engine v4",
     overlay=true, max_labels_count=500, max_lines_count=500)

// ═══════════════════════════════════════
// SETTINGS
// ═══════════════════════════════════════

groupFlow = "Orderflow Engine"
groupSMC  = "Smart Money Concepts"
groupRSI  = "RSI Engine"
groupVis  = "Visual Settings"

lowerTF     = input.timeframe("1", "Lower Timeframe", group=groupFlow)
deltaLen    = input.int(20, "Delta Window", minval=1, group=groupFlow)
momentumLen = input.int(10, "Momentum Length", minval=1, group=groupFlow)

swingLen    = input.int(5, "Structure Swing Length", minval=1, group=groupSMC)
showFVG     = input.bool(true, "Show Fair Value Gaps", group=groupSMC)
showSweep   = input.bool(true, "Show Liquidity Sweeps", group=groupSMC)

rsiLen      = input.int(14, "RSI Length", group=groupRSI)
rsiOB       = input.int(70, "Overbought Level", group=groupRSI)
rsiOS       = input.int(30, "Oversold Level", group=groupRSI)
useRSIFilter = input.bool(true, "Use RSI in Score", group=groupRSI)

bullColor   = input.color(color.lime, "Bull Color", group=groupVis)
bearColor   = input.color(color.red, "Bear Color", group=groupVis)

// ═══════════════════════════════════════
// SAFE DELTA FUNCTION
// ═══════════════════════════════════════

getDelta() =>
    float d = 0.0
    if close > open
        d := volume
    else if close < open
        d := -volume
    d

array<float> ltfData = request.security_lower_tf(syminfo.tickerid, lowerTF, getDelta())

float barDelta = 0.0
if array.size(ltfData) > 0
    for i = 0 to array.size(ltfData) - 1
        barDelta += array.get(ltfData, i)
else
    barDelta := getDelta()

// ═══════════════════════════════════════
// DELTA ENGINE
// ═══════════════════════════════════════

rollingDelta  = math.sum(barDelta, deltaLen)
deltaMomentum = rollingDelta - rollingDelta[momentumLen]

buyVol  = close > open ? volume : 0.0
sellVol = close < open ? volume : 0.0

buySum  = math.sum(buyVol, deltaLen)
sellSum = math.sum(sellVol, deltaLen)

aggression = sellSum != 0 ? buySum / sellSum : 1.0

// ═══════════════════════════════════════
// MARKET STRUCTURE
// ═══════════════════════════════════════

swingHigh = ta.pivothigh(high, swingLen, swingLen)
swingLow  = ta.pivotlow(low, swingLen, swingLen)

var float lastHigh = na
var float lastLow  = na

if not na(swingHigh)
    lastHigh := high[swingLen]

if not na(swingLow)
    lastLow := low[swingLen]

bullBOS = not na(lastHigh) and close > lastHigh
bearBOS = not na(lastLow) and close < lastLow

// ═══════════════════════════════════════
// LIQUIDITY SWEEPS
// ═══════════════════════════════════════

sweepHigh = high > ta.highest(high[1], swingLen) and close < open
sweepLow  = low < ta.lowest(low[1], swingLen) and close > open

// ═══════════════════════════════════════
// FAIR VALUE GAP
// ═══════════════════════════════════════

bullFVG = showFVG and low > high[2]
bearFVG = showFVG and high < low[2]

// ═══════════════════════════════════════
// RSI ENGINE
// ═══════════════════════════════════════

rsi = ta.rsi(close, rsiLen)

rsiBull = rsi > 50
rsiBear = rsi < 50

rsiOverbought = rsi > rsiOB
rsiOversold   = rsi < rsiOS

// ═══════════════════════════════════════
// INSTITUTIONAL SCORE
// ═══════════════════════════════════════

score = 0.0

if rollingDelta > 0
    score += 20
if deltaMomentum > 0
    score += 15
if aggression > 1
    score += 15
if bullBOS
    score += 20
if sweepLow
    score += 10
if bullFVG
    score += 10

// RSI Contribution
if useRSIFilter
    if rsiBull
        score += 10
    if rsiOverbought
        score -= 5

score := math.max(math.min(score, 100), 0)

// ═══════════════════════════════════════
// VISUALS
// ═══════════════════════════════════════

// Institutional Score
plot(score,
     title="Institutional Score",
     color = score >= 70 ? bullColor :
             score <= 30 ? bearColor :
             color.gray,
     linewidth=3)

hline(70, "Strong Bull Zone", color=color.new(bullColor,70))
hline(30, "Strong Bear Zone", color=color.new(bearColor,70))
hline(50, "Neutral", color=color.new(color.gray,80))

// RSI Plot
plot(rsi, title="RSI", color=color.blue, linewidth=2)
hline(rsiOB, "RSI Overbought", color=color.new(color.red,60))
hline(rsiOS, "RSI Oversold", color=color.new(color.green,60))

// Background Bias
bgcolor(score >= 85 ? color.new(bullColor, 90) :
        score <= 15 ? color.new(bearColor, 90) : na)

// ═══════════════════════════════════════
// ALERTS
// ═══════════════════════════════════════

alertcondition(score >= 85,
     title="High Confidence Bullish Flow",
     message="Mentor Michael: Institutional Buying + RSI Confirmed")

alertcondition(score <= 15,
     title="High Confidence Bearish Flow",
     message="Mentor Michael: Institutional Selling + RSI Confirmed")
