//@version=5
indicator("Custom Sector Comparison Index (Checkbox)", overlay=false)

// --- 1. CONFIGURATION ---
startDate = input.time(timestamp("01 Jan 2025 00:00"), "Comparison Start Date", tooltip="The date where all performance resets to 0%")

// --- 2. SELECTABLE SYMBOLS WITH CHECKBOXES ---
// We use 'inline' to put the checkbox and symbol on the same row.
// Uncheck the box to IGNORE that symbol.
g1  = "Basket Components"

use_s01 = input.bool(true, "", inline="s01", group=g1)
s01     = input.symbol("NYSE:VRE", "Symbol 1", inline="s01", group=g1)

use_s02 = input.bool(true, "", inline="s02", group=g1)
s02     = input.symbol("NYSE:UDR", "Symbol 2", inline="s02", group=g1)

use_s03 = input.bool(true, "", inline="s03", group=g1)
s03     = input.symbol("NYSE:MAA", "Symbol 3", inline="s03", group=g1)

use_s04 = input.bool(true, "", inline="s04", group=g1)
s04     = input.symbol("NYSE:EQR", "Symbol 4", inline="s04", group=g1)

use_s05 = input.bool(true, "", inline="s05", group=g1)
s05     = input.symbol("NYSE:INVH", "Symbol 5", inline="s05", group=g1)

use_s06 = input.bool(true, "", inline="s06", group=g1)
s06     = input.symbol("NYSE:ESS", "Symbol 6", inline="s06", group=g1)

use_s07 = input.bool(true, "", inline="s07", group=g1)
s07     = input.symbol("NYSE:CPT", "Symbol 7", inline="s07", group=g1)

use_s08 = input.bool(true, "", inline="s08", group=g1)
s08     = input.symbol("NYSE:AVB", "Symbol 8", inline="s08", group=g1)

use_s09 = input.bool(true, "", inline="s09", group=g1)
s09     = input.symbol("NYSE:AMH", "Symbol 9", inline="s09", group=g1)

use_s10 = input.bool(true, "", inline="s10", group=g1)
s10     = input.symbol("NYSE:CSR", "Symbol 10", inline="s10", group=g1)

use_s11 = input.bool(false, "", inline="s11", group=g1) // Defaulted to OFF
s11     = input.symbol("SPY", "Symbol 11", inline="s11", group=g1)

use_s12 = input.bool(false, "", inline="s12", group=g1) // Defaulted to OFF
s12     = input.symbol("SPY", "Symbol 12", inline="s12", group=g1)

// --- 3. SAFE REQUEST LOGIC ---
// We only request data if the checkbox is ON.
// If OFF, we request "SPY" just to keep the script running, but ignore it later.

get_data(use_sym, sym_ticker) =>
    request.security(use_sym ? sym_ticker : "SPY", timeframe.period, close)

p01 = get_data(use_s01, s01)
p02 = get_data(use_s02, s02)
p03 = get_data(use_s03, s03)
p04 = get_data(use_s04, s04)
p05 = get_data(use_s05, s05)
p06 = get_data(use_s06, s06)
p07 = get_data(use_s07, s07)
p08 = get_data(use_s08, s08)
p09 = get_data(use_s09, s09)
p10 = get_data(use_s10, s10)
p11 = get_data(use_s11, s11)
p12 = get_data(use_s12, s12)

// --- 4. RETURN CALCULATION ---
calc_return(currentPrice, _start) =>
    var float initialPrice = na
    if time >= _start and na(initialPrice)
        initialPrice := currentPrice
    
    if not na(initialPrice) and initialPrice != 0
        (currentPrice - initialPrice) / initialPrice * 100
    else
        na

r01 = calc_return(p01, startDate)
r02 = calc_return(p02, startDate)
r03 = calc_return(p03, startDate)
r04 = calc_return(p04, startDate)
r05 = calc_return(p05, startDate)
r06 = calc_return(p06, startDate)
r07 = calc_return(p07, startDate)
r08 = calc_return(p08, startDate)
r09 = calc_return(p09, startDate)
r10 = calc_return(p10, startDate)
r11 = calc_return(p11, startDate)
r12 = calc_return(p12, startDate)

// --- 5. AGGREGATION LOGIC ---
// Now we check the CHECKBOX (use_sXX) instead of checking for empty text.
float sumReturns = 0.0
int validCount = 0

// Helper to add to sum
add_to_index(use_it, ret_val) =>
    if use_it and not na(ret_val)
        [ret_val, 1]
    else
        [0.0, 0]

[v01, c01] = add_to_index(use_s01, r01)
[v02, c02] = add_to_index(use_s02, r02)
[v03, c03] = add_to_index(use_s03, r03)
[v04, c04] = add_to_index(use_s04, r04)
[v05, c05] = add_to_index(use_s05, r05)
[v06, c06] = add_to_index(use_s06, r06)
[v07, c07] = add_to_index(use_s07, r07)
[v08, c08] = add_to_index(use_s08, r08)
[v09, c09] = add_to_index(use_s09, r09)
[v10, c10] = add_to_index(use_s10, r10)
[v11, c11] = add_to_index(use_s11, r11)
[v12, c12] = add_to_index(use_s12, r12)

sumReturns := v01+v02+v03+v04+v05+v06+v07+v08+v09+v10+v11+v12
validCount := c01+c02+c03+c04+c05+c06+c07+c08+c09+c10+c11+c12

// --- 6. PLOT ---
indexPerf = validCount > 0 ? (sumReturns / validCount) : na
myPerf = calc_return(close, startDate)

plot(indexPerf, title="Basket Index Avg %", color=color.gray, linewidth=2)
plot(myPerf, title="Current Symbol %", color=color.blue, linewidth=2)
fill(plot(indexPerf), plot(myPerf), color = myPerf > indexPerf ? color.new(color.green, 80) : color.new(color.red, 80))
