//@version=5
strategy("RSI Trendline Breakout BB Exit (2% SL / 3R TP)", overlay=false)

// ---------------------------------------------------------
// RSI
// ---------------------------------------------------------
rsiLen = input.int(14)
src = close
rsi = ta.rsi(src, rsiLen)

// RSI Trendline Pivots
leftBars  = input.int(3)
rightBars = input.int(3)

pivotHigh = ta.pivothigh(rsi, leftBars, rightBars)
pivotLow  = ta.pivotlow(rsi, leftBars, rightBars)

var float lowTL  = na
var float highTL = na

if not na(pivotLow)
    lowTL := pivotLow

if not na(pivotHigh)
    highTL := pivotHigh

rsiBreakUp   = ta.crossover(rsi, lowTL)
rsiBreakDown = ta.crossunder(rsi, highTL)

// ---------------------------------------------------------
// Higher Timeframe RSI Filter
// ---------------------------------------------------------
rsiHTF = request.security(syminfo.tickerid, "60", ta.rsi(src, rsiLen))
allowLong  = rsiHTF > 50
allowShort = rsiHTF < 50

// Noise filters
longZone  = rsi > 60
shortZone = rsi < 40

// ---------------------------------------------------------
// RSI Bollinger Band Exit
// ---------------------------------------------------------
bbLen  = input.int(20)
bbMult = input.float(2.0)

basis = ta.sma(rsi, bbLen)
dev   = ta.stdev(rsi, bbLen)

upperBB = basis + dev * bbMult
lowerBB = basis - dev * bbMult

exitLong  = rsi >= upperBB * 0.98
exitShort = rsi <= lowerBB * 1.02

// ---------------------------------------------------------
// 2% Stop Loss + 3R Take Profit (6%)
// ---------------------------------------------------------
stopPercent   = 0.02     // 2%
targetPercent = 0.06     // 6%

longStop  = close * (1 - stopPercent)
longTP    = close * (1 + targetPercent)

shortStop = close * (1 + stopPercent)
shortTP   = close * (1 - targetPercent)

// ---------------------------------------------------------
// Entries
// ---------------------------------------------------------
if rsiBreakUp and longZone and allowLong
    strategy.entry("Long", strategy.long)

if rsiBreakDown and shortZone and allowShort
    strategy.entry("Short", strategy.short)

// ---------------------------------------------------------
// Exits: 2% SL / 6% TP + RSI BB exit
// ---------------------------------------------------------
strategy.exit("XL", "Long", stop = longStop, limit = longTP)
strategy.exit("XS", "Short", stop = shortStop, limit = shortTP)

if strategy.position_size > 0 and exitLong
    strategy.close("Long")

if strategy.position_size < 0 and exitShort
    strategy.close("Short")

// ---------------------------------------------------------
// Plot
// ---------------------------------------------------------
plot(rsi, "RSI")
plot(lowTL, "Lower TL", color=color.new(color.green, 0))
plot(highTL, "Upper TL", color=color.new(color.red, 0))
plot(upperBB, "UpperBB", color=color.new(color.purple, 40))
plot(lowerBB, "LowerBB", color=color.new(color.purple, 40))
