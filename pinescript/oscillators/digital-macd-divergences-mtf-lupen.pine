//@version=6
indicator(title="Digital MACD Divergences MTF [LUPEN]", shorttitle="DMACD DIV HTF", overlay=false, max_bars_back = 5000, max_lines_count = 500)

//HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH//
//    DEFINED TYPES   
//HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH//

type DigiData
    float graph
    float signal
    bool  crossUp
    bool  crossDn

//HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH//
// CONSTANTS & INPUTS   
//HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH//

string G_CALC  = "══════ CALCULATION ══════"
string G_VIS   = "══════ VISUALS ══════"
string G_DIV   = "══════ DIVERGENCES ══════"
string G_ALERT = "══════ ALERTS ══════"

// Inputs with Detailed Tooltips
string i_htf    = input.timeframe("", "Timeframe", inline = "macd_", group=G_CALC, tooltip="Selects the timeframe for the indicator calculation.")
int i_sigPeriod = input.int(5, "Signal MA Period", inline = "macd_", minval=1, group=G_CALC, tooltip="Specifies the number of periods used to calculate the MACD.")

// Colors
color c_up      = input.color(#29ff89, "Up Color", inline = "col_inp", group=G_VIS, tooltip="Defines the primary color used for bullish histogram bars and the upper gradient fill, visually representing positive market momentum and potential buying opportunities on the chart.")
color c_down    = input.color(color.new(#df06a8, 0), "Down Color", inline = "col_inp", group=G_VIS, tooltip="Defines the primary color used for bearish histogram bars and the lower gradient fill, visually representing negative market momentum and potential selling opportunities on the chart.")
color c_signal  = input.color(color.new(#FFFFFF, 0), "Signal Color", inline = "col_inp", group=G_VIS, tooltip="Sets the color for the signal line, which is the moving average of the digital graph, used to identify crossovers and trend direction changes clearly.")

// Divergence Inputs
bool i_showDiv  = input.bool(true, "Show Divergences", group=G_DIV, inline = "div", tooltip="Toggles the visibility of divergence lines.")
bool show_fill  = input.bool(true, "Show Div Fill?", group=G_DIV, inline = "div")
int  i_lookback = input.int(5, "Div Lookback", minval=1, inline = "div_inp", group=G_DIV, tooltip="Sets the number of bars required to confirm a pivot point. A higher value reduces noise but delays the detection of divergence lines.")
int  i_width    = input.int(2, "Line Width", minval=1, inline = "div_inp", group=G_DIV, tooltip="Controls the thickness of the divergence lines drawn on the chart.")
color c_divBull = input.color(#df06a8, "Bull Div Color", inline = "div_col", group=G_DIV, tooltip="Sets the color for bullish divergence lines and fills, typically used to signal potential upward reversals when price makes lower lows but the oscillator makes higher lows.")
color c_divBear = input.color(#29ff89, "Bear Div Color", inline = "div_col", group=G_DIV, tooltip="Sets the color for bearish divergence lines and fills, typically used to signal potential downward reversals when price makes higher highs but the oscillator makes lower highs.")
bool _show_line = input.bool(false, "Show Overbought/Oversold Lines", group=G_DIV)
int  i_lines    = input.int(10, "Overbought/Oversold custom values", minval=1, inline = "div_inp", group=G_DIV)
// Alerts
bool i_alert    = input.bool(true, "Enable Alerts", group=G_ALERT, tooltip="Master switch to enable or disable all alert notifications generated by this indicator.")

//HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH//
//  HELPER FUNCTIONS     
//HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH//

safe_get(array<float> arr, int index) =>
    array.size(arr) > 0 ? array.get(arr, math.max(0, math.min(index, array.size(arr) - 1))) : 0.0

// Coefficients
get_coeffs_1() =>
    array.from(
         0.2149840610, 0.2065763732, 0.1903728890, 0.1675422436, 0.1397053150, 0.1087951881, 0.0768869405, 0.0460244906, 0.0180517395, -0.0055294579,
        -0.0236660212, -0.0358140055, -0.0419497760, -0.0425331450, -0.0384279507, -0.0307917433, -0.0209443384, -0.0102335925,  0.0000932767,  0.0089950015,
         0.0157131144, 0.0198149331, 0.0211989019, 0.0200639819, 0.0168532934, 0.0121825067, 0.0067474241, 0.0012444305, -0.0037087682, -0.0076300416,
        -0.0102110543, -0.0113306266, -0.0110462105, -0.0095662166, -0.0072080453, -0.0043494435, -0.0013771970,  0.0013575268,  0.0035760416,  0.0050946166,
         0.0058339574, 0.0058160431, 0.0051486631, 0.0039984014, 0.0025619380, 0.0010531475, -0.0003481453, -0.0014937154, -0.0022905986, -0.0027000514,
        -0.0027359080, -0.0024543322, -0.0019409837, -0.0012957482, -0.0006179734,  0.0000057542,  0.0005111297,  0.0008605279,  0.0010441921,  0.0010775684,
         0.0009966494, 0.0008537300, 0.0007142855, 0.0006599146, -0.0008151017)

get_coeffs_2() =>
    array.from(
         0.0825641231, 0.0822783080, 0.0814249974, 0.0800166909, 0.0780735197, 0.0756232268, 0.0727009740, 0.0693478349, 0.0656105823, 0.0615409157,
         0.0571939540, 0.0526285643, 0.0479025123, 0.0430785482, 0.0382152880, 0.0333706133, 0.0286021160, 0.0239614376, 0.0194972056, 0.0152532583,
         0.0112682658, 0.0075745482, 0.0041980052, 0.0011588603, -0.0015292889, -0.0038593393, -0.0058303888, -0.0074473108, -0.0087203043, -0.0096645874,
        -0.0102995666, -0.0106483424, -0.0107374524, -0.0105952115, -0.0102516944, -0.0097377645, -0.0090838346, -0.0083237046, -0.0074804382, -0.0065902734,
        -0.0056742995, -0.0047554314, -0.0038574209, -0.0029983549, -0.0021924972, -0.0014513858, -0.0007848072, -0.0001995891,  0.0003009728,  0.0007162164,
         0.0010478905, 0.0012994016, 0.0014755433, 0.0015824007, 0.0016272598, 0.0016185271, 0.0015648336, 0.0014747659, 0.0013569946, 0.0012193896,
         0.0010695971, 0.0009140878, 0.0007591540, 0.0016019033)

//HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH//
//  MAIN LOGIC           
//HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH//

// --- Data Containers ---
var DigiData curData = DigiData.new(0.0, 0.0, false, false)

// --- Calculation Function ---
f_calc_digi(int sig_len) =>
    var c1 = get_coeffs_1()
    var c2 = get_coeffs_2()
    
    float val1 = 0.0
    float val2 = 0.0
    int size1 = array.size(c1)
    int size2 = array.size(c2)
    
    // Convolution Loop
    if bar_index >= math.max(size1, size2)
        for i = 0 to size1 - 1
            val1 += close[i] * safe_get(c1, i)
        for j = 0 to size2 - 1
            val2 += close[j] * safe_get(c2, j)
            
    float gVal = val1 - val2
    float sVal = ta.sma(gVal, sig_len)
    [gVal, sVal]

// --- Execution with MTF ---
[graphVal, sigVal] = request.security(syminfo.tickerid, i_htf, f_calc_digi(i_sigPeriod))

// --- Update UDT ---
curData.graph   := graphVal
curData.signal  := sigVal
curData.crossUp := ta.crossover(graphVal, sigVal)
curData.crossDn := ta.crossunder(graphVal, sigVal)

//HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH//
//  PLOTTING & VISUALS   
//HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH//

// --- Plots for Fill ---
p_graph = plot(curData.graph, "Graph Value", display=display.pine_screener)
p_zero  = plot(0, "Zero Line", color=#787b8680, display=display.none)
fill(plot1 = p_graph, plot2 = p_zero, top_value = curData.graph, bottom_value = 0, top_color = curData.graph > 0 ? color.new(c_up, 50) : color.new(c_down, 50), bottom_color = color.new(chart.bg_color, 80), title = "Digital Gradient", display=display.all)


// --- Main visuals ---
plot(curData.signal, title="Signal Line", color=c_signal, linewidth=1, display=display.pine_screener)
plot(curData.graph, title="Graph Edge", color=curData.graph > 0 ? c_up : c_down, linewidth=1, style=plot.style_line, display=display.pine_screener)


// --- Horizontal  lines ---
hline(0, title = "Zero line", color = #9fa7c7f5, linestyle = hline.style_dotted, linewidth = 1 )
hline(_show_line ? i_lines : na, title = "Overbought line", color = #9fa7c7f5, linestyle = hline.style_dotted, linewidth = 1 )
hline(_show_line ? -i_lines : na, title = "Oversold line", color = #9fa7c7f5, linestyle = hline.style_dotted, linewidth = 1 )


//HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH//
//    DIVERGENCE LOGIC     
//HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH//

float pl = ta.pivotlow(graphVal, i_lookback, i_lookback)
float ph = ta.pivothigh(graphVal, i_lookback, i_lookback)

// State Variables for Divergence
var float last_pl_val = na
var int   last_pl_idx = na
var float last_low_val = na 

var float last_ph_val = na
var int   last_ph_idx = na
var float last_high_val = na 

bool alert_div_bull = false
bool alert_div_bear = false

// Bullish Divergence
if not na(pl) and i_showDiv
    float curr_pl_val = pl
    int curr_pl_idx = bar_index - i_lookback
    float curr_low_val = low[i_lookback] 
    
    if not na(last_pl_val)
        if curr_pl_val > last_pl_val and curr_low_val < last_low_val 
            line l_div = line.new(last_pl_idx, last_pl_val, curr_pl_idx, curr_pl_val, color=c_divBear, width=i_width)
            line l_ref = line.new(last_pl_idx, 0, curr_pl_idx, 0, color=color.new(c_divBear, 100)) // Invisible reference line at zero
            linefill.new(l_div, l_ref, color = show_fill ? color.new(c_divBear, 80) : color.new(c_divBear, 100))
            alert_div_bull := true
            
    last_pl_val := curr_pl_val
    last_pl_idx := curr_pl_idx
    last_low_val := curr_low_val

// Bearish Divergence
if not na(ph) and i_showDiv
    float curr_ph_val = ph
    int curr_ph_idx = bar_index - i_lookback
    float curr_high_val = high[i_lookback]
    
    if not na(last_ph_val)
        if curr_ph_val < last_ph_val and curr_high_val > last_high_val
            line l_div = line.new(last_ph_idx, last_ph_val, curr_ph_idx, curr_ph_val, color=c_divBull, width=i_width)
            line l_ref = line.new(last_ph_idx, 0, curr_ph_idx, 0, color=color.new(c_divBull, 100)) // Invisible reference line at zero
            linefill.new(l_div, l_ref, show_fill ?  color.new(c_divBull, 80) : color.new(c_divBull, 100))
            alert_div_bear := true
            
    last_ph_val := curr_ph_val
    last_ph_idx := curr_ph_idx
    last_high_val := curr_high_val

//HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH//
// ALERTS               
//HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH//

string alert_msg = syminfo.tickerid + " | Digital MACD: at price" + str.tostring(close)

if i_alert
    if curData.crossUp
        alert("CROSS UP " + alert_msg, freq=alert.freq_once_per_bar_close)
    if curData.crossDn
        alert("CROSS DOWN " + alert_msg, freq=alert.freq_once_per_bar_close)
    if alert_div_bull
        alert("BULLISH DIVERGENCE " + alert_msg, freq=alert.freq_once_per_bar_close)
    if alert_div_bear
        alert("BEARISH DIVERGENCE " + alert_msg, freq=alert.freq_once_per_bar_close)
