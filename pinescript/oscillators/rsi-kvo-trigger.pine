//@version=5
indicator("RSI + KVO Trigger (Aligned Midline)", shorttitle="RSI_KVO", overlay=false, timeframe="", timeframe_gaps=true)

//––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––
// RSI INPUTS
//––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––
rsiLength   = input.int(14,    "RSI Length", minval=1)
rsiSource   = input.source(close, "RSI Source")
rsiUpper    = input.float(70.0, "RSI Upper Level", minval=0.0, maxval=100.0)
rsiMiddle   = input.float(50.0, "RSI Middle Level", minval=0.0, maxval=100.0)
rsiLower    = input.float(30.0, "RSI Lower Level", minval=0.0, maxval=100.0)

// RSI visual options
rsiColor        = input.color(color.new(color.teal, 0), "RSI Color")
rsiWidth        = input.int(2, "RSI Line Width", minval=1, maxval=5)
rsiStyle        = input.string("Solid", "RSI Line Style", options=["Solid","Dashed","Dotted"])
rsiStyleEnum    = rsiStyle == "Solid" ? plot.style_line : rsiStyle == "Dashed" ? plot.style_linebr : plot.style_circles

upperColor      = input.color(color.new(color.gray, 60), "Upper Level Color")
middleColor     = input.color(color.new(color.gray, 70), "Middle / 0 Line Color")
lowerColor      = input.color(color.new(color.gray, 60), "Lower Level Color")
levelWidth      = input.int(1, "Level Line Width", minval=1, maxval=3)

//––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––
// KVO INPUTS (Trigger Line Only)
//––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––
kvoFastLen  = input.int(34, "KVO Fast EMA", minval=1)
kvoSlowLen  = input.int(55, "KVO Slow EMA", minval=1)
kvoSignalLen= input.int(13, "KVO Signal Length", minval=1)

// KVO trigger visual options (drawn in RSI scale)
kvoTrigColor    = input.color(color.new(color.orange, 0), "KVO Trigger Color")
kvoTrigWidth    = input.int(2, "KVO Trigger Width", minval=1, maxval=5)
kvoTrigStyleSel = input.string("Solid", "KVO Trigger Style", options=["Solid","Dashed","Dotted"])
kvoTrigStyle    = kvoTrigStyleSel == "Solid" ? plot.style_line : kvoTrigStyleSel == "Dashed" ? plot.style_linebr : plot.style_circles

//––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––
// CALCULATE RSI
//––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––
rsiValue = ta.rsi(rsiSource, rsiLength)

//––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––
// CALCULATE KVO + SIGNAL (TRIGGER)
//  Basic Klinger Volume Oscillator implementation:
//  sv  = change(hlc3) >= 0 ? volume : -volume
//  kvo = ema(sv, fast) - ema(sv, slow)
//  sig = ema(kvo, signalLen)
//––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––
hlc3Value = (high + low + close) / 3.0
sv        = ta.change(hlc3Value) >= 0 ? volume : -volume
kvo       = ta.ema(sv, kvoFastLen) - ta.ema(sv, kvoSlowLen)
kvoTrig   = ta.ema(kvo, kvoSignalLen)

//––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––
// ALIGN KVO TRIGGER LINE TO RSI SCALE
//  We map KVO so its 0.0 equals RSI midline (50 by default).
//  Optionally normalize by ATR of KVO to keep it visually reasonable.
//––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––
kvoNormLength = input.int(100, "KVO Normalization Length", minval=10)

// Use simple normalization: divide by its recent ATR and scale to a visual factor.
kvoAtr   = ta.atr(1)  // dummy ATR, not ideal: Pine cannot ATR on arbitrary series directly
// Instead, use stdev as a proxy for amplitude
kvoStdev = ta.stdev(kvoTrig, kvoNormLength)
scaleFactor = 10.0   // visual scaling; adjust if you want the KVO line bigger/smaller

kvoTrigScaled = rsiMiddle + (kvoTrig / nz(kvoStdev, 1)) * scaleFactor

//––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––
// PLOTS
//––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––

// RSI line
plot(rsiValue, title="RSI", color=rsiColor, linewidth=rsiWidth, style=rsiStyleEnum)

// RSI levels (upper, middle / 0-line, lower)
hline(rsiUpper,  "RSI Upper",  color=upperColor,  linestyle=hline.style_dashed, linewidth=levelWidth)
hline(rsiMiddle, "RSI Mid / 0", color=middleColor, linestyle=hline.style_solid,  linewidth=levelWidth)
hline(rsiLower,  "RSI Lower",  color=lowerColor,  linestyle=hline.style_dashed, linewidth=levelWidth)

// KVO trigger line plotted on RSI scale, 0 of KVO at RSI middle level
plot(kvoTrigScaled, title="KVO Trigger (Aligned)", color=kvoTrigColor, linewidth=kvoTrigWidth, style=kvoTrigStyle)
