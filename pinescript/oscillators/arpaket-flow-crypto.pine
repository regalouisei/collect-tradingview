// This Pine Script‚Ñ¢ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// ¬© Smart Money Flow Indicator v1.0
// ===================================================================================
// ARPAKET_FLOW - Multi-Asset Edition
// ===================================================================================
// 
// DESCRIPTION:
// A comprehensive money flow indicator that visualizes whether smart money is 
// flowing INTO or OUT of the market, with intensity measurement for buy/sell decisions.
//
// FEATURES:
// - Multi-asset support (Crypto, Low Liquidity Stocks, High Liquidity Markets)
// - Multiple trading styles (Scalping, Day Trading, Swing, Position Trading)
// - Whale activity detection for crypto
// - Multi-timeframe analysis
// - Composite Flow Score (0-100)
// - Visual dashboard with actionable signals
//
// HOW TO USE:
// 1. Select your Market Type (Crypto/Low Liquidity/High Liquidity)
// 2. Select your Trading Style (Scalping/Day Trading/Swing/Position)
// 3. Adjust sensitivity based on your risk preference
// 4. Watch for BUY/SELL signals and Flow Score
//
// INTERPRETATION:
// - Green histogram = Money flowing IN (bullish)
// - Red histogram = Money flowing OUT (bearish)
// - Score > 70 = Strong buy zone
// - Score < 30 = Strong sell zone
// - Whale icons = Large player activity detected
// ===================================================================================

//@version=5
indicator("Arpaket_FLOW", shorttitle="ARPAKET", overlay=false, precision=2)

// ===================================================================================
// INPUT SETTINGS
// ===================================================================================

// ‚îÄ‚îÄ‚îÄ General Settings ‚îÄ‚îÄ‚îÄ
grp_general = "‚ïê‚ïê‚ïê General Settings ‚ïê‚ïê‚ïê"
i_marketType = input.string("Crypto", "Market Type", options=["Crypto", "Low Liquidity Stock", "High Liquidity"], group=grp_general, tooltip="Select your market type for optimized signals")
i_tradingStyle = input.string("Day Trading", "Trading Style", options=["Scalping", "Day Trading", "Swing", "Position"], group=grp_general, tooltip="Select your trading timeframe style")
i_sensitivity = input.string("Normal", "Sensitivity", options=["Conservative", "Normal", "Aggressive"], group=grp_general, tooltip="Signal sensitivity level")

// ‚îÄ‚îÄ‚îÄ Period Settings ‚îÄ‚îÄ‚îÄ
grp_periods = "‚ïê‚ïê‚ïê Period Settings ‚ïê‚ïê‚ïê"
i_fastPeriod = input.int(7, "Fast Period", minval=3, maxval=20, group=grp_periods)
i_slowPeriod = input.int(21, "Slow Period", minval=10, maxval=50, group=grp_periods)
i_signalSmooth = input.int(5, "Signal Smoothing", minval=2, maxval=15, group=grp_periods)
i_mfiPeriod = input.int(14, "MFI Period", minval=5, maxval=30, group=grp_periods)
i_cmfPeriod = input.int(20, "CMF Period", minval=10, maxval=40, group=grp_periods)

// ‚îÄ‚îÄ‚îÄ Visual Settings ‚îÄ‚îÄ‚îÄ
grp_visual = "‚ïê‚ïê‚ïê Visual Settings ‚ïê‚ïê‚ïê"
i_showSignals = input.bool(true, "Show Signal Markers", group=grp_visual)
i_showDashboard = input.bool(true, "Show Dashboard Table", group=grp_visual)
i_showMTF = input.bool(true, "Show MTF Panel", group=grp_visual)
i_showWhale = input.bool(true, "Show Whale Markers", group=grp_visual)
i_showBackground = input.bool(true, "Show Background Zones", group=grp_visual)

// ‚îÄ‚îÄ‚îÄ Alert Settings ‚îÄ‚îÄ‚îÄ
grp_alerts = "‚ïê‚ïê‚ïê Alert Settings ‚ïê‚ïê‚ïê"
i_buyThreshold = input.int(70, "Buy Signal Threshold", minval=60, maxval=90, group=grp_alerts)
i_sellThreshold = input.int(30, "Sell Signal Threshold", minval=10, maxval=40, group=grp_alerts)
i_volumeSurge = input.float(2.0, "Volume Surge Multiplier", minval=1.5, maxval=5.0, step=0.1, group=grp_alerts)
i_whaleMultiplier = input.float(3.0, "Whale Detection Multiplier", minval=2.0, maxval=10.0, step=0.5, group=grp_alerts)

// ‚îÄ‚îÄ‚îÄ Colors ‚îÄ‚îÄ‚îÄ
grp_colors = "‚ïê‚ïê‚ïê Color Settings ‚ïê‚ïê‚ïê"
c_strongBull = input.color(color.new(#00E676, 0), "Strong Inflow", group=grp_colors)
c_weakBull = input.color(color.new(#81C784, 0), "Moderate Inflow", group=grp_colors)
c_neutral = input.color(color.new(#9E9E9E, 0), "Neutral", group=grp_colors)
c_weakBear = input.color(color.new(#E57373, 0), "Moderate Outflow", group=grp_colors)
c_strongBear = input.color(color.new(#FF1744, 0), "Strong Outflow", group=grp_colors)

// ===================================================================================
// HELPER FUNCTIONS
// ===================================================================================

// ‚îÄ‚îÄ‚îÄ Sensitivity Multiplier ‚îÄ‚îÄ‚îÄ
getSensitivityMult() =>
    i_sensitivity == "Conservative" ? 1.2 : i_sensitivity == "Aggressive" ? 0.8 : 1.0

// ‚îÄ‚îÄ‚îÄ Period Adjustment based on Trading Style ‚îÄ‚îÄ‚îÄ
getAdjustedPeriod(basePeriod) =>
    switch i_tradingStyle
        "Scalping" => math.max(3, math.round(basePeriod * 0.5))
        "Day Trading" => basePeriod
        "Swing" => math.round(basePeriod * 1.5)
        "Position" => math.round(basePeriod * 2)
        => basePeriod

// ‚îÄ‚îÄ‚îÄ Market Type Adjustment ‚îÄ‚îÄ‚îÄ
getMarketAdjustment() =>
    switch i_marketType
        "Crypto" => 1.2           // Higher volatility threshold
        "Low Liquidity Stock" => 0.8  // More sensitive to smaller moves
        "High Liquidity" => 1.0
        => 1.0

// ‚îÄ‚îÄ‚îÄ Normalize Value to 0-100 ‚îÄ‚îÄ‚îÄ
normalize(value, minVal, maxVal) =>
    math.max(0, math.min(100, (value - minVal) / (maxVal - minVal) * 100))

// ‚îÄ‚îÄ‚îÄ Safe Division ‚îÄ‚îÄ‚îÄ
safeDivide(numerator, denominator) =>
    denominator == 0 ? 0 : numerator / denominator

// ===================================================================================
// CORE CALCULATIONS
// ===================================================================================

// ‚îÄ‚îÄ‚îÄ Adjusted Periods ‚îÄ‚îÄ‚îÄ
fastPeriod = getAdjustedPeriod(i_fastPeriod)
slowPeriod = getAdjustedPeriod(i_slowPeriod)
mfiPeriod = getAdjustedPeriod(i_mfiPeriod)
cmfPeriod = getAdjustedPeriod(i_cmfPeriod)
sensitivityMult = getSensitivityMult()
marketAdj = getMarketAdjustment()

// ‚îÄ‚îÄ‚îÄ Volume Analysis ‚îÄ‚îÄ‚îÄ
vol = volume
volSMA = ta.sma(vol, slowPeriod)
volRatio = safeDivide(vol, volSMA)
isVolumeSurge = volRatio >= i_volumeSurge
isWhaleActivity = volRatio >= i_whaleMultiplier and i_marketType == "Crypto"

// ‚îÄ‚îÄ‚îÄ Money Flow Index (MFI) ‚îÄ‚îÄ‚îÄ
typicalPrice = hlc3
rawMoneyFlow = typicalPrice * vol
positiveFlow = rawMoneyFlow * (typicalPrice > typicalPrice[1] ? 1 : 0)
negativeFlow = rawMoneyFlow * (typicalPrice < typicalPrice[1] ? 1 : 0)
positiveFlowSum = math.sum(positiveFlow, mfiPeriod)
negativeFlowSum = math.sum(negativeFlow, mfiPeriod)
moneyFlowRatio = safeDivide(positiveFlowSum, negativeFlowSum)
mfi = 100 - (100 / (1 + moneyFlowRatio))

// ‚îÄ‚îÄ‚îÄ Chaikin Money Flow (CMF) ‚îÄ‚îÄ‚îÄ
mfMultiplier = safeDivide((close - low) - (high - close), high - low)
mfVolume = mfMultiplier * vol
cmf = safeDivide(math.sum(mfVolume, cmfPeriod), math.sum(vol, cmfPeriod))
cmfNormalized = normalize(cmf, -1, 1)

// ‚îÄ‚îÄ‚îÄ On-Balance Volume (OBV) ‚îÄ‚îÄ‚îÄ
obv = ta.cum(math.sign(ta.change(close)) * vol)
obvEmaFast = ta.ema(obv, fastPeriod)
obvEmaSlow = ta.ema(obv, slowPeriod)
obvSignal = obvEmaFast > obvEmaSlow ? 1 : obvEmaFast < obvEmaSlow ? -1 : 0
obvTrend = normalize(ta.ema(obvSignal, fastPeriod), -1, 1)

// ‚îÄ‚îÄ‚îÄ VWAP Deviation ‚îÄ‚îÄ‚îÄ
vwapValue = ta.vwap(close)
vwapDeviation = safeDivide(close - vwapValue, vwapValue) * 100
vwapScore = normalize(vwapDeviation, -5, 5)

// ‚îÄ‚îÄ‚îÄ RSI Momentum ‚îÄ‚îÄ‚îÄ
rsi = ta.rsi(close, mfiPeriod)
rsiScore = rsi

// ‚îÄ‚îÄ‚îÄ Price Rate of Change ‚îÄ‚îÄ‚îÄ
roc = ta.roc(close, fastPeriod)
rocNormalized = normalize(roc, -10 * marketAdj, 10 * marketAdj)

// ===================================================================================
// COMPOSITE FLOW SCORE CALCULATION
// ===================================================================================

// Weight distribution
w_volume = 0.25
w_mfi = 0.20
w_cmf = 0.20
w_obv = 0.15
w_momentum = 0.10
w_vwap = 0.10

// Volume Score (0-100)
volumeScore = normalize(volRatio, 0.5, 3)

// Calculate composite score
rawFlowScore = (volumeScore * w_volume) + 
               (mfi * w_mfi) + 
               (cmfNormalized * w_cmf) + 
               (obvTrend * w_obv) + 
               (rsiScore * w_momentum) + 
               (vwapScore * w_vwap)

// Apply sensitivity adjustment
flowScore = math.max(0, math.min(100, rawFlowScore * (2 - sensitivityMult)))

// Smooth the score
smoothedScore = ta.ema(flowScore, i_signalSmooth)

// ===================================================================================
// SIGNAL LOGIC
// ===================================================================================

// ‚îÄ‚îÄ‚îÄ Flow Direction ‚îÄ‚îÄ‚îÄ
flowDirection = smoothedScore > 55 ? 1 : smoothedScore < 45 ? -1 : 0
flowStrength = smoothedScore > 80 ? "Extreme" : smoothedScore > 65 ? "Strong" : smoothedScore > 55 ? "Moderate" : smoothedScore > 45 ? "Weak" : smoothedScore > 35 ? "Moderate" : smoothedScore > 20 ? "Strong" : "Extreme"

// ‚îÄ‚îÄ‚îÄ Buy/Sell Signals ‚îÄ‚îÄ‚îÄ
buyCondition = (smoothedScore > i_buyThreshold) and (smoothedScore > smoothedScore[1]) and (close > vwapValue) and (cmf > 0)

sellCondition = (smoothedScore < i_sellThreshold) and (smoothedScore < smoothedScore[1]) and (close < vwapValue) and (cmf < 0)

// Confirmation for cleaner signals (avoid consecutive signals)
confirmedBuy = buyCondition and not buyCondition[1] and not buyCondition[2]
confirmedSell = sellCondition and not sellCondition[1] and not sellCondition[2]

// ‚îÄ‚îÄ‚îÄ Divergence Detection ‚îÄ‚îÄ‚îÄ
priceLL = low < ta.lowest(low, slowPeriod)[1]
priceLH = low > ta.lowest(low, slowPeriod)[1]
priceHH = high > ta.highest(high, slowPeriod)[1]
priceHL = high < ta.highest(high, slowPeriod)[1]

flowLL = smoothedScore < ta.lowest(smoothedScore, slowPeriod)[1]
flowLH = smoothedScore > ta.lowest(smoothedScore, slowPeriod)[1]
flowHH = smoothedScore > ta.highest(smoothedScore, slowPeriod)[1]
flowHL = smoothedScore < ta.highest(smoothedScore, slowPeriod)[1]

bullishDivergence = priceLL and flowLH
bearishDivergence = priceHH and flowHL

// ‚îÄ‚îÄ‚îÄ Whale Detection (Crypto) ‚îÄ‚îÄ‚îÄ
whaleAccumulation = isWhaleActivity and close >= open
whaleDistribution = isWhaleActivity and close < open

// ===================================================================================
// MULTI-TIMEFRAME ANALYSIS
// ===================================================================================

// Request MTF data (only for Swing and Position trading)
[mtf1hScore, mtf4hScore, mtfDailyScore, mtfWeeklyScore] = request.security(syminfo.tickerid, "", [smoothedScore, smoothedScore, smoothedScore, smoothedScore])

// For actual MTF, we use different timeframes
mtf_1h = request.security(syminfo.tickerid, "60", smoothedScore)
mtf_4h = request.security(syminfo.tickerid, "240", smoothedScore)
mtf_daily = request.security(syminfo.tickerid, "D", smoothedScore)
mtf_weekly = request.security(syminfo.tickerid, "W", smoothedScore)

// MTF Alignment Count
mtfBullish = (mtf_1h > 50 ? 1 : 0) + (mtf_4h > 50 ? 1 : 0) + (mtf_daily > 50 ? 1 : 0) + (mtf_weekly > 50 ? 1 : 0)
mtfBearish = (mtf_1h < 50 ? 1 : 0) + (mtf_4h < 50 ? 1 : 0) + (mtf_daily < 50 ? 1 : 0) + (mtf_weekly < 50 ? 1 : 0)

// ===================================================================================
// VISUAL RENDERING
// ===================================================================================

// ‚îÄ‚îÄ‚îÄ Histogram Color Logic ‚îÄ‚îÄ‚îÄ
histogramColor = smoothedScore >= 80 ? c_strongBull :
                 smoothedScore >= 60 ? c_weakBull :
                 smoothedScore >= 40 ? c_neutral :
                 smoothedScore >= 20 ? c_weakBear :
                 c_strongBear

// ‚îÄ‚îÄ‚îÄ Plot Histogram ‚îÄ‚îÄ‚îÄ
// Convert score to centered histogram (-50 to +50)
histogramValue = smoothedScore - 50
plot(histogramValue, "Money Flow", color=histogramColor, style=plot.style_columns, linewidth=3)

// ‚îÄ‚îÄ‚îÄ Signal Line ‚îÄ‚îÄ‚îÄ
signalLine = ta.ema(histogramValue, i_signalSmooth * 2)
plot(signalLine, "Signal Line", color=color.new(color.yellow, 20), linewidth=2)

// ‚îÄ‚îÄ‚îÄ Zero Line ‚îÄ‚îÄ‚îÄ
hline(0, "Zero Line", color=color.gray, linestyle=hline.style_dashed)

// ‚îÄ‚îÄ‚îÄ Threshold Lines ‚îÄ‚îÄ‚îÄ
hline(i_buyThreshold - 50, "Buy Zone", color=color.new(color.green, 70), linestyle=hline.style_dotted)
hline(i_sellThreshold - 50, "Sell Zone", color=color.new(color.red, 70), linestyle=hline.style_dotted)

// ‚îÄ‚îÄ‚îÄ Background Zones ‚îÄ‚îÄ‚îÄ
bgColor = i_showBackground ? 
          (smoothedScore > i_buyThreshold ? color.new(color.green, 90) :
           smoothedScore < i_sellThreshold ? color.new(color.red, 90) :
           na) : na
bgcolor(bgColor, title="Zone Background")

// ‚îÄ‚îÄ‚îÄ Signal Markers ‚îÄ‚îÄ‚îÄ
plotshape(i_showSignals and confirmedBuy, "Buy Signal", shape.triangleup, location.bottom, c_strongBull, size=size.small)
plotshape(i_showSignals and confirmedSell, "Sell Signal", shape.triangledown, location.top, c_strongBear, size=size.small)

// ‚îÄ‚îÄ‚îÄ Whale Markers ‚îÄ‚îÄ‚îÄ
plotshape(i_showWhale and whaleAccumulation, "Whale Buy", shape.diamond, location.top, color.new(color.blue, 0), size=size.tiny, text="üêã")
plotshape(i_showWhale and whaleDistribution, "Whale Sell", shape.diamond, location.bottom, color.new(color.purple, 0), size=size.tiny, text="üêã")

// ‚îÄ‚îÄ‚îÄ Divergence Markers ‚îÄ‚îÄ‚îÄ
plotshape(bullishDivergence, "Bullish Divergence", shape.labelup, location.bottom, color.new(color.teal, 0), size=size.tiny, text="DIV")
plotshape(bearishDivergence, "Bearish Divergence", shape.labeldown, location.top, color.new(color.orange, 0), size=size.tiny, text="DIV")

// ‚îÄ‚îÄ‚îÄ Volume Surge Marker ‚îÄ‚îÄ‚îÄ
plotshape(isVolumeSurge and not isWhaleActivity, "Volume Surge", shape.circle, location.top, color.new(color.yellow, 50), size=size.tiny)

// ===================================================================================
// DASHBOARD TABLE
// ===================================================================================

if i_showDashboard and barstate.islast
    // Create dashboard table
    var table dashboard = table.new(position.top_right, 2, 10, bgcolor=color.new(color.black, 20), border_width=1, border_color=color.gray)
    
    // Title
    table.cell(dashboard, 0, 0, "ARPAKET_FLOW", text_color=color.white, text_size=size.small, bgcolor=color.new(color.blue, 50), text_halign=text.align_center)
    table.merge_cells(dashboard, 0, 0, 1, 0)
    
    // Flow Direction
    flowDirText = smoothedScore > 55 ? "‚ñ≤ INFLOW" : smoothedScore < 45 ? "‚ñº OUTFLOW" : "‚óè NEUTRAL"
    flowDirColor = smoothedScore > 55 ? color.green : smoothedScore < 45 ? color.red : color.gray
    table.cell(dashboard, 0, 1, "Direction:", text_color=color.white, text_size=size.tiny, text_halign=text.align_left)
    table.cell(dashboard, 1, 1, flowDirText, text_color=flowDirColor, text_size=size.tiny, text_halign=text.align_right)
    
    // Flow Score
    scoreColor = smoothedScore > 70 ? color.green : smoothedScore > 50 ? color.lime : smoothedScore > 30 ? color.orange : color.red
    table.cell(dashboard, 0, 2, "Score:", text_color=color.white, text_size=size.tiny, text_halign=text.align_left)
    table.cell(dashboard, 1, 2, str.tostring(math.round(smoothedScore)) + "/100", text_color=scoreColor, text_size=size.tiny, text_halign=text.align_right)
    
    // Flow Strength
    strengthColor = flowStrength == "Extreme" or flowStrength == "Strong" ? (smoothedScore > 50 ? color.green : color.red) : color.yellow
    table.cell(dashboard, 0, 3, "Strength:", text_color=color.white, text_size=size.tiny, text_halign=text.align_left)
    table.cell(dashboard, 1, 3, flowStrength, text_color=strengthColor, text_size=size.tiny, text_halign=text.align_right)
    
    // Volume Status
    volStatus = isWhaleActivity ? "üêã WHALE" : isVolumeSurge ? "‚ö° SURGE" : volRatio > 1.2 ? "‚Üë Above Avg" : "‚óã Normal"
    volColor = isWhaleActivity ? color.blue : isVolumeSurge ? color.yellow : volRatio > 1.2 ? color.lime : color.gray
    table.cell(dashboard, 0, 4, "Volume:", text_color=color.white, text_size=size.tiny, text_halign=text.align_left)
    table.cell(dashboard, 1, 4, volStatus + " (" + str.tostring(math.round(volRatio, 1)) + "x)", text_color=volColor, text_size=size.tiny, text_halign=text.align_right)
    
    // MFI
    mfiColor = mfi > 80 ? color.red : mfi > 70 ? color.orange : mfi > 30 ? color.white : mfi > 20 ? color.lime : color.green
    mfiStatus = mfi > 80 ? "Overbought" : mfi > 70 ? "High" : mfi > 30 ? "Normal" : mfi > 20 ? "Low" : "Oversold"
    table.cell(dashboard, 0, 5, "MFI:", text_color=color.white, text_size=size.tiny, text_halign=text.align_left)
    table.cell(dashboard, 1, 5, str.tostring(math.round(mfi)) + " (" + mfiStatus + ")", text_color=mfiColor, text_size=size.tiny, text_halign=text.align_right)
    
    // CMF
    cmfColor = cmf > 0.1 ? color.green : cmf > 0 ? color.lime : cmf > -0.1 ? color.orange : color.red
    cmfText = cmf > 0.1 ? "Strong Acc" : cmf > 0 ? "Accumulation" : cmf > -0.1 ? "Distribution" : "Strong Dist"
    table.cell(dashboard, 0, 6, "CMF:", text_color=color.white, text_size=size.tiny, text_halign=text.align_left)
    table.cell(dashboard, 1, 6, str.tostring(math.round(cmf, 2)) + " (" + cmfText + ")", text_color=cmfColor, text_size=size.tiny, text_halign=text.align_right)
    
    // MTF Alignment (for Swing/Position)
    if i_showMTF and (i_tradingStyle == "Swing" or i_tradingStyle == "Position")
        mtfText = str.tostring(mtfBullish) + "/4 Bullish"
        mtfColor = mtfBullish >= 3 ? color.green : mtfBullish >= 2 ? color.yellow : color.red
        table.cell(dashboard, 0, 7, "MTF Align:", text_color=color.white, text_size=size.tiny, text_halign=text.align_left)
        table.cell(dashboard, 1, 7, mtfText, text_color=mtfColor, text_size=size.tiny, text_halign=text.align_right)
    
    // Divergence
    divText = bullishDivergence ? "‚ö† Bullish" : bearishDivergence ? "‚ö† Bearish" : "None"
    divColor = bullishDivergence ? color.teal : bearishDivergence ? color.orange : color.gray
    table.cell(dashboard, 0, 8, "Divergence:", text_color=color.white, text_size=size.tiny, text_halign=text.align_left)
    table.cell(dashboard, 1, 8, divText, text_color=divColor, text_size=size.tiny, text_halign=text.align_right)
    
    // Overall Signal
    signalText = confirmedBuy ? "üü¢ BUY" : confirmedSell ? "üî¥ SELL" : smoothedScore > i_buyThreshold ? "‚óè BULLISH" : smoothedScore < i_sellThreshold ? "‚óè BEARISH" : "‚óè NEUTRAL"
    signalColor = confirmedBuy or smoothedScore > i_buyThreshold ? color.green : confirmedSell or smoothedScore < i_sellThreshold ? color.red : color.gray
    signalBg = confirmedBuy ? color.new(color.green, 70) : confirmedSell ? color.new(color.red, 70) : color.new(color.gray, 80)
    table.cell(dashboard, 0, 9, "SIGNAL:", text_color=color.white, text_size=size.tiny, bgcolor=signalBg, text_halign=text.align_left)
    table.cell(dashboard, 1, 9, signalText, text_color=signalColor, text_size=size.tiny, bgcolor=signalBg, text_halign=text.align_right)

// ===================================================================================
// MTF PANEL (for Swing/Position Trading)
// ===================================================================================

if i_showMTF and (i_tradingStyle == "Swing" or i_tradingStyle == "Position") and barstate.islast
    var table mtfPanel = table.new(position.bottom_right, 3, 5, bgcolor=color.new(color.black, 30), border_width=1, border_color=color.gray)
    
    // Header
    table.cell(mtfPanel, 0, 0, "TIMEFRAME", text_color=color.white, text_size=size.tiny, bgcolor=color.new(color.purple, 50))
    table.cell(mtfPanel, 1, 0, "FLOW", text_color=color.white, text_size=size.tiny, bgcolor=color.new(color.purple, 50))
    table.cell(mtfPanel, 2, 0, "SCORE", text_color=color.white, text_size=size.tiny, bgcolor=color.new(color.purple, 50))
    
    // 1H
    flow1h = mtf_1h > 55 ? "‚ñ≤ IN" : mtf_1h < 45 ? "‚ñº OUT" : "‚óè NEU"
    color1h = mtf_1h > 55 ? color.green : mtf_1h < 45 ? color.red : color.gray
    table.cell(mtfPanel, 0, 1, "1H", text_color=color.white, text_size=size.tiny)
    table.cell(mtfPanel, 1, 1, flow1h, text_color=color1h, text_size=size.tiny)
    table.cell(mtfPanel, 2, 1, str.tostring(math.round(mtf_1h)), text_color=color1h, text_size=size.tiny)
    
    // 4H
    flow4h = mtf_4h > 55 ? "‚ñ≤ IN" : mtf_4h < 45 ? "‚ñº OUT" : "‚óè NEU"
    color4h = mtf_4h > 55 ? color.green : mtf_4h < 45 ? color.red : color.gray
    table.cell(mtfPanel, 0, 2, "4H", text_color=color.white, text_size=size.tiny)
    table.cell(mtfPanel, 1, 2, flow4h, text_color=color4h, text_size=size.tiny)
    table.cell(mtfPanel, 2, 2, str.tostring(math.round(mtf_4h)), text_color=color4h, text_size=size.tiny)
    
    // Daily
    flowD = mtf_daily > 55 ? "‚ñ≤ IN" : mtf_daily < 45 ? "‚ñº OUT" : "‚óè NEU"
    colorD = mtf_daily > 55 ? color.green : mtf_daily < 45 ? color.red : color.gray
    table.cell(mtfPanel, 0, 3, "Daily", text_color=color.white, text_size=size.tiny)
    table.cell(mtfPanel, 1, 3, flowD, text_color=colorD, text_size=size.tiny)
    table.cell(mtfPanel, 2, 3, str.tostring(math.round(mtf_daily)), text_color=colorD, text_size=size.tiny)
    
    // Weekly
    flowW = mtf_weekly > 55 ? "‚ñ≤ IN" : mtf_weekly < 45 ? "‚ñº OUT" : "‚óè NEU"
    colorW = mtf_weekly > 55 ? color.green : mtf_weekly < 45 ? color.red : color.gray
    table.cell(mtfPanel, 0, 4, "Weekly", text_color=color.white, text_size=size.tiny)
    table.cell(mtfPanel, 1, 4, flowW, text_color=colorW, text_size=size.tiny)
    table.cell(mtfPanel, 2, 4, str.tostring(math.round(mtf_weekly)), text_color=colorW, text_size=size.tiny)

// ===================================================================================
// ALERTS
// ===================================================================================

// Buy/Sell Alerts
alertcondition(confirmedBuy, "Strong Buy Signal", "üü¢ STRONG BUY: Money Flow Score above threshold with confirmation")
alertcondition(confirmedSell, "Strong Sell Signal", "üî¥ STRONG SELL: Money Flow Score below threshold with confirmation")

// Zone Alerts
alertcondition(ta.crossover(smoothedScore, i_buyThreshold), "Enter Buy Zone", "üìà Price entering BUY ZONE - Flow Score crossed above threshold")
alertcondition(ta.crossunder(smoothedScore, i_sellThreshold), "Enter Sell Zone", "üìâ Price entering SELL ZONE - Flow Score crossed below threshold")

// Whale Alerts
alertcondition(whaleAccumulation, "Whale Accumulation", "üêã WHALE ACCUMULATION DETECTED - Large volume with price increase")
alertcondition(whaleDistribution, "Whale Distribution", "üêã WHALE DISTRIBUTION DETECTED - Large volume with price decrease")

// Divergence Alerts
alertcondition(bullishDivergence, "Bullish Divergence", "‚ö†Ô∏è BULLISH DIVERGENCE - Price making lower lows but flow making higher lows")
alertcondition(bearishDivergence, "Bearish Divergence", "‚ö†Ô∏è BEARISH DIVERGENCE - Price making higher highs but flow making lower highs")

// Volume Surge Alert
alertcondition(isVolumeSurge, "Volume Surge", "‚ö° VOLUME SURGE DETECTED - Volume is above average threshold")

// MTF Alignment Alerts
alertcondition(mtfBullish >= 3 and mtfBullish[1] < 3, "MTF Bullish Alignment", "üìä MTF BULLISH ALIGNMENT - 3+ timeframes showing inflow")
alertcondition(mtfBearish >= 3 and mtfBearish[1] < 3, "MTF Bearish Alignment", "üìä MTF BEARISH ALIGNMENT - 3+ timeframes showing outflow")

// Extreme Conditions
alertcondition(smoothedScore > 90, "Extreme Inflow", "üî• EXTREME INFLOW - Flow Score above 90")
alertcondition(smoothedScore < 10, "Extreme Outflow", "‚ùÑÔ∏è EXTREME OUTFLOW - Flow Score below 10")

// Flow Reversal
alertcondition(ta.crossover(smoothedScore, 50) and smoothedScore[1] < 40, "Flow Reversal to Bullish", "üîÑ FLOW REVERSAL - Turning BULLISH from bearish territory")
alertcondition(ta.crossunder(smoothedScore, 50) and smoothedScore[1] > 60, "Flow Reversal to Bearish", "üîÑ FLOW REVERSAL - Turning BEARISH from bullish territory")

// ===================================================================================
// END OF SCRIPT
// ===================================================================================
