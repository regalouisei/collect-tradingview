//@version=6
strategy("Game Theory EMA Strategy - High Accuracy", 
     shorttitle="GT EMA", 
     overlay=true,
     initial_capital=10000,
     default_qty_type=strategy.percent_of_equity,
     default_qty_value=100,
     commission_type=strategy.commission.percent,
     commission_value=0.1,
     pyramiding=0,
     calc_on_every_tick=true)

// ==================== DESCRIPTION ====================
// This strategy combines proven EMA crossover signals with game theory validation
// Uses trend filtering and Nash equilibrium detection to avoid low-probability trades
// Based on high-win-rate EMA strategies but enhanced with utility calculations

// ==================== INPUTS ====================

// EMA Settings (Proven profitable combination)
emaFast = input.int(9, "Fast EMA", minval=5, maxval=50, group="EMA Settings")
emaSlow = input.int(21, "Slow EMA", minval=10, maxval=100, group="EMA Settings")
emaTrend = input.int(50, "Trend Filter EMA", minval=20, maxval=200, group="EMA Settings")

// Game Theory Settings
gtPeriod = input.int(14, "Game Theory Period", minval=5, maxval=50, group="Game Theory")
nashFilter = input.bool(true, "Use Nash Equilibrium Filter", 
     tooltip="Avoid trades during market equilibrium", group="Game Theory")
utilityFilter = input.bool(true, "Use Utility Confirmation", 
     tooltip="Only trade when expected utility favors direction", group="Game Theory")

// Risk Management
riskRewardRatio = input.float(2.0, "Risk:Reward Ratio", minval=1.0, maxval=5.0, step=0.5, group="Risk Management")
atrPeriod = input.int(14, "ATR Period", minval=5, maxval=50, group="Risk Management")
atrMultiplier = input.float(1.5, "ATR Stop Multiplier", minval=0.5, maxval=5.0, step=0.5, group="Risk Management")

// Trade Filters
useADXFilter = input.bool(true, "Use ADX Trend Filter", group="Filters")
adxThreshold = input.int(25, "ADX Threshold", minval=10, maxval=50, group="Filters")
useVolumeFilter = input.bool(true, "Volume Filter", group="Filters")

// ==================== CORE INDICATORS ====================

// EMAs
ema_fast = ta.ema(close, emaFast)
ema_slow = ta.ema(close, emaSlow)
ema_trend = ta.ema(close, emaTrend)

// ATR for stops
atr = ta.atr(atrPeriod)

// ADX for trend strength
[diPlus, diMinus, adx] = ta.dmi(14, 14)

// Volume
volMA = ta.sma(volume, 20)
volumeUp = volume > volMA * 1.2

// ==================== GAME THEORY COMPONENTS ====================

// Expected Utility Calculation
calcExpectedUtility() =>
    // RSI-based momentum
    rsi = ta.rsi(close, gtPeriod)
    
    // Buyer utility increases when RSI is bullish but not overbought
    buyer_momentum = rsi > 50 and rsi < 70 ? (rsi - 50) / 20 : 
                     rsi >= 70 ? 0.5 : 
                     (rsi - 50) / 50
    
    // Seller utility increases when RSI is bearish but not oversold
    seller_momentum = rsi < 50 and rsi > 30 ? (50 - rsi) / 20 : 
                      rsi <= 30 ? 0.5 : 
                      (50 - rsi) / 50
    
    // Volume weight (probability)
    vol_weight = volume > volMA ? math.min(volume / volMA, 2.0) : 0.5
    
    // Calculate expected utilities
    eu_buyer = buyer_momentum * vol_weight
    eu_seller = seller_momentum * vol_weight
    
    [eu_buyer, eu_seller]

// Nash Equilibrium Detection
calcNashEquilibrium(eu_buy, eu_sell) =>
    diff = math.abs(eu_buy - eu_sell)
    total = eu_buy + eu_sell
    
    // Equilibrium when utilities are balanced (within 20%)
    is_equilibrium = total > 0 ? (diff / total) < 0.2 : true
    
    is_equilibrium

// Replicator Dynamics - Which strategy is winning?
calcDominantStrategy() =>
    bullBars = 0
    bearBars = 0
    
    for i = 0 to gtPeriod - 1
        if close[i] > open[i]
            bullBars += 1
        else
            bearBars += 1
    
    bullRatio = bullBars / gtPeriod
    bearRatio = bearBars / gtPeriod
    
    [bullRatio, bearRatio]

// ==================== CALCULATE SIGNALS ====================

[eu_buyer, eu_seller] = calcExpectedUtility()
is_nash = calcNashEquilibrium(eu_buyer, eu_seller)
[bull_dominance, bear_dominance] = calcDominantStrategy()

// EMA Crossover Signals
emaCrossUp = ta.crossover(ema_fast, ema_slow)
emaCrossDown = ta.crossunder(ema_fast, ema_slow)

// Trend Filter (price must be above/below trend EMA)
uptrend = close > ema_trend
downtrend = close < ema_trend

// ADX Filter (strong trend)
strongTrend = adx > adxThreshold

// Game Theory Filters
buyer_has_edge = eu_buyer > eu_seller
seller_has_edge = eu_seller > eu_buyer
not_equilibrium = not is_nash

// ==================== ENTRY CONDITIONS ====================

longCondition = emaCrossUp and uptrend and (not useADXFilter or strongTrend) and (not useVolumeFilter or volumeUp) and (not nashFilter or not_equilibrium) and (not utilityFilter or buyer_has_edge)

shortCondition = emaCrossDown and downtrend and (not useADXFilter or strongTrend) and (not useVolumeFilter or volumeUp) and (not nashFilter or not_equilibrium) and (not utilityFilter or seller_has_edge)

// ==================== POSITION MANAGEMENT ====================

// Track entry price and stops
var float longStop = na
var float longTarget = na
var float shortStop = na
var float shortTarget = na

// Enter Long
if longCondition and strategy.position_size == 0
    strategy.entry("Long", strategy.long)
    longStop := close - (atr * atrMultiplier)
    longTarget := close + (atr * atrMultiplier * riskRewardRatio)

// Enter Short
if shortCondition and strategy.position_size == 0
    strategy.entry("Short", strategy.short)
    shortStop := close + (atr * atrMultiplier)
    shortTarget := close - (atr * atrMultiplier * riskRewardRatio)

// Exit Long
if strategy.position_size > 0
    strategy.exit("Long Exit", "Long", stop=longStop, limit=longTarget)
    
    // Also exit on opposite crossover
    if emaCrossDown
        strategy.close("Long", comment="EMA Cross Exit")
    
    // Exit on Nash equilibrium
    if nashFilter and is_nash
        strategy.close("Long", comment="Equilibrium Exit")

// Exit Short
if strategy.position_size < 0
    strategy.exit("Short Exit", "Short", stop=shortStop, limit=shortTarget)
    
    // Also exit on opposite crossover
    if emaCrossUp
        strategy.close("Short", comment="EMA Cross Exit")
    
    // Exit on Nash equilibrium
    if nashFilter and is_nash
        strategy.close("Short", comment="Equilibrium Exit")

// ==================== PLOTTING ====================

// Plot EMAs
plot(ema_fast, "Fast EMA", color=color.new(color.blue, 0), linewidth=2)
plot(ema_slow, "Slow EMA", color=color.new(color.red, 0), linewidth=2)
plot(ema_trend, "Trend EMA", color=color.new(color.orange, 0), linewidth=2)

// Background for trend
bgcolor(uptrend ? color.new(color.green, 95) : color.new(color.red, 95), title="Trend Background")

// Nash Equilibrium zones
bgcolor(is_nash ? color.new(color.yellow, 90) : na, title="Nash Equilibrium")

// Entry signals
plotshape(longCondition, "Long Signal", shape.triangleup, 
     location.belowbar, color=color.new(color.lime, 0), size=size.normal)
plotshape(shortCondition, "Short Signal", shape.triangledown, 
     location.abovebar, color=color.new(color.red, 0), size=size.normal)

// Plot stop and target levels
plot(strategy.position_size > 0 ? longStop : na, "Long Stop", 
     color=color.red, style=plot.style_linebr, linewidth=1)
plot(strategy.position_size > 0 ? longTarget : na, "Long Target", 
     color=color.green, style=plot.style_linebr, linewidth=1)
plot(strategy.position_size < 0 ? shortStop : na, "Short Stop", 
     color=color.red, style=plot.style_linebr, linewidth=1)
plot(strategy.position_size < 0 ? shortTarget : na, "Short Target", 
     color=color.green, style=plot.style_linebr, linewidth=1)

// ==================== UTILITY PLOT (SEPARATE PANE) ====================

// Plot on bottom pane
hline(0, "Zero", color=color.gray)
plot(eu_buyer - eu_seller, "Utility Advantage", 
     color=eu_buyer > eu_seller ? color.green : color.red, linewidth=2)
plot(bull_dominance - 0.5, "Bull Dominance", color=color.blue, linewidth=1)

// ==================== INFO TABLE ====================

var table infoTable = table.new(position.top_right, 2, 10, 
     border_width=1, frame_width=1, border_color=color.gray)

if barstate.islast
    // Header
    table.cell(infoTable, 0, 0, "Metric", bgcolor=color.new(color.gray, 50), 
         text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, "Value", bgcolor=color.new(color.gray, 50), 
         text_color=color.white, text_size=size.small)
    
    // Current Position
    posText = strategy.position_size > 0 ? "LONG" : strategy.position_size < 0 ? "SHORT" : "FLAT"
    posColor = strategy.position_size > 0 ? color.lime : strategy.position_size < 0 ? color.red : color.gray
    table.cell(infoTable, 0, 1, "Position", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 1, posText, text_color=posColor, text_size=size.small)
    
    // Trend
    trendText = uptrend ? "UP" : "DOWN"
    trendColor = uptrend ? color.lime : color.red
    table.cell(infoTable, 0, 2, "Trend", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 2, trendText, text_color=trendColor, text_size=size.small)
    
    // ADX
    table.cell(infoTable, 0, 3, "ADX", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 3, str.tostring(adx, "#"), 
         text_color=adx > adxThreshold ? color.lime : color.orange, text_size=size.small)
    
    // Expected Utility
    table.cell(infoTable, 0, 4, "EU Buyer", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 4, str.tostring(eu_buyer, "#.##"), 
         text_color=eu_buyer > eu_seller ? color.lime : color.red, text_size=size.small)
    
    table.cell(infoTable, 0, 5, "EU Seller", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 5, str.tostring(eu_seller, "#.##"), 
         text_color=eu_seller > eu_buyer ? color.red : color.lime, text_size=size.small)
    
    // Nash Status
    table.cell(infoTable, 0, 6, "Nash Eq", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 6, is_nash ? "YES" : "NO", 
         text_color=is_nash ? color.yellow : color.gray, text_size=size.small)
    
    // Separator
    table.cell(infoTable, 0, 7, "━━━━━━━━", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 7, "━━━━━━━━", text_color=color.gray, text_size=size.small)
    
    // Performance
    table.cell(infoTable, 0, 8, "Total Trades", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 8, str.tostring(strategy.closedtrades), 
         text_color=color.white, text_size=size.small)
    
    winRate = strategy.closedtrades > 0 ? (strategy.wintrades / strategy.closedtrades * 100) : 0
    table.cell(infoTable, 0, 9, "Win Rate", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 9, str.tostring(winRate, "#.#") + "%", 
         text_color=winRate >= 60 ? color.lime : winRate >= 40 ? color.yellow : color.red, 
         text_size=size.small)

// ==================== ALERTS ====================

alertcondition(longCondition, "Long Entry", "GT Strategy: Long Entry Signal")
alertcondition(shortCondition, "Short Entry", "GT Strategy: Short Entry Signal")
alertcondition(is_nash, "Nash Equilibrium", "Market entering equilibrium - avoid new trades")
