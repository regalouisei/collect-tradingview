//@version=5
indicator("Prior Month/Week/Day & Current Month High/Low/POC/Open/Close", overlay = true, max_lines_count = 500)

// ─── Inputs ────────────────────────────────────────────────
group_month = "Month Levels"
prior_m_hl_color = input.color(color.orange, "Prior Month H/L Color", group = group_month)
prior_m_oc_color = input.color(color.rgb(255, 200, 0), "Prior Month O/C Color", group = group_month)
prior_m_poc_color = input.color(color.rgb(255, 165, 0), "Prior Month POC Color", group = group_month)
curr_m_hl_color = input.color(color.yellow, "Current Month H/L Color", group = group_month)
curr_m_poc_color = input.color(color.rgb(255, 255, 0), "Current Month POC Color", group = group_month)

prior_m_style = input.string("Dashed", "Prior Month Style", options = ["Solid", "Dashed", "Dotted"], group = group_month)
curr_m_style = input.string("Solid", "Current Month Style", options = ["Solid", "Dashed", "Dotted"], group = group_month)

prior_m_width = input.int(2, "Prior Month Width", minval = 1, maxval = 5, group = group_month)
curr_m_width = input.int(1, "Current Month Width", minval = 1, maxval = 5, group = group_month)

show_prior_month_hl = input.bool(true, "Show Prior Month H/L", group = group_month)
show_prior_month_oc = input.bool(true, "Show Prior Month O/C", group = group_month)
show_prior_month_poc = input.bool(true, "Show Prior Month POC", group = group_month)
show_current_month_hl = input.bool(true, "Show Current Month H/L", group = group_month)
show_current_month_poc = input.bool(true, "Show Current Month POC", group = group_month)

group_week = "Week Levels"
prior_w_hl_color = input.color(color.blue, "Prior Week H/L Color", group = group_week)
prior_w_oc_color = input.color(color.rgb(0, 0, 200), "Prior Week O/C Color", group = group_week)
prior_w_poc_color = input.color(color.rgb(0, 0, 255), "Prior Week POC Color", group = group_week)

prior_w_style = input.string("Dashed", "Prior Week Style", options = ["Solid", "Dashed", "Dotted"], group = group_week)

prior_w_width = input.int(2, "Prior Week Width", minval = 1, maxval = 5, group = group_week)

show_prior_week_hl = input.bool(true, "Show Prior Week H/L", group = group_week)
show_prior_week_oc = input.bool(true, "Show Prior Week O/C", group = group_week)
show_prior_week_poc = input.bool(true, "Show Prior Week POC", group = group_week)

group_day = "Day Levels"
prior_d_hl_color = input.color(color.green, "Prior Day H/L Color", group = group_day)
prior_d_oc_color = input.color(color.lime, "Prior Day O/C Color", group = group_day)

prior_d_style = input.string("Dashed", "Prior Day Style", options = ["Solid", "Dashed", "Dotted"], group = group_day)

prior_d_width = input.int(2, "Prior Day Width", minval = 1, maxval = 5, group = group_day)

show_prior_day_hl = input.bool(true, "Show Prior Day H/L", group = group_day)
show_prior_day_oc = input.bool(true, "Show Prior Day O/C", group = group_day)

show_labels = input.bool(true, "Show labels on right edge")
label_size = input.string("Small", "Label Font Size", options = ["Small", "Normal", "Large", "Huge"])

// ─── Style converter ───────────────────────────────────────
f_getStyle(s) => 
    switch s
        "Solid" => line.style_solid
        "Dashed" => line.style_dashed
        => line.style_dotted

// ─── Label size converter ──────────────────────────────────
f_getLabelSize(s) =>
    switch s
        "Small" => size.small
        "Normal" => size.normal
        "Large" => size.large
        "Huge" => size.huge
        => size.small  // fallback

// ─── Variables ─────────────────────────────────────────────
var line linePMH = na
var line linePML = na
var line linePMO = na
var line linePMC = na
var line linePMPOC = na
var line lineCMH = na
var line lineCML = na
var line lineCMPOC = na
var line linePWH = na
var line linePWL = na
var line linePWO = na
var line linePWC = na
var line linePWPOC = na
var line linePDH = na
var line linePDL = na
var line linePDO = na
var line linePDC = na

// ─── Month levels ──────────────────────────────────────────
var float priorMonthHigh = na
var float priorMonthLow = na
var float priorMonthOpen = na
var float priorMonthClose = na
var float priorMonthPOC = na
var float currMonthHigh = na
var float currMonthLow = na
var float currMonthOpen = na

bool newMonth = ta.change(time("M"))

if barstate.isfirst
    currMonthHigh := high
    currMonthLow := low
    currMonthOpen := open

if newMonth
    priorMonthHigh := currMonthHigh
    priorMonthLow := currMonthLow
    priorMonthOpen := currMonthOpen
    priorMonthClose := close[1]
    priorMonthPOC := (currMonthHigh + currMonthLow + close[1]) / 3  // Use close[1] for last close of prior month
    currMonthHigh := high
    currMonthLow := low
    currMonthOpen := open

else
    currMonthHigh := math.max(currMonthHigh, high)
    currMonthLow := math.min(currMonthLow, low)

float currMonthPOC = (currMonthHigh + currMonthLow + close) / 3

// ─── Week levels ───────────────────────────────────────────
var float priorWeekHigh = na
var float priorWeekLow = na
var float priorWeekOpen = na
var float priorWeekClose = na
var float priorWeekPOC = na
var float currWeekHigh = na
var float currWeekLow = na
var float currWeekOpen = na

bool newWeek = ta.change(time("W"))

if barstate.isfirst
    currWeekHigh := high
    currWeekLow := low
    currWeekOpen := open

if newWeek
    priorWeekHigh := currWeekHigh
    priorWeekLow := currWeekLow
    priorWeekOpen := currWeekOpen
    priorWeekClose := close[1]
    priorWeekPOC := (currWeekHigh + currWeekLow + close[1]) / 3  // Use close[1] for last close of prior week
    currWeekHigh := high
    currWeekLow := low
    currWeekOpen := open

else
    currWeekHigh := math.max(currWeekHigh, high)
    currWeekLow := math.min(currWeekLow, low)

// ─── Day levels ────────────────────────────────────────────
var float priorDayHigh = na
var float priorDayLow = na
var float priorDayOpen = na
var float priorDayClose = na
var float currDayHigh = na
var float currDayLow = na
var float currDayOpen = na

bool newDay = ta.change(time_tradingday)

if barstate.isfirst
    currDayHigh := high
    currDayLow := low
    currDayOpen := open

if newDay
    priorDayHigh := currDayHigh
    priorDayLow := currDayLow
    priorDayOpen := currDayOpen
    priorDayClose := close[1]
    currDayHigh := high
    currDayLow := low
    currDayOpen := open

else
    currDayHigh := math.max(currDayHigh, high)
    currDayLow := math.min(currDayLow, low)

// ─── Prior month lines (redraw when values change) ─────────
if newMonth or na(linePMH)
    if show_prior_month_hl
        line.delete(linePMH)
        linePMH := line.new(bar_index, priorMonthHigh, bar_index + 1, priorMonthHigh, xloc = xloc.bar_index, extend = extend.right, color = prior_m_hl_color, style = f_getStyle(prior_m_style), width = prior_m_width)
        line.delete(linePML)
        linePML := line.new(bar_index, priorMonthLow, bar_index + 1, priorMonthLow, xloc = xloc.bar_index, extend = extend.right, color = prior_m_hl_color, style = f_getStyle(prior_m_style), width = prior_m_width)
    
    if show_prior_month_oc
        line.delete(linePMO)
        linePMO := line.new(bar_index, priorMonthOpen, bar_index + 1, priorMonthOpen, xloc = xloc.bar_index, extend = extend.right, color = prior_m_oc_color, style = f_getStyle(prior_m_style), width = prior_m_width)
        line.delete(linePMC)
        linePMC := line.new(bar_index, priorMonthClose, bar_index + 1, priorMonthClose, xloc = xloc.bar_index, extend = extend.right, color = prior_m_oc_color, style = f_getStyle(prior_m_style), width = prior_m_width)
    
    if show_prior_month_poc
        line.delete(linePMPOC)
        linePMPOC := line.new(bar_index, priorMonthPOC, bar_index + 1, priorMonthPOC, xloc = xloc.bar_index, extend = extend.right, color = prior_m_poc_color, style = f_getStyle(prior_m_style), width = prior_m_width)

// ─── Prior week lines (redraw when values change) ──────────
if newWeek or na(linePWH)
    if show_prior_week_hl
        line.delete(linePWH)
        linePWH := line.new(bar_index, priorWeekHigh, bar_index + 1, priorWeekHigh, xloc = xloc.bar_index, extend = extend.right, color = prior_w_hl_color, style = f_getStyle(prior_w_style), width = prior_w_width)
        line.delete(linePWL)
        linePWL := line.new(bar_index, priorWeekLow, bar_index + 1, priorWeekLow, xloc = xloc.bar_index, extend = extend.right, color = prior_w_hl_color, style = f_getStyle(prior_w_style), width = prior_w_width)
    
    if show_prior_week_oc
        line.delete(linePWO)
        linePWO := line.new(bar_index, priorWeekOpen, bar_index + 1, priorWeekOpen, xloc = xloc.bar_index, extend = extend.right, color = prior_w_oc_color, style = f_getStyle(prior_w_style), width = prior_w_width)
        line.delete(linePWC)
        linePWC := line.new(bar_index, priorWeekClose, bar_index + 1, priorWeekClose, xloc = xloc.bar_index, extend = extend.right, color = prior_w_oc_color, style = f_getStyle(prior_w_style), width = prior_w_width)
    
    if show_prior_week_poc
        line.delete(linePWPOC)
        linePWPOC := line.new(bar_index, priorWeekPOC, bar_index + 1, priorWeekPOC, xloc = xloc.bar_index, extend = extend.right, color = prior_w_poc_color, style = f_getStyle(prior_w_style), width = prior_w_width)

// ─── Prior day lines (redraw when values change) ───────────
if newDay or na(linePDH)
    if show_prior_day_hl
        line.delete(linePDH)
        linePDH := line.new(bar_index, priorDayHigh, bar_index + 1, priorDayHigh, xloc = xloc.bar_index, extend = extend.right, color = prior_d_hl_color, style = f_getStyle(prior_d_style), width = prior_d_width)
        line.delete(linePDL)
        linePDL := line.new(bar_index, priorDayLow, bar_index + 1, priorDayLow, xloc = xloc.bar_index, extend = extend.right, color = prior_d_hl_color, style = f_getStyle(prior_d_style), width = prior_d_width)
    
    if show_prior_day_oc
        line.delete(linePDO)
        linePDO := line.new(bar_index, priorDayOpen, bar_index + 1, priorDayOpen, xloc = xloc.bar_index, extend = extend.right, color = prior_d_oc_color, style = f_getStyle(prior_d_style), width = prior_d_width)
        line.delete(linePDC)
        linePDC := line.new(bar_index, priorDayClose, bar_index + 1, priorDayClose, xloc = xloc.bar_index, extend = extend.right, color = prior_d_oc_color, style = f_getStyle(prior_d_style), width = prior_d_width)

// ─── Current month lines (redraw every bar if enabled) ─────
if show_current_month_hl
    line.delete(lineCMH[1])
    lineCMH := line.new(bar_index, currMonthHigh, bar_index + 1, currMonthHigh, xloc = xloc.bar_index, extend = extend.right, color = curr_m_hl_color, style = f_getStyle(curr_m_style), width = curr_m_width)
    
    line.delete(lineCML[1])
    lineCML := line.new(bar_index, currMonthLow, bar_index + 1, currMonthLow, xloc = xloc.bar_index, extend = extend.right, color = curr_m_hl_color, style = f_getStyle(curr_m_style), width = curr_m_width)

if show_current_month_poc
    line.delete(lineCMPOC[1])
    lineCMPOC := line.new(bar_index, currMonthPOC, bar_index + 1, currMonthPOC, xloc = xloc.bar_index, extend = extend.right, color = curr_m_poc_color, style = f_getStyle(curr_m_style), width = curr_m_width)

// ─── LABELS ────────────────────────────────────────────────
if show_labels and barstate.islast
    int month_offset = bar_index + 20
    int week_offset = bar_index + 15
    int day_offset = bar_index + 10
    int current_month_offset = bar_index + 20  // Same as prior month for consistency
    
    if show_prior_month_hl and not na(priorMonthHigh)
        label.new(month_offset, priorMonthHigh, "Prior Month High", style = label.style_label_left, color = prior_m_hl_color, textcolor = color.black, size = f_getLabelSize(label_size))
    if show_prior_month_hl and not na(priorMonthLow)
        label.new(month_offset, priorMonthLow, "Prior Month Low", style = label.style_label_left, color = prior_m_hl_color, textcolor = color.black, size = f_getLabelSize(label_size))
    if show_prior_month_oc and not na(priorMonthOpen)
        label.new(month_offset, priorMonthOpen, "Prior Month Open", style = label.style_label_left, color = prior_m_oc_color, textcolor = color.black, size = f_getLabelSize(label_size))
    if show_prior_month_oc and not na(priorMonthClose)
        label.new(month_offset, priorMonthClose, "Prior Month Close", style = label.style_label_left, color = prior_m_oc_color, textcolor = color.black, size = f_getLabelSize(label_size))
    if show_prior_month_poc and not na(priorMonthPOC)
        label.new(month_offset, priorMonthPOC, "Prior Month POC", style = label.style_label_left, color = prior_m_poc_color, textcolor = color.black, size = f_getLabelSize(label_size))
    
    if show_current_month_hl and not na(currMonthHigh)
        label.new(current_month_offset, currMonthHigh, "Current Month High", style = label.style_label_left, color = curr_m_hl_color, textcolor = color.black, size = f_getLabelSize(label_size))
    if show_current_month_hl and not na(currMonthLow)
        label.new(current_month_offset, currMonthLow, "Current Month Low", style = label.style_label_left, color = curr_m_hl_color, textcolor = color.black, size = f_getLabelSize(label_size))
    if show_current_month_poc and not na(currMonthPOC)
        label.new(current_month_offset, currMonthPOC, "Current Month POC", style = label.style_label_left, color = curr_m_poc_color, textcolor = color.black, size = f_getLabelSize(label_size))
    
    if show_prior_week_hl and not na(priorWeekHigh)
        label.new(week_offset, priorWeekHigh, "Prior Week High", style = label.style_label_left, color = prior_w_hl_color, textcolor = color.black, size = f_getLabelSize(label_size))
    if show_prior_week_hl and not na(priorWeekLow)
        label.new(week_offset, priorWeekLow, "Prior Week Low", style = label.style_label_left, color = prior_w_hl_color, textcolor = color.black, size = f_getLabelSize(label_size))
    if show_prior_week_oc and not na(priorWeekOpen)
        label.new(week_offset, priorWeekOpen, "Prior Week Open", style = label.style_label_left, color = prior_w_oc_color, textcolor = color.black, size = f_getLabelSize(label_size))
    if show_prior_week_oc and not na(priorWeekClose)
        label.new(week_offset, priorWeekClose, "Prior Week Close", style = label.style_label_left, color = prior_w_oc_color, textcolor = color.black, size = f_getLabelSize(label_size))
    if show_prior_week_poc and not na(priorWeekPOC)
        label.new(week_offset, priorWeekPOC, "Prior Week POC", style = label.style_label_left, color = prior_w_poc_color, textcolor = color.black, size = f_getLabelSize(label_size))
    
    if show_prior_day_hl and not na(priorDayHigh)
        label.new(day_offset, priorDayHigh, "Prior Day High", style = label.style_label_left, color = prior_d_hl_color, textcolor = color.black, size = f_getLabelSize(label_size))
    if show_prior_day_hl and not na(priorDayLow)
        label.new(day_offset, priorDayLow, "Prior Day Low", style = label.style_label_left, color = prior_d_hl_color, textcolor = color.black, size = f_getLabelSize(label_size))
    if show_prior_day_oc and not na(priorDayOpen)
        label.new(day_offset, priorDayOpen, "Prior Day Open", style = label.style_label_left, color = prior_d_oc_color, textcolor = color.black, size = f_getLabelSize(label_size))
    if show_prior_day_oc and not na(priorDayClose)
        label.new(day_offset, priorDayClose, "Prior Day Close", style = label.style_label_left, color = prior_d_oc_color, textcolor = color.black, size = f_getLabelSize(label_size))
