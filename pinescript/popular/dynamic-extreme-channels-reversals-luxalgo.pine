// This work is licensed under a Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0) https://creativecommons.org/licenses/by-nc-sa/4.0/
// © LuxAlgo

//@version=6
indicator("Dynamic Extreme Channels & Reversals [LuxAlgo]", "LuxAlgo - Dynamic Extreme Channels & Reversals", overlay = true)

//---------------------------------------------------------------------------------------------------------------------}
// Constants
//---------------------------------------------------------------------------------------------------------------------{
color GREEN             = #089981
color RED               = #f23645
color DATA              = #DBDBDB
color HEADERS           = #808080
color BACKGROUND        = #161616
color BORDERS           = #2E2E2E

string TOP_RIGHT        = 'Top Right'
string BOTTOM_RIGHT     = 'Bottom Right'
string BOTTOM_LEFT      = 'Bottom Left'

string TINY             = 'Tiny'
string SMALL            = 'Small'
string NORMAL           = 'Normal'
string LARGE            = 'Large'
string HUGE             = 'Huge'

string DASHBOARD_GROUP  = 'Dashboard'

//---------------------------------------------------------------------------------------------------------------------}
// Inputs
//---------------------------------------------------------------------------------------------------------------------{
int lengthInput         = input.int(20, "Lookback Period", minval = 1, tooltip = "Number of bars to wait before resetting the extreme level if no new extreme is found.")
float alphaInput        = input.float(50.0, "Reset Alpha %", minval = 0, maxval = 100, step = 5, tooltip = "When the lookback period is reached, the level interpolates toward the current price based on this percentage. 100% is a full reset, 0% means no change.") / 100
bool trailingModeInput  = input.bool(false, "Trailing Stop Mode", tooltip = "When enabled, a single trailing stop line is shown. It tracks the lower bound during uptrends and the upper bound during downtrends.")

dashboardInput          = input.bool(true, 'Dashboard', group = DASHBOARD_GROUP, tooltip = 'Enable or disable the dashboard.')
dashboardPositionInput  = input.string(TOP_RIGHT, 'Position', group = DASHBOARD_GROUP, tooltip = 'Select the dashboard location.', options = [TOP_RIGHT, BOTTOM_RIGHT, BOTTOM_LEFT])
dashboardSizeInput      = input.string(SMALL, 'Size', group = DASHBOARD_GROUP, tooltip = 'Select the dashboard size.', options = [TINY, SMALL, NORMAL, LARGE, HUGE])
showSignalsInput        = input.bool(true, "Show Reversal Signals", group = "Visuals")
color upperColorInput   = input.color(color.new(GREEN, 50), "Upper Color", group = "Visuals")
color midColorInput     = input.color(color.new(color.gray, 20), "Midline Color", group = "Visuals")
color lowerColorInput   = input.color(color.new(RED, 50), "Lower Color", group = "Visuals")

//---------------------------------------------------------------------------------------------------------------------}
// Methods / Functions
//---------------------------------------------------------------------------------------------------------------------{
// Dashboard helper functions
var parsedDashboardPosition = switch dashboardPositionInput
    TOP_RIGHT       => position.top_right
    BOTTOM_RIGHT    => position.bottom_right
    BOTTOM_LEFT     => position.bottom_left

var parsedDashboardSize     = switch dashboardSizeInput
    TINY            => size.tiny
    SMALL           => size.small
    NORMAL          => size.normal
    LARGE           => size.large
    HUGE            => size.huge

cell(table t_able, int column, int row, string data, color = #FFFFFF, align = text.align_right, color background = na, float height = 0) => 
    t_able.cell(column, row, data, text_color = color, text_size = parsedDashboardSize, text_halign = align, bgcolor = background, height = height)

divider(table t_able, int row, int lastColumn) =>    
    string rowDivider = '━━━━━━━━━━━━━━━━━━━━━━'
    t_able.merge_cells(0, row, lastColumn, row)
    cell(t_able, 0, row, rowDivider, align = text.align_center, height = 0.5, color = BORDERS)

//---------------------------------------------------------------------------------------------------------------------}
// Core Calculations
//---------------------------------------------------------------------------------------------------------------------{
var float upperLevel = high
var float lowerLevel = low
var int upperCounter = 0
var int lowerCounter = 0
var int trend        = 0 // 1 for Long (Upper touched), -1 for Short (Lower touched)

bool isHH = high >= upperLevel
bool isLL = low <= lowerLevel

// Logic to track extremes without rolling max/min functions
if high >= upperLevel
    upperLevel   := high
    upperCounter := 0
    trend        := 1
else
    upperCounter += 1
    if upperCounter >= lengthInput
        upperLevel   := upperLevel * (1 - alphaInput) + high * alphaInput
        upperCounter := 0

if low <= lowerLevel
    lowerLevel   := low
    lowerCounter := 0
    trend        := -1
else
    lowerCounter += 1
    if lowerCounter >= lengthInput
        lowerLevel   := lowerLevel * (1 - alphaInput) + low * alphaInput
        lowerCounter := 0

float midline = (upperLevel + lowerLevel) / 2

// Reversal Signals Logic
bool bearishSignal = isHH and low < midline
bool bullishSignal = isLL and high > midline

// Logic & Dashboard Data
float channelWidth = ((upperLevel - lowerLevel) / lowerLevel) * 100
float pricePos     = (close - lowerLevel) / (upperLevel - lowerLevel) * 100
string trendText   = trend == 1 ? "Bullish" : trend == -1 ? "Bearish" : "Neutral"
color trendColor   = trend == 1 ? GREEN : trend == -1 ? RED : DATA

// Trailing Stop Logic
float trailingStop = trend == 1 ? lowerLevel : (trend == -1 ? upperLevel : na)
color stopColor    = trend == 1 ? GREEN : RED
//---------------------------------------------------------------------------------------------------------------------}
// Visuals
//---------------------------------------------------------------------------------------------------------------------{
// Trailing Stop Plot
p_stop  = plot(trailingModeInput ? trailingStop : na, "Trailing Stop", color = stopColor, style = plot.style_stepline, linewidth = 2)
p_price = plot(trailingModeInput ? close : na, "Price Reference", color = na)
fill(p_stop, p_price, color.new(stopColor, 90), "Trailing Fill")

p_upper = plot(trailingModeInput ? na : upperLevel, "Upper Bound", color = upperColorInput, style = plot.style_stepline)
p_lower = plot(trailingModeInput ? na : lowerLevel, "Lower Bound", color = lowerColorInput, style = plot.style_stepline)
p_mid   = plot(trailingModeInput ? na : midline, "Midline", color = midColorInput, style = plot.style_stepline)

fill(p_upper, p_mid, top_value = upperLevel, bottom_value = midline, top_color = color.new(upperColorInput, 85), bottom_color = color.new(upperColorInput, 100), title = "Upper Gradient")
fill(p_mid, p_lower, top_value = midline, bottom_value = lowerLevel, top_color = color.new(lowerColorInput, 100), bottom_color = color.new(lowerColorInput, 85), title = "Lower Gradient")

// Reversal Labels
if showSignalsInput
    if bullishSignal
        label.new(bar_index, low, "▲", color = #00000000, textcolor = GREEN, style = label.style_label_up, size = size.small)
    if bearishSignal
        label.new(bar_index, high, "▼", color = #00000000, textcolor = RED, style = label.style_label_down, size = size.small)

// Dashboard implementation
var table dashboard = table.new(parsedDashboardPosition, 2, 9, bgcolor = BACKGROUND, border_width = 0, frame_color = BORDERS, frame_width = 1)

if dashboardInput and barstate.islast
    dashboard.merge_cells(0, 0, 1, 0)
    cell(dashboard, 0, 0, 'Dynamic Extreme Channels [LuxAlgo]', color = DATA, align = text.align_center)
    
    divider(dashboard, 1, 1)
    
    cell(dashboard, 0, 2, 'Trend', color = HEADERS, align = text.align_left)
    cell(dashboard, 1, 2, trendText, color = trendColor)

    divider(dashboard, 3, 1)

    cell(dashboard, 0, 4, 'Channel Width', color = HEADERS, align = text.align_left)
    cell(dashboard, 1, 4, str.format("{0,number,#.##}%", channelWidth), color = DATA)
    
    divider(dashboard, 5, 1)
    
    cell(dashboard, 0, 6, 'Price Position', color = HEADERS, align = text.align_left)
    cell(dashboard, 1, 6, str.format("{0,number,#.##}%", pricePos), color = pricePos > 50 ? GREEN : RED)
    
    divider(dashboard, 7, 1)
    
    cell(dashboard, 0, 8, 'Lookback Reset', color = HEADERS, align = text.align_left)
    cell(dashboard, 1, 8, str.tostring(lengthInput), color = DATA)

//---------------------------------------------------------------------------------------------------------------------}
