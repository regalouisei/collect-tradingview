//@version=5
indicator("Swing High/Low Zones with Wick Boxes", overlay=true, max_boxes_count=500, max_labels_count=500, max_lines_count=500)

// ========== INPUT PARAMETERS ==========
swingLength = input.int(5, "Swing Detection Length", minval=1, tooltip="Number of bars to the left and right for swing detection")
boxExtension = input.int(10, "Box Extension (Bars)", minval=1, tooltip="Number of bars to extend the box to the right")
lineExtension = input.int(20, "Line Extension (Bars)", minval=1, tooltip="Number of bars to extend the line to the right")

// Box Colors & Opacity
boxOpacity = input.int(70, "Box Opacity", minval=0, maxval=100, tooltip="0 = Fully visible, 100 = Fully transparent")
highBoxColor = input.color(color.red, "Swing High Box Color")
lowBoxColor = input.color(color.blue, "Swing Low Box Color")
boxBorderColor = input.color(color.gray, "Box Border Color")

// Line Settings
showLines = input.bool(true, "Show Horizontal Lines")
lineOpacity = input.int(0, "Line Opacity", minval=0, maxval=100, tooltip="0 = Fully visible, 100 = Fully transparent")
highLineColor = input.color(color.lime, "Swing High Line Color")
lowLineColor = input.color(color.lime, "Swing Low Line Color")
lineWidth = input.int(2, "Line Width", minval=1, maxval=5)

// Marker Settings
markerColor = input.color(color.lime, "Marker Color")
markerSize = input.string("Small", "Marker Size", options=["Tiny", "Small", "Normal"])

// ========== SWING DETECTION ==========
swingHigh = ta.pivothigh(high, swingLength, swingLength)
swingLow = ta.pivotlow(low, swingLength, swingLength)

// Convert marker size
mSize = markerSize == "Tiny" ? size.tiny : markerSize == "Small" ? size.small : size.normal

// Apply opacity to colors
finalHighBoxColor = color.new(highBoxColor, boxOpacity)
finalLowBoxColor = color.new(lowBoxColor, boxOpacity)
finalHighLineColor = color.new(highLineColor, lineOpacity)
finalLowLineColor = color.new(lowLineColor, lineOpacity)

// ========== DRAWING BOXES, LINES, AND MARKERS ==========
// When a swing high is detected
if not na(swingHigh)
    swingHighPrice = high[swingLength]
    swingHighClose = close[swingLength]
    swingHighOpen = open[swingLength]
    swingTime = time[swingLength]
    
    boxEndTime = swingTime + (timeframe.in_seconds() * 1000 * boxExtension)
    lineEndTime = swingTime + (timeframe.in_seconds() * 1000 * lineExtension)
    bodyTop = math.max(swingHighClose, swingHighOpen)
    
    // Draw box from wick top to body top
    box.new(left=swingTime, top=swingHighPrice, right=boxEndTime, bottom=bodyTop, bgcolor=finalHighBoxColor, border_color=boxBorderColor, border_width=1, xloc=xloc.bar_time)
    
    // Draw horizontal line at swing high
    if showLines
        line.new(x1=swingTime, y1=swingHighPrice, x2=lineEndTime, y2=swingHighPrice, color=finalHighLineColor, width=lineWidth, xloc=xloc.bar_time)
    
    // Draw green circle marker
    label.new(x=swingTime, y=swingHighPrice, text="●", color=color.new(color.black, 100), textcolor=markerColor, style=label.style_none, size=mSize, xloc=xloc.bar_time)

// When a swing low is detected
if not na(swingLow)
    swingLowPrice = low[swingLength]
    swingLowClose = close[swingLength]
    swingLowOpen = open[swingLength]
    swingTime = time[swingLength]
    
    boxEndTime = swingTime + (timeframe.in_seconds() * 1000 * boxExtension)
    lineEndTime = swingTime + (timeframe.in_seconds() * 1000 * lineExtension)
    bodyBottom = math.min(swingLowClose, swingLowOpen)
    
    // Draw box from wick bottom to body bottom
    box.new(left=swingTime, top=bodyBottom, right=boxEndTime, bottom=swingLowPrice, bgcolor=finalLowBoxColor, border_color=boxBorderColor, border_width=1, xloc=xloc.bar_time)
    
    // Draw horizontal line at swing low
    if showLines
        line.new(x1=swingTime, y1=swingLowPrice, x2=lineEndTime, y2=swingLowPrice, color=finalLowLineColor, width=lineWidth, xloc=xloc.bar_time)
    
    // Draw green circle marker
    label.new(x=swingTime, y=swingLowPrice, text="●", color=color.new(color.black, 100), textcolor=markerColor, style=label.style_none, size=mSize, xloc=xloc.bar_time)
