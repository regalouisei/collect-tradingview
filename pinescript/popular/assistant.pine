//@version=6
indicator('Assistant', overlay = true)

// ===== НАСТРОЙКИ ТЕНЕЙ =====
wickSettings = 'Настройки теней'
wickThreshold = input.float(0.0, 'Макс. размер тени', minval = 0.0, step = 0.1, group = wickSettings, tooltip = '0 = только свечи без теней')
showWickMarks = input.bool(true, 'Показывать метки', group = wickSettings)

// ===== НАСТРОЙКИ ФРАКТАЛОВ =====
fractalSettings = 'Настройки фракталов'
show3Candle = input.bool(true, '3-свечные', group = fractalSettings)
show5Candle = input.bool(true, '5-свечные', group = fractalSettings)
fractal3Color = color.new(#FFA500, 90) // Оранжевый 10%
fractal5Color = color.new(#000000, 50) // Черный 50%

// ===== НАСТРОЙКИ FVG =====
fvgSettings = 'Настройки FVG (только алерты)'
enableBullishFVGAlert = input.bool(true, 'Уведомления о бычьих FVG', group = fvgSettings)
enableBearishFVGAlert = input.bool(true, 'Уведомления о медвежьих FVG', group = fvgSettings)

// ===== ЛОГИКА ТЕНЕЙ =====
body = math.abs(close - open)
upperWick = high - math.max(open, close)
lowerWick = math.min(open, close) - low

validBody = body > 0
upperSignal = upperWick <= body * wickThreshold / 100 and validBody or upperWick == 0
lowerSignal = lowerWick <= body * wickThreshold / 100 and validBody or lowerWick == 0

// ===== ЛОГИКА ФРАКТАЛОВ =====
// 3-свечные фракталы
fractalUp3 = high[2] > high[1] and high[2] > high[3]
fractalDown3 = low[2] < low[1] and low[2] < low[3]

// 5-свечные фракталы
fractalUp5 = high[2] > high[0] and high[2] > high[1] and high[2] > high[3] and high[2] > high[4]
fractalDown5 = low[2] < low[0] and low[2] < low[1] and low[2] < low[3] and low[2] < low[4]

// ===== ЛОГИКА FVG =====
// Условия для FVG
bullishFVG = low[2] > high[0]
bearishFVG = high[2] < low[0]

// Триггеры для алертов
bullishFVGAlert = enableBullishFVGAlert and bullishFVG
bearishFVGAlert = enableBearishFVGAlert and bearishFVG

// ===== ОТРИСОВКА ТЕНЕЙ И ФРАКТАЛОВ =====
// Метки для теней (красные плюсики с 10% прозрачностью)
plotshape(showWickMarks and upperSignal, title = 'Верхняя тень (маленькая или отсутствует)', location = location.abovebar, color = color.new(color.red, 10), style = shape.cross, size = size.tiny)
plotshape(showWickMarks and lowerSignal, title = 'Нижняя тень (маленькая или отсутствует)', location = location.belowbar, color = color.new(color.red, 10), style = shape.cross, size = size.tiny)

// 3-свечные фракталы (перевернутые треугольники)
plotshape(show3Candle and fractalUp3, title = 'Верхний фрактал (3 свечи)', location = location.abovebar, color = fractal3Color, style = shape.triangledown, offset = -2)
plotshape(show3Candle and fractalDown3, title = 'Нижний фрактал (3 свечи)', location = location.belowbar, color = fractal3Color, style = shape.triangleup, offset = -2)

// 5-свечные фракталы (перевернутые треугольники)
plotshape(show5Candle and fractalUp5, title = 'Верхний фрактал (5 свечей)', location = location.abovebar, color = fractal5Color, style = shape.triangledown, offset = -2)
plotshape(show5Candle and fractalDown5, title = 'Нижний фрактал (5 свечей)', location = location.belowbar, color = fractal5Color, style = shape.triangleup, offset = -2)

// ===== УВЕДОМЛЕНИЯ =====
alertcondition(bullishFVGAlert, title = 'Bullish FVG', message = 'Bullish FVG formed')
alertcondition(bearishFVGAlert, title = 'Bearish FVG', message = 'Bearish FVG formed')
