//@version=6
indicator('Malaysian SnR Kai[DoN]', overlay = true, max_lines_count = 500, max_boxes_count = 500, max_labels_count = 500)

// ==========================================
// 1. Settings
// ==========================================

// --- Current TF SnR ---
group_main = 'Current Timeframe SnR'
depth = input.int(3, 'Pivot Depth', minval = 1, group = group_main)
max_active = input.int(5, 'Max Active Lines', minval = 1, maxval = 20, group = group_main)
show_zone = input.bool(true, 'Show Zones (Boxes)', group = group_main)
show_labels = input.bool(true, 'Show Price Labels', group = group_main)
v_color = input.color(color.new(#00FFFF, 0), 'Support Color (V)', group = group_main)
a_color = input.color(color.new(#FF9800, 0), 'Resistance Color (A)', group = group_main)
lbl_text_col = input.color(color.black, 'Label Text Color', group = group_main)

// --- SMA Filter ---
group_filter = 'SMA Filter'
sma_len = input.int(21, 'SMA Filter Length', minval = 1, group = group_filter)
show_sma = input.bool(true, 'Show SMA 21 Line', group = group_filter)

// --- Role Reversal (History) ---
group_hist = 'Role Reversal (History)'
show_hist = input.bool(true, 'Show RBS/SBR Lines', group = group_hist)
max_hist_display = 2 
hist_style_cfg = input.string(line.style_dashed, 'History Line Style', options = [line.style_dotted, line.style_dashed, line.style_solid], group = group_hist)

// --- Higher TF SnR ---
group_htf = 'Higher Timeframe Overlay'
htf_tf = input.timeframe('D', 'Higher Timeframe', group = group_htf)
show_htf = input.bool(false, 'Show HTF SnR', group = group_htf)
show_htf_lbl = input.bool(false, 'Show HTF Labels', group = group_htf)
max_htf = input.int(3, 'Max HTF Lines', group = group_htf)
htf_v_color = input.color(color.new(#2962FF, 20), 'HTF Support Color', group = group_htf)
htf_a_color = input.color(color.new(#F44336, 20), 'HTF Resistance Color', group = group_htf)
htf_width = input.int(2, 'Line Width', group = group_htf)

// ==========================================
// Utilities & Global Functions
// ==========================================
get_tf_str(tf) =>
    tf == '240' ? 'H4' : tf == 'D' or tf == '1D' ? 'D1' : tf == 'W' or tf == '1W' ? 'W1' : tf == 'M' or tf == '1M' ? 'M1' : tf
htf_label_text = get_tf_str(htf_tf)

sma21 = ta.sma(close, sma_len)
plot(show_sma ? sma21 : na, "SMA Filter", color.new(color.gray, 60))

// 未来延長用の関数
update_visuals(lns, bxs, future_time) =>
    if array.size(lns) > 0
        for i = 0 to array.size(lns) - 1
            line.set_x2(array.get(lns, i), future_time)
    if array.size(bxs) > 0
        for i = 0 to array.size(bxs) - 1
            box.set_right(array.get(bxs, i), future_time)

// ==========================================
// 2. Current TF Logic (Pivot SnR)
// ==========================================
var v_lines = array.new_line()
var v_boxes = array.new_box()
var v_lbls = array.new_label()
var a_lines = array.new_line()
var a_boxes = array.new_box()
var a_lbls = array.new_label()

// History Arrays 分離 (RBS = 元A, SBR = 元V)
var rbs_lines = array.new_line()
var rbs_lbls  = array.new_label()
var sbr_lines = array.new_line()
var sbr_lbls  = array.new_label()

l_v = ta.pivotlow(close, depth, depth)
l_a = ta.pivothigh(close, depth, depth)

add_level(is_support, price, zone_price, t_idx, arr_l, arr_b, arr_lbl, col) =>
    ln = line.new(t_idx, price, time, price, xloc = xloc.bar_time, color = col, width = 1, style = line.style_solid)
    bx = show_zone ? box.new(t_idx, price, time, zone_price, xloc = xloc.bar_time, border_color = na, bgcolor = color.new(col, 85)) : na
    txt = (is_support ? 'V: ' : 'A: ') + str.tostring(price, format.mintick)
    lbl_style = is_support ? label.style_label_up : label.style_label_down
    lbl = show_labels ? label.new(t_idx, price, text = txt, xloc = xloc.bar_time, style = lbl_style, color = color.new(col, 80), textcolor = lbl_text_col, size = size.tiny) : na
    array.push(arr_l, ln)
    array.push(arr_b, bx)
    array.push(arr_lbl, lbl)

trim_array(arr_l, arr_b, arr_lbl, limit) =>
    if array.size(arr_l) > limit
        line.delete(array.shift(arr_l))
        box.delete(array.shift(arr_b))
        label.delete(array.shift(arr_lbl))

// --- SMA21 Filter ---
if not na(l_v) and l_v < sma21[depth]
    add_level(true, l_v, low[depth], time[depth], v_lines, v_boxes, v_lbls, v_color)
    trim_array(v_lines, v_boxes, v_lbls, max_active)

if not na(l_a) and l_a > sma21[depth]
    add_level(false, l_a, high[depth], time[depth], a_lines, a_boxes, a_lbls, a_color)
    trim_array(a_lines, a_boxes, a_lbls, max_active)

// --- Active Line Break Logic (転換) ---
check_break_active(arr_l, arr_b, arr_lbl, is_supp) =>
    if array.size(arr_l) > 0
        for i = array.size(arr_l) - 1 to 0 by 1
            ln = array.get(arr_l, i)
            lvl = line.get_y1(ln)
            broken = is_supp ? close < lvl : close > lvl
            if broken
                ml = array.remove(arr_l, i)
                mb = array.remove(arr_b, i)
                mlb = array.remove(arr_lbl, i)
                box.delete(mb)
                if show_hist
                    line.set_style(ml, hist_style_cfg)
                    line.set_color(ml, is_supp ? a_color : v_color) // 色反転
                    line.set_width(ml, 2)
                    if not na(mlb)
                        label.set_text(mlb, (is_supp ? "SBR: " : "RBS: ") + str.tostring(lvl, format.mintick))
                        label.set_color(mlb, is_supp ? a_color : v_color)
                    
                    if is_supp // Support(V)が破られたら Resistance(SBR)へ
                        array.push(sbr_lines, ml)
                        array.push(sbr_lbls, mlb)
                    else // Resistance(A)が破られたら Support(RBS)へ
                        array.push(rbs_lines, ml)
                        array.push(rbs_lbls, mlb)
                else
                    line.delete(ml)
                    label.delete(mlb)

check_break_active(v_lines, v_boxes, v_lbls, true)
check_break_active(a_lines, a_boxes, a_lbls, false)

// --- RBS/SBR 再ブレイク判定 (破られたら削除) ---
// SBR (Resistance): 価格が上抜けたら削除
if array.size(sbr_lines) > 0
    for i = array.size(sbr_lines) - 1 to 0 by 1
        if close > line.get_y1(array.get(sbr_lines, i))
            line.delete(array.remove(sbr_lines, i))
            label.delete(array.remove(sbr_lbls, i))

// RBS (Support): 価格が下抜けたら削除
if array.size(rbs_lines) > 0
    for i = array.size(rbs_lines) - 1 to 0 by 1
        if close < line.get_y1(array.get(rbs_lines, i))
            line.delete(array.remove(rbs_lines, i))
            label.delete(array.remove(rbs_lbls, i))

// --- Closest 2 History Filter (RBSとSBR合計で2本) ---
total_hist_count = array.size(rbs_lines) + array.size(sbr_lines)
if total_hist_count > max_hist_display
    while (array.size(rbs_lines) + array.size(sbr_lines)) > max_hist_display
        max_dist = -1.0
        max_idx = -1
        is_rbs_target = true
        
        // RBSから遠いものを探す
        if array.size(rbs_lines) > 0
            for i = 0 to array.size(rbs_lines) - 1
                dist = math.abs(close - line.get_y1(array.get(rbs_lines, i)))
                if dist > max_dist
                    max_dist := dist
                    max_idx := i
                    is_rbs_target := true
        
        // SBRからも遠いものを探す
        if array.size(sbr_lines) > 0
            for i = 0 to array.size(sbr_lines) - 1
                dist = math.abs(close - line.get_y1(array.get(sbr_lines, i)))
                if dist > max_dist
                    max_dist := dist
                    max_idx := i
                    is_rbs_target := false
        
        if is_rbs_target
            line.delete(array.remove(rbs_lines, max_idx))
            label.delete(array.remove(rbs_lbls, max_idx))
        else
            line.delete(array.remove(sbr_lines, max_idx))
            label.delete(array.remove(sbr_lbls, max_idx))

// ==========================================
// 3. HTF SnR Logic
// ==========================================
get_htf_pivots(d) =>
    pl = ta.pivotlow(close, d, d), ph = ta.pivothigh(close, d, d), t = time[d]
    [ta.valuewhen(not na(pl), pl, 0), ta.valuewhen(not na(pl), t, 0),
     ta.valuewhen(not na(ph), ph, 0), ta.valuewhen(not na(ph), t, 0)]

[s_pl1, s_plt1, s_ph1, s_pht1] = request.security(syminfo.tickerid, htf_tf, get_htf_pivots(depth))

var htf_v_lines = array.new_line(), var htf_a_lines = array.new_line()
var htf_v_lbls = array.new_label(), var htf_a_lbls = array.new_label()

process_htf_level(val, t_val, lines_arr, lbls_arr, col, txt) =>
    if show_htf and not na(val)
        exists = false
        if array.size(lines_arr) > 0
            for i = 0 to array.size(lines_arr) - 1
                if line.get_x1(array.get(lines_arr, i)) == t_val
                    exists := true
                    break
        if not exists
            nl = line.new(t_val, val, time, val, xloc=xloc.bar_time, color=col, style=line.style_dashed, width=htf_width)
            nlb = show_htf_lbl ? label.new(t_val, val, text=txt, xloc=xloc.bar_time, style=label.style_none, textcolor=col, size=size.small) : na
            array.push(lines_arr, nl), array.push(lbls_arr, nlb)
            if array.size(lines_arr) > max_htf
                line.delete(array.shift(lines_arr)), label.delete(array.shift(lbls_arr))

process_htf_level(s_pl1, s_plt1, htf_v_lines, htf_v_lbls, htf_v_color, htf_label_text)
process_htf_level(s_ph1, s_pht1, htf_a_lines, htf_a_lbls, htf_a_color, htf_label_text)

// ==========================================
// 4. Final Updates
// ==========================================
if barstate.islast
    f_time = time + (time - time[1]) * 20
    update_visuals(v_lines, v_boxes, f_time)
    update_visuals(a_lines, a_boxes, f_time)
    update_visuals(rbs_lines, array.new_box(), f_time)
    update_visuals(sbr_lines, array.new_box(), f_time)
    update_visuals(htf_v_lines, array.new_box(), f_time)
    update_visuals(htf_a_lines, array.new_box(), f_time)
