// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © angirshahdeo


//@version=6
indicator(
     title = "Advanced Support & Resistance Suite",
     shorttitle = "LANS Advanced S&R [LANS]",
     overlay = true,
     max_bars_back = 2000,
     max_labels_count = 500
)

// ───── INPUTS ─────
toggleBreaks  = input.bool(true, "Show Breaks")
showSignals   = input.bool(true, "Show Buy / Sell Signals")
leftBars     = input.int(15, "Left Bars", minval = 1)
rightBars    = input.int(15, "Right Bars", minval = 1)
volumeThresh = input.int(20, "Volume Threshold")

// === EMA Inputs ===
emaLength1 = input.int(21, "EMA 1 (Short)")
emaLength2 = input.int(50, "EMA 2 (Medium)")
emaLength3 = input.int(100, "EMA 3 (Long)")
emaLength4 = input.int(200, "EMA 4 (Longest)")
emaLength5 = input.int(1000, "EMA 4 (Far Longest)")

// === EMAs ===
ema1 = ta.ema(close, emaLength1)
ema2 = ta.ema(close, emaLength2)
ema3 = ta.ema(close, emaLength3)
ema4 = ta.ema(close, emaLength4)
ema5 = ta.ema(close, emaLength5)

// Trend Filter
emaLen = input.int(9, "EMA Trend Filter")

// HTF Levels
showHTF = input.bool(true, "Show HTF Levels")
htfTF   = input.timeframe("D", "HTF Timeframe")

// ───── TREND FILTER ─────
emaTrend  = ta.ema(close, emaLen)
bullTrend = close > emaTrend
bearTrend = close < emaTrend

plot(emaTrend, "EMA Trend", color=color.yellow, linewidth=3)

// ───── PIVOT LEVELS ─────
highPivot = ta.pivothigh(high, leftBars, rightBars)
lowPivot  = ta.pivotlow(low, leftBars, rightBars)

var float highUsePivot = na
var float lowUsePivot  = na

highUsePivot := na(highPivot[1]) ? highUsePivot[1] : highPivot[1]
lowUsePivot  := na(lowPivot[1])  ? lowUsePivot[1]  : lowPivot[1]

// ───── SUPPORT & RESISTANCE COLORS (v6 SAFE) ─────
resColor = ta.change(highUsePivot) != 0 ? na : color.red
supColor = ta.change(lowUsePivot)  != 0 ? na : color.green

// ───── PLOT SUPPORT & RESISTANCE ─────
plot(highUsePivot, "Resistance", resColor, linewidth = 3, offset = -(rightBars + 1))
plot(lowUsePivot,  "Support",    supColor, linewidth = 3, offset = -(rightBars + 1))

// ───── HTF SUPPORT & RESISTANCE ─────
htfHigh = request.security(syminfo.tickerid, htfTF, high[1])
htfLow  = request.security(syminfo.tickerid, htfTF, low[1])

plot(showHTF ? htfHigh : na, "HTF High", color=color.new(color.red, 60), linewidth=2)
plot(showHTF ? htfLow  : na, "HTF Low",  color=color.new(color.blue, 60), linewidth=2)

// ───── VOLUME OSCILLATOR ─────
shortVol = ta.ema(volume, 5)
longVol  = ta.ema(volume, 10)
osc      = 100 * (shortVol - longVol) / longVol

// ───── BREAKOUT CONDITIONS ─────
supportBreak =
     toggleBreaks and
     ta.crossunder(close, lowUsePivot) and
     osc > volumeThresh

resistanceBreak =
     toggleBreaks and
     ta.crossover(close, highUsePivot) and
     osc > volumeThresh

plotshape(supportBreak, title="Support Break", style=shape.triangledown, color=color.red,  location=location.abovebar, size=size.small)
plotshape(resistanceBreak,  title="Resistance Break",  style=shape.triangleup,   color=color.lime, location=location.belowbar, size=size.small)


// ───── WICK REJECTIONS ─────
bullRejection =
     ta.crossover(close, highUsePivot) and
     (open - low) > (close - open)

bearRejection =
     ta.crossunder(close, lowUsePivot) and
     (open - close) < (high - open)

plotshape(bullRejection,  title="Bull Wick",  style=shape.triangleup,   color=color.lime, location=location.belowbar, size=size.small)
plotshape(bearRejection, title="Bear Wick", style=shape.triangledown, color=color.red,  location=location.abovebar, size=size.small)


// ───── BUY / SELL SIGNALS ─────
buySignal =
     showSignals and
     bullTrend and
     bullRejection and
     close > lowUsePivot

sellSignal =
     showSignals and
     bearTrend and
     bearRejection and
     close < highUsePivot

plotshape(buySignal,  title="Buy Signal",  style=shape.triangleup,   color=color.lime, location=location.belowbar, size=size.small, text="BUY")
plotshape(sellSignal, title="Sell Signal", style=shape.triangledown, color=color.red,  location=location.abovebar, size=size.small, text="SELL")


// === Plot EMAs ===
plot(ema1, color=color.new(color.green, 0), title="EMA 21", linewidth=1)
plot(ema2, color=color.new(color.red, 0), title="EMA 50", linewidth=1)
plot(ema3, color=color.new(color.blue, 0), title="EMA 100", linewidth=2)
plot(ema4, color=color.new(color.yellow, 8), title="EMA 200", linewidth=3)
plot(ema5, color=color.new(color.white, 0), title="EMA 1000", linewidth=4)


// ───── ALERTS ─────
alertcondition(buySignal, title="BUY Alert", message="BUY: Bullish rejection at Support with trend")
alertcondition(sellSignal, title="SELL Alert", message="SELL: Bearish rejection at Resistance with trend")
alertcondition(supportBreak, title="Support Broken", message="Support broken with volume")
alertcondition(resistanceBreak, title="Resistance Broken", message="Resistance broken with volume")

// ───── INFO DASHBOARD ─────
var table info = table.new(position.bottom_right, 1, 5)

if barstate.islast
    table.cell(info, 0, 0,
         bullTrend ? "Trend: BULLISH" : "Trend: BEARISH",
         bgcolor = bullTrend ? color.new(color.green, 70) : color.new(color.red, 70),
         text_color = color.white)

    table.cell(info, 0, 1,
         "HTF: " + htfTF,
         bgcolor = color.new(color.gray, 80),
         text_color = color.white)

    table.cell(info, 0, 2,
         "Vol Osc: " + str.tostring(osc, "#.##"),
         bgcolor = color.new(color.black, 80),
         text_color = color.white)
