//@version=6
indicator('Two Candle Comparison TMP V 5.0', overlay=true)

// === INPUTS ===
// Candle Colors & Labels Toggles
var GCPL = "Candle Colors & Labels"

display_mode = input.string("Both", "Display Mode", options=["Labels Only", "Colors Only", "Both"], group=GCPL)

color_SBu_val = input.color(color.new(#19b11e, 0), "Strongest Bullish (SBu)", group=GCPL, inline="SBu")
color_SBu_en = input.bool(true, "Candle", group=GCPL, inline="SBu")
show_SBu = input.bool(true, 'Label', group=GCPL, inline="SBu")

color_SBa_val = input.color(color.new(#fb4040, 0), "Strongest Bearish (SBa)", group=GCPL, inline="SBa")
color_SBa_en = input.bool(true, "Candle", group=GCPL, inline="SBa")
show_SBa = input.bool(true, 'Label', group=GCPL, inline="SBa")

// === VOLUME SPIKE FILTER ===
useVolSpike = input.bool(true, "Volume Filter(SBu/SBa)", group=GCPL, inline = "1")
volSpikeThreshold = input.float(0.5, "Thresh", step=0.1, group=GCPL, inline = "1")
volSmaLen = input.int(13, "SMA", group=GCPL, inline = "1")

// === LOGIC FUNCTIONS ===

getCloseComparison(open_,close_,high_,low_, prevHigh, prevLow ,prevOpen, prevClose, shortMA_, middleMA_, longMA_, highMA_, SMI_, SMIsignal_) =>
   low_ <= prevLow and prevClose<prevOpen and close_>open_ and (open_-low_)>=(high_-close_) and close_>prevOpen and  longMA_<middleMA_ and middleMA_<shortMA_  and highMA_<longMA_ and (open_-low_)<2*(close_-open_) and low_<=shortMA_ ? 'Bull' : 
   high_ >= prevHigh and prevClose>prevOpen and close_<open_ and (high_-open_)>=(close_-low_) and close_<prevOpen and longMA_>middleMA_ and middleMA_>shortMA_ and highMA_>longMA_ and (high_-open_)<2*(open_-close_) and high_>=shortMA_ ? 'Bear' : 'Range'
    //(low_ <= prevLow and close_ >= prevOpen) or (prevClose < prevOpen and close_ >= prevOpen) ? 'Bull' : (high_ >= prevHigh and close_ <= prevOpen) or(prevClose > prevOpen and close_ <= prevOpen) ? 'Bear' : 'Range'pi./44o
    
getShortLabel(cc) =>
    //cp == 'High' and cc == 'Bull' ? 'SBu' :
    cc == 'Bull' ? 'SBu' :

     cc == 'Bear' ? 'SBa' : ""
     //cp == 'Low'  and cc == 'Bear' ? 'SBa' : ""
    

// === DETECTION ===


prevHigh = high[1]
prevLow  = low[1]
prevClose = close[1]
prevOpen = open[1]


shortMA=ta.ema(close,21)
middleMA=ta.ema(close,50)
longMA=ta.ema(close,100)
highMA=ta.ema(close,200)

//xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
a = input.int(5, "Percent K Length")
b = input.int(3, "Percent D Length")
// Range Calculation
ll = ta.lowest(low, a)
hh = ta.highest (high, a)
diff = hh - ll
rdiff = close - (hh+ll)/2
// Nested Moving Average for smoother curves
avgrel = ta.ema(ta.ema(rdiff,b),b)
avgdiff = ta.ema(ta.ema(diff,b),b)
// SMI calculations
SMI = avgdiff != 0 ? (avgrel/(avgdiff/2)*100) : 0
SMIsignal = ta.ema(SMI,b)
//All PLOTS
//plot(SMI, title = "Stochastic Momentum Index")
//plot(SMIsignal, color= red, title = "SMI Signal Line")
//plot(40, color = red, title = "Over Bought")
//plot(-40, color = green, title = "Over Sold")
//plot(0, color = blue, title = "Zero Line")
//xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

closeComp = getCloseComparison(open , close , high , low , prevHigh , prevLow , prevOpen , prevClose, shortMA, middleMA, longMA, highMA, SMI, SMIsignal )
//labelText = getShortLabel(closePos, closeComp)
labelText = getShortLabel(closeComp)

// === PLOT LABELS ===
showLabels = display_mode != "Colors Only"

// === BAR COLORING ===
showColor = display_mode != "Labels Only"


barcolor(
     showColor and labelText == 'SBu' and color_SBu_en  ? color_SBu_val :

     showColor and labelText == 'SBa' and color_SBa_en  ? color_SBa_val :
     na)




if labelText == 'SBu'
    alert("Opportunity for Buy Entry!",alert.freq_once_per_bar_close)

if labelText == 'SBa'
    alert("Opportunity for Sell Entry!",alert.freq_once_per_bar_close)

//plot(ma)
//plotshape(labelText == 'SBu', style = shape.triangleup, location = location.belowbar, color = color.green, title = "xUp")
//plotshape(labelText == 'SBa', style = shape.triangledown, location = location.abovebar, color = color.red, title = "xDn")

//xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
ma(source, length, MAtype) =>
    switch MAtype
        "SMA"        => ta.sma(source,  length) 
        "EMA"        => ta.ema(source,  length) 
        "SMMA (RMA)" => ta.rma(source,  length) 
        "WMA"        => ta.wma(source,  length) 
        "VWMA"       => ta.vwma(source, length) 
        => na

show_ma1   = input(true,         "MA #1", inline = "MA #1", display = display.data_window)
ma1_type   = input.string("EMA", "",      inline = "MA #1", active = show_ma1, options = ["SMA", "EMA", "SMMA (RMA)", "WMA", "VWMA"])
ma1_source = input(close,        "",      inline = "MA #1", active = show_ma1, display = display.data_window)
ma1_length = input.int(20,       "",      inline = "MA #1", active = show_ma1, minval  = 1)
ma1_color  = input(color.rgb(246, 17, 9),    "",      inline = "MA #1", active = show_ma1, display = display.data_window)

show_ma2   = input(true,         "MA #2", inline = "MA #2", display = display.data_window)
ma2_type   = input.string("EMA", "",      inline = "MA #2", active = show_ma2, options = ["SMA", "EMA", "SMMA (RMA)", "WMA", "VWMA"])
ma2_source = input(close,        "",      inline = "MA #2", active = show_ma2, display = display.data_window)
ma2_length = input.int(50,       "",      inline = "MA #2", active = show_ma2, minval  = 1)
ma2_color  = input(color.rgb(12, 168, 12),    "",      inline = "MA #2", active = show_ma2, display = display.data_window)

show_ma3   = input(true,         "MA #3", inline = "MA #3", display = display.data_window)
ma3_type   = input.string("EMA", "",      inline = "MA #3", active = show_ma3, options = ["SMA", "EMA", "SMMA (RMA)", "WMA", "VWMA"])
ma3_source = input(close,        "",      inline = "MA #3", active = show_ma3, display = display.data_window)
ma3_length = input.int(100,      "",      inline = "MA #3", active = show_ma3, minval  = 1)
ma3_color  = input(color.rgb(233, 175, 15),    "",      inline = "MA #3", active = show_ma3, display = display.data_window)

show_ma4   = input(true,         "MA #4", inline = "MA #4", display = display.data_window)
ma4_type   = input.string("EMA", "",      inline = "MA #4", active = show_ma4, options = ["SMA", "EMA", "SMMA (RMA)", "WMA", "VWMA"])
ma4_source = input(close,        "",      inline = "MA #4", active = show_ma4, display = display.data_window)
ma4_length = input.int(200,      "",      inline = "MA #4", active = show_ma4, minval  = 1)
ma4_color  = input(color.rgb(24, 28, 238),    "",      inline = "MA #4", active = show_ma4, display = display.data_window)

ma1 = show_ma1 ? ma(ma1_source, ma1_length, ma1_type) : na
ma2 = show_ma2 ? ma(ma2_source, ma2_length, ma2_type) : na
ma3 = show_ma3 ? ma(ma3_source, ma3_length, ma3_type) : na
ma4 = show_ma4 ? ma(ma4_source, ma4_length, ma4_type) : na

plot(ma1, "MA #1", ma1_color, display = show_ma1 ? display.all : display.none)
plot(ma2, "MA #2", ma2_color, display = show_ma2 ? display.all : display.none)
plot(ma3, "MA #3", ma3_color, display = show_ma3 ? display.all : display.none)
plot(ma4, "MA #4", ma4_color, display = show_ma4 ? display.all : display.none)
