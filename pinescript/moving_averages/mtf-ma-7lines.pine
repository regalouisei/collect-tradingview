//@version=6
indicator("MTF MA Lines (7) – Stable (No Tick Wobble) + Right Labels", overlay=true, max_labels_count=200)

//====================================================
// Inputs
//====================================================
grpCommon = "Common"
src      = input.source(close, "Source", group=grpCommon)
lineW    = input.int(2, "Line Width", minval=1, maxval=5, group=grpCommon)
stableOn = input.bool(true, "Stable (no tick update) ※リアルタイム足は確定まで値を固定", group=grpCommon)

grpLbl   = "Right Labels"
showLbl  = input.bool(true, "Show right labels", group=grpLbl)
lblXoff  = input.int(0, "Label X offset (bars)", minval=0, maxval=200, group=grpLbl)
lblSize  = input.string("small", "Label Size", options=["tiny","small","normal","large","huge"], group=grpLbl)

//====================================================
// MA selector
//====================================================
f_ma(_type, _src, _len) =>
    switch _type
        "SMA"  => ta.sma(_src, _len)
        "EMA"  => ta.ema(_src, _len)
        "RMA"  => ta.rma(_src, _len)   // SMMA系
        "WMA"  => ta.wma(_src, _len)
        "VWMA" => ta.vwma(_src, _len)

// 「Tickでぐらぐらしない」：リアルタイムの未確定バーは前バー値を使う
f_stable(_v) =>
    stableOn ? (barstate.isconfirmed ? _v : _v[1]) : _v

//====================================================
// Inputs per line (7)
// おすすめデフォ色（見分けやすい系）
//====================================================
grp1 = "Line 1"
on1   = input.bool(true,  "Enable", group=grp1)
tf1   = input.timeframe("1",  "Timeframe", group=grp1)
len1  = input.int(20, "Length", minval=1, group=grp1)
typ1  = input.string("EMA", "MA Type", options=["SMA","EMA","RMA","WMA","VWMA"], group=grp1)
col1  = input.color(color.aqua, "Color (default)", group=grp1)

grp2 = "Line 2"
on2   = input.bool(true,  "Enable", group=grp2)
tf2   = input.timeframe("5",  "Timeframe", group=grp2)
len2  = input.int(20, "Length", minval=1, group=grp2)
typ2  = input.string("EMA", "MA Type", options=["SMA","EMA","RMA","WMA","VWMA"], group=grp2)
col2  = input.color(color.lime, "Color (default)", group=grp2)

grp3 = "Line 3"
on3   = input.bool(true,  "Enable", group=grp3)
tf3   = input.timeframe("15", "Timeframe", group=grp3)
len3  = input.int(20, "Length", minval=1, group=grp3)
typ3  = input.string("SMA", "MA Type", options=["SMA","EMA","RMA","WMA","VWMA"], group=grp3)
col3  = input.color(color.yellow, "Color (default)", group=grp3)

grp4 = "Line 4"
on4   = input.bool(true,  "Enable", group=grp4)
tf4   = input.timeframe("30", "Timeframe", group=grp4)
len4  = input.int(75, "Length", minval=1, group=grp4)
typ4  = input.string("SMA", "MA Type", options=["SMA","EMA","RMA","WMA","VWMA"], group=grp4)
col4  = input.color(color.orange, "Color (default)", group=grp4)

grp5 = "Line 5"
on5   = input.bool(true,  "Enable", group=grp5)
tf5   = input.timeframe("60", "Timeframe", group=grp5)
len5  = input.int(200, "Length", minval=1, group=grp5)
typ5  = input.string("SMA", "MA Type", options=["SMA","EMA","RMA","WMA","VWMA"], group=grp5)
col5  = input.color(color.fuchsia, "Color (default)", group=grp5)

grp6 = "Line 6"
on6   = input.bool(true,  "Enable", group=grp6)
tf6   = input.timeframe("240", "Timeframe", group=grp6)
len6  = input.int(200, "Length", minval=1, group=grp6)
typ6  = input.string("SMA", "MA Type", options=["SMA","EMA","RMA","WMA","VWMA"], group=grp6)
col6  = input.color(color.blue, "Color (default)", group=grp6)

grp7 = "Line 7"
on7   = input.bool(true,  "Enable", group=grp7)
tf7   = input.timeframe("D", "Timeframe", group=grp7)
len7  = input.int(200, "Length", minval=1, group=grp7)
typ7  = input.string("SMA", "MA Type", options=["SMA","EMA","RMA","WMA","VWMA"], group=grp7)
col7  = input.color(color.gray, "Color (default)", group=grp7)

//====================================================
// MTF MA calc (7)
//====================================================
f_mtf_ma(_tf, _type, _src, _len) =>
    request.security(syminfo.tickerid, _tf, f_ma(_type, _src, _len), barmerge.gaps_off, barmerge.lookahead_off)

ma1_raw = on1 ? f_mtf_ma(tf1, typ1, src, len1) : na
ma2_raw = on2 ? f_mtf_ma(tf2, typ2, src, len2) : na
ma3_raw = on3 ? f_mtf_ma(tf3, typ3, src, len3) : na
ma4_raw = on4 ? f_mtf_ma(tf4, typ4, src, len4) : na
ma5_raw = on5 ? f_mtf_ma(tf5, typ5, src, len5) : na
ma6_raw = on6 ? f_mtf_ma(tf6, typ6, src, len6) : na
ma7_raw = on7 ? f_mtf_ma(tf7, typ7, src, len7) : na

ma1 = on1 ? f_stable(ma1_raw) : na
ma2 = on2 ? f_stable(ma2_raw) : na
ma3 = on3 ? f_stable(ma3_raw) : na
ma4 = on4 ? f_stable(ma4_raw) : na
ma5 = on5 ? f_stable(ma5_raw) : na
ma6 = on6 ? f_stable(ma6_raw) : na
ma7 = on7 ? f_stable(ma7_raw) : na

//====================================================
// Plots
//====================================================
plot(ma1, "MA1", color=on1 ? col1 : na, linewidth=lineW)
plot(ma2, "MA2", color=on2 ? col2 : na, linewidth=lineW)
plot(ma3, "MA3", color=on3 ? col3 : na, linewidth=lineW)
plot(ma4, "MA4", color=on4 ? col4 : na, linewidth=lineW)
plot(ma5, "MA5", color=on5 ? col5 : na, linewidth=lineW)
plot(ma6, "MA6", color=on6 ? col6 : na, linewidth=lineW)
plot(ma7, "MA7", color=on7 ? col7 : na, linewidth=lineW)

//====================================================
// Right labels (optional) : last bar only
//====================================================
f_tfText(_tf) =>
    // そのまま表示（"60" とか "240" とか "D"）
    _tf

f_fmt(_v) =>
    str.tostring(_v, format.mintick)

f_lblText(_tf, _type, _len, _v) =>
    f_tfText(_tf) + " " + _type + str.tostring(_len) + "  " + f_fmt(_v)

var label lb1 = na
var label lb2 = na
var label lb3 = na
var label lb4 = na
var label lb5 = na
var label lb6 = na
var label lb7 = na

f_updLabel(_enabled, _lb, _y, _txt, _col) =>
    if not showLbl or not _enabled or na(_y)
        if not na(_lb)
            label.delete(_lb)
        na
    else
        if not na(_lb)
            label.delete(_lb)
        label.new(bar_index + lblXoff, _y, _txt, xloc=xloc.bar_index, style=label.style_label_right, textcolor=color.white, color=_col, size=lblSize)

if barstate.islast
    lb1 := f_updLabel(on1, lb1, ma1, f_lblText(tf1, typ1, len1, ma1), col1)
    lb2 := f_updLabel(on2, lb2, ma2, f_lblText(tf2, typ2, len2, ma2), col2)
    lb3 := f_updLabel(on3, lb3, ma3, f_lblText(tf3, typ3, len3, ma3), col3)
    lb4 := f_updLabel(on4, lb4, ma4, f_lblText(tf4, typ4, len4, ma4), col4)
    lb5 := f_updLabel(on5, lb5, ma5, f_lblText(tf5, typ5, len5, ma5), col5)
    lb6 := f_updLabel(on6, lb6, ma6, f_lblText(tf6, typ6, len6, ma6), col6)
    lb7 := f_updLabel(on7, lb7, ma7, f_lblText(tf7, typ7, len7, ma7), col7)
