//@version=6
indicator("5m MES/MGC EMA Cross (HA + Trend Cross) v6", overlay=true, max_labels_count=500)

// ───── Inputs
fastLen      = input.int(9,  "Fast EMA", minval=1)
slowLen      = input.int(21, "Slow EMA", minval=1)

trendMode    = input.string("EMA200", "Trend Filter", options=["None", "EMA200", "HTF EMA"])
htfEmaLen    = input.int(50, "HTF EMA Length (1H)", minval=1)

useHeikin    = input.bool(true, "Use Heikin Ashi Filter")
haConsec     = input.int(1, "HA candles (1 or 2)", minval=1, maxval=2)

useVWAP      = input.bool(true, "VWAP Filter")
useADX       = input.bool(false, "ADX Filter")

diLen        = input.int(14, "DI Length", minval=1)
adxSmooth    = input.int(14, "ADX Smoothing", minval=1)
minAdx       = input.float(20, "Min ADX", minval=1)

cooldownBars = input.int(6, "Cooldown bars", minval=0)
showLabels   = input.bool(true, "Show Labels")

// ───── EMAs
fastEma = ta.ema(close, fastLen)
slowEma = ta.ema(close, slowLen)
plot(fastEma, color=color.blue, linewidth=2, title="Fast EMA")
plot(slowEma, color=color.orange, linewidth=2, title="Slow EMA")

// ───── Heikin Ashi (v6 correct)
haTicker = ticker.heikinashi(syminfo.tickerid)
haOpen   = request.security(haTicker, timeframe.period, open)
haClose  = request.security(haTicker, timeframe.period, close)

haBull = haClose > haOpen
haBear = haClose < haOpen

haBullOk = haBull
haBearOk = haBear
if haConsec == 2
    haBullOk := haBull and haBull[1]
    haBearOk := haBear and haBear[1]

heikinBuyOk  = (not useHeikin) or haBullOk
heikinSellOk = (not useHeikin) or haBearOk

// ───── Trend lines
ema200 = ta.ema(close, 200)
htfEma = request.security(syminfo.tickerid, "60", ta.ema(close, htfEmaLen))

float trendLine = na
if trendMode == "EMA200"
    trendLine := ema200
else if trendMode == "HTF EMA"
    trendLine := htfEma
else
    trendLine := na

// Your rule: open on one side of trendLine and close on the other = valid
crossUpTrend   = (trendMode != "None") and (open < trendLine) and (close > trendLine)
crossDownTrend = (trendMode != "None") and (open > trendLine) and (close < trendLine)

trendBuyOk  = true
trendSellOk = true
if trendMode != "None"
    trendBuyOk  := (close > trendLine) or crossUpTrend
    trendSellOk := (close < trendLine) or crossDownTrend

// ───── VWAP
vwapVal    = ta.vwap(hlc3)
vwapBuyOk  = (not useVWAP) or (close > vwapVal)
vwapSellOk = (not useVWAP) or (close < vwapVal)

// ───── ADX (v6 requires diLength + adxSmoothing)
[diplus, diminus, adx] = ta.dmi(diLen, adxSmooth)
adxOk = (not useADX) or (adx >= minAdx)

// ───── Cross signals
buyRaw  = ta.crossover(fastEma, slowEma)
sellRaw = ta.crossunder(fastEma, slowEma)

// ───── Cooldown
var int lastSignalBar = na
cooldownOk = (cooldownBars == 0) or na(lastSignalBar) or ((bar_index - lastSignalBar) > cooldownBars)

// ───── Final signals (confirmed close)
buySignal  = barstate.isconfirmed and cooldownOk and buyRaw  and trendBuyOk  and heikinBuyOk  and vwapBuyOk  and adxOk
sellSignal = barstate.isconfirmed and cooldownOk and sellRaw and trendSellOk and heikinSellOk and vwapSellOk and adxOk

if buySignal or sellSignal
    lastSignalBar := bar_index

// ───── Labels
if showLabels and buySignal
    label.new(bar_index, low, "BUY", style=label.style_label_up, textcolor=color.white, color=color.new(color.green, 0))

if showLabels and sellSignal
    label.new(bar_index, high, "SELL", style=label.style_label_down, textcolor=color.white, color=color.new(color.red, 0))

// ───── Alerts
alertcondition(buySignal,  title="BUY",  message="BUY: EMA cross + filters (5m)")
alertcondition(sellSignal, title="SELL", message="SELL: EMA cross + filters (5m)")
