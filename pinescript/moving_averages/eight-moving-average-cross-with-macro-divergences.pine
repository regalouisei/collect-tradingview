//@version=6
indicator("Eight Moving Average Cross with Macro Divergences", shorttitle="8MA Macro", overlay=false, max_lines_count=500, max_labels_count=500)

// Credits: Inspired by the open-source "MA difference" concept from @cereallarceny.
// This version expands the idea into an 8-moving-average oscillator with cascade alignment and macro divergence layers.

// ==========================================
// INPUTS - MOVING AVERAGES
// ==========================================
MA_GROUP = "Moving Averages"
ma_base_length = input.int(13, "Base Length", group=MA_GROUP,
     tooltip="Baseline length used as the anchor for all percentage differences.")
ma_short_length = input.int(17, "Short Length", group=MA_GROUP,
     tooltip="Short-term moving average length used for faster cross signals.")
ma_medium_length = input.int(30, "Medium Length", group=MA_GROUP,
     tooltip="Medium-term moving average length used for trend confirmation.")
ma_long_length = input.int(50, "Long Length", group=MA_GROUP,
     tooltip="Long-term moving average length that also acts as the macro price reference.")

ma_x1_length = input.int(100, "Extra MA 1 Length", group=MA_GROUP,
     tooltip="First extra long-term moving average length used for cascade alignment.")
ma_x2_length = input.int(150, "Extra MA 2 Length", group=MA_GROUP,
     tooltip="Second extra long-term moving average length used for cascade alignment.")
ma_x3_length = input.int(200, "Extra MA 3 Length", group=MA_GROUP,
     tooltip="Third extra long-term moving average length used for cascade alignment.")
ma_x4_length = input.int(200, "Extra MA 4 Length", group=MA_GROUP,
     tooltip="Fourth extra long-term moving average length used for macro confirmation.")

ma_source = input.source(close, "Source", group=MA_GROUP,
     tooltip="Price source used for all moving average calculations.")
ma_type = input.string("EMA", "Type", options=["SMA", "EMA", "SMMA (RMA)", "WMA", "VWMA"], group=MA_GROUP,
     tooltip="Moving average type applied to all lengths. EMA is default for responsiveness.")

// ==========================================
// INPUTS - DISPLAY & VISIBILITY
// ==========================================
DISPLAY_GROUP = "Display"
show_chart_info = input.bool(true, "Show Chart Info", group=DISPLAY_GROUP,
     tooltip="Displays symbol, timeframe, and indicator name in the pane.")

VIS_GROUP = "Visibility"
show_zero_line = input.bool(true, "Zero Line", group=VIS_GROUP, inline="zero",
     tooltip="Show the zero line that separates bullish from bearish zones.")
show_short = input.bool(true, "Short", group=VIS_GROUP, inline="short",
     tooltip="Display the short moving average difference plot.")
show_medium = input.bool(true, "Medium", group=VIS_GROUP, inline="medium",
     tooltip="Display the medium moving average difference plot.")
show_long = input.bool(true, "Long", group=VIS_GROUP, inline="long",
     tooltip="Display the long moving average difference plot.")
show_x1 = input.bool(true, "Extra MA 1", group=VIS_GROUP, inline="x1",
     tooltip="Display the first extra moving average difference plot.")
show_x2 = input.bool(true, "Extra MA 2", group=VIS_GROUP, inline="x2",
     tooltip="Display the second extra moving average difference plot.")
show_x3 = input.bool(true, "Extra MA 3", group=VIS_GROUP, inline="x3",
     tooltip="Display the third extra moving average difference plot.")
show_x4 = input.bool(true, "Extra MA 4", group=VIS_GROUP, inline="x4",
     tooltip="Display the fourth extra moving average difference plot.")

// ==========================================
// INPUTS - FILL CONTROLS
// ==========================================
FILL_GROUP = "Fill Areas"
fill_short = input.bool(true, "Fill Short", group=FILL_GROUP, inline="fs",
     tooltip="Fill between zero line and short difference plot.")
fill_short_color_0 = input.color(#00FF00, "Bullish", group=FILL_GROUP, inline="fs",
     tooltip="Fill color when the short difference is above zero.")
fill_short_color_1 = input.color(#FF0000, "Bearish", group=FILL_GROUP, inline="fs",
     tooltip="Fill color when the short difference is below zero.")

fill_medium = input.bool(true, "Fill Medium", group=FILL_GROUP, inline="fm",
     tooltip="Fill between zero line and medium difference plot.")
fill_medium_color_0 = input.color(#00FF00, "Bullish", group=FILL_GROUP, inline="fm",
     tooltip="Fill color when the medium difference is above zero.")
fill_medium_color_1 = input.color(#FF0000, "Bearish", group=FILL_GROUP, inline="fm",
     tooltip="Fill color when the medium difference is below zero.")

fill_long = input.bool(true, "Fill Long", group=FILL_GROUP, inline="fl",
     tooltip="Fill between zero line and long difference plot.")
fill_long_color_0 = input.color(#00FF00, "Bullish", group=FILL_GROUP, inline="fl",
     tooltip="Fill color when the long difference is above zero.")
fill_long_color_1 = input.color(#FF0000, "Bearish", group=FILL_GROUP, inline="fl",
     tooltip="Fill color when the long difference is below zero.")

fill_x1 = input.bool(true, "Fill Extra MA 1", group=FILL_GROUP, inline="fx1",
     tooltip="Fill between zero line and Extra MA 1 difference plot.")
fill_x1_color_0 = input.color(#00FF00, "Bullish", group=FILL_GROUP, inline="fx1",
     tooltip="Fill color when Extra MA 1 difference is above zero.")
fill_x1_color_1 = input.color(#FF0000, "Bearish", group=FILL_GROUP, inline="fx1",
     tooltip="Fill color when Extra MA 1 difference is below zero.")

fill_x2 = input.bool(true, "Fill Extra MA 2", group=FILL_GROUP, inline="fx2",
     tooltip="Fill between zero line and Extra MA 2 difference plot.")
fill_x2_color_0 = input.color(#FFFFFF, "Bullish", group=FILL_GROUP, inline="fx2",
     tooltip="Fill color when Extra MA 2 difference is above zero.")
fill_x2_color_1 = input.color(#000000, "Bearish", group=FILL_GROUP, inline="fx2",
     tooltip="Fill color when Extra MA 2 difference is below zero.")

fill_x3 = input.bool(true, "Fill Extra MA 3", group=FILL_GROUP, inline="fx3",
     tooltip="Fill between zero line and Extra MA 3 difference plot.")
fill_x3_color_0 = input.color(#FFFFFF, "Bullish", group=FILL_GROUP, inline="fx3",
     tooltip="Fill color when Extra MA 3 difference is above zero.")
fill_x3_color_1 = input.color(#000000, "Bearish", group=FILL_GROUP, inline="fx3",
     tooltip="Fill color when Extra MA 3 difference is below zero.")

fill_x4 = input.bool(true, "Fill Extra MA 4", group=FILL_GROUP, inline="fx4",
     tooltip="Fill between zero line and Extra MA 4 difference plot.")
fill_x4_color_0 = input.color(#FFFFFF, "Bullish", group=FILL_GROUP, inline="fx4",
     tooltip="Fill color when Extra MA 4 difference is above zero.")
fill_x4_color_1 = input.color(#000000, "Bearish", group=FILL_GROUP, inline="fx4",
     tooltip="Fill color when Extra MA 4 difference is below zero.")

// ==========================================
// INPUTS - DIVERGENCES (MACRO SETTINGS)
// ==========================================
DIV_GROUP = "Divergences"
show_classic_bullish = input.bool(false, "Show Classic Bullish", group=DIV_GROUP,
     tooltip="Draw classic bullish divergences when price makes a lower low but the oscillator makes a higher low.")
show_classic_bearish = input.bool(false, "Show Classic Bearish", group=DIV_GROUP,
     tooltip="Draw classic bearish divergences when price makes a higher high but the oscillator makes a lower high.")
show_hidden_bullish = input.bool(false, "Show Hidden Bullish", group=DIV_GROUP,
     tooltip="Draw hidden bullish divergences when price makes a higher low but the oscillator makes a lower low.")
show_hidden_bearish = input.bool(false, "Show Hidden Bearish", group=DIV_GROUP,
     tooltip="Draw hidden bearish divergences when price makes a lower high but the oscillator makes a higher high.")

pivot_lookback_left = input.int(15, "Pivot Lookback Left", minval=5, maxval=50, group=DIV_GROUP,
     tooltip="Bars to the left of a pivot point used to confirm swing highs/lows.")
pivot_lookback_right = input.int(15, "Pivot Lookback Right", minval=5, maxval=50, group=DIV_GROUP,
     tooltip="Bars to the right of a pivot point used to confirm swing highs/lows.")
min_bars_between_pivots = input.int(20, "Minimum Bars Between Pivots", minval=10, maxval=100, group=DIV_GROUP,
     tooltip="Minimum separation between pivots to reduce noisy divergence signals.")
oscillator_smoothing = input.int(3, "Oscillator Smoothing", minval=1, maxval=10, group=DIV_GROUP,
     tooltip="Smoothing applied to the divergence oscillator. Higher values reduce noise.")
min_divergence_amplitude = input.float(1.0, "Minimum Divergence Amplitude", minval=0.1, maxval=10.0, step=0.1, group=DIV_GROUP,
     tooltip="Minimum oscillator swing required for a divergence to be considered valid.")

div_line_width = input.int(2, "Divergence Line Width", minval=1, maxval=5, group=DIV_GROUP,
     tooltip="Line width used to draw divergence connections.")

bullish_div_color = input.color(#1fff00, "Bullish Divergence Color", group=DIV_GROUP,
     tooltip="Color for bullish divergence lines.")
bearish_div_color = input.color(#ff0000, "Bearish Divergence Color", group=DIV_GROUP,
     tooltip="Color for bearish divergence lines.")

show_tuning_table = input.bool(false, "Show Divergence Tuning Table", group=DIV_GROUP,
     tooltip="Displays a quick reference table for divergence settings by timeframe.")

// ==========================================
// INPUTS - CASCADE SIGNAL SETTINGS
// ==========================================
SIGNAL_GROUP = "Cascade Signals"
show_cascade_signals = input.bool(true, "Show Cascade Signals", group=SIGNAL_GROUP,
     tooltip="Enable visual cascade signals when multiple MA layers align.")
non_repainting = input.bool(true, "Non-repainting signals (bar close)", group=SIGNAL_GROUP,
     tooltip="When enabled, signals and alerts trigger only on confirmed bar close to prevent repainting.")

cascade_viz_mode = input.string("Background", "Visualization Mode", options=["Background", "Shapes", "Both"], group=SIGNAL_GROUP,
     tooltip="Choose whether cascade signals appear as background shading, shapes, or both. Shapes are tiny circles and are off by default.")

cascade_bg_buy_opacity = input.int(22, "Buy Background Opacity", minval=0, maxval=100, group=SIGNAL_GROUP, inline="bg1",
     tooltip="Opacity of the bullish background highlight.")
cascade_bg_buy_color = input.color(#1fff00, "Bullish", group=SIGNAL_GROUP, inline="bg1",
     tooltip="Background color for bullish cascade alignment.")

cascade_bg_sell_opacity = input.int(22, "Sell Background Opacity", minval=0, maxval=100, group=SIGNAL_GROUP, inline="bg2",
     tooltip="Opacity of the bearish background highlight.")
cascade_bg_sell_color = input.color(#ff0000, "Bearish", group=SIGNAL_GROUP, inline="bg2",
     tooltip="Background color for bearish cascade alignment.")

cascade_shape_buy_location = input.string("Bottom", "Buy Shape Position", options=["Bottom", "Top", "Below Bar", "Above Bar"], group=SIGNAL_GROUP, inline="shp1",
     tooltip="Position for bullish cascade shape markers.")
cascade_shape_buy_color = input.color(#1fff00, "Bullish", group=SIGNAL_GROUP, inline="shp1",
     tooltip="Color for bullish cascade shape markers.")

cascade_shape_sell_location = input.string("Top", "Sell Shape Position", options=["Bottom", "Top", "Below Bar", "Above Bar"], group=SIGNAL_GROUP, inline="shp2",
     tooltip="Position for bearish cascade shape markers.")
cascade_shape_sell_color = input.color(#ff0000, "Bearish", group=SIGNAL_GROUP, inline="shp2",
     tooltip="Color for bearish cascade shape markers.")

// ==========================================
// FUNCTIONS
// ==========================================
maFunc(src, len, maType) =>
    switch maType
        "SMA" => ta.sma(src, len)
        "EMA" => ta.ema(src, len)
        "SMMA (RMA)" => ta.rma(src, len)
        "WMA" => ta.wma(src, len)
        "VWMA" => ta.vwma(src, len)
        => ta.ema(src, len)

percent_change(a, b) =>
    b != 0 ? (a - b) / math.abs(b) * 100 : 0

confirm_signal(cond) =>
    non_repainting ? (cond and barstate.isconfirmed) : cond

confirm_draw(cond) =>
    non_repainting ? (cond and barstate.isconfirmed) : cond

// ==========================================
// MA CALCULATIONS
// ==========================================
ma_base = maFunc(ma_source, ma_base_length, ma_type)
ma_short = maFunc(ma_source, ma_short_length, ma_type)
ma_medium = maFunc(ma_source, ma_medium_length, ma_type)
ma_long = maFunc(ma_source, ma_long_length, ma_type)

ma_x1 = maFunc(ma_source, ma_x1_length, ma_type)
ma_x2 = maFunc(ma_source, ma_x2_length, ma_type)
ma_x3 = maFunc(ma_source, ma_x3_length, ma_type)
ma_x4 = maFunc(ma_source, ma_x4_length, ma_type)

// ==========================================
// OSCILLATOR CALCULATIONS (DIFFS)
// ==========================================
diff_short = percent_change(ma_base, ma_short)
diff_medium = percent_change(ma_base, ma_medium)
diff_long = percent_change(ma_base, ma_long)
diff_x1 = percent_change(ma_base, ma_x1)
diff_x2 = percent_change(ma_base, ma_x2)
diff_x3 = percent_change(ma_base, ma_x3)
diff_x4 = percent_change(ma_base, ma_x4)

// ==========================================
// CHART-SIDE REFERENCE (EMA 50)
// ==========================================
ema_50 = ma_long

// ==========================================
// OSCILLATOR-SIDE REFERENCE
// ==========================================
osc_value_raw = (diff_x1 + diff_x2 + diff_x3) / 3
osc_value = ta.sma(osc_value_raw, oscillator_smoothing)

// ==========================================
// CASCADE SIGNAL LOGIC
// ==========================================
extra_cascade_bearish = diff_x1 < 0 and diff_x2 < 0 and diff_x3 < 0 and diff_x4 < 0
extra_cascade_bullish = diff_x1 > 0 and diff_x2 > 0 and diff_x3 > 0 and diff_x4 > 0

cross_down_short = ta.crossunder(diff_short, 0)
cross_down_medium = ta.crossunder(diff_medium, 0)
cross_down_long = ta.crossunder(diff_long, 0)
any_base_cross_down = cross_down_short or cross_down_medium or cross_down_long

cross_up_short = ta.crossover(diff_short, 0)
cross_up_medium = ta.crossover(diff_medium, 0)
cross_up_long = ta.crossover(diff_long, 0)
any_base_cross_up = cross_up_short or cross_up_medium or cross_up_long

cascade_sell_raw = any_base_cross_down and extra_cascade_bearish
cascade_buy_raw = any_base_cross_up and extra_cascade_bullish

cascade_sell = confirm_signal(cascade_sell_raw)
cascade_buy = confirm_signal(cascade_buy_raw)

// ==========================================
// MACRO PIVOT DETECTION
// ==========================================
price_ph = ta.pivothigh(ema_50, pivot_lookback_left, pivot_lookback_right)
price_pl = ta.pivotlow(ema_50, pivot_lookback_left, pivot_lookback_right)

osc_ph = ta.pivothigh(osc_value, pivot_lookback_left, pivot_lookback_right)
osc_pl = ta.pivotlow(osc_value, pivot_lookback_left, pivot_lookback_right)

// ==========================================
// STORE LAST 2 MACRO PIVOTS
// ==========================================
var float price_high_prev = na
var int price_high_prev_bar = na
var float price_high_curr = na
var int price_high_curr_bar = na

var float price_low_prev = na
var int price_low_prev_bar = na
var float price_low_curr = na
var int price_low_curr_bar = na

var float osc_high_prev = na
var int osc_high_prev_bar = na
var float osc_high_curr = na
var int osc_high_curr_bar = na

var float osc_low_prev = na
var int osc_low_prev_bar = na
var float osc_low_curr = na
var int osc_low_curr_bar = na

if not na(price_ph)
    bars_since_last = na(price_high_curr_bar) ? 999 : bar_index - pivot_lookback_right - price_high_curr_bar
    if bars_since_last >= min_bars_between_pivots
        price_high_prev := price_high_curr
        price_high_prev_bar := price_high_curr_bar
        price_high_curr := price_ph
        price_high_curr_bar := bar_index - pivot_lookback_right

if not na(price_pl)
    bars_since_last = na(price_low_curr_bar) ? 999 : bar_index - pivot_lookback_right - price_low_curr_bar
    if bars_since_last >= min_bars_between_pivots
        price_low_prev := price_low_curr
        price_low_prev_bar := price_low_curr_bar
        price_low_curr := price_pl
        price_low_curr_bar := bar_index - pivot_lookback_right

if not na(osc_ph)
    bars_since_last = na(osc_high_curr_bar) ? 999 : bar_index - pivot_lookback_right - osc_high_curr_bar
    if bars_since_last >= min_bars_between_pivots
        osc_high_prev := osc_high_curr
        osc_high_prev_bar := osc_high_curr_bar
        osc_high_curr := osc_ph
        osc_high_curr_bar := bar_index - pivot_lookback_right

if not na(osc_pl)
    bars_since_last = na(osc_low_curr_bar) ? 999 : bar_index - pivot_lookback_right - osc_low_curr_bar
    if bars_since_last >= min_bars_between_pivots
        osc_low_prev := osc_low_curr
        osc_low_prev_bar := osc_low_curr_bar
        osc_low_curr := osc_pl
        osc_low_curr_bar := bar_index - pivot_lookback_right

// ==========================================
// MACRO DIVERGENCE DETECTION
// ==========================================
classic_bearish_detected = false
if not na(price_ph) and not na(price_high_prev) and not na(osc_high_curr) and not na(osc_high_prev)
    price_higher = price_high_curr > price_high_prev
    osc_lower = osc_high_curr < osc_high_prev
    osc_amplitude = math.abs(osc_high_curr - osc_high_prev)
    if price_higher and osc_lower and osc_amplitude >= min_divergence_amplitude
        classic_bearish_detected := true

classic_bullish_detected = false
if not na(price_pl) and not na(price_low_prev) and not na(osc_low_curr) and not na(osc_low_prev)
    price_lower = price_low_curr < price_low_prev
    osc_higher = osc_low_curr > osc_low_prev
    osc_amplitude = math.abs(osc_low_curr - osc_low_prev)
    if price_lower and osc_higher and osc_amplitude >= min_divergence_amplitude
        classic_bullish_detected := true

hidden_bearish_detected = false
if not na(price_ph) and not na(price_high_prev) and not na(osc_high_curr) and not na(osc_high_prev)
    price_lower = price_high_curr < price_high_prev
    osc_higher = osc_high_curr > osc_high_prev
    osc_amplitude = math.abs(osc_high_curr - osc_high_prev)
    if price_lower and osc_higher and osc_amplitude >= min_divergence_amplitude
        hidden_bearish_detected := true

hidden_bullish_detected = false
if not na(price_pl) and not na(price_low_prev) and not na(osc_low_curr) and not na(osc_low_prev)
    price_higher = price_low_curr > price_low_prev
    osc_lower = osc_low_curr < osc_low_prev
    osc_amplitude = math.abs(osc_low_curr - osc_low_prev)
    if price_higher and osc_lower and osc_amplitude >= min_divergence_amplitude
        hidden_bullish_detected := true

// ==========================================
// DRAW MACRO DIVERGENCE LINES
// ==========================================
if show_classic_bearish and confirm_draw(classic_bearish_detected)
    line.new(osc_high_prev_bar, osc_high_prev, osc_high_curr_bar, osc_high_curr, color=bearish_div_color, width=div_line_width, style=line.style_solid)

if show_classic_bullish and confirm_draw(classic_bullish_detected)
    line.new(osc_low_prev_bar, osc_low_prev, osc_low_curr_bar, osc_low_curr, color=bullish_div_color, width=div_line_width, style=line.style_solid)

if show_hidden_bearish and confirm_draw(hidden_bearish_detected)
    line.new(osc_high_prev_bar, osc_high_prev, osc_high_curr_bar, osc_high_curr, color=bearish_div_color, width=div_line_width, style=line.style_dashed)

if show_hidden_bullish and confirm_draw(hidden_bullish_detected)
    line.new(osc_low_prev_bar, osc_low_prev, osc_low_curr_bar, osc_low_curr, color=bullish_div_color, width=div_line_width, style=line.style_dashed)

// ==========================================
// DIVERGENCE TUNING TABLE
// ==========================================
if show_tuning_table and barstate.islast
    var tuning_table = table.new(position.top_right, 5, 5, bgcolor=color.new(color.black, 5), frame_color=color.new(color.green, 30), frame_width=2, border_color=color.new(color.gray, 0), border_width=1)
    table.cell(tuning_table, 0, 0, "How to tune for your timeframe", text_color=color.white, bgcolor=color.new(color.green, 70), text_size=size.normal, text_halign=text.align_left)
    table.merge_cells(tuning_table, 0, 0, 4, 0)
    table.cell(tuning_table, 0, 1, "Timeframe", text_color=color.green, bgcolor=color.new(color.gray, 80), text_size=size.small, text_halign=text.align_center)
    table.cell(tuning_table, 1, 1, "Pivot Lookback", text_color=color.green, bgcolor=color.new(color.gray, 80), text_size=size.small, text_halign=text.align_center)
    table.cell(tuning_table, 2, 1, "Min Bars Between", text_color=color.green, bgcolor=color.new(color.gray, 80), text_size=size.small, text_halign=text.align_center)
    table.cell(tuning_table, 3, 1, "Smoothing", text_color=color.green, bgcolor=color.new(color.gray, 80), text_size=size.small, text_halign=text.align_center)
    table.cell(tuning_table, 4, 1, "Min Amplitude", text_color=color.green, bgcolor=color.new(color.gray, 80), text_size=size.small, text_halign=text.align_center)
    table.cell(tuning_table, 0, 2, "1H-4H charts", text_color=color.white, bgcolor=color.new(color.black, 0), text_size=size.small, text_halign=text.align_left)
    table.cell(tuning_table, 1, 2, "15-20", text_color=color.white, bgcolor=color.new(color.black, 0), text_size=size.small, text_halign=text.align_center)
    table.cell(tuning_table, 2, 2, "20-30", text_color=color.white, bgcolor=color.new(color.black, 0), text_size=size.small, text_halign=text.align_center)
    table.cell(tuning_table, 3, 2, "3-5", text_color=color.white, bgcolor=color.new(color.black, 0), text_size=size.small, text_halign=text.align_center)
    table.cell(tuning_table, 4, 2, "1.0-2.0", text_color=color.white, bgcolor=color.new(color.black, 0), text_size=size.small, text_halign=text.align_center)
    table.cell(tuning_table, 0, 3, "Daily charts", text_color=color.white, bgcolor=color.new(color.gray, 90), text_size=size.small, text_halign=text.align_left)
    table.cell(tuning_table, 1, 3, "10-15", text_color=color.white, bgcolor=color.new(color.gray, 90), text_size=size.small, text_halign=text.align_center)
    table.cell(tuning_table, 2, 3, "15-25", text_color=color.white, bgcolor=color.new(color.gray, 90), text_size=size.small, text_halign=text.align_center)
    table.cell(tuning_table, 3, 3, "2-3", text_color=color.white, bgcolor=color.new(color.gray, 90), text_size=size.small, text_halign=text.align_center)
    table.cell(tuning_table, 4, 3, "0.5-1.5", text_color=color.white, bgcolor=color.new(color.gray, 90), text_size=size.small, text_halign=text.align_center)
    table.cell(tuning_table, 0, 4, "15m charts", text_color=color.white, bgcolor=color.new(color.black, 0), text_size=size.small, text_halign=text.align_left)
    table.cell(tuning_table, 1, 4, "20-30", text_color=color.white, bgcolor=color.new(color.black, 0), text_size=size.small, text_halign=text.align_center)
    table.cell(tuning_table, 2, 4, "30-50", text_color=color.white, bgcolor=color.new(color.black, 0), text_size=size.small, text_halign=text.align_center)
    table.cell(tuning_table, 3, 4, "5-7", text_color=color.white, bgcolor=color.new(color.black, 0), text_size=size.small, text_halign=text.align_center)
    table.cell(tuning_table, 4, 4, "2.0-3.0", text_color=color.white, bgcolor=color.new(color.black, 0), text_size=size.small, text_halign=text.align_center)

// ==========================================
// COLORS
// ==========================================
make_color(diff, color_0, color_1) =>
    diff > 0 ? color_0 : color_1

diff_short_color = make_color(diff_short, fill_short_color_0, fill_short_color_1)
diff_medium_color = make_color(diff_medium, fill_medium_color_0, fill_medium_color_1)
diff_long_color = make_color(diff_long, fill_long_color_0, fill_long_color_1)
diff_x1_color = make_color(diff_x1, fill_x1_color_0, fill_x1_color_1)
diff_x2_color = make_color(diff_x2, fill_x2_color_0, fill_x2_color_1)
diff_x3_color = make_color(diff_x3, fill_x3_color_0, fill_x3_color_1)
diff_x4_color = make_color(diff_x4, fill_x4_color_0, fill_x4_color_1)

// ==========================================
// PLOTS
// ==========================================
zero_line = plot(show_zero_line ? 0 : na, "Zero Line", color=color.gray, linewidth=1)

p_short = plot(show_short ? diff_short : na, "Short", color=color.new(color.gray, 100), linewidth=1, display=display.none)
p_medium = plot(show_medium ? diff_medium : na, "Medium", color=color.new(color.gray, 100), linewidth=1, display=display.none)
p_long = plot(show_long ? diff_long : na, "Long", color=color.new(color.gray, 100), linewidth=1, display=display.none)
p_x1 = plot(show_x1 ? diff_x1 : na, "Extra MA 1", color=color.new(color.gray, 100), linewidth=1, display=display.none)
p_x2 = plot(show_x2 ? diff_x2 : na, "Extra MA 2", color=color.new(color.gray, 100), linewidth=1, display=display.none)
p_x3 = plot(show_x3 ? diff_x3 : na, "Extra MA 3", color=color.new(color.gray, 100), linewidth=1, display=display.none)
p_x4 = plot(show_x4 ? diff_x4 : na, "Extra MA 4", color=color.new(color.gray, 100), linewidth=1, display=display.none)

// ==========================================
// FILL AREAS
// ==========================================
fill(p_short, zero_line, color=fill_short ? diff_short_color : na, title="Fill Short")
fill(p_medium, zero_line, color=fill_medium ? diff_medium_color : na, title="Fill Medium")
fill(p_long, zero_line, color=fill_long ? diff_long_color : na, title="Fill Long")
fill(p_x1, zero_line, color=fill_x1 ? diff_x1_color : na, title="Fill Extra MA 1")
fill(p_x2, zero_line, color=fill_x2 ? diff_x2_color : na, title="Fill Extra MA 2")
fill(p_x3, zero_line, color=fill_x3 ? diff_x3_color : na, title="Fill Extra MA 3")
fill(p_x4, zero_line, color=fill_x4 ? diff_x4_color : na, title="Fill Extra MA 4")

// ==========================================
// CASCADE SIGNALS - BACKGROUND VISUALIZATION
// ==========================================
show_bg = cascade_viz_mode == "Background" or cascade_viz_mode == "Both"
bgcolor(show_cascade_signals and show_bg and cascade_buy ? color.new(cascade_bg_buy_color, 100 - cascade_bg_buy_opacity) : na, title="Cascade Buy Background")
bgcolor(show_cascade_signals and show_bg and cascade_sell ? color.new(cascade_bg_sell_color, 100 - cascade_bg_sell_opacity) : na, title="Cascade Sell Background")

// ==========================================
// CASCADE SIGNALS - SHAPE VISUALIZATION
// ==========================================
show_shapes = cascade_viz_mode == "Shapes" or cascade_viz_mode == "Both"

buy_shape_y = cascade_shape_buy_location == "Bottom" ? ta.lowest(diff_x3, 50) : cascade_shape_buy_location == "Top" ? ta.highest(diff_x3, 50) : cascade_shape_buy_location == "Below Bar" ? diff_x3 - ta.atr(14) : diff_x3 + ta.atr(14)

sell_shape_y = cascade_shape_sell_location == "Bottom" ? ta.lowest(diff_x3, 50) : cascade_shape_sell_location == "Top" ? ta.highest(diff_x3, 50) : cascade_shape_sell_location == "Below Bar" ? diff_x3 - ta.atr(14) : diff_x3 + ta.atr(14)

plotshape(show_cascade_signals and show_shapes and cascade_buy ? buy_shape_y : na,
     title="Cascade Buy Shape",
     style=shape.circle,
     location=location.bottom,
     color=color.new(cascade_bg_buy_color, 0),
     size=size.tiny)

plotshape(show_cascade_signals and show_shapes and cascade_sell ? sell_shape_y : na,
     title="Cascade Sell Shape",
     style=shape.circle,
     location=location.top,
     color=color.new(cascade_bg_sell_color, 0),
     size=size.tiny)

// ==========================================
// CHART INFO LABEL
// ==========================================
var table info_table = table.new(position.top_right, 1, 1, bgcolor=color.new(color.black, 75))
if show_chart_info and barstate.islast
    table.cell(info_table, 0, 0, syminfo.ticker + " | " + timeframe.period + " | Eight Moving Average Cross", text_color=color.white, text_size=size.tiny)
if not show_chart_info and barstate.islast
    table.clear(info_table, 0, 0, 0, 0)

// ==========================================
// ALERTS (CONFIRMED BAR WHEN NON-REPAINTING)
// ==========================================
alertcondition(cascade_buy, title="Cascade Buy Signal (Confirmed)",
     message="Cascade Buy on {{ticker}} {{interval}} at {{close}}. Base MAs crossed above zero while extra MAs are bullish.")
alertcondition(cascade_sell, title="Cascade Sell Signal (Confirmed)",
     message="Cascade Sell on {{ticker}} {{interval}} at {{close}}. Base MAs crossed below zero while extra MAs are bearish.")

alertcondition(confirm_signal(classic_bullish_detected), title="Classic Bullish Divergence (Confirmed)",
     message="Classic bullish divergence on {{ticker}} {{interval}} at {{close}}. Price made a lower low while the oscillator made a higher low.")
alertcondition(confirm_signal(classic_bearish_detected), title="Classic Bearish Divergence (Confirmed)",
     message="Classic bearish divergence on {{ticker}} {{interval}} at {{close}}. Price made a higher high while the oscillator made a lower high.")
alertcondition(confirm_signal(hidden_bullish_detected), title="Hidden Bullish Divergence (Confirmed)",
     message="Hidden bullish divergence on {{ticker}} {{interval}} at {{close}}. Price made a higher low while the oscillator made a lower low.")
alertcondition(confirm_signal(hidden_bearish_detected), title="Hidden Bearish Divergence (Confirmed)",
     message="Hidden bearish divergence on {{ticker}} {{interval}} at {{close}}. Price made a lower high while the oscillator made a higher high.")
