//@version=5
indicator("5 EMA With Individual Angle Thresholds", overlay=true)

// ===== GLOBAL INPUT =====
atr_length = input.int(14, "ATR Length For Normalization")

// ===== EMA 1 SETTINGS =====
ema1_length     = input.int(9,  title="EMA 1 Length")
ema1_lookback   = input.int(5,  title="EMA 1 Angle Lookback")
ema1_buy_angle  = input.float(8.0,  title="EMA 1 BUY Angle")
ema1_sell_angle = input.float(-8.0, title="EMA 1 SELL Angle")
ema1_color      = input.color(color.green, title="EMA 1 Color")

// ===== EMA 2 SETTINGS =====
ema2_length     = input.int(21, title="EMA 2 Length")
ema2_lookback   = input.int(6,  title="EMA 2 Angle Lookback")
ema2_buy_angle  = input.float(8.0,  title="EMA 2 BUY Angle")
ema2_sell_angle = input.float(-8.0, title="EMA 2 SELL Angle")
ema2_color      = input.color(color.yellow, title="EMA 2 Color")

// ===== EMA 3 SETTINGS =====
ema3_length     = input.int(50, title="EMA 3 Length")
ema3_lookback   = input.int(8,  title="EMA 3 Angle Lookback")
ema3_buy_angle  = input.float(6.0,  title="EMA 3 BUY Angle")
ema3_sell_angle = input.float(-6.0, title="EMA 3 SELL Angle")
ema3_color      = input.color(color.aqua, title="EMA 3 Color")

// ===== EMA 4 SETTINGS =====
ema4_length     = input.int(100, title="EMA 4 Length")
ema4_lookback   = input.int(10,  title="EMA 4 Angle Lookback")
ema4_buy_angle  = input.float(5.0,  title="EMA 4 BUY Angle")
ema4_sell_angle = input.float(-5.0, title="EMA 4 SELL Angle")
ema4_color      = input.color(color.orange, title="EMA 4 Color")

// ===== EMA 5 SETTINGS =====
ema5_length     = input.int(200, title="EMA 5 Length")
ema5_lookback   = input.int(12,  title="EMA 5 Angle Lookback")
ema5_buy_angle  = input.float(4.0,  title="EMA 5 BUY Angle")
ema5_sell_angle = input.float(-4.0, title="EMA 5 SELL Angle")
ema5_color      = input.color(color.white, title="EMA 5 Color")

// ===== EMA CALCULATION =====
ema1 = ta.ema(close, ema1_length)
ema2 = ta.ema(close, ema2_length)
ema3 = ta.ema(close, ema3_length)
ema4 = ta.ema(close, ema4_length)
ema5 = ta.ema(close, ema5_length)

// Plot EMAs
plot(ema1, color=ema1_color, linewidth=2)
plot(ema2, color=ema2_color, linewidth=2)
plot(ema3, color=ema3_color, linewidth=2)
plot(ema4, color=ema4_color, linewidth=2)
plot(ema5, color=ema5_color, linewidth=2)

// ===== ANGLE CALCULATION =====
atr = ta.atr(atr_length)

calc_angle(ema_val, lookback) =>
    slope = (ema_val - ema_val[lookback]) / lookback
    normalized_slope = slope / math.max(atr, 0.000001)
    math.atan(normalized_slope) * 180 / math.pi

angle1 = calc_angle(ema1, ema1_lookback)
angle2 = calc_angle(ema2, ema2_lookback)
angle3 = calc_angle(ema3, ema3_lookback)
angle4 = calc_angle(ema4, ema4_lookback)
angle5 = calc_angle(ema5, ema5_lookback)

// ===== CATEGORY FUNCTION =====
getCategory(angle, buyLevel, sellLevel) =>
    string result = "SIDEWAYS"
    if angle >= buyLevel
        result := "BUY"
    else if angle <= sellLevel
        result := "SELL"
    result

getColor(angle, buyLevel, sellLevel) =>
    color result = color.yellow
    if angle >= buyLevel
        result := color.green
    else if angle <= sellLevel
        result := color.red
    result

// ===== DASHBOARD =====
var table dashboard = table.new(position.top_right, 2, 6, border_width=1)

if barstate.islast
    table.cell(dashboard, 0, 0, "EMA", bgcolor=color.black, text_color=color.white)
    table.cell(dashboard, 1, 0, "Angle", bgcolor=color.black, text_color=color.white)

    table.cell(dashboard, 0, 1, "EMA 1")
    table.cell(dashboard, 1, 1, getCategory(angle1, ema1_buy_angle, ema1_sell_angle) + " (" + str.tostring(angle1, "#.0") + "°)", bgcolor=getColor(angle1, ema1_buy_angle, ema1_sell_angle))

    table.cell(dashboard, 0, 2, "EMA 2")
    table.cell(dashboard, 1, 2, getCategory(angle2, ema2_buy_angle, ema2_sell_angle) + " (" + str.tostring(angle2, "#.0") + "°)", bgcolor=getColor(angle2, ema2_buy_angle, ema2_sell_angle))

    table.cell(dashboard, 0, 3, "EMA 3")
    table.cell(dashboard, 1, 3, getCategory(angle3, ema3_buy_angle, ema3_sell_angle) + " (" + str.tostring(angle3, "#.0") + "°)", bgcolor=getColor(angle3, ema3_buy_angle, ema3_sell_angle))

    table.cell(dashboard, 0, 4, "EMA 4")
    table.cell(dashboard, 1, 4, getCategory(angle4, ema4_buy_angle, ema4_sell_angle) + " (" + str.tostring(angle4, "#.0") + "°)", bgcolor=getColor(angle4, ema4_buy_angle, ema4_sell_angle))

    table.cell(dashboard, 0, 5, "EMA 5")
    table.cell(dashboard, 1, 5, getCategory(angle5, ema5_buy_angle, ema5_sell_angle) + " (" + str.tostring(angle5, "#.0") + "°)", bgcolor=getColor(angle5, ema5_buy_angle, ema5_sell_angle))
