// 0DTE Scalping Suite - by theTRADINGDECK
// Your complete 0DTE SPY/QQQ scalping system
// Â© 2026 Adam Silva / Ms. Flow

//@version=5
indicator("0DTE Scalping Suite", overlay=true, max_bars_back=500)

// ============================================
// USER INPUTS
// ============================================

// EMA Settings
ema_fast = input.int(9, "Fast EMA", minval=1, group="EMA Settings")
ema_slow = input.int(21, "Slow EMA", minval=1, group="EMA Settings")
show_ema = input.bool(true, "Show EMAs", group="EMA Settings")

// VWAP Settings
show_vwap = input.bool(true, "Show VWAP", group="VWAP Settings")
vwap_std_mult = input.float(1.0, "VWAP StdDev Multiplier", step=0.1, group="VWAP Settings")

// Impulse MACD Settings
macd_fast = input.int(12, "MACD Fast Length", group="Impulse MACD")
macd_slow = input.int(26, "MACD Slow Length", group="Impulse MACD")
macd_signal = input.int(9, "MACD Signal Length", group="Impulse MACD")
macd_threshold = input.float(0.05, "MACD Impulse Threshold", step=0.01, group="Impulse MACD")

// Market Internals Filter (Simulated)
use_internals_filter = input.bool(true, "Use Market Internals Filter", group="Market Internals")
internals_bullish_threshold = input.float(0.5, "Bullish Threshold (%)", group="Market Internals")
internals_bearish_threshold = input.float(-0.5, "Bearish Threshold (%)", group="Market Internals")

// Risk Calculator
show_risk_calc = input.bool(true, "Show Risk Calculator", group="Risk Management")
account_size = input.float(25000, "Account Size ($)", step=1000, group="Risk Management")
risk_percent = input.float(1.0, "Risk Per Trade (%)", step=0.1, group="Risk Management")
contract_price = input.float(2.00, "Estimated Contract Price ($)", step=0.1, group="Risk Management")

// Visual Settings
show_signals = input.bool(true, "Show Buy/Sell Arrows", group="Visual Settings")
show_ema_cloud = input.bool(true, "Show EMA Cloud", group="Visual Settings")

// ============================================
// CALCULATIONS
// ============================================

// EMAs
ema9 = ta.ema(close, ema_fast)
ema21 = ta.ema(close, ema_slow)

// VWAP
vwap = ta.vwap(close)
vwap_std = ta.stdev(close - vwap, 20)
vwap_upper = vwap + (vwap_std * vwap_std_mult)
vwap_lower = vwap - (vwap_std * vwap_std_mult)

// Impulse MACD
[macd_line, signal_line, hist] = ta.macd(close, macd_fast, macd_slow, macd_signal)
macd_bullish = hist > 0 and hist > hist[1] and math.abs(hist - hist[1]) > macd_threshold
macd_bearish = hist < 0 and hist < hist[1] and math.abs(hist - hist[1]) > macd_threshold

// Market Internals Simulation (based on price momentum + volume)
// NOTE: For real $TICK integration, use external data feed
price_change_pct = (close - close[1]) / close[1] * 100
volume_ratio = volume / ta.sma(volume, 20)
simulated_internals = price_change_pct * volume_ratio

internals_bullish = simulated_internals > internals_bullish_threshold
internals_bearish = simulated_internals < internals_bearish_threshold
internals_neutral = not internals_bullish and not internals_bearish

// EMA Crossover Detection
ema_cross_up = ta.crossover(ema9, ema21)
ema_cross_down = ta.crossunder(ema9, ema21)
ema_bullish = ema9 > ema21
ema_bearish = ema9 < ema21

// Price vs VWAP
price_above_vwap = close > vwap
price_below_vwap = close < vwap

// ============================================
// SIGNAL GENERATION
// ============================================

// BUY Signal: EMA bullish cross + MACD bullish impulse + price above VWAP + internals bullish
buy_signal = ema_cross_up and macd_bullish and price_above_vwap and (not use_internals_filter or internals_bullish)

// SELL Signal: EMA bearish cross + MACD bearish impulse + price below VWAP + internals bearish
sell_signal = ema_cross_down and macd_bearish and price_below_vwap and (not use_internals_filter or internals_bearish)

// ============================================
// RISK CALCULATOR
// ============================================

risk_amount = account_size * (risk_percent / 100)
contracts_to_trade = math.floor(risk_amount / contract_price)

// ============================================
// PLOTTING
// ============================================

// EMAs
plot(show_ema ? ema9 : na, "9 EMA", color=color.new(color.blue, 0), linewidth=2)
plot(show_ema ? ema21 : na, "21 EMA", color=color.new(color.yellow, 0), linewidth=2)

// EMA Cloud
ema_cloud_color = ema_bullish ? color.new(color.green, 85) : color.new(color.red, 85)
fill(plot(show_ema_cloud ? ema9 : na), plot(show_ema_cloud ? ema21 : na), color=ema_cloud_color, title="EMA Cloud")

// VWAP
plot(show_vwap ? vwap : na, "VWAP", color=color.new(color.white, 0), linewidth=2)
plot(show_vwap ? vwap_upper : na, "VWAP Upper", color=color.new(color.gray, 50), linewidth=1, style=plot.style_circles)
plot(show_vwap ? vwap_lower : na, "VWAP Lower", color=color.new(color.gray, 50), linewidth=1, style=plot.style_circles)

// Buy/Sell Arrows
plotshape(show_signals and buy_signal, "BUY", shape.triangleup, location.belowbar, color=color.new(color.green, 0), size=size.small, text="BUY")
plotshape(show_signals and sell_signal, "SELL", shape.triangledown, location.abovebar, color=color.new(color.red, 0), size=size.small, text="SELL")

// Background coloring based on internals
bgcolor(use_internals_filter and internals_bullish ? color.new(color.green, 95) : na, title="Bullish Internals BG")
bgcolor(use_internals_filter and internals_bearish ? color.new(color.red, 95) : na, title="Bearish Internals BG")

// ============================================
// RISK CALCULATOR TABLE
// ============================================

if show_risk_calc and barstate.islast
    var table risk_table = table.new(position.top_right, 2, 5, border_width=2, border_color=color.gray, frame_color=color.gray, frame_width=2)
    
    // Header
    table.cell(risk_table, 0, 0, "Risk Calculator", text_color=color.white, bgcolor=color.new(color.blue, 0), text_size=size.normal)
    table.merge_cells(risk_table, 0, 0, 1, 0)
    
    // Account Size
    table.cell(risk_table, 0, 1, "Account Size:", text_color=color.white, bgcolor=color.new(color.gray, 50))
    table.cell(risk_table, 1, 1, "$" + str.tostring(account_size, "#,###"), text_color=color.white, bgcolor=color.new(color.gray, 70))
    
    // Risk Per Trade
    table.cell(risk_table, 0, 2, "Risk Per Trade:", text_color=color.white, bgcolor=color.new(color.gray, 50))
    table.cell(risk_table, 1, 2, str.tostring(risk_percent, "#.##") + "% ($" + str.tostring(risk_amount, "#,###") + ")", text_color=color.white, bgcolor=color.new(color.gray, 70))
    
    // Contract Price
    table.cell(risk_table, 0, 3, "Contract Price:", text_color=color.white, bgcolor=color.new(color.gray, 50))
    table.cell(risk_table, 1, 3, "$" + str.tostring(contract_price, "#.##"), text_color=color.white, bgcolor=color.new(color.gray, 70))
    
    // Contracts to Trade
    table.cell(risk_table, 0, 4, "Contracts:", text_color=color.white, bgcolor=color.new(color.green, 30))
    table.cell(risk_table, 1, 4, str.tostring(contracts_to_trade) + " contracts", text_color=color.white, bgcolor=color.new(color.green, 50), text_size=size.large)

// ============================================
// ALERTS
// ============================================

alertcondition(buy_signal, "BUY Signal", "0DTE Scalping Suite: BUY signal detected! All conditions aligned.")
alertcondition(sell_signal, "SELL Signal", "0DTE Scalping Suite: SELL signal detected! All conditions aligned.")
alertcondition(ema_cross_up, "EMA Bullish Cross", "9 EMA crossed above 21 EMA - Bullish momentum shift.")
alertcondition(ema_cross_down, "EMA Bearish Cross", "9 EMA crossed below 21 EMA - Bearish momentum shift.")
