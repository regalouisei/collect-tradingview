//@version=6
indicator("Custom 13-Week & 26-Week MA (Dashed 50% Transparent)", overlay=true, max_labels_count=500)

// Inputs
devThresholdPct = input.float(10.0, "Extreme % Deviation Threshold", minval=0)
devThresholdSD = input.float(2.0, "Extreme SD Deviation Threshold", minval=0)

// Fetch weekly closes
weeklyClose = request.security(syminfo.tickerid, "W", close)

// Calculate MAs
ma13 = ta.sma(weeklyClose, 13)
ma26 = ta.sma(weeklyClose, 26)

// Colors
oliveGreen50 = color.new(#808000, 100)   // 50% transparent for lines/arrows
magenta50    = color.new(#C000C0, 100)   // 50% transparent for lines/arrows

oliveGreenSolid = #808000                // Solid for table label
magentaSolid    = #C000C0                // Solid for table label

// Plot solid thin base lines (slightly more opaque for better tracking)
plot(ma13, color=color.new(#808000, 50), linewidth=2, title="13-Week Base")
plot(ma26, color=color.new(#C000C0, 50), linewidth=2, title="26-Week Base")

// Clean dashed effect (heavy, 50% transparent)
dash13 = (bar_index % 6 < 3) ? ma13 : na
dash26 = (bar_index % 6 < 3) ? ma26 : na

plot(dash13, color=oliveGreen50, linewidth=5, style=plot.style_line, title="13-Week Dashed")
plot(dash26, color=magenta50,    linewidth=5, style=plot.style_line, title="26-Week Dashed")

// Percentage deviations
devPct13 = ma13 != 0 ? (close - ma13) / ma13 * 100 : na
devPct26 = ma26 != 0 ? (close - ma26) / ma26 * 100 : na

// SD deviations
stdev13 = ta.stdev(weeklyClose, 13)
stdev26 = ta.stdev(weeklyClose, 26)
devSD13 = stdev13 != 0 ? (close - ma13) / stdev13 : na
devSD26 = stdev26 != 0 ? (close - ma26) / stdev26 : na

// Hidden plots for alerts
plot(devPct13, title="% Dev 13W", display=display.none)
plot(devPct26, title="% Dev 26W", display=display.none)
plot(devSD13, title="SD Dev 13W", display=display.none)
plot(devSD26, title="SD Dev 26W", display=display.none)

// Crossover arrows (50% transparent, matching lines)
bullCross = ta.crossover(ma13, ma26)
bearCross = ta.crossunder(ma13, ma26)

plotshape(bullCross, style=shape.triangleup,   location=location.belowbar, color=oliveGreen50, size=size.small)
plotshape(bearCross, style=shape.triangledown, location=location.abovebar, color=magenta50,    size=size.small)

// Dashboard table - now with solid label colors for clear visibility
var table devTable = table.new(position.top_right, 3, 3, bgcolor=color.new(color.black, 85), border_width=1)

if barstate.islast
    table.cell(devTable, 0, 0, "MA", text_color=color.white, bgcolor=color.new(color.gray, 50), text_size=size.small)
    table.cell(devTable, 0, 1, "% Deviation", text_color=color.white, bgcolor=color.new(color.gray, 50), text_size=size.small)
    table.cell(devTable, 0, 2, "SD Deviation", text_color=color.white, bgcolor=color.new(color.gray, 50), text_size=size.small)
    
    table.cell(devTable, 1, 0, "13-Week", text_color=oliveGreenSolid, text_size=size.normal)
    table.cell(devTable, 1, 1, str.tostring(devPct13, "#.##") + "%", text_color=devPct13 > 0 ? color.lime : color.red, text_size=size.normal)
    table.cell(devTable, 1, 2, str.tostring(devSD13, "#.##") + " σ", text_color=devSD13 > 0 ? color.lime : color.red, text_size=size.normal)
    
    table.cell(devTable, 2, 0, "26-Week", text_color=magentaSolid, text_size=size.normal)
    table.cell(devTable, 2, 1, str.tostring(devPct26, "#.##") + "%", text_color=devPct26 > 0 ? color.lime : color.red, text_size=size.normal)
    table.cell(devTable, 2, 2, str.tostring(devSD26, "#.##") + " σ", text_color=devSD26 > 0 ? color.lime : color.red, text_size=size.normal)

// Alerts
alertcondition(math.abs(devPct13) > devThresholdPct or math.abs(devPct26) > devThresholdPct,
     title="Extreme % Deviation", 
     message="Extreme % deviation: 13W {{plot(\"% Dev 13W\")}}% | 26W {{plot(\"% Dev 26W\")}}%")

alertcondition(math.abs(devSD13) > devThresholdSD or math.abs(devSD26) > devThresholdSD,
     title="Extreme SD Deviation", 
     message="Extreme SD deviation: 13W {{plot(\"SD Dev 13W\")}} σ | 26W {{plot(\"SD Dev 26W\")}} σ")
