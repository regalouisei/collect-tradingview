//@version=5
indicator(title="High Win Rate Scalping EMA Indicator", shorttitle="Scalp EMA", overlay=true, timeframe="", timeframe_gaps=true)

// Inputs
emaFastLen = input.int(8, title="Fast EMA Length", minval=1)
emaMidLen = input.int(13, title="Mid EMA Length", minval=1)
emaSlowLen = input.int(21, title="Slow EMA Length", minval=1)
htfTimeframe = input.timeframe("60", title="Higher Timeframe (e.g., 60 for 1H)")

// Calculate EMAs on current timeframe (1min)
emaFast = ta.ema(close, emaFastLen)
emaMid = ta.ema(close, emaMidLen)
emaSlow = ta.ema(close, emaSlowLen)

// Fetch higher timeframe data
htfEmaFast = request.security(syminfo.tickerid, htfTimeframe, ta.ema(close, emaFastLen), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_on)
htfEmaMid = request.security(syminfo.tickerid, htfTimeframe, ta.ema(close, emaMidLen), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_on)
htfEmaSlow = request.security(syminfo.tickerid, htfTimeframe, ta.ema(close, emaSlowLen), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_on)

// Determine HTF trend
htfBullish = htfEmaFast > htfEmaMid and htfEmaMid > htfEmaSlow
htfBearish = htfEmaFast < htfEmaMid and htfEmaMid < htfEmaSlow
htfNeutral = not htfBullish and not htfBearish

// Plot EMAs
plot(emaFast, color=color.blue, title="Fast EMA")
plot(emaMid, color=color.orange, title="Mid EMA")
plot(emaSlow, color=color.red, title="Slow EMA")

// Entry Signals on 1min (aligned with HTF)
// Long Entry: Price above all EMAs, EMAs stacked bullishly, and recent breakout high
// Short Entry: Opposite
rangeLen = input.int(5, title="Range Lookback for Breakout", minval=1)
rangeHigh = ta.highest(high, rangeLen)
rangeLow = ta.lowest(low, rangeLen)

longCondition = htfBullish and close > emaFast and emaFast > emaMid and emaMid > emaSlow and close > rangeHigh[1]
shortCondition = htfBearish and close < emaFast and emaFast < emaMid and emaMid < emaSlow and close < rangeLow[1]

// Plot Signals
plotshape(series=longCondition, title="Long Entry", location=location.belowbar, color=color.green, style=shape.triangleup, size=size.small, text="BUY")
plotshape(series=shortCondition, title="Short Entry", location=location.abovebar, color=color.red, style=shape.triangledown, size=size.small, text="SELL")

// Optional Filters
useVolFilter = input.bool(true, title="Use Volume Filter")
volMaLen = input.int(14, title="Volume MA Length")
avgVol = ta.sma(volume, volMaLen)
highVol = volume > avgVol * 1.5  // Only signal if volume is 50% above average

if useVolFilter
    longCondition := longCondition and highVol
    shortCondition := shortCondition and highVol

// Alerts
alertcondition(longCondition, title="Long Scalp Alert", message="Potential Long Entry on 1min - Check HTF Bullish")
alertcondition(shortCondition, title="Short Scalp Alert", message="Potential Short Entry on 1min - Check HTF Bearish")

// Background for HTF Trend
bgcolor(htfBullish ? color.new(color.green, 90) : na, title="HTF Bullish")
bgcolor(htfBearish ? color.new(color.red, 90) : na, title="HTF Bearish")
bgcolor(htfNeutral ? color.new(color.gray, 90) : na, title="HTF Neutral")
