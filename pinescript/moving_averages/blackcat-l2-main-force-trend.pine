//@version=6
indicator("[blackcat] L2 Main Force Trend", overlay=true, max_bars_back=5000)

// ============================================================================
// INPUT PARAMETERS
// ============================================================================

// Display options
showSupportLines = input.bool(true, "Show Support Lines", group="Display Options")
showMovingAverages = input.bool(true, "Show Moving Averages", group="Display Options")
showStatusTable = input.bool(true, "Show Status Table", group="Display Options")
showBuySellLabels = input.bool(true, "Show Buy/Sell Labels", group="Display Options")
showTrendBackground = input.bool(true, "Show Trend Background", group="Display Options")
showSignalShapes = input.bool(true, "Show Signal Shapes", group="Display Options")
showVolumeBars = input.bool(true, "Show Volume Bars", group="Display Options")

// Color inputs - Neon/Cyberpunk Theme
colorTopLine = input.color(color.new(#00FFFF, 0), "Top Line Color", group="Colors")
colorBottomLine = input.color(color.new(#FF00FF, 0), "Bottom Line Color", group="Colors")
colorMa5 = input.color(color.new(#00FF00, 0), "MA5 Color", group="Colors")
colorMa10 = input.color(color.new(#FFFF00, 0), "MA10 Color", group="Colors")
colorMa30 = input.color(color.new(#FF6600, 0), "MA30 Color", group="Colors")
colorMa5Strong = input.color(color.new(#FF0000, 0), "MA5 Strong Trend Color", group="Colors")
colorMa30Strong = input.color(color.new(#FF1493, 0), "MA30 Strong Trend Color", group="Colors")
colorBuyLabel = input.color(color.new(#00FF00, 0), "Buy Label Color", group="Colors")
colorSellLabel = input.color(color.new(#FF00FF, 0), "Sell Label Color", group="Colors")
colorBullishBg = input.color(color.new(#00FF00, 95), "Bullish Background", group="Colors")
colorBearishBg = input.color(color.new(#FF0000, 95), "Bearish Background", group="Colors")

// Calculation parameters
supportPeriod = input.int(150, "Support Line Period", minval=10, maxval=500, group="Calculation")
supportShift = input.int(3, "Support Line Shift", minval=0, maxval=20, group="Calculation")
signalLookback = input.int(10, "Signal Lookback Bars", minval=1, maxval=50, group="Calculation")
cooldownBars = input.int(20, "Cooldown Bars", minval=5, maxval=50, group="Calculation")

// ============================================================================
// CUSTOM FUNCTIONS
// ============================================================================

// Function to check if condition occurred within last N bars
occurredInLastBars(condition, bars) =>
    bool result = false
    for i = 0 to bars - 1
        if condition[i]
            result := true
            break
    result

// Function to count true occurrences in last N bars
countTrue(condition, bars) =>
    int count = 0
    for i = 0 to bars - 1
        if condition[i]
            count := count + 1
    count

// Function to calculate slope angle in degrees
calculateSlopeAngle(maValue) =>
    float slope = (maValue / maValue[1] - 1) * 100
    float angle = math.atan(slope) * 180 / math.pi
    angle

// ============================================================================
// CORE CALCULATIONS
// ============================================================================

// Calculate support lines (150-period high/low shifted by 3 bars)
float highSupport = ta.highest(high, supportPeriod)[supportShift]
float lowSupport = ta.lowest(low, supportPeriod)[supportShift]

// Calculate moving averages
float ma5 = ta.sma(close, 5)
float ma10 = ta.sma(close, 10)
float ma30 = ta.sma(close, 30)

// Calculate bias rates (deviation from moving averages)
float bias5 = (close - ma5) / ma5 * 100
float bias30 = (close - ma30) / ma30 * 100

// Calculate slope angles using atan
float slope5 = calculateSlopeAngle(ma5)
float slope30 = calculateSlopeAngle(ma30)

// Calculate RSI for additional confirmation
float rsiValue = ta.rsi(close, 14)

// ============================================================================
// SIGNAL CONDITIONS
// ============================================================================

// Golden Cross: MA5 crosses above MA10 (Buy signal)
bool goldenCross = ta.crossover(ma5, ma10)

// Death Cross: MA5 crosses below MA10 (Sell signal)
bool deathCross = ta.crossunder(ma5, ma10)

// Additional confirmation: Price crosses above/below MA30
bool priceAboveMa30 = ta.crossover(close, ma30)
bool priceBelowMa30 = ta.crossunder(close, ma30)

// Strong Buy: Golden Cross + Price above MA30 + Bias5 positive + RSI not overbought
bool strongBuyCondition = goldenCross and priceAboveMa30 and bias5 > 0 and rsiValue < 70

// Strong Sell: Death Cross + Price below MA30 + Bias5 negative + RSI not oversold
bool strongSellCondition = deathCross and priceBelowMa30 and bias5 < 0 and rsiValue > 30

// Medium Buy: Golden Cross + Bias5 increasing
bool mediumBuyCondition = goldenCross and bias5 > bias5[1]

// Medium Sell: Death Cross + Bias5 decreasing
bool mediumSellCondition = deathCross and bias5 < bias5[1]

// Combine conditions for final signals (prefer strong signals over medium ones)
bool buyCondition = strongBuyCondition or mediumBuyCondition
bool sellCondition = strongSellCondition or mediumSellCondition

// Apply cooldown period to prevent too frequent signals
var int lastBuyBar = -100
var int lastSellBar = -100

bool buyCooldown = bar_index - lastBuyBar < cooldownBars
bool sellCooldown = bar_index - lastSellBar < cooldownBars

// Final signals with cooldown
bool buySignal = buyCondition and not buyCooldown
bool sellSignal = sellCondition and not sellCooldown

// Update last signal bars
if buySignal
    lastBuyBar := bar_index
if sellSignal
    lastSellBar := bar_index

// ============================================================================
// TREND ANALYSIS
// ============================================================================

// Determine overall trend direction
string trendDirection = "NEUTRAL"
if ma5 > ma10 and ma10 > ma30
    trendDirection := "BULLISH"
else if ma5 < ma10 and ma10 < ma30
    trendDirection := "BEARISH"

// Determine slope status with emojis
string slope5Status = slope5 > 30 ? "üöÄ STRONG" : (slope5 > 0 ? "‚¨ÜÔ∏è WEAK" : (slope5 < -30 ? "üí• STRONG" : "‚¨áÔ∏è WEAK"))
string slope30Status = slope30 > 15 ? "üöÄ STRONG" : (slope30 > 0 ? "‚¨ÜÔ∏è WEAK" : (slope30 < -15 ? "üí• STRONG" : "‚¨áÔ∏è WEAK"))

// Determine current signal with emojis
string currentSignal = "‚≠ï NONE"
if strongBuyCondition
    currentSignal := "üü¢ STRONG BUY"
else if mediumBuyCondition
    currentSignal := "üü° BUY"
else if strongSellCondition
    currentSignal := "üî¥ STRONG SELL"
else if mediumSellCondition
    currentSignal := "üü£ SELL"

// ============================================================================
// VISUALIZATION - TREND BACKGROUND
// ============================================================================

// Color the background based on trend
bool isBullish = ma5 > ma10 and ma10 > ma30
bool isBearish = ma5 < ma10 and ma10 < ma30

bgcolor(showTrendBackground ? (isBullish ? colorBullishBg : (isBearish ? colorBearishBg : na)) : na)

// ============================================================================
// VISUALIZATION - VOLUME BARS
// ============================================================================

// Plot volume bars with color based on price movement
// volumeColor = close > open ? color.new(color.green, 70) : color.new(color.red, 70)
// plot(showVolumeBars ? volume : na, "Volume", style=plot.style_columns, color=color.new(volumeColor, 10))

// ============================================================================
// VISUALIZATION - SUPPORT LINES WITH GLOW EFFECT
// ============================================================================

// Plot support lines with glow effect (multiple lines with decreasing opacity)
plot(showSupportLines ? highSupport : na, "Top Support", color=colorTopLine, linewidth=2)
plot(showSupportLines ? highSupport : na, "Top Support Glow 1", color=color.new(colorTopLine, 30), linewidth=4)
plot(showSupportLines ? highSupport : na, "Top Support Glow 2", color=color.new(colorTopLine, 60), linewidth=6)

plot(showSupportLines ? lowSupport : na, "Bottom Support", color=colorBottomLine, linewidth=2)
plot(showSupportLines ? lowSupport : na, "Bottom Support Glow 1", color=color.new(colorBottomLine, 30), linewidth=4)
plot(showSupportLines ? lowSupport : na, "Bottom Support Glow 2", color=color.new(colorBottomLine, 60), linewidth=6)

// ============================================================================
// VISUALIZATION - MOVING AVERAGES WITH DYNAMIC COLORS
// ============================================================================

// Dynamic colors based on trend strength
ma5DynamicColor = (slope5 > 30 and ma5 > ma5[1]) ? colorMa5Strong : 
                  (ma5 > ma10 ? color.new(color.green, 0) : color.new(color.red, 0))
ma10DynamicColor = ma10 > ma30 ? color.new(color.yellow, 0) : color.new(color.orange, 0)
ma30DynamicColor = (slope30 > 15 and ma30 > ma30[1]) ? colorMa30Strong : colorMa30

// Plot moving averages with dynamic colors
plot(showMovingAverages ? ma5 : na, "MA5", color=ma5DynamicColor, linewidth=2)
plot(showMovingAverages ? ma10 : na, "MA10", color=ma10DynamicColor, linewidth=2)
plot(showMovingAverages ? ma30 : na, "MA30", color=ma30DynamicColor, linewidth=2)

// Add glow effect to moving averages
plot(showMovingAverages ? ma5 : na, "MA5 Glow", color=color.new(ma5DynamicColor, 50), linewidth=4)
plot(showMovingAverages ? ma10 : na, "MA10 Glow", color=color.new(ma10DynamicColor, 50), linewidth=4)
plot(showMovingAverages ? ma30 : na, "MA30 Glow", color=color.new(ma30DynamicColor, 50), linewidth=4)

// ============================================================================
// VISUALIZATION - SIGNAL SHAPES
// ============================================================================

// Plot shapes for buy signals
plotshape(showSignalShapes and buySignal, "Buy Shape", shape.triangleup, location.belowbar, 
          color.new(colorBuyLabel, 0), size=size.small, text="BUY")

// Plot shapes for sell signals
plotshape(showSignalShapes and sellSignal, "Sell Shape", shape.triangledown, location.abovebar, 
          color.new(colorSellLabel, 0), size=size.small, text="SELL")

// Plot shapes for golden cross
plotshape(showSignalShapes and goldenCross, "Golden Cross", shape.diamond, location.belowbar, 
          color.new(color.green, 0), size=size.tiny)

// Plot shapes for death cross
plotshape(showSignalShapes and deathCross, "Death Cross", shape.diamond, location.abovebar, 
          color.new(color.red, 0), size=size.tiny)

// ============================================================================
// VISUALIZATION - FILL BETWEEN MA LINES
// ============================================================================

// Create plots for fill (hidden)
ma5Plot = plot(showMovingAverages ? ma5 : na, "MA5 Fill", display=display.none)
ma10Plot = plot(showMovingAverages ? ma10 : na, "MA10 Fill", display=display.none)
ma30Plot = plot(showMovingAverages ? ma30 : na, "MA30 Fill", display=display.none)

// Fill between MA5 and MA10 with gradient color based on trend
fillColor = ma5 > ma10 ? color.new(color.green, 90) : color.new(color.red, 90)
fill(ma5Plot, ma10Plot, color=fillColor)

// Fill between MA10 and MA30
fillColor2 = ma10 > ma30 ? color.new(color.yellow, 90) : color.new(color.orange, 90)
fill(ma10Plot, ma30Plot, color=fillColor2)

// ============================================================================
// STATUS TABLE WITH CYBERPUNK STYLE
// ============================================================================

var table statusTable = table.new(position.top_right, 2, 7, 
                                bgcolor=color.new(color.black, 80), 
                                border_width=1, 
                                border_color=color.new(#00FFFF, 50))

if showStatusTable and barstate.islast
    // Header row
    table.cell(statusTable, 0, 0, "üìä STATUS", text_color=color.new(#00FFFF, 0), text_size=size.small, bgcolor=color.new(#00FFFF, 90))
    table.cell(statusTable, 1, 0, "üí∞ SIGNAL", text_color=color.new(#FF00FF, 0), text_size=size.small, bgcolor=color.new(#FF00FF, 90))
    
    // Trend direction
    string trendText = "Trend: " + trendDirection
    color trendColor = trendDirection == "BULLISH" ? color.new(#00FF00, 0) : (trendDirection == "BEARISH" ? color.new(#FF0000, 0) : color.new(#FFFF00, 0))
    table.cell(statusTable, 0, 1, trendText, text_color=trendColor, text_size=size.small)
    
    // Bias5 value
    string bias5Text = "Bias5: " + str.tostring(bias5, "#.##") + "%"
    color bias5Color = bias5 > 0 ? color.new(#00FF00, 0) : (bias5 < 0 ? color.new(#FF0000, 0) : color.new(#FFFF00, 0))
    table.cell(statusTable, 1, 1, bias5Text, text_color=bias5Color, text_size=size.small)
    
    // Bias30 value
    string bias30Text = "Bias30: " + str.tostring(bias30, "#.##") + "%"
    color bias30Color = bias30 > 0 ? color.new(#00FF00, 0) : (bias30 < 0 ? color.new(#FF0000, 0) : color.new(#FFFF00, 0))
    table.cell(statusTable, 0, 2, bias30Text, text_color=bias30Color, text_size=size.small)
    
    // MA5 slope status
    string slope5Text = "MA5: " + slope5Status
    color slope5Color = slope5 > 0 ? color.new(#00FF00, 0) : color.new(#FF0000, 0)
    table.cell(statusTable, 1, 2, slope5Text, text_color=slope5Color, text_size=size.small)
    
    // MA30 slope status
    string slope30Text = "MA30: " + slope30Status
    color slope30Color = slope30 > 0 ? color.new(#00FF00, 0) : color.new(#FF0000, 0)
    table.cell(statusTable, 0, 3, slope30Text, text_color=slope30Color, text_size=size.small)
    
    // Current signal
    string signalText = "Signal: " + currentSignal
    color signalColor = strongBuyCondition ? color.new(#00FF00, 0) : 
                      (mediumBuyCondition ? color.new(#FFFF00, 0) : 
                      (strongSellCondition ? color.new(#FF0000, 0) : 
                      (mediumSellCondition ? color.new(#FF00FF, 0) : color.new(#808080, 0))))
    table.cell(statusTable, 1, 3, signalText, text_color=signalColor, text_size=size.small, bgcolor=color.new(signalColor, 90))
    
    // Additional info
    string priceChangeText = "Change: " + str.tostring((close / close[1] - 1) * 100, "#.##") + "%"
    color priceChangeColor = close > close[1] ? color.new(#00FF00, 0) : color.new(#FF0000, 0)
    table.cell(statusTable, 0, 4, priceChangeText, text_color=priceChangeColor, text_size=size.small)
    
    string rsiText = "RSI: " + str.tostring(rsiValue, "#.#")
    color rsiColor = rsiValue > 70 ? color.new(#FF0000, 0) : (rsiValue < 30 ? color.new(#00FF00, 0) : color.new(#FFFF00, 0))
    table.cell(statusTable, 1, 4, rsiText, text_color=rsiColor, text_size=size.small)
    
    string closePriceText = "Close: " + str.tostring(close, "#.####")
    table.cell(statusTable, 0, 5, closePriceText, text_color=color.new(#FFFFFF, 0), text_size=size.small)
    
    string positionText = "Pos: " + str.tostring((close - lowSupport) / (highSupport - lowSupport) * 100, "#.#") + "%"
    color positionColor = (close - lowSupport) / (highSupport - lowSupport) > 0.5 ? color.new(#00FF00, 0) : color.new(#FF0000, 0)
    table.cell(statusTable, 1, 5, positionText, text_color=positionColor, text_size=size.small)
    
    // Cooldown status
    string cooldownText = "CD: " + str.tostring(bar_index - math.max(lastBuyBar, lastSellBar)) + "/" + str.tostring(cooldownBars)
    table.cell(statusTable, 0, 6, cooldownText, text_color=color.new(#FFFFFF, 0), text_size=size.small)
    
    string strengthText = strongBuyCondition or strongSellCondition ? "STRONG" : "NORMAL"
    color strengthColor = strongBuyCondition or strongSellCondition ? color.new(#FF00FF, 0) : color.new(#00FFFF, 0)
    table.cell(statusTable, 1, 6, strengthText, text_color=strengthColor, text_size=size.small)

// ============================================================================
// BUY/SELL LABELS WITH ENHANCED STYLING
// ============================================================================

// Create buy labels with enhanced styling
if showBuySellLabels and buySignal and barstate.isconfirmed
    label.new(bar_index, low, 
              text="‚¨ÜÔ∏è BUY\n" + str.tostring(close, "#.##"),
              color=colorBuyLabel, 
              textcolor=color.black,
              style=label.style_label_up,
              size=size.normal,
              yloc=yloc.belowbar)

// Create sell labels with enhanced styling
if showBuySellLabels and sellSignal and barstate.isconfirmed
    label.new(bar_index, high, 
              text="‚¨áÔ∏è SELL\n" + str.tostring(close, "#.##"),
              color=colorSellLabel, 
              textcolor=color.black,
              style=label.style_label_down,
              size=size.normal,
              yloc=yloc.abovebar)

// ============================================================================
// ALERT CONDITIONS
// ============================================================================

alertcondition(buySignal, "Buy Signal", "Main Capital Position Change: BUY Signal")
alertcondition(sellSignal, "Sell Signal", "Main Capital Position Change: SELL Signal")
alertcondition(goldenCross, "Golden Cross", "MA5 crosses above MA10 - Potential Buy")
alertcondition(deathCross, "Death Cross", "MA5 crosses below MA10 - Potential Sell")

// ============================================================================
// END OF SCRIPT
// ============================================================================
