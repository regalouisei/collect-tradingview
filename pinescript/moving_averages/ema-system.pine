//@version=6
indicator("EMA System ", overlay=true, max_labels_count=500)

// =====================================================
// Inputs
// =====================================================
grpEma = "EMAs"
len9   = input.int(9,   "EMA 9",   minval=1, group=grpEma)
len21  = input.int(21,  "EMA 21",  minval=1, group=grpEma)
len50  = input.int(50,  "EMA 50",  minval=1, group=grpEma)
len200 = input.int(200, "EMA 200", minval=1, group=grpEma)

grpSetup = "Setup (Pullback + Volume)"
useATRProximity = input.bool(true, "Proximidad por ATR (recomendado)", group=grpSetup)
atrLen          = input.int(14, "ATR Length", minval=1, group=grpSetup)
atrMult         = input.float(0.30, "Distancia a EMA21 (ATR x)", step=0.05, group=grpSetup)
pctProximity    = input.float(0.25, "Distancia a EMA21 (%) si no usas ATR", step=0.05, group=grpSetup)

volLen          = input.int(20, "Vol SMA Length", minval=1, group=grpSetup)
volDryFactor    = input.float(0.80, "Volumen 'se seca' si Vol < SMA *", step=0.05, group=grpSetup)

grpSignals = "Señales"
bullishMode = input.string("Close>Open", "Confirmación vela alcista",
     options=["Close>Open", "Close>HighPrev"], group=grpSignals)
showLabels  = input.bool(true, "Mostrar etiquetas", group=grpSignals)
showBg      = input.bool(true, "Fondo (régimen)", group=grpSignals)

// =====================================================
// Core calculations
// =====================================================
ema9   = ta.ema(close, len9)
ema21  = ta.ema(close, len21)
ema50  = ta.ema(close, len50)
ema200 = ta.ema(close, len200)

atr = ta.atr(atrLen)
volSma = ta.sma(volume, volLen)

// =====================================================
// Regime filters (fiel a la lámina)
// =====================================================
// Long-only filter: Price above EMA200
longOnly = close > ema200

// Trend valid: EMA21 above EMA50
trendValid = ema21 > ema50

// No buys if below EMA50 (tal cual recuadro)
noBuys = close < ema50

// Market control (contexto simple): price above EMA -> buyers control, below -> sellers control
buyersControl = close > ema21
sellersControl = close < ema21

// =====================================================
// Pullback toward EMA21 (definición objetiva)
// =====================================================
distTo21 = math.abs(close - ema21)
near21_atr = distTo21 <= (atr * atrMult)
near21_pct = distTo21 <= (close * (pctProximity / 100.0))
near21 = useATRProximity ? near21_atr : near21_pct

// Volume dries up on pullback
volDriesUp = volume < (volSma * volDryFactor)

// Bullish candle near EMA21 (trigger)
bullishCandle =
     bullishMode == "Close>Open" ? (close > open) :
     (close > high[1])

// High-probability setup (la checklist inicial)
setupReady = longOnly and trendValid and not noBuys and near21 and volDriesUp

// Entry signal (buy only on bullish candle near 21 EMA)
buySignal = setupReady and bullishCandle

// =====================================================
// Plot EMAs
// =====================================================
plot(ema9,   "EMA 9",   linewidth=1)
plot(ema21,  "EMA 21",  linewidth=2)
plot(ema50,  "EMA 50",  linewidth=2)
plot(ema200, "EMA 200", linewidth=2)

// =====================================================
// Visual regime cues
// =====================================================
bgOk   = longOnly and trendValid and not noBuys
bgWarn = longOnly and (not trendValid) and not noBuys
bgBad  = (not longOnly) or noBuys

bgcolor(showBg ? (bgOk ? color.new(color.green, 88) : bgWarn ? color.new(color.orange, 88) : color.new(color.red, 88)) : na)

// =====================================================
// Labels / Markers
// =====================================================
plotshape(setupReady, title="Setup Ready", style=shape.circle, size=size.tiny, text="SET", location=location.belowbar, color=color.new(color.blue, 0))
plotshape(buySignal,  title="BUY Signal",  style=shape.labelup, size=size.small, text="BUY", location=location.belowbar, color=color.new(color.lime, 0))

if showLabels and buySignal
    label.new(bar_index, low, "V6 BUY\n(200↑ + 21>50 + Pullback 21 + Vol↓ + Bull)", style=label.style_label_up, textcolor=color.black)

// =====================================================
// Alerts
// =====================================================
alertcondition(setupReady, title="V6 Setup Ready", message="EMA System V6: Setup listo (200 filtro + 21>50 + near 21 + vol se seca).")
alertcondition(buySignal,  title="V6 BUY Signal",  message="EMA System V6: Señal BUY (setup + vela alcista cerca de EMA21).")

// =====================================================
// Optional: Tiny status table (minimal)
// =====================================================
grpUI = "UI"
showStatus = input.bool(true, "Mostrar estado (esquina)", group=grpUI)
var table t = table.new(position.top_right, 1, 5)

if showStatus and barstate.islast
    table.cell(t, 0, 0, longOnly ? "Long-only: ON" : "Long-only: OFF", text_color=color.white, bgcolor=longOnly ? color.new(color.green, 0) : color.new(color.red, 0))
    table.cell(t, 0, 1, trendValid ? "Trend valid: 21>50" : "Trend: NO (21<=50)", text_color=color.white, bgcolor=trendValid ? color.new(color.green, 0) : color.new(color.orange, 0))
    table.cell(t, 0, 2, near21 ? "Pullback: near 21" : "Pullback: lejos", text_color=color.white, bgcolor=near21 ? color.new(color.blue, 0) : color.new(color.gray, 40))
    table.cell(t, 0, 3, volDriesUp ? "Volume: dries up" : "Volume: no", text_color=color.white, bgcolor=volDriesUp ? color.new(color.blue, 0) : color.new(color.gray, 40))
    table.cell(t, 0, 4, noBuys ? "NO BUYS (below 50)" : "Buys OK (above 50)", text_color=color.white, bgcolor=noBuys ? color.new(color.red, 0) : color.new(color.green, 0))
