//@version=6
//Author FWO !
strategy('Long Short MA %Band Breakout with Fixed Stop + Mode', overlay = true, initial_capital = 10000, currency = currency.EUR, pyramiding = 1, commission_type = strategy.commission.percent, commission_value = 0.1, slippage = 1, default_qty_type = strategy.percent_of_equity, default_qty_value = 100)

// -----------------------------
// Inputs
// -----------------------------
startCapital = input.float(10000, 'Starting Capital')
commissionInp = input.float(0.1, 'Commission (%)')
slippageInp = input.int(1, 'Slippage (Ticks)')

mode = input.string(defval = 'Long Only', title = 'Trading Mode', options = ['Long Only', 'Short Only', 'Long & Short'])

ma_type = input.string(defval = 'EMA', title = 'Moving Average Type', options = ['EMA', 'TEMA', 'SMA', 'ALMA', 'HMA'])
maLen = input.int(200, 'MA Length', minval = 1)

bandUpPerc = input.float(3.0, 'Upper Band %', step = 0.1)
bandDownPerc = input.float(2.0, 'Lower Band %', step = 0.1)

startDate = input.time(timestamp('2018-01-01'), 'Start Date')
endDate = input.time(timestamp('2030-01-01'), 'End Date')
// Fixed Stop-Loss (in %)
stopLossPerc = input.float(2.0, 'Fixed Stop-Loss (%)', step = 0.1)

// -----------------------------
// MA Functions
// -----------------------------
tema(src, length) =>
    ema1 = ta.ema(src, length)
    ema2 = ta.ema(ema1, length)
    ema3 = ta.ema(ema2, length)
    3 * (ema1 - ema2) + ema3

alma(src, length, offset, sigma) =>
    m = offset * (length - 1)
    s = length / sigma
    sum = 0.0
    norm = 0.0
    for i = 0 to length - 1 by 1
        w = math.exp(-1 * math.pow(i - m, 2) / (2 * math.pow(s, 2)))
        sum := sum + src[i] * w
        norm := norm + w
        norm
    sum / norm

hma(src, length) =>
    wma1 = ta.wma(src, length / 2)
    wma2 = ta.wma(src, length)
    diff = 2 * wma1 - wma2
    ta.wma(diff, math.round(math.sqrt(length)))

// -----------------------------
// MA Selection
// -----------------------------
ma = switch ma_type
    'EMA' => ta.ema(close, maLen)
    'TEMA' => tema(close, maLen)
    'SMA' => ta.sma(close, maLen)
    'ALMA' => alma(close, maLen, 0.85, 6)
    'HMA' => hma(close, maLen)

// -----------------------------
// Bands
// -----------------------------
upperBand = ma * (1 + bandUpPerc / 100)
lowerBand = ma * (1 - bandDownPerc / 100)

// -----------------------------
// Date Filter
// -----------------------------
inDateRange = time >= startDate

// -----------------------------
// Entry/Exit Conditions
// -----------------------------
// Long Rules
longEntry = close > upperBand
longExit = close < lowerBand

// Short Rules (Mirrored)
shortEntry = close < lowerBand
shortExit = close > upperBand

// -----------------------------
// Long Logic
// -----------------------------
if inDateRange and (mode == 'Long Only' or mode == 'Long & Short')
    // Long Entry
    if longEntry and strategy.position_size == 0
        strategy.entry('Long', strategy.long)
        // Fixed stop only at entry
        longStopPrice = close * (1 - stopLossPerc / 100)
        strategy.exit('Exit Long', 'Long', stop = longStopPrice)

    // Exit Long on band breach
    if longExit and strategy.position_size > 0 and strategy.position_avg_price > 0
        strategy.close('Long')

// -----------------------------
// Short Logic
// -----------------------------
if inDateRange and (mode == 'Short Only' or mode == 'Long & Short')
    // Short Entry
    if shortEntry and strategy.position_size == 0
        strategy.entry('Short', strategy.short)
        // Fixed stop for short (above entry price)
        shortStopPrice = close * (1 + stopLossPerc / 100)
        strategy.exit('Exit Short', 'Short', stop = shortStopPrice)

    // Exit Short on band breach
    if shortExit and strategy.position_size < 0
        strategy.close('Short')

// -----------------------------
// Plots: MA & Bands
// -----------------------------
plot(ma, 'MA', color = color.orange, linewidth = 2)
plot(upperBand, 'Upper Band', color = color.new(color.green, 0))
plot(lowerBand, 'Lower Band', color = color.new(color.red, 0))

// -----------------------------
// Equity Curve Plot
// -----------------------------
// Uses the strategy equity (including open PnL)
equity = strategy.equity
plot(equity, 'Equity Curve', color = color.new(color.aqua, 0))
