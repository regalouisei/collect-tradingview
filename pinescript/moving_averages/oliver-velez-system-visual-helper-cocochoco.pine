//@version=6
indicator("Oliver Velez System Visual Helper [CocoChoco]", overlay=true, precision=2, scale=scale.right)

// --- Inputs ---
threshold      = input.float(0.5, "Narrow State Threshold %", minval=0.01, step=0.05, tooltip="Distance between 20 & 200 SMA")
slope_limit    = input.float(0.05, "Max Slope (Parallelism)", minval=0.01, step=0.01, tooltip="Lower value means more horizontal/parallel")
slope_lookback = input.int(3, "Slope Lookback Bars", minval=1, tooltip="Bars to calculate the angle/slope")

// Timeframe Selection (Only 1 Higher TF)
tf_mid  = input.timeframe("15", "Higher Timeframe (Narrow + Order)")

// Colors & Styles
line_20_col        = input.color(color.blue, "20 SMA Color")
line_20_width      = input.int(2, "20 SMA Thickness", minval=1)
line_200_col       = input.color(color.green, "200 SMA Color")
line_200_width     = input.int(2, "200 SMA Thickness", minval=1)
bull_cloud_col     = input.color(color.new(color.green, 85), "Bullish Cloud Color")
bear_cloud_col     = input.color(color.new(color.red, 85), "Bearish Cloud Color")
entry_bar_col      = input.color(color.aqua, "Entry Bar Highlight Color")
text_col           = input.color(color.white, "Label Text Color")

// --- Logic Function ---
get_state_logic() =>
    s20  = ta.sma(close, 20)
    s200 = ta.sma(close, 200)
    diff = math.abs(s20 - s200) / s200 * 100
    is_narrow_dist = diff <= threshold
    s20_slope  = math.abs(s20 - s20[slope_lookback]) / s20[slope_lookback] * 100
    s200_slope = math.abs(s200 - s200[slope_lookback]) / s200[slope_lookback] * 100
    is_horizontal = s20_slope <= slope_limit and s200_slope <= slope_limit
    is_narrow = is_narrow_dist and is_horizontal
    is_bull   = s20 > s200
    is_bear   = s20 < s200
    [s20, s200, is_narrow, is_bull, is_bear]

// --- Data Fetching ---
[curr_20, curr_200, curr_narrow, curr_bull, curr_bear] = get_state_logic()
[mid_narrow, mid_bull, mid_bear] = request.security(syminfo.tickerid, tf_mid, [curr_narrow, curr_bull, curr_bear], lookahead=barmerge.lookahead_off)

// --- Confluence Logic ---
bull_confluence = curr_narrow and mid_narrow and curr_bull and mid_bull
bear_confluence = curr_narrow and mid_narrow and curr_bear and mid_bear

// Memory: last 3 bars for breakout entries
was_bull_narrow = ta.barssince(bull_confluence) <= 3
was_bear_narrow = ta.barssince(bear_confluence) <= 3

// --- Velez Entry Patterns ---
body_size   = math.abs(open - close)
total_range = high - low
avg_body    = ta.sma(body_size, 10) 
is_solid    = body_size >= total_range * 0.75

// 1. Elephant Bar (Relative to Bodies)
is_eb = body_size > (avg_body * 1.5) and is_solid

// 2. Tail Bars (TB) - Rejection wick must be > 60% of total range
is_bt = low < math.min(open, close) - (total_range * 0.60) and close > open
is_tt = high > math.max(open, close) + (total_range * 0.60) and close < open

// 3. 180s (Engulfing) - Current body must fully engulf previous body
is_b180    = close[1] < open[1] and close > open and open <= close[1] and close >= open[1]
is_bear180 = close[1] > open[1] and close < open and open >= close[1] and close <= open[1]

// --- Entry Logic Filters ---
bull_entry = was_bull_narrow and (is_eb or is_bt or is_b180) and close > curr_20 and curr_20 > curr_200 and close > open
bear_entry = was_bear_narrow and (is_eb or is_tt or is_bear180) and close < curr_20 and curr_20 < curr_200 and close < open

// --- Visuals ---
p1 = plot(curr_20,  color=line_20_col,  linewidth=line_20_width,  title="20 SMA")
p2 = plot(curr_200, color=line_200_col, linewidth=line_200_width, title="200 SMA")

fill(p1, p2, color = bull_confluence ? bull_cloud_col : bear_confluence ? bear_cloud_col : na, title="Narrow State Cloud")
barcolor(bull_entry or bear_entry ? entry_bar_col : na, title="Velez Entry Bar Highlight")

// Labels
plotshape(bull_entry and is_eb,      text="EB",  style=shape.labelup,   location=location.belowbar, color=entry_bar_col, textcolor=text_col, size=size.tiny, title="Bull EB Label")
plotshape(bull_entry and is_bt,      text="TB",  style=shape.labelup,   location=location.belowbar, color=entry_bar_col, textcolor=text_col, size=size.tiny, title="Bull TB Label")
plotshape(bull_entry and is_b180,    text="180", style=shape.labelup,   location=location.belowbar, color=entry_bar_col, textcolor=text_col, size=size.tiny, title="Bull 180 Label")

plotshape(bear_entry and is_eb,      text="EB",  style=shape.labeldown, location=location.abovebar, color=entry_bar_col, textcolor=text_col, size=size.tiny, title="Bear EB Label")
plotshape(bear_entry and is_tt,      text="TB",  style=shape.labeldown, location=location.abovebar, color=entry_bar_col, textcolor=text_col, size=size.tiny, title="Bear TB Label")
plotshape(bear_entry and is_bear180, text="180", style=shape.labeldown, location=location.abovebar, color=entry_bar_col, textcolor=text_col, size=size.tiny, title="Bear 180 Label")

// --- Alert System ---
alert_narrow_start = (bull_confluence and not bull_confluence) or (bear_confluence and not bear_confluence)
alert_entry_candle = (bull_entry or bear_entry)

alertcondition(alert_narrow_start, title="Narrow State Start", message="A narrow state alignment has just begun [CocoChoco].")
alertcondition(alert_entry_candle, title="Entry Candle", message="A Velez entry candle has formed in a narrow state [CocoChoco].")
