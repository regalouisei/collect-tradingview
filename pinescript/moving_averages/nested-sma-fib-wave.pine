//@version=6
indicator("Nested SMA Fib Wave", overlay = true, max_bars_back=500)

// ── INPUTS ───────────────────────────────────────────────────────────────
base_length = input.int(1, "Base Length (Fib multiplier)", minval = 1, group="Main Settings")

fib_start_str = input.string("8", "Starting Fib Number (for MA1)", 
     options = ["1","2","3","5","8","13","21","34","55","89","144","233","377"], 
     group="Main Settings",
     tooltip = "Fibonacci multiplier for the first SMA. Each next SMA uses the following number in the Fibonacci sequence.")

// ── Bar Coloring Settings (unchanged) ───────────────────────────────────
group_color = "Bar Coloring"

barcolor_mode = input.string("None", "Bar Coloring Mode",
     options = ["None", "Gradient vs selected MA", "Above/Below selected MA", "Trend + Strength"],
     group = group_color)

color_center_ma = input.string("MA4", "Center coloring on which MA?",
     options = ["MA1","MA2","MA3","MA4","MA5","MA6","MA7","MA8"],
     group = group_color)

barcolor_strength = input.int(6, "Color intensity cap (× deviation)", minval=2, maxval=20, group=group_color)

bull_start = input.color(color.gray,  "Bull start (close to MA)", group=group_color)
bull_end   = input.color(color.lime,  "Bull end (far above MA)",   group=group_color)
bear_start = input.color(color.gray,  "Bear start (close to MA)", group=group_color)
bear_end   = input.color(color.red,   "Bear end (far below MA)",   group=group_color)

// ── ZONE SHADING OPTIONS (unchanged) ─────────────────────────────────────
group_shade = "Zone Shading Between SMAs"

shade1 = input.bool(true, "Shade 1-2", group = group_shade)
shade2 = input.bool(true, "Shade 2-3", group = group_shade)
shade3 = input.bool(true, "Shade 3-4", group = group_shade)
shade4 = input.bool(true, "Shade 4-5", group = group_shade)
shade5 = input.bool(true, "Shade 5-6", group = group_shade)
shade6 = input.bool(true, "Shade 6-7", group = group_shade)
shade7 = input.bool(true, "Shade 7-8", group = group_shade)

trans1 = input.int(92, "1-2 Transparency", minval=0, maxval=100, group = group_shade)
trans2 = input.int(88, "2-3 Transparency", minval=0, maxval=100, group = group_shade)
trans3 = input.int(84, "3-4 Transparency", minval=0, maxval=100, group = group_shade)
trans4 = input.int(80, "4-5 Transparency", minval=0, maxval=100, group = group_shade)
trans5 = input.int(76, "5-6 Transparency", minval=0, maxval=100, group = group_shade)
trans6 = input.int(72, "6-7 Transparency", minval=0, maxval=100, group = group_shade)
trans7 = input.int(68, "7-8 Transparency", minval=0, maxval=100, group = group_shade)

// ── FIBONACCI MULTIPLIERS ───────────────────────────────────────────────
// Full Fibonacci sequence (enough for any starting point in the dropdown + 7 more)
var array<float> fib_seq = array.from(
     1.0, 2.0, 3.0, 5.0, 8.0, 13.0, 21.0, 34.0, 
     55.0, 89.0, 144.0, 233.0, 377.0, 610.0, 987.0, 
     1597.0, 2584.0, 4181.0, 6765.0, 10946.0, 17711.0)

// Find starting index and get 8 consecutive Fib multipliers
float start_fib = str.tonumber(fib_start_str)
int   start_idx = array.indexof(fib_seq, start_fib)

// Safety fallback (should never trigger with the dropdown options)
if start_idx == -1 or start_idx + 7 >= array.size(fib_seq)
    start_idx := 4  // default = 8 (index 4 in the array)

// Extract multipliers
float mult1 = array.get(fib_seq, start_idx)
float mult2 = array.get(fib_seq, start_idx + 1)
float mult3 = array.get(fib_seq, start_idx + 2)
float mult4 = array.get(fib_seq, start_idx + 3)
float mult5 = array.get(fib_seq, start_idx + 4)
float mult6 = array.get(fib_seq, start_idx + 5)
float mult7 = array.get(fib_seq, start_idx + 6)
float mult8 = array.get(fib_seq, start_idx + 7)

// Convert to integer lengths (exact because Fib numbers are integers)
int length1 = int(math.round(base_length * mult1))
int length2 = int(math.round(base_length * mult2))
int length3 = int(math.round(base_length * mult3))
int length4 = int(math.round(base_length * mult4))
int length5 = int(math.round(base_length * mult5))
int length6 = int(math.round(base_length * mult6))
int length7 = int(math.round(base_length * mult7))
int length8 = int(math.round(base_length * mult8))

// ── CENTER SMAs ──────────────────────────────────────────────────────────
ma1 = ta.sma(close, length1)
ma2 = ta.sma(close, length2)
ma3 = ta.sma(close, length3)
ma4 = ta.sma(close, length4)
ma5 = ta.sma(close, length5)
ma6 = ta.sma(close, length6)
ma7 = ta.sma(close, length7)
ma8 = ta.sma(close, length8)

// ── Select reference MA for bar coloring (unchanged) ─────────────────────
ma_ref = switch color_center_ma
    "MA1" => ma1
    "MA2" => ma2
    "MA3" => ma3
    "MA4" => ma4
    "MA5" => ma5
    "MA6" => ma6
    "MA7" => ma7
    "MA8" => ma8
    => ma4

// ── Deviation & Bar Coloring Logic (unchanged) ───────────────────────────
deviation  = ta.atr(14)

var color bc = na

if barcolor_mode != "None"
    float dist     = (close - ma_ref) / deviation
    float strength = math.min(math.abs(dist), barcolor_strength) / barcolor_strength

    if barcolor_mode == "Gradient vs selected MA"
        bc := close <= ma_ref ?
             color.from_gradient(strength, 0, 1, bull_start, bull_end) :
             color.from_gradient(strength, 0, 1, bear_start, bear_end)

    else if barcolor_mode == "Above/Below selected MA"
        bc := close <  ma_ref ? color.lime :
              close >  ma_ref ? color.red  : na

    else if barcolor_mode == "Trend + Strength"
        bc := close <= ma_ref ?
             color.from_gradient(strength, 0, 1, color.new(color.green, 70), color.green) :
             color.from_gradient(strength, 0, 1, color.new(color.red,   70), color.red)

barcolor(bc)

// ── PLOT THE WAVE (unchanged colors/line widths) ─────────────────────────
p1 = plot(ma1, color = color.new(#90bff9, 0), linewidth = 1, title="MA1")
p2 = plot(ma2, color = color.new(#ff9800, 0), linewidth = 1, title="MA2")
p3 = plot(ma3, color = color.new(#fbff00, 0), linewidth = 1, title="MA3")
p4 = plot(ma4, color = color.new(#6bf806, 0), linewidth = 1, title="MA4")
p5 = plot(ma5, color = color.new(#3179f5, 0), linewidth = 1, title="MA5")
p6 = plot(ma6, color = color.new(#7e57c2, 0), linewidth = 1, title="MA6")
p7 = plot(ma7, color = color.new(#ff0022, 0), linewidth = 1, title="MA7")
p8 = plot(ma8, color = color.new(#ffffff, 0), linewidth = 1, title="MA8")

// ── ZONE SHADING (unchanged) ─────────────────────────────────────────────
fill(p1, p2, color = shade1 ? color.new(#90bff9, trans1) : na)
fill(p2, p3, color = shade2 ? color.new(#ff9800, trans2) : na)
fill(p3, p4, color = shade3 ? color.new(#fbff00, trans3) : na)
fill(p4, p5, color = shade4 ? color.new(#6bf806, trans4) : na)
fill(p5, p6, color = shade5 ? color.new(#3179f5, trans5) : na)
fill(p6, p7, color = shade6 ? color.new(#7e57c2, trans6) : na)
fill(p7, p8, color = shade7 ? color.new(#ff0022, trans7) : na)
