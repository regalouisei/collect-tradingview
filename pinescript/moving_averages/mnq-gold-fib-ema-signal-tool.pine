//@version=6
indicator("MNQ & Gold: Fib + EMA Signal Tool", overlay=true)

// --- INPUTS ---
lookback = input.int(20, "Fibonacci Lookback (Bars)", minval=10)
ema_len = input.int(200, "Trend Filter (EMA 200)")
show_labels = input.bool(true, "Show Buy/Sell Labels")

// --- CALCULATIONS ---
// Trend Filter
ema200 = ta.ema(close, ema_len)
plot(ema200, color=color.new(color.gray, 50), title="Trend EMA")

// Automated Fibonacci High/Low
hi = ta.highest(high, lookback)
lo = ta.lowest(low, lookback)
range_ = hi - lo

// Defining Fibonacci Levels
fib_786 = hi - (range_ * 0.786)
fib_618 = hi - (range_ * 0.618)
fib_500 = hi - (range_ * 0.500)

// --- SIGNAL LOGIC ---
// Bullish: Price is above EMA200 AND price dips into the 50%-61.8% zone (Golden Pocket)
long_signal = close > ema200 and ta.crossover(close, fib_618)

// Bearish: Price is below EMA200 AND price rallies into the 50%-61.8% zone
short_signal = close < ema200 and ta.crossunder(close, fib_618)

// --- VISUALS ---
// Plot Fibonacci Levels for visual reference
plot(fib_786, "Fib 78.6%", color=color.new(color.red, 40), style=plot.style_linebr)
plot(fib_618, "Fib 61.8%", color=color.new(color.orange, 40), style=plot.style_linebr)
plot(fib_500, "Fib 50.0%", color=color.new(color.green, 40), style=plot.style_linebr)

// Plot Signals
plotshape(series=long_signal and show_labels, title="Buy Signal", location=location.belowbar, color=color.green, style=shape.labelup, text="BUY", textcolor=color.white, size=size.small)
plotshape(series=short_signal and show_labels, title="Sell Signal", location=location.abovebar, color=color.red, style=shape.labeldown, text="SELL", textcolor=color.white, size=size.small)

// Alerts
alertcondition(long_signal, title="Bullish Fib Rejection", message="MNQ/Gold Buy Signal at 61.8% Fib")
alertcondition(short_signal, title="Bearish Fib Rejection", message="MNQ/Gold Sell Signal at 61.8% Fib")
