//@version=6
// © K@lTony – K@lTony SMA Strategy
// Original author: K@lTony
// 
// The core SMA calculation and optional smoothing/Bollinger Bands logic 
// are adapted from publicly available open-source SMA indicators 
// shared by the TradingView community. 
// Special thanks to the original authors for their contributions.
// This script significantly extends the concept with multi-range time-based 
// bias logic ("Contro SMA" / "Verso SMA"), open-price signals at range start, 
// and customizable strategies.
// Published in compliance with TradingView's Script Publishing Rules.

indicator(title="K@lTony SMA Strategy", shorttitle="KTSMAS", overlay=true, timeframe="", timeframe_gaps=true)

// === SMA Section ===
len = input.int(9, minval=1, title="Length")
src = input(close, title="Source")
offset = input.int(title="Offset", defval=0, minval=-500, maxval=500, display = display.none)
out = ta.sma(src, len)
plot(out, color=color.blue, title="MA", offset=offset)

// Smoothing MA inputs
GRP = "Smoothing"
TT_BB = "Only applies when 'SMA + Bollinger Bands' is selected. Determines the distance between the SMA and the bands."
maTypeInput = input.string("None", "Type", options = ["None", "SMA", "SMA + Bollinger Bands", "EMA", "SMMA (RMA)", "WMA", "VWMA"], group = GRP, display = display.none)
var isBB = maTypeInput == "SMA + Bollinger Bands"
maLengthInput = input.int(14, "Length", group = GRP, display = display.none, active = maTypeInput != "None")
bbMultInput = input.float(2.0, "BB StdDev", minval = 0.001, maxval = 50, step = 0.5, tooltip = TT_BB, group = GRP, display = display.none, active = isBB)
var enableMA = maTypeInput != "None"

// Smoothing MA Calculation
ma(source, length, MAtype) =>
    switch MAtype
        "SMA"                   => ta.sma(source, length)
        "SMA + Bollinger Bands" => ta.sma(source, length)
        "EMA"                   => ta.ema(source, length)
        "SMMA (RMA)"            => ta.rma(source, length)
        "WMA"                   => ta.wma(source, length)
        "VWMA"                  => ta.vwma(source, length)

// Smoothing MA plots
smoothingMA = enableMA ? ma(out, maLengthInput, maTypeInput) : na
smoothingStDev = isBB ? ta.stdev(out, maLengthInput) * bbMultInput : na
plot(smoothingMA, "SMA-based MA", color=color.yellow, display = enableMA ? display.all : display.none, editable = enableMA)
bbUpperBand = plot(smoothingMA + smoothingStDev, title = "Upper Bollinger Band", color=color.green, display = isBB ? display.all : display.none, editable = isBB)
bbLowerBand = plot(smoothingMA - smoothingStDev, title = "Lower Bollinger Band", color=color.green, display = isBB ? display.all : display.none, editable = isBB)
fill(bbUpperBand, bbLowerBand, color= isBB ? color.new(color.green, 90) : na, title="Bollinger Bands Background Fill", display = isBB ? display.all : display.none, editable = isBB)

// === Time Ranges Section ===
GRP_RANGE = "Time Ranges"
enableRange1 = input.bool(true, "Enable Range 1", group=GRP_RANGE)
range1Type = input.string("Contro SMA", "Range 1 Strategy", options=["Contro SMA", "Verso SMA"], group=GRP_RANGE)
range1Start = input.session("0900-0905", "Range 1 (HHMM-HHMM)", group=GRP_RANGE)
range1Color = input.color(color.new(color.blue, 90), "Range 1 Background Color", group=GRP_RANGE)

enableRange2 = input.bool(false, "Enable Range 2", group=GRP_RANGE)
range2Type = input.string("Contro SMA", "Range 2 Strategy", options=["Contro SMA", "Verso SMA"], group=GRP_RANGE)
range2Start = input.session("1630-1700", "Range 2 (HHMM-HHMM)", group=GRP_RANGE)
range2Color = input.color(color.new(color.orange, 90), "Range 2 Background Color", group=GRP_RANGE)

enableRange3 = input.bool(false, "Enable Range 3", group=GRP_RANGE)
range3Type = input.string("Contro SMA", "Range 3 Strategy", options=["Contro SMA", "Verso SMA"], group=GRP_RANGE)
range3Start = input.session("1805-2000", "Range 3 (HHMM-HHMM)", group=GRP_RANGE)
range3Color = input.color(color.new(color.purple, 90), "Range 3 Background Color", group=GRP_RANGE)

// Range Activity & First Bar Detection
inRange1 = not na(time(timeframe.period, range1Start))
firstInRange1 = enableRange1 and inRange1 and not inRange1[1]

inRange2 = not na(time(timeframe.period, range2Start))
firstInRange2 = enableRange2 and inRange2 and not inRange2[1]

inRange3 = not na(time(timeframe.period, range3Start))
firstInRange3 = enableRange3 and inRange3 and not inRange3[1]

// Background Colors for Ranges
bgcolor(enableRange1 and inRange1 ? range1Color : na)
bgcolor(enableRange2 and inRange2 ? range2Color : na)
bgcolor(enableRange3 and inRange3 ? range3Color : na)

// SMA Line for Comparison (uses smoothed if enabled, else primary SMA)
smaLine = enableMA ? smoothingMA : out

// Signals - triggered on the FIRST bar of the range (at its open)
buySignal  = false
sellSignal = false

if firstInRange1
    if range1Type == "Contro SMA"
        buySignal  := open > smaLine
        sellSignal := open < smaLine
    else // "Verso SMA"
        buySignal  := open < smaLine
        sellSignal := open > smaLine

if firstInRange2
    if range2Type == "Contro SMA"
        buySignal  := open > smaLine
        sellSignal := open < smaLine
    else // "Verso SMA"
        buySignal  := open < smaLine
        sellSignal := open > smaLine

if firstInRange3
    if range3Type == "Contro SMA"
        buySignal  := open > smaLine
        sellSignal := open < smaLine
    else // "Verso SMA"
        buySignal  := open < smaLine
        sellSignal := open > smaLine

// Plot Signals
plotshape(buySignal,  title="Buy Signal",  style=shape.labelup,   location=location.belowbar, color=color.new(color.green, 0), text="BUY",  textcolor=color.white, size=size.small)
plotshape(sellSignal, title="Sell Signal", style=shape.labeldown, location=location.abovebar,  color=color.new(color.red,   0), text="SELL", textcolor=color.white, size=size.small)

// Optional: alertcondition
alertcondition(buySignal,  title="KT SMA Buy",  message="K@lTony SMA Strategy - BUY at range start")
alertcondition(sellSignal, title="KT SMA Sell", message="K@lTony SMA Strategy - SELL at range start")
