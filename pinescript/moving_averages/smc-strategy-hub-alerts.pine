//@version=5
indicator("SMC Strategy Hub + Alerts", overlay=true, max_labels_count=500)

// --- 1. INPUTS ---
show_fvg  = input.bool(true, "Show Fair Value Gaps", group="Display Settings")
lookback  = input.int(20, "Structure Lookback", minval=5, group="Market Structure")
atr_mult  = input.float(2.0, "TP Multiplier (Risk:Reward)", group="Risk Management")
use_timer = input.bool(false, "Only Trade NY Session (07:30-12:00)", group="Time Filter")

// --- 2. TIME FILTER ---
is_in_time = not use_timer or (hour >= 7 and hour <= 12)

// --- 3. TREND & STRUCTURE (MSS) ---
high_h = ta.highest(high, lookback)
low_l  = ta.lowest(low, lookback)

var string trend_dir = "Neutral"
bull_mss = ta.crossover(close, high_h[1]) and is_in_time
bear_mss = ta.crossunder(close, low_l[1]) and is_in_time

if bull_mss
    trend_dir := "BULLISH"
else if bear_mss
    trend_dir := "BEARISH"

// --- 4. FAIR VALUE GAPS (FVG) ---
is_bull_fvg = low > high[2] and close[1] > high[2]
is_bear_fvg = high < low[2] and close[1] < low[2]

if show_fvg
    if is_bull_fvg
        box.new(bar_index[2], low, bar_index, high[2], bgcolor=color.new(color.green, 85), border_color=na)
    if is_bear_fvg
        box.new(bar_index[2], high, bar_index, low[2], bgcolor=color.new(color.red, 85), border_color=na)

// --- 5. SIGNALS & RISK MANAGEMENT ---
atr = ta.atr(14)
var float sl_price = na
var float tp_price = na
string current_sig = "Wait"

if bull_mss
    current_sig := "BUY"
    sl_price := low - (atr * 1.5)
    tp_price := close + (atr * atr_mult)
    label.new(bar_index, low, "BUY\nSL: " + str.tostring(sl_price, "0.00") + "\nTP: " + str.tostring(tp_price, "0.00"), color=color.green, style=label.style_label_up, textcolor=color.white)
    alert("SMC Buy Signal: Trend is Bullish. TP: " + str.tostring(tp_price, "0.00"), alert.freq_once_per_bar_close)

if bear_mss
    current_sig := "SELL"
    sl_price := high + (atr * 1.5)
    tp_price := close - (atr * atr_mult)
    label.new(bar_index, high, "SELL\nSL: " + str.tostring(sl_price, "0.00") + "\nTP: " + str.tostring(tp_price, "0.00"), color=color.red, style=label.style_label_down, textcolor=color.white)
    alert("SMC Sell Signal: Trend is Bearish. TP: " + str.tostring(tp_price, "0.00"), alert.freq_once_per_bar_close)

// --- 6. DASHBOARD ---
var table board = table.new(position.top_right, 2, 3, border_width=1, frame_color=color.gray)
if barstate.islast
    table.cell(board, 0, 0, "TREND", bgcolor=color.gray, text_color=color.white)
    table.cell(board, 1, 0, trend_dir, bgcolor=trend_dir == "BULLISH" ? color.green : color.red, text_color=color.white)
    table.cell(board, 0, 1, "SIGNAL", bgcolor=color.gray, text_color=color.white)
    table.cell(board, 1, 1, current_sig, bgcolor=color.black, text_color=color.white)
    table.cell(board, 0, 2, "TARGET TP", bgcolor=color.gray, text_color=color.white)
    table.cell(board, 1, 2, str.tostring(tp_price, "0.00"), bgcolor=color.black, text_color=color.white)

// Visual plots
plotshape(bull_mss, "MSS Bull", shape.triangleup, location.belowbar, color.green, size=size.small)
plotshape(bear_mss, "MSS Bear", shape.triangledown, location.abovebar, color.red, size=size.small)
