//@version=5
indicator("EMA 20/50/200 Cross + Bounce (High Volume)", overlay=true, max_labels_count=500)

// ───────────────────────── Inputs ─────────────────────────
len20  = input.int(20,  "EMA Fast Length",  minval=1)
len50  = input.int(50,  "EMA Mid Length",   minval=1)
len200 = input.int(200, "EMA Slow Length",  minval=1)

// Volume filter
volLookback   = input.int(10, "Volume SMA Lookback", minval=1)
volMultiplier = input.float(2.0, "High Volume Multiplier", minval=0.1, step=0.1)
useHighestFilter = input.bool(false, "Also require volume > Highest(volume, lookback)?")

// Bounce settings
touchBufferPct = input.float(0.0, "Bounce Touch Buffer % (0 = exact touch)", minval=0.0, step=0.05)
showBounce50   = input.bool(true,  "Show bounce signals on EMA 50")
showBounce200  = input.bool(true,  "Show bounce signals on EMA 200")

// ───────────────────────── Calculations ─────────────────────────
ema20  = ta.ema(close, len20)
ema50  = ta.ema(close, len50)
ema200 = ta.ema(close, len200)

volSMA = ta.sma(volume, volLookback)

// High volume logic (same as before)
highVolBySMA     = volume > volSMA * volMultiplier
highVolByHighest = volume > ta.highest(volume[1], volLookback)
highVol = useHighestFilter ? (highVolBySMA and highVolByHighest) : highVolBySMA

// ───────────────────────── Cross Signals ─────────────────────────
bullCross = ta.crossover(ema20, ema200) or ta.crossover(ema50, ema200)
bearCross = ta.crossunder(ema20, ema200) or ta.crossunder(ema50, ema200)

bullCrossSignal = bullCross and highVol
bearCrossSignal = bearCross and highVol

// ───────────────────────── Bounce Logic ─────────────────────────
// Buffer converts % into price distance
buf50  = ema50  * (touchBufferPct / 100.0)
buf200 = ema200 * (touchBufferPct / 100.0)

// Touch definitions with buffer
touch50  = (low <= ema50 + buf50)  and (high >= ema50 - buf50)
touch200 = (low <= ema200 + buf200) and (high >= ema200 - buf200)

// Bull bounce: touch/pierce then close back above
bullBounce50  = showBounce50  and touch50  and close > ema50
bearBounce50  = showBounce50  and touch50  and close < ema50

bullBounce200 = showBounce200 and touch200 and close > ema200
bearBounce200 = showBounce200 and touch200 and close < ema200

// Apply volume filter
bullBounce50Signal  = bullBounce50  and highVol
bearBounce50Signal  = bearBounce50  and highVol
bullBounce200Signal = bullBounce200 and highVol
bearBounce200Signal = bearBounce200 and highVol

// ───────────────────────── Plots ─────────────────────────
plot(ema20,  title="EMA 20",  linewidth=2)
plot(ema50,  title="EMA 50",  linewidth=2)
plot(ema200, title="EMA 200", linewidth=3)

// Cross markers
plotshape(bullCrossSignal, title="Bull Cross Signal", style=shape.labelup,   text="HV Cross ↑", location=location.belowbar, size=size.small)
plotshape(bearCrossSignal, title="Bear Cross Signal", style=shape.labeldown, text="HV Cross ↓", location=location.abovebar, size=size.small)

// Bounce markers (50)
plotshape(bullBounce50Signal, title="Bull Bounce 50", style=shape.triangleup,   text="B50", location=location.belowbar, size=size.tiny)
plotshape(bearBounce50Signal, title="Bear Bounce 50", style=shape.triangledown, text="B50", location=location.abovebar, size=size.tiny)

// Bounce markers (200)
plotshape(bullBounce200Signal, title="Bull Bounce 200", style=shape.triangleup,   text="B200", location=location.belowbar, size=size.tiny)
plotshape(bearBounce200Signal, title="Bear Bounce 200", style=shape.triangledown, text="B200", location=location.abovebar, size=size.tiny)

// ───────────────────────── Alerts ─────────────────────────
alertcondition(bullCrossSignal, title="Bullish HV EMA Cross", message="EMA20/EMA50 crossed ABOVE EMA200 with high volume.")
alertcondition(bearCrossSignal, title="Bearish HV EMA Cross", message="EMA20/EMA50 crossed BELOW EMA200 with high volume.")

alertcondition(bullBounce50Signal,  title="Bullish HV Bounce EMA50",  message="Price bounced ABOVE EMA50 with high volume.")
alertcondition(bearBounce50Signal,  title="Bearish HV Bounce EMA50",  message="Price bounced BELOW EMA50 with high volume.")
alertcondition(bullBounce200Signal, title="Bullish HV Bounce EMA200", message="Price bounced ABOVE EMA200 with high volume.")
alertcondition(bearBounce200Signal, title="Bearish HV Bounce EMA200", message="Price bounced BELOW EMA200 with high volume.")
