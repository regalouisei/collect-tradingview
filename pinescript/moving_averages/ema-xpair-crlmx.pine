// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 | https://mozilla.org/MPL/2.0/
// [     crlmx.EMA xPair v1.21     ]
// [        ••• © crlmx •••        ]
//
//@version=6
indicator(title = 'EMA xPair [crlmx]', shorttitle = 'EMA xPair [crlmx]', overlay = true)

// ══════════════════════════════════════════════════════════════════════════════
// INPUTS
// ══════════════════════════════════════════════════════════════════════════════

// General
refTf = input.string("Day", "Timeframe", group = "General",
     options = ["Chart", "1min", "2min", "3min", "5min", "10min", "15min", "30min", "1H", "2H", "4H", "8H", "12H", "Day", "Week", "Month"],
     tooltip = "Timeframe the EMA lengths are defined against. Lengths are automatically scaled to match this period at any chart timeframe.")
src   = input.source(close, "Source", group = "General")

// EMAs
showEma1  = input.bool(true,    'EMA (1)', inline = 'ema1')
len1      = input.int(8,        '',         inline = 'ema1', minval = 1,
     tooltip = 'EMA period in Timeframe units. Automatically scaled to the chart timeframe.')
ema1Color = input.color(#407174, '',         inline = 'ema1')

showEma2  = input.bool(true,    'EMA (2)', inline = 'ema2')
len2      = input.int(24,       '',         inline = 'ema2', minval = 1,
     tooltip = 'EMA period in Timeframe units. Automatically scaled to the chart timeframe.')
ema2Color = input.color(#70537a, '',         inline = 'ema2')

// Gradient Fill
showFill   = input.bool(true, 'Transparency', inline = 'fill', group = 'Gradient Fill')
fillTransp = input.int(90,    '',              inline = 'fill', group = 'Gradient Fill', minval = 0, maxval = 100,
     tooltip = '0 = fully opaque, 100 = invisible. Gradient fades from the upper EMA line to transparent at the lower EMA line.')

// Midline
showMid  = input.bool(false,    'Show',  inline = 'mid', group = 'Midline')
midColor = input.color(#4a4a4a, '',      inline = 'mid', group = 'Midline')
midWidth = input.int(1,         'Width', inline = 'mid', group = 'Midline', minval = 1, maxval = 5)

// ══════════════════════════════════════════════════════════════════════════════
// FUNCTIONS
// ══════════════════════════════════════════════════════════════════════════════

refTfSecs(tf) =>
    switch tf
        "Chart" => timeframe.in_seconds()
        "1min"  => timeframe.in_seconds("1")
        "2min"  => timeframe.in_seconds("2")
        "3min"  => timeframe.in_seconds("3")
        "5min"  => timeframe.in_seconds("5")
        "10min" => timeframe.in_seconds("10")
        "15min" => timeframe.in_seconds("15")
        "30min" => timeframe.in_seconds("30")
        "1H"    => timeframe.in_seconds("60")
        "2H"    => timeframe.in_seconds("120")
        "4H"    => timeframe.in_seconds("240")
        "8H"    => timeframe.in_seconds("480")
        "12H"   => timeframe.in_seconds("720")
        "Day"   => timeframe.in_seconds("D")
        "Week"  => timeframe.in_seconds("W")
        "Month" => timeframe.in_seconds("M")
        => timeframe.in_seconds("D")

// ══════════════════════════════════════════════════════════════════════════════
// CALCULATIONS
// ══════════════════════════════════════════════════════════════════════════════

// Scale EMA lengths from the reference timeframe to the native chart timeframe.
// barsPerRef = how many chart bars fit in one reference TF period.
// On a chart matching the reference TF this equals 1, so lengths are used as-is.
// On shorter timeframes the length scales up so the EMA decay rate matches the
// reference period while updating every bar — enabling smooth lines and gradient fill.
// Note: Month uses a fixed 30-day approximation via timeframe.in_seconds("M").
// On instruments with defined sessions (e.g. stocks) values will be slightly smoother
// than the true reference-TF EMA but track the same trend.
barsPerRef = math.max(1, refTfSecs(refTf) / timeframe.in_seconds())
eqLen1     = math.max(2, math.round(len1 * barsPerRef))
eqLen2     = math.max(2, math.round(len2 * barsPerRef))

ema1 = ta.ema(src, eqLen1)
ema2 = ta.ema(src, eqLen2)
mid  = (ema1 + ema2) / 2

// Gradient fill: fades from the upper EMA's colour (at the upper EMA line)
// to fully transparent (at the lower EMA line).
effectiveFillTransp = showFill ? fillTransp : 100
upperVal   = ema1 >= ema2 ? ema1 : ema2
lowerVal   = ema1 >= ema2 ? ema2 : ema1
upperColor = ema1 >= ema2 ? color.new(ema1Color, effectiveFillTransp) : color.new(ema2Color, effectiveFillTransp)
lowerColor = ema1 >= ema2 ? color.new(ema1Color, 100)                 : color.new(ema2Color, 100)

// ══════════════════════════════════════════════════════════════════════════════
// PLOTTING
// ══════════════════════════════════════════════════════════════════════════════

ema1Plot = plot(showEma1 ? ema1 : na, title = 'EMA (1)', color = ema1Color)
ema2Plot = plot(showEma2 ? ema2 : na, title = 'EMA (2)', color = ema2Color)

fill(ema1Plot, ema2Plot,
     top_value    = upperVal,   top_color    = upperColor,
     bottom_value = lowerVal,   bottom_color = lowerColor,
     title = 'Gradient Fill')

plot(showMid ? mid : na, title = 'Midline', color = midColor, linewidth = midWidth)
