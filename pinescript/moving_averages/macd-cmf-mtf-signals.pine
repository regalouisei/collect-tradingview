// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Fenris74
//V0.3


//@version=6
indicator(
     title      = "MACD + CMF MTF Signals",
     shorttitle = "MACD+CMF",
     overlay    = false,
     max_lines_count = 500,
     max_labels_count = 500
)

//──────────────────────
// Inputs
//──────────────────────
group_macd = "MACD Settings"
fastLen   = input.int(12,  "Fast Length",   minval=1, group=group_macd)
slowLen   = input.int(26,  "Slow Length",   minval=1, group=group_macd)
sigLen    = input.int(9,   "Signal Length", minval=1, group=group_macd)
tfMACD    = input.timeframe("", "MACD Timeframe (empty = chart)", group=group_macd)

group_cmf = "CMF Settings"
cmfLen    = input.int(21,  "CMF Length",    minval=1, group=group_cmf)
tfCMF     = input.timeframe("", "CMF Timeframe (empty = chart)", group=group_cmf)

group_vis = "Visual Settings"
showHist  = input.bool(true,  "Show MACD Histogram",         group=group_vis)
showCMF   = input.bool(true,  "Show CMF Line (auto-scaled)", group=group_vis)
showMarks = input.bool(true,  "Show Buy/Sell Markers",       group=group_vis)

//──────────────────────
// MACD (MTF)
//──────────────────────
macdTf        = tfMACD == "" ? timeframe.period : tfMACD
srcClose_macd = request.security(syminfo.tickerid, macdTf, close)

fastMA = ta.ema(srcClose_macd, fastLen)
slowMA = ta.ema(srcClose_macd, slowLen)
macd   = fastMA - slowMA
signal = ta.ema(macd, sigLen)
hist   = macd - signal

//──────────────────────
// CMF (MTF)
//──────────────────────
cmfTf = tfCMF == "" ? timeframe.period : tfCMF

h_htf = request.security(syminfo.tickerid, cmfTf, high)
l_htf = request.security(syminfo.tickerid, cmfTf, low)
c_htf = request.security(syminfo.tickerid, cmfTf, close)
v_htf = request.security(syminfo.tickerid, cmfTf, volume)

priceRange = h_htf - l_htf
mfm        = priceRange == 0.0 ? 0.0 : ((c_htf - l_htf) - (h_htf - c_htf)) / priceRange
mfv        = mfm * v_htf

cmf_num = ta.sma(mfv,   cmfLen)
cmf_den = ta.sma(v_htf, cmfLen)
cmf_raw = cmf_den == 0.0 ? 0.0 : cmf_num / cmf_den

//──────────────────────
// Auto-Scaling für CMF
//──────────────────────
macdHigh  = ta.highest(macd, 200)
macdLow   = ta.lowest(macd, 200)
macdRange = math.max(math.abs(macdHigh), math.abs(macdLow))

cmfHigh   = ta.highest(cmf_raw, 200)
cmfLow    = ta.lowest(cmf_raw, 200)
cmfRange  = math.max(math.abs(cmfHigh), math.abs(cmfLow))

cmfRangeSafe = cmfRange == 0.0 ? 0.0001 : cmfRange
autoScale    = macdRange / cmfRangeSafe
cmf_scaled   = cmf_raw * autoScale

//──────────────────────
// Buy/Sell Logic
//──────────────────────
bullCross = ta.crossover(macd, signal)
bearCross = ta.crossunder(macd, signal)

buyCond  = bullCross and cmf_raw > 0
sellCond = bearCross and cmf_raw < 0

//──────────────────────
// MACD Panel
//──────────────────────
plot(macd,   "MACD",   color=color.teal,   linewidth=2)
plot(signal, "Signal", color=color.orange, linewidth=2)

// Histogramm mit Grau-Logik
histColor =
     hist >= 0 and hist > hist[1] ? color.new(color.green, 0) :
     hist >= 0 and hist < hist[1] ? color.new(color.gray, 20) :
     hist < 0  and hist > hist[1] ? color.new(color.red,   0) :
     color.new(color.gray, 20)

plot(
     showHist ? hist : na,
     "Histogram",
     style = plot.style_columns,
     color = histColor
)

// CMF sichtbar (auto-scaled)
plot(
     showCMF ? cmf_scaled : na,
     "CMF (auto-scaled)",
     color=color.purple,
     linewidth=2
)

//──────────────────────
// Buy/Sell Markers
//──────────────────────
plotshape(showMarks and buyCond,  title="Buy",  style=shape.triangleup,   location=location.bottom, color=color.lime, size=size.tiny)
plotshape(showMarks and sellCond, title="Sell", style=shape.triangledown, location=location.top,    color=color.red,  size=size.tiny)

//──────────────────────
// Alerts
//──────────────────────
alertcondition(buyCond,  title="Buy Signal",  message="MACD+CMF MTF Buy Signal")
alertcondition(sellCond, title="Sell Signal", message="MACD+CMF MTF Sell Signal")
