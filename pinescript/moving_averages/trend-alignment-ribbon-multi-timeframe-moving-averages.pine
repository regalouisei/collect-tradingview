//@version=6
indicator("Trend Alignment Ribbon - Multi Timeframe Moving Averages", shorttitle="Trend MA", overlay=true)

// ─────────────────────────────────────────────────────────
//  INPUTS
// ─────────────────────────────────────────────────────────

var string GRP_MA1 = "Moving Average 1"
ma1_show   = input.bool(true,    "Show",      group=GRP_MA1, inline="ma1")
ma1_type   = input.string("EMA", "Type",      group=GRP_MA1, inline="ma1", options=["EMA","SMA","WMA","HMA"])
ma1_len    = input.int(8,        "Length",    group=GRP_MA1, inline="ma1", minval=1)
ma1_tf     = input.timeframe("", "Timeframe", group=GRP_MA1)
ma1_color  = input.color(#00BCD4,"Color",     group=GRP_MA1)

var string GRP_MA2 = "Moving Average 2"
ma2_show   = input.bool(true,    "Show",      group=GRP_MA2, inline="ma2")
ma2_type   = input.string("EMA", "Type",      group=GRP_MA2, inline="ma2", options=["EMA","SMA","WMA","HMA"])
ma2_len    = input.int(21,       "Length",    group=GRP_MA2, inline="ma2", minval=1)
ma2_tf     = input.timeframe("", "Timeframe", group=GRP_MA2)
ma2_color  = input.color(#FF9800,"Color",     group=GRP_MA2)

var string GRP_MA3 = "Moving Average 3"
ma3_show   = input.bool(true,    "Show",      group=GRP_MA3, inline="ma3")
ma3_type   = input.string("EMA", "Type",      group=GRP_MA3, inline="ma3", options=["EMA","SMA","WMA","HMA"])
ma3_len    = input.int(50,       "Length",    group=GRP_MA3, inline="ma3", minval=1)
ma3_tf     = input.timeframe("", "Timeframe", group=GRP_MA3)
ma3_color  = input.color(#F44336,"Color",     group=GRP_MA3)

var string GRP_MA4 = "Moving Average 4"
ma4_show   = input.bool(true,    "Show",      group=GRP_MA4, inline="ma4")
ma4_type   = input.string("EMA", "Type",      group=GRP_MA4, inline="ma4", options=["EMA","SMA","WMA","HMA"])
ma4_len    = input.int(200,      "Length",    group=GRP_MA4, inline="ma4", minval=1)
ma4_tf     = input.timeframe("", "Timeframe", group=GRP_MA4)
ma4_color  = input.color(#9C27B0,"Color",     group=GRP_MA4)

var string GRP_VIS = "Visuals"
show_ribbon   = input.bool(false, "Show Ribbon Fill (MA1 to MA4)", group=GRP_VIS)
show_align_bg = input.bool(true,  "Show Full Alignment Background", group=GRP_VIS)
show_signals  = input.bool(true,  "Show MA1 × MA2 Cross Signals",   group=GRP_VIS)

// ─────────────────────────────────────────────────────────
//  FUNCTIONS
// ─────────────────────────────────────────────────────────

get_ma(src, len, ma_type) =>
    switch ma_type
        "SMA" => ta.sma(src, len)
        "WMA" => ta.wma(src, len)
        "HMA" => ta.hma(src, len)
        =>       ta.ema(src, len)

// ─────────────────────────────────────────────────────────
//  CALCULATIONS
// ─────────────────────────────────────────────────────────

// Compute on chart timeframe first, then pull HTF if specified
_ma1 = get_ma(close, ma1_len, ma1_type)
_ma2 = get_ma(close, ma2_len, ma2_type)
_ma3 = get_ma(close, ma3_len, ma3_type)
_ma4 = get_ma(close, ma4_len, ma4_type)

// Use request.security only when a non-chart timeframe is chosen
// lookahead_off ensures no future data leaks (honest, non-repainting)
ma1 = ma1_tf == "" ? _ma1 : request.security(syminfo.tickerid, ma1_tf, _ma1, lookahead=barmerge.lookahead_off)
ma2 = ma2_tf == "" ? _ma2 : request.security(syminfo.tickerid, ma2_tf, _ma2, lookahead=barmerge.lookahead_off)
ma3 = ma3_tf == "" ? _ma3 : request.security(syminfo.tickerid, ma3_tf, _ma3, lookahead=barmerge.lookahead_off)
ma4 = ma4_tf == "" ? _ma4 : request.security(syminfo.tickerid, ma4_tf, _ma4, lookahead=barmerge.lookahead_off)

// Trend alignment: all MAs in order
aligned_bull = ma1 > ma2 and ma2 > ma3 and ma3 > ma4
aligned_bear = ma1 < ma2 and ma2 < ma3 and ma3 < ma4

// MA1 × MA2 crossover signals
cross_up   = ta.crossover(ma1,  ma2)
cross_down = ta.crossunder(ma1, ma2)

// ─────────────────────────────────────────────────────────
//  PLOTS
// ─────────────────────────────────────────────────────────

p1 = plot(ma1_show ? ma1 : na, "MA1", color=ma1_color, linewidth=1)
p2 = plot(ma2_show ? ma2 : na, "MA2", color=ma2_color, linewidth=1)
p3 = plot(ma3_show ? ma3 : na, "MA3", color=ma3_color, linewidth=2)
p4 = plot(ma4_show ? ma4 : na, "MA4", color=ma4_color, linewidth=2)

// Ribbon fill between MA1 and MA4
fill(p1, p4,
     color = show_ribbon ? (ma1 >= ma4 ? color.new(color.green, 88) : color.new(color.red, 88)) : na,
     title = "MA Ribbon")

// Background when all 4 MAs are in full trend alignment
bgcolor(show_align_bg and aligned_bull ? color.new(color.green, 94) :
        show_align_bg and aligned_bear ? color.new(color.red,   94) : na,
        title = "Alignment BG")

// Crossover signals between MA1 and MA2
plotshape(show_signals and cross_up,   "Bull Cross", shape.triangleup,
          location.belowbar, color.new(color.lime, 0), size=size.small)
plotshape(show_signals and cross_down, "Bear Cross", shape.triangledown,
          location.abovebar, color.new(color.red,  0), size=size.small)

// ─────────────────────────────────────────────────────────
//  ALERTS
// ─────────────────────────────────────────────────────────

alertcondition(cross_up,                            "MA Bull Cross",       "MA1 crossed above MA2")
alertcondition(cross_down,                          "MA Bear Cross",       "MA1 crossed below MA2")
alertcondition(aligned_bull and not aligned_bull[1],"Full Bull Alignment", "All 4 MAs in bullish alignment")
alertcondition(aligned_bear and not aligned_bear[1],"Full Bear Alignment", "All 4 MAs in bearish alignment")
