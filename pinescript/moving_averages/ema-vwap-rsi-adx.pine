//@version=6
indicator("BTC 0DTE Clean Combo + ADX Filter", overlay=true)

// === INPUTS ===
emaLength      = input.int(20, "EMA Length")
rsiLength      = input.int(5, "RSI Length")

diLength       = input.int(14, "DI Length")
adxSmoothing   = input.int(14, "ADX Smoothing")
adxThreshold   = input.int(18, "ADX Threshold")

rsiLongLevel   = input.int(55, "RSI Bullish Threshold")
rsiShortLevel  = input.int(45, "RSI Bearish Threshold")

// === CALCULATIONS ===
ema20     = ta.ema(close, emaLength)
vwapValue = ta.vwap(close)
rsiValue  = ta.rsi(close, rsiLength)

// --- ADX using DMI (FIXED) ---
[plusDI, minusDI, adxValue] = ta.dmi(diLength, adxSmoothing)

strongTrend = adxValue > adxThreshold

// === TREND BIAS ===
bullBias = close > ema20 and close > vwapValue
bearBias = close < ema20 and close < vwapValue

// === RSI CROSS ===
rsiCrossUp   = ta.crossover(rsiValue, rsiLongLevel)
rsiCrossDown = ta.crossunder(rsiValue, rsiShortLevel)

// === STATE VARIABLE ===
var int tradeState = 0   // 1=Long, -1=Short, 0=Flat

// === ENTRY CONDITIONS ===
longEntry  = tradeState == 0 and strongTrend and bullBias and rsiCrossUp
shortEntry = tradeState == 0 and strongTrend and bearBias and rsiCrossDown

// === EXIT CONDITIONS ===
exitLong  = tradeState == 1 and (close < ema20 or rsiValue < 50)
exitShort = tradeState == -1 and (close > ema20 or rsiValue > 50)

// === STATE UPDATE ===
if longEntry
    tradeState := 1
else if shortEntry
    tradeState := -1
else if exitLong or exitShort
    tradeState := 0

// === PLOTS ===
plot(ema20, title="20 EMA", color=color.orange, linewidth=2)
plot(vwapValue, title="VWAP", color=color.blue, linewidth=2)

// Entry Signals
plotshape(longEntry, title="Long Entry",
     location=location.belowbar,
     color=color.green,
     style=shape.triangleup,
     size=size.small,
     text="BUY")

plotshape(shortEntry, title="Short Entry",
     location=location.abovebar,
     color=color.red,
     style=shape.triangledown,
     size=size.small,
     text="SELL")

// Exit Signals
plotshape(exitLong, title="Exit Long",
     location=location.abovebar,
     color=color.yellow,
     style=shape.xcross,
     size=size.small,
     text="EXIT")

plotshape(exitShort, title="Exit Short",
     location=location.belowbar,
     color=color.yellow,
     style=shape.xcross,
     size=size.small,
     text="EXIT")

// Background
bgcolor(tradeState == 1 ? color.new(color.green, 90) :
       tradeState == -1 ? color.new(color.red, 90) : na)
