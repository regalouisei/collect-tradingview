// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © BigGuavaTrading
//@version=5

// 1. STANDARDIZATION: Name [ST]
indicator("MA & BB Levels [ST]", overlay=true, max_lines_count=16, max_labels_count=16)

// 2. VERSION CONTROL
string ver_num  = "v2.0"
string ver_date = "2026-02-09"

// ==========================================
// 1. INPUTS
// ==========================================
grp_week  = "Weekly Levels"
grp_day   = "Daily Levels"
grp_conf  = "Indicator Settings"
grp_style = "Style Settings"

// Weekly Switches
plotW_EMA9    = input.bool(true, "MA9 (Weekly)", group=grp_week)
plotW_EMA20   = input.bool(true, "MA20 (Weekly)", group=grp_week)
plotW_BBUpper = input.bool(true, "BB Upper (Weekly)", group=grp_week)
plotW_BBLower = input.bool(true, "BB Lower (Weekly)", group=grp_week)

// Daily Switches
plotD_EMA9    = input.bool(true, "MA9 (Daily)", group=grp_day)
plotD_EMA20   = input.bool(true, "MA20 (Daily)", group=grp_day)
plotD_BBUpper = input.bool(true, "BB Upper (Daily)", group=grp_day)
plotD_BBLower = input.bool(true, "BB Lower (Daily)", group=grp_day)

// Indicator Settings
ema9Len   = input.int(9,  "EMA 9 Period",  inline="ema", group=grp_conf)
ema20Len  = input.int(20, "EMA 20 Period", inline="ema", group=grp_conf)
bbLen     = input.int(20, "BB Period",     inline="bb",  group=grp_conf)
bbStdDev  = input.float(2.0, "BB StdDev",  inline="bb",  group=grp_conf)

// Style Settings
textSizeInput = input.string("Normal", "Text Size", options = ["Small", "Normal", "Large", "Huge"], group=grp_style)

finalSize = switch textSizeInput
    "Small"  => size.small
    "Normal" => size.normal
    "Large"  => size.large
    "Huge"   => size.huge
    => size.normal

// ==========================================
// 2. CALCULATIONS
// ==========================================
// Core Indicators
ema9      = ta.ema(close, ema9Len)
ema20     = ta.ema(close, ema20Len)
ema_basis = ta.ema(close, bbLen) 
dev       = bbStdDev * ta.stdev(close, bbLen)
bbUpper   = ema_basis + dev
bbLower   = ema_basis - dev

// ==========================================
// 3. MTF DATA FETCHING
// ==========================================
// Weekly Data
w_ema9    = request.security(syminfo.tickerid, "W", ema9,    lookahead=barmerge.lookahead_on)
w_ema20   = request.security(syminfo.tickerid, "W", ema20,   lookahead=barmerge.lookahead_on)
w_bbUpper = request.security(syminfo.tickerid, "W", bbUpper, lookahead=barmerge.lookahead_on)
w_bbLower = request.security(syminfo.tickerid, "W", bbLower, lookahead=barmerge.lookahead_on)

// Daily Data
d_ema9    = request.security(syminfo.tickerid, "D", ema9,    lookahead=barmerge.lookahead_on)
d_ema20   = request.security(syminfo.tickerid, "D", ema20,   lookahead=barmerge.lookahead_on)
d_bbUpper = request.security(syminfo.tickerid, "D", bbUpper, lookahead=barmerge.lookahead_on)
d_bbLower = request.security(syminfo.tickerid, "D", bbLower, lookahead=barmerge.lookahead_on)

// Style Definitions
lineColor = color.new(#FFBF00, 30) // Gold with transparency
lineStyle = line.style_solid
textColor = color.blue

// ==========================================
// 4. PLOTTING (Lines & Labels)
// ==========================================
if barstate.islast
    int labelOffset = 1 
    // Label sits on top of the line, aligned to the right
    string lblStyle = label.style_label_lower_left 
    
    // --- WEEKLY LEVELS ---
    if plotW_EMA9
        line.new(bar_index, w_ema9, bar_index + 10, w_ema9, extend=extend.right, color=lineColor, style=lineStyle, width=2)
        label.new(bar_index + labelOffset, w_ema9, "W EMA9: " + str.tostring(w_ema9, "#.##"), color=color(na), textcolor=textColor, size=finalSize, style=lblStyle)
    
    if plotW_EMA20
        line.new(bar_index, w_ema20, bar_index + 10, w_ema20, extend=extend.right, color=lineColor, style=lineStyle, width=2)
        label.new(bar_index + labelOffset, w_ema20, "W EMA20: " + str.tostring(w_ema20, "#.##"), color=color(na), textcolor=textColor, size=finalSize, style=lblStyle)
    
    if plotW_BBUpper
        line.new(bar_index, w_bbUpper, bar_index + 10, w_bbUpper, extend=extend.right, color=lineColor, style=lineStyle, width=2)
        label.new(bar_index + labelOffset, w_bbUpper, "W BB UP: " + str.tostring(w_bbUpper, "#.##"), color=color(na), textcolor=textColor, size=finalSize, style=lblStyle)
    
    if plotW_BBLower
        line.new(bar_index, w_bbLower, bar_index + 10, w_bbLower, extend=extend.right, color=lineColor, style=lineStyle, width=2)
        label.new(bar_index + labelOffset, w_bbLower, "W BB LW: " + str.tostring(w_bbLower, "#.##"), color=color(na), textcolor=textColor, size=finalSize, style=lblStyle)

    // --- DAILY LEVELS ---
    if plotD_EMA9
        line.new(bar_index, d_ema9, bar_index + 10, d_ema9, extend=extend.right, color=lineColor, style=lineStyle, width=2)
        label.new(bar_index + labelOffset, d_ema9, "D EMA9: " + str.tostring(d_ema9, "#.##"), color=color(na), textcolor=textColor, size=finalSize, style=lblStyle)
    
    if plotD_EMA20
        line.new(bar_index, d_ema20, bar_index + 10, d_ema20, extend=extend.right, color=lineColor, style=lineStyle, width=2)
        label.new(bar_index + labelOffset, d_ema20, "D EMA20: " + str.tostring(d_ema20, "#.##"), color=color(na), textcolor=textColor, size=finalSize, style=lblStyle)
    
    if plotD_BBUpper
        line.new(bar_index, d_bbUpper, bar_index + 10, d_bbUpper, extend=extend.right, color=lineColor, style=lineStyle, width=2)
        label.new(bar_index + labelOffset, d_bbUpper, "D BB UP: " + str.tostring(d_bbUpper, "#.##"), color=color(na), textcolor=textColor, size=finalSize, style=lblStyle)
    
    if plotD_BBLower
        line.new(bar_index, d_bbLower, bar_index + 10, d_bbLower, extend=extend.right, color=lineColor, style=lineStyle, width=2)
        label.new(bar_index + labelOffset, d_bbLower, "D BB LW: " + str.tostring(d_bbLower, "#.##"), color=color(na), textcolor=textColor, size=finalSize, style=lblStyle)
