//@version=6
indicator("Trend-Based Fibs: Strict Reversal Logic", overlay=true, max_lines_count=500, max_boxes_count=500)

//----------------------
// User Inputs
//----------------------
tfMode       = input.string("Daily", "Anchor Period", options=["Daily", "Weekly"])
showLabels   = input.bool(true, "Show Labels", group="Visuals")
showFirstHL  = input.bool(true, "Show First Candle H/L", group="Visuals")
showSLTarget = input.bool(true, "Show SL/Target Lines", group="Strategy Visuals")

// Moving Averages
showEma      = input.bool(true, "Show EMA 1", group="Moving Averages")
emaLength    = input.int(20, "EMA 1 Length", group="Moving Averages")
showEma2     = input.bool(true, "Show EMA 2", group="Moving Averages")
emaLength2   = input.int(100, "EMA 2 Length", group="Moving Averages")

// Logic Helpers
isNewPeriod = tfMode == "Daily" ? ta.change(time("D")) != 0 : ta.change(time("W")) != 0
rawHigh = request.security(syminfo.tickerid, tfMode == "Daily" ? "D" : "W", high[1], lookahead=barmerge.lookahead_on)
rawLow  = request.security(syminfo.tickerid, tfMode == "Daily" ? "D" : "W", low[1], lookahead=barmerge.lookahead_on)

//----------------------
// State Variables
//----------------------
var float prevHigh    = na
var float prevLow     = na
var float firstClose  = na
var float bullFib0236 = na
var float bearFib0236 = na
var float bullFib0500 = na
var float bearFib0500 = na

var bool  hasSignaledToday = false
var bool  targetMetToday   = false
var bool  reversalTaken    = false
var float activeSL         = na
var float activeTarget     = na
var int   posType          = 0 // 1: Long, -1: Short, 0: None

var line[] activeLines      = array.new_line()
var line[] firstCandleLines = array.new_line()

if isNewPeriod
    hasSignaledToday := false
    targetMetToday   := false
    reversalTaken    := false
    posType          := 0
    activeSL         := na
    activeTarget     := na
    prevHigh         := rawHigh
    prevLow          := rawLow
    firstClose       := close 
    
    float rangeP = prevHigh - prevLow
    bullFib0236 := firstClose + (rangeP * 0.236)
    bearFib0236 := firstClose - (rangeP * 0.236)
    bullFib0500 := firstClose + (rangeP * 0.500)
    bearFib0500 := firstClose - (rangeP * 0.500)
    
    array.clear(activeLines)
    array.clear(firstCandleLines)
    
    if showFirstHL
        array.push(firstCandleLines, line.new(bar_index, high, bar_index + 1, high, color=color.yellow, style=line.style_dotted))
        array.push(firstCandleLines, line.new(bar_index, low, bar_index + 1, low, color=color.yellow, style=line.style_dotted))
    
    ratios = array.from(0.236, 0.5, 0.786, 1.0, 1.618)
    for r in ratios
        float pBull = firstClose + (rangeP * r)
        float pBear = firstClose - (rangeP * r)
        array.push(activeLines, line.new(bar_index, pBull, bar_index + 1, pBull, color=color.new(color.blue, 60)))
        array.push(activeLines, line.new(bar_index, pBear, bar_index + 1, pBear, color=color.new(color.red, 60)))

//----------------------
// Signal Logic
//----------------------
// Only signal if no trade has happened and the target hasn't been met yet
canSignal = not isNewPeriod and not hasSignaledToday and not targetMetToday and posType == 0

longRev  = canSignal and low <= bearFib0236 and close > bearFib0236
longBrk  = canSignal and high >= bullFib0236 and close > bullFib0236
shortRev = canSignal and high >= bullFib0236 and close < bullFib0236
shortBrk = canSignal and low <= bearFib0236 and close < bearFib0236

// Entry Logic for First Trade
if longRev
    posType := 1, hasSignaledToday := true, activeTarget := firstClose, activeSL := bearFib0236 + (bearFib0500 - bearFib0236) * 0.382
if longBrk
    posType := 1, hasSignaledToday := true, activeTarget := bullFib0500, activeSL := bullFib0236 + (firstClose - bullFib0236) * 0.382
if shortRev
    posType := -1, hasSignaledToday := true, activeTarget := firstClose, activeSL := bullFib0236 + (bullFib0500 - bullFib0236) * 0.382
if shortBrk
    posType := -1, hasSignaledToday := true, activeTarget := bearFib0500, activeSL := bearFib0236 + (firstClose - bearFib0236) * 0.382

//----------------------
// Exit / Reversal Logic
//----------------------
slHit     = false
targetHit = false
revBuy    = false
revSell   = false

if posType != 0
    // Check for Target Hit (Ends the day for this script)
    if (posType == 1 and high >= activeTarget) or (posType == -1 and low <= activeTarget)
        targetHit      := true
        targetMetToday := true
        posType        := 0
        activeSL       := na
        activeTarget   := na
    
    // Check for SL Hit (Only triggers reversal if target wasn't met first)
    else if (posType == 1 and close < activeSL) or (posType == -1 and close > activeSL)
        slHit := true
        if not reversalTaken
            // Trigger Reversal Order
            if posType == 1
                revSell := true
                posType := -1
            else
                revBuy  := true
                posType := 1
            
            reversalTaken := true
            activeSL      := na // No SL for reversal
            activeTarget  := na // No Target for reversal (Skip target)
        else
            posType := 0

//----------------------
// Visuals
//----------------------
plot(showEma ? ta.ema(close, emaLength) : na, "EMA 1", color=color.aqua)
plot(showEma2 ? ta.ema(close, emaLength2) : na, "EMA 2", color=color.white)

// Only plot SL/Target for the first trade
plot(showSLTarget and not reversalTaken ? activeSL : na, "Stop Loss", color=color.red, style=plot.style_linebr, linewidth=2)
plot(showSLTarget and not reversalTaken ? activeTarget : na, "Target", color=color.green, style=plot.style_linebr, linewidth=2)

// Shapes
plotshape(longRev or longBrk, "Entry Long", shape.triangleup, location.belowbar, color.green, size=size.small)
plotshape(shortRev or shortBrk, "Entry Short", shape.triangledown, location.abovebar, color.red, size=size.small)
plotshape(revBuy, "REV BUY", shape.triangleup, location.belowbar, color.lime, size=size.normal, text="REV-BUY")
plotshape(revSell, "REV SELL", shape.triangledown, location.abovebar, color.fuchsia, size=size.normal, text="REV-SELL")
plotshape(targetHit, "Target Met", shape.circle, location.abovebar, color.yellow, size=size.tiny, text="ðŸŽ¯")

// Line Extensions
if array.size(activeLines) > 0
    for i = 0 to array.size(activeLines) - 1
        line.set_x2(array.get(activeLines, i), bar_index)
