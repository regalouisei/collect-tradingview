//@version=5
indicator("15m BOS + OTE + FVG + OB (Prop Firm)", overlay=true, max_lines_count=500, max_labels_count=500)

// ==========================
// INPUTS
// ==========================
htf           = "15"
swingLen      = 3
nySession     = "0930-1130"
showZones     = true

// ==========================
// SESSION FILTER
// ==========================
inSession = not na(time(timeframe.period, nySession))

// ==========================
// 15M STRUCTURE
// ==========================
[htfH, htfL, htfC] = request.security(syminfo.tickerid, htf, [high, low, close])

ph = ta.pivothigh(htfH, swingLen, swingLen)
pl = ta.pivotlow(htfL, swingLen, swingLen)

var float lastHigh = na
var float lastLow  = na

if not na(ph)
    lastHigh := ph
if not na(pl)
    lastLow := pl

bullBOS = ta.crossover(htfC, lastHigh)
bearBOS = ta.crossunder(htfC, lastLow)

// ==========================
// DEALING RANGE + OTE
// ==========================
var float rangeHigh = na
var float rangeLow  = na
var bool  traded    = false

if bullBOS
    rangeHigh := htfH
    rangeLow  := lastLow
    traded    := false

if bearBOS
    rangeLow  := htfL
    rangeHigh := lastHigh
    traded    := false

oteH = rangeLow + (rangeHigh - rangeLow) * 0.79
oteL = rangeLow + (rangeHigh - rangeLow) * 0.618

// ==========================
// FAIR VALUE GAP (3-CANDLE)
// ==========================
bullFVG = low > high[2]
bearFVG = high < low[2]

fvgLowBull  = high[2]
fvgHighBull = low

fvgHighBear = low[2]
fvgLowBear  = high

// ==========================
// ORDER BLOCK (LAST OPPOSING CANDLE)
// ==========================
bullOB = close[1] < open[1] and bullBOS
bearOB = close[1] > open[1] and bearBOS

obHigh = high[1]
obLow  = low[1]

// ==========================
// LOWER TF INTERNAL BOS
// ==========================
iHigh = ta.pivothigh(high, 2, 2)
iLow  = ta.pivotlow(low, 2, 2)

var float internalHigh = na
var float internalLow  = na

if not na(iHigh)
    internalHigh := iHigh
if not na(iLow)
    internalLow := iLow

ltfBullBOS = ta.crossover(close, internalHigh)
ltfBearBOS = ta.crossunder(close, internalLow)

// ==========================
// RETRACEMENT CONDITIONS
// ==========================
inOTEbull = low <= oteH and low >= oteL
inOTEbear = high >= oteL and high <= oteH

tapBullFVG = low <= fvgHighBull and low >= fvgLowBull
tapBearFVG = high >= fvgLowBear and high <= fvgHighBear

tapBullOB = low <= obHigh and low >= obLow
tapBearOB = high >= obLow and high <= obHigh

// ==========================
// ENTRY CONDITIONS
// ==========================
longEntry = bullBOS == false and inSession and not traded and inOTEbull and tapBullFVG and tapBullOB and  ltfBullBOS

shortEntry = bearBOS == false and inSession and not traded and inOTEbear and tapBearFVG and tapBearOB and ltfBearBOS

if longEntry or shortEntry
    traded := true

// ==========================
// VISUALS
// ==========================
if bullBOS
    label.new(bar_index, high, "15m BOS ↑", color=color.green)

if bearBOS
    label.new(bar_index, low, "15m BOS ↓", color=color.red)

if longEntry
    label.new(bar_index, low, "PROP LONG", style=label.style_label_up, color=color.lime)

if shortEntry
    label.new(bar_index, high, "PROP SHORT", style=label.style_label_down, color=color.red)

// ==========================
// STOPS & TARGETS
// ==========================
if longEntry
    line.new(bar_index, internalLow, bar_index + 25, internalLow, color=color.red)
    line.new(bar_index, rangeHigh, bar_index + 25, rangeHigh, color=color.green)

if shortEntry
    line.new(bar_index, internalHigh, bar_index + 25, internalHigh, color=color.red)
    line.new(bar_index, rangeLow, bar_index + 25, rangeLow, color=color.green)

// ==========================
// BUY / SELL SIGNALS
// ==========================
plotshape(longEntry, title="Buy Signal", style=shape.triangleup,location=location.belowbar,color=color.lime,size=size.small,text="BUY")

plotshape(shortEntry,title="Sell Signal",style=shape.triangledown,location=location.abovebar,color=color.red,size=size.small,text="SELL")

// ==========================
// ALERTS
// ==========================
alertcondition(longEntry, title="Long Entry Alert", message="LONG entry signal")
alertcondition(shortEntry, title="Short Entry Alert", message="SHORT entry signal")
