//@version=6
indicator("VWAP + Stoch + Macro Panel - Dale M.G. Edition", overlay=true)

// --- 1. PARÁMETROS Y VWAP ---
vwapVal = ta.vwap(hlc3)
plot(vwapVal, title="VWAP de Sesión", color=color.new(color.lime, 0), linewidth=2)

// --- 2. ESTOCÁSTICO LOCAL (5-15 min) ---
periodK = 14, periodD = 3, smoothK = 3
k = ta.sma(ta.stoch(close, high, low, periodK), smoothK)
d = ta.sma(k, periodD)

// --- 3. LÓGICA DE FILTRO MACRO (1 Hora) ---
stochK_60 = request.security(syminfo.tickerid, "60", ta.sma(ta.stoch(close, high, low, periodK), smoothK))
macroTrend = stochK_60 > 50 ? "ALCISTA" : "BAJISTA"
macroColor = stochK_60 > 50 ? color.green : color.red
smaH200 = request.security(syminfo.tickerid, "60", ta.sma(close, 200)) //(ta.stoch(close, high, low, periodK), smoothK))
plot(smaH200, title="SMA 200 1Hr", color=color.new(color.purple, 0), linewidth=2)
// --- 4. SEÑAL DE COMPRA ---
nearVWAP = low <= vwapVal * 1.0015
stochOversold = k < 30
stochBought = k > 70
rejection = (math.min(open, close) - low) > (math.abs(close - open) * 1.2)
// Solo compramos si el precio está sobre VWAP Y la macro (1H) no está en sobreventa extrema o es favorable
longSignal = close > vwapVal and nearVWAP and stochOversold and rejection and close > smaH200
shortSignal = close < vwapVal and nearVWAP and stochBought and rejection and close < smaH200

plotshape(longSignal, title="BUY", style=shape.labelup, location=location.belowbar, color=color.green, text="BUY", textcolor=color.white, size=size.small)
plotshape(shortSignal, title="SELL", style=shape.labeldown, location=location.abovebar, color=color.red, text="SELL", textcolor=color.white, size=size.small)

// --- 5. PANEL VISUAL MACRO ---
var table panel = table.new(position.top_right, 2, 2, bgcolor=color.new(color.black, 70), border_width=1)
if barstate.islast
    table.cell(panel, 0, 0, "Temporalidad 1H", text_color=color.white)
    table.cell(panel, 1, 0, "Estado: " + macroTrend, text_color=macroColor)
    table.cell(panel, 0, 1, "Stoch 1H Val:", text_color=color.white)
    table.cell(panel, 1, 1, str.tostring(math.round(stochK_60)), text_color=macroColor)

// Alertas
alertcondition(longSignal, "Señal Confirmada VWAP+Stoch", "Entrada detectada con filtro Macro 1H")
