//@version=6
indicator("Draggable VWAP Pivot Pairs Simplified", overlay = true, dynamic_requests = true)

// ──────────────────────────────────────
// INPUTS
// ──────────────────────────────────────
htf = input.timeframe("D", "Higher Timeframe for VWAP Pairs", group="Timeframe Settings")

start_time = input.time(timestamp("2025-12-01 00:00"), "Anchor Start (drag me)", confirm = true, group="Anchor Settings")

showHighPair = input.bool(true,  "Show High Pivot Pair (when falling)", group = "Display Options")
showLowPair  = input.bool(true,  "Show Low Pivot Pair (when rising)",   group = "Display Options")
showMidpoint = input.bool(true,  "Show Midpoint Line",                  group = "Display Options")

hiColor      = input.color(color.red,   "High VWAP Color",                group = "Colors")
hiCloseColor = input.color(color.red,   "High VWAP (Close)",             group = "Colors")
loColor      = input.color(color.green, "Low VWAP Color",                 group = "Colors")
loCloseColor = input.color(color.green, "Low VWAP (Close)",              group = "Colors")
midColor     = input.color(color.rgb(255, 255, 255), "Midpoint Line",     group = "Colors")

fillHiColor  = input.color(color.new(color.red,   50), "Fill: High Pair", group = "Colors")
fillLoColor  = input.color(color.new(color.green, 50), "Fill: Low Pair",  group = "Colors")

// ──────────────────────────────────────
// CALCULATION FUNCTION – simple new-extreme anchor
// ──────────────────────────────────────
f_getVWAPs() =>
    var float hi = na
    var float lo = na
    var bool  resetHi = false
    var bool  resetLo = false

    bool after_start = time >= start_time

    if after_start
        if na(hi) and na(lo)                     // First bar after draggable start
            hi := high
            lo := low
            resetHi := true
            resetLo := true
        else
            // Update on new extremes (independent for high and low)
            resetHi := high > hi
            resetLo := low  < lo
            
            if resetHi
                hi := high
            if resetLo
                lo := low
    else
        resetHi := false
        resetLo := false

    vwapHiHigh  = ta.vwap(high,  resetHi)
    vwapHiClose = ta.vwap(close, resetHi)
    vwapLoLow   = ta.vwap(low,   resetLo)
    vwapLoClose = ta.vwap(close, resetLo)

    bool vwapHighFalling = vwapHiHigh < vwapHiHigh[1]
    bool vwapLowRising    = vwapLoLow   > vwapLoLow[1]

    float midPoint = (vwapHiHigh + vwapLoLow) / 2

    [vwapHiHigh, vwapHiClose, vwapLoLow, vwapLoClose, midPoint, vwapHighFalling, vwapLowRising, after_start]

// ──────────────────────────────────────
// REQUEST HTF DATA
// ──────────────────────────────────────
[vwapHiHigh_, vwapHiClose_, vwapLoLow_, vwapLoClose_, midPoint_, vwapHighFalling, vwapLowRising, afterAnchor_] = request.security(syminfo.tickerid, htf, f_getVWAPs(), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)

// ──────────────────────────────────────
// DISPLAY LOGIC
// ──────────────────────────────────────
bool showHighNow = showHighPair and vwapHighFalling and afterAnchor_
bool showLowNow  = showLowPair  and vwapLowRising   and afterAnchor_

plot(showHighNow ? vwapHiHigh_  : na, "High VWAP (High)",  color=hiColor,      linewidth=1)
plot(showHighNow ? vwapHiClose_ : na, "High VWAP (Close)", color=hiCloseColor, linewidth=1)
plot(showLowNow  ? vwapLoLow_   : na, "Low VWAP (Low)",    color=loColor,      linewidth=1)
plot(showLowNow  ? vwapLoClose_ : na, "Low VWAP (Close)",  color=loCloseColor, linewidth=1)

fill(
     plot(showHighNow ? vwapHiHigh_  : na, display=display.none),
     plot(showHighNow ? vwapHiClose_ : na, display=display.none),
     showHighNow ? fillHiColor : na, title="High Pair Fill")

fill(
     plot(showLowNow  ? vwapLoLow_   : na, display=display.none),
     plot(showLowNow  ? vwapLoClose_ : na, display=display.none),
     showLowNow  ? fillLoColor  : na, title="Low Pair Fill")

plot(showMidpoint and afterAnchor_ ? midPoint_ : na, "Midpoint", color=midColor, linewidth=2)

// ──────────────────────────────────────
// Visual draggable anchor line (blue dashed)
// ──────────────────────────────────────
var line anchorLine = na

if not na(ta.change(start_time)) or barstate.isfirst
    if na(anchorLine)
        anchorLine := line.new(start_time, -1e12, start_time, 1e12,
             xloc    = xloc.bar_time,
             extend  = extend.both,
             color   = color.blue,
             style   = line.style_dashed,
             width   = 2)
    else
        line.set_x1(anchorLine, start_time)
        line.set_x2(anchorLine, start_time)
