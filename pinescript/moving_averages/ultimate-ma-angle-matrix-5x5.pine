//@version=5
indicator("Ultimate MA Angle Matrix (5x5)", overlay=true)

// ===== GLOBAL INPUT =====
atr_length = input.int(14, "ATR Length For Normalization", group="Global Settings")

// Display Toggles (To prevent the chart from becoming unreadable)
grp_disp = "Plot Visibility"
plot_ema = input.bool(true, "Plot EMAs", group=grp_disp)
plot_wma = input.bool(false, "Plot WMAs", group=grp_disp)
plot_sma = input.bool(false, "Plot SMAs", group=grp_disp)
plot_vwap = input.bool(false, "Plot VWAPs", group=grp_disp)
plot_tema = input.bool(false, "Plot TEMAs", group=grp_disp)

// ===== CUSTOM FUNCTION: TEMA =====
tema(src, len) =>
    ema1 = ta.ema(src, len)
    ema2 = ta.ema(ema1, len)
    ema3 = ta.ema(ema2, len)
    3 * (ema1 - ema2) + ema3

// ===== LEVEL 1 SETTINGS (Default 9) =====
grp1 = "Level 1 Settings (Fast)"
len1  = input.int(9,  title="Length", group=grp1)
lb1   = input.int(5,  title="Angle Lookback", group=grp1)
buy1  = input.float(8.0,  title="BUY Angle", group=grp1)
sell1 = input.float(-8.0, title="SELL Angle", group=grp1)
col1  = input.color(color.green, title="Line Color", group=grp1)

// ===== LEVEL 2 SETTINGS (Default 21) =====
grp2 = "Level 2 Settings (Short)"
len2  = input.int(21, title="Length", group=grp2)
lb2   = input.int(6,  title="Angle Lookback", group=grp2)
buy2  = input.float(8.0,  title="BUY Angle", group=grp2)
sell2 = input.float(-8.0, title="SELL Angle", group=grp2)
col2  = input.color(color.yellow, title="Line Color", group=grp2)

// ===== LEVEL 3 SETTINGS (Default 50) =====
grp3 = "Level 3 Settings (Medium)"
len3  = input.int(50, title="Length", group=grp3)
lb3   = input.int(8,  title="Angle Lookback", group=grp3)
buy3  = input.float(6.0,  title="BUY Angle", group=grp3)
sell3 = input.float(-6.0, title="SELL Angle", group=grp3)
col3  = input.color(color.aqua, title="Line Color", group=grp3)

// ===== LEVEL 4 SETTINGS (Default 100) =====
grp4 = "Level 4 Settings (Long)"
len4  = input.int(100, title="Length", group=grp4)
lb4   = input.int(10,  title="Angle Lookback", group=grp4)
buy4  = input.float(5.0,  title="BUY Angle", group=grp4)
sell4 = input.float(-5.0, title="SELL Angle", group=grp4)
col4  = input.color(color.orange, title="Line Color", group=grp4)

// ===== LEVEL 5 SETTINGS (Default 200) =====
grp5 = "Level 5 Settings (Macro)"
len5  = input.int(200, title="Length", group=grp5)
lb5   = input.int(12,  title="Angle Lookback", group=grp5)
buy5  = input.float(4.0,  title="BUY Angle", group=grp5)
sell5 = input.float(-4.0, title="SELL Angle", group=grp5)
col5  = input.color(color.white, title="Line Color", group=grp5)


// ===== MA CALCULATIONS (All 25 Indicators) =====
// Level 1 (9)
ema1 = ta.ema(close, len1), wma1 = ta.wma(close, len1), sma1 = ta.sma(close, len1), vwap1 = ta.vwma(close, len1), tema1 = tema(close, len1)
// Level 2 (21)
ema2 = ta.ema(close, len2), wma2 = ta.wma(close, len2), sma2 = ta.sma(close, len2), vwap2 = ta.vwma(close, len2), tema2 = tema(close, len2)
// Level 3 (50)
ema3 = ta.ema(close, len3), wma3 = ta.wma(close, len3), sma3 = ta.sma(close, len3), vwap3 = ta.vwma(close, len3), tema3 = tema(close, len3)
// Level 4 (100)
ema4 = ta.ema(close, len4), wma4 = ta.wma(close, len4), sma4 = ta.sma(close, len4), vwap4 = ta.vwma(close, len4), tema4 = tema(close, len4)
// Level 5 (200)
ema5 = ta.ema(close, len5), wma5 = ta.wma(close, len5), sma5 = ta.sma(close, len5), vwap5 = ta.vwma(close, len5), tema5 = tema(close, len5)

// ===== PLOTTING =====
plot(plot_ema ? ema1 : na, color=col1, linewidth=2), plot(plot_ema ? ema2 : na, color=col2, linewidth=2), plot(plot_ema ? ema3 : na, color=col3, linewidth=2), plot(plot_ema ? ema4 : na, color=col4, linewidth=2), plot(plot_ema ? ema5 : na, color=col5, linewidth=2)
plot(plot_wma ? wma1 : na, color=col1, linewidth=1), plot(plot_wma ? wma2 : na, color=col2, linewidth=1), plot(plot_wma ? wma3 : na, color=col3, linewidth=1), plot(plot_wma ? wma4 : na, color=col4, linewidth=1), plot(plot_wma ? wma5 : na, color=col5, linewidth=1)
plot(plot_sma ? sma1 : na, color=col1, linewidth=1), plot(plot_sma ? sma2 : na, color=col2, linewidth=1), plot(plot_sma ? sma3 : na, color=col3, linewidth=1), plot(plot_sma ? sma4 : na, color=col4, linewidth=1), plot(plot_sma ? sma5 : na, color=col5, linewidth=1)
plot(plot_vwap ? vwap1 : na, color=col1, linewidth=1), plot(plot_vwap ? vwap2 : na, color=col2, linewidth=1), plot(plot_vwap ? vwap3 : na, color=col3, linewidth=1), plot(plot_vwap ? vwap4 : na, color=col4, linewidth=1), plot(plot_vwap ? vwap5 : na, color=col5, linewidth=1)
plot(plot_tema ? tema1 : na, color=col1, linewidth=1), plot(plot_tema ? tema2 : na, color=col2, linewidth=1), plot(plot_tema ? tema3 : na, color=col3, linewidth=1), plot(plot_tema ? tema4 : na, color=col4, linewidth=1), plot(plot_tema ? tema5 : na, color=col5, linewidth=1)

// ===== ANGLE CALCULATIONS =====
atr = ta.atr(atr_length)

calc_angle(ma_val, lookback) =>
    slope = (ma_val - ma_val[lookback]) / lookback
    normalized_slope = slope / math.max(atr, 0.000001)
    math.atan(normalized_slope) * 180 / math.pi

// Angles Level 1
a_ema1 = calc_angle(ema1, lb1), a_wma1 = calc_angle(wma1, lb1), a_sma1 = calc_angle(sma1, lb1), a_vwap1 = calc_angle(vwap1, lb1), a_tema1 = calc_angle(tema1, lb1)
// Angles Level 2
a_ema2 = calc_angle(ema2, lb2), a_wma2 = calc_angle(wma2, lb2), a_sma2 = calc_angle(sma2, lb2), a_vwap2 = calc_angle(vwap2, lb2), a_tema2 = calc_angle(tema2, lb2)
// Angles Level 3
a_ema3 = calc_angle(ema3, lb3), a_wma3 = calc_angle(wma3, lb3), a_sma3 = calc_angle(sma3, lb3), a_vwap3 = calc_angle(vwap3, lb3), a_tema3 = calc_angle(tema3, lb3)
// Angles Level 4
a_ema4 = calc_angle(ema4, lb4), a_wma4 = calc_angle(wma4, lb4), a_sma4 = calc_angle(sma4, lb4), a_vwap4 = calc_angle(vwap4, lb4), a_tema4 = calc_angle(tema4, lb4)
// Angles Level 5
a_ema5 = calc_angle(ema5, lb5), a_wma5 = calc_angle(wma5, lb5), a_sma5 = calc_angle(sma5, lb5), a_vwap5 = calc_angle(vwap5, lb5), a_tema5 = calc_angle(tema5, lb5)

// ===== DASHBOARD LOGIC =====
getCategory(angle, buyLevel, sellLevel) =>
    angle >= buyLevel ? "BUY" : angle <= sellLevel ? "SELL" : "SIDEWAYS"

getColor(angle, buyLevel, sellLevel) =>
    angle >= buyLevel ? color.new(color.green, 20) : angle <= sellLevel ? color.new(color.red, 20) : color.new(color.yellow, 20)

// Function to cleanly fill a matrix cell
fill_cell(tb, col, row, angle, buyLvl, sellLvl) =>
    cat = getCategory(angle, buyLvl, sellLvl)
    bg = getColor(angle, buyLvl, sellLvl)
    // Using \n to put the degrees on a new line so the table doesn't get too wide
    txt = cat + "\n(" + str.tostring(angle, "#.0") + "Â°)"
    table.cell(tb, col, row, txt, bgcolor=bg, text_color=color.black)

// ===== DRAW DASHBOARD (6 Columns x 6 Rows) =====
var table dashboard = table.new(position.top_right, 6, 6, border_width=1, border_color=color.gray)

if barstate.islast
    // Header Row (0)
    table.cell(dashboard, 0, 0, "Length", bgcolor=color.black, text_color=color.white)
    table.cell(dashboard, 1, 0, "EMA", bgcolor=color.black, text_color=color.white)
    table.cell(dashboard, 2, 0, "WMA", bgcolor=color.black, text_color=color.white)
    table.cell(dashboard, 3, 0, "SMA", bgcolor=color.black, text_color=color.white)
    table.cell(dashboard, 4, 0, "VWAP", bgcolor=color.black, text_color=color.white)
    table.cell(dashboard, 5, 0, "TEMA", bgcolor=color.black, text_color=color.white)

    // Row 1 (Length 9)
    table.cell(dashboard, 0, 1, str.tostring(len1), bgcolor=col1, text_color=color.black)
    fill_cell(dashboard, 1, 1, a_ema1, buy1, sell1)
    fill_cell(dashboard, 2, 1, a_wma1, buy1, sell1)
    fill_cell(dashboard, 3, 1, a_sma1, buy1, sell1)
    fill_cell(dashboard, 4, 1, a_vwap1, buy1, sell1)
    fill_cell(dashboard, 5, 1, a_tema1, buy1, sell1)

    // Row 2 (Length 21)
    table.cell(dashboard, 0, 2, str.tostring(len2), bgcolor=col2, text_color=color.black)
    fill_cell(dashboard, 1, 2, a_ema2, buy2, sell2)
    fill_cell(dashboard, 2, 2, a_wma2, buy2, sell2)
    fill_cell(dashboard, 3, 2, a_sma2, buy2, sell2)
    fill_cell(dashboard, 4, 2, a_vwap2, buy2, sell2)
    fill_cell(dashboard, 5, 2, a_tema2, buy2, sell2)

    // Row 3 (Length 50)
    table.cell(dashboard, 0, 3, str.tostring(len3), bgcolor=col3, text_color=color.black)
    fill_cell(dashboard, 1, 3, a_ema3, buy3, sell3)
    fill_cell(dashboard, 2, 3, a_wma3, buy3, sell3)
    fill_cell(dashboard, 3, 3, a_sma3, buy3, sell3)
    fill_cell(dashboard, 4, 3, a_vwap3, buy3, sell3)
    fill_cell(dashboard, 5, 3, a_tema3, buy3, sell3)

    // Row 4 (Length 100)
    table.cell(dashboard, 0, 4, str.tostring(len4), bgcolor=col4, text_color=color.black)
    fill_cell(dashboard, 1, 4, a_ema4, buy4, sell4)
    fill_cell(dashboard, 2, 4, a_wma4, buy4, sell4)
    fill_cell(dashboard, 3, 4, a_sma4, buy4, sell4)
    fill_cell(dashboard, 4, 4, a_vwap4, buy4, sell4)
    fill_cell(dashboard, 5, 4, a_tema4, buy4, sell4)

    // Row 5 (Length 200)
    table.cell(dashboard, 0, 5, str.tostring(len5), bgcolor=col5, text_color=color.black)
    fill_cell(dashboard, 1, 5, a_ema5, buy5, sell5)
    fill_cell(dashboard, 2, 5, a_wma5, buy5, sell5)
    fill_cell(dashboard, 3, 5, a_sma5, buy5, sell5)
    fill_cell(dashboard, 4, 5, a_vwap5, buy5, sell5)
    fill_cell(dashboard, 5, 5, a_tema5, buy5, sell5)
