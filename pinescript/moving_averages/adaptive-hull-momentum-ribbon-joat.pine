// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © officialjackofalltrades
//@version=6
indicator("Adaptive Hull Momentum Ribbon [JOAT]", shorttitle="AHM [JOAT]", overlay=true)

// ═══════════════════════════════════════════════════════════════════════════════
// ADAPTIVE HULL MOMENTUM RIBBON [JOAT]
// Professional 5-Layer HMA Ribbon with EMA Cloud & Trend Strength Analytics
// Features Golden/Death Cross Detection, MA Alignment Scoring & Dynamic Confluence Zones
// ═══════════════════════════════════════════════════════════════════════════════

// ────────────────────────────────────────────────────────────────────────────────
// INPUTS
// ────────────────────────────────────────────────────────────────────────────────

// HMA Ribbon Settings
hmaGroup = "HMA Ribbon Settings"
showHMARibbon = input.bool(true, "Show HMA Ribbon", group=hmaGroup)
hmaLength1 = input.int(8, "HMA 1", minval=1, group=hmaGroup)
hmaLength2 = input.int(13, "HMA 2", minval=1, group=hmaGroup)
hmaLength3 = input.int(21, "HMA 3", minval=1, group=hmaGroup)
hmaLength4 = input.int(34, "HMA 4", minval=1, group=hmaGroup)
hmaLength5 = input.int(55, "HMA 5", minval=1, group=hmaGroup)

// EMA Cloud Settings
emaGroup = "EMA Cloud Settings"
showEMACloud = input.bool(true, "Show EMA Cloud", group=emaGroup)
emaFast = input.int(9, "Fast EMA", minval=1, group=emaGroup)
emaSlow = input.int(21, "Slow EMA", minval=1, group=emaGroup)

// Key Moving Averages
keyMAGroup = "Key Moving Averages"
showSMA50 = input.bool(true, "Show SMA 50", group=keyMAGroup)
showSMA200 = input.bool(true, "Show SMA 200", group=keyMAGroup)
showEMA200 = input.bool(true, "Show EMA 200", group=keyMAGroup)

// Trend Strength
trendGroup = "Trend Strength"
showTrendStrength = input.bool(true, "Show Trend Strength", group=trendGroup)
trendLength = input.int(20, "Trend Length", minval=5, group=trendGroup)

// Display Options
displayGroup = "Display Options"
ribbonTransparency = input.int(70, "Ribbon Transparency", minval=0, maxval=95, group=displayGroup)
showCrossovers = input.bool(true, "Show MA Crossovers", group=displayGroup)

// ────────────────────────────────────────────────────────────────────────────────
// COLOR DEFINITIONS
// ────────────────────────────────────────────────────────────────────────────────

// HMA Ribbon Colors (Green to Red gradient)
hmaColor1 = color.rgb(0, 255, 0)
hmaColor2 = color.rgb(102, 255, 102)
hmaColor3 = color.rgb(255, 255, 0)
hmaColor4 = color.rgb(255, 153, 0)
hmaColor5 = color.rgb(255, 0, 0)

// EMA Cloud Colors
emaCloudBull = color.rgb(76, 175, 80)
emaCloudBear = color.rgb(244, 67, 54)

// Key MA Colors
sma50Color = color.rgb(33, 150, 243)
sma200Color = color.rgb(255, 152, 0)
ema200Color = color.rgb(156, 39, 176)

// Trend Colors
strongBullColor = color.rgb(0, 255, 0)
weakBullColor = color.rgb(129, 199, 132)
strongBearColor = color.rgb(255, 0, 0)
weakBearColor = color.rgb(229, 115, 115)
neutralColor = color.rgb(158, 158, 158)

// ────────────────────────────────────────────────────────────────────────────────
// HULL MOVING AVERAGE CALCULATION
// ────────────────────────────────────────────────────────────────────────────────

hullMA(src, length) =>
    wma1 = ta.wma(src, length / 2)
    wma2 = ta.wma(src, length)
    ta.wma(2 * wma1 - wma2, int(math.sqrt(length)))

// Calculate HMAs
hma1 = hullMA(close, hmaLength1)
hma2 = hullMA(close, hmaLength2)
hma3 = hullMA(close, hmaLength3)
hma4 = hullMA(close, hmaLength4)
hma5 = hullMA(close, hmaLength5)

// HMA Trend Detection
hmaTrend = hma1 > hma2 and hma2 > hma3 and hma3 > hma4 and hma4 > hma5 ? 1 : hma1 < hma2 and hma2 < hma3 and hma3 < hma4 and hma4 < hma5 ? -1 : 0

// ────────────────────────────────────────────────────────────────────────────────
// EMA CLOUD
// ────────────────────────────────────────────────────────────────────────────────

emaFastLine = ta.ema(close, emaFast)
emaSlowLine = ta.ema(close, emaSlow)
emaCloudColor = emaFastLine > emaSlowLine ? emaCloudBull : emaCloudBear

// ────────────────────────────────────────────────────────────────────────────────
// KEY MOVING AVERAGES
// ────────────────────────────────────────────────────────────────────────────────

sma50 = ta.sma(close, 50)
sma200 = ta.sma(close, 200)
ema200 = ta.ema(close, 200)

// ────────────────────────────────────────────────────────────────────────────────
// TREND STRENGTH CALCULATION
// ────────────────────────────────────────────────────────────────────────────────

// Calculate alignment score
alignmentScore = 0
alignmentScore := (close > hma1 ? 1 : -1) +
                  (close > hma2 ? 1 : -1) +
                  (close > hma3 ? 1 : -1) +
                  (close > hma4 ? 1 : -1) +
                  (close > hma5 ? 1 : -1) +
                  (close > emaFastLine ? 1 : -1) +
                  (close > emaSlowLine ? 1 : -1) +
                  (close > sma50 ? 1 : -1) +
                  (close > sma200 ? 1 : -1)

// Normalize to 0-100
trendStrength = (alignmentScore + 9) / 18 * 100

// Trend classification
trendColor = trendStrength >= 75 ? strongBullColor : trendStrength >= 55 ? weakBullColor : trendStrength <= 25 ? strongBearColor : trendStrength <= 45 ? weakBearColor : neutralColor

// ────────────────────────────────────────────────────────────────────────────────
// CROSSOVER DETECTION
// ────────────────────────────────────────────────────────────────────────────────

// Golden Cross / Death Cross
goldenCross = ta.crossover(sma50, sma200)
deathCross = ta.crossunder(sma50, sma200)

// EMA Crossovers
emaBullCross = ta.crossover(emaFastLine, emaSlowLine)
emaBearCross = ta.crossunder(emaFastLine, emaSlowLine)

// HMA Fast Crossovers
hmaFastBullCross = ta.crossover(hma1, hma2)
hmaFastBearCross = ta.crossunder(hma1, hma2)

// ────────────────────────────────────────────────────────────────────────────────
// PLOTTING
// ────────────────────────────────────────────────────────────────────────────────

// HMA Ribbon
hma1Plot = plot(showHMARibbon ? hma1 : na, "HMA 8", color.new(hmaColor1, ribbonTransparency), 2)
hma2Plot = plot(showHMARibbon ? hma2 : na, "HMA 13", color.new(hmaColor2, ribbonTransparency), 2)
hma3Plot = plot(showHMARibbon ? hma3 : na, "HMA 21", color.new(hmaColor3, ribbonTransparency), 2)
hma4Plot = plot(showHMARibbon ? hma4 : na, "HMA 34", color.new(hmaColor4, ribbonTransparency), 2)
hma5Plot = plot(showHMARibbon ? hma5 : na, "HMA 55", color.new(hmaColor5, ribbonTransparency), 2)

// HMA Ribbon Fills
fill(hma1Plot, hma2Plot, color.new(hmaColor1, ribbonTransparency + 10), title="HMA Fill 1-2")
fill(hma2Plot, hma3Plot, color.new(hmaColor2, ribbonTransparency + 10), title="HMA Fill 2-3")
fill(hma3Plot, hma4Plot, color.new(hmaColor3, ribbonTransparency + 10), title="HMA Fill 3-4")
fill(hma4Plot, hma5Plot, color.new(hmaColor4, ribbonTransparency + 10), title="HMA Fill 4-5")

// EMA Cloud
emaFastPlot = plot(showEMACloud ? emaFastLine : na, "EMA Fast", color.new(emaCloudColor, 0), 2)
emaSlowPlot = plot(showEMACloud ? emaSlowLine : na, "EMA Slow", color.new(emaCloudColor, 0), 2)
fill(emaFastPlot, emaSlowPlot, color.new(emaCloudColor, 85), title="EMA Cloud")

// Key Moving Averages
plot(showSMA50 ? sma50 : na, "SMA 50", sma50Color, 3)
plot(showSMA200 ? sma200 : na, "SMA 200", sma200Color, 3)
plot(showEMA200 ? ema200 : na, "EMA 200", ema200Color, 3)

// Crossover Signals
plotshape(showCrossovers and goldenCross ? sma50 : na, "Golden Cross",
         shape.circle, location.absolute, color.new(strongBullColor, 0),
         size=size.normal, text="GC")

plotshape(showCrossovers and deathCross ? sma50 : na, "Death Cross",
         shape.circle, location.absolute, color.new(strongBearColor, 0),
         size=size.normal, text="DC")

plotshape(showCrossovers and emaBullCross ? emaFastLine : na, "EMA Bull Cross",
         shape.triangleup, location.absolute, color.new(emaCloudBull, 0),
         size=size.small)

plotshape(showCrossovers and emaBearCross ? emaFastLine : na, "EMA Bear Cross",
         shape.triangledown, location.absolute, color.new(emaCloudBear, 0),
         size=size.small)

plotshape(showCrossovers and hmaFastBullCross ? hma1 : na, "HMA Bull Cross",
         shape.diamond, location.absolute, color.new(hmaColor1, 0),
         size=size.tiny)

plotshape(showCrossovers and hmaFastBearCross ? hma1 : na, "HMA Bear Cross",
         shape.diamond, location.absolute, color.new(hmaColor5, 0),
         size=size.tiny)

// ────────────────────────────────────────────────────────────────────────────────
// ENHANCED INFORMATION TABLE WITH CONFLUENCE SCORE
// ────────────────────────────────────────────────────────────────────────────────

var table infoTable = table.new(position.top_right, 2, 9,
                                 bgcolor=color.new(color.black, 85),
                                 frame_color=color.new(color.gray, 50),
                                 frame_width=1,
                                 border_width=1,
                                 border_color=color.new(color.gray, 50))

if barstate.islast and showTrendStrength
    table.cell(infoTable, 0, 0, "MA System", bgcolor=color.new(color.gray, 70), text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, "Status", bgcolor=color.new(color.gray, 70), text_color=color.white, text_size=size.small)
    
    table.cell(infoTable, 0, 1, "Trend", text_color=color.white, text_size=size.small)
    trendText = trendStrength >= 75 ? "STRONG BULL" : trendStrength >= 55 ? "BULL" : trendStrength <= 25 ? "STRONG BEAR" : trendStrength <= 45 ? "BEAR" : "NEUTRAL"
    table.cell(infoTable, 1, 1, trendText, bgcolor=color.new(trendColor, 30), text_color=color.white, text_size=size.small)
    
    table.cell(infoTable, 0, 2, "Strength", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 2, str.tostring(trendStrength, "#.#") + "%", text_color=color.white, text_size=size.small)
    
    table.cell(infoTable, 0, 3, "HMA Align", text_color=color.white, text_size=size.small)
    hmaAlignText = hmaTrend == 1 ? "Bullish" : hmaTrend == -1 ? "Bearish" : "Mixed"
    hmaAlignColor = hmaTrend == 1 ? color.new(strongBullColor, 30) : hmaTrend == -1 ? color.new(strongBearColor, 30) : color.new(neutralColor, 30)
    table.cell(infoTable, 1, 3, hmaAlignText, bgcolor=hmaAlignColor, text_color=color.white, text_size=size.small)
    
    table.cell(infoTable, 0, 4, "EMA Cloud", text_color=color.white, text_size=size.small)
    emaCloudText = emaFastLine > emaSlowLine ? "Bullish" : "Bearish"
    table.cell(infoTable, 1, 4, emaCloudText, bgcolor=color.new(emaCloudColor, 30), text_color=color.white, text_size=size.small)
    
    table.cell(infoTable, 0, 5, "Price vs 200", text_color=color.white, text_size=size.small)
    priceVs200 = close > sma200 ? "Above" : "Below"
    priceVs200Color = close > sma200 ? color.new(strongBullColor, 30) : color.new(strongBearColor, 30)
    table.cell(infoTable, 1, 5, priceVs200, bgcolor=priceVs200Color, text_color=color.white, text_size=size.small)
    
    table.cell(infoTable, 0, 6, "50 vs 200", text_color=color.white, text_size=size.small)
    ma50vs200 = sma50 > sma200 ? "Golden" : "Death"
    ma50vs200Color = sma50 > sma200 ? color.new(strongBullColor, 30) : color.new(strongBearColor, 30)
    table.cell(infoTable, 1, 6, ma50vs200, bgcolor=ma50vs200Color, text_color=color.white, text_size=size.small)
    
    // Confluence Score
    confluenceScore = 0
    confluenceScore := (hmaTrend == 1 ? 3 : hmaTrend == -1 ? -3 : 0) +
                       (emaFastLine > emaSlowLine ? 2 : -2) +
                       (close > sma50 ? 1 : -1) +
                       (close > sma200 ? 2 : -2) +
                       (sma50 > sma200 ? 2 : -2)
    
    table.cell(infoTable, 0, 7, "Confluence", text_color=color.white, text_size=size.small)
    confluenceText = math.abs(confluenceScore) >= 8 ? "STRONG" : math.abs(confluenceScore) >= 5 ? "MODERATE" : "WEAK"
    confluenceColor = confluenceScore >= 8 ? color.new(strongBullColor, 20) : confluenceScore >= 5 ? color.new(weakBullColor, 30) : confluenceScore <= -8 ? color.new(strongBearColor, 20) : confluenceScore <= -5 ? color.new(weakBearColor, 30) : color.new(neutralColor, 50)
    table.cell(infoTable, 1, 7, confluenceText, bgcolor=confluenceColor, text_color=color.white, text_size=size.small)
    
    table.cell(infoTable, 0, 8, "Score", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 8, str.tostring(confluenceScore), text_color=color.white, text_size=size.small)

// ────────────────────────────────────────────────────────────────────────────────
// ENHANCED ALERTS WITH CONFLUENCE DETECTION
// ────────────────────────────────────────────────────────────────────────────────

alertcondition(goldenCross, "Golden Cross", "SMA 50 crossed above SMA 200 - Major bullish signal")
alertcondition(deathCross, "Death Cross", "SMA 50 crossed below SMA 200 - Major bearish signal")
alertcondition(emaBullCross, "EMA Bullish Cross", "Fast EMA crossed above Slow EMA")
alertcondition(emaBearCross, "EMA Bearish Cross", "Fast EMA crossed below Slow EMA")
alertcondition(hmaFastBullCross, "HMA Bullish Cross", "HMA 8 crossed above HMA 13")
alertcondition(hmaFastBearCross, "HMA Bearish Cross", "HMA 8 crossed below HMA 13")
alertcondition(hmaTrend == 1 and hmaTrend[1] != 1, "HMA Full Alignment Bull", "All HMAs aligned bullish - Strong trend")
alertcondition(hmaTrend == -1 and hmaTrend[1] != -1, "HMA Full Alignment Bear", "All HMAs aligned bearish - Strong trend")
alertcondition(trendStrength > 75 and trendStrength[1] <= 75, "Strong Bullish Trend", "Trend strength crossed above 75%")
alertcondition(trendStrength < 25 and trendStrength[1] >= 25, "Strong Bearish Trend", "Trend strength crossed below 25%")
alertcondition(close > sma200 and close[1] <= sma200, "Price Above 200 SMA", "Price crossed above 200 SMA")
alertcondition(close < sma200 and close[1] >= sma200, "Price Below 200 SMA", "Price crossed below 200 SMA")
alertcondition(goldenCross and hmaTrend == 1, "MEGA Bullish Signal", "Golden Cross + HMA Alignment - Extremely bullish")
alertcondition(deathCross and hmaTrend == -1, "MEGA Bearish Signal", "Death Cross + HMA Alignment - Extremely bearish")
