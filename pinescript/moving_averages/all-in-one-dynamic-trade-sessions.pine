//@version=5
indicator("Fusion Strategy V5 [Dynamic Trade Sessions]", overlay=true, max_lines_count=500, max_labels_count=500)

// --- 1. SETTINGS ---
// Strategy Settings
ema_len = input.int(50, "Trend Filter (EMA)")
rsi_len = input.int(7, "RSI Length")
atr_len = input.int(14, "ATR Length (Risk)")
rr_ratio = input.float(2.0, "Risk:Reward Ratio")

// --- 2. CALCULATIONS ---
// Trend & Momentum
trend_ema = ta.ema(close, ema_len)
rsi = ta.rsi(close, rsi_len)
atr = ta.atr(atr_len)
[macdLine, signalLine, _] = ta.macd(close, 12, 26, 9)

// --- 3. DYNAMIC SESSION LOGIC ---
// A "Trade Session" is defined by MOMENTUM, not time.
// If RSI is stuck between 45 and 55, the session is CLOSED (Chop).
// If RSI breaks out, the session is OPEN.

is_chop = rsi > 45 and rsi < 55
is_trending = not is_chop

// Count how long the current session has lasted
var int session_duration = 0
if is_trending
    session_duration := session_duration + 1
else
    session_duration := 0

// Background Colors for Dynamic Sessions
// Blue = Active Trade Session (Momentum is present)
// Grey = Dead Zone (Chop)
bgcolor(is_trending ? color.new(color.blue, 90) : color.new(color.gray, 90))

// --- 4. TRADE SIGNALS ---
// Long Condition
long_cond = ta.crossover(macdLine, signalLine) and close > trend_ema and rsi > 50 and is_trending

// Short Condition
short_cond = ta.crossunder(macdLine, signalLine) and close < trend_ema and rsi < 50 and is_trending

// --- 5. VISUALS ---
// Color Bars based on session status
barcolor(is_chop ? color.gray : na)

// Plot Trend Line
plot(trend_ema, "Trend EMA", color=color.white, linewidth=2)

// --- 6. TRADE MANAGEMENT & LABELS ---
var float entry_price = na
var float stop_price = na
var float tp_price = na

if long_cond
    entry_price := close
    stop_price := close - (atr * 1.5)
    dist = close - stop_price
    tp_price := close + (dist * rr_ratio)
    
    // Labels
    label.new(bar_index, stop_price, "1. SL: " + str.tostring(stop_price, format.mintick), color=color.red, style=label.style_label_up, textcolor=color.white, size=size.small)
    label.new(bar_index, entry_price, "2. ENTRY: " + str.tostring(entry_price, format.mintick), color=color.blue, style=label.style_label_left, textcolor=color.white, size=size.small)
    label.new(bar_index, tp_price, "3. TP: " + str.tostring(tp_price, format.mintick), color=color.green, style=label.style_label_down, textcolor=color.white, size=size.small)
    label.new(bar_index, tp_price, "4. RR: 1:" + str.tostring(rr_ratio), color=color.new(color.yellow, 0), style=label.style_label_lower_right, textcolor=color.black, size=size.small)

if short_cond
    entry_price := close
    stop_price := close + (atr * 1.5)
    dist = stop_price - close
    tp_price := close - (dist * rr_ratio)

    // Labels
    label.new(bar_index, stop_price, "1. SL: " + str.tostring(stop_price, format.mintick), color=color.red, style=label.style_label_down, textcolor=color.white, size=size.small)
    label.new(bar_index, entry_price, "2. ENTRY: " + str.tostring(entry_price, format.mintick), color=color.blue, style=label.style_label_left, textcolor=color.white, size=size.small)
    label.new(bar_index, tp_price, "3. TP: " + str.tostring(tp_price, format.mintick), color=color.green, style=label.style_label_up, textcolor=color.white, size=size.small)
    label.new(bar_index, tp_price, "4. RR: 1:" + str.tostring(rr_ratio), color=color.new(color.yellow, 0), style=label.style_label_upper_right, textcolor=color.black, size=size.small)

// --- 7. INTELLIGENT DASHBOARD ---
var tbl = table.new(position.top_right, 2, 7, bgcolor=color.new(color.black, 40), frame_color=color.gray, frame_width=1)

// Determine Session Status Text
string sess_txt = "DEAD / CHOP"
color sess_col = color.gray

if is_trending
    sess_txt := "ACTIVE: " + str.tostring(session_duration) + " BARS"
    sess_col := color.blue
else
    sess_txt := "WAITING..."
    sess_col := color.gray

// Determine Trend Status
string status_txt = "NEUTRAL"
color status_bg = color.gray

if close > trend_ema
    status_txt := "BULLISH"
    status_bg := color.green
else
    status_txt := "BEARISH"
    status_bg := color.red

if barstate.islast
    // Header
    table.cell(tbl, 0, 0, "FUSION V5", text_color=color.white, bgcolor=color.black)
    
    // Row 1: Session Duration (NEW)
    table.cell(tbl, 0, 1, "MOMENTUM SESSION", text_color=color.white, bgcolor=sess_col)
    table.cell(tbl, 1, 1, sess_txt, text_color=color.white, bgcolor=sess_col)

    // Row 2: Market Status
    table.cell(tbl, 0, 2, "TREND", text_color=color.white, bgcolor=status_bg)
    table.cell(tbl, 1, 2, status_txt, text_color=color.white, bgcolor=status_bg)
    
    // Row 3: Stop Loss
    table.cell(tbl, 0, 3, "1. STOP LOSS", text_color=color.red)
    table.cell(tbl, 1, 3, str.tostring(stop_price, format.mintick), text_color=color.red)

    // Row 4: Entry
    table.cell(tbl, 0, 4, "2. ENTRY", text_color=color.white)
    table.cell(tbl, 1, 4, str.tostring(entry_price, format.mintick), text_color=color.white)
    
    // Row 5: Take Profit
    table.cell(tbl, 0, 5, "3. TAKE PROFIT", text_color=color.green)
    table.cell(tbl, 1, 5, str.tostring(tp_price, format.mintick), text_color=color.green)
    
    // Row 6: RR Ratio
    table.cell(tbl, 0, 6, "4. RR RATIO", text_color=color.yellow)
    table.cell(tbl, 1, 6, "1 : " + str.tostring(rr_ratio), text_color=color.yellow)
