// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © mizu92

//@version=5
indicator("All-in-One VWAPs ", overlay=true, max_labels_count=500)

//────────────────────────────────────
// SOURCE
//────────────────────────────────────
src = hlc3

//────────────────────────────────────
// LABEL SETTINGS
//────────────────────────────────────
groupLabels     = "Labels"
showLabels      = input.bool(true, "Show Labels", group=groupLabels)
labelSizeOpt    = input.string("Small", "Label Size", options=["Tiny","Small","Normal","Large"], group=groupLabels)
labelOffsetBars = input.int(10, "Label Offset Right (bars)", minval=0, maxval=500, group=groupLabels)

labelSize = size.small
if labelSizeOpt == "Tiny"
    labelSize := size.tiny
else if labelSizeOpt == "Small"
    labelSize := size.small
else if labelSizeOpt == "Large"
    labelSize := size.large
else
    labelSize := size.normal

//────────────────────────────────────
// ANCHORED VWAP FUNCTION (break line on reset)
//────────────────────────────────────
f_vwap(_reset) =>
    var float cumPV = 0.0
    var float cumV  = 0.0
    float result = na

    if barstate.isfirst
        cumPV := 0.0
        cumV  := 0.0

    if _reset
        cumPV := volume * src
        cumV  := volume
        result := na
    else
        cumPV += volume * src
        cumV  += volume
        result := cumV > 0 ? cumPV / cumV : na

    result

//────────────────────────────────────
// DAILY KEY FUNCTION (DST SAFE)
//────────────────────────────────────
f_dailyKey(_tz, _hour, _min) =>
    y  = year(time, _tz)
    mo = month(time, _tz)
    d  = dayofmonth(time, _tz)
    t0 = timestamp(_tz, y, mo, d, _hour, _min)
    time >= t0 ? t0 : t0 - 86400000

//────────────────────────────────────
// COLORS + WIDTHS
//────────────────────────────────────
groupStyle = "Style"
sessColor  = input.color(color.yellow, "Session Color", group=groupStyle)
weekColor  = input.color(color.black,  "Weekly Color",  group=groupStyle)
monthColor = input.color(color.purple, "Monthly Color", group=groupStyle)

nyColor    = input.color(color.green,  "NY Color",      group=groupStyle)
ldnColor   = input.color(color.orange, "London Color",  group=groupStyle)
asiaColor  = input.color(color.blue,   "Asia Color",    group=groupStyle)

aColor     = input.color(color.teal,   "Anchor A Color", group=groupStyle)
bColor     = input.color(color.red,    "Anchor B Color", group=groupStyle)

sessW  = input.int(2, "Session Width",  minval=1, maxval=5, group=groupStyle)
weekW  = input.int(2, "Weekly Width",   minval=1, maxval=5, group=groupStyle)
monthW = input.int(2, "Monthly Width",  minval=1, maxval=5, group=groupStyle)
nyW    = input.int(2, "NY Width",       minval=1, maxval=5, group=groupStyle)
ldnW   = input.int(2, "London Width",   minval=1, maxval=5, group=groupStyle)
asiaW  = input.int(2, "Asia Width",     minval=1, maxval=5, group=groupStyle)
aW     = input.int(2, "Anchor A Width", minval=1, maxval=5, group=groupStyle)
bW     = input.int(2, "Anchor B Width", minval=1, maxval=5, group=groupStyle)

//────────────────────────────────────
// Label text colors (per VWAP)  ✅ FIXED
//────────────────────────────────────
groupLabelColors = "Label Text Colors"
sessTxt  = input.color(color.yellow, "Session Text",  group=groupLabelColors)
weekTxt  = input.color(color.black,  "Weekly Text",   group=groupLabelColors)
monthTxt = input.color(color.purple, "Monthly Text",  group=groupLabelColors)
nyTxt    = input.color(color.green,  "NY Text",       group=groupLabelColors)
ldnTxt   = input.color(color.orange, "London Text",   group=groupLabelColors)
asiaTxt  = input.color(color.blue,   "Asia Text",     group=groupLabelColors)
aTxt     = input.color(color.teal,   "Anchor A Text", group=groupLabelColors)
bTxt     = input.color(color.red,    "Anchor B Text", group=groupLabelColors)

//────────────────────────────────────
// SESSION VWAP (default 17:00 now)
//────────────────────────────────────
groupSess = "Session VWAP"
showSess  = input.bool(true, "Show Session VWAP", group=groupSess)
sessHour  = input.int(17, "Reset Hour", minval=0, maxval=23, group=groupSess)
sessMin   = input.int(0,  "Reset Minute", minval=0, maxval=59, group=groupSess)
sessTZOpt = input.string("Exchange", "Timezone", options=["Exchange","America/New_York","America/Chicago","UTC"], group=groupSess)

sessTZ    = sessTZOpt == "Exchange" ? syminfo.timezone : sessTZOpt
sessKey   = f_dailyKey(sessTZ, sessHour, sessMin)
sessReset = ta.change(sessKey)
sessVWAP  = showSess ? f_vwap(sessReset) : na

//────────────────────────────────────
// WEEKLY / MONTHLY VWAP
//────────────────────────────────────
groupWeek = "Weekly VWAP"
showWeek  = input.bool(true, "Show Weekly VWAP", group=groupWeek)
weekKey   = year * 100 + weekofyear
weekReset = ta.change(weekKey)
weekVWAP  = showWeek ? f_vwap(weekReset) : na

groupMonth = "Monthly VWAP"
showMonth  = input.bool(true, "Show Monthly VWAP", group=groupMonth)
monthKey   = year * 100 + month
monthReset = ta.change(monthKey)
monthVWAP  = showMonth ? f_vwap(monthReset) : na

//────────────────────────────────────
// NY / LONDON / ASIA VWAP
//────────────────────────────────────
groupNY = "New York VWAP"
showNY  = input.bool(true, "Show NY VWAP", group=groupNY)
nyHour  = input.int(9,  "Start Hour", minval=0, maxval=23, group=groupNY)
nyMin   = input.int(30, "Start Minute", minval=0, maxval=59, group=groupNY)
nyTZOpt = input.string("America/New_York", "Timezone", options=["Exchange","America/New_York","America/Chicago","UTC"], group=groupNY)
nyTZ    = nyTZOpt == "Exchange" ? syminfo.timezone : nyTZOpt
nyKey   = f_dailyKey(nyTZ, nyHour, nyMin)
nyReset = ta.change(nyKey)
nyVWAP  = showNY ? f_vwap(nyReset) : na

groupLDN = "London VWAP"
showLDN  = input.bool(true, "Show London VWAP", group=groupLDN)
ldnHour  = input.int(2, "Start Hour", minval=0, maxval=23, group=groupLDN)
ldnMin   = input.int(0, "Start Minute", minval=0, maxval=59, group=groupLDN)
ldnTZOpt = input.string("America/New_York", "Timezone", options=["Exchange","America/New_York","Europe/London","UTC"], group=groupLDN)
ldnTZ    = ldnTZOpt == "Exchange" ? syminfo.timezone : ldnTZOpt
ldnKey   = f_dailyKey(ldnTZ, ldnHour, ldnMin)
ldnReset = ta.change(ldnKey)
ldnVWAP  = showLDN ? f_vwap(ldnReset) : na

groupAsia = "Asia VWAP"
showAsia  = input.bool(true, "Show Asia VWAP", group=groupAsia)
asiaHour  = input.int(19, "Start Hour", minval=0, maxval=23, group=groupAsia)
asiaMin   = input.int(0,  "Start Minute", minval=0, maxval=59, group=groupAsia)
asiaTZOpt = input.string("America/New_York", "Timezone", options=["Exchange","America/New_York","Asia/Tokyo","UTC"], group=groupAsia)
asiaTZ    = asiaTZOpt == "Exchange" ? syminfo.timezone : asiaTZOpt
asiaKey   = f_dailyKey(asiaTZ, asiaHour, asiaMin)
asiaReset = ta.change(asiaKey)
asiaVWAP  = showAsia ? f_vwap(asiaReset) : na

//────────────────────────────────────
// ANCHOR A / ANCHOR B VWAP (Custom Times)
//────────────────────────────────────
groupA  = "Anchor A VWAP (Custom Time)"
showA   = input.bool(true, "Show Anchor A VWAP", group=groupA)
aHour   = input.int(9, "Anchor Hour", minval=0, maxval=23, group=groupA)
aMin    = input.int(0, "Anchor Minute", minval=0, maxval=59, group=groupA)
aTZOpt  = input.string("Exchange", "Timezone", options=["Exchange","America/New_York","America/Chicago","UTC"], group=groupA)
aTZ     = aTZOpt == "Exchange" ? syminfo.timezone : aTZOpt
aKey    = f_dailyKey(aTZ, aHour, aMin)
aReset  = ta.change(aKey)
aVWAP   = showA ? f_vwap(aReset) : na

groupB  = "Anchor B VWAP (Custom Time)"
showB   = input.bool(true, "Show Anchor B VWAP", group=groupB)
bHour   = input.int(8, "Anchor Hour", minval=0, maxval=23, group=groupB)
bMin    = input.int(30, "Anchor Minute", minval=0, maxval=59, group=groupB)
bTZOpt  = input.string("Exchange", "Timezone", options=["Exchange","America/New_York","America/Chicago","UTC"], group=groupB)
bTZ     = bTZOpt == "Exchange" ? syminfo.timezone : bTZOpt
bKey    = f_dailyKey(bTZ, bHour, bMin)
bReset  = ta.change(bKey)
bVWAP   = showB ? f_vwap(bReset) : na

//────────────────────────────────────
// PLOTS
//────────────────────────────────────
plot(sessVWAP,  "Session VWAP",  style=plot.style_linebr, linewidth=sessW,  color=sessColor)
plot(weekVWAP,  "Weekly VWAP",   style=plot.style_linebr, linewidth=weekW,  color=weekColor)
plot(monthVWAP, "Monthly VWAP",  style=plot.style_linebr, linewidth=monthW, color=monthColor)

plot(nyVWAP,    "NY VWAP",       style=plot.style_linebr, linewidth=nyW,    color=nyColor)
plot(ldnVWAP,   "London VWAP",   style=plot.style_linebr, linewidth=ldnW,   color=ldnColor)
plot(asiaVWAP,  "Asia VWAP",     style=plot.style_linebr, linewidth=asiaW,  color=asiaColor)

plot(aVWAP,     "Anchor A VWAP", style=plot.style_linebr, linewidth=aW,     color=aColor)
plot(bVWAP,     "Anchor B VWAP", style=plot.style_linebr, linewidth=bW,     color=bColor)

//────────────────────────────────────
// LABELS (TEXT ONLY, OFFSET TO THE RIGHT)
//────────────────────────────────────
var label lSess  = na
var label lWeek  = na
var label lMonth = na
var label lNY    = na
var label lLDN   = na
var label lAsia  = na
var label lA     = na
var label lB     = na

if barstate.islast and showLabels
    x = bar_index + labelOffsetBars

    if showSess and not na(sessVWAP)
        if na(lSess)
            lSess := label.new(x, sessVWAP, "Session", style=label.style_none, textcolor=sessTxt, size=labelSize)
        label.set_xy(lSess, x, sessVWAP)
        label.set_text(lSess, "Session")
        label.set_textcolor(lSess, sessTxt)
        label.set_size(lSess, labelSize)

    if showWeek and not na(weekVWAP)
        if na(lWeek)
            lWeek := label.new(x, weekVWAP, "Weekly", style=label.style_none, textcolor=weekTxt, size=labelSize)
        label.set_xy(lWeek, x, weekVWAP)
        label.set_text(lWeek, "Weekly")
        label.set_textcolor(lWeek, weekTxt)
        label.set_size(lWeek, labelSize)

    if showMonth and not na(monthVWAP)
        if na(lMonth)
            lMonth := label.new(x, monthVWAP, "Monthly", style=label.style_none, textcolor=monthTxt, size=labelSize)
        label.set_xy(lMonth, x, monthVWAP)
        label.set_text(lMonth, "Monthly")
        label.set_textcolor(lMonth, monthTxt)
        label.set_size(lMonth, labelSize)

    if showNY and not na(nyVWAP)
        if na(lNY)
            lNY := label.new(x, nyVWAP, "NY", style=label.style_none, textcolor=nyTxt, size=labelSize)
        label.set_xy(lNY, x, nyVWAP)
        label.set_text(lNY, "NY")
        label.set_textcolor(lNY, nyTxt)
        label.set_size(lNY, labelSize)

    if showLDN and not na(ldnVWAP)
        if na(lLDN)
            lLDN := label.new(x, ldnVWAP, "London", style=label.style_none, textcolor=ldnTxt, size=labelSize)
        label.set_xy(lLDN, x, ldnVWAP)
        label.set_text(lLDN, "London")
        label.set_textcolor(lLDN, ldnTxt)
        label.set_size(lLDN, labelSize)

    if showAsia and not na(asiaVWAP)
        if na(lAsia)
            lAsia := label.new(x, asiaVWAP, "Asia", style=label.style_none, textcolor=asiaTxt, size=labelSize)
        label.set_xy(lAsia, x, asiaVWAP)
        label.set_text(lAsia, "Asia")
        label.set_textcolor(lAsia, asiaTxt)
        label.set_size(lAsia, labelSize)

    if showA and not na(aVWAP)
        if na(lA)
            lA := label.new(x, aVWAP, "Anchor A", style=label.style_none, textcolor=aTxt, size=labelSize)
        label.set_xy(lA, x, aVWAP)
        label.set_text(lA, "Anchor A")
        label.set_textcolor(lA, aTxt)
        label.set_size(lA, labelSize)

    if showB and not na(bVWAP)
        if na(lB)
            lB := label.new(x, bVWAP, "Anchor B", style=label.style_none, textcolor=bTxt, size=labelSize)
        label.set_xy(lB, x, bVWAP)
        label.set_text(lB, "Anchor B")
        label.set_textcolor(lB, bTxt)
        label.set_size(lB, labelSize)
