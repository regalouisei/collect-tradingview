// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Since 2020 Zofesu

//@version=6
indicator("Smart Trend [Zofesu]", overlay=true, shorttitle="Zofesu - SmartTrend")

// --- INPUTS ---
group_trend   = "Trend Core Settings"
atr_length    = input.int(30, title="ATR Period", group=group_trend)
multiplier    = input.float(1.8, title="Volatility Multiplier", step=0.1, group=group_trend)

group_filter = "The Great Filter (Main Trend)"
use_filter   = input.bool(true, title="Enable Main Trend Filter?", group=group_filter)
filter_len   = input.int(200, title="Main Trend Smoothness (HMA)", group=group_filter)
show_bg      = input.bool(true, title="Show Background Bias Tint?", group=group_filter)

group_vol    = "Volume Confirmation"
use_vol      = input.bool(true, title="Require Volume Confirmation?", group=group_vol)
vol_pct_target = input.int(80, title="Volume Percentile Rank (%)", minval=1, maxval=100, group=group_vol)

// --- CALCULATIONS ---
atr = ta.atr(atr_length)
v_rank = ta.percentrank(volume, 200)

// Main Filter (Hull Moving Average)
main_trend_ma = ta.hma(close, filter_len)
main_trend_bull = close > main_trend_ma
main_trend_bear = close < main_trend_ma

// Trend Engine Logic
var float trend_line = na
var int trend_dir = 1 

float upper_band = high - (atr * multiplier)
float lower_band = low + (atr * multiplier)

bool vol_confirmed = not use_vol or v_rank > vol_pct_target

if na(trend_line)
    trend_line := upper_band

if trend_dir == 1
    if close < trend_line and vol_confirmed
        trend_dir := -1
        trend_line := lower_band
    else
        trend_line := math.max(nz(trend_line[1]), upper_band)
else
    if close > trend_line and vol_confirmed
        trend_dir := 1
        trend_line := upper_band
    else
        trend_line := math.min(nz(trend_line[1]), lower_band)

// --- VISUALIZATION ---
bg_color = show_bg ? (main_trend_bull ? color.new(#00ffbb, 95) : color.new(#ff0055, 95)) : na
bgcolor(bg_color, title="Trend Bias Background")

line_color = trend_dir == 1 ? color.new(#00ffbb, 0) : color.new(#ff0055, 0)
final_line_col = use_filter ? (trend_dir == 1 and not main_trend_bull ? color.new(color.gray, 50) : trend_dir == -1 and not main_trend_bear ? color.new(color.gray, 50) : line_color) : line_color

plot(trend_line, "Trend Line", color=final_line_col, linewidth=2, style=plot.style_linebr)

// Strategy Signals
bool show_long  = (trend_dir == 1 and trend_dir[1] == -1) and (not use_filter or main_trend_bull)
bool show_short = (trend_dir == -1 and trend_dir[1] == 1) and (not use_filter or main_trend_bear)

plotshape(show_long, "Long Entry", shape.triangleup, location.belowbar, color.new(#00ffbb, 0), size=size.small, text="BUY", textcolor=color.white)
plotshape(show_short, "Short Entry", shape.triangledown, location.abovebar, color.new(#ff0055, 0), size=size.small, text="SELL", textcolor=color.white)

plot(use_filter ? main_trend_ma : na, "Main Trend Reference", color=color.new(color.white, 80), linewidth=1, style=plot.style_line)

// --- ALERT CONDITION LOGIC ---
alertcondition(show_long, title="Trend Engine: BUY Signal", message="Trend Engine Buy Signal on {{ticker}}")
alertcondition(show_short, title="Trend Engine: SELL Signal", message="Trend Engine Sell Signal on {{ticker}}")
