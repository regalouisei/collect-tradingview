//@version=6
strategy("TEMACD", "TEMACD", overlay=true, max_bars_back=5000, initial_capital=1000, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

import TradingView/ta/9 as ta

// - - - - - INPUTS - - - - - //{
var string G1 = "EMA Settings"
var string G2 = "MACD Settings"
var string G3 = "Strategy Settings"
var string G4 = "Backtesting Table Settings"

// EMA Settings
int ema1_length = input.int(9, "EMA 1 Length", minval=1, group=G1)
int ema2_length = input.int(21, "EMA 2 Length", minval=1, group=G1)
int ema3_length = input.int(50, "EMA 3 Length", minval=1, group=G1)
int ema2001 = input.int (200, "display ema" , minval=2)

// MACD Settings
int macd_fast = input.int(12, "MACD Fast Length", minval=1, group=G2)
int macd_slow = input.int(26, "MACD Slow Length", minval=1, group=G2)
int macd_signal = input.int(9, "MACD Signal Length", minval=1, group=G2)

// Strategy Settings
string signals = input.string("Long & Short", "Allowed Signals", options=["Long & Short", "Long Only", "Short Only"], group=G3)

// Backtesting Table Settings
string disp_ind = input.string("Equity", "Display Indicator", options=["Equity", "Open Profit", "Gross Profit", "Net Profit"], group=G4)
color disp_col = input.color(color.yellow, "Display Color", group=G4)
//}

// - - - - - CALCULATIONS - - - - - //{
// Calculate 3 EMAs
ema1 = ta.ema(close, ema1_length)
ema2 = ta.ema(close, ema2_length)
ema3 = ta.ema(close, ema3_length)
ema200 = ta.ema(close, ema2001)

// EMA Crossovers
cross_1_above_2 = ta.crossover(ema1, ema2)
cross_1_above_3 = ta.crossover(ema1, ema3)
cross_2_above_3 = ta.crossover(ema2, ema3)
cross_1_below_2 = ta.crossunder(ema1, ema2)
cross_1_below_3 = ta.crossunder(ema1, ema3)
cross_2_below_3 = ta.crossunder(ema2, ema3)

// Calculate MACD
[macd_line, signal_line, hist_line] = ta.macd(close, macd_fast, macd_slow, macd_signal)

// MACD Signals
macd_long = ta.crossover(macd_line, signal_line)
macd_short = ta.crossunder(macd_line, signal_line)

// Combined entry signals - Any EMA crosses OR MACD goes long
long_entry = cross_1_above_2 or cross_1_above_3 or cross_2_above_3 or macd_long

// Combined exit signals - Any EMA crosses opposite OR MACD goes short
long_exit = cross_1_below_2 or cross_1_below_3 or cross_2_below_3 or macd_short

// Short entry signals - Any EMA crosses below OR MACD goes short
short_entry = cross_1_below_2 or cross_1_below_3 or cross_2_below_3 or macd_short

// Short exit signals - Any EMA crosses above OR MACD goes long
short_exit = cross_1_above_2 or cross_1_above_3 or cross_2_above_3 or macd_long
//}

// - - - - - PLOTS - - - - - //{
plot(ema1, title="EMA 1", color=color.blue, linewidth=1)
plot(ema2, title="EMA 2", color=color.orange, linewidth=1)
plot(ema3, title="EMA 3", color=color.red, linewidth=2)

// Bar colors based on trend
ema200long = (long_entry)
ema200short = (short_entry)

bgcolor(long_entry ? color.green : short_entry ? color.red : na)
//}

// - - - - - STRATEGY LOGIC - - - - - //{
// Close positions when exit signal appears
if strategy.position_size > 0 and long_exit
    strategy.close_all()

if strategy.position_size < 0 and short_exit
    strategy.close_all()

// Enter long positions
if (signals == "Long Only" or signals == "Long & Short") and long_entry
    strategy.entry("Long", strategy.long)

// Enter short positions
if (signals == "Short Only" or signals == "Long & Short") and short_entry
    strategy.entry("Short", strategy.short)
//}

// - - - - - BACKTESTING TABLE - - - - - //{
// DISPLAY DATA
plot_equity = plot(disp_ind == "Equity" ? strategy.equity/strategy.initial_capital : na, color=disp_col, title="strategy Equity")
plot_op = plot(disp_ind == "Open Profit" ? strategy.openprofit : na, color=disp_col, title="Open Profit")
plot_gp = plot(disp_ind == "Gross Profit" ? strategy.grossprofit : na, color=disp_col, title="Gross Profit")
plot_np = plot(disp_ind == "Net Profit" ? strategy.netprofit : na, color=disp_col, title="Net Profit")

truncate(number, decimals) =>
    factor = math.pow(10, decimals)
    int(number * factor) / factor

// EQUITY DISPLAY TABLES
var table equityBox = table.new(position.top_center, 2, 1, bgcolor=color.new(color.black,100))
if barstate.islast
    if disp_ind == "Equity"
        table.cell(equityBox, 0, 0, "Equity", text_color=disp_col)
        table.cell(equityBox, 1, 0, str.tostring(truncate(strategy.equity/strategy.initial_capital, 2)) + "x", text_color=disp_col)

// PERFORMANCE STATS
max_dd = 0.
max_eq = strategy.equity
max_eq := math.max(nz(max_eq[1]), strategy.equity)
max_dd := math.min(nz(max_dd[1]), strategy.equity/max_eq - 1)

var max_dd_table = table.new(position=position.middle_left, columns=1, rows=2, bgcolor=color.yellow, border_width=1)
if barstate.islast
    table.cell(max_dd_table, 0, 0, "Max DD")
    table.cell(max_dd_table, 0, 1, str.tostring(math.ceil(max_dd * 1000)/10) + "%")

maxTradeDrawDown() =>
    tradeEntryEquity = 0.0
    maxDrawdownPercent = 0.0
    for tradeNo = 0 to strategy.closedtrades-1
        maxDrawdownPercent := math.max(maxDrawdownPercent, (strategy.closedtrades.max_drawdown(tradeNo)/(math.abs(strategy.closedtrades.size(tradeNo))*strategy.closedtrades.entry_price(tradeNo))*100))
    maxDrawdownPercent

AVG_bar() =>
    sumBarsPerTrade = 0
    for tradeNo = 0 to strategy.closedtrades - 1
        sumBarsPerTrade += strategy.closedtrades.exit_bar_index(tradeNo) - strategy.closedtrades.entry_bar_index(tradeNo) + 1
    nz(sumBarsPerTrade / strategy.closedtrades)

// RETURN CALCULATIONS
daily_return = strategy.equity/strategy.equity[1]-1
var returns_array = array.new<float>(0)
var negative_returns_array = array.new<float>(0)
var positive_returns_array = array.new<float>(0)

if year > 2017
    array.push(returns_array, daily_return)
    if daily_return <= 0.0
        array.push(negative_returns_array, daily_return)
        array.push(positive_returns_array, 0.0)
    else
        array.push(positive_returns_array, daily_return)
        array.push(negative_returns_array, 0.0)

// STATS CALCULATIONS
intrade_drawdown = strategy.closedtrades > 0 ? math.round(maxTradeDrawDown()*(-1),2) : 0.0
standard_deviation = array.size(returns_array) > 0 ? array.stdev(returns_array) : 0.0
negative_returns_standard_deviation = array.size(negative_returns_array) > 0 ? array.stdev(negative_returns_array) : 0.0
mean = array.size(returns_array) > 0 ? array.avg(returns_array) : 0.0
sharpe = standard_deviation > 0 ? math.round(mean/standard_deviation*math.sqrt(365),2) : 0.0
sortino = negative_returns_standard_deviation > 0 ? math.round(mean/negative_returns_standard_deviation*math.sqrt(365),2) : 0.0

// Omega (calculated but not displayed)
positive_area = array.sum(positive_returns_array)
negative_area = array.sum(negative_returns_array)*(-1)
positive_count = array.size(positive_returns_array)
negative_count = array.size(negative_returns_array)
annualized_positive = positive_count > 0 ? positive_area * 365 / positive_count : 0.0
annualized_negative = negative_count > 0 ? negative_area * 365 / negative_count : 0.0
omega = annualized_negative > 0 ? math.round(annualized_positive / annualized_negative, 2) : 0.0

// Other stats
trades = strategy.closedtrades
AVG_bar = trades > 0 ? math.round(AVG_bar()) : 0
profitable_percent = trades > 0 ? math.round(strategy.wintrades/trades*100,2) : 0.0
profit_factor = strategy.grossloss > 0 ? math.round(strategy.grossprofit/strategy.grossloss,2) : (strategy.grossprofit > 0 ? 999.0 : 0.0)

// SLAPPER PARAMETERS
intrade_drawdown_slap_value = -15
intrade_drawdown_low_value = -35
sharpe_slap_value = 1.75
sharpe_low_value = 1.0
sortino_slap_value = 2.0
sortino_low_value = 1.25
trades_slap_value = 25
trades_low_value = 10
trades_high_value = 80
profitable_slap_value = 55
profitable_low_value = 40
profit_factor_slap_value = 3
profit_factor_low_value = 1.5
AVG_Bar_slap_value_low = 20
AVG_Bar_slap_value_high = 80
omega_slap_value = 1.5
omega_low_value = 1.0

// TABLE (WITH OMEGA)
var stats_table = table.new(position=position.middle_left, columns=2, rows=8, bgcolor=color.yellow, border_width=1)

// DRAW TABLE (WITH OMEGA ROW) - Update on every bar
labels = array.from(
     "Max DD",
     "Sharpe",
     "Sortino",
     "Profit Factor",
     "Profitable %",
     "Trades",
     "AVG Bar",
     "Omega")

values = array.from(
     str.tostring(intrade_drawdown)+"%", 
     str.tostring(sharpe), 
     str.tostring(sortino), 
     str.tostring(profit_factor), 
     str.tostring(profitable_percent)+"%", 
     str.tostring(trades), 
     str.tostring(AVG_bar),
     str.tostring(omega))

raw_values = array.from(
     intrade_drawdown, 
     sharpe, 
     sortino, 
     profit_factor, 
     profitable_percent, 
     trades, 
     AVG_bar,
     omega)

green_thresh = array.from(
     intrade_drawdown_slap_value, 
     sharpe_slap_value, 
     sortino_slap_value, 
     profit_factor_slap_value, 
     profitable_slap_value, 
     trades_slap_value, 
     AVG_Bar_slap_value_low,
     omega_slap_value)

red_thresh = array.from(
     intrade_drawdown_low_value, 
     sharpe_low_value, 
     sortino_low_value, 
     profit_factor_low_value, 
     profitable_low_value, 
     trades_low_value, 
     AVG_Bar_slap_value_high,
     omega_low_value)

for j = 0 to array.size(labels)-1
    table.cell(stats_table, 0, j, array.get(labels, j), text_halign=text.align_left)
    table.cell(stats_table, 1, j, array.get(values, j), text_halign=text.align_right)
    raw = array.get(raw_values, j)
    green = array.get(green_thresh, j)
    red = array.get(red_thresh, j)
    if raw >= green
        table.cell_set_bgcolor(stats_table, 1, j, color.green)
    else if raw <= red
        table.cell_set_bgcolor(stats_table, 1, j, color.red)
//}
