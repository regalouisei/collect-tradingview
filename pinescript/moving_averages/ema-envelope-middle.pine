// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © ChannelFisher

//@version=6
indicator(title = 'EMA Envelope + Middle', shorttitle = 'Env + Mid', overlay = true)

len = input.int(20, title = 'Length', minval = 1)

a = close - ta.ema(close, len)
b = a < 0 ? a * -1 : a
d = ta.ema(b, len)

basis = ta.ema(close, len)

upper = basis + d
lower = basis - d

maxx   = math.max(upper, close)     // renamed to avoid keyword conflict
smooth = ta.ema(maxx, len)

minn   = math.min(close, lower)     // renamed to avoid keyword conflict
smooth2 = ta.ema(minn, len)

// Original-style plots for the bands (default appearance)
plot(smooth2)
plot(smooth)

// Aqua middle line between the two bands
middle = math.avg(smooth, smooth2)
plot(middle, "Middle", color = color.aqua, linewidth = 2, style = plot.style_stepline)
