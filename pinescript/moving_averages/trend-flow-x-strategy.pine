//@version=5
strategy("Trend flow X Strategy", overlay=true,overlay=true, pyramiding=0,  initial_capital=10000, default_qty_type=strategy.fixed, default_qty_value=120, commission_type=strategy.commission.percent, commission_value=0.01,  slippage=2 ,process_orders_on_close=true)

//──────────────────────────────
// Master Timeframe Fixed
//──────────────────────────────
masterTF = "15"  // Fixed 15 min timeframe

//──────────────────────────────
// Manual ADX
//──────────────────────────────
f_manual_adx(_high, _low, _close, _len) =>
    upMove = _high - _high[1]
    downMove = _low[1] - _low
    plusDM = (upMove > downMove and upMove > 0) ? upMove : 0.0
    minusDM = (downMove > upMove and downMove > 0) ? downMove : 0.0
    trur = ta.rma(ta.tr, _len)
    plusDI = 100 * ta.rma(plusDM, _len) / trur
    minusDI = 100 * ta.rma(minusDM, _len) / trur
    dx = 100 * math.abs(plusDI - minusDI) / (plusDI + minusDI + 1e-10)
    adx = ta.rma(dx, _len)
    [adx, plusDI, minusDI]

//──────────────────────────────
// Manual Williams %R
//──────────────────────────────
f_manual_wr(_high, _low, _close, _len) =>
    hh = ta.highest(_high, _len)
    ll = ta.lowest(_low, _len)
    rng = hh - ll
    -100 * (hh - _close) / (rng == 0 ? 1e-10 : rng)

//──────────────────────────────
// TF Scoring Function
//──────────────────────────────
f_score(tf) =>
    h = request.security(syminfo.tickerid, tf, high)
    l = request.security(syminfo.tickerid, tf, low)
    c = request.security(syminfo.tickerid, tf, close)

    ema20 = ta.ema(c, 20)
    ema50 = ta.ema(c, 50)
    sma20 = ta.sma(c, 20)
    sma50 = ta.sma(c, 50)
    rsi = ta.rsi(c, 14)

    [adx, plusDI, minusDI] = f_manual_adx(h, l, c, 14)
    wr = f_manual_wr(h, l, c, 14)

    macd = ta.ema(c, 12) - ta.ema(c, 26)
    signal = ta.ema(macd, 9)

    sc = 0
    sc += c > ema20 ? 1 : -1
    sc += c > ema50 ? 1 : -1
    sc += c > sma20 ? 1 : -1
    sc += c > sma50 ? 1 : -1
    sc += rsi > 55 ? 1 : rsi < 45 ? -1 : 0
    sc += macd > signal ? 1 : -1
    sc += adx > 20 and plusDI > minusDI ? 1 : adx > 20 and minusDI > plusDI ? -1 : 0
    sc += wr > -50 ? 1 : -1

    sc

//──────────────────────────────
// Use Master TF Score
//──────────────────────────────
score = f_score(masterTF)

buyCond = score > 0
sellCond = score < 0
neutral = score == 0

//──────────────────────────────
// START ONLY FROM YEAR 2024
//──────────────────────────────
allowTrade = year >= 2024

//──────────────────────────────
// Entries & Exits
//──────────────────────────────
if allowTrade and buyCond
    strategy.entry("Buy", strategy.long)

if allowTrade and sellCond
    strategy.entry("Sell", strategy.short)

if allowTrade and neutral
    strategy.close("Buy")
    strategy.close("Sell")

//──────────────────────────────
// Visuals
//──────────────────────────────
bgcolor(
     buyCond ? color.new(color.green,80) :
     sellCond ? color.new(color.red,80) :
     color.new(color.gray,85))

plot(score, title="Score", color=color.white)
hline(0, "Neutral", color=color.gray)

// Label for Master TF
var label tfLabel = label.new(bar_index, na, "", style=label.style_label_center, color=color.new(color.blue, 80), textcolor=color.white)

if barstate.islast
    label.set_xy(tfLabel, bar_index, score)
    label.set_text(tfLabel, "Master TF: " + masterTF + "min")
