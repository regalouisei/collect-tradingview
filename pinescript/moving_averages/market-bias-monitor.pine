// ░▒▓██████▓▒░ ░▒▓█▓▒░       ░▒▓█▓▒░░▒▓████████▓▒░░▒▓██████▓▒░ ░▒▓█▓▒░░▒▓█▓▒░ 
//░▒▓█▓▒░░▒▓█▓▒░░▒▓█▓▒░       ░▒▓█▓▒░   ░▒▓█▓▒░   ░▒▓█▓▒░░▒▓█▓▒░░▒▓█▓▒░░▒▓█▓▒░ 
//░▒▓█▓▒░       ░▒▓█▓▒░       ░▒▓█▓▒░   ░▒▓█▓▒░   ░▒▓█▓▒░       ░▒▓█▓▒░░▒▓█▓▒░ 
//░▒▓█▓▒▒▓███▓▒░░▒▓█▓▒░       ░▒▓█▓▒░   ░▒▓█▓▒░   ░▒▓█▓▒░       ░▒▓████████▓▒░ 
//░▒▓█▓▒░░▒▓█▓▒░░▒▓█▓▒░       ░▒▓█▓▒░   ░▒▓█▓▒░   ░▒▓█▓▒░       ░▒▓█▓▒░░▒▓█▓▒░ 
//░▒▓█▓▒░░▒▓█▓▒░░▒▓█▓▒░       ░▒▓█▓▒░   ░▒▓█▓▒░   ░▒▓█▓▒░░▒▓█▓▒░░▒▓█▓▒░░▒▓█▓▒░ 
// ░▒▓██████▓▒░ ░▒▓████████▓▒░░▒▓█▓▒░   ░▒▓█▓▒░    ░▒▓██████▓▒░ ░▒▓█▓▒░░▒▓█▓▒░ 
                                                                       
  
//The indicator determines market bias by analyzing three key EMAs (8, 21, and 50) across 
//10 different timeframes ranging from 15 minutes to weekly charts.

//To access other capable tools and trading strategies please visit www.glitch.capital

//@version=6
indicator('Market Bias Monitor', overlay = true)

// Input parameters for bias calculation
i_minTFAgreement = input.int(title = 'Minimum TFs in Agreement', defval = 5, minval = 1, maxval = 10)
i_showBackground = input.bool(title = 'Show Background Highlight', defval = true)
i_contrarian = input.bool(title = 'Contrarian Mode', defval = false, tooltip = 'When enabled, colors are reversed to highlight counter-trend opportunities')
i_bullColor = input.color(title = 'Bullish Background', defval = color.new(color.green, 90))
i_bearColor = input.color(title = 'Bearish Background', defval = color.new(color.red, 90))

// Input parameters for EMA display
i_showEMAs = input.bool(title = 'Show EMAs', defval = false, group = 'EMA Display')
i_ema8Color = input.color(title = 'EMA 8 Color', defval = color.blue, group = 'EMA Display')
i_ema21Color = input.color(title = 'EMA 21 Color', defval = color.yellow, group = 'EMA Display')
i_ema50Color = input.color(title = 'EMA 50 Color', defval = color.red, group = 'EMA Display')
i_ema8Width = input.int(title = 'EMA 8 Width', defval = 1, minval = 1, maxval = 4, group = 'EMA Display')
i_ema21Width = input.int(title = 'EMA 21 Width', defval = 1, minval = 1, maxval = 4, group = 'EMA Display')
i_ema50Width = input.int(title = 'EMA 50 Width', defval = 1, minval = 1, maxval = 4, group = 'EMA Display')

// Theme customization for text colors
i_headerBgColor = input.color(title = "Header Background Color", defval = color.gray, group = "Text Colors")
i_headerTextColor = input.color(title = "Header Text Color", defval = color.white, group = "Text Colors")
i_timeframeTextColor = input.color(title = "Timeframe Label Color", defval = color.black, group = "Text Colors")
i_biasTextColor = input.color(title = "Bias Text Color", defval = color.black, group = "Text Colors")

// EMA Lengths
ema8 = 8
ema21 = 21
ema50 = 50

/// Plot EMAs on current timeframe
ema8_plot = plot(ta.ema(close, ema8), title = 'EMA 8', color = i_showEMAs ? i_ema8Color : na, linewidth = math.max(1, i_ema8Width))
ema21_plot = plot(ta.ema(close, ema21), title = 'EMA 21', color = i_showEMAs ? i_ema21Color : na, linewidth = math.max(1, i_ema21Width))
ema50_plot = plot(ta.ema(close, ema50), title = 'EMA 50', color = i_showEMAs ? i_ema50Color : na, linewidth = math.max(1, i_ema50Width))

// Function to calculate bias for a specific timeframe
getBias(timeframe) =>
    ema8_tf = request.security(syminfo.tickerid, timeframe, ta.ema(close, ema8))
    ema21_tf = request.security(syminfo.tickerid, timeframe, ta.ema(close, ema21))
    ema50_tf = request.security(syminfo.tickerid, timeframe, ta.ema(close, ema50))
    price_tf = request.security(syminfo.tickerid, timeframe, close)

    bullish = price_tf > ema21_tf and ema8_tf > ema21_tf and ema21_tf > ema50_tf

    bearish = price_tf < ema21_tf and ema8_tf < ema21_tf and ema21_tf < ema50_tf

    [bullish, bearish]

// Get bias for each timeframe
[weekly_bull, weekly_bear] = getBias('W')
[daily_bull, daily_bear] = getBias('D')
[h8_bull, h8_bear] = getBias('480')
[h6_bull, h6_bear] = getBias('360')
[h4_bull, h4_bear] = getBias('240')
[h3_bull, h3_bear] = getBias('180')
[h2_bull, h2_bear] = getBias('120')
[h1_bull, h1_bear] = getBias('60')
[m30_bull, m30_bear] = getBias('30')
[m15_bull, m15_bear] = getBias('15')

// Count bullish and bearish timeframes
bullCount = weekly_bull ? 1 : 0
bullCount := bullCount + (daily_bull ? 1 : 0)
bullCount := bullCount + (h8_bull ? 1 : 0)
bullCount := bullCount + (h6_bull ? 1 : 0)
bullCount := bullCount + (h4_bull ? 1 : 0)
bullCount := bullCount + (h3_bull ? 1 : 0)
bullCount := bullCount + (h2_bull ? 1 : 0)
bullCount := bullCount + (h1_bull ? 1 : 0)
bullCount := bullCount + (m30_bull ? 1 : 0)
bullCount := bullCount + (m15_bull ? 1 : 0)

bearCount = weekly_bear ? 1 : 0
bearCount := bearCount + (daily_bear ? 1 : 0)
bearCount := bearCount + (h8_bear ? 1 : 0)
bearCount := bearCount + (h6_bear ? 1 : 0)
bearCount := bearCount + (h4_bear ? 1 : 0)
bearCount := bearCount + (h3_bear ? 1 : 0)
bearCount := bearCount + (h2_bear ? 1 : 0)
bearCount := bearCount + (h1_bear ? 1 : 0)
bearCount := bearCount + (m30_bear ? 1 : 0)
bearCount := bearCount + (m15_bear ? 1 : 0)

// Determine if we have enough timeframes in agreement
isBullish = bullCount >= i_minTFAgreement
isBearish = bearCount >= i_minTFAgreement

// Define background colors based on contrarian mode
bgcolor_bull = i_contrarian ? i_bearColor : i_bullColor
bgcolor_bear = i_contrarian ? i_bullColor : i_bearColor

// Global background color
bgcolor(i_showBackground ? isBullish ? bgcolor_bull : isBearish ? bgcolor_bear : na : na)

// Plot individual timeframe status
var table statusTable = table.new(position.top_right, 3, 11, border_width = 1)

// Update table headers
if barstate.isfirst
    table.cell(statusTable, 0, 0, 'Timeframe', bgcolor = i_headerBgColor, text_color = i_headerTextColor)
    table.cell(statusTable, 1, 0, 'Bias', bgcolor = i_headerBgColor, text_color = i_headerTextColor)
    table.cell(statusTable, 2, 0, i_contrarian ? 'Counter' : 'Status', bgcolor = i_headerBgColor, text_color = i_headerTextColor)

// Define status colors based on contrarian mode
status_bull_color = i_contrarian ? color.red : color.green
status_bear_color = i_contrarian ? color.green : color.red

// Function to get status symbol and color
getStatusSymbol(isBull, isBear) =>
    symbol = isBull ? '▲' : isBear ? '▼' : '✗'
    color = isBull ? status_bull_color : isBear ? status_bear_color : color.gray
    [symbol, color]

// Update table contents
if barstate.islast
    // Weekly status
    [weekly_symbol, weekly_color] = getStatusSymbol(weekly_bull, weekly_bear)
    table.cell(statusTable, 0, 1, 'Weekly', text_color = i_timeframeTextColor)
    table.cell(statusTable, 1, 1, weekly_bull ? 'Bullish' : weekly_bear ? 'Bearish' : 'Neutral', text_color = i_biasTextColor)
    table.cell(statusTable, 2, 1, weekly_symbol, text_color = weekly_color)

    // Daily status
    [daily_symbol, daily_color] = getStatusSymbol(daily_bull, daily_bear)
    table.cell(statusTable, 0, 2, 'Daily', text_color = i_timeframeTextColor)
    table.cell(statusTable, 1, 2, daily_bull ? 'Bullish' : daily_bear ? 'Bearish' : 'Neutral', text_color = i_biasTextColor)
    table.cell(statusTable, 2, 2, daily_symbol, text_color = daily_color)

    // 8H status
    [h8_symbol, h8_color] = getStatusSymbol(h8_bull, h8_bear)
    table.cell(statusTable, 0, 3, '8H', text_color = i_timeframeTextColor)
    table.cell(statusTable, 1, 3, h8_bull ? 'Bullish' : h8_bear ? 'Bearish' : 'Neutral', text_color = i_biasTextColor)
    table.cell(statusTable, 2, 3, h8_symbol, text_color = h8_color)

    // 6H status
    [h6_symbol, h6_color] = getStatusSymbol(h6_bull, h6_bear)
    table.cell(statusTable, 0, 4, '6H', text_color = i_timeframeTextColor)
    table.cell(statusTable, 1, 4, h6_bull ? 'Bullish' : h6_bear ? 'Bearish' : 'Neutral', text_color = i_biasTextColor)
    table.cell(statusTable, 2, 4, h6_symbol, text_color = h6_color)

    // 4H status
    [h4_symbol, h4_color] = getStatusSymbol(h4_bull, h4_bear)
    table.cell(statusTable, 0, 5, '4H', text_color = i_timeframeTextColor)
    table.cell(statusTable, 1, 5, h4_bull ? 'Bullish' : h4_bear ? 'Bearish' : 'Neutral', text_color = i_biasTextColor)
    table.cell(statusTable, 2, 5, h4_symbol, text_color = h4_color)

    // 3H status
    [h3_symbol, h3_color] = getStatusSymbol(h3_bull, h3_bear)
    table.cell(statusTable, 0, 6, '3H', text_color = i_timeframeTextColor)
    table.cell(statusTable, 1, 6, h3_bull ? 'Bullish' : h3_bear ? 'Bearish' : 'Neutral', text_color = i_biasTextColor)
    table.cell(statusTable, 2, 6, h3_symbol, text_color = h3_color)

    // 2H status
    [h2_symbol, h2_color] = getStatusSymbol(h2_bull, h2_bear)
    table.cell(statusTable, 0, 7, '2H', text_color = i_timeframeTextColor)
    table.cell(statusTable, 1, 7, h2_bull ? 'Bullish' : h2_bear ? 'Bearish' : 'Neutral', text_color = i_biasTextColor)
    table.cell(statusTable, 2, 7, h2_symbol, text_color = h2_color)

    // 1H status
    [h1_symbol, h1_color] = getStatusSymbol(h1_bull, h1_bear)
    table.cell(statusTable, 0, 8, '1H', text_color = i_timeframeTextColor)
    table.cell(statusTable, 1, 8, h1_bull ? 'Bullish' : h1_bear ? 'Bearish' : 'Neutral', text_color = i_biasTextColor)
    table.cell(statusTable, 2, 8, h1_symbol, text_color = h1_color)

    // 30M status
    [m30_symbol, m30_color] = getStatusSymbol(m30_bull, m30_bear)
    table.cell(statusTable, 0, 9, '30M', text_color = i_timeframeTextColor)
    table.cell(statusTable, 1, 9, m30_bull ? 'Bullish' : m30_bear ? 'Bearish' : 'Neutral', text_color = i_biasTextColor)
    table.cell(statusTable, 2, 9, m30_symbol, text_color = m30_color)

    // 15M status
    [m15_symbol, m15_color] = getStatusSymbol(m15_bull, m15_bear)
    table.cell(statusTable, 0, 10, '15M', text_color = i_timeframeTextColor)
    table.cell(statusTable, 1, 10, m15_bull ? 'Bullish' : m15_bear ? 'Bearish' : 'Neutral', text_color = i_biasTextColor)
    table.cell(statusTable, 2, 10, m15_symbol, text_color = m15_color)
