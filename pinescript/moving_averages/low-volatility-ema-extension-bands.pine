//@version=6
indicator(title="Low Volatility EMA extension Bands", shorttitle="Low Volatility EMA extension", overlay=true)

// ==================== BASIC EMA ====================
len = input.int(8, minval=1, title="Length")
src = input(close, title="Source")
offset = input.int(title="Offset", defval=0, minval=-500, maxval=500, display = display.none)
out = ta.ema(src, len)
plot(out, title="EMA", color=color.yellow, offset=offset, linewidth=2)

// ==================== EXTENSION INDICATORS ====================
EXT_GRP = "Extension Levels"
ema34Length = input.int(34, "34 EMA Length", group = EXT_GRP)
showExtensions = input.bool(true, "Show Extension Levels", group = EXT_GRP)
ext10Pct = input.float(10, "Extension Level 1 (%)", minval = 0, step = 5, group = EXT_GRP)
ext25Pct = input.float(15, "Extension Level 2 (%)", minval = 0, step = 5, group = EXT_GRP)
ext35Pct = input.float(20, "Extension Level 3 (%)", minval = 0, step = 5, group = EXT_GRP)

// Calculate 34 EMA
ema34 = ta.ema(src, ema34Length)

// Calculate extension levels
ema34_ext10_upper = ema34 * (1 + ext10Pct / 100)
ema34_ext10_lower = ema34 * (1 - ext10Pct / 100)
ema34_ext25_upper = ema34 * (1 + ext25Pct / 100)
ema34_ext25_lower = ema34 * (1 - ext25Pct / 100)
ema34_ext35_upper = ema34 * (1 + ext35Pct / 100)
ema34_ext35_lower = ema34 * (1 - ext35Pct / 100)

// Plot 34 EMA
plot(showExtensions ? ema34 : na, title="34 EMA", color=color.white, linewidth=2)

// Plot extension levels
p10u = plot(showExtensions ? ema34_ext10_upper : na, title="10% Above", color=color.new(#4caf50, 70), style=plot.style_circles, linewidth=1)
p10l = plot(showExtensions ? ema34_ext10_lower : na, title="10% Below", color=color.new(#4caf50, 70), style=plot.style_circles, linewidth=1)
p25u = plot(showExtensions ? ema34_ext25_upper : na, title="25% Above", color=color.new(#ff9800, 85), style=plot.style_circles, linewidth=1)
p25l = plot(showExtensions ? ema34_ext25_lower : na, title="25% Below", color=color.new(#ff9800, 85), style=plot.style_circles, linewidth=1)
p35u = plot(showExtensions ? ema34_ext35_upper : na, title="35% Above", color=color.new(#f23645, 80), style=plot.style_circles, linewidth=1)
p35l = plot(showExtensions ? ema34_ext35_lower : na, title="35% Below", color=color.new(#f23645, 80), style=plot.style_circles, linewidth=1)

fill(p10u, p25u, color=color.new(#f57c00, 95), title="10-25% Upper Fill")
fill(p25u, p35u, color=color.new(#f23645, 95), title="25-35% Upper Fill")
fill(p10l, p25l, color=color.new(#f57c00, 95), title="10-25% Lower Fill")
fill(p25l, p35l, color=color.new(#f23645, 95), title="25-35% Lower Fill")

// ==================== WEEKLY MAs ====================
sma50w  = request.security(syminfo.tickerid, "W", ta.sma(close, 50),  lookahead=barmerge.lookahead_off)
sma200w = request.security(syminfo.tickerid, "W", ta.sma(close, 200), lookahead=barmerge.lookahead_off)

// ==================== STATS CALCULATIONS ====================
tfInMinutes = timeframe.in_seconds() / 60
barsPerDay  = math.max(1, math.round(390 / math.max(tfInMinutes, 1)))
barsPerYear = barsPerDay * 5 * 52
lookback    = math.min(barsPerYear, bar_index + 1)
medLookback = math.min(200, lookback)

// EMA34
ext34    = ema34  != 0 ? (close - ema34)  / ema34  * 100 : 0
diff34   = close - ema34
min34    = ta.lowest(ext34, lookback)
max34    = ta.highest(ext34, lookback)
med34    = ta.percentile_nearest_rank(ext34, medLookback, 50)

// 50W SMA
ext50w   = sma50w  != 0 ? (close - sma50w)  / sma50w  * 100 : 0
diff50w  = close - sma50w
min50w   = ta.lowest(ext50w, lookback)
max50w   = ta.highest(ext50w, lookback)
med50w   = ta.percentile_nearest_rank(ext50w, medLookback, 50)

// 200W SMA
ext200w  = sma200w != 0 ? (close - sma200w) / sma200w * 100 : 0
diff200w = close - sma200w
min200w  = ta.lowest(ext200w, lookback)
max200w  = ta.highest(ext200w, lookback)
med200w  = ta.percentile_nearest_rank(ext200w, medLookback, 50)

// Helper functions for color and sign
f_col(v) => v >= 0 ? color.new(#4caf50, 0) : color.new(#f23645, 0)
f_sign(v) => v >= 0 ? "+" : ""

// ==================== SINGLE COMBINED TABLE ====================
// 4 columns: label | EMA34 | 50W | 200W
STATS_GRP = "Extension Stats"
showStats = input.bool(true, "Show Stats Table", group = STATS_GRP)

var table t = table.new(position.top_right, 4, 6,
     bgcolor      = color.new(#1a1a2e, 10),
     border_color = color.new(#555555, 0),
     border_width = 1,
     frame_color  = color.new(#555555, 0),
     frame_width  = 1)

if showStats and barstate.islast
    // Header
    table.cell(t, 0, 0, "Extension",  text_color=color.white,            text_size=size.small, bgcolor=color.new(#2a2a4a, 0), text_halign=text.align_left)
    table.cell(t, 1, 0, "EMA 34",     text_color=color.white,            text_size=size.small, bgcolor=color.new(#2a2a4a, 0), text_halign=text.align_right)
    table.cell(t, 2, 0, "SMA 50W",    text_color=color.new(#2196f3, 0),  text_size=size.small, bgcolor=color.new(#2a2a4a, 0), text_halign=text.align_right)
    table.cell(t, 3, 0, "SMA 200W",   text_color=color.new(#e040fb, 0),  text_size=size.small, bgcolor=color.new(#2a2a4a, 0), text_halign=text.align_right)

    // Price Diff
    table.cell(t, 0, 1, "Price Diff", text_color=color.new(#aaaaaa, 0),  text_size=size.small, text_halign=text.align_left)
    table.cell(t, 1, 1, f_sign(diff34)   + str.tostring(math.round(diff34,   2)), text_color=f_col(diff34),   text_size=size.small, text_halign=text.align_right)
    table.cell(t, 2, 1, f_sign(diff50w)  + str.tostring(math.round(diff50w,  2)), text_color=f_col(diff50w),  text_size=size.small, text_halign=text.align_right)
    table.cell(t, 3, 1, f_sign(diff200w) + str.tostring(math.round(diff200w, 2)), text_color=f_col(diff200w), text_size=size.small, text_halign=text.align_right)

    // Current %
    table.cell(t, 0, 2, "Current %",  text_color=color.new(#aaaaaa, 0),  text_size=size.small, text_halign=text.align_left)
    table.cell(t, 1, 2, f_sign(ext34)   + str.tostring(math.round(ext34,   2)) + "%", text_color=f_col(ext34),   text_size=size.small, text_halign=text.align_right)
    table.cell(t, 2, 2, f_sign(ext50w)  + str.tostring(math.round(ext50w,  2)) + "%", text_color=f_col(ext50w),  text_size=size.small, text_halign=text.align_right)
    table.cell(t, 3, 2, f_sign(ext200w) + str.tostring(math.round(ext200w, 2)) + "%", text_color=f_col(ext200w), text_size=size.small, text_halign=text.align_right)

    // Min
    table.cell(t, 0, 3, "Min",        text_color=color.new(#aaaaaa, 0),  text_size=size.small, text_halign=text.align_left)
    table.cell(t, 1, 3, str.tostring(math.round(min34,   2)) + "%", text_color=color.new(#f23645, 0), text_size=size.small, text_halign=text.align_right)
    table.cell(t, 2, 3, str.tostring(math.round(min50w,  2)) + "%", text_color=color.new(#f23645, 0), text_size=size.small, text_halign=text.align_right)
    table.cell(t, 3, 3, str.tostring(math.round(min200w, 2)) + "%", text_color=color.new(#f23645, 0), text_size=size.small, text_halign=text.align_right)

    // Median
    table.cell(t, 0, 4, "Median",     text_color=color.new(#aaaaaa, 0),  text_size=size.small, text_halign=text.align_left)
    table.cell(t, 1, 4, str.tostring(math.round(med34,   2)) + "%", text_color=color.new(#ff9800, 0), text_size=size.small, text_halign=text.align_right)
    table.cell(t, 2, 4, str.tostring(math.round(med50w,  2)) + "%", text_color=color.new(#ff9800, 0), text_size=size.small, text_halign=text.align_right)
    table.cell(t, 3, 4, str.tostring(math.round(med200w, 2)) + "%", text_color=color.new(#ff9800, 0), text_size=size.small, text_halign=text.align_right)

    // Max
    table.cell(t, 0, 5, "Max",        text_color=color.new(#aaaaaa, 0),  text_size=size.small, text_halign=text.align_left)
    table.cell(t, 1, 5, str.tostring(math.round(max34,   2)) + "%", text_color=color.new(#4caf50, 0), text_size=size.small, text_halign=text.align_right)
    table.cell(t, 2, 5, str.tostring(math.round(max50w,  2)) + "%", text_color=color.new(#4caf50, 0), text_size=size.small, text_halign=text.align_right)
    table.cell(t, 3, 5, str.tostring(math.round(max200w, 2)) + "%", text_color=color.new(#4caf50, 0), text_size=size.small, text_halign=text.align_right)
