//@version=6
strategy("PSAR Strategy v3 RR 1:5", overlay=true, max_labels_count=500,
     default_qty_type=strategy.percent_of_equity, default_qty_value=10, pyramiding=1)

// === Inputs ===
smaLength        = input.int(100, "SMA Length", minval=1)
bbLength         = input.int(20, "BB Length", minval=1)
bbDev            = input.float(2.0, "BB Deviation", minval=0.1, step=0.1)

psarStart        = input.float(0.01, "PSAR Start (AF)", step=0.001)
psarIncrement    = input.float(0.01, "PSAR Increment (AF)", step=0.001)
psarMax          = input.float(0.2,  "PSAR Maximum (AF)", step=0.01)

rrRatio          = input.float(6.0, "Risk:Reward Ratio", minval=0.5, step=0.1)

// === Trade Direction Filter ===
tradeDirection   = input.string("Both", "Trade Direction", options=["Both", "Just Buy", "Just Sell"])

// === RSI Filter (Optional) ===
useRSI           = input.bool(true, "Use RSI Filter?")
rsiLength        = input.int(14, "RSI Length", minval=1)
rsiBuyLevel      = input.int(55, "RSI Buy Level", minval=50, maxval=100)
rsiSellLevel     = input.int(45, "RSI Sell Level", minval=0, maxval=50)
rsiVal           = ta.rsi(close, rsiLength)

// === BB Filter Lookback ===
lookbackBars     = input.int(0, "Previous Candle Check", minval=0)

// === Session Filter ===
useSessionFilter = input.bool(false, "Use Session Filter?")
tradeAsian       = input.bool(true, "Allow Asian Session")
tradeLondon      = input.bool(true, "Allow London Session")
tradeNY          = input.bool(true, "Allow NY Session")

// === Indicators ===
smaVal   = ta.sma(close, smaLength)
basis    = ta.sma(close, bbLength)
dev      = bbDev * ta.stdev(close, bbLength)
upperBB  = basis + dev
lowerBB  = basis - dev
psarVal  = ta.sar(psarStart, psarIncrement, psarMax)

// === PSAR flip detection ===
psarFlipToLong  = not na(psarVal[1]) and psarVal[1] > close[1] and psarVal < close
psarFlipToShort = not na(psarVal[1]) and psarVal[1] < close[1] and psarVal > close

// === BB Mid Filter ===
noBelowMid = true
for i = 1 to lookbackBars
    if close[i] < basis[i]
        noBelowMid := false

noAboveMid = true
for i = 1 to lookbackBars
    if close[i] > basis[i]
        noAboveMid := false

// === Session Filter Logic ===
// Mendapatkan waktu saat ini dalam timezone UTC
currentHour = hour(time)
currentMinute = minute(time)

// Definisi sesi trading (dalam UTC):
// Asian: 00:00 - 09:00 UTC (mencakup Tokyo, Sydney, Hong Kong)
// London: 08:00 - 17:00 UTC (tumpang tindih dengan Asian di awal)
// NY: 13:00 - 22:00 UTC (tumpang tindih dengan London)
isAsianSession = currentHour >= 0 and (currentHour < 9 or (currentHour == 9 and currentMinute == 0))
isLondonSession = currentHour >= 8 and (currentHour < 17 or (currentHour == 17 and currentMinute == 0))
isNYSession = currentHour >= 13 and (currentHour < 22 or (currentHour == 22 and currentMinute == 0))

// Session allowed condition
sessionAllowed = not useSessionFilter or 
                 (tradeAsian and isAsianSession) or 
                 (tradeLondon and isLondonSession) or 
                 (tradeNY and isNYSession)

// === Entry conditions dengan session filter dan trade direction ===
longCondition  = sessionAllowed and 
                 (tradeDirection == "Both" or tradeDirection == "Just Buy") and
                 psarFlipToLong and 
                 close > smaVal and 
                 close > basis and 
                 noBelowMid and 
                 (not useRSI or rsiVal > rsiBuyLevel)

shortCondition = sessionAllowed and 
                 (tradeDirection == "Both" or tradeDirection == "Just Sell") and
                 psarFlipToShort and 
                 close < smaVal and 
                 close < basis and 
                 noAboveMid and 
                 (not useRSI or rsiVal < rsiSellLevel)

// === SL/TP calculation ===
longSL  = psarVal
shortSL = psarVal
longTP  = close + (close - longSL) * rrRatio
shortTP = close - (shortSL - close) * rrRatio

// === Strategy execution ===
if (longCondition)
    strategy.entry("Long", strategy.long)
    strategy.exit("Long Exit", from_entry="Long", stop=longSL, limit=longTP)

if (shortCondition)
    strategy.entry("Short", strategy.short)
    strategy.exit("Short Exit", from_entry="Short", stop=shortSL, limit=shortTP)

// === Plotting indikator ===
plot(smaVal, "SMA 50", color=color.orange, linewidth=2)
plot(basis, "BB Basis", color=color.new(color.blue, 0))
plot(upperBB, "BB Upper", color=color.new(color.blue, 50))
plot(lowerBB, "BB Lower", color=color.new(color.blue, 50))
plot(psarVal, "PSAR", style=plot.style_cross, color=color.fuchsia, linewidth=2)
plot(rsiVal, "RSI", color=color.new(color.yellow, 0), display=display.none)

// === Dashboard table ===
var table dash = table.new(position.top_right, 2, 9, border_width=1)

if barstate.islast
    table.cell(dash, 0, 0, "Total Trades", text_color=color.white, bgcolor=color.black)
    table.cell(dash, 1, 0, str.tostring(strategy.closedtrades), text_color=color.yellow, bgcolor=color.black)

    table.cell(dash, 0, 1, "Win Trades", text_color=color.white, bgcolor=color.black)
    table.cell(dash, 1, 1, str.tostring(strategy.wintrades), text_color=color.green, bgcolor=color.black)

    table.cell(dash, 0, 2, "Loss Trades", text_color=color.white, bgcolor=color.black)
    table.cell(dash, 1, 2, str.tostring(strategy.losstrades), text_color=color.red, bgcolor=color.black)

    winRate = strategy.closedtrades > 0 ? (strategy.wintrades * 100.0 / strategy.closedtrades) : na
    table.cell(dash, 0, 3, "Winrate %", text_color=color.white, bgcolor=color.black)
    table.cell(dash, 1, 3, na(winRate) ? "NA" : str.tostring(winRate, "#.##") + "%", text_color=color.blue, bgcolor=color.black)

    table.cell(dash, 0, 4, "RSI Now", text_color=color.white, bgcolor=color.black)
    table.cell(dash, 1, 4, str.tostring(rsiVal, "#.##"), text_color=color.orange, bgcolor=color.black)

    table.cell(dash, 0, 5, "Lookback Candles", text_color=color.white, bgcolor=color.black)
    table.cell(dash, 1, 5, str.tostring(lookbackBars), text_color=color.yellow, bgcolor=color.black)

    table.cell(dash, 0, 6, "RSI Filter Active", text_color=color.white, bgcolor=color.black)
    table.cell(dash, 1, 6, useRSI ? "YES" : "NO", text_color=color.purple, bgcolor=color.black)
    
    // Session Filter Info
    table.cell(dash, 0, 7, "Session Filter", text_color=color.white, bgcolor=color.black)
    sessionStatus = useSessionFilter ? "ACTIVE" : "OFF"
    table.cell(dash, 1, 7, sessionStatus, text_color=color.lime, bgcolor=color.black)
    
    // Trade Direction Info
    table.cell(dash, 0, 8, "Trade Direction", text_color=color.white, bgcolor=color.black)
    table.cell(dash, 1, 8, tradeDirection, text_color=color.aqua, bgcolor=color.black)
