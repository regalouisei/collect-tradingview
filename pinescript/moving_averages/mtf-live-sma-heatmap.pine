// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © SwoboHD

//@version=6
indicator('MTF LIVE SMA Heatmap – 5m/15m/1h/4h/1D (Pips)', overlay = true, max_labels_count = 500)

tf_current = timeframe.period

// Heatmap für SMA200 (weiterhin Prozent-basiert)
f_heat_color(float pct, float maxRange) =>
    neutral = input.float(0.1, 'SMA200 yellow Range at %', step=0.01) // ±0.1% gelber Bereich

    if math.abs(pct) <= neutral
        intensity = math.abs(pct) / neutral
        transp = int(70 * (1 - intensity))
        color.new(color.yellow, transp)
    else if pct > neutral
        intensity = (pct - neutral) / (maxRange - neutral)
        intensity := math.max(0, math.min(1, intensity))
        transp = int(50 * (1 - intensity))
        color.new(color.green, transp)
    else
        intensity = (math.abs(pct) - neutral) / (maxRange - neutral)
        intensity := math.max(0, math.min(1, intensity))
        transp = int(50 * (1 - intensity))
        color.new(color.red, transp)

// Textfarbe abhängig von Intensität
f_text_color(float pct, float maxRange) =>
    intensity = math.abs(math.max(-maxRange, math.min(maxRange, pct))) / maxRange
    intensity > 0.01 ? color.white : color.black

// Formatierung für Pip-Text
f_pip_text(float pips) =>
    str.tostring(math.round(pips * 10) / 10) + ' pips'

// Prozent für Heatmap (nur für SMA200)
f_get_pct(tf, len) =>
    c_tf = request.security(syminfo.tickerid, tf, close)
    sma_tf = request.security(syminfo.tickerid, tf, ta.sma(close, len))
    sma_tf != 0 ? 100 * (c_tf - sma_tf) / sma_tf : 0.0

// === UNIVERSAL PIP ENGINE ===
f_get_pip_size() =>
    sym = str.upper(syminfo.ticker)

    if str.contains(sym, 'XAU')
        0.10
    else if str.contains(sym, 'XAG')
        0.01
    else if str.contains(sym, 'XPT') or str.contains(sym, 'XPD')
        0.10
    else if str.contains(sym, 'BTC')
        1.00
    else if str.contains(sym, 'ETH')
        0.10
    else if str.contains(sym, 'LTC')
        0.01
    else if str.contains(sym, 'DOGE')
        0.0001
    else if str.contains(sym, 'JPY')
        0.01
    else if str.contains(sym, 'USD') or str.contains(sym, 'EUR') or str.contains(sym, 'GBP') or str.contains(sym, 'AUD') or str.contains(sym, 'NZD') or str.contains(sym, 'CAD') or str.contains(sym, 'CHF')
        0.0001
    else if str.contains(sym, 'US30') or str.contains(sym, 'DJI')
        1.0
    else if str.contains(sym, 'NAS') or str.contains(sym, 'NDX')
        0.25
    else if str.contains(sym, 'SPX') or str.contains(sym, 'ES')
        0.25
    else if str.contains(sym, 'GER40') or str.contains(sym, 'DAX') or str.contains(sym, 'UK100')
        1.0
    else if str.contains(sym, 'WTI') or str.contains(sym, 'CL') or str.contains(sym, 'BRENT') or str.contains(sym, 'BRN')
        0.01
    else
        syminfo.mintick

// Abstand in Pips berechnen
f_get_pips(tf, len) =>
    pip_size = f_get_pip_size()
    c_tf = request.security(syminfo.tickerid, tf, close)
    sma_tf = request.security(syminfo.tickerid, tf, ta.sma(close, len))
    (c_tf - sma_tf) / pip_size

// === NEUE GELB-LOGIK für SMA9 & SMA20 ===
f_sma_color(c, sma9, sma20) =>
    lower = math.min(sma9, sma20)
    upper = math.max(sma9, sma20)

    if c >= lower and c <= upper
        color.yellow
    else if c > upper
        color.green
    else
        color.red

// === Tabelle anlegen ===
var table t = table.new(position.top_right, 5, 7, border_width = 1)

if barstate.isfirst
    table.cell(t, 0, 0, 'TF', bgcolor = color.gray, text_color = color.white)
    table.cell(t, 1, 0, 'SMA 9', bgcolor = color.gray, text_color = color.white)
    table.cell(t, 2, 0, 'SMA 20', bgcolor = color.gray, text_color = color.white)
    table.cell(t, 3, 0, 'SMA 200', bgcolor = color.gray, text_color = color.white)
    table.cell(t, 4, 0, '9 vs 20', bgcolor = color.gray, text_color = color.white)

// === Parameter ===
maxRange = input.float(5.0, 'Max Range to Heatmap (%)', step = 0.1)

// === Funktion zum Füllen einer Zeile ===
f_fill_row(row, tfLabel, tf) =>
    c_tf = request.security(syminfo.tickerid, tf, close)
    s9 = request.security(syminfo.tickerid, tf, ta.sma(close, 9))
    s20 = request.security(syminfo.tickerid, tf, ta.sma(close, 20))

    pct200 = f_get_pct(tf, 200)
    pips9 = f_get_pips(tf, 9)
    pips20 = f_get_pips(tf, 20)
    pips200 = f_get_pips(tf, 200)
    pips9to20 =math.round(pips20 - pips9)
    col9 = f_sma_color(c_tf, s9, s20)
    col20 = f_sma_color(c_tf, s9, s20)

    cross = s9 > s20 ? 1 : s9 < s20 ? -1 : 0

    table.cell(t, 0, row, tfLabel, bgcolor = color.new(color.blue, 70), text_color = color.white)

    table.cell(t, 1, row, f_pip_text(pips9), bgcolor = col9, text_color = color.black)
    table.cell(t, 2, row, f_pip_text(pips20), bgcolor = col20, text_color = color.black)
    table.cell(t, 3, row, f_pip_text(pips200), bgcolor = f_heat_color(pct200, maxRange), text_color = f_text_color(pct200, maxRange))

    table.cell(t, 4, row, cross == 1 ? "9>20 | "+str.tostring(pips9to20) : cross == -1 ? "20>9 | "+str.tostring(pips9to20) : '=', text_color = cross == 0 ? color.black : color.white, bgcolor = cross == 1 ? color.green : cross == -1 ? color.red : color.yellow)

// === Heatmap füllen ===
f_fill_row(1, str.tostring(tf_current), timeframe.period)
f_fill_row(2, "5m",  "5")
f_fill_row(3, "15m", "15")
f_fill_row(4, "1H",  "60")
f_fill_row(5, "4H",  "240")
f_fill_row(6, "1D",  "D")
