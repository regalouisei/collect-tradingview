//@version=6

// This code is licensed under the Mozilla Public License 2.0
// You can obtain a copy of the license at https://mozilla.org/MPL/2.0/
//
//Use at your own Risk!!

indicator(
     title = "Swiss Army Moving Averages + Vwap",
     shorttitle = "Swiss Army MA's",
     overlay = true,
     timeframe = "",
     timeframe_gaps = true)

// ───────────────────────────────────────
/// 1️⃣  MASTER SWITCHES
// ───────────────────────────────────────
showEMAs   = input.bool(true,  title = "EMA series",   group = "Master Switches")
showSMAs   = input.bool(false,  title = "SMA series",   group = "Master Switches")
showVWAP  = input.bool(true,  title = "VWAP", group = "Master Switches")

// ───────────────────────────────────────
// 2️⃣  EMA SETTINGS
// ───────────────────────────────────────
showEMA1 = input.bool(true, title = 'Show EMA 1', group = 'EMA Settings')
ema1Length = input.int(9, title = 'EMA 1 Length', group = 'EMA Settings')
ema1Color = input.color(color.rgb(243, 3, 223), title = 'EMA 1 Color', group = 'EMA Settings')

showEMA2 = input.bool(true, title = 'Show EMA 2', group = 'EMA Settings')
ema2Length = input.int(20, title = 'EMA 2 Length', group = 'EMA Settings')
ema2Color = input.color(color.rgb(255, 0, 0), title = 'EMA 2 Color', group = 'EMA Settings')

showEMA3 = input.bool(true, title = 'Show EMA 3', group = 'EMA Settings')
ema3Length = input.int(50, title = 'EMA 3 Length', group = 'EMA Settings')
ema3Color = input.color(color.rgb(251, 255, 255), title = 'EMA 3 Color', group = 'EMA Settings')

showEMA4 = input.bool(true, title = 'Show EMA 4', group = 'EMA Settings')
ema4Length = input.int(200, title = 'EMA 4 Length', group = 'EMA Settings')
ema4Color = input.color(color.rgb(3, 136, 245), title = 'EMA 4 Color', group = 'EMA Settings')

// ───────────────────────────────────────
// 3️⃣  SMA SETTINGS
// ───────────────────────────────────────
showSMA1 = input.bool(false, title = 'Show SMA 1', group = 'SMA Settings')
sma1Length = input.int(9, title = 'SMA 1 Length', group = 'SMA Settings')
sma1Color = input.color(color.rgb(235, 10, 167), title = 'SMA 1 Color', group = 'SMA Settings')

showSMA2 = input.bool(false, title = 'Show SMA 2', group = 'SMA Settings')
sma2Length = input.int(20, title = 'SMA 2 Length', group = 'SMA Settings')
sma2Color = input.color(color.rgb(241, 7, 7), title = 'SMA 2 Color', group = 'SMA Settings')

showSMA3 = input.bool(false, title = 'Show SMA 3', group = 'SMA Settings')
sma3Length = input.int(50, title = 'SMA 3 Length', group = 'SMA Settings')
sma3Color = input.color(color.rgb(234, 243, 242), title = 'SMA 3 Color', group = 'SMA Settings')

showSMA4 = input.bool(false, title = 'Show SMA 4', group = 'SMA Settings')
sma4Length = input.int(200, title = 'SMA 4 Length', group = 'SMA Settings')
sma4Color = input.color(color.rgb(47, 34, 235), title = 'SMA 4 Color', group = 'SMA Settings')

// ───────────────────────────────────────
// 4️⃣  VWAP SETTINGS
// ───────────────────────────────────────
hideonDWM   = input.bool(false, title = "Hide VWAP on 1D or Above", group = "VWAP Settings", display = display.none)
anchor      = input.string(defval = "Session", title = "Anchor Period",
               options = ["Session","Week","Month","Quarter","Year","Decade","Century","Earnings","Dividends","Splits"],
               group = "VWAP Settings")
src = input(title = "Source", defval = hlc3, group="VWAP Settings", display = display.none)
offset      = input.int(0, title = "Offset", group = "VWAP Settings", display = display.none)

BANDS_GROUP = "Bands Settings"
calcModeInput = input.string("Standard Deviation", "Bands Calculation Mode",
                options = ["Standard Deviation","Percentage"], group = BANDS_GROUP,
                tooltip = "Determines the units used to calculate the distance of the bands. When 'Percentage' is selected, a multiplier of 1 means 1%.",
                display = display.none)

showBand_1 = input.bool(false, title = "", group = BANDS_GROUP, inline = "band_1", display = display.none)
bandMult_1 = input.float(1.0, title = "Bands Multiplier #1", group = BANDS_GROUP, inline = "band_1", step = 0.5, minval = 0,
                display = display.none, active = showBand_1)

showBand_2 = input.bool(false, title = "", group = BANDS_GROUP, inline = "band_2", display = display.none)
bandMult_2 = input.float(2.0, title = "Bands Multiplier #2", group = BANDS_GROUP, inline = "band_2", step = 0.5, minval = 0,
                display = display.none, active = showBand_2)

showBand_3 = input.bool(false, title = "", group = BANDS_GROUP, inline = "band_3", display = display.none)
bandMult_3 = input.float(3.0, title = "Bands Multiplier #3", group = BANDS_GROUP, inline = "band_3", step = 0.5, minval = 0,
                display = display.none, active = showBand_3)

// ───────────────────────────────────────
// 5️⃣  CALCULATIONS
// ───────────────────────────────────────

// EMAs (only calculated if the master switch is on – saves CPU)
ema1 = showEMAs ? ta.ema(close, ema1Length) : na
ema2 = showEMAs ? ta.ema(close, ema2Length) : na
ema3 = showEMAs ? ta.ema(close, ema3Length) : na
ema4 = showEMAs ? ta.ema(close, ema4Length) : na

// SMAs (only calculated if the master switch is on)
sma1 = showSMAs ? ta.sma(close, sma1Length) : na
sma2 = showSMAs ? ta.sma(close, sma2Length) : na
sma3 = showSMAs ? ta.sma(close, sma3Length) : na
sma4 = showSMAs ? ta.sma(close, sma4Length) : na

// VWAP & Bands (only calculated if the master switch is on)
float vwapValue          = na
float upperBandValue1    = na
float lowerBandValue1    = na
float upperBandValue2    = na
float lowerBandValue2    = na
float upperBandValue3    = na
float lowerBandValue3    = na

if showVWAP
    cumVolume = ta.cum(volume)
    if barstate.islast and cumVolume == 0
        runtime.error("No volume is provided by the data vendor.")

    isNewPeriod = switch anchor
        "Earnings" => 
            new_earnings_actual       = request.earnings(syminfo.tickerid, earnings.actual, barmerge.gaps_on, barmerge.lookahead_on, ignore_invalid_symbol=true)
            new_earnings_standardized = request.earnings(syminfo.tickerid, earnings.standardized, barmerge.gaps_on, barmerge.lookahead_on, ignore_invalid_symbol=true)
            not na(new_earnings_actual) or not na(new_earnings_standardized)
        "Dividends" => 
            new_dividends = request.dividends(syminfo.tickerid, dividends.gross, barmerge.gaps_on, barmerge.lookahead_on, ignore_invalid_symbol=true)
            not na(new_dividends)
        "Splits"    => 
            new_split = request.splits(syminfo.tickerid, splits.denominator, barmerge.gaps_on, barmerge.lookahead_on, ignore_invalid_symbol=true)
            not na(new_split)
        "Session"   => timeframe.change("D")
        "Week"      => timeframe.change("W")
        "Month"     => timeframe.change("M")
        "Quarter"   => timeframe.change("3M")
        "Year"      => timeframe.change("12M")
        "Decade"    => timeframe.change("12M") and year % 10 == 0
        "Century"   => timeframe.change("12M") and year % 100 == 0
        => false

    isEsdAnchor = anchor == "Earnings" or anchor == "Dividends" or anchor == "Splits"
    if na(src[1]) and not isEsdAnchor
        isNewPeriod := true

    if not (hideonDWM and timeframe.isdwm)
        [_vwap, _stdevUpper, _] = ta.vwap(src, isNewPeriod, 1)
        vwapValue := _vwap
        stdevAbs = _stdevUpper - _vwap
        bandBasis = calcModeInput == "Standard Deviation" ? stdevAbs : _vwap * 0.01

        upperBandValue1 := _vwap + bandBasis * bandMult_1
        lowerBandValue1 := _vwap - bandBasis * bandMult_1
        upperBandValue2 := _vwap + bandBasis * bandMult_2
        lowerBandValue2 := _vwap - bandBasis * bandMult_2
        upperBandValue3 := _vwap + bandBasis * bandMult_3
        lowerBandValue3 := _vwap - bandBasis * bandMult_3

// ───────────────────────────────────────
// 6️⃣  PLOTS
// ───────────────────────────────────────

// EMA plots (respect individual visibility AND master switch)
plot(showEMAs and showEMA1 ? ema1 : na, title = 'EMA 1', linewidth = 1, color = ema1Color)
plot(showEMAs and showEMA2 ? ema2 : na, title = 'EMA 2', linewidth = 2, color = ema2Color)
plot(showEMAs and showEMA3 ? ema3 : na, title = 'EMA 3', linewidth = 2, color = ema3Color)
plot(showEMAs and showEMA4 ? ema4 : na, title = 'EMA 4', linewidth = 2, color = ema4Color)

// SMA plots (respect individual visibility AND master switch)
plot(showSMAs and showSMA1 ? sma1 : na, title = 'SMA 1', color = sma1Color)
plot(showSMAs and showSMA2 ? sma2 : na, title = 'SMA 2', color = sma2Color)
plot(showSMAs and showSMA3 ? sma3 : na, title = 'SMA 3', color = sma3Color)
plot(showSMAs and showSMA4 ? sma4 : na, title = 'SMA 4', color = sma4Color)

// VWAP and band plots (only if master switch is on)
plot(showVWAP ? vwapValue : na, title = "VWAP", color = #d1f506, offset = offset)

displayBand1 = showBand_1 ? display.all : display.none
upperBand_1 = plot(showVWAP ? upperBandValue1 : na, title="Upper Band #1", color=color.green, offset=offset, display=displayBand1, editable=showBand_1)
lowerBand_1 = plot(showVWAP ? lowerBandValue1 : na, title="Lower Band #1", color=color.green, offset=offset, display=displayBand1, editable=showBand_1)
fill(upperBand_1, lowerBand_1, title="Bands Fill #1", color=color.new(color.green, 95), display=displayBand1, editable=showBand_1)

displayBand2 = showBand_2 ? display.all : display.none
upperBand_2 = plot(showVWAP ? upperBandValue2 : na, title="Upper Band #2", color=color.olive, offset=offset, display=displayBand2, editable=showBand_2)
lowerBand_2 = plot(showVWAP ? lowerBandValue2 : na, title="Lower Band #2", color=color.olive, offset=offset, display=displayBand2, editable=showBand_2)
fill(upperBand_2, lowerBand_2, title="Bands Fill #2", color=color.new(color.olive, 95), display=displayBand2, editable=showBand_2)

displayBand3 = showBand_3 ? display.all : display.none
upperBand_3 = plot(showVWAP ? upperBandValue3 : na, title="Upper Band #3", color=color.teal, offset=offset, display=displayBand3, editable=showBand_3)
lowerBand_3 = plot(showVWAP ? lowerBandValue3 : na, title="Lower Band #3", color=color.teal, offset=offset, display=displayBand3, editable=showBand_3)
fill(upperBand_3, lowerBand_3, title="Bands Fill #3", color=color.new(color.teal, 95), display=displayBand3, editable=showBand_3)
