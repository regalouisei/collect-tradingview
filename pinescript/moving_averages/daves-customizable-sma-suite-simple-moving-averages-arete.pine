//@version=6
indicator("Dave's Highly Customizable SMA Suite", overlay=true)

// --- Inputs Section ---
use_custom_tf = input.bool(false, title="Use Custom Timeframe? (Uncheck for 'Same as Chart')")
custom_tf = input.timeframe("D", title="Custom Timeframe (Only if box above is checked)")

// SMA Toggle and Length Inputs
show_sma1 = input.bool(true, title="Show SMA 1?", group="SMA 1 (Short)")
len1      = input.int(12, title="Length", group="SMA 1 (Short)")
color1    = input.color(color.blue, title="Color", group="SMA 1 (Short)")

show_sma2 = input.bool(true, title="Show SMA 2?", group="SMA 2 (Medium)")
len2      = input.int(22, title="Length", group="SMA 2 (Medium)")
color2    = input.color(color.orange, title="Color", group="SMA 2 (Medium)")

show_sma3 = input.bool(true, title="Show SMA 3?", group="SMA 3 (Long)")
len3      = input.int(55, title="Length", group="SMA 3 (Long)")
color3    = input.color(color.red, title="Color", group="SMA 3 (Long)")

show_sma4 = input.bool(true, title="Show SMA 4?", group="SMA 4 (Institutional)")
len4      = input.int(100, title="Length", group="SMA 4 (Institutional)")
color4    = input.color(color.purple, title="Color", group="SMA 4 (Institutional)")

show_sma5 = input.bool(true, title="Show SMA 5?", group="SMA 5 (Institutional)")
len5      = input.int(200, title="Length", group="SMA 5 (Institutional)")
color5    = input.color(color.gray, title="Color", group="SMA 5 (Institutional)")

// --- Logic for Timeframe Selection ---
active_tf = use_custom_tf ? custom_tf : timeframe.period

// --- Calculations ---
sma1_raw = ta.sma(close, len1)
sma2_raw = ta.sma(close, len2)
sma3_raw = ta.sma(close, len3)
sma4_raw = ta.sma(close, len4)
sma5_raw = ta.sma(close, len5)

sma1 = request.security(syminfo.tickerid, active_tf, sma1_raw[barstate.isrealtime ? 1 : 0], lookahead=barmerge.lookahead_on)
sma2 = request.security(syminfo.tickerid, active_tf, sma2_raw[barstate.isrealtime ? 1 : 0], lookahead=barmerge.lookahead_on)
sma3 = request.security(syminfo.tickerid, active_tf, sma3_raw[barstate.isrealtime ? 1 : 0], lookahead=barmerge.lookahead_on)
sma4 = request.security(syminfo.tickerid, active_tf, sma4_raw[barstate.isrealtime ? 1 : 0], lookahead=barmerge.lookahead_on)
sma5 = request.security(syminfo.tickerid, active_tf, sma5_raw[barstate.isrealtime ? 1 : 0], lookahead=barmerge.lookahead_on)

// --- Plotting Lines (Conditional on the Checkboxes) ---
plot(show_sma1 ? sma1 : na, color=color1, title="Short SMA", linewidth=2)
plot(show_sma2 ? sma2 : na, color=color2, title="Medium SMA", linewidth=2)
plot(show_sma3 ? sma3 : na, color=color3, title="Long SMA", linewidth=2)
plot(show_sma4 ? sma4 : na, color=color4, title="100 SMA", linewidth=2)
plot(show_sma5 ? sma5 : na, color=color5, title="200 SMA", linewidth=3)

// --- Crossover Logic & Signals ---
longCondition = ta.crossover(sma1, sma2)
shortCondition = ta.crossunder(sma1, sma2)

// --- Dashboard Table Implementation ---
var table trendTable = table.new(position.top_right, 2, 6, bgcolor=color.new(color.black, 70), border_width=1)

// 1. Move the function definition to the GLOBAL SCOPE (outside the IF block)
f_fill_row(_table, _row, _label, _val) =>
    _isBullish = close > _val
    table.cell(_table, 0, _row, _label, text_color=color.white, text_size=size.small)
    table.cell(_table, 1, _row, _isBullish ? "BULLISH" : "BEARISH", bgcolor=_isBullish ? color.new(color.green, 40) : color.new(color.red, 40), text_color=color.white, text_size=size.small)

// 2. Now use the IF block only for the execution
if barstate.islast
    table.cell(trendTable, 0, 0, "SMA Period", text_color=color.white, text_size=size.small)
    table.cell(trendTable, 1, 0, "Trend Status", text_color=color.white, text_size=size.small)
    
    // Call the function for each row
    f_fill_row(trendTable, 1, str.tostring(len1), sma1)
    f_fill_row(trendTable, 2, str.tostring(len2), sma2)
    f_fill_row(trendTable, 3, str.tostring(len3), sma3)
    f_fill_row(trendTable, 4, str.tostring(len4), sma4)
    f_fill_row(trendTable, 5, str.tostring(len5), sma5)

//plotshape(series=longCondition, title="Buy Signal", location=location.belowbar, color=color.green, style=shape.triangleup, size=size.small, text="BUY")
//lotshape(series=shortCondition, title="Sell Signal", location=location.abovebar, color=color.red, style=shape.triangledown, size=size.small, text="SELL")
