// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © VanHe1sing

//@version=5
indicator("Modern Portfolio Theory", shorttitle = "[MPT]", max_labels_count = 500)

//======================================================================================================================}
// - User Inputs
//======================================================================================================================{

int BarScale = input(150, "Bar Scale")
float rfr    = input.float(0.048, "Risk-Free Rate")
int strt_year= input(2010, "Portfolio Start Year")

data         = timestamp(strt_year, 01, 01, 0, 0)

float weight1 = input.float(10, "Weight 1", group = "Weight's", inline = "W") / 100
float weight2 = input.float(22, "Weight 2", group = "Weight's", inline = "W") / 100
float weight3 = input.float(5, "Weight 3", group = "Weight's", inline = "W") / 100
float weight4 = input.float(27, "Weight 4", group = "Weight's", inline = "W") / 100
float weight5 = input.float(10, "Weight 5", group = "Weight's", inline = "W") / 100
float weight6 = input.float(5, "Weight 6", group = "Weight's", inline = "W") / 100
float weight7 = input.float(3, "Weight 7", group = "Weight's", inline = "W") / 100
float weight8 = input.float(3, "Weight 8", group = "Weight's", inline = "W") / 100
float weight9 = input.float(5, "Weight 9", group = "Weight's", inline = "W") / 100
float weight10= input.float(10, "Weight 10", group = "Weight's", inline = "W") / 100

bool use_sym1 = input.bool(true, "Use Symbol 1?", inline = "Use?")
bool use_sym2 = input.bool(true, "Use Symbol 2?", inline = "Use?")
bool use_sym3 = input.bool(true, "Use Symbol 3?", inline = "Use?")
bool use_sym4 = input.bool(true, "Use Symbol 4?", inline = "Use?")
bool use_sym5 = input.bool(true, "Use Symbol 5?", inline = "Use?")
bool use_sym6 = input.bool(true, "Use Symbol 6?", inline = "Use?")
bool use_sym7 = input.bool(true, "Use Symbol 7?", inline = "Use?")
bool use_sym8 = input.bool(true, "Use Symbol 8?", inline = "Use?")
bool use_sym9 = input.bool(true, "Use Symbol 9?", inline = "Use?")
bool use_sym10= input.bool(true, "Use Symbol 10?", inline = "Use?")

sym1 =     input.symbol("    INDEX:BTCUSD    ", "    Symbol 1    ", inline = "Sym", group = "Symbol's")
sym2 =     input.symbol("    INDEX:ETHUSD    ", "    Symbol 2    ", inline = "Sym", group = "Symbol's")
sym3 =     input.symbol("    BINANCE:AAVEUSD    ", "    Symbol 3    ", inline = "Sym", group = "Symbol's")
sym4 =     input.symbol("    BINANCE:BNBUSD    ", "    Symbol 4    ", inline = "Sym", group = "Symbol's")
sym5 =     input.symbol("    BINANCE:SOLUSD    ", "    Symbol 5    ", inline = "Sym", group = "Symbol's")
sym6 =     input.symbol("    BINANCE:XRPUSD    ", "    Symbol 6    ", inline = "Sym", group = "Symbol's")
sym7 =     input.symbol("    BINANCE:ETCUSD    ", "    Symbol 7    ", inline = "Sym", group = "Symbol's")
sym8 =     input.symbol("    BINANCE:ADAUSD    ", "    Symbol 8    ", inline = "Sym", group = "Symbol's")
sym9 =     input.symbol("    BINANCE:AVAXUSD    ", "    Symbol 9    ", inline = "Sym", group = "Symbol's")
sym10 = input.symbol("    BINANCE:RUNEUSD    ", "    Symbol 10    ", inline = "Sym", group = "Symbol's")

//======================================================================================================================}
// - Declaration of Functions
//======================================================================================================================{
// Clean symbol from exchange name
clean_symbol(symbol)=>
    sym = str.split(symbol, ":")
    sym.get(1)

// Risk and Return Function
risk_return(src)=>
    var returns_array   = array.new_float(0)
    float root          = math.sqrt(365)

    if time >= data
        daily_return = 0.0
        //Daily Asset Returns 
        //formula -> (previous_value/current_value - 1)
        daily_return := src/src[1] - 1
        returns_array.push(daily_return)

    X = returns_array.stdev()*root
    Y = returns_array.avg()*root

    [X, Y]

// Scatter Plot
scatter(float xPosition, float yPosition, color  Color,
             int BarScale, string symbol, nodeChar = "⦿", nodeSize1 =  size.small, nodeSize =  size.normal) =>
    if barstate.islast
        float Y2 =     nz(yPosition)
        int   X2 = int(nz(xPosition) * BarScale)
        X2 := math.min(500, X2) + bar_index
   
        node = label.new(X2, Y2, nodeChar,  size=nodeSize,
                             color=#00000000, textcolor=Color,
                             style=label.style_label_center)

        nodeChar1 =  symbol
        label.new(X2+10, Y2, nodeChar1,  size=nodeSize1,
                         color=#00000000, textcolor=color.new(Color, 50),
                         style=label.style_label_center)

        label.new(bar_index, Y2, text= symbol + "  " + str.tostring(math.round(yPosition,3)), 
                 style = label.style_label_right, size = size.small, color = Color, textcolor = #000000)

        label.new(X2, 0, text= str.tostring(math.round(xPosition-1,2)), 
                 style = label.style_label_up, size = size.small, color = Color, textcolor = #000000)

//======================================================================================================================}
// - X & Y Values
//======================================================================================================================{
[    X1    ,    Y1    ] = request.security(    sym1    ,"", risk_return(close))
[    X2    ,    Y2    ] = request.security(    sym2    ,"", risk_return(close))
[    X3    ,    Y3    ] = request.security(    sym3    ,"", risk_return(close))
[    X4    ,    Y4    ] = request.security(    sym4    ,"", risk_return(close))
[    X5    ,    Y5    ] = request.security(    sym5    ,"", risk_return(close))
[    X6    ,    Y6    ] = request.security(    sym6    ,"", risk_return(close))
[    X7    ,    Y7    ] = request.security(    sym7    ,"", risk_return(close))
[    X8    ,    Y8    ] = request.security(    sym8    ,"", risk_return(close))
[    X9    ,    Y9    ] = request.security(    sym9    ,"", risk_return(close))
[    X10    ,    Y10    ] = request.security(    sym10    ,"", risk_return(close))

//======================================================================================================================}
// - Plots and AVG Portfolio ★
//======================================================================================================================{

var tbl = table.new(position.bottom_right, 15, 15, frame_color = #474747, frame_width = 2)

table.cell(tbl, 0, 0, "Symbol's", text_color = #f3f3f3)
table.cell(tbl, 0, 1, clean_symbol(    sym1    ), text_color = color.gray)
table.cell(tbl, 0, 2, clean_symbol(    sym2    ), text_color = color.gray)
table.cell(tbl, 0, 3, clean_symbol(    sym3    ), text_color = color.gray)
table.cell(tbl, 0, 4, clean_symbol(    sym4    ), text_color = color.gray)
table.cell(tbl, 0, 5, clean_symbol(    sym5    ), text_color = color.gray)
table.cell(tbl, 0, 6, clean_symbol(    sym6    ), text_color = color.gray)
table.cell(tbl, 0, 7, clean_symbol(    sym7    ), text_color = color.gray)
table.cell(tbl, 0, 8, clean_symbol(    sym8    ), text_color = color.gray)
table.cell(tbl, 0, 9, clean_symbol(    sym9    ), text_color = color.gray)
table.cell(tbl, 0, 10,clean_symbol(    sym10    ), text_color = color.gray)

table.cell(tbl, 1, 0, "Weight's", text_color = #f3f3f3)
table.cell(tbl, 1, 1, str.tostring(use_sym1 ? weight1*100 : 0, format.percent), text_color = color.gray)
table.cell(tbl, 1, 2, str.tostring(use_sym2 ?weight2*100 : 0, format.percent), text_color = color.gray)
table.cell(tbl, 1, 3, str.tostring(use_sym3 ?weight3*100 : 0, format.percent), text_color = color.gray)
table.cell(tbl, 1, 4, str.tostring(use_sym4 ?weight4*100 : 0, format.percent), text_color = color.gray)
table.cell(tbl, 1, 5, str.tostring(use_sym5 ?weight5*100 : 0, format.percent), text_color = color.gray)
table.cell(tbl, 1, 6, str.tostring(use_sym6 ?weight6*100 : 0, format.percent), text_color = color.gray)
table.cell(tbl, 1, 7, str.tostring(use_sym7 ?weight7*100 : 0, format.percent), text_color = color.gray)
table.cell(tbl, 1, 8, str.tostring(use_sym8 ?weight8*100 : 0, format.percent), text_color = color.gray)
table.cell(tbl, 1, 9, str.tostring(use_sym9 ?weight9*100 : 0, format.percent), text_color = color.gray)
table.cell(tbl, 1, 10,str.tostring(use_sym10 ?weight10*100 : 0, format.percent), text_color = color.gray)

table.cell(tbl, 0, 11, "Total", text_color = #f3f3f3)

sum = ((use_sym1 ? weight1 : 0)
     + (use_sym2 ? weight2 : 0)
     + (use_sym3 ? weight3 : 0)
     + (use_sym4 ? weight4 : 0)
     + (use_sym5 ? weight5 : 0)
     + (use_sym6 ? weight6 : 0)
     + (use_sym7 ? weight7 : 0)
     + (use_sym8 ? weight8 : 0)
     + (use_sym9 ? weight9 : 0)
     + (use_sym10 ? weight10 : 0)) * 100

table.cell(tbl, 1, 11, 
     str.tostring(sum, format.percent), 
     text_color = sum < 100 ? color.orange : sum == 100 ? color.green : color.red, 
     text_size = sum == 100 ? size.large : sum > 100 ? size.huge : size.large)
if sum < 100
    table.cell(tbl, 0, 12, "Cash", text_color = #f3f3f3)
    table.cell(tbl, 1, 12, str.tostring(100-sum, format.percent), text_color = #f3f3f3, text_size = size.large)

//Gradient colors of scatter plot marks
y_max = math.max(Y1, Y2, Y3,Y4,Y5,Y6,Y7,Y8,Y9,Y10)

y_min = math.min(Y1, Y2, Y3,Y4,Y5,Y6,Y7,Y8,Y9,Y10)

gradient(val)=>
    color_ = color.from_gradient(val, y_min,
                                 y_max, color.rgb(135, 223, 138), color.aqua)

color_1= gradient(    Y1    ), scatter(    X1    ,    Y1    ,    color_1    , BarScale, clean_symbol(    sym1    ))
color_2= gradient(    Y2    ), scatter(    X2    ,    Y2    ,    color_2    , BarScale, clean_symbol(    sym2    ))
color_3= gradient(    Y3    ), scatter(    X3    ,    Y3    ,    color_3    , BarScale, clean_symbol(    sym3    ))
color_4= gradient(    Y4    ), scatter(    X4    ,    Y4    ,    color_4    , BarScale, clean_symbol(    sym4    ))
color_5= gradient(    Y5    ), scatter(    X5    ,    Y5    ,    color_5    , BarScale, clean_symbol(    sym5    ))
color_6= gradient(    Y6    ), scatter(    X6    ,    Y6    ,    color_6    , BarScale, clean_symbol(    sym6    ))
color_7= gradient(    Y7    ), scatter(    X7    ,    Y7    ,    color_7    , BarScale, clean_symbol(    sym7    ))
color_8= gradient(    Y8    ), scatter(    X8    ,    Y8    ,    color_8    , BarScale, clean_symbol(    sym8    ))
color_9= gradient(    Y9    ), scatter(    X9    ,    Y9    ,    color_9    , BarScale, clean_symbol(    sym9    ))
color_10= gradient(    Y10    ), scatter(    X10    ,    Y10    ,    color_10, BarScale, clean_symbol(    sym10    ))

// Portfolio

// Risk and Return of Portfolio
x_portfolio = (use_sym1 ? X1*weight1 : 0)
 + (use_sym2 ? X2*weight2 : 0)
 + (use_sym3 ? X3*weight3 : 0)
 + (use_sym4 ? X4*weight4 : 0)
 + (use_sym5 ? X5*weight5 : 0)
 + (use_sym6 ? X6*weight6 : 0)
 + (use_sym7 ? X7*weight7 : 0)
 + (use_sym8 ? X8*weight8 : 0)
 + (use_sym9 ? X9*weight9 : 0)
 + (use_sym10 ? X10*weight10 : 0)

y_portfolio = (use_sym1 ? Y1*weight1 : 0)  
 + (use_sym2 ? Y2*weight2 : 0)
 + (use_sym3 ? Y3*weight3 : 0)
 + (use_sym4 ? Y4*weight4 : 0)
 + (use_sym5 ? Y5*weight5 : 0)
 + (use_sym6 ? Y6*weight6 : 0)
 + (use_sym7 ? Y7*weight7 : 0)
 + (use_sym8 ? Y8*weight8 : 0)
 + (use_sym9 ? Y9*weight9 : 0)
 + (use_sym10 ? Y10*weight10 : 0)


// Plot of Portfolio
scatter(x_portfolio, y_portfolio, color.red, BarScale, "Portfolio", "★", size.small, size.huge)

// Axis lines with labels
if barstate.islast
    x_max = math.round(math.max(X1,X2,X3,X4,X5,X6,X7,X8,X9,X10)*250)
    y_max := y_max+(y_max/10)

    X = bar_index
    X2 = int(nz(x_portfolio) * BarScale)
    X2 := math.min(500, X2) + bar_index

    // Background
    box.new(X+x_max, y_max, X, 0, #ffffff00, bgcolor = #ffffff07)

    // Return Axis
    label.new(X, y_max, "RETURN (Mean Daily Returns)", textcolor = #d6d6d6, style = label.style_none)
    line.new(X, 0.0, X, y_max, color=color.gray,
                     style=line.style_solid,  width=1)
 
    // Risk Axis
    label.new(X+x_max, 0, "RISK (Standart Deviation)", textcolor = #d6d6d6, style = label.style_none)
    line.new(X+x_max, 0.0, X, 0.0, color=color.gray,
                     style=line.style_solid,  width=1)

    // Legend
    y_max := y_max - (y_max/10)
    x_max := x_max + 50
    label.new(X+x_max, y_max, "  ★ - Manually Optimized Portfolio", textcolor = color.red, style = label.style_none)
    label.new(X+x_max, y_max-y_max/35, "⦿ - Coins (X - Risk, Y - Return)", textcolor = color.rgb(82, 255, 232), style = label.style_none)
    label.new(X+x_max, y_max-y_max/15, "Portfolio from " + str.tostring(strt_year), textcolor = #6b6b6b, style = label.style_none)

    // Capital allocation line (CAL)
    line.new(X2, 0.0, X2, y_portfolio, color=#474747,
                     style=line.style_dotted,  width=1)
                     
    line.new(X2, y_portfolio, X, y_portfolio, color=#474747,
                     style=line.style_dotted,  width=1)
    //(CAL) and risk-free rate
    line.new(X2, y_portfolio, X, 0+rfr, color=#474747,
                     style=line.style_dashed,  width=1)

    label.new(X+15, 0+rfr, "Risk-Free Rate \n" + str.tostring(rfr*100, format.percent), textcolor = #d6d6d6, style = label.style_none)

    
//★
