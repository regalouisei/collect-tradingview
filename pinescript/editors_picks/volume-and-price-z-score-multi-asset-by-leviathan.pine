// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © LeviathanCapital

//@version=5
indicator("Volume and Price Z-Score [Multi-Asset] - By Leviathan", max_labels_count = 500, max_lines_count = 500, max_boxes_count = 100)

g1  = 'Symbols'
g2  = 'General'
g3  = 'Columns/Circles'
g4  = 'Scatter Plot'
g10 = 'Heatmap'
g5  = 'Group 1'
g6  = 'Group 2'
g7  = 'Group 3'
g8  = 'Group 4'
g9  = 'Group 5'

tt1 = 'Select the group of symbols that should be displayed. The symbols can be adjusted in the last section of indicator settings'
tt2 = 'Select the color palette'
tt3 = 'Select how the data should be displayed'
tt4 = 'Mean is the moving average of price/volume (fundamental part of calculating the z-score). This input controls the length of the moving average'
tt5 = 'This input determines the length of the moving average for calculating the Average Z-Score. '
tt6 = 'Select the type of z-score you wish to display. Please read more about this in indicator description.'
tt7 = 'Select the timeframe used in calculations. Default is current chart timeframe.'
tt8 = 'Select the type of volume used for calculating volume z-score. Please read more about this in indicator description.'
tt9 = 'Select the type of moving average used for calculating the mean. SMA equally weights all prices in the period. Gives more weight to recent values, making it more sensitive to recent action.'

// General
ztype         = input.string('Current Z-Score', 'Z-Score Type', options = ['Current Z-Score', 'Average Z-Score', 'Relative Z-Score'], tooltip = tt6, display = display.none)
disp          = input.string('Scatter Plot', 'Display', ['Circles', 'Scatter Plot', 'Columns', 'Z-Price Heatmap', 'Z-Volume Heatmap', 'Z-Delta Heatmap', 'Delta Columns'], tooltip = tt3, display = display.none)
meantype      = input.string('SMA', 'Mean Type', ['SMA', 'EMA'], tooltip = tt9, display = display.none)
zlen          = input.int(20, 'Mean Length', tooltip = tt4, display = display.none)
azlen         = input.int(14, 'Average Z-Score Length', tooltip = tt5, display = display.none)
voltype       = input.string('VOLUME', 'Volume Type', ['VOLUME', 'OBV'], tooltip = tt8, display = display.none)
gn            = input.string('Group 1', 'Asset Group', options = ['Group 1', 'Group 2', 'Group 3', 'Group 4'], tooltip = tt1, display = display.none)
pl            = input.string('Palette 1', 'Color Palette', ['Palette 1', 'Palette 2', 'Palette 3', 'Palette 4', 'Palette 5'], tooltip = tt2, display = display.none)
tf            = input.timeframe('', 'Bar Timeframe', tooltip = tt7, display = display.none) 
showtitle     = input.bool(true, 'Show Title', display = display.none)

// Scatter
priceshape    = input.string('Circle', 'Shape & Transparency', options = ['Circle', 'Square', 'Diamond'], group = g4, inline = 'sp', display = display.none)
trans         = input.int(50, '', group = g4, inline = 'sp', display = display.none)
showquadr     = input.bool(true, 'Square (σ)    ', inline = 'quadrant', group = g4, display = display.none)
quadr         = input.float(1, '', step = 0.1, inline = 'quadrant', group = g4, display = display.none)
quadrcol      = input.color(color.gray, '', inline = 'quadrant', group = g4, display = display.none)
quadrbgcol    = input.color(color.rgb(120, 123, 134, 100), '', inline = 'quadrant', group = g4, display = display.none)
showquadr1    = input.bool(true, 'Square (σ)    ', inline = 'quadrant1', group = g4, display = display.none)
quadr1        = input.float(2, '', step = 0.1, inline = 'quadrant1', group = g4, display = display.none)
quadrcol1     = input.color(color.gray, '', inline = 'quadrant1', group = g4, display = display.none)
quadrbgcol1   = input.color(color.rgb(120, 123, 134, 100), '', inline = 'quadrant1', group = g4, display = display.none)
showquadr2    = input.bool(true, 'Square (σ)    ', inline = 'quadrant2', group = g4, display = display.none)
quadr2        = input.float(3, '', step = 0.1, inline = 'quadrant2', group = g4, display = display.none)
quadrcol2     = input.color(color.gray, '', inline = 'quadrant2', group = g4, display = display.none)
quadrbgcol2   = input.color(color.rgb(120, 123, 134, 100), '', inline = 'quadrant2', group = g4, display = display.none)
gridcol       = #787b861f
gridcol2      = #787b868f
lblplotscond  = input.string('Outliers', 'Symbol names', options = ['Outliers', 'All', 'None'], group = g4, inline = 'lblcol', display = display.none)
lblplotscol   = input.color(color.gray, '', inline = 'lblcol', group = g4, display = display.none)
outlierstd    = input.float(1, ' SD(σ) >', group = g4, inline = 'lblcol', display = display.none)
helperlab     = input.bool(true, 'Helper Labels', group = g4, display = display.none)

// Circles
zprice        = input.bool(true, '', inline = 'p', group = g3, display = display.none)
zvol          = input.bool(true, '', inline = 'v', group = g3, display = display.none)
priceshape2   = input.string('Circle', 'Z-Price  ', options = ['Circle', 'Square', 'Diamond'], inline = 'p', group = g3, display = display.none)
volshape      = input.string('Circle', 'Z-Volume', options = ['Circle', 'Square', 'Diamond'], inline = 'v', group = g3, display = display.none)

// Heatmap
hmpos         = input.string('1', 'Heatmap Position', ['1', '2', '3', '4', '5'], group = g10, display = display.none)
hmcoltype     = input.string('Two-Color', 'Color coding', ['Two-Color', 'Multi-Color'], group = g10, display = display.none)
colh1         = input.color(#b22222, 'Multi-Color (High->Low)', inline = 'hm', group = g10, display = display.none)  
colh2         = input.color(#ffa07a, '', inline = 'hm', group = g10, display = display.none)  
colh3         = input.color(#ffebeb, '', inline = 'hm', group = g10, display = display.none)  
colc1         = input.color(#4682b4, '', inline = 'hm', group = g10, display = display.none)  
colc2         = input.color(#add8e6, '', inline = 'hm', group = g10, display = display.none)  
colc3         = input.color(#f0f8ff, '', inline = 'hm', group = g10, display = display.none)  
colhh         = input.color(#FF6161, 'Two-Color (High->Low)', inline = 'hm2', group = g10, display = display.none)
colcc         = input.color(#1A237E, '', inline = 'hm2', group = g10, display = display.none)


// Function for switching object shape
switchshape(x) =>
    switch x
        'Circle'  => label.style_circle
        'Square'  => label.style_square
        'Diamond' => label.style_diamond


sym1  = input.symbol('BINANCE:BTCUSDT.P', ''     , group = g1, display = display.none), sym41 = input.symbol('BINANCE:ZROUSDT.P', ''      , group = g2, display = display.none), sym81  = input.symbol('BINANCE:SANDUSDT.P', ''    , group = g3, display = display.none), sym121 = input.symbol('BINANCE:XEMUSDT.P', ''  , group = g4, display = display.none)
sym2  = input.symbol('BINANCE:ETHUSDT.P', ''     , group = g1, display = display.none), sym42 = input.symbol('BINANCE:SUNUSDT.P', ''      , group = g2, display = display.none), sym82  = input.symbol('BINANCE:1000LUNCUSDT.P', '', group = g3, display = display.none), sym122 = input.symbol('BINANCE:KSMUSDT.P', ''  , group = g4, display = display.none)
sym3  = input.symbol('BINANCE:SOLUSDT.P', ''     , group = g1, display = display.none), sym43 = input.symbol('BINANCE:UNIUSDT.P', ''      , group = g2, display = display.none), sym83  = input.symbol('BINANCE:STMXUSDT.P', ''    , group = g3, display = display.none), sym123 = input.symbol('BINANCE:XTZUSDT.P', ''  , group = g4, display = display.none)
sym4  = input.symbol('BINANCE:SUIUSDT.P', ''     , group = g1, display = display.none), sym44 = input.symbol('BINANCE:FILUSDT.P', ''      , group = g2, display = display.none), sym84  = input.symbol('BINANCE:CFXUSDT.P', ''     , group = g3, display = display.none), sym124 = input.symbol('BINANCE:BONDUSDT.P', '' , group = g4, display = display.none)
sym5  = input.symbol('BINANCE:1000PEPEUSDT.P', '', group = g1, display = display.none), sym45 = input.symbol('BINANCE:ICPUSDT.P', ''      , group = g2, display = display.none), sym85  = input.symbol('BINANCE:1INCHUSDT.P', ''   , group = g3, display = display.none), sym125 = input.symbol('BINANCE:ANKRUSDT.P', '' , group = g4, display = display.none)
sym6  = input.symbol('BINANCE:WIFUSDT.P', ''     , group = g1, display = display.none), sym46 = input.symbol('BINANCE:STRKUSDT.P', ''     , group = g2, display = display.none), sym86  = input.symbol('BINANCE:LINAUSDT.P', ''    , group = g3, display = display.none), sym126 = input.symbol('BINANCE:ALICEUSDT.P', '', group = g4, display = display.none)
sym7  = input.symbol('BINANCE:REEFUSDT.P', ''    , group = g1, display = display.none), sym47 = input.symbol('BINANCE:OPUSDT.P', ''       , group = g2, display = display.none), sym87  = input.symbol('BINANCE:MANAUSDT.P', ''    , group = g3, display = display.none), sym127 = input.symbol('BINANCE:LQTYUSDT.P', '' , group = g4, display = display.none)
sym8  = input.symbol('BINANCE:BNBUSDT.P', ''     , group = g1, display = display.none), sym48 = input.symbol('BINANCE:SEIUSDT.P', ''      , group = g2, display = display.none), sym88  = input.symbol('BINANCE:BLURUSDT.P', ''    , group = g3, display = display.none), sym128 = input.symbol('BINANCE:AXLUSDT.P', ''  , group = g4, display = display.none)
sym9  = input.symbol('BINANCE:FETUSDT.P', ''     , group = g1, display = display.none), sym49 = input.symbol('BINANCE:SAGAUSDT.P', ''     , group = g2, display = display.none), sym89  = input.symbol('BINANCE:IMXUSDT.P', ''     , group = g3, display = display.none), sym129 = input.symbol('BINANCE:ZILUSDT.P', ''  , group = g4, display = display.none)
sym10 = input.symbol('BINANCE:DOGSUSDT.P', ''    , group = g1, display = display.none), sym50 = input.symbol('BINANCE:DARUSDT.P', ''      , group = g2, display = display.none), sym90  = input.symbol('BINANCE:GRTUSDT.P', ''     , group = g3, display = display.none), sym130 = input.symbol('BINANCE:KLAYUSDT.P', '' , group = g4, display = display.none)
sym11 = input.symbol('BINANCE:NEIROETHUSDT.P', '', group = g1, display = display.none), sym51 = input.symbol('BINANCE:TAOUSDT.P', ''      , group = g2, display = display.none), sym91  = input.symbol('BINANCE:TURBOUSDT.P', ''   , group = g3, display = display.none), sym131 = input.symbol('BINANCE:CELRUSDT.P', '' , group = g4, display = display.none)
sym12 = input.symbol('BINANCE:AAVEUSDT.P', ''    , group = g1, display = display.none), sym52 = input.symbol('BINANCE:1000FLOKIUSDT.P', '', group = g2, display = display.none), sym92  = input.symbol('BINANCE:ACEUSDT.P', ''     , group = g3, display = display.none), sym132 = input.symbol('BINANCE:SPELLUSDT.P', '', group = g4, display = display.none)
sym13 = input.symbol('BINANCE:ORDIUSDT.P', ''    , group = g1, display = display.none), sym53 = input.symbol('BINANCE:STXUSDT.P', ''      , group = g2, display = display.none), sym93  = input.symbol('BINANCE:XLMUSDT.P', ''     , group = g3, display = display.none), sym133 = input.symbol('BINANCE:OMGUSDT.P', ''  , group = g4, display = display.none)
sym14 = input.symbol('BINANCE:DOGEUSDT.P', ''    , group = g1, display = display.none), sym54 = input.symbol('BINANCE:1000BONKUSDT.P', '' , group = g2, display = display.none), sym94  = input.symbol('BINANCE:WOOUSDT.P', ''     , group = g3, display = display.none), sym134 = input.symbol('BINANCE:JOEUSDT.P', ''  , group = g4, display = display.none)
sym15 = input.symbol('BINANCE:1000SATSUSDT.P', '', group = g1, display = display.none), sym55 = input.symbol('BINANCE:RUNEUSDT.P', ''     , group = g2, display = display.none), sym95  = input.symbol('BINANCE:COMPUSDT.P', ''    , group = g3, display = display.none), sym135 = input.symbol('BINANCE:KEYUSDT.P', ''  , group = g4, display = display.none)
sym16 = input.symbol('BINANCE:XRPUSDT.P', ''     , group = g1, display = display.none), sym56 = input.symbol('BINANCE:1000RATSUSDT.P', '' , group = g2, display = display.none), sym96  = input.symbol('BINANCE:XMRUSDT.P', ''     , group = g3, display = display.none), sym136 = input.symbol('BINANCE:LRCUSDT.P', ''  , group = g4, display = display.none)
sym17 = input.symbol('BINANCE:SUPERUSDT.P', ''   , group = g1, display = display.none), sym57 = input.symbol('BINANCE:DOTUSDT.P', ''      , group = g2, display = display.none), sym97  = input.symbol('BINANCE:SUSHIUSDT.P', ''   , group = g3, display = display.none), sym137 = input.symbol('BINANCE:IDUSDT.P', ''   , group = g4, display = display.none)
sym18 = input.symbol('BINANCE:TONUSDT.P', ''     , group = g1, display = display.none), sym58 = input.symbol('BINANCE:ARPAUSDT.P', ''     , group = g2, display = display.none), sym98  = input.symbol('BINANCE:AXSUSDT.P', ''     , group = g3, display = display.none), sym138 = input.symbol('BINANCE:FXSUSDT.P', ''  , group = g4, display = display.none)
sym19 = input.symbol('BINANCE:WLDUSDT.P', ''     , group = g1, display = display.none), sym59 = input.symbol('BINANCE:1000SHIBUSDT.P', '' , group = g2, display = display.none), sym99  = input.symbol('BINANCE:SSVUSDT.P', ''     , group = g3, display = display.none), sym139 = input.symbol('BINANCE:XVSUSDT.P', ''  , group = g4, display = display.none)
sym20 = input.symbol('BINANCE:POPCATUSDT.P', ''  , group = g1, display = display.none), sym60 = input.symbol('BINANCE:APTUSDT.P', ''      , group = g2, display = display.none), sym100 = input.symbol('BINANCE:THETAUSDT.P', ''   , group = g3, display = display.none), sym140 = input.symbol('BINANCE:TLMUSDT.P', ''  , group = g4, display = display.none)
sym21 = input.symbol('BINANCE:FTMUSDT.P', ''     , group = g1, display = display.none), sym61 = input.symbol('BINANCE:ARBUSDT.P', ''      , group = g2, display = display.none), sym101 = input.symbol('BINANCE:BAKEUSDT.P', ''    , group = g3, display = display.none), sym141 = input.symbol('BINANCE:ONTUSDT.P', ''  , group = g4, display = display.none)
sym22 = input.symbol('BINANCE:AVAXUSDT.P', ''    , group = g1, display = display.none), sym62 = input.symbol('BINANCE:ARUSDT.P', ''       , group = g2, display = display.none), sym102 = input.symbol('BINANCE:LPTUSDT.P', ''     , group = g3, display = display.none), sym142 = input.symbol('BINANCE:POLYXUSDT.P', '', group = g4, display = display.none)
sym23 = input.symbol('BINANCE:ADAUSDT.P', ''     , group = g1, display = display.none), sym63 = input.symbol('BINANCE:GALAUSDT.P', ''     , group = g2, display = display.none), sym103 = input.symbol('BINANCE:SXPUSDT.P', ''     , group = g3, display = display.none), sym143 = input.symbol('BINANCE:OXTUSDT.P', ''  , group = g4, display = display.none)
sym24 = input.symbol('BINANCE:GMTUSDT.P', ''     , group = g1, display = display.none), sym64 = input.symbol('BINANCE:ATOMUSDT.P', ''     , group = g2, display = display.none), sym104 = input.symbol('BINANCE:SNXUSDT.P', ''     , group = g3, display = display.none), sym144 = input.symbol('BINANCE:NMRUSDT.P', ''  , group = g4, display = display.none)
sym25 = input.symbol('BINANCE:NOTUSDT.P', ''     , group = g1, display = display.none), sym65 = input.symbol('BINANCE:TRXUSDT.P', ''      , group = g2, display = display.none), sym105 = input.symbol('BINANCE:MASKUSDT.P', ''    , group = g3, display = display.none), sym145 = input.symbol('BINANCE:ILVUSDT.P', ''  , group = g4, display = display.none)
sym26 = input.symbol('BINANCE:PENDLEUSDT.P', ''  , group = g1, display = display.none), sym66 = input.symbol('BINANCE:RENDERUSDT.P', ''   , group = g2, display = display.none), sym106 = input.symbol('BINANCE:NEOUSDT.P', ''     , group = g3, display = display.none), sym146 = input.symbol('BINANCE:LOOMUSDT.P', '' , group = g4, display = display.none)
sym27 = input.symbol('BINANCE:PEOPLEUSDT.P', ''  , group = g1, display = display.none), sym67 = input.symbol('BINANCE:EOSUSDT.P', ''      , group = g2, display = display.none), sym107 = input.symbol('BINANCE:MAGICUSDT.P', ''   , group = g3, display = display.none), sym147 = input.symbol('BINANCE:HFTUSDT.P', ''  , group = g4, display = display.none)
sym28 = input.symbol('BINANCE:ENAUSDT.P', ''     , group = g1, display = display.none), sym68 = input.symbol('BINANCE:TRBUSDT.P', ''      , group = g2, display = display.none), sym108 = input.symbol('BINANCE:ZECUSDT.P', ''     , group = g3, display = display.none), sym148 = input.symbol('BINANCE:POWRUSDT.P', '' , group = g4, display = display.none)
sym29 = input.symbol('BINANCE:COTIUSDT.P', ''    , group = g1, display = display.none), sym69 = input.symbol('BINANCE:BNXUSDT.P', ''      , group = g2, display = display.none), sym109 = input.symbol('BINANCE:ROSEUSDT.P', ''    , group = g3, display = display.none), sym149 = input.symbol('BINANCE:BNTUSDT.P', ''  , group = g4, display = display.none)
sym30 = input.symbol('BINANCE:INJUSDT.P', ''     , group = g1, display = display.none), sym70 = input.symbol('BINANCE:ENSUSDT.P', ''      , group = g2, display = display.none), sym110 = input.symbol('BINANCE:QNTUSDT.P', ''     , group = g3, display = display.none), sym150 = input.symbol('BINANCE:SYSUSDT.P', ''  , group = g4, display = display.none)
sym31 = input.symbol('BINANCE:NEARUSDT.P', ''    , group = g1, display = display.none), sym71 = input.symbol('BINANCE:ETCUSDT.P', ''      , group = g2, display = display.none), sym111 = input.symbol('BINANCE:API3USDT.P', ''    , group = g3, display = display.none), sym151 = input.symbol('BINANCE:METISUSDT.P', '', group = g4, display = display.none)
sym32 = input.symbol('BINANCE:RAREUSDT.P', ''    , group = g1, display = display.none), sym72 = input.symbol('BINANCE:DYDXUSDT.P', ''     , group = g2, display = display.none), sym112 = input.symbol('BINANCE:ASTRUSDT.P', ''    , group = g3, display = display.none), sym152 = input.symbol('BINANCE:CHESSUSDT.P', '', group = g4, display = display.none)
sym33 = input.symbol('BINANCE:LTCUSDT.P', ''     , group = g1, display = display.none), sym73 = input.symbol('BINANCE:JASMYUSDT.P', ''    , group = g2, display = display.none), sym113 = input.symbol('BINANCE:UMAUSDT.P', ''     , group = g3, display = display.none), sym153 = input.symbol('BINANCE:AEVOUSDT.P', '' , group = g4, display = display.none)
sym34 = input.symbol('BINANCE:TIAUSDT.P', ''     , group = g1, display = display.none), sym74 = input.symbol('BINANCE:MKRUSDT.P', ''      , group = g2, display = display.none), sym114 = input.symbol('BINANCE:AUCTIONUSDT.P', '' , group = g3, display = display.none), sym154 = input.symbol('BINANCE:ALGOUSDT.P', '' , group = g4, display = display.none)
sym35 = input.symbol('BINANCE:LINKUSDT.P', ''    , group = g1, display = display.none), sym75 = input.symbol('BINANCE:RDNTUSDT.P', ''     , group = g2, display = display.none), sym115 = input.symbol('BINANCE:BALUSDT.P', ''     , group = g3, display = display.none), sym155 = input.symbol('BINANCE:AMBUSDT.P', ''  , group = g4, display = display.none)
sym36 = input.symbol('BINANCE:BCHUSDT.P', ''     , group = g1, display = display.none), sym76 = input.symbol('BINANCE:LDOUSDT.P', ''      , group = g2, display = display.none), sym116 = input.symbol('BINANCE:TNSRUSDT.P', ''    , group = g3, display = display.none), sym156 = input.symbol('BINANCE:ARKUSDT.P', ''  , group = g4, display = display.none)
sym37 = input.symbol('BINANCE:CRVUSDT.P', ''     , group = g1, display = display.none), sym77 = input.symbol('BINANCE:ARKMUSDT.P', ''     , group = g2, display = display.none), sym117 = input.symbol('BINANCE:LITUSDT.P', ''     , group = g3, display = display.none), sym157 = input.symbol('BINANCE:ATAUSDT.P', ''  , group = g4, display = display.none)
sym38 = input.symbol('BINANCE:APEUSDT.P', ''     , group = g1, display = display.none), sym78 = input.symbol('BINANCE:ONDOUSDT.P', ''     , group = g2, display = display.none), sym118 = input.symbol('BINANCE:ZENUSDT.P', ''     , group = g3, display = display.none), sym158 = input.symbol('BINANCE:ACHUSDT.P', ''  , group = g4, display = display.none)
sym39 = input.symbol('BINANCE:BOMEUSDT.P', ''    , group = g1, display = display.none), sym79 = input.symbol('BINANCE:JUPUSDT.P', ''      , group = g2, display = display.none), sym119 = input.symbol('BINANCE:SKLUSDT.P', ''     , group = g3, display = display.none), sym159 = input.symbol('BINANCE:AIUSDT.P', ''   , group = g4, display = display.none)
sym40 = input.symbol('BINANCE:BIGTIMEUSDT.P', '' , group = g1, display = display.none), sym80 = input.symbol('BINANCE:ZKUSDT.P', ''       , group = g2, display = display.none), sym120 = input.symbol('BINANCE:HOTUSDT.P', ''     , group = g3, display = display.none), sym160 = input.symbol('BINANCE:ALPHAUSDT.P', '', group = g4, display = display.none)

// Assigning symbols to groups
S1  = gn=='Group 1' ? sym1  : gn=='Group 2' ? sym41  : gn=='Group 3' ? sym81   : sym121   
S2  = gn=='Group 1' ? sym2  : gn=='Group 2' ? sym42  : gn=='Group 3' ? sym82   : sym122  
S3  = gn=='Group 1' ? sym3  : gn=='Group 2' ? sym43  : gn=='Group 3' ? sym83   : sym123  
S4  = gn=='Group 1' ? sym4  : gn=='Group 2' ? sym44  : gn=='Group 3' ? sym84   : sym124  
S5  = gn=='Group 1' ? sym5  : gn=='Group 2' ? sym45  : gn=='Group 3' ? sym85   : sym125  
S6  = gn=='Group 1' ? sym6  : gn=='Group 2' ? sym46  : gn=='Group 3' ? sym86   : sym126  
S7  = gn=='Group 1' ? sym7  : gn=='Group 2' ? sym47  : gn=='Group 3' ? sym87   : sym127  
S8  = gn=='Group 1' ? sym8  : gn=='Group 2' ? sym48  : gn=='Group 3' ? sym88   : sym128  
S9  = gn=='Group 1' ? sym9  : gn=='Group 2' ? sym49  : gn=='Group 3' ? sym89   : sym129  
S10 = gn=='Group 1' ? sym10 : gn=='Group 2' ? sym50  : gn=='Group 3' ? sym90   : sym130  
S11 = gn=='Group 1' ? sym11 : gn=='Group 2' ? sym51  : gn=='Group 3' ? sym91   : sym131  
S12 = gn=='Group 1' ? sym12 : gn=='Group 2' ? sym52  : gn=='Group 3' ? sym92   : sym132  
S13 = gn=='Group 1' ? sym13 : gn=='Group 2' ? sym53  : gn=='Group 3' ? sym93   : sym133  
S14 = gn=='Group 1' ? sym14 : gn=='Group 2' ? sym54  : gn=='Group 3' ? sym94   : sym134  
S15 = gn=='Group 1' ? sym15 : gn=='Group 2' ? sym55  : gn=='Group 3' ? sym95   : sym135  
S16 = gn=='Group 1' ? sym16 : gn=='Group 2' ? sym56  : gn=='Group 3' ? sym96   : sym136  
S17 = gn=='Group 1' ? sym17 : gn=='Group 2' ? sym57  : gn=='Group 3' ? sym97   : sym137  
S18 = gn=='Group 1' ? sym18 : gn=='Group 2' ? sym58  : gn=='Group 3' ? sym98   : sym138  
S19 = gn=='Group 1' ? sym19 : gn=='Group 2' ? sym59  : gn=='Group 3' ? sym99   : sym139  
S20 = gn=='Group 1' ? sym20 : gn=='Group 2' ? sym60  : gn=='Group 3' ? sym100  : sym140  
S21 = gn=='Group 1' ? sym21 : gn=='Group 2' ? sym61  : gn=='Group 3' ? sym101  : sym141  
S22 = gn=='Group 1' ? sym22 : gn=='Group 2' ? sym62  : gn=='Group 3' ? sym102  : sym142  
S23 = gn=='Group 1' ? sym23 : gn=='Group 2' ? sym63  : gn=='Group 3' ? sym103  : sym143  
S24 = gn=='Group 1' ? sym24 : gn=='Group 2' ? sym64  : gn=='Group 3' ? sym104  : sym144  
S25 = gn=='Group 1' ? sym25 : gn=='Group 2' ? sym65  : gn=='Group 3' ? sym105  : sym145  
S26 = gn=='Group 1' ? sym26 : gn=='Group 2' ? sym66  : gn=='Group 3' ? sym106  : sym146  
S27 = gn=='Group 1' ? sym27 : gn=='Group 2' ? sym67  : gn=='Group 3' ? sym107  : sym147  
S28 = gn=='Group 1' ? sym28 : gn=='Group 2' ? sym68  : gn=='Group 3' ? sym108  : sym148  
S29 = gn=='Group 1' ? sym29 : gn=='Group 2' ? sym69  : gn=='Group 3' ? sym109  : sym149  
S30 = gn=='Group 1' ? sym30 : gn=='Group 2' ? sym70  : gn=='Group 3' ? sym110  : sym150  
S31 = gn=='Group 1' ? sym31 : gn=='Group 2' ? sym71  : gn=='Group 3' ? sym111  : sym151  
S32 = gn=='Group 1' ? sym32 : gn=='Group 2' ? sym72  : gn=='Group 3' ? sym112  : sym152  
S33 = gn=='Group 1' ? sym33 : gn=='Group 2' ? sym73  : gn=='Group 3' ? sym113  : sym153  
S34 = gn=='Group 1' ? sym34 : gn=='Group 2' ? sym74  : gn=='Group 3' ? sym114  : sym154  
S35 = gn=='Group 1' ? sym35 : gn=='Group 2' ? sym75  : gn=='Group 3' ? sym115  : sym155  
S36 = gn=='Group 1' ? sym36 : gn=='Group 2' ? sym76  : gn=='Group 3' ? sym116  : sym156  
S37 = gn=='Group 1' ? sym37 : gn=='Group 2' ? sym77  : gn=='Group 3' ? sym117  : sym157  
S38 = gn=='Group 1' ? sym38 : gn=='Group 2' ? sym78  : gn=='Group 3' ? sym118  : sym158  
S39 = gn=='Group 1' ? sym39 : gn=='Group 2' ? sym79  : gn=='Group 3' ? sym119  : sym159  
S40 = gn=='Group 1' ? sym40 : gn=='Group 2' ? sym80  : gn=='Group 3' ? sym120  : sym160 

// Assigning colors to palettes
C1  = pl=='Palette 1' ? #a0e4c0 : pl=='Palette 2' ? #8DD3C7 : pl=='Palette 3' ? #1F77B4 : pl=='Palette 4' ? #D32F2F : #007BFF
C2  = pl=='Palette 1' ? #7d8bae : pl=='Palette 2' ? #FFFFB3 : pl=='Palette 3' ? #FF7F0E : pl=='Palette 4' ? #1976D2 : #1C56AC
C3  = pl=='Palette 1' ? #e5857b : pl=='Palette 2' ? #BEBADA : pl=='Palette 3' ? #2CA02C : pl=='Palette 4' ? #388E3C : #0082CC
C4  = pl=='Palette 1' ? #f1b2b2 : pl=='Palette 2' ? #FB8072 : pl=='Palette 3' ? #D62728 : pl=='Palette 4' ? #FBC02D : #3D8DD9
C5  = pl=='Palette 1' ? #e8ccc7 : pl=='Palette 2' ? #80B1D3 : pl=='Palette 3' ? #9467BD : pl=='Palette 4' ? #8E24AA : #0066B2
C6  = pl=='Palette 1' ? #506488 : pl=='Palette 2' ? #FDB462 : pl=='Palette 3' ? #8C564B : pl=='Palette 4' ? #E64A19 : #3498DB
C7  = pl=='Palette 1' ? #849bb1 : pl=='Palette 2' ? #B3DE69 : pl=='Palette 3' ? #E377C2 : pl=='Palette 4' ? #0288D1 : #0099E5
C8  = pl=='Palette 1' ? #e89c8f : pl=='Palette 2' ? #FCCDD3 : pl=='Palette 3' ? #7F7F7F : pl=='Palette 4' ? #7B1FA2 : #57A8FF
C9  = pl=='Palette 1' ? #f3c3c3 : pl=='Palette 2' ? #D9D9D9 : pl=='Palette 3' ? #BCBD22 : pl=='Palette 4' ? #C2185B : #6BBBFF
C10 = pl=='Palette 1' ? #eddbd2 : pl=='Palette 2' ? #BC80BD : pl=='Palette 3' ? #17BECF : pl=='Palette 4' ? #7C4DFF : #4C8DBE
C11 = pl=='Palette 1' ? #5b7085 : pl=='Palette 2' ? #CCEDC5 : pl=='Palette 3' ? #9EDAE5 : pl=='Palette 4' ? #00796B : #7EBFFF
C12 = pl=='Palette 1' ? #8badb5 : pl=='Palette 2' ? #DEDAC4 : pl=='Palette 3' ? #FFBB78 : pl=='Palette 4' ? #D35400 : #53A0D1
C13 = pl=='Palette 1' ? #d17584 : pl=='Palette 2' ? #FED9A6 : pl=='Palette 3' ? #98DF8A : pl=='Palette 4' ? #CDDC39 : #80CAFF
C14 = pl=='Palette 1' ? #f4c8c5 : pl=='Palette 2' ? #FFED6F : pl=='Palette 3' ? #D6616B : pl=='Palette 4' ? #9E9E9E : #4694BF
C15 = pl=='Palette 1' ? #ddd8da : pl=='Palette 2' ? #98DF8A : pl=='Palette 3' ? #C5B0D5 : pl=='Palette 4' ? #607D8B : #8ED5FF
C16 = pl=='Palette 1' ? #667c91 : pl=='Palette 2' ? #9EDAE5 : pl=='Palette 3' ? #C49C94 : pl=='Palette 4' ? #8BC34A : #3E86AD
C17 = pl=='Palette 1' ? #92c0b8 : pl=='Palette 2' ? #D53E4F : pl=='Palette 3' ? #F7B6D2 : pl=='Palette 4' ? #795548 : #9CE0FF
C18 = pl=='Palette 1' ? #be6e8d : pl=='Palette 2' ? #F46D43 : pl=='Palette 3' ? #C7C7C7 : pl=='Palette 4' ? #5D4037 : #3A79A1
C19 = pl=='Palette 1' ? #f7dde0 : pl=='Palette 2' ? #FDA861 : pl=='Palette 3' ? #DBDB8D : pl=='Palette 4' ? #9C27B0 : #B2E9FF
C20 = pl=='Palette 1' ? #d4d9dd : pl=='Palette 2' ? #ABDDA4 : pl=='Palette 3' ? #9EDAE5 : pl=='Palette 4' ? #FFEB3B : #316595
C21 = pl=='Palette 1' ? #70878e : pl=='Palette 2' ? #80B1D3 : pl=='Palette 3' ? #AEC7E8 : pl=='Palette 4' ? #00BCD4 : #C4F1FF
C22 = pl=='Palette 1' ? #99d2bc : pl=='Palette 2' ? #FDB462 : pl=='Palette 3' ? #FF9896 : pl=='Palette 4' ? #03A9F4 : #295089
C23 = pl=='Palette 1' ? #aa688b : pl=='Palette 2' ? #B3DE69 : pl=='Palette 3' ? #C5B0D5 : pl=='Palette 4' ? #E91E63 : #D6FAFF
C24 = pl=='Palette 1' ? #fad2e3 : pl=='Palette 2' ? #FCCDD3 : pl=='Palette 3' ? #C49C94 : pl=='Palette 4' ? #FF5722 : #20477D
C25 = pl=='Palette 1' ? #ccd3d9 : pl=='Palette 2' ? #D9D9D9 : pl=='Palette 3' ? #F7B6D2 : pl=='Palette 4' ? #4CAF50 : #E6FFFF
C26 = pl=='Palette 1' ? #7c938a : pl=='Palette 2' ? #BC80BD : pl=='Palette 3' ? #7FCDBB : pl=='Palette 4' ? #3F51B5 : #1E66A8
C27 = pl=='Palette 1' ? #a0a2e4 : pl=='Palette 2' ? #CCEDC5 : pl=='Palette 3' ? #D9D9D9 : pl=='Palette 4' ? #FFC107 : #A1D7FF
C28 = pl=='Palette 1' ? #966398 : pl=='Palette 2' ? #DEDAC4 : pl=='Palette 3' ? #DB8D41 : pl=='Palette 4' ? #FF9800 : #2773A3
C29 = pl=='Palette 1' ? #fbe7ec : pl=='Palette 2' ? #FED9A6 : pl=='Palette 3' ? #1CAE78 : pl=='Palette 4' ? #673AB7 : #ACE3FF
C30 = pl=='Palette 1' ? #e3ecf0 : pl=='Palette 2' ? #FFED6F : pl=='Palette 3' ? #AD494A : pl=='Palette 4' ? #212121 : #2E7FAD
C31 = pl=='Palette 1' ? #b4e1d1 : pl=='Palette 2' ? #8CAFCB : pl=='Palette 3' ? #8C6D31 : pl=='Palette 4' ? #BDBDBD : #B6EEFF
C32 = pl=='Palette 1' ? #6a82a3 : pl=='Palette 2' ? #C994C7 : pl=='Palette 3' ? #E7969C : pl=='Palette 4' ? #76FF03 : #257C99
C33 = pl=='Palette 1' ? #f09f9b : pl=='Palette 2' ? #E5F5E0 : pl=='Palette 3' ? #7B4173 : pl=='Palette 4' ? #00E5FF : #BEDFFF
C34 = pl=='Palette 1' ? #f9c9ca : pl=='Palette 2' ? #67A9CF : pl=='Palette 3' ? #A55194 : pl=='Palette 4' ? #FF1744 : #21708E
C35 = pl=='Palette 1' ? #e5d6d2 : pl=='Palette 2' ? #E31A1C : pl=='Palette 3' ? #8C6D31 : pl=='Palette 4' ? #651FFF : #C6E9FF
C36 = pl=='Palette 1' ? #455a6f : pl=='Palette 2' ? #74C476 : pl=='Palette 3' ? #B5CF6B : pl=='Palette 4' ? #FF9100 : #1D6380
C37 = pl=='Palette 1' ? #7694a1 : pl=='Palette 2' ? #F768A1 : pl=='Palette 3' ? #CE6DBD : pl=='Palette 4' ? #8D6E63 : #D1F4FF
C38 = pl=='Palette 1' ? #df8980 : pl=='Palette 2' ? #7FCDBB : pl=='Palette 3' ? #BD9E39 : pl=='Palette 4' ? #4E342E : #186573
C39 = pl=='Palette 1' ? #f5bcbc : pl=='Palette 2' ? #9E9AC8 : pl=='Palette 3' ? #6B6ECF : pl=='Palette 4' ? #1B5E20 : #DBFEFF
C40 = pl=='Palette 1' ? #c9cfcd : pl=='Palette 2' ? #FEB24C : pl=='Palette 3' ? #D6616B : pl=='Palette 4' ? #01579B : #155C6B

debugtitle = input.bool(false, 'Fix Ticker Titling')

// Creating symbol and color arrays
syms = array.new_string()
cols = array.new_color()

// Pushing symbols into an array
array.push(syms, S1 ), array.push(syms, S2 ), array.push(syms, S3 ), array.push(syms, S4 ), array.push(syms, S5 )
array.push(syms, S6 ), array.push(syms, S7 ), array.push(syms, S8 ), array.push(syms, S9 ), array.push(syms, S10)
array.push(syms, S11), array.push(syms, S12), array.push(syms, S13), array.push(syms, S14), array.push(syms, S15)
array.push(syms, S16), array.push(syms, S17), array.push(syms, S18), array.push(syms, S19), array.push(syms, S20)
array.push(syms, S21), array.push(syms, S22), array.push(syms, S23), array.push(syms, S24), array.push(syms, S25)
array.push(syms, S26), array.push(syms, S27), array.push(syms, S28), array.push(syms, S29), array.push(syms, S30)
array.push(syms, S31), array.push(syms, S32), array.push(syms, S33), array.push(syms, S34), array.push(syms, S35)
array.push(syms, S36), array.push(syms, S37), array.push(syms, S38), array.push(syms, S39), array.push(syms, S40)

// Pushing colors into an array
array.push(cols, C1 ), array.push(cols, C2 ), array.push(cols, C3 ), array.push(cols, C4)
array.push(cols, C5 ), array.push(cols, C6 ), array.push(cols, C7 ), array.push(cols, C8)
array.push(cols, C9 ), array.push(cols, C10), array.push(cols, C11), array.push(cols, C12)
array.push(cols, C13), array.push(cols, C14), array.push(cols, C15), array.push(cols, C16)
array.push(cols, C17), array.push(cols, C18), array.push(cols, C19), array.push(cols, C20)
array.push(cols, C21), array.push(cols, C22), array.push(cols, C23), array.push(cols, C24)
array.push(cols, C25), array.push(cols, C26), array.push(cols, C27), array.push(cols, C28)
array.push(cols, C29), array.push(cols, C30), array.push(cols, C31), array.push(cols, C32)
array.push(cols, C33), array.push(cols, C34), array.push(cols, C35), array.push(cols, C36)
array.push(cols, C37), array.push(cols, C38), array.push(cols, C39), array.push(cols, C40)

// Function for calculating the Z-Score
f_zscore(src) =>
    mean    = meantype=='SMA' ? ta.sma(src, zlen) : ta.ema(src, zlen)
    std_dev = ta.stdev(src, zlen)
    z_score = (src - mean) / std_dev

// Function for encoding price + volume data (a trick to overcome max 40 security call limit)
encode_data(closeVal, volumeVal) =>
    closeStr    = na(closeVal)  ? "na" : str.tostring(closeVal)
    volumeStr   = na(volumeVal) ? "na" : str.tostring(volumeVal)
    encodedData = closeStr + "|" + volumeStr
    encodedData

// Function for decoding price data
decode_close(encodedData) =>
    data = str.split(encodedData, "|")
    float closeVal = na
    if array.size(data) > 0
        for i = 0 to array.size(data)-1
            if na(closeVal)
                closeVal := str.tonumber(array.get(data, i))
            else
                closeVal := closeVal, str.tonumber(array.get(data, i))
    else
        closeVal := na
    closeVal

// Function for decoding volume data
decode_volume(encodedData) =>
    data = str.split(encodedData, "|")
    float volumeVal = na
    if array.size(data) > 1
        val = str.tonumber(array.get(data, 1))
        if not na(val)
            volumeVal := val
    volumeVal

// Function for fetching data
f_data(sym, t) =>
    vol          = voltype=='VOLUME' ? ta.sma(volume, 2) : ta.obv
    combinedData = request.security(sym, timeframe.period, encode_data(close, vol))
    dta          = t == 0 ? decode_close(combinedData) : decode_volume(combinedData)
    out          = ztype=='Current Z-Score' or ztype=='Relative Z-Score' ? f_zscore(dta) : ta.sma(f_zscore(dta), azlen)
    out > 4 ? 4 : out < -4 ? -4 : out

// Creating arrays for z-score values
Ps = array.new_float(40)
Vs = array.new_float(40)

// Fetching price and volume z-score data and pushing it into arrays
f_pushdata(index, p, v) =>
    array.set(Ps, index, p)
    array.set(Vs, index, v)

P1  = f_data(S1 , 0), V1  = f_data(S1 , 1), f_pushdata(0, P1 , V1  ), P2  = f_data(S2 , 0), V2  = f_data(S2 , 1), f_pushdata(1, P2 , V2 )
P3  = f_data(S3 , 0), V3  = f_data(S3 , 1), f_pushdata(2, P3 , V3  ), P4  = f_data(S4 , 0), V4  = f_data(S4 , 1), f_pushdata(3, P4 , V4 )
P5  = f_data(S5 , 0), V5  = f_data(S5 , 1), f_pushdata(4, P5 , V5  ), P6  = f_data(S6 , 0), V6  = f_data(S6 , 1), f_pushdata(5, P6 , V6 )
P7  = f_data(S7 , 0), V7  = f_data(S7 , 1), f_pushdata(6, P7 , V7  ), P8  = f_data(S8 , 0), V8  = f_data(S8 , 1), f_pushdata(7, P8 , V8 )
P9  = f_data(S9 , 0), V9  = f_data(S9 , 1), f_pushdata(8, P9 , V9  ), P10 = f_data(S10, 0), V10 = f_data(S10, 1), f_pushdata(9, P10, V10)
P11 = f_data(S11, 0), V11 = f_data(S11, 1), f_pushdata(10, P11, V11), P12 = f_data(S12, 0), V12 = f_data(S12, 1), f_pushdata(11, P12, V12)
P13 = f_data(S13, 0), V13 = f_data(S13, 1), f_pushdata(12, P13, V13), P14 = f_data(S14, 0), V14 = f_data(S14, 1), f_pushdata(13, P14, V14)
P15 = f_data(S15, 0), V15 = f_data(S15, 1), f_pushdata(14, P15, V15), P16 = f_data(S16, 0), V16 = f_data(S16, 1), f_pushdata(15, P16, V16)
P17 = f_data(S17, 0), V17 = f_data(S17, 1), f_pushdata(16, P17, V17), P18 = f_data(S18, 0), V18 = f_data(S18, 1), f_pushdata(17, P18, V18)
P19 = f_data(S19, 0), V19 = f_data(S19, 1), f_pushdata(18, P19, V19), P20 = f_data(S20, 0), V20 = f_data(S20, 1), f_pushdata(19, P20, V20)
P21 = f_data(S21, 0), V21 = f_data(S21, 1), f_pushdata(20, P21, V21), P22 = f_data(S22, 0), V22 = f_data(S22, 1), f_pushdata(21, P22, V22)
P23 = f_data(S23, 0), V23 = f_data(S23, 1), f_pushdata(22, P23, V23), P24 = f_data(S24, 0), V24 = f_data(S24, 1), f_pushdata(23, P24, V24)
P25 = f_data(S25, 0), V25 = f_data(S25, 1), f_pushdata(24, P25, V25), P26 = f_data(S26, 0), V26 = f_data(S26, 1), f_pushdata(25, P26, V26)
P27 = f_data(S27, 0), V27 = f_data(S27, 1), f_pushdata(26, P27, V27), P28 = f_data(S28, 0), V28 = f_data(S28, 1), f_pushdata(27, P28, V28)
P29 = f_data(S29, 0), V29 = f_data(S29, 1), f_pushdata(28, P29, V29), P30 = f_data(S30, 0), V30 = f_data(S30, 1), f_pushdata(29, P30, V30)
P31 = f_data(S31, 0), V31 = f_data(S31, 1), f_pushdata(30, P31, V31), P32 = f_data(S32, 0), V32 = f_data(S32, 1), f_pushdata(31, P32, V32)
P33 = f_data(S33, 0), V33 = f_data(S33, 1), f_pushdata(32, P33, V33), P34 = f_data(S34, 0), V34 = f_data(S34, 1), f_pushdata(33, P34, V34)
P35 = f_data(S35, 0), V35 = f_data(S35, 1), f_pushdata(34, P35, V35), P36 = f_data(S36, 0), V36 = f_data(S36, 1), f_pushdata(35, P36, V36)
P37 = f_data(S37, 0), V37 = f_data(S37, 1), f_pushdata(36, P37, V37), P38 = f_data(S38, 0), V38 = f_data(S38, 1), f_pushdata(37, P38, V38)
P39 = f_data(S39, 0), V39 = f_data(S39, 1), f_pushdata(38, P39, V39), P40 = f_data(S40, 0), V40 = f_data(S40, 1), f_pushdata(39, P40, V40)

// Relative/Second-Level Z-score
avgZscorePrice  = array.avg(Ps)
avgZscoreVolume = array.avg(Vs)
stdDevPrice     = array.stdev(Ps, false) 
stdDevVolume    = array.stdev(Vs, false)

relativeZscorePrice(P) => 
    out = (P - avgZscorePrice) / stdDevPrice
    out > 4 ? 4 : out < -4 ? -4 : out
relativeZscoreVolume(V) => 
    out = (V - avgZscoreVolume) / stdDevVolume
    out > 4 ? 4 : out < -4 ? -4 : out

// Modifying symbol names
ticker_names = array.new_string(40, na)

for i = 0 to 39
    full_ticker = array.get(syms, i)
    ticker_split = str.split(full_ticker, ":")
    short_ticker = array.get(ticker_split, 1)
    array.set(ticker_names, i, short_ticker)

// Creating an array with bar_index points
xs = array.new_int(0)
for i = 0 to 80
    array.push(xs, bar_index[i])

// Function for transforming Z-Score values into bar_index points
f_magic(value) =>
    index = 80 - int((value + 4) * 10)
    array.get(xs, index)

// Initializing labels
var label[] pLabels = array.new_label(40, na)
var label[] vLabels = array.new_label(40, na)
var label[] nLabels = array.new_label(40, na)
var label[] sLabels = array.new_label(40, na)
var box[]   pBoxes  = array.new_box(40, na)
var box[]   vBoxes  = array.new_box(40, na)

// Functions to create or update labels and boxes
createOrUpdateLabel(arr, idx, x_val, y_val, lbl_style, lbl_color, lbl_text) =>
    lbl = array.get(arr, idx)
    if (na(lbl))
        lbl := label.new(x_val, y_val, style = lbl_style, color = lbl_color, text = str.tostring(lbl_text), size = size.tiny, textcolor = lblplotscol)
        array.set(arr, idx, lbl)
    else
        label.set_x(lbl, x = x_val)

createOrUpdateBox(arr, idx, x1_val, y1_val, x2_val, y2_val, bg_color) =>
    bx = array.get(arr, idx)
    if (na(bx))
        bx := box.new(x1_val, y1_val, x2_val, y2_val, bgcolor = bg_color, border_color = chart.bg_color)
        array.set(arr, idx, bx)
    else
        box.set_left(bx, x1_val)
        box.set_right(bx, x2_val)

// Creating and updating labels and boxes
for i = 0 to 39
    yValueP   = ztype=='Relative Z-Score' ? relativeZscorePrice(array.get(Ps, i)) : array.get(Ps, i)
    yValueV   = ztype=='Relative Z-Score' ? relativeZscoreVolume(array.get(Vs, i)) : array.get(Vs, i)
    xValue    = 195 - i * 5
    PlblColor = disp == 'Columns' ? color.new(array.get(cols, i), 30) : array.get(cols, i)
    VlblColor = color.new(array.get(cols, i), trans)
    txt       = str.tostring(array.get(ticker_names, i))
    txt1      = array.get(str.split(txt, 'USD'), 0)

    if barstate.islast
        if disp == 'Circles'
            createOrUpdateLabel(pLabels, i, bar_index[xValue], yValueP, switchshape(priceshape), PlblColor, '')
            createOrUpdateLabel(nLabels, i, bar_index[xValue], -4.3, label.style_label_up, color.rgb(120, 123, 134, 100), debugtitle ? txt : txt1)
            createOrUpdateLabel(vLabels, i, bar_index[xValue], yValueV, switchshape(priceshape), VlblColor, '')
        
        if disp == 'Columns'
            createOrUpdateBox(pBoxes,    i, bar_index[xValue], yValueP, bar_index[xValue] -2, 0, PlblColor)
            createOrUpdateLabel(nLabels, i, bar_index[xValue], -4.3, label.style_label_up, color.rgb(54, 58, 69, 100), debugtitle ? txt : txt1)
            createOrUpdateBox(vBoxes,    i, bar_index[xValue] + 2, yValueV, bar_index[xValue], 0, VlblColor)

        if disp == 'Delta Columns'
            createOrUpdateBox(pBoxes,    i, bar_index[xValue] - 2, yValueP - yValueV, bar_index[xValue] + 2, 0, PlblColor)
            createOrUpdateLabel(nLabels, i, bar_index[xValue], -4.3, label.style_label_up, color.rgb(54, 58, 69, 100), debugtitle ? txt : txt1)

        if disp == 'Scatter Plot'
            cond = lblplotscond == 'Outliers' ? (yValueV > outlierstd or yValueV < -outlierstd) or (yValueP > outlierstd or yValueP < -outlierstd) : lblplotscond == 'All' ? true : false
            createOrUpdateLabel(sLabels, i, f_magic(yValueP), yValueV, switchshape(priceshape), VlblColor, cond ? (debugtitle ? txt : txt1) : '')

mainsty = line.style_solid
quadsty = line.style_dotted

// Creating chart grid and lines
hlines = array.new_line()
vlines = array.new_line()

var s = disp == 'Scatter Plot' ? 80 : 200
var b = disp == 'Scatter Plot' ? 0 : 2
var line[] horzLines = na

if (na(horzLines)) and disp!='Z-Price Heatmap' and disp!='Z-Volume Heatmap' and disp!='Z-Delta Heatmap'
    horzLines := array.new_line(9)
    array.set(horzLines, 0, line.new(bar_index[s],  0, bar_index + b,  0, color = disp == 'Scatter Plot' ? gridcol : gridcol2))
    array.set(horzLines, 1, line.new(bar_index[s], -4, bar_index + b, -4, color = disp == 'Scatter Plot' ? gridcol2 : gridcol))
    array.set(horzLines, 2, line.new(bar_index[s],  1, bar_index + b,  1, color = gridcol))
    array.set(horzLines, 3, line.new(bar_index[s],  2, bar_index + b,  2, color = gridcol))
    array.set(horzLines, 4, line.new(bar_index[s],  3, bar_index + b,  3, color = gridcol))
    array.set(horzLines, 5, line.new(bar_index[s],  4, bar_index + b,  4, color = gridcol))
    array.set(horzLines, 6, line.new(bar_index[s], -1, bar_index + b, -1, color = gridcol))
    array.set(horzLines, 7, line.new(bar_index[s], -2, bar_index + b, -2, color = gridcol))
    array.set(horzLines, 8, line.new(bar_index[s], -3, bar_index + b, -3, color = gridcol))

if (barstate.islast) and disp!='Z-Price Heatmap' and disp!='Z-Volume Heatmap' and disp!='Z-Delta Heatmap'
    for i = 0 to array.size(horzLines) - 1
        line.set_x2(array.get(horzLines, i), bar_index + b)
        line.set_x1(array.get(horzLines, i), bar_index[s])

var line[] vertLines  = na
var label[] hlaLabels = na

if (na(vertLines)) and disp=='Scatter Plot'
    vertLines := array.new_line(9)
    hlaLabels := array.new_label(9)
    
    array.set(vertLines, 0, line.new(bar_index[s], 4, bar_index[s], -4, color = color.rgb(120, 123, 134, 44)))
    array.set(hlaLabels, 0, label.new(bar_index[s], -4.3, text = '-4', textcolor = color.gray, style = label.style_label_up, color = na, size = size.tiny))
    array.set(vertLines, 1, line.new(bar_index[s - 10], 4, bar_index[s - 10], -4, style = mainsty, color = gridcol))
    array.set(hlaLabels, 1, label.new(bar_index[s - 10], -4.3, text = '-3', textcolor = color.gray, style = label.style_label_up, color = na, size = size.tiny))
    array.set(vertLines, 2, line.new(bar_index[s - 20], 4, bar_index[s - 20], -4, style = mainsty, color = gridcol))
    array.set(hlaLabels, 2, label.new(bar_index[s - 20], -4.3, text = '-2', textcolor = color.gray, style = label.style_label_up, color = na, size = size.tiny))
    array.set(vertLines, 3, line.new(bar_index[s - 30], 4, bar_index[s - 30], -4, style = mainsty, color = gridcol))
    array.set(hlaLabels, 3, label.new(bar_index[s - 30], -4.3, text = '-1', textcolor = color.gray, style = label.style_label_up, color = na, size = size.tiny))
    array.set(vertLines, 4, line.new(bar_index[s - 40], 4, bar_index[s - 40], -4, style = mainsty, color = gridcol))
    array.set(hlaLabels, 4, label.new(bar_index[s - 40], -4.3, text = '0', textcolor = color.gray, style = label.style_label_up, color = na, size = size.tiny))
    array.set(vertLines, 5, line.new(bar_index[s - 50], 4, bar_index[s - 50], -4, style = mainsty, color = gridcol))
    array.set(hlaLabels, 5, label.new(bar_index[s - 50], -4.3, text = '1', textcolor = color.gray, style = label.style_label_up, color = na, size = size.tiny))
    array.set(vertLines, 6, line.new(bar_index[s - 60], 4, bar_index[s - 60], -4, style = mainsty, color = gridcol))
    array.set(hlaLabels, 6, label.new(bar_index[s - 60], -4.3, text = '2', textcolor = color.gray, style = label.style_label_up, color = na, size = size.tiny))
    array.set(vertLines, 7, line.new(bar_index[s - 70], 4, bar_index[s - 70], -4, style = mainsty, color = gridcol))
    array.set(hlaLabels, 7, label.new(bar_index[s - 70], -4.3, text = '3', textcolor = color.gray, style = label.style_label_up, color = na, size = size.tiny))
    array.set(vertLines, 8, line.new(bar_index[s - 80], 4, bar_index[s - 80], -4, style = mainsty, color = gridcol))
    array.set(hlaLabels, 8, label.new(bar_index[s - 80], -4.3, text = '4', textcolor = color.gray, style = label.style_label_up, color = na, size = size.tiny))

if (barstate.islast) and disp=='Scatter Plot'
    for i = 0 to 8
        line.set_x1(array.get(vertLines, i), bar_index[s - i * 10])
        line.set_x2(array.get(vertLines, i), bar_index[s - i * 10])
        label.set_x(array.get(hlaLabels, i), bar_index[s - i * 10])

if showquadr and disp == 'Scatter Plot'
    q1 = box.new(f_magic(-quadr), quadr, f_magic(quadr), -quadr, quadrcol, border_style = quadsty, bgcolor = quadrbgcol, text = str.tostring(quadr) + 'σ', text_valign = text.align_top, text_size = size.normal, text_color = color.rgb(120, 123, 134, 40))
    box.delete(q1[1])
if showquadr1 and disp == 'Scatter Plot'
    q1 = box.new(f_magic(-quadr1), quadr1, f_magic(quadr1), -quadr1, quadrcol1, border_style = quadsty, bgcolor = quadrbgcol1, text = str.tostring(quadr1) + 'σ', text_valign = text.align_top, text_size = size.normal, text_color = color.rgb(120, 123, 134, 40))
    box.delete(q1[1])
if showquadr2 and disp == 'Scatter Plot'
    q1 = box.new(f_magic(-quadr2), quadr2, f_magic(quadr2), -quadr2, quadrcol2, border_style = quadsty, bgcolor = quadrbgcol2, text = str.tostring(quadr2) + 'σ', text_valign = text.align_top, text_size = size.normal, text_color = color.rgb(120, 123, 134, 40))
    box.delete(q1[1])

// Grid labels
offset                  = 0.04
var label[] valueLabels = na
var label[] guideLabels  = na
var label[] guideLabels2 = na

if (na(valueLabels)) and disp!='Z-Price Heatmap' and disp!='Z-Volume Heatmap' and disp!='Z-Delta Heatmap'
    valueLabels := array.new_label(10)
    
    array.set(valueLabels, 0, label.new(bar_index[s],  0 - offset,  text =   '0             ',    textcolor = color.gray, style = label.style_label_right, color = na, size = size.tiny))
    array.set(valueLabels, 1, label.new(bar_index[s],  1 - offset,  text =   '1             ',    textcolor = color.gray, style = label.style_label_right, color = na, size = size.tiny))
    array.set(valueLabels, 2, label.new(bar_index[s],  2 - offset,  text =   '2             ',    textcolor = color.gray, style = label.style_label_right, color = na, size = size.tiny))
    array.set(valueLabels, 3, label.new(bar_index[s],  3 - offset,  text =   '3             ',    textcolor = color.gray, style = label.style_label_right, color = na, size = size.tiny))
    array.set(valueLabels, 4, label.new(bar_index[s],  4 - offset,  text =   '4             ',    textcolor = color.gray, style = label.style_label_right, color = na, size = size.tiny))
    array.set(valueLabels, 5, label.new(bar_index[s], -1 - offset,  text =  '-1             ',    textcolor = color.gray, style = label.style_label_right, color = na, size = size.tiny))
    array.set(valueLabels, 6, label.new(bar_index[s], -2 - offset,  text =  '-2             ',    textcolor = color.gray, style = label.style_label_right, color = na, size = size.tiny))
    array.set(valueLabels, 7, label.new(bar_index[s], -3 - offset,  text =  '-3             ',    textcolor = color.gray, style = label.style_label_right, color = na, size = size.tiny))
    array.set(valueLabels, 8, label.new(bar_index[s], -4 - offset,  text =  '-4             ',    textcolor = color.gray, style = label.style_label_right, color = na, size = size.tiny))

if (barstate.islast) and disp!='Z-Price Heatmap' and disp!='Z-Volume Heatmap' and disp!='Z-Delta Heatmap'
    for i = 0 to 9
        label.set_x(array.get(valueLabels, i), bar_index[s])

if helperlab and (na(guideLabels)) and (na(guideLabels)) and disp=='Scatter Plot'
    guideLabels := array.new_label(2)
    guideLabels2 := array.new_label(2)
    array.set(guideLabels,  0, label.new(bar_index[s +4], -4.5 - offset,  text =  'Low Price - Low Volume',    textcolor = color.gray, style = label.style_label_right, color = #787b8624, size = size.small))
    array.set(guideLabels,  1, label.new(bar_index[s +4],  4.5 - offset,  text =  'Low Price - High Volume',   textcolor = color.gray, style = label.style_label_right, color = #787b8624, size = size.small))
    array.set(guideLabels2, 0, label.new(bar_index + 4,   -4.5 - offset,  text =  'High Price - Low Volume',  textcolor = color.gray, style = label.style_label_left,  color = #787b8624, size = size.small))
    array.set(guideLabels2, 1, label.new(bar_index + 4,    4.5 - offset,  text =  'High Price - High Volume',   textcolor = color.gray, style = label.style_label_left,  color = #787b8624, size = size.small))

if helperlab and barstate.islast and disp=='Scatter Plot'
    for i = 0 to 1
        label.set_x(array.get(guideLabels, i), bar_index[s + 4])
    for i = 0 to 1
        label.set_x(array.get(guideLabels2, i), bar_index + 4)

// Creating the title
table1 = table.new(position.top_center, 5,5)
if showtitle
    table.cell(table1, 0, 0, 'Price x Volume Z-Score: ' + str.tostring(disp), text_size = size.normal, text_color = color.gray)
    table.cell(table1, 0, 1, '• Period: ' + str.tostring(zlen) + '    ' + '• Timeframe: ' + str.tostring(tf=='' ? (timeframe.period + (timeframe.isminutes ? 'm' : '')) : tf) + '    • Data: ' + str.tostring(ztype), text_size = size.tiny, text_color = color.gray)

// Creating heatmap grid
f_vertoffs(n) =>
    hmpos=='1' ? n : hmpos=='2' ? -n : hmpos=='3' ? (-1*n - n) : hmpos=='4' ? (-2*n - n) : (-3*n - n)

h0  = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(40) : na,  display = display.none, color = na, editable = false)
h1  = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(39) : na,  display = display.none, color = na, editable = false)
h2  = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(38) : na,  display = display.none, color = na, editable = false)
h3  = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(37) : na,  display = display.none, color = na, editable = false)
h4  = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(36) : na,  display = display.none, color = na, editable = false)
h5  = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(35) : na,  display = display.none, color = na, editable = false)
h6  = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(34) : na,  display = display.none, color = na, editable = false)
h7  = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(33) : na,  display = display.none, color = na, editable = false)
h8  = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(32) : na,  display = display.none, color = na, editable = false)
h9  = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(31) : na,  display = display.none, color = na, editable = false)
h10 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(30) : na,  display = display.none, color = na, editable = false)
h11 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(29) : na,  display = display.none, color = na, editable = false)
h12 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(28) : na,  display = display.none, color = na, editable = false)
h13 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(27) : na,  display = display.none, color = na, editable = false)
h14 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(26) : na,  display = display.none, color = na, editable = false)
h15 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(25) : na,  display = display.none, color = na, editable = false)
h16 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(24) : na,  display = display.none, color = na, editable = false)
h17 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(23) : na,  display = display.none, color = na, editable = false)
h18 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(22) : na,  display = display.none, color = na, editable = false)
h19 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(21) : na,  display = display.none, color = na, editable = false)
h20 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(20) : na,  display = display.none, color = na, editable = false)
h21 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(19) : na,  display = display.none, color = na, editable = false)
h22 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(18) : na,  display = display.none, color = na, editable = false)
h23 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(17) : na,  display = display.none, color = na, editable = false)
h24 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(16) : na,  display = display.none, color = na, editable = false)
h25 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(15) : na,  display = display.none, color = na, editable = false)
h26 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(14) : na,  display = display.none, color = na, editable = false)
h27 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(13) : na,  display = display.none, color = na, editable = false)
h28 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(12) : na,  display = display.none, color = na, editable = false)
h29 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(11) : na,  display = display.none, color = na, editable = false)
h30 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(10) : na,  display = display.none, color = na, editable = false)
h31 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(9 ) : na,  display = display.none, color = na, editable = false)
h32 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(8 ) : na,  display = display.none, color = na, editable = false)
h33 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(7 ) : na,  display = display.none, color = na, editable = false)
h34 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(6 ) : na,  display = display.none, color = na, editable = false)
h35 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(5 ) : na,  display = display.none, color = na, editable = false)
h36 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(4 ) : na,  display = display.none, color = na, editable = false)
h37 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(3 ) : na,  display = display.none, color = na, editable = false)
h38 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(2 ) : na,  display = display.none, color = na, editable = false)
h39 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(1 ) : na,  display = display.none, color = na, editable = false)
h40 = hline(disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? f_vertoffs(0 ) : na,  display = display.none, color = na, editable = false)

// Function for calculating heatmap color-coding
f_hmcol(P, V) =>
    Px     = disp=='Z-Price Heatmap' ? (ztype=='Relative Z-Score' ? relativeZscorePrice(P) : P) : disp=='Z-Volume Heatmap' ? (ztype=='Relative Z-Score' ? relativeZscoreVolume(V) : V) : (ztype=='Relative Z-Score' ? (relativeZscorePrice(P) - relativeZscoreVolume(V)) : (P - V))
    hot    = color.from_gradient(Px,  0,  2, colh3, colh2) 
    vhot   = color.from_gradient(Px,  2,  4, colh2, colh1) 
    cold   = color.from_gradient(Px, -2,  0, colc2, colc3) 
    vcold  = color.from_gradient(Px, -4, -2, colc1, colc2) 
    out1   = Px == 0 ? colc3 : Px>0 and Px<2 ? hot : Px>2 ? vhot : Px<0 and Px>-2 ? cold : Px<-2 ? vcold : chart.bg_color
    out2   = color.from_gradient(Px, -4, 4, colcc, colhh)
    out    = hmcoltype=='Two-Color' ? out2 : out1

// Filling the grid with color-coded colors
fill(h0,  h1,  f_hmcol(P1 , V1 ))
fill(h1,  h2,  f_hmcol(P2 , V2 ))
fill(h2,  h3,  f_hmcol(P3 , V3 ))
fill(h3,  h4,  f_hmcol(P4 , V4 ))
fill(h4,  h5,  f_hmcol(P5 , V5 ))
fill(h5,  h6,  f_hmcol(P6 , V6 ))
fill(h6,  h7,  f_hmcol(P7 , V7 ))
fill(h7,  h8,  f_hmcol(P8 , V8 ))
fill(h8,  h9,  f_hmcol(P9 , V9 ))
fill(h9,  h10, f_hmcol(P10, V10))
fill(h10, h11, f_hmcol(P11, V11))
fill(h11, h12, f_hmcol(P12, V12))
fill(h12, h13, f_hmcol(P13, V13))
fill(h13, h14, f_hmcol(P14, V14))
fill(h14, h15, f_hmcol(P15, V15))
fill(h15, h16, f_hmcol(P16, V16))
fill(h16, h17, f_hmcol(P17, V17))
fill(h17, h18, f_hmcol(P18, V18))
fill(h18, h19, f_hmcol(P19, V19))
fill(h19, h20, f_hmcol(P20, V20))
fill(h20, h21, f_hmcol(P21, V21))
fill(h21, h22, f_hmcol(P22, V22))
fill(h22, h23, f_hmcol(P23, V23))
fill(h23, h24, f_hmcol(P24, V24))
fill(h24, h25, f_hmcol(P25, V25))
fill(h25, h26, f_hmcol(P26, V26))
fill(h26, h27, f_hmcol(P27, V27))
fill(h27, h28, f_hmcol(P28, V28))
fill(h28, h29, f_hmcol(P29, V29))
fill(h29, h30, f_hmcol(P30, V30))
fill(h30, h31, f_hmcol(P31, V31))
fill(h31, h32, f_hmcol(P32, V32))
fill(h32, h33, f_hmcol(P33, V33))
fill(h33, h34, f_hmcol(P34, V34))
fill(h34, h35, f_hmcol(P35, V35))
fill(h35, h36, f_hmcol(P36, V36))
fill(h36, h37, f_hmcol(P37, V37))
fill(h37, h38, f_hmcol(P38, V38))
fill(h38, h39, f_hmcol(P39, V39))
fill(h39, h40, f_hmcol(P40, V40))

// Creating heatmap symbol labels
var label[] tickerLabels = na
if disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap'
    if (na(tickerLabels))
        tickerLabels := array.new_label(40)
        
        for i = 0 to 39
            y_position = 39.5 - i
            y_position := f_vertoffs(y_position)
            txt       = str.tostring(array.get(ticker_names, i))
            txt1      = array.get(str.split(txt, 'USD'), 0)
            array.set(tickerLabels, i, label.new(bar_index + 1, y_position - offset * 1, text = debugtitle ? txt : txt1, xloc = xloc.bar_index, style = label.style_label_left, color = color.rgb(255, 235, 59, 100), textcolor = color.gray, size = size.small, textalign = text.align_left))
    else
        for i = 0 to 39
            lbl = array.get(tickerLabels, i)
            label.set_x(lbl, bar_index + 1)

// Scaling anchor
scaleanchorup   = disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? na : 5.3
scaleanchordown = disp=='Z-Price Heatmap' or disp=='Z-Volume Heatmap' or disp=='Z-Delta Heatmap' ? na : -5.3

plot(scaleanchorup,   display = display.pane, color = na, editable = false)
plot(scaleanchordown, display = display.pane, color = na, editable = false)
