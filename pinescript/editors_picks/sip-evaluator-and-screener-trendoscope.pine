// This work is licensed under Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License (CC BY-NC-SA 4.0) https://creativecommons.org/licenses/by-nc-sa/4.0/
// © Trendoscope Pty Ltd
//                                       ░▒             
//                                  ▒▒▒   ▒▒      
//                              ▒▒▒▒▒     ▒▒      
//                      ▒▒▒▒▒▒▒░     ▒     ▒▒          
//                  ▒▒▒▒▒▒           ▒     ▒▒          
//             ▓▒▒▒       ▒        ▒▒▒▒▒▒▒▒▒▒▒  
//   ▒▒▒▒▒▒▒▒▒▒▒ ▒        ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒         
//   ▒  ▒       ░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░        
//   ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░▒▒▒▒▒▒▒▒         
//   ▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒ ▒▒                       
//    ▒▒▒▒▒         ▒▒▒▒▒▒▒                            
//                 ▒▒▒▒▒▒▒▒▒                           
//                ▒▒▒▒▒ ▒▒▒▒▒                          
//               ░▒▒▒▒   ▒▒▒▒▓      ████████╗██████╗ ███████╗███╗   ██╗██████╗  ██████╗ ███████╗ ██████╗ ██████╗ ██████╗ ███████╗
//              ▓▒▒▒▒     ▒▒▒▒      ╚══██╔══╝██╔══██╗██╔════╝████╗  ██║██╔══██╗██╔═══██╗██╔════╝██╔════╝██╔═══██╗██╔══██╗██╔════╝
//              ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒        ██║   ██████╔╝█████╗  ██╔██╗ ██║██║  ██║██║   ██║███████╗██║     ██║   ██║██████╔╝█████╗ 
//             ▒▒▒▒▒       ▒▒▒▒▒       ██║   ██╔══██╗██╔══╝  ██║╚██╗██║██║  ██║██║   ██║╚════██║██║     ██║   ██║██╔═══╝ ██╔══╝  
//            ▒▒▒▒▒         ▒▒▒▒▒      ██║   ██║  ██║███████╗██║ ╚████║██████╔╝╚██████╔╝███████║╚██████╗╚██████╔╝██║     ███████╗
//             ▒▒             ▒                        
//@version=6
indicator('SIP Evaluator and Screener [Trendoscope®]', shorttitle = 'SC [Trendoscope®]', overlay = false)

enum PriceReference
    OPEN
    CLOSE
    HL2
    HLC3
    OHLC4

enum Period
    Bars
    Weeks
    Months

enum CommissionType
    Fixed = '$'
    Percentage = '%'

durationTooltip = 'Specifies the year from which the SIP calculations begin. When Start Year is enabled via the timebound option, '+
                         'the script only considers data from the specified year onward. This is useful for analyzing historical SIP performance '+
                         'over a defined period. If disabled, the script uses all available data.'
pricePrefereceTooltip = 'Determines the price used for purchasing units in each SIP installment. Options include: OPEN, CLOSE, HL2, HLC3, OHLC4'
recurringInvestmentTooltip = 'The fixed amount invested in each SIP installment (e.g., $1000 per period). '+
                                 'This represents the regular contribution to the SIP and directly influences the total invested amount and quantity purchased.'
allowFractionalTooltip = 'When enabled, the script allows the purchase of fractional units (e.g., 2.35 shares). '+
                             'If disabled, only whole units are purchased (e.g., 2 shares), with any remaining funds carried forward as Remainder. '+
                             'This setting impacts the precision of investment allocation.'
commissionTooltip = 'The commission charged per SIP installment, expressed as either a fixed amount (e.g., $3) or a percentage (e.g., 3% of the investment). '+
                             'This reduces the amount available for purchasing units.'
taxOnDividendTooltip = 'When enabled, a tax is applied to dividends before they are reinvested or recorded. '+
                             'The percentage of tax deducted from dividends if Apply Tax On Dividends is enabled '+
                             '(e.g., 47% tax reduces a $100 dividend to $53). This reduces the amount available for reinvestment or accumulation.'
reinvestDividendsTooltip = 'When enabled, dividends received are reinvested to purchase additional units after a specified period (e.g., 2 units of time, defined by Dividends Availability). '+
                             'If disabled, dividends are tracked but not reinvested. Reinvestment increases the total quantity and equity over time.'
timebound = input.bool(false, 'Start Year', inline = 't1', group = 'Duration', display = display.none)
startYear = input.int(2020, '', tooltip = durationTooltip, inline = 't1', group = 'Duration', display = display.none)
priceReference = input.enum(PriceReference.OPEN, 'Price Reference', tooltip = pricePrefereceTooltip, group = 'Investment', display = display.none)
incrementalInvestment = input.float(1000.0, 'Recurring Investment', tooltip = recurringInvestmentTooltip, group = 'Investment', display = display.none)
allowFractional = input.bool(true, 'Allow Fractional Qty', allowFractionalTooltip, group = 'Investment', display = display.none)

commissionValue = input.float(3, 'Commission', group = 'Commission', inline='c', display = display.none)
commissionType = input.enum(CommissionType.Fixed, '', group='Commission', inline='c', tooltip = commissionTooltip, display = display.none)

reinvestDividends = input.bool(true, 'Reinvest Dividends After', reinvestDividendsTooltip, group = 'Dividends', display = display.none, inline='ri')
dividendsAfter = input.int(2, '', group = 'Dividends', display = display.none, inline='ri')
dividendsAvailability = input.enum(Period.Bars, '', group = 'Dividends', display = display.none, inline='ri')
applyTax = input.bool(false, 'Apply Tax On Dividends',group='Dividends', display = display.none, inline='tax')
dividendTax = input.float(47, '', tooltip = taxOnDividendTooltip, group='Dividends', display = display.none, inline='tax')
type Instalment
    float amount
    float commission
    float dividend
    float qty
    float price
    int startDate = time

type Investment
    float totalAmount =0.0
    float commission = 0.0
    float dividends = 0.0
    float totalQty = 0.0
    int numberOfInstallments = 0
    float remainder = 0.0
    int startDate

method add(Investment this, Instalment instalment, float remainder)=>
    if(na(this.startDate))
        this.startDate := time
    this.totalAmount += instalment.amount
    this.commission += instalment.commission
    this.dividends += instalment.dividend
    this.totalQty += instalment.qty
    this.numberOfInstallments+=1
    this.remainder := remainder

type Dividend
    float amount
    int dTime = time
    int dBar = bar_index

method diff(Period dividendsAvailability, int timeFrom, int timeTo)=>
    days = (timeTo-timeFrom)/(1000*86400)
    weeks = days/7
    months = days/30.5
    dividendsAvailability == Period.Bars? timeTo - timeFrom :
         dividendsAvailability == Period.Weeks? weeks : 
         months

var allDividends = array.new<Dividend>()

var investmentInstallments = array.new<Instalment>()
var totalInvestment = Investment.new()

dividend = request.dividends(syminfo.tickerid, gaps = barmerge.gaps_on, lookahead = barmerge.lookahead_off, ignore_invalid_symbol=true)
if(not na(dividend))
    allDividends.push(Dividend.new(dividend))

currentDividend = 0.0
if(allDividends.size() > 0)
    firstDividend = allDividends.first()
    timeDiff = dividendsAvailability.diff(dividendsAvailability == Period.Bars? firstDividend.dBar: firstDividend.dTime,
                                             dividendsAvailability == Period.Bars?bar_index: time)
    if(timeDiff >= dividendsAfter)
        currentDividend := firstDividend.amount*totalInvestment.totalQty*(applyTax?(100-dividendTax)/100 : 1)
        allDividends.shift()

if not timebound or year(time) >= startYear
    var float investmentCurrent = 0.0
    investmentCurrent := investmentCurrent + incrementalInvestment + (reinvestDividends?currentDividend:0)
    price = priceReference == PriceReference.OPEN? open :
                 priceReference == PriceReference.CLOSE? close : 
                 priceReference == PriceReference.HL2? hl2:
                 priceReference == PriceReference.HLC3? hlc3: ohlc4
    commissionAdjustment = (1+commissionValue/100)
    fixedCommission = (commissionType==CommissionType.Fixed? commissionValue : 0)
    availableAmount = investmentCurrent - fixedCommission
    consideredPrice = commissionType==CommissionType.Fixed?price:price*commissionAdjustment
    qty = availableAmount/consideredPrice
    qty := allowFractional? qty : math.floor(qty)
    amount = allowFractional? availableAmount : qty*consideredPrice
    commisionNow = commissionType==CommissionType.Fixed? commissionValue : amount*commissionValue/100
    investmentCurrent := investmentCurrent - amount - fixedCommission
    instalment = Instalment.new(amount+fixedCommission, commisionNow, currentDividend, qty, price)
    log.info('{0},  : {1} - {2} // {3} // {4}', amount+fixedCommission, commisionNow, currentDividend, qty, investmentCurrent)
    totalInvestment.add(instalment, investmentCurrent)

gain = (totalInvestment.totalQty*close-(totalInvestment.totalAmount-(reinvestDividends?totalInvestment.dividends:0)))*100 / (totalInvestment.totalAmount-(reinvestDividends?totalInvestment.dividends:0))
plot(totalInvestment.numberOfInstallments, 'Installments', color.gray, display = display.data_window)
plot(totalInvestment.totalAmount-(reinvestDividends?totalInvestment.dividends:0), 'Invested', color.new(color.blue, 80), format=format.price, style = plot.style_area)
plot(totalInvestment.dividends, 'Dividends', color.new(color.green, 60), format=format.price, style = plot.style_area)
plot(totalInvestment.totalQty*close, 'Equity', color.new(color.purple, 80), style = plot.style_area)
plot(totalInvestment.remainder, 'Remainder', color.gray, display = display.data_window)
plot(gain, 'Gain%', color=color.silver, display = display.data_window, format=format.percent)
