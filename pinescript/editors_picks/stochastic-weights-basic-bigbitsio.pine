//@version=6

// 
// Pine Script v4
// @author BigBitsIO
// Script Library: https://www.tradingview.com/u/BigBitsIO/#published-scripts
//
indicator(title = 'Stochastic Weights - Basic [BigBitsIO]', shorttitle = 'SWB', overlay = false)

IConfig = input.string(title = 'Configuration', defval = 'Default', options = ['BigBitsIO Settings', 'Default'])

IenableStoch = input(true, title = 'Enable Stochastic')
IsmoothStochK = input.int(1, title = 'Stochastic K MA Length', minval = 1)
IlengthStoch = input.int(14, title = 'Stochastic Lookback Length', minval = 1)
IweightStoch = input.int(1, title = 'Stochastic Weight', minval = 1)

IenableStochRSI = input(true, title = 'Enable Stochastic RSI')
IsmoothStochRSIK = input.int(1, title = 'Stochastic RSI K MA Length', minval = 1)
IlengthStochRSI = input.int(14, title = 'Stochastic RSI - Stochastic Lookback Length', minval = 1)
IrsiLengthInStochRSI = input.int(14, title = 'Stochastic RSI - RSI Lookback Length', minval = 1)
IweightStochRSI = input.int(1, title = 'Stochastic RSI Weight', minval = 1)

IenableStochPC = input(true, title = 'Enable Stochastic PC [BigBitsIO]')
IsmoothStochPCK = input.int(1, title = 'Stochastic PC K MA Length', minval = 1)
IlengthStochPC = input.int(8, title = 'Stochastic PC Lookback Length', minval = 1)
IsuperStochPCFastSmoothLength = input.int(4, title = 'Stochastic PC Super Fast Smoothing Length', minval = 1)
IweightStochPC = input.int(1, title = 'Stochastic PC Weight', minval = 1)

IenableStochVOL = input(true, title = 'Enable Stochastic V [BigBitsIO]')
IsmoothStochVOLK = input.int(1, title = 'Stochastic V K MA Length', minval = 1)
IlengthStochVOL = input.int(14, title = 'Stochastic V Lookback Length', minval = 1)
IsuperStochVOLFastSmoothLength = input.int(6, title = 'Stochastic V Super Fast Smoothing Length', minval = 1)
IweightStochVOL = input.int(1, title = 'Stochastic V Weight', minval = 1)

IenableRSI = input(true, title = 'Enable RSI')
IrsiLength = input.int(14, minval = 1, title = 'RSI Lookback Length')
IweightRSI = input.int(1, title = 'RSI Weight', minval = 1)

IenableSmoothedRSI = input(true, title = 'Enable Smoothed RSI')
IsmoothedRSILength = input.int(14, minval = 1, title = 'Smoothed RSI Lookback Length')
IsmoothedRSISmoothLength = input(8, title = 'Smoothed RSI Smooth Length')
IsmoothedRSIType = input.string(title = 'Smoothed RSI MA Type', defval = 'HMA', options = ['RMA', 'SMA', 'EMA', 'WMA', 'HMA', 'DEMA', 'TEMA', 'VWMA'])
IweightSmoothedRSI = input.int(1, title = 'Smoothed RSI Weight', minval = 1)

IenableMFI = input(true, title = 'Enable MFI')
ImfiLength = input.int(14, minval = 1, title = 'MFI Lookback Length')
IweightMFI = input.int(1, title = 'MFI Weight', minval = 1)

IenableSmoothedMFI = input(true, title = 'Enable Smoothed MFI')
IsmoothedMFILength = input.int(14, minval = 1, title = 'Smoothed MFI Lookback Length')
IsmoothedMFISmoothLength = input(8, title = 'Smoothed MFI Smooth Length')
IsmoothedMFIType = input.string(title = 'Smoothed MFI MA Type', defval = 'HMA', options = ['RMA', 'SMA', 'EMA', 'WMA', 'HMA', 'DEMA', 'TEMA', 'VWMA'])
IweightSmoothedMFI = input.int(1, title = 'Smoothed MFI Weight', minval = 1)

IkLen = input(3, title = 'K Length')
IsmoothD = input.int(3, minval = 1, title = 'Stochastic D Length (only applies to weighted K)')

OS = input.int(20, title = 'Oversold Level', maxval = 100, minval = 0, step = 1)
VeryOS = input.int(10, title = 'Very Oversold Level', maxval = 100, minval = 0, step = 1)
OB = input.int(80, title = 'Overbought Level', maxval = 100, minval = 0, step = 1)
VeryOB = input.int(90, title = 'Very Oversold Level', maxval = 100, minval = 0, step = 1)

bool enableStoch = true
int smoothStochK = 3
int lengthStoch = 14
int weightStoch = 2

bool enableStochRSI = true
int smoothStochRSIK = 3
int lengthStochRSI = 14
int rsiLengthInStochRSI = 14
int weightStochRSI = 2

bool enableStochPC = true
int smoothStochPCK = 3
int lengthStochPC = 8
int superStochPCFastSmoothLength = 4
int weightStochPC = 2

bool enableStochVOL = true
int smoothStochVOLK = 3
int lengthStochVOL = 14
int superStochVOLFastSmoothLength = 6
int weightStochVOL = 3

bool enableRSI = true
int rsiLength = 14
int weightRSI = 5

bool enableSmoothedRSI = true
int smoothedRSILength = 14
int smoothedRSISmoothLength = 8
string smoothedRSIType = 'HMA'
int weightSmoothedRSI = 3

bool enableMFI = true
int mfiLength = 14
int weightMFI = 2

bool enableSmoothedMFI = true
int smoothedMFILength = 14
int smoothedMFISmoothLength = 8
string smoothedMFIType = 'HMA'
int weightSmoothedMFI = 3

int kLen = 3
int smoothD = 4

bool ConfirmWithRSI = false

float OBRSI = 80
float OSRSI = 20

int lbR = 0
int lbL = 20
int rangeUpper = 30
int rangeLower = 0
bool plotBull = true
bool plotBear = true

int bullRecency = 5
int bearRecency = 5

int QuickDivLength = 40
float QuickDivOSRequirement = 40
float QuickDivOBRequirement = 60


if IConfig == 'BigBitsIO Settings'
    enableStoch := true
    smoothStochK := 3
    lengthStoch := 14
    weightStoch := 2

    enableStochRSI := true
    smoothStochRSIK := 3
    lengthStochRSI := 14
    rsiLengthInStochRSI := 14
    weightStochRSI := 2

    enableStochPC := true
    smoothStochPCK := 3
    lengthStochPC := 8
    superStochPCFastSmoothLength := 4
    weightStochPC := 2

    enableStochVOL := true
    smoothStochVOLK := 3
    lengthStochVOL := 14
    superStochVOLFastSmoothLength := 6
    weightStochVOL := 3

    enableRSI := true
    rsiLength := 14
    weightRSI := 5

    enableSmoothedRSI := true
    smoothedRSILength := 14
    smoothedRSISmoothLength := 8
    smoothedRSIType := 'HMA'
    weightSmoothedRSI := 3

    enableMFI := true
    mfiLength := 14
    weightMFI := 2

    enableSmoothedMFI := true
    smoothedMFILength := 14
    smoothedMFISmoothLength := 8
    smoothedMFIType := 'HMA'
    weightSmoothedMFI := 3

    kLen := 3
    smoothD := 4

    ConfirmWithRSI := false

    OBRSI := 80
    OSRSI := 20

    //lbR = 0
    lbL := 20
    rangeUpper := 30
    rangeLower := 0
    plotBull := true
    plotBear := true

    bullRecency := 5
    bearRecency := 5

    QuickDivLength := 40
    QuickDivOSRequirement := 40
    QuickDivOBRequirement := 60
    QuickDivOBRequirement
else
    enableStoch := IenableStoch
    smoothStochK := IsmoothStochK
    lengthStoch := IlengthStoch
    weightStoch := IweightStoch

    enableStochRSI := IenableStochRSI
    smoothStochRSIK := IsmoothStochRSIK
    lengthStochRSI := IlengthStochRSI
    rsiLengthInStochRSI := IrsiLengthInStochRSI
    weightStochRSI := IweightStochRSI

    enableStochPC := IenableStochPC
    smoothStochPCK := IsmoothStochPCK
    lengthStochPC := IlengthStochPC
    superStochPCFastSmoothLength := IsuperStochPCFastSmoothLength
    weightStochPC := IweightStochPC

    enableStochVOL := IenableStochVOL
    smoothStochVOLK := IsmoothStochVOLK
    lengthStochVOL := IlengthStochVOL
    superStochVOLFastSmoothLength := IsuperStochVOLFastSmoothLength
    weightStochVOL := IweightStochVOL

    enableRSI := IenableRSI
    rsiLength := IrsiLength
    weightRSI := IweightRSI

    enableSmoothedRSI := IenableSmoothedRSI
    smoothedRSILength := IsmoothedRSILength
    smoothedRSISmoothLength := IsmoothedRSISmoothLength
    smoothedRSIType := IsmoothedRSIType
    weightSmoothedRSI := IweightSmoothedRSI

    enableMFI := IenableMFI
    mfiLength := ImfiLength
    weightMFI := IweightMFI

    enableSmoothedMFI := IenableSmoothedMFI
    smoothedMFILength := IsmoothedMFILength
    smoothedMFISmoothLength := IsmoothedMFISmoothLength
    smoothedMFIType := IsmoothedMFIType
    weightSmoothedMFI := IweightSmoothedMFI

    kLen := IkLen
    smoothD := IsmoothD



ma(MAType, MASource, MAPeriod) =>
    if MAPeriod > 0
        if MAType == 'SMA'
            ta.sma(MASource, MAPeriod)
        else if MAType == 'EMA'
            ta.ema(MASource, MAPeriod)
        else if MAType == 'WMA'
            ta.wma(MASource, MAPeriod)
        else if MAType == 'RMA'
            ta.rma(MASource, MAPeriod)
        else if MAType == 'HMA'
            ta.hma(MASource, MAPeriod)
        else if MAType == 'DEMA'
            e = ta.ema(MASource, MAPeriod)
            2 * e - ta.ema(e, MAPeriod)
        else if MAType == 'TEMA'
            e = ta.ema(MASource, MAPeriod)
            3 * (e - ta.ema(e, MAPeriod)) + ta.ema(ta.ema(e, MAPeriod), MAPeriod)
        else if MAType == 'VWMA'
            ta.vwma(MASource, MAPeriod)
        else
            ta.sma(MASource, MAPeriod)

res(MAResolution) =>
    if MAResolution == '00 Current'
        timeframe.period
    else if MAResolution == '01 1m'
        '1'
    else if MAResolution == '02 3m'
        '3'
    else if MAResolution == '03 5m'
        '5'
    else if MAResolution == '04 15m'
        '15'
    else if MAResolution == '05 30m'
        '30'
    else if MAResolution == '06 45m'
        '45'
    else if MAResolution == '07 1h'
        '60'
    else if MAResolution == '08 2h'
        '120'
    else if MAResolution == '09 3h'
        '180'
    else if MAResolution == '10 4h'
        '240'
    else if MAResolution == '11 1D'
        '1D'
    else if MAResolution == '12 1W'
        '1W'
    else if MAResolution == '13 1M'
        '1M'
    else
        timeframe.period

gettickerid(MACandleType) =>
    if MACandleType == '00 Current'
        syminfo.tickerid
    else if MACandleType == '01 Heikin Ashi'
        ticker.heikinashi(syminfo.tickerid)
    else if MACandleType == '02 Renko'
        ticker.renko(syminfo.tickerid, 'ATR', 10)
    else if MACandleType == '03 Line Break'
        ticker.linebreak(syminfo.tickerid, 3)
    else if MACandleType == '04 Kagi'
        ticker.kagi(syminfo.tickerid, 3)
    else if MACandleType == '05 Point & Figure'
        ticker.pointfigure(syminfo.tickerid, 'hl', 'Traditional', 1, 3)
    else
        syminfo.tickerid

int Weights = 0
float WeightedTotal = 0

float percentChange = 0
float SPC = 0
float StochPC = 0
if enableStochPC
    percentChange := (close - open) / open * 100
    SPC := ta.sma(percentChange, superStochPCFastSmoothLength)
    StochPC := ta.sma(ta.stoch(SPC, SPC, SPC, lengthStochPC), smoothStochPCK)
    Weights := Weights + weightStochPC
    WeightedTotal := WeightedTotal + StochPC * weightStochPC
    WeightedTotal

float Stoch = 0
if enableStoch
    Stoch := ta.sma(ta.stoch(close, high, low, lengthStoch), smoothStochK)
    Weights := Weights + weightStoch
    WeightedTotal := WeightedTotal + Stoch * weightStoch
    WeightedTotal

float RSIInStochRSI = 0
float StochRSI = 0
if enableStochRSI
    RSIInStochRSI := ta.rsi(close, rsiLengthInStochRSI)
    StochRSI := ta.sma(ta.stoch(RSIInStochRSI, RSIInStochRSI, RSIInStochRSI, lengthStochRSI), smoothStochRSIK)
    Weights := Weights + weightStochRSI
    WeightedTotal := WeightedTotal + StochRSI * weightStochRSI
    WeightedTotal

float RSI = 0
if enableRSI
    RSI := ta.rsi(close, rsiLength)
    Weights := Weights + weightRSI
    WeightedTotal := WeightedTotal + RSI * weightRSI
    WeightedTotal

float VOLInStochVOL = 0
float SVOL = 0
float StochVOL = 0
if enableStochVOL
    VOLInStochVOL := close >= open ? volume : volume * -1
    SVOL := ta.sma(VOLInStochVOL, superStochVOLFastSmoothLength)
    StochVOL := ta.sma(ta.stoch(SVOL, SVOL, SVOL, lengthStochVOL), smoothStochVOLK)
    Weights := Weights + weightStochVOL
    WeightedTotal := WeightedTotal + StochVOL * weightStochVOL
    WeightedTotal

float SmoothedRSIRSI = 0
float SmoothedRSI = 0
if enableSmoothedRSI
    SmoothedRSIRSI := ta.rsi(close, smoothedRSILength)
    SmoothedRSI := ma(smoothedRSIType, SmoothedRSIRSI, smoothedRSISmoothLength)
    Weights := Weights + weightSmoothedRSI
    WeightedTotal := WeightedTotal + SmoothedRSI * weightSmoothedRSI
    WeightedTotal

float MFI = 0
if enableMFI
    MFI := ta.mfi(hlc3, mfiLength)
    Weights := Weights + weightMFI
    WeightedTotal := WeightedTotal + MFI * weightMFI
    WeightedTotal

float SmoothedMFIMFI = 0
float SmoothedMFI = 0
if enableSmoothedMFI
    SmoothedMFIMFI := ta.mfi(hlc3, smoothedMFILength)
    SmoothedMFI := ma(smoothedMFIType, SmoothedMFIMFI, smoothedMFISmoothLength)
    Weights := Weights + weightSmoothedMFI
    WeightedTotal := WeightedTotal + SmoothedMFI * weightSmoothedMFI
    WeightedTotal

k = ta.sma(WeightedTotal / Weights, kLen)
d = ta.sma(k, smoothD)

plot(k, color = color.new(color.blue, 0), title = 'K (Weighted)')
plot(d, color = color.new(color.orange, 0), title = 'D')



OBl = hline(OB, title = 'Overbought', color = color.red, linewidth = 1, editable = false)
OSl = hline(OS, title = 'Oversold', color = color.green, linewidth = 1, editable = false)
Max = hline(100, title = 'Max', color = color.red, linewidth = math.max(1, 0), editable = false)
Min = hline(0, title = 'Min', color = color.green, linewidth = math.max(1, 0), editable = false)
hline(VeryOB, title = 'Very Overbought', color = color.red, linewidth = 1, editable = false)
hline(VeryOS, title = 'Very Oversold', color = color.green, linewidth = 1, editable = false)

fill(Min, OSl, title = 'Oversold Area', color = color.new(color.green, 90))
fill(OBl, Max, title = 'Overbought Area', color = color.new(color.red, 90))








//plot(obv)

bearColor = color.red
bullColor = color.green
hiddenBullColor = color.new(color.green, 80)
hiddenBearColor = color.new(color.red, 80)
textColor = color.white
noneColor = color.new(color.white, 100)

osc = d


isVeryOBLastBars = 0
isVeryOBLastBars := na(isVeryOBLastBars[1]) ? 0 : isVeryOBLastBars + 1
isVeryOB = k > VeryOB

isVeryOSLastBars = 0
isVeryOSLastBars := na(isVeryOSLastBars[1]) ? 0 : isVeryOSLastBars + 1
isVeryOS = k < VeryOS

plot(osc, title = 'RSI', linewidth = 2, color = color.new(#8D1699, 0))
hline(50, title = 'Middle Line', linestyle = hline.style_dotted)
obLevel = OB
osLevel = OS

plFound = na(ta.pivotlow(osc, lbL, lbR)) ? false : true
phFound = na(ta.pivothigh(osc, lbL, lbR)) ? false : true

_inRange(cond) =>
    bars = ta.barssince(cond == true)
    rangeLower <= bars and bars <= rangeUpper

plotshape(isVeryOB ? osc : na, title = 'Very Overbought', text = ' V OB ', style = shape.labeldown, location = location.absolute, color = color.new(bearColor, 0), textcolor = color.new(textColor, 0))

plotshape(isVeryOS ? osc : na, title = 'Very Oversold', text = ' V OS ', style = shape.labelup, location = location.absolute, color = color.new(bullColor, 0), textcolor = color.new(textColor, 0))

// Strategy 


alertcondition(isVeryOS, title = '1 - K is Very Oversold', message = 'K = {{plot_0}}')
alertcondition(isVeryOB, title = '2 - K is Very Overbought', message = 'K = {{plot_0}}')
