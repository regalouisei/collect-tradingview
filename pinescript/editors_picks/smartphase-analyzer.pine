// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © RWCS_LTD

//@version=6
indicator("SmartPhase Analyzer", overlay = false, max_bars_back = 500)
import RWCS_LTD/StatMetrics/1 as sm

// === INPUTS ===
length = input.int(50, "Lookback", minval=5)
lookback = input.int(100, "Dynamic Threshold Lookback")

benchmark_sym = input.symbol("INDEX:BTCUSD", "Benchmark Symbol")

// Enable/Disable switches
useSharpe     = input.bool(true,  "Include Sharpe")
useSortino    = input.bool(true,  "Include Sortino")
useOmega      = input.bool(true,  "Include Omega")
useCV         = input.bool(false, "Include CV")
useAlpha      = input.bool(true,  "Include Alpha")
useBeta       = input.bool(true,  "Include Beta")
useR2         = input.bool(false, "Include R²")
useEntropy    = input.bool(false, "Include Entropy")
useZscore     = input.bool(true,  "Include Z-score")
usePLF        = input.bool(true,  "Include PLF")
useSRI        = input.bool(true,  "Include SRI")
useDrawdown   = input.bool(false, "Include Max Drawdown")
useMomentum   = input.bool(true,  "Include Momentum Rank")

// === Price + Benchmark ===
price = close
benchmark = request.security(benchmark_sym, timeframe.period, close)

// === RAW METRICS ===
sharpe    = sm.sharpe(price, length)
sortino   = sm.sortino(price, length)
omega     = sm.omega(price, length)
cv        = sm.cv(price, length)
alpha     = sm.alpha(price, benchmark, length)
beta      = sm.beta(price, benchmark, length)
r2        = sm.r_squared(price / price[1] - 1, benchmark / benchmark[1] - 1, length)
entropy   = sm.entropy(price, length)
zval      = sm.zscore(price, length)
plf       = sm.plf(price, 50, 14, 3)
sri       = sm.sri(plf, 14)
drawdown  = sm.max_drawdown(price, length)
momentum  = sm.momentum_rank(price, length)

// === NORMALIZED METRICS ===
norm_sharpe   = sm.normalize(sharpe, length)
norm_sortino  = sm.normalize(sortino, length)
norm_omega    = sm.normalize(omega, length)
norm_cv       = sm.normalize(cv, length)
norm_alpha    = sm.normalize(alpha, length)
norm_beta     = sm.normalize(beta, length)
norm_r2       = sm.normalize(r2, length)
norm_entropy  = sm.normalize(entropy, length)
norm_zval     = sm.normalize(zval, length)
norm_plf      = sm.normalize(plf, length)
norm_sri      = sm.normalize(sri, length)
norm_drawdown = sm.normalize(drawdown, length)
norm_momentum = sm.normalize(momentum, length)

// === COMPOSITE CALCULATION ===
total = 0.0
count = 0

if useSharpe
    total := total + norm_sharpe
    count := count + 1
if useSortino
    total := total + norm_sortino
    count := count + 1
if useOmega
    total := total + norm_omega
    count := count + 1
if useCV
    total := total + norm_cv
    count := count + 1
if useAlpha
    total := total + norm_alpha
    count := count + 1
if useBeta
    total := total + norm_beta
    count := count + 1
if useR2
    total := total + norm_r2
    count := count + 1
if useEntropy
    total := total + norm_entropy
    count := count + 1
if useZscore
    total := total + norm_zval
    count := count + 1
if usePLF
    total := total + norm_plf
    count := count + 1
if useSRI
    total := total + norm_sri
    count := count + 1
if useDrawdown
    total := total + norm_drawdown
    count := count + 1
if useMomentum
    total := total + norm_momentum
    count := count + 1

composite = count > 0 ? total / count : na

composite_mean = ta.sma(composite, lookback)
composite_std  = ta.stdev(composite, lookback)

strong_thresh = composite_mean + composite_std     // Bullish
neutral_upper = composite_mean
neutral_lower = composite_mean - composite_std     // Bearish
panic_thresh  = composite_mean - composite_std * 2 // Extreme Bearish

// === VISUALIZATION ===
colorComp = composite > strong_thresh      ? color.green :
             composite > neutral_upper     ? color.lime :
             composite > neutral_lower     ? color.orange :
             composite > panic_thresh      ? color.red :
                                             color.maroon

plot(composite, title="Composite Score", style=plot.style_histogram, color=colorComp, linewidth=2)

plot(composite_mean, "Mean", color=color.gray)
plot(strong_thresh, "Strong", color=color.green)
plot(neutral_lower, "Weak", color=color.red)
plot(panic_thresh, "Panic", color=color.maroon)

// === Regime Classification ===
regime = composite > strong_thresh      ? "BULL" :
         composite > neutral_upper      ? "ACCUM" :
         composite > neutral_lower      ? "NEUTRAL" :
         composite > panic_thresh       ? "DISTRIB" :
                                          "BEAR"

bgcolor(regime == "BULL"     ? color.new(color.green, 85) :
         regime == "ACCUM"    ? color.new(color.lime, 85) :
         regime == "NEUTRAL"  ? color.new(color.gray, 85) :
         regime == "DISTRIB"  ? color.new(color.orange, 85) :
         regime == "BEAR"     ? color.new(color.red, 85) :
         na)

// === Create Live Regime Label ===
var label regimeLabel = label.new(x=bar_index, y=na, text="", style=label.style_label_up, size=size.small)

labelText = "Regime: " + regime
labelColor =
     regime == "BULL"     ? color.green :
     regime == "ACCUM"    ? color.lime :
     regime == "NEUTRAL"  ? color.gray :
     regime == "DISTRIB"  ? color.orange :
     regime == "BEAR"     ? color.red :
     color.black

label.set_xy(regimeLabel, bar_index, na)
label.set_text(regimeLabel, labelText)
label.set_textcolor(regimeLabel, color.white)
label.set_style(regimeLabel, label.style_label_up)
label.set_color(regimeLabel, color.new(labelColor, 0))
