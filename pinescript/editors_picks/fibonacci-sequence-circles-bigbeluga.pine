// This work is licensed under Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International  
// https://creativecommons.org/licenses/by-nc-sa/4.0/
// © BigBeluga

//@version=6
indicator("Fibonacci Sequence Circles [BigBeluga]", overlay = true)

// ＩＮＰＵＴＳ ――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――{
start_val = input.int(2, "Start", minval = 1, maxval = 50)
anchor = input.string("Pivot High", "Anchor", ["Pivot High", "Pivot Low", "D", "W", "M"], inline = "a")
rightBars = input.int(40, "Pivot", inline = "a")

circle1 = input.bool(true, "1", inline = "1"), col1 = input.color(color.white, "", inline = "1")
circle2 = input.bool(true, "2", inline = "2"), col2 = input.color(color.blue, "", inline = "2")
circle3 = input.bool(true, "3", inline = "3"), col3 = input.color(color.aqua, "", inline = "3")
circle4 = input.bool(true, "4", inline = "4"), col4 = input.color(color.lime, "", inline = "4")
circle5 = input.bool(true, "5", inline = "5"), col5 = input.color(color.yellow, "", inline = "5")
circle6 = input.bool(true, "6", inline = "1"), col6 = input.color(color.orange, "", inline = "1")
circle7 = input.bool(true, "7", inline = "2"), col7 = input.color(color.red, "", inline = "2")
circle8 = input.bool(true, "8", inline = "3"), col8 = input.color(color.maroon, "", inline = "3")
circle9 = input.bool(false, "9", inline = "4"), col9 = input.color(color.purple, "", inline = "4")
circle10 = input.bool(false, "10", inline = "5"), col10 = input.color(color.fuchsia, "", inline = "5")


var index_h = 0
var index_l = 0
var line_   = line(na)
var H = float(na)
var L = float(na)
// }


// ＣＡＬＣＵＬＡＴＩＯＮＳ――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――{
bool ph_ = not na(ta.pivothigh(rightBars, rightBars))
bool pl_ = not na(ta.pivotlow(rightBars, rightBars))

// Define scaling factors
float xScale = 2.0
float yScale = 0.5 * ta.atr(500)
// Initialize arrays for storing points and levels
var points = array.new<chart.point>()


if ph_
    index_h := bar_index[rightBars]
    H := high[rightBars]

if pl_
    index_l := bar_index[rightBars]
    L := low[rightBars]


method draw_circle(bool cond, float source, index, int mult_x, int mult_y, color) =>
    if cond
        points.clear()
        float     angle  = 0
        for i = 1 to 21
            int xValue   = int(math.round(xScale * mult_x * math.cos(angle))) + index
            float yValue = yScale * mult_y * math.sin(angle) + source
            angle       += math.pi / 10

            points.push(chart.point.from_index(xValue, yValue))

        p = polyline.new(    
                         points, 
                         curved     = false,
                         line_color = color, 
                         line_width = 1, 
                         fill_color = color.new(color, 95)
                         )

        polyline.delete(p[1])

        label.delete(label.new(points.last(), str.tostring(mult_x), color = color(na), style = label.style_label_left, textcolor = color)[1])


display = switch anchor
    "Pivot High" => ph_ 
    "Pivot Low"  => pl_ 
    "D"          => timeframe.change("D")
    "W"          => timeframe.change("W")
    "M"          => timeframe.change("M")


index = switch anchor
    "Pivot High" => index_h
    "Pivot Low"  => index_l
    => bar_index


source = switch anchor
    "Pivot High" => H
    "Pivot Low"  => L
    => hlc3

// }



// ＰＬＯＴ ――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――{
if display
    label.new(index, source, "", style = label.style_cross, size = size.tiny, color = color.orange)
    
    first   = start_val
    secon   = start_val + int(start_val/2)
    three   = first + secon
    four    = secon + three
    five    = three + four
    six     = four + five
    seven   = five + six
    eight   = six + seven
    nine    = seven + eight
    ten     = eight + nine

    circle1.draw_circle(source, index, first, first, col1)
    circle2.draw_circle(source, index, secon, secon, col2)
    circle3.draw_circle(source, index, three, three, col3)
    circle4.draw_circle(source, index, four, four, col4)
    circle5.draw_circle(source, index, five, five, col5)
    circle6.draw_circle(source, index, six, six, col6)
    circle7.draw_circle(source, index, seven, seven, col7)
    circle8.draw_circle(source, index, eight, eight, col8)
    circle9.draw_circle(source, index, nine, nine, col9)
    circle10.draw_circle(source, index, ten, ten, col10)

    line.delete(line_)
    line_ := line.new(index, source, bar_index, hlc3, color = chart.fg_color, style = line.style_dashed)

line_.set_xy2(bar_index, hlc3)

// }
