// This work is licensed under a Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0) https://creativecommons.org/licenses/by-nc-sa/4.0/

// © Zeiierman {
//@version=6
indicator("Trend Impulse Channels (Zeiierman)", overlay=true)
//~~}

// ~~ Tooltips {
var string t1 = "Trigger Threshold: Controls when a new trend step is triggered. It's a multiplier of the ATR — higher values require a stronger price move to flip the trend direction."
var string t2 = "Max Step Size: Defines the maximum allowed size for each trend step, based on ATR. Use a negative number to scale down large step jumps in volatile conditions."
var string t3 = "Band Multiplier: Expands or contracts the volatility bands around the trend line. A higher value creates wider channels to account for more price fluctuation."
var string t4 = "Trend Hold: After a trend flip, the trend will hold for this many bars before another flip can occur. Useful for avoiding rapid flip-flopping in choppy markets."
var string t5 = "Retest Signals: Enables triangle markers on the chart when price re-tests the upper or lower channel boundary. Helpful for spotting potential continuation or bounce zones."
var string t6 = "Trend Filter: Only show retest signals if they align with the current trend direction (e.g., only show upper retests in a downtrend)."
var string t7 = "Trend Step Signals: Shows circular markers each time a new step is taken in the trend direction. These mark every structural trend advancement."
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~}

// ~~ Inputs {
flipMult   = input.float(2.86,step=0.01, title="Trigger Threshold", group="", inline="", tooltip=t1)
maxStepAtr = input.float(-0.034,step=0.001, title="Max Step Size", group="", inline="", tooltip=t2)
bandMult   = input.float(2.02, step=0.01,title="Band Multiplier", group="", inline="", tooltip=t3)
holdBars   = input.int(0, minval=0, title="Trend Hold", group="", inline="", tooltip=t4)

colorUp    = input.color(color.lime, title="", group="", inline="c", tooltip="")
colorDown  = input.color(color.red, title="", group="", inline="c", tooltip="")
showFill   = input.bool(true, title="Channel Fill", group="", inline="c", tooltip="")

ChannelRetestSignal = input.bool(true, title="Retest Signals", group="Retest Signals", inline="c22", tooltip=t5)
TrendFilter  = input.bool(true, title="Filter by Trend", group="Retest Signals", inline="c222", tooltip=t6)
colorUp2     = input.color(color.lime, title="", group="Retest Signals", inline="c2", tooltip="")
colorDown2   = input.color(color.red, title="", group="Retest Signals", inline="c2", tooltip="")

TrendStepSignal = input.bool(false, title="Trend Step Signals", group="Trend Step Signals", inline="c33", tooltip=t7)
colorUp3    = input.color(color.lime, title="", group="Trend Step Signals", inline="c3", tooltip="")
colorDown3  = input.color(color.red, title="", group="Trend Step Signals", inline="c3", tooltip="")
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~}

// ~~ Atr Scaling {
atr = ta.atr(200)
stepBase = atr * 2.52
maxStep  = atr * maxStepAtr
trigger  = atr * flipMult
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~}

// ~~ Var {
var float trend     = na
var int dir         = 0
var int barsInTrend = 0
var float hold      = na
var int extension   = 0
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~}

// ~~ Logic {
startLong  = close > nz(trend) + trigger
startShort = close < nz(trend) - trigger
flip       = (startLong or startShort) and barsInTrend >= 0
stepSize   = math.min(stepBase + 0.0093 * barsInTrend * atr, maxStep)

if na(trend)
    trend := close
    dir := 0
    barsInTrend := 0
    hold := trigger
    extension := 0
else
    if flip and extension <= 0
        trend := close
        dir := startLong ? 1 : -1
        barsInTrend := 1
        hold := trigger
        extension := holdBars
    else
        trend := trend + (dir == 1 ? stepSize : dir == -1 ? -stepSize : 0)
        barsInTrend += 1
        extension := math.max(extension - 1, 0)
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~}

// ~~ Channel {
trendDirection = dir == 1 ? 1 : dir == -1 ? -1 : 0
upper = trend + atr * bandMult
lower = trend - atr * bandMult
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~}

// ~~ Plots {
trendColor = dir == 1 ? colorUp : dir == -1 ? colorDown : color.gray
trendStep  = (dir != 0) and (trend != trend[1]) and ((trend > trend[1] and dir == 1) or (trend < trend[1] and dir == -1))

plotMid    = plot(trend, "Trend Line", color=trendColor, linewidth=2)
plotUpper  = plot(showFill ? upper : na, "Upper Band", color=na)
plotLower  = plot(showFill ? lower : na, "Lower Band", color=na)
fill(plotUpper, plotMid, upper, trend,showFill ? color.new(trendColor, 60) : na,na)
fill(plotLower, plotMid, lower, trend,showFill ? color.new(trendColor, 60) : na,na)

Crossunder = ta.crossunder(low,lower)
Crossover  = ta.crossover(high,upper)

if TrendFilter 
    Crossunder := ta.crossunder(low,lower) and trendDirection == 1
    Crossover  := ta.crossover(high,upper) and trendDirection == -1

plotshape(Crossunder and ChannelRetestSignal?low:na, title="Lower Retest", color=colorUp2, style=shape.triangleup, size=size.tiny, location=location.belowbar)
plotshape(Crossover and ChannelRetestSignal?high:na, title="Upper Retest", color=colorDown2, style=shape.triangledown, size=size.tiny, location=location.abovebar)

plotshape(trendStep and dir == 1 and TrendStepSignal?high:na, title="Bullish Step", location=location.absolute, style=shape.circle, color=colorUp3, size=size.tiny)
plotshape(trendStep and dir == -1 and TrendStepSignal?low:na, title="Bearish Step", location=location.absolute, style=shape.circle, color=colorDown3, size=size.tiny)
plotshape(trendStep and dir == 1 and TrendStepSignal?high:na, title="Bullish Step", location=location.absolute, style=shape.circle, color=color.new(colorUp3,50), size=size.small)
plotshape(trendStep and dir == -1 and TrendStepSignal?low:na, title="Bearish Step", location=location.absolute, style=shape.circle, color=color.new(colorDown3,50), size=size.small)
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~}
