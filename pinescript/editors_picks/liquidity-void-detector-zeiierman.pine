// This work is licensed under Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International  
// https://creativecommons.org/licenses/by-nc-sa/4.0/

// © Zeiierman {
//@version=6
indicator("Liquidity Void Detector (Zeiierman)", overlay=false, max_labels_count=500)
//~~}

// ~~ Tooltips (in-depth) {
var string t1 = "How many bars to build the volume *baseline* used for the volume shock.\n\nWe compute VS = ln(Volume_t) − ln(SMA(Volume, L)_t).\nBigger L = smoother baseline (fewer Low-Volume flags). Typical: 20–60."
var string t2 = "How many bars to judge whether today’s volume shock is *unusually* low.\nWe z-score the volume shock against this lookback. Larger = smoother, fewer extremes."
var string t3 = "How many bars to judge whether the prior price move is *unusually* large.\nWe use the 1-bar log return (ln(C/PrevC)) and z-score it against this lookback."
var string t4 = "Threshold for flagging *Low Volume*.\nIf VolShock Z ≤ this value, we treat the bar as *low-participation* (thin liquidity). Typical: −0.5 to −1.0."
var string t6 = "Weight applied when volume is NOT low (0–1).\n• 0.00 = ignore non-low-volume bars entirely (only react under Low Volume)\n• 1.00 = treat volume condition as irrelevant (pure return reversal)\nTypical: 0.10–0.50."
var string t7 = "Signal thresholds for the Liquidity Void Oscillator."
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~}

// ~~ Inputs {
L      = input.int(30, "Volume Baseline Length", minval=2, tooltip=t1, group="Volume Shock")
vzLen  = input.int(60, "Vol Shock Z-Score Lookback", minval=1, tooltip=t2, group="Volume Shock")
vzThr  = input.float(-0.5, "Low-Volume Threshold (VolShock Z ≤)", step=0.1, tooltip=t4, group="Volume Shock")
rLen   = input.int(60, "Return Z-Score Lookback", minval=1, tooltip=t3, group="Return")
fadeNoLow = input.float(0.01, "Fade When Volume Not Low (0–1)", minval=0.0, maxval=1.0, step=0.01, tooltip=t6, group="Liquidity Void Oscillator")
longThr   = input.float(+1.0, "Upper Threshold (Osc ≥)", step=0.1, tooltip=t7, group="Liquidity Void Oscillator")
shortThr  = input.float(-1.0, "Lower Threshold (Osc ≤)", step=0.1, tooltip=t7, group="Liquidity Void Oscillator")
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~}

// ~~ Helpers {
zScore(src, len) =>
    m = ta.sma(src, len)
    d = ta.stdev(src, len)
    d == 0.0 ? 0.0 : (src - m) / d

ret1() =>
    math.log(close / close[1])
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~}

// ~~ Core series {
// ~~  Volume shock
volTrend = ta.sma(volume, L)
vs       = (volume > 0 and volTrend > 0) ? math.log(volume) - math.log(volTrend) : na
vsZ      = zScore(vs, vzLen)
//~~}

// ~~ Prior 1-bar return (t−1→t)
r1   = ret1()
retZ = zScore(r1, rLen)
//~~}

// ~~ Low-volume condition
lowVS = (vsZ <= vzThr) 
//~~}
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~}

// ~~ Void construction {
base   = retZ
weight = lowVS ? 1.0 : fadeNoLow
osc    = base * weight
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~}

// ~~ Plots {
h0 = hline(0,  "Zero",  color=color.new(color.gray, 70))
hL = hline(longThr,  "Upper Threshold (Osc ≥)",  color=color.new(color.teal, 30))
hS = hline(shortThr, "Lower Threshold (Osc ≤)", color=color.new(color.red, 30))
voidcol = osc > 0?color.teal:color.red
plot(osc,  "Liquidity Void Oscillator",  linewidth=2, color=voidcol, style=plot.style_columns)
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~}

// ~~ Label {
VoidAbove = ta.crossover(osc, longThr)
VoidBelow = ta.crossunder(osc, shortThr)

if VoidAbove
    label.new(bar_index, osc, "Buy-Side Imbalance",  // price UP inefficiency, expect DOWN fill
     color=color.new(color.teal, 0), textcolor=color.white, style=label.style_label_down, size=size.small, yloc=yloc.price)

if VoidBelow
    label.new(bar_index, osc, "Sell-Side Imbalance", // price DOWN inefficiency, expect UP fill
     color=color.new(color.red, 0), textcolor=color.white, style=label.style_label_up, size=size.small, yloc=yloc.price)

//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~}

// ~~ Alerts {
alertcondition(VoidAbove,  title="Buy-Side Imbalance",  message="Buy-Side Imbalance")
alertcondition(VoidBelow, title="Sell-Side Imbalance", message="Sell-Side Imbalance")
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~}
