//  /$$$$$$   /$$                                                         /$$                                            
// /$$__  $$ | $$                                                        | $$                                            
//| $$  \__//$$$$$$    /$$$$$$  /$$    /$$ /$$$$$$   /$$$$$$   /$$$$$$$ /$$$$$$    /$$$$$$  /$$    /$$ /$$$$$$   /$$$$$$$
//|  $$$$$$|_  $$_/   /$$__  $$|  $$  /$$//$$__  $$ /$$__  $$ /$$_____/|_  $$_/   /$$__  $$|  $$  /$$//$$__  $$ /$$_____/
// \____  $$ | $$    | $$$$$$$$ \  $$/$$/| $$$$$$$$| $$  \__/|  $$$$$$   | $$    | $$$$$$$$ \  $$/$$/| $$$$$$$$|  $$$$$$ 
// /$$  \ $$ | $$ /$$| $$_____/  \  $$$/ | $$_____/| $$       \____  $$  | $$ /$$| $$_____/  \  $$$/ | $$_____/ \____  $$
//|  $$$$$$/ |  $$$$/|  $$$$$$$   \  $/  |  $$$$$$$| $$       /$$$$$$$/  |  $$$$/|  $$$$$$$   \  $/  |  $$$$$$$ /$$$$$$$/
// \______/   \___/   \_______/    \_/    \_______/|__/      |_______/    \___/   \_______/    \_/    \_______/|_______/ 

//       ___________________
//      /                   \
//     /  _____        _____ \
//    /  /     \      /     \  \
// __/__/       \____/       \__\_____
//|           ___________           ____|
// \_________/           \_________/
//            \  /////// /
//             \/////////
// Â© Steversteves

//@version=5
indicator("Z-Score Probability Indicator")

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///                                                            Tooltips                                                                                 ///
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

t1 = "Determines the Length of Z-Score Assessment. Defaults to a 75 lookback period" 
t2 = "Determines the length of the SMA if the user selects Show SMA. Default is 75, but for a more responsive SMA you can reduce it to 14. Optional."
t3 = "Shows the probability zones in colour." 
t4 = "Will Display a summarized Z-Table." 
t5 = "Display's the SMA."  

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///                                                            User Inputs                                                                              ///
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
len = input.int(75, "Lookback Length", tooltip=t1)
plot_type = input.string("Area", "Plot Type", ["Area", "Candles"])
txtcolor = input.string("White", "Text Colour", ["White", "Black", "Blue"])
smalen = input.int(75, "SMA Length", tooltip=t2) 
probfill = input.bool(true, "Distribution Probaiblity Fills", tooltip=t3) 
showztable = input.bool(true, "Show Z-Table", tooltip=t4) 
showsma = input.bool(true, "Show SMA", tooltip=t5) 
showsd = input.bool(false, "Show SMA Standard Deviation Bands")
roundup = input.int(2, "Round Target Prices Up or Down")
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///                                                            Z-Score/SMA Calculations                                                                  ///
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
z = (close - ta.sma(close, len)) / ta.stdev(close, len) 
z_hi = (high - ta.sma(high, len)) / ta.stdev(high, len) 
z_lo = (low - ta.sma(low, len)) / ta.stdev(low, len) 
z_op = (open - ta.sma(open, len)) / ta.stdev(open, len) 

float z_close = 0.0
float z_open = 0.0 
float z_high = 0.0 
float z_low = 0.0 

if plot_type == "Candles"
    z_close := z 
    z_high := z_hi
    z_low :=z_lo
    z_open := z_op 

cl_sma = ta.sma(close, len) 
cl_sd = ta.stdev(close, len) 

// SMA 
var float z_sma = 0.0 

if showsma 
    z_sma := ta.sma(z, smalen) 
sma_sd_bands = ta.stdev(z_sma, smalen) 
plot(showsd ? z_sma + sma_sd_bands : na, "SMA UCL Bands", color = color.aqua)
plot(showsd ? z_sma - sma_sd_bands : na, "SMA LCL Bands", color = color.aqua)

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///                                                           Colours                                                                                  ///
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
color red = color.red 
color green = color.green 
color orange = color.orange 
color yellow = color.yellow 
color labelcolor = color.new(color.white, 100) 
color gray = color.new(color.gray, 25) 
color white = color.white 
color black = color.rgb(0, 0, 0) 
color blue = color.blue 
// Colour for Probability Distribution 
color greenfill = color.new(color.green, 75) 
color yellowfill = color.new(color.yellow, 75) 
color redfill = color.new(color.red, 75) 
color candlecolor = z_op > z ? color.red : z > z_op ? color.lime : color.lime 

plotcandle(z_open, z_high, z_low, z_close, "Candles", color = candlecolor) 
f_txtcolor(string) => 
    if string == "White" 
        color = white 
    else if string =="Black" 
        color = black
    else if string == "Blue"
        color = blue  

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///                                                            Logical Assessments                                                                      ///
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
bool zero_one = z >= 0 and z < 1 
bool one_two = z >= 1 and z < 2.01 
bool two_three = z >= 2 and z < 3.01 
bool three = z >= 3 
bool zero = z >= 0.99 and z <= -0.99 
bool neg_zero_one = z < 0 and z > -1 
bool neg_one_two = z <= -1 and z > -2 
bool neg_two_three = z <= -2 and z > -3 
bool neg_three = z <= -3 
falling = ta.falling(z_sma, 3) 
rising = ta.rising(z_sma, 3) 


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///                                                         Plots                                                                                        ///
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
color z_color_plot = z > 0 ? green : z <= 0 ? red : orange 
plot(plot_type == "Area" ? z : na, "Z-Score", color=z_color_plot, style=plot.style_area) 
plot(z_sma, "Z-SMA", color=showsma ? white : labelcolor, linewidth=2) 

neutral = 0 
onesd = 1 
twosd = 2 
threesd = 3 
neg_onesd = -1 
neg_twosd = -2 
neg_threesd = -3 

a = plot(neutral, color=greenfill)  
b = plot(onesd, color=yellowfill)  
c = plot(twosd, color=redfill) 
d = plot(threesd, color=redfill)  
e = plot(neg_onesd, color=greenfill)  
f = plot(neg_twosd, color=yellowfill) 
g = plot(neg_threesd, color=redfill) 

fill(a, b, color=probfill ? greenfill : na) 
fill(b, c, color=probfill ? yellowfill : na) 
fill(c, d, color=probfill ? redfill : na) 
fill(a, e, color=probfill ? greenfill : na) 
fill(e, f, color=probfill ? yellowfill : na) 
fill(f, g, color=probfill ? redfill : na) 

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///                                                           Price Level Calculations                                                                  ///
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

neutral_price = (cl_sma) + (0 * cl_sd) 
onesd_price = (cl_sma) + (1 * cl_sd) 
twosd_price = (cl_sma) + (2 * cl_sd) 
threesd_price = (cl_sma) + (3 * cl_sd) 
neg_onesd_price = (cl_sma) + (-1 * cl_sd) 
neg_twosd_price = (cl_sma) + (-2 * cl_sd) 
neg_threesd_price = (cl_sma) + (-3 * cl_sd) 

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///                                                            Line Plots                                                                              ///
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


var label neutral_price_line = na 
var label onesd_price_line = na
var label twosd_price_line = na 
var label threesd_price_line = na 
var label neg_onesd_price_line = na 
var label neg_twosd_price_line = na 
var label neg_threesd_price_line = na


if bar_index >= 75 
    label.delete(neutral_price_line) 
    label.delete(onesd_price_line) 
    label.delete(twosd_price_line)
    label.delete(threesd_price_line) 
    label.delete(neg_onesd_price_line) 
    label.delete(neg_twosd_price_line)
    label.delete(neg_threesd_price_line) 
    neutral_price_line := label.new(bar_index, y=neutral, text=str.tostring(math.round(neutral_price,roundup)), color=labelcolor, style=label.style_label_left, textcolor = f_txtcolor(txtcolor), size=size.large, textalign = text.align_right)
    onesd_price_line := label.new(bar_index - 5, onesd, str.tostring(math.round(onesd_price,roundup)), color=labelcolor, style=label.style_label_left, textcolor = f_txtcolor(txtcolor), size=size.large, textalign = text.align_right) 
    twosd_price_line := label.new(bar_index - 5, twosd, str.tostring(math.round(twosd_price,roundup)), color=labelcolor, style=label.style_label_left, textcolor =  f_txtcolor(txtcolor), size=size.large, textalign = text.align_right) 
    threesd_price_line := label.new(bar_index - 5, threesd, str.tostring(math.round(threesd_price,roundup)), color=labelcolor, style=label.style_label_left, textcolor =  f_txtcolor(txtcolor), size=size.large, textalign = text.align_right) 
    neg_onesd_price_line := label.new(bar_index - 5, neg_onesd, str.tostring(math.round(neg_onesd_price,roundup)), color=labelcolor, style=label.style_label_left, textcolor =  f_txtcolor(txtcolor), size=size.large, textalign = text.align_right) 
    neg_twosd_price_line := label.new(bar_index - 5, neg_twosd, str.tostring(math.round(neg_twosd_price,roundup)), color=labelcolor, style=label.style_label_left, textcolor =  f_txtcolor(txtcolor), size=size.large, textalign = text.align_right) 
    neg_threesd_price_line := label.new(bar_index - 5, neg_threesd, str.tostring(math.round(neg_threesd_price,roundup)), color=labelcolor, style=label.style_label_left, textcolor =  f_txtcolor(txtcolor), size=size.large, textalign = text.align_right) 


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///                                                            Z-Table                                                                                 ///
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

var ztable = table.new(position.bottom_center, 10, 3, bgcolor = color.white) 

if showztable 
    // Z-Score / Columns 
    table.cell(ztable, 1, 1, text="Z-Score:", bgcolor = color.white, text_color = color.black) 
    table.cell(ztable, 2, 1, text = "-3", bgcolor = neg_three ? gray : white, text_color=color.black) 
    table.cell(ztable, 3, 1, text="-2", bgcolor = neg_two_three ? gray : white, text_color = color.black) 
    table.cell(ztable, 4, 1, text="-1", bgcolor = neg_zero_one ? gray : white, text_color=color.black) 
    table.cell(ztable, 5, 1, text="0", bgcolor= zero ? gray : white, text_color=color.black) 
    table.cell(ztable, 6, 1, text="1", bgcolor=zero_one ? gray : white, text_color=color.black) 
    table.cell(ztable, 7, 1, text="2", bgcolor=two_three ? gray : white, text_color=color.black) 
    table.cell(ztable, 8, 1, text="3", bgcolor=three ? gray : white, text_color=color.black) 
    // Probability / Rows 
    table.cell(ztable, 1, 2, text="Probability:", bgcolor = color.white, text_color = color.black) 
    table.cell(ztable, 2, 2, text = "0.0013", bgcolor = red, text_color=color.black) 
    table.cell(ztable, 3, 2, text="0.0228", bgcolor = yellow, text_color = color.black) 
    table.cell(ztable, 4, 2, text="0.1600", bgcolor = green, text_color=color.black) 
    table.cell(ztable, 5, 2, text="0.5000", bgcolor=green, text_color=color.black) 
    table.cell(ztable, 6, 2, text="0.8500", bgcolor=green, text_color=color.black) 
    table.cell(ztable, 7, 2, text="0.9800", bgcolor=yellow, text_color=color.black) 
    table.cell(ztable, 8, 2, text="0.9998", bgcolor=red, text_color=color.black)
