//@version=5
//By yours and only, Henrique Centieiro ;)
indicator("Per Bak Self-Organized Criticality", shorttitle="Per Bak SOC", overlay=false)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUTS - Component Weights & Parameters
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

lookback = input.int(252, "Statistical Lookback Period", minval=50, maxval=1000)

// Component weights (should sum to 100%)
skew_weight = input.float(34.0, "1ï¸âƒ£ Tail Risk Weight %", minval=0, maxval=100) / 100
vix_weight = input.float(26.0, "2ï¸âƒ£ Volatility Regime Weight %", minval=0, maxval=100) / 100
credit_weight = input.float(18.0, "3ï¸âƒ£ Credit Stress Weight %", minval=0, maxval=100) / 100
pc_weight = input.float(22.0, "4ï¸âƒ£ Positioning Weight %", minval=0, maxval=100) / 100

// Alert thresholds - RECALIBRATED
alert_building = input.int(40, "Building Fragility Threshold", minval=1, maxval=100, group="Thresholds")
alert_elevated = input.int(55, "Elevated Fragility Threshold", minval=1, maxval=100, group="Thresholds")
alert_critical = input.int(70, "Critical Fragility Threshold", minval=1, maxval=100, group="Thresholds")

// Display options
show_components = input.bool(true, "Show Individual Components", group="Display")
show_historical_avg = input.bool(true, "Show Historical Average", group="Display")
show_labels = input.bool(true, "Show Component Labels", group="Display")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA SOURCES - Fetch External Symbols (FORCED DAILY)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Tail risk - FORCE DAILY
skew = request.security("SKEW", "D", close, gaps=barmerge.gaps_off)

// Volatility term structure - FORCE DAILY
vix = request.security("VIX", "D", close, gaps=barmerge.gaps_off)
vix3m = request.security("VIX3M", "D", close, gaps=barmerge.gaps_off)
vix6m = request.security("VIX6M", "D", close, gaps=barmerge.gaps_off)

// Credit stress - FORCE DAILY
hyg = request.security("HYG", "D", close, gaps=barmerge.gaps_off)
lqd = request.security("LQD", "D", close, gaps=barmerge.gaps_off)
hyg_lqd_ratio = lqd > 0 ? hyg / lqd : na

ted_spread = request.security("TEDRATE", "D", close, gaps=barmerge.gaps_off)

// Positioning - FORCE DAILY
pcall = request.security("FINRA:PALL_SHORT_VOLUME", "D", close, gaps=barmerge.gaps_off)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPONENT 1: TAIL RISK (SKEW Index)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Use percentile rank for better dynamic scaling
skew_percentile = ta.percentrank(skew, lookback)

// Also keep absolute level for extreme events
skew_absolute = math.min(100, math.max(0, (skew - 115) / 0.5))  // 115-165 range maps to 0-100

// Blend percentile (responsive) with absolute (extreme detection)
skew_component = skew_percentile * 0.7 + skew_absolute * 0.3

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPONENT 2: VOLATILITY REGIME (VIX Term Structure)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// VIX spot level contribution
vix_level = math.min(100, (vix / 50) * 100)  // VIX 50+ = maxed out

// Term structure slope (backwardation = stress)
vix_term_slope = vix3m > 0 ? (vix - vix3m) / vix3m : 0
vix_slope_score = math.max(0, math.min(100, 50 + (vix_term_slope * 300)))

// 6-month ratio
vix_6m_ratio = vix6m > 0 ? vix / vix6m : 1
vix_ratio_score = math.max(0, math.min(100, (vix_6m_ratio - 0.7) * 200))

// Weighted combination
vix_component = (vix_level * 0.4 + vix_slope_score * 0.35 + vix_ratio_score * 0.25)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPONENT 3: CREDIT STRESS (HYG/LQD + TED)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// HYG/LQD falling = stress (use inverse percentile)
hyg_lqd_stress = hyg_lqd_ratio > 0 ? 1 / hyg_lqd_ratio : 1
hyg_lqd_percentile = ta.percentrank(hyg_lqd_stress, lookback)

// TED spread - recalibrated for normal vs stress
ted_normalized = math.min(100, (ted_spread / 0.75) * 100)  // 0.75% = extreme stress

credit_component = (hyg_lqd_percentile * 0.65 + ted_normalized * 0.35)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPONENT 4: POSITIONING EXTREMES (Put/Call Ratio)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Percentile rank for dynamic adaptation
pc_percentile = ta.percentrank(pcall, lookback)

// Z-score for extreme detection
pc_mean = ta.sma(pcall, lookback)
pc_std = ta.stdev(pcall, lookback)
pc_zscore = pc_std > 0 ? (pcall - pc_mean) / pc_std : 0

// High P/C = hedging demand = fragility
pc_zscore_normalized = math.min(100, math.max(0, 50 + (pc_zscore * 25)))

// Blend percentile and z-score
pc_component = pc_percentile * 0.6 + pc_zscore_normalized * 0.4

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPOSITE SLOPE INDEX
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

slope_index = (skew_weight * skew_component + vix_weight * vix_component + credit_weight * credit_component + pc_weight * pc_component)

// Lighter smoothing for more responsiveness
slope_smoothed = ta.ema(slope_index, 2)

slope_historical_avg = ta.sma(slope_index, lookback)

slope_roc = ta.change(slope_smoothed, 10)
slope_acceleration = ta.change(slope_roc, 5)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REGIME DETECTION - RECALIBRATED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

regime_safe = slope_smoothed < alert_building
regime_building = slope_smoothed >= alert_building and slope_smoothed < alert_elevated
regime_elevated = slope_smoothed >= alert_elevated and slope_smoothed < alert_critical
regime_critical = slope_smoothed >= alert_critical

regime_color = regime_critical ? color.new(color.red, 0) : regime_elevated ? color.new(color.orange, 0) : regime_building ? color.new(color.yellow, 0) : color.new(color.green, 0)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLOTTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

plot(slope_smoothed, "Fragility Index", color=regime_color, linewidth=3)

plot(show_historical_avg ? slope_historical_avg : na, "Historical Avg", color=color.new(color.gray, 50), linewidth=1, style=plot.style_line)

// Updated threshold lines
hline(alert_building, "Building Risk", color=color.new(color.yellow, 60), linestyle=hline.style_dotted)
hline(alert_elevated, "Elevated Risk", color=color.new(color.orange, 60), linestyle=hline.style_dashed)
hline(alert_critical, "Critical Zone", color=color.new(color.red, 60), linestyle=hline.style_solid, linewidth=2)

// Background shading
bgcolor(regime_critical ? color.new(color.red, 90) : regime_elevated ? color.new(color.orange, 93) : regime_building ? color.new(color.yellow, 95) : na)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INDIVIDUAL COMPONENTS (Optional Display)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

plot(show_components ? skew_component : na, "1ï¸âƒ£ Tail Risk", color=color.new(color.purple, 60), linewidth=1)
plot(show_components ? vix_component : na, "2ï¸âƒ£ Vol Regime", color=color.new(color.blue, 60), linewidth=1)
plot(show_components ? credit_component : na, "3ï¸âƒ£ Credit Stress", color=color.new(color.fuchsia, 60), linewidth=1)
plot(show_components ? pc_component : na, "4ï¸âƒ£ Positioning", color=color.new(color.aqua, 60), linewidth=1)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPONENT LABELS ON CHART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if barstate.islast and show_components and show_labels
    label.new(bar_index, skew_component, "Tail Risk", 
              color=color.new(color.purple, 80), 
              textcolor=color.purple, 
              style=label.style_label_left, 
              size=size.tiny)
    
    label.new(bar_index, vix_component, "Vol Regime", 
              color=color.new(color.blue, 80), 
              textcolor=color.blue, 
              style=label.style_label_left, 
              size=size.tiny)
    
    label.new(bar_index, credit_component, "Credit", 
              color=color.new(color.fuchsia, 80), 
              textcolor=color.fuchsia, 
              style=label.style_label_left, 
              size=size.tiny)
    
    label.new(bar_index, pc_component, "Positioning", 
              color=color.new(color.aqua, 80), 
              textcolor=color.aqua, 
              style=label.style_label_left, 
              size=size.tiny)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABLE - Current Readings
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var table dashboard = table.new(position.top_right, 3, 7, bgcolor=color.new(color.black, 85), border_width=1)

if barstate.islast
    table.cell(dashboard, 0, 0, "PER BAK SOC", text_color=color.white, text_size=size.normal, bgcolor=color.new(color.navy, 70))
    table.merge_cells(dashboard, 0, 0, 2, 0)
    
    regime_text = regime_critical ? "ğŸ”´ AVALANCHE ZONE" : regime_elevated ? "ğŸŸ  CRACKING" : regime_building ? "ğŸŸ¡ STRESS FORMING" : "ğŸŸ¢ STABLE"
    
    table.cell(dashboard, 0, 1, "Current State:", text_color=color.gray, text_size=size.small)
    table.cell(dashboard, 1, 1, regime_text, text_color=regime_color, text_size=size.normal, bgcolor=color.new(regime_color, 85))
    table.cell(dashboard, 2, 1, str.tostring(slope_smoothed, "#.0"), text_color=color.white, text_size=size.normal)
    
    table.cell(dashboard, 0, 2, "Tail Risk:", text_color=color.gray, text_size=size.small)
    table.cell(dashboard, 1, 2, str.tostring(skew_component, "#.0"), text_color=color.purple, text_size=size.small)
    table.cell(dashboard, 2, 2, "SKEW: " + str.tostring(skew, "#.0"), text_color=color.gray, text_size=size.tiny)
    
    table.cell(dashboard, 0, 3, "Vol Regime:", text_color=color.gray, text_size=size.small)
    table.cell(dashboard, 1, 3, str.tostring(vix_component, "#.0"), text_color=color.blue, text_size=size.small)
    table.cell(dashboard, 2, 3, "VIX: " + str.tostring(vix, "#.1"), text_color=color.gray, text_size=size.tiny)
    
    table.cell(dashboard, 0, 4, "Credit:", text_color=color.gray, text_size=size.small)
    table.cell(dashboard, 1, 4, str.tostring(credit_component, "#.0"), text_color=color.fuchsia, text_size=size.small)
    table.cell(dashboard, 2, 4, "TED: " + str.tostring(ted_spread, "#.2") + "%", text_color=color.gray, text_size=size.tiny)
    
    table.cell(dashboard, 0, 5, "Positioning:", text_color=color.gray, text_size=size.small)
    table.cell(dashboard, 1, 5, str.tostring(pc_component, "#.0"), text_color=color.aqua, text_size=size.small)
    table.cell(dashboard, 2, 5, "P/C: " + str.tostring(pcall, "#.2"), text_color=color.gray, text_size=size.tiny)
    
    trend_arrow = slope_roc > 2 ? "â¬†ï¸ Accelerating" : slope_roc > 0 ? "â†—ï¸ Rising" : slope_roc > -2 ? "â†˜ï¸ Falling" : "â¬‡ï¸ Declining"
    
    table.cell(dashboard, 0, 6, "10D Î”:", text_color=color.gray, text_size=size.small)
    table.cell(dashboard, 1, 6, trend_arrow, text_color=slope_roc > 0 ? color.red : color.green, text_size=size.small)
    table.merge_cells(dashboard, 1, 6, 2, 6)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTS - Updated thresholds
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

alertcondition(ta.crossover(slope_smoothed, alert_critical), title="ğŸ”´ AVALANCHE ZONE", message="Per Bak SOC entered AVALANCHE ZONE (70+)!")

alertcondition(ta.crossover(slope_smoothed, alert_elevated), title="ğŸŸ  CRACKING", message="Per Bak SOC CRACKING (55+) - add hedges")

alertcondition(ta.crossover(slope_smoothed, alert_building), title="ğŸŸ¡ STRESS FORMING", message="Per Bak SOC STRESS FORMING (40+)")

alertcondition(ta.crossunder(slope_smoothed, alert_building) and regime_safe, title="ğŸŸ¢ STABLE", message="Per Bak SOC returned to STABLE (<40)")

alertcondition(slope_roc > 5 and slope_smoothed > alert_elevated, title="âš¡ RAPID DETERIORATION", message="Fragility accelerating rapidly from elevated levels!")

alertcondition(skew > 150, title="âš ï¸ EXTREME TAIL RISK", message="SKEW Index > 150 - fat tails forming")

alertcondition(vix_term_slope > 0.15 and vix > 20, title="âš ï¸ VIX BACKWARDATION", message="VIX term structure inverted with elevated VIX")

alertcondition(ted_spread > 0.5, title="âš ï¸ CREDIT STRESS", message="TED Spread elevated above 0.5%")
