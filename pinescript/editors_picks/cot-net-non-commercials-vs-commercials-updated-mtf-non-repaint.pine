// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© Noldo

//@version=6

// Inputs

bool hideCurrentWeek = true

bool showCommercials = true
bool showLarge = true
indicator("COT Net Commercial vs Net Non-Commercial Positions", shorttitle="COT COMM vs NON COMM", format=format.percent, precision=0)

import TradingView/LibraryCOT/2 as cot

var string Root_Symbol = syminfo.root
var string CFTC_Code_fixed = cot.convertRootToCOTCode("Auto")
if Root_Symbol == "HG"
    CFTC_Code_fixed := "085692"
else if Root_Symbol == "LBR"
    CFTC_Code_fixed := "058644"

dataRequest(metricName, direction) =>
    tickerId = cot.COTTickerid('Legacy', CFTC_Code_fixed, false, metricName, direction, "All")
    value = request.security(tickerId, "1D", close, ignore_invalid_symbol = true)
    if barstate.islastconfirmedhistory and na(value)
        runtime.error("Could not find relevant COT data based on the current symbol.")
    value

// Calculates net long positions for commercials
netLongCommercialPositions() =>
    commercialLong = dataRequest("Commercial Positions", "Long")
    commercialShort = dataRequest("Commercial Positions", "Short")
    commercialLong - commercialShort

// Calculates net long positions for traders
netLongLargePositions() =>
    largeSpecsLong = dataRequest("Noncommercial Positions", "Long")
    largeSpecsShort = dataRequest("Noncommercial Positions", "Short")
    largeSpecsLong - largeSpecsShort
//
netCommercials = netLongCommercialPositions()
netLarge = netLongLargePositions()

//
// Plot based on user input
plotValueCommercials = hideCurrentWeek ? (timenow >= time_close ? netCommercials : na) : na
plotValueLarge = hideCurrentWeek ? (timenow >= time_close ? netLarge : na) : na

// Plot the index and horizontal lines
hline(0.0,color = color.black)
plot(plotValueCommercials, "Commercials", color=color.green, style=plot.style_steplinebr, linewidth=2)
plot(plotValueLarge, "Large Traders", color=color.red, style=plot.style_steplinebr, linewidth=2)
//
