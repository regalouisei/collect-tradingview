// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Steversteves
//  /$$$$$$   /$$                                                         /$$                                            
// /$$__  $$ | $$                                                        | $$                                            
//| $$  \__//$$$$$$    /$$$$$$  /$$    /$$ /$$$$$$   /$$$$$$   /$$$$$$$ /$$$$$$    /$$$$$$  /$$    /$$ /$$$$$$   /$$$$$$$
//|  $$$$$$|_  $$_/   /$$__  $$|  $$  /$$//$$__  $$ /$$__  $$ /$$_____/|_  $$_/   /$$__  $$|  $$  /$$//$$__  $$ /$$_____/
// \____  $$ | $$    | $$$$$$$$ \  $$/$$/| $$$$$$$$| $$  \__/|  $$$$$$   | $$    | $$$$$$$$ \  $$/$$/| $$$$$$$$|  $$$$$$ 
// /$$  \ $$ | $$ /$$| $$_____/  \  $$$/ | $$_____/| $$       \____  $$  | $$ /$$| $$_____/  \  $$$/ | $$_____/ \____  $$
//|  $$$$$$/ |  $$$$/|  $$$$$$$   \  $/  |  $$$$$$$| $$       /$$$$$$$/  |  $$$$/|  $$$$$$$   \  $/  |  $$$$$$$ /$$$$$$$/
// \______/   \___/   \_______/    \_/    \_______/|__/      |_______/    \___/   \_______/    \_/    \_______/|_______/ 

//@version=6
indicator("BIN Based Support and Resistance [SS]", overlay=true)
lookback = input.int(500, "Lookback Length") 
displaylabel = input.string("On SR lines", "Where would you like the statistics to display?", ["On SR lines", "Table", "OFF"])
offset = input.int(100, "Offset the lines ahead") 
max = ta.highest(close, lookback) 
min = ta.lowest(close, lookback) 

bins = (max - min) / 10 

lbin1 = min + bins 
lbin2 = lbin1 + bins 
lbin3 = lbin2 + bins 
lbin4 = lbin3 + bins 
lbin5 = lbin4 + bins 
ubin10 = max - bins 
ubin9 = ubin10 - bins 
ubin8 = ubin9 - bins 
ubin7 = ubin8 - bins 
ubin6 = ubin7 -bins 

bool bin1 = close >= min and close < lbin1 
bool bin2 = close >= lbin1 and close < lbin2 
bool bin3 = close >= lbin2 and close < lbin3 
bool bin4 = close >= lbin3 and close < lbin4 
bool bin5 = close >= lbin4 and close < lbin5 
bool bin6 = close >= lbin5 and close < ubin6 
bool bin7 = close >= ubin6 and close < ubin7 
bool bin8 = close >= ubin7 and close < ubin8 
bool bin9 = close >= ubin8 and close < ubin9 
bool bin10 = close >= ubin10 


ar() => 
    array.new<float>() 

bin1a = ar(), bin2a = ar(), bin3a = ar(), bin4a = ar(), bin5a = ar(), bin6a = ar(), bin7a = ar(), bin8a = ar(), bin9a = ar(), bin10a = ar() 

for i = 0 to lookback 
    if bin1[i]
        bin1a.push(close[i])
    else if bin2[i]
        bin2a.push(close[i])
    else if bin3[i]
        bin3a.push(close[i])
    else if bin4[i]
        bin4a.push(close[i])
    else if bin5[i]
        bin5a.push(close[i])
    else if bin6[i]
        bin6a.push(close[i])
    else if bin7[i]
        bin7a.push(close[i])
    else if bin8[i]
        bin8a.push(close[i])
    else if bin9[i]
        bin9a.push(close[i])
    else if bin10[i]
        bin10a.push(close[i])
    else 
        na

sr1 = array.avg(bin1a), sr2 = array.avg(bin2a), sr3 = array.avg(bin3a), sr4 = array.avg(bin4a), sr5 = array.avg(bin5a), sr6 = array.avg(bin6a), sr7 = array.avg(bin7a), sr8 = array.avg(bin8a)
sr9 = array.avg(bin9a), sr10 = array.avg(bin10a) 


// statistica 

calculate_statistics(bin, lookback) =>
    bool bullish_rejection = high[2] >= bin and close < bin 
    bool bearish_rejection = low[2] <= bin and close > bin 

    int reject_bull = 0 
    int reject_bear = 0 
    for i = 0 to lookback 
        if bullish_rejection[i]
            reject_bull += 1 
        if bearish_rejection[i]
            reject_bear += 1 
    
    support_success = (reject_bear/ (reject_bear + reject_bull)) * 100 
    resistance_success = (reject_bull / (reject_bear + reject_bull)) * 100 
    [support_success, resistance_success]


[sr1_ss, sr1_rs] = calculate_statistics(sr1, lookback)
[sr2_ss, sr2_rs] = calculate_statistics(sr2, lookback)
[sr3_ss, sr3_rs] = calculate_statistics(sr3, lookback)
[sr4_ss, sr4_rs] = calculate_statistics(sr4, lookback)
[sr5_ss, sr5_rs] = calculate_statistics(sr5, lookback)
[sr6_ss, sr6_rs] = calculate_statistics(sr6, lookback)
[sr7_ss, sr7_rs] = calculate_statistics(sr7, lookback)
[sr8_ss, sr8_rs] = calculate_statistics(sr8, lookback)
[sr9_ss, sr9_rs] = calculate_statistics(sr9, lookback)
[sr10_ss, sr10_rs] = calculate_statistics(sr10, lookback)

// Gradient colours 

color[] gradient_array = array.from(#ff00c8, #e100ff, #0d00ff, #007bff, #00ffd5, #00ff15, #00ff15, #ffc400, #ff7700, #ff1500, #ff008c, #e3000b)

// Combine data 
sr_array = array.from(sr1, sr2, sr3, sr4, sr5, sr6, sr7, sr8, sr9, sr10, max, min)
support_success_array = array.from(sr1_ss, sr2_ss, sr3_ss, sr4_ss, sr5_ss, sr6_ss, sr7_ss, sr8_ss, sr9_ss, sr10_ss, 0, 100)
resistance_success_array = array.from(sr1_rs, sr2_rs, sr3_rs, sr4_rs, sr5_rs, sr6_rs, sr7_rs, sr8_rs, sr9_rs, sr10_rs, 100, 0)
num_array = array.from(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12)

create_label(idx) => 
    label.new(bar_index + offset, array.get(sr_array, idx), text = "% Success as Support: " + str.tostring(array.get(support_success_array, idx)) + "\n % Success as Resistance: " + str.tostring(array.get(resistance_success_array, idx)), color = na, style = label.style_label_right, size = size.normal)


if barstate.islast 
    for lines in line.all 
        line.delete(lines) 
    for labels in label.all 
        label.delete(labels)

if barstate.islast
    for i = 0 to array.size(sr_array) - 1 
        line.new(bar_index - lookback, array.get(sr_array, i), bar_index + offset, array.get(sr_array, i), color = array.get(gradient_array, i), width = 1)
        line.new(bar_index - lookback, array.get(sr_array, i), bar_index + offset, array.get(sr_array, i), color = color.new(array.get(gradient_array, i), 70), width = 3)
        line.new(bar_index - lookback, array.get(sr_array, i), bar_index + offset, array.get(sr_array, i), color = color.new(array.get(gradient_array, i), 80), width = 6)
        line.new(bar_index - lookback, array.get(sr_array, i), bar_index + offset, array.get(sr_array, i), color = color.new(array.get(gradient_array, i), 95), width = 8)
        if displaylabel == "On SR lines"
            create_label(i) 
        if displaylabel == "Table"
            label.new(bar_index + offset, array.get(sr_array, i), text = str.tostring(array.get(num_array,i)), color = na, textcolor = color.white)
            table data = table.new(position.middle_right, 3, 14, bgcolor = color.new(color.rgb(0, 0, 0), 65))
            for j = 0 to array.size(sr_array) - 1 
                table.cell(data, 1, 1, text = "SR Line", text_color = color.white) 
                table.cell(data, 2, 1, text = "Backtest Results", text_color = color.white) 
                table.cell(data, 1, 2 + j, text = str.tostring(array.get(num_array, j)), bgcolor = array.get(gradient_array, j), text_color = color.black) 
                table.cell(data, 2, 2 + j, text = "% Support Success: " + str.tostring(math.round(array.get(support_success_array, j), 2)) + "\n % Resistance Success: " + str.tostring(math.round(array.get(resistance_success_array, j), 2)), text_color = color.white)
