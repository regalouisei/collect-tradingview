//@version=6
indicator("Bloomberg Financial Conditions Index (Proxy)", shorttitle="BFCI", overlay=false)

// === Inputs ===
lookback    = input.int(252, "Z-Score Lookback (Days)", minval=50)
smoothing   = input.int(10, "Smoothing", minval=1)
use_glow    = input.bool(true, "Enable Glow Effect")
show_comps  = input.bool(false, "Show Components")

// === Symbols ===
ticker_eq   = "SPY"     // Equity Market: S&P 500 ETF
ticker_gov  = "TLT"     // Bond Market: 20+ Year Treasury ETF
ticker_hy   = "HYG"     // High-Yield Corporate Bonds
ticker_ig   = "LQD"     // Investment-Grade Corporate Bonds
ticker_vix  = "VIX"     // Market Volatility
ticker_cash = "SHY"     // Short-Term Treasuries (for interest rate component)

// === Weights ===
w_eq   = 0.25  // Equity weight
w_gov  = 0.20  // Government bonds weight
w_cs   = 0.25  // Credit spread weight
w_vol  = 0.20  // Volatility weight
w_liq  = 0.10  // Liquidity weight

// === Helper: Z-Score Calculation ===
zscore(src, len) =>
    lr = math.log(src / src[1])
    mean = ta.sma(lr, len)
    std  = ta.stdev(lr, len)
    (lr - mean) / std

// === Components ===
eq_price   = request.security(ticker_eq, timeframe.period, close)
gov_price  = request.security(ticker_gov, timeframe.period, close)
hy_price   = request.security(ticker_hy, timeframe.period, close)
ig_price   = request.security(ticker_ig, timeframe.period, close)
vix_price  = request.security(ticker_vix, timeframe.period, close)
cash_price = request.security(ticker_cash, timeframe.period, close)

// === Z-Scores ===
eq_z = zscore(eq_price, lookback)
gov_z = -zscore(gov_price, lookback)  // Inverted, as falling bond prices mean higher yields
spread_ratio = ig_price / hy_price    // Credit spread proxy
cs_z = -zscore(spread_ratio, lookback)  // Inverted, as tighter spreads mean better conditions
vol_z = -zscore(vix_price, lookback)  // Inverted, as lower volatility means better conditions
liq_ratio = cash_price / eq_price     // Liquidity/interest rate proxy
liq_z = -zscore(liq_ratio, lookback)  // Inverted, as lower ratio indicates better conditions

// === Total Index ===
raw_fci = eq_z * w_eq + gov_z * w_gov + cs_z * w_cs + vol_z * w_vol + liq_z * w_liq
fci = ta.sma(raw_fci, smoothing)

// === Traditional TradingView Colors ===
// Using standard TradingView color scheme
neutral_color = color.new(#2196F3, 0)  // TradingView blue
bull_color = color.new(#4CAF50, 0)     // TradingView green
bear_color = color.new(#FF5252, 0)     // TradingView red

// Dynamic color based on financial conditions
fci_color = fci >= 1.0 ? bull_color : 
           fci <= -1.0 ? bear_color : 
           fci > 0 ? color.from_gradient(fci, 0, 1, neutral_color, bull_color) :
           color.from_gradient(fci, -1, 0, bear_color, neutral_color)

// Dynamic background color with higher transparency
bg_neutral = color.new(#2196F3, 90)  // Almost transparent blue
bg_bull = color.new(#4CAF50, 75)     // Semi-transparent green
bg_bear = color.new(#FF5252, 75)     // Semi-transparent red

// Continuous dynamic background color
bg_color = fci >= 1.0 ? 
           color.from_gradient(math.min(fci, 2), 1, 2, bg_bull, color.new(#4CAF50, 85)) : 
           fci <= -1.0 ? 
           color.from_gradient(math.max(fci, -2), -2, -1, color.new(#FF5252, 85), bg_bear) :
           fci > 0 ? 
           color.from_gradient(fci, 0, 1, bg_neutral, bg_bull) :
           color.from_gradient(fci, -1, 0, bg_bear, bg_neutral)

bgcolor(bg_color)

// === Reference Lines ===
hline(0, "Neutral", color=color.gray, linestyle=hline.style_dashed)
hline(1, "Loose Conditions", color=color.green, linestyle=hline.style_dotted)
hline(-1, "Tight Conditions", color=color.red, linestyle=hline.style_dotted)

// === Plots ===
plot(fci, title="BFCI", color=fci_color, linewidth=2)
plot(use_glow ? fci : na, title="Glow Inner", color=color.new(fci_color, 75), linewidth=4)
plot(use_glow ? fci : na, title="Glow Outer", color=color.new(fci_color, 90), linewidth=6)

// === Component Plots ===
disp = show_comps ? display.all : display.none
plot(eq_z * w_eq, "Equity", color=color.green, display=disp, linewidth=1)
plot(gov_z * w_gov, "Bonds", color=color.orange, display=disp, linewidth=1)
plot(cs_z * w_cs, "Credit", color=color.purple, display=disp, linewidth=1)
plot(vol_z * w_vol, "Volatility", color=color.red, display=disp, linewidth=1)
plot(liq_z * w_liq, "Liquidity", color=color.teal, display=disp, linewidth=1)

// === Component Table ===
if barstate.islast
    var table t = table.new(position.top_right, 2, 6, frame_color=color.gray, 
                             frame_width=1, border_width=1, 
                             bgcolor=color.new(color.black, 85))
    
    // Headers
    table.cell(t, 0, 0, "Component", text_color=color.white, text_size=size.small)
    table.cell(t, 1, 0, "Z-Score", text_color=color.white, text_size=size.small)
    
    // Equity row
    table.cell(t, 0, 1, "Equity", text_color=color.white, text_size=size.small)
    table.cell(t, 1, 1, str.tostring(eq_z, "#.##"), 
              text_color=eq_z > 0 ? color.green : color.red, text_size=size.small)
    
    // Treasury row
    table.cell(t, 0, 2, "Treasury", text_color=color.white, text_size=size.small)
    table.cell(t, 1, 2, str.tostring(gov_z, "#.##"), 
              text_color=gov_z > 0 ? color.green : color.red, text_size=size.small)
    
    // Credit row
    table.cell(t, 0, 3, "Credit Spread", text_color=color.white, text_size=size.small)
    table.cell(t, 1, 3, str.tostring(cs_z, "#.##"), 
              text_color=cs_z > 0 ? color.green : color.red, text_size=size.small)
    
    // Volatility row
    table.cell(t, 0, 4, "Volatility", text_color=color.white, text_size=size.small)
    table.cell(t, 1, 4, str.tostring(vol_z, "#.##"), 
              text_color=vol_z > 0 ? color.green : color.red, text_size=size.small)
    
    // Liquidity row
    table.cell(t, 0, 5, "Liquidity", text_color=color.white, text_size=size.small)
    table.cell(t, 1, 5, str.tostring(liq_z, "#.##"), 
              text_color=liq_z > 0 ? color.green : color.red, text_size=size.small)
