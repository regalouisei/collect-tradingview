//@version=6
// ══════════════════════════════════════════════════════════════════════════════════════════════════ //
//# * ══════════════════════════════════════════════════════════════════════════════════════════════
//# *
//# * Study       : Relative Strength of Volume Indicators
//# * Author      : © dgtrd
//# *
//# * Revision History
//# *  Release    : Aug 18, 2020 : initial release
//# *  Update     : Aug 26, 2020 : volume histogram size made adjustable
//# *  Update     : Sep 22, 2020 : 4 color coded relative volume histogram
//# *  Update     : Aug 10, 2022 : buying/selling relative volume histogram option added, performance optimization, Pine Script v5 update
//# *
//# * ══════════════════════════════════════════════════════════════════════════════════════════════
// ══════════════════════════════════════════════════════════════════════════════════════════════════ //


indicator('Relative Strength of Volume Indicators by DGT', 'RSIᵛᴼᴸ ☼☾', format = format.price, max_bars_back = 252)

// -Input ======================================================================================= //

display = display.all - display.status_line

// Relative Strength application on Volume Indicators
addRsiX = input.string('On Balance Volume', '► Apply RSI To', display = display,
    options = ['Accumulation / Distribution', 'Elder’s Force Index', 'Money Flow Index', 'On Balance Volume', 'Price Volume Trend'],
    tooltip = 'Select the volume-based indicator on which the Relative Strength Index (RSI) is applied. This reveals momentum shifts within volume dynamics rather than price alone.')

length = input.int(13, minval = 1, title = '  RSI Length', display = display)

smooth = input.int(2, '  RSI Smoothing', minval = 2, display = display,
    tooltip = 'Applies Least Squares smoothing to the RSI output to reduce noise while preserving directional intent.')

// Volume Histogram
group_hist = 'Relative Volume Histogram'

tp_rvol = 'Relative Volume (RVOL) compares current volume to its historical average.\n\n' +
         'RVOL = Current Volume ÷ Average Volume\n\n' +
         'High RVOL highlights participation expansion, often preceding volatility or structural breaks.'

volHist = input.string('Relative Volume [4 Color]', '► Histogram Mode', display = display,
    options = ['Relative Volume', 'Relative Volume [4 Color]', 'Buying / Selling Volume [Mode 1]', 'Buying / Selling Volume [Mode 2]', 'Disabled'], group = group_hist, tooltip = tp_rvol)

volComp = input.string('Volume Oscillator', '► Histogram Companion',
    options = ['Moving Average', 'Volume Oscillator', 'None'], group = group_hist, display = display,
    tooltip = 'Optional companion metric used to contextualize histogram expansion or contraction.')

size = input.int(10, '  Histogram Height', minval = 1, group = group_hist, display = display,
    tooltip = 'Controls the vertical scale of the volume histogram.')

// Volume Based Colored Bars
vbcb = input.bool(true, title = '► Volume-Weighted Price Bars', group = 'Volume Weighted Colored Bars', 
    tooltip = 'Colors price bars based on volume intensity relative to a volume moving average. High participation bars are visually emphasized.')


// -Calculation ================================================================================= //

nzVolume = nz(volume)
O = open
H = high
L = low
C = close

// RSI
rsi = ta.rsi(C, length)
srsi = ta.linreg(rsi, smooth, 0)

float rsix = switch addRsiX
    'Accumulation / Distribution' => ta.rsi(ta.cum(C == H and C == L or H == L ? 0 : (2 * C - L - H) / (H - L) * nzVolume), length)
    'Elder’s Force Index' => ta.rsi(ta.ema(ta.change(C) * nzVolume, length), length)
    'Money Flow Index' => 100.0 - 100.0 / (1.0 + math.sum(nzVolume * (ta.change(hlc3) <= 0 ? 0 : hlc3), length) / math.sum(nzVolume * (ta.change(hlc3) >= 0 ? 0 : hlc3), length))
    'On Balance Volume' => ta.rsi(ta.cum(math.sign(ta.change(C)) * nzVolume), length)
    'Price Volume Trend' => ta.rsi(ta.cum(ta.change(C) / C[1] * nzVolume), length)

srsix = ta.linreg(rsix, smooth, 0)

// Volume Histogram
vAvg = ta.sma(nzVolume, length)
rvAvg = ta.sma(nzVolume / vAvg * size, length)
B = nzVolume * (C - L) / (H - L) / vAvg * size
S = nzVolume * (H - C) / (H - L) / vAvg * size

// Histogram Companion
volx = switch volComp
    'Moving Average' => rvAvg //ta.sma(nzVolume / vAvg * size, length)
    'Volume Oscillator' => (ta.ema(nzVolume, 5) - ta.ema(nzVolume, 10)) / ta.ema(nzVolume, 10) * 100

// -Plot ======================================================================================== //
// Volume Histogram
plot(bool(nzVolume) and volHist == 'Relative Volume' ? nzVolume / vAvg * size : na, 'Relative Volume (RVOL)', O > C ? color.new(#ef5350, 0) : color.new(#26a69a, 0), style = plot.style_columns, editable = false, display = display)
plot(bool(nzVolume) and volHist == 'Relative Volume [4 Color]' ? nzVolume / vAvg * size : na, 'Relative Volume (RVOL · Context)', O > C ? nzVolume / vAvg * math.abs(size) > math.abs(rvAvg) ? color.new(#ef5350, 0) : color.new(color.gray, 25) : nzVolume / vAvg * math.abs(size) > math.abs(rvAvg) ? color.new(#26a69a, 0) : color.new(color.gray, 55), style = plot.style_columns, editable = false, display = display)
plot(bool(nzVolume) and (volHist == 'Buying/Selling Volume [1]' or volHist == 'Buying/Selling Volume [2]') ? volHist == 'Buying/Selling Volume [1]' ? S + B : B : na, 'Buy-Side Volume', color.new(#26a69a, 0), style = plot.style_columns, editable = false, display = display)
plot(bool(nzVolume) and (volHist == 'Buying/Selling Volume [1]' or volHist == 'Buying/Selling Volume [2]') ? volHist == 'Buying/Selling Volume [1]' ? S : -S : na, 'Sell-Side Volume', color.new(#ef5350, 0), style = plot.style_columns, editable = false, display = display)

// Histogram Companion
plot(bool(nzVolume) and volHist != 'None' ? volx : na, 'Volume Companion', color.new(color.orange, 20), 2, display = display)

// Threshold Lines
p1 = hline(75, color = color.red, title = 'Overbought (Upper)', linestyle = hline.style_dotted)
p2 = hline(65, color = color.red, title = 'Overbought (Lower)', linestyle = hline.style_dotted)
fill(p1, p2, color = color.new(color.red, 89), title = 'Overbought Zone')

hline(50, color = color.gray, title = 'Equilibrium (50)', linestyle = hline.style_dotted, linewidth = 2)

p3 = hline(35, color = color.teal, title = 'Oversold (Upper)', linestyle = hline.style_dotted)
p4 = hline(25, color = color.teal, title = 'Oversold (Lower)', linestyle = hline.style_dotted)
fill(p3, p4, color = color.new(color.teal, 89), title = 'Oversold Zone')

// RSI
plot(srsi, 'RSI (Price)', #8E1599, 2, display = display)
plot(bool(nzVolume) ? srsix : na, 'RSI (Volume)', color.new(color.aqua, 10), 2, display = display)

// Volume Based Colored Bars by KIVANÇ ÖZBİLGİÇ
barcolor(vbcb and bool(nzVolume) ? nzVolume > vAvg * 1.618 ? C > O ? #006400 : #910000 : nzVolume < vAvg * 0.618 ? C > O ? #7FFFD4 : #FF9800 : C > O ? color.teal : color.red : na, title = 'Volume-Weighted Price Bars', editable = false)

var table logo = table.new(position.bottom_right, 1, 1)
if barstate.islast
    table.cell(logo, 0, 0, '☼☾  ', text_size=size.normal, text_color=color.teal, tooltip = 'SoleMare Analytics')
