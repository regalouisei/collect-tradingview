//@version=6
indicator(title="Predictive Moving Average Convergence Divergence - Ryder", shorttitle="PMACD - Ryder", overlay=false, max_lines_count=500, max_labels_count=500)

// ---------- Inputs ----------
macdTF        = input.timeframe("", "MACD Timeframe (blank = current)")
fast_length   = input.int(5,  "Fast Length",      minval=1)
slow_length   = input.int(34, "Slow Length",      minval=1)
signal_length = input.int(5,  "Signal Smoothing", minval=1)
src           = input.source(close, "Source")
percent       = input.bool(false, "Percentage Price")

// Colors
col_macd       = input.color(#2962FF, "MACD Line",   group="Color Settings", inline="macd")
col_signal     = input.color(#FF6D00, "Signal Line", group="Color Settings", inline="macd")
col_grow_above = input.color(#26A69A, "Above Grow",  group="Histogram",      inline="above")
col_fall_above = input.color(#B2DFDB, "Above Fall",  group="Histogram",      inline="above")
col_grow_below = input.color(#FFCDD2, "Below Grow",  group="Histogram",      inline="below")
col_fall_below = input.color(#FF5252, "Below Fall",  group="Histogram",      inline="below")

// ---------- Core MACD ----------
fast_ma = request.security(syminfo.tickerid, macdTF == "" ? timeframe.period : macdTF, ta.ema(src, fast_length))
slow_ma = request.security(syminfo.tickerid, macdTF == "" ? timeframe.period : macdTF, ta.ema(src, slow_length))

macd   = percent ? (fast_ma - slow_ma) / nz(slow_ma, 1) * 100 : (fast_ma - slow_ma)
signal = request.security(syminfo.tickerid, macdTF == "" ? timeframe.period : macdTF, ta.ema(macd, signal_length))
hist   = macd - signal

// ---------- Helpers ----------
f_ema(_src, _length, _pre_ema) =>
    alpha  = 2.0 / (_length + 1.0)
    curEMA = alpha * _src + (1.0 - alpha) * _pre_ema
    curEMA  // return

cal_f(pre_fast, pre_slow, pre_sig, pre_hist) =>
    ffast  = f_ema(src, fast_length,   pre_fast)
    fslow  = f_ema(src, slow_length,   pre_slow)
    fmacd  = percent ? (ffast - fslow) / nz(fslow, 1) * 100 : (ffast - fslow)
    fsig   = f_ema(fmacd, signal_length, pre_sig)
    fhist  = fmacd - fsig
    priorH = nz(pre_hist, 0)
    colfh  = (fhist >= 0) ? ((priorH < fhist) ? col_grow_above : col_fall_above) : ((priorH < fhist) ? col_grow_below : col_fall_below)
    [ffast, fslow, fmacd, fsig, fhist, colfh]

// 1..3-bar forward extrapolations
[ffast1, fslow1, fmacd1, fsig1, fhist1, colfhist1] = cal_f(fast_ma, slow_ma, signal, hist)
[ffast2, fslow2, fmacd2, fsig2, fhist2, colfhist2] = cal_f(ffast1,  fslow1,  fsig1,  fhist1)
[ffast3, fslow3, fmacd3, fsig3, fhist3, colfhist3] = cal_f(ffast2,  fslow2,  fsig2,  fhist2)

// ---------- Plots ----------
plot(hist, title="Histogram", style=plot.style_columns,
     color = (hist >= 0) ? ((hist[1] < hist) ? col_grow_above : col_fall_above)
                         : ((hist[1] < hist) ? col_grow_below : col_fall_below),
     display=display.pane)

plot(macd,   title="MACD",   color=col_macd,   display=display.pane)
plot(signal, title="Signal", color=col_signal, display=display.pane)

// Forward markers (offset 1â€“3 bars ahead)
plot(fmacd1, "fMACD-1",   color=col_macd,   style=plot.style_circles, offset=1, show_last=1, display=display.pane)
plot(fsig1,  "fSignal-1", color=col_signal, style=plot.style_circles, offset=1, show_last=1, display=display.pane)
plot(fhist1, title="fHistogram-1", style=plot.style_histogram, color=colfhist1, offset=1, show_last=1, display=display.pane)

plot(fmacd2, "fMACD-2",   color=col_macd,   style=plot.style_circles, offset=2, show_last=1, display=display.pane)
plot(fsig2,  "fSignal-2", color=col_signal, style=plot.style_circles, offset=2, show_last=1, display=display.pane)
plot(fhist2, title="fHistogram-2", style=plot.style_histogram, color=colfhist2, offset=2, show_last=1, display=display.pane)

plot(fmacd3, "fMACD-3",   color=col_macd,   style=plot.style_circles, offset=3, show_last=1, display=display.pane)
plot(fsig3,  "fSignal-3", color=col_signal, style=plot.style_circles, offset=3, show_last=1, display=display.pane)
plot(fhist3, title="fHistogram-3", style=plot.style_histogram, color=colfhist3, offset=3, show_last=1, display=display.pane)
