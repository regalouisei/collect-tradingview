//@version=6
indicator("Market Breadth Momentum", shorttitle="Breadth Momentum", overlay=false)

// --- Inputs ---
group_sym = "Data Symbols"
sym_highs = input.symbol("ATHI.US", "New Highs Ticker", group=group_sym)
sym_lows  = input.symbol("ATLO.US", "New Lows Ticker", group=group_sym)

group_calc = "Calculation Logic"
calc_mode = input.string("Net (Highs - Lows)", "Base Data", options=["Net (Highs - Lows)", "Ratio (Highs / Lows)"], group=group_calc)
show_momentum = input.bool(true, "Show Momentum? (McClellan Style)", group=group_calc, tooltip="If checked, calculates the difference between Fast and Slow EMAs to show momentum.")
fast_len = input.int(19, "Fast EMA Length", group=group_calc)
slow_len = input.int(39, "Slow EMA Length", group=group_calc)

group_sig = "Signal Line"
show_sig = input.bool(true, "Show Signal Line?", group=group_sig)
sig_len  = input.int(9, "Signal Length", group=group_sig)

// --- Data Fetching ---
highs = nz(request.security(sym_highs, timeframe.period, close))
lows  = nz(request.security(sym_lows, timeframe.period, close))

// --- Base Calculation ---
float raw_val = 0.0
if calc_mode == "Net (Highs - Lows)"
    raw_val := highs - lows
else
    raw_val := lows != 0 ? highs / lows : 1.0

// --- Momentum Calculation (The "Change" Measure) ---
// If Momentum is ON, we calculate FastEMA - SlowEMA (MACD style logic)
// If OFF, we just use the Raw Value
float final_val = 0.0
if show_momentum
    final_val := ta.ema(raw_val, fast_len) - ta.ema(raw_val, slow_len)
else
    final_val := raw_val

// --- Signal Line Calculation ---
signal = ta.ema(final_val, sig_len)

// --- Visuals ---
// Color logic: Green if value is rising, Red if falling (shows rate of change)
color col = final_val > final_val[1] ? color.new(color.teal, 30) : color.new(color.maroon, 30)

// Plot Main Histogram
plot(final_val, title="Breadth Indicator", color=col, style=plot.style_columns, linewidth=2)

// Plot Signal Line
plot(show_sig ? signal : na, title="Signal Line", color=color.orange, linewidth=2)

// Zero Line
hline(0, "Zero Line", color=color.gray)

// --- Alerts ---
// Trigger an alert when the Histogram crosses the Signal Line
algo_cross = ta.crossover(final_val, signal) or ta.crossunder(final_val, signal)
alertcondition(algo_cross, title="Momentum Change Detected", message="Breadth Momentum has crossed the signal line.")
