//@version=5
indicator("Prev day High, Low, Close + buying force", overlay=true)

// 1. Obtenemos datos de las últimas dos velas diarias y sus fechas
[h0, l0, c0, t0] = request.security(syminfo.tickerid, "D", [high, low, close, time], lookahead=barmerge.lookahead_on)
[h1, l1, c1, t1] = request.security(syminfo.tickerid, "D", [high[1], low[1], close[1], time[1]], lookahead=barmerge.lookahead_on)

// 2. Lógica de "Ayer"
is_t0_today = dayofmonth(t0, syminfo.timezone) == dayofmonth(last_bar_time, syminfo.timezone) and month(t0, syminfo.timezone) == month(last_bar_time, syminfo.timezone)

pdh = is_t0_today ? h1 : h0
pdl = is_t0_today ? l1 : l0
pdc = is_t0_today ? c1 : c0

// 3. Lógica de Fuerza (Alcista y Vendedora)
rango_total = pdh - pdl

// Regla 1/3 Superior: Fuerza Compradora (Cierre cerca del Máximo)
es_fuerte_comprador = (pdh - pdc) < (rango_total / 3)

// Regla 1/3 Inferior: Fuerza Vendedora (Cierre cerca del Mínimo)
es_fuerte_vendedor = (pdc - pdl) < (rango_total / 3)

// 4. Filtro para dibujar solo hoy y evitar el "Pre-market" (escalonamiento)
t_reg = time(timeframe.period, syminfo.session, syminfo.timezone)
es_hoy = dayofmonth(time, syminfo.timezone) == dayofmonth(last_bar_time, syminfo.timezone)
mostrar = es_hoy and not na(t_reg)

// 5. Dibujo de Niveles
p_pdh = plot(mostrar ? pdh : na, "PDH", color=color.new(#26a69a, 0), linewidth=2, style=plot.style_linebr)
p_pdl = plot(mostrar ? pdl : na, "PDL", color=color.new(#ef5350, 0), linewidth=2, style=plot.style_linebr)
p_pdc = plot(mostrar ? pdc : na, "PDC", color=color.new(#787b86, 0), linewidth=1, style=plot.style_linebr)

// 6. Sombreados Dinámicos
// Sombreado VERDE (entre Máximo y Cierre) si hay fuerza compradora
fill(p_pdh, p_pdc, color = (mostrar and es_fuerte_comprador) ? color.new(color.green, 85) : na, title="Fuerza Alcista")

// Sombreado ROJO (entre Cierre y Mínimo) si hay fuerza vendedora
fill(p_pdc, p_pdl, color = (mostrar and es_fuerte_vendedor) ? color.new(color.red, 85) : na, title="Fuerza Vendedora")

// 7. Etiquetas Dinámicas
var label lblH = na
var label lblL = na
var label lblC = na

if mostrar
    if na(lblH)
        lblH := label.new(bar_index, pdh, "PDH: " + str.tostring(pdh, "#.##"), color=color.new(color.white, 100), textcolor=#26a69a, style=label.style_label_left, size=size.small)
        lblL := label.new(bar_index, pdl, "PDL: " + str.tostring(pdl, "#.##"), color=color.new(color.white, 100), textcolor=#ef5350, style=label.style_label_left, size=size.small)
        lblC := label.new(bar_index, pdc, "PDC: " + str.tostring(pdc, "#.##"), color=color.new(color.white, 100), textcolor=#787b86, style=label.style_label_left, size=size.small)
    else
        label.set_xy(lblH, bar_index + 2, pdh)
        label.set_xy(lblL, bar_index + 2, pdl)
        label.set_xy(lblC, bar_index + 2, pdc)
