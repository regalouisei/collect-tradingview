//@version=6
indicator("Stock Expansion → Pullback Screener (v6)", overlay=true)

// ───── INPUTS ─────
atrLen   = input.int(14, "ATR Length")
atrMult  = input.float(1.3, "Expansion ATR Multiplier", step=0.1)
rsiLen   = input.int(14, "RSI Length")
emaFast  = input.int(20, "Fast EMA")
emaSlow  = input.int(50, "Slow EMA")
maxBars  = input.int(20, "Max Bars After Expansion")

// ───── CALCULATIONS ─────
atr  = ta.atr(atrLen)
rsi  = ta.rsi(close, rsiLen)

ema20 = ta.ema(close, emaFast)
ema50 = ta.ema(close, emaSlow)
vwap  = ta.vwap(close)

// Candle strength (Expansion)
candleRange = high - low
candleBody  = math.abs(close - open)

isExpansion = (
    candleRange > atr * atrMult and
    candleBody  > candleRange * 0.6
)
// Momentum
bullMomentum = rsi > 55
bearMomentum = rsi < 45

// ───── STATE TRACKING ─────
var int bullExpIndex = na
var int bearExpIndex = na

if isExpansion and bullMomentum
    bullExpIndex := bar_index

if isExpansion and bearMomentum
    bearExpIndex := bar_index

bullActive = not na(bullExpIndex) and (bar_index - bullExpIndex <= maxBars)
bearActive = not na(bearExpIndex) and (bar_index - bearExpIndex <= maxBars)

// ───── PULLBACK ZONES ─────
pullbackBull = (
    (close <= ema20 and close >= ema50) or
    math.abs(close - vwap) / close < 0.003
)
pullbackBear = (
    (close >= ema20 and close <= ema50) or
    math.abs(close - vwap) / close < 0.003
)
// ───── FINAL SIGNALS ─────
bullSignal = bullActive and bullMomentum and pullbackBull
bearSignal = bearActive and bearMomentum and pullbackBear

// ───── VISUAL OUTPUT ─────
plotshape(
    bullSignal,
    title="Bull Pullback",
    style=shape.triangleup,
    location=location.belowbar,
    size=size.small,
    color=color.lime
)

plotshape(
    bearSignal,
    title="Bear Pullback",
    style=shape.triangledown,
    location=location.abovebar,
    size=size.small,
    color=color.red
)

// ───── ALERTS (THIS IS YOUR SCREENER) ─────
alertcondition(
    bullSignal,
    title="Bull Expansion → Pullback",
    message="Bullish expansion pullback on {{ticker}} ({{interval}})"
)

alertcondition(
    bearSignal,
    title="Bear Expansion → Pullback",
    message="Bearish expansion pullback on {{ticker}} ({{interval}})"
)
