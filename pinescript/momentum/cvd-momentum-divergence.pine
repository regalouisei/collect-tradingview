//@version=6
indicator("CVD Momentum Divergence", shorttitle="CVD Div", overlay=false)

//=== INPUTS ===
lenPrice = input.int(100, "Detrend length (Price)")
lenCVD   = input.int(100, "Detrend length (CVD)")
smooth   = input.int(5,  "Smoothing")

// Daily reset option at 9am
resetDaily      = input.bool(true, "Reset CVD and Price?")
resetHourInput  = input.int(9,  "Reset Hour",  minval = 0, maxval = 23)
resetMinuteInput= input.int(0,  "Reset Minute",minval = 0, maxval = 59)

// Scale multiplier
scaleMult = input.float(1.0, "Scale Multiplier", minval=0.1, maxval=10.0, step=0.1)

// Histogram inversion
invertHistogram = input.bool(false, "Invert Histogram?")

//=== RESET CONDITION AT 9AM ===
var int lastResetDay = na
curHour   = hour(time)
curMinute = minute(time)
curDay    = dayofmonth(time)

isResetTime = resetDaily and curHour == resetHourInput and curMinute == resetMinuteInput and (na(lastResetDay) or curDay != lastResetDay)

//=== APPROXIMATED SMOOTH CVD ===
delta = volume * (close - open) / math.max(high - low, syminfo.mintick)

// CVD accumulator with reset
var float cvdCum = 0.0
if isResetTime
    cvdCum := 0.0
    lastResetDay := curDay
else
    cvdCum += delta

cvdRaw = cvdCum
cvd    = ta.ema(cvdRaw, 5)

//=== DETREND PRICE WITH RESET ===
var float priceSum = 0.0
var int priceCount = 0

if isResetTime
    priceSum := 0.0
    priceCount := 0
else
    priceSum += close
    priceCount += 1
    if priceCount > lenPrice
        priceSum -= close[lenPrice]
        priceCount := lenPrice

priceMA   = priceCount > 0 ? priceSum / priceCount : close
priceDet  = close - priceMA
priceDetSm= ta.ema(priceDet, smooth)

//=== DETREND CVD ===
cvdMA    = ta.sma(cvd, lenCVD)
cvdDet   = cvd - cvdMA
cvdDetSm = ta.ema(cvdDet, smooth)

//=== NORMALIZATION ===
normFactorPrice = ta.stdev(priceDetSm, lenPrice)
normFactorCVD   = ta.stdev(cvdDetSm, lenCVD)

priceNorm = normFactorPrice != 0.0 ? priceDetSm / normFactorPrice : 0.0
cvdNorm   = normFactorCVD   != 0.0 ? cvdDetSm   / normFactorCVD   : 0.0

//=== FINAL VALUES WITH SCALE ===
finalPrice = scaleMult * priceNorm
finalCVD   = scaleMult * cvdNorm

//=== PLOTS ===
hline(0, "Zero", color=color.gray)

plot(finalPrice, "Detrended Price (norm)", color=color.orange, linewidth=2)
plot(finalCVD,   "Detrended CVD (norm)",   color=color.blue,   linewidth=2)

// CVD-Price divergence histogram WITH INVERSION OPTION
showDiff = input.bool(true, "Show CVD-Price Divergence?")
divCVD   = invertHistogram ? finalPrice - finalCVD : finalCVD - finalPrice
histColor = divCVD > 0 ? color.new(color.green, 60) : color.new(color.red, 60)
plot(showDiff ? divCVD : na, "CVD vs Price", style=plot.style_columns, color=histColor)
