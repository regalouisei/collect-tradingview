//@version=5
indicator("Dynamic Gann Fan & Cycle - Lite Framework", overlay=true)

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// INPUT GROUPS (Professional Layout)
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
groupCore   = "Core Structure"
groupVisual = "Momentum & Visuals"
groupPanels = "Panels & Display"

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// CORE STRUCTURE SETTINGS
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
pivotBar   = input.int(50,  "Lookback for Pivot High/Low", minval=1, group=groupCore)
baseStep   = input.float(1.0, "Base Gann Step Multiplier", group=groupCore)
angleCount = input.int(3,   "Number of Fan Angles Each Side", minval=1, group=groupCore)

showPivotLowFan  = input.bool(true,  "Show Pivot Low Fan",  group=groupCore)
showPivotHighFan = input.bool(true,  "Show Pivot High Fan", group=groupCore)

atrLen = input.int(14, "ATR Length (Tolerance)", group=groupCore)

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// MOMENTUM & VISUAL HIGHLIGHTING
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
showMomentumHighlight = input.bool(true, "Highlight Momentum Candles (2x1 / 3x1)", group=groupVisual)

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// PANELS & DISPLAY
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
showLegendPanel = input.bool(true, "Show Gann Fan Legend Panel", group=groupPanels)

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// INTERNAL SETTINGS
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
lookaheadBars = 100  // Bars to project fan lines forward

// === ATR (Tolerance) ===
atrVal = ta.atr(atrLen)

// === PRICE RANGE (used for slope normalization) ===
priceLow  = ta.lowest(low, pivotBar)
priceHigh = ta.highest(high, pivotBar)
priceRange = priceHigh - priceLow

// === PIVOT LOW DETECTION ===
lowestBar = ta.lowestbars(low, pivotBar)
isPivotLow = bar_index > pivotBar and lowestBar == 0

var float pivotLowPrice = na
var int   pivotLowIndex = na
var bool  pivotLowInit  = false

if isPivotLow
    pivotLowPrice := low
    pivotLowIndex := bar_index
    pivotLowInit  := true

canDrawLow = pivotLowInit and not na(pivotLowPrice) and not na(pivotLowIndex) and bar_index > pivotLowIndex

// === MOMENTUM HIGHLIGHT (Lite: no counters, just regime highlight) ===
var bool isMomentum = false
var bool isDownsideMomentum = false

isMomentum := false
isDownsideMomentum := false

if showMomentumHighlight and canDrawLow
    for i = 2 to math.min(angleCount, 3)
        pr = ta.highest(high, pivotBar) - ta.lowest(low, pivotBar)
        barSpan = float(lookaheadBars)
        slope = (baseStep * i) * (pr / barSpan)

        fanY    = pivotLowPrice + slope * (bar_index - pivotLowIndex)
        fanYNeg = pivotLowPrice - slope * (bar_index - pivotLowIndex)

        if close <= fanYNeg + atrVal * 0.5
            isDownsideMomentum := true
        else if close >= fanY - atrVal * 0.5
            isMomentum := true

        if isMomentum or isDownsideMomentum
            break

bgcolor(isDownsideMomentum ? color.new(color.red, 85) : isMomentum ? color.new(color.green, 85) : na)

// === PIVOT LOW FAN DRAWING ===
var line[]  lowFanLines  = array.new_line()
var label[] lowFanLabels = array.new_label()

if canDrawLow and showPivotLowFan
    // Clear prior fan
    if array.size(lowFanLines) > 0
        for j = 0 to array.size(lowFanLines) - 1
            line.delete(array.get(lowFanLines, j))
    array.clear(lowFanLines)

    if array.size(lowFanLabels) > 0
        for j = 0 to array.size(lowFanLabels) - 1
            label.delete(array.get(lowFanLabels, j))
    array.clear(lowFanLabels)

    for i = 1 to angleCount
        pr = ta.highest(high, pivotBar) - ta.lowest(low, pivotBar)
        barSpan = float(lookaheadBars)
        step = (baseStep * i) * (pr / barSpan)

        x2 = pivotLowIndex + lookaheadBars
        upY   = pivotLowPrice + step * (x2 - pivotLowIndex)
        downY = pivotLowPrice - step * (x2 - pivotLowIndex)

        upL   = line.new(x1=pivotLowIndex, y1=pivotLowPrice, x2=x2, y2=upY,   color=color.lime, width=1)
        downL = line.new(x1=pivotLowIndex, y1=pivotLowPrice, x2=x2, y2=downY, color=color.red,  width=1)

        array.push(lowFanLines, upL)
        array.push(lowFanLines, downL)

        if i <= 3
            lblUp   = label.new(x=x2, y=upY,   text=str.tostring(i) + "x1 Low",  textcolor=color.lime, style=label.style_label_left, size=size.small)
            lblDown = label.new(x=x2, y=downY, text=str.tostring(i) + "x-1 Low", textcolor=color.red,  style=label.style_label_left, size=size.small)
            array.push(lowFanLabels, lblUp)
            array.push(lowFanLabels, lblDown)

// === PIVOT HIGH DETECTION ===
highestBar = ta.highestbars(high, pivotBar)
isPivotHigh = bar_index > pivotBar and highestBar == 0

var float pivotHighPrice = na
var int   pivotHighIndex = na

if isPivotHigh
    pivotHighPrice := high
    pivotHighIndex := bar_index

// === PIVOT HIGH FAN DRAWING ===
var line[]  highFanLines  = array.new_line()
var label[] highFanLabels = array.new_label()

canDrawHigh = not na(pivotHighPrice) and not na(pivotHighIndex) and bar_index > pivotHighIndex

if canDrawHigh and showPivotHighFan
    if array.size(highFanLines) > 0
        for j = 0 to array.size(highFanLines) - 1
            line.delete(array.get(highFanLines, j))
    array.clear(highFanLines)

    if array.size(highFanLabels) > 0
        for j = 0 to array.size(highFanLabels) - 1
            label.delete(array.get(highFanLabels, j))
    array.clear(highFanLabels)

    for i = 1 to angleCount
        pr = ta.highest(high, pivotBar) - ta.lowest(low, pivotBar)
        barSpanHigh = float(lookaheadBars)
        stepHigh = (baseStep * i) * (pr / barSpanHigh)

        x2 = pivotHighIndex + lookaheadBars
        upY   = pivotHighPrice - stepHigh * (x2 - pivotHighIndex)
        downY = pivotHighPrice + stepHigh * (x2 - pivotHighIndex)

        upLine   = line.new(x1=pivotHighIndex, y1=pivotHighPrice, x2=x2, y2=upY,   color=color.blue, width=1)
        downLine = line.new(x1=pivotHighIndex, y1=pivotHighPrice, x2=x2, y2=downY, color=color.navy, width=1)

        array.push(highFanLines, upLine)
        array.push(highFanLines, downLine)

        if i <= 3
            lblUp   = label.new(x=x2, y=upY,   text=str.tostring(i) + "x-1 High", textcolor=color.red,   style=label.style_label_left, size=size.small)
            lblDown = label.new(x=x2, y=downY, text=str.tostring(i) + "x1 High",  textcolor=color.white, style=label.style_label_left, size=size.small)
            array.push(highFanLabels, lblUp)
            array.push(highFanLabels, lblDown)

// === LEGEND (TOP-RIGHT TEXT BOX STYLE) ===
var label legendLabel = na
if showLegendPanel and bar_index == ta.highest(bar_index, 1)
    if not na(legendLabel)
        label.delete(legendLabel)
    legendLabel := label.new(x=bar_index + 50,y=ta.highest(high, 100) + atrVal * 2,text="ðŸ“ Gann Fan Momentum Guide:\n1x1 = Balanced trend\n2x1 = Strong trend\n3x1 = Extreme momentum\n\nðŸŸ¢ Support (x1)\nðŸ”´ Resistance (x-1)\nâ–¼â–²  Cycle Marker = Gann Time Cycle\nðŸŸ¢background = riding above 2x1 or 3x1 = upside momentum\nðŸ”´background = riding below 2x-1 or 3x-1 = downside momentum",style=label.style_label_left,textcolor=color.white,size=size.normal,color=color.black,textalign=text.align_left)

if not showLegendPanel and not na(legendLabel)
    label.delete(legendLabel)
    legendLabel := na
    //

// Â© merlin51685
