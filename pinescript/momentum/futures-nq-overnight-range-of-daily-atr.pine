//@version=6
indicator("Futures: NQ Overnight Range (% of Daily ATR)", overlay=true)

// ===== Inputs =====
atrLen     = input.int(14, "Daily ATR Length", minval=1)
onSession  = input.session("1800-0930", "Overnight Session (Exchange Time)")
showLabel  = input.bool(true, "Show Status Label")

chopThresh  = input.float(25.0, "Chop if ON Range %ATR < ", step=0.5)
trendThresh = input.float(50.0, "Expansion if ON Range %ATR > ", step=0.5)

// ===== Daily ATR (from Daily timeframe) =====
dailyATR   = request.security(syminfo.tickerid, "D", ta.atr(atrLen))
dailyClose = request.security(syminfo.tickerid, "D", close)
atrPct     = (dailyATR / dailyClose) * 100.0

// ===== Overnight High/Low (18:00 -> 09:30) =====
inON = not na(time(timeframe.period, onSession))

var float onHigh = na
var float onLow  = na

// Start of overnight session (first bar inside ON after being outside)
onStart = inON and not inON[1]

// Reset ON range exactly at session start (18:00)
if onStart
    onHigh := high
    onLow  := low
else if inON
    onHigh := na(onHigh) ? high : math.max(onHigh, high)
    onLow  := na(onLow)  ? low  : math.min(onLow, low)

onRange = (na(onHigh) or na(onLow)) ? na : (onHigh - onLow)
onRangePctOfATR = (na(onRange) or dailyATR == 0) ? na : (onRange / dailyATR) * 100.0

// ===== Regime =====
string regime = "NO DATA"
if not na(onRangePctOfATR)
    regime := onRangePctOfATR < chopThresh ? "CHOP-LEANING" :
              onRangePctOfATR > trendThresh ? "EXPANSION-LEANING" :
              "NEUTRAL"

// ===== Display (single label) =====
var label lastLbl = na

onRangeStr = na(onRange) ? "n/a" : str.tostring(onRange, format.mintick)
onPctStr   = na(onRangePctOfATR) ? "n/a" : str.tostring(onRangePctOfATR, "#.##") + "%"

txt = "Symbol: " + syminfo.ticker +
      "\nDaily ATR(" + str.tostring(atrLen) + "): " + str.tostring(dailyATR, format.mintick) +
      "\nATR% (vs D close): " + str.tostring(atrPct, "#.##") + "%" +
      "\nON Range (18:00-09:30): " + onRangeStr +
      "\nON Range % of ATR: " + onPctStr +
      "\nRegime: " + regime

if showLabel and barstate.islast
    if not na(lastLbl)
        label.delete(lastLbl)
    lastLbl := label.new(bar_index, high, txt, style=label.style_label_down, textcolor=color.white, color=color.new(color.black, 0))
