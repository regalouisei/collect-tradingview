//@version=6
//======================================================================
//  RSI Adaptive Structure Engine (RASE)
//======================================================================
//
//  DESCRIPTION
//  --------------------------------------------------------------------
//  RSI Adaptive Structure Engine (RASE) is a multi-layer market structure
//  and regime analysis indicator built entirely using the Relative
//  Strength Index (RSI).
//
//  RASE identifies directional market regimes by combining:
//   - Structural RSI slope
//   - RSI efficiency (trend quality)
//   - Smoothed RSI momentum
//   - Fast RSI execution timing
//   - Higher-timeframe RSI confirmation for strong trends
//
//  Signals are state-based (non-spamming) and represent regime changes,
//  not trade entries.
//
//  DISCLAIMER
//  --------------------------------------------------------------------
//  Educational and analytical use only. Not financial advice.
//======================================================================

indicator("RSI Adaptive Structure Engine (RASE)", shorttitle="RASE", overlay=false)

//======================================================================
// INPUTS
//======================================================================
lenStructure = input.int(21, "Structure RSI Length", minval=14, maxval=50)
lenMomentum  = input.int(14, "Momentum RSI Length", minval=5,  maxval=30)
lenFast      = input.int(5,  "Fast RSI Length",     minval=2,  maxval=10)
effLen       = input.int(20, "RSI Efficiency Lookback", minval=5, maxval=50)

showBase     = input.bool(true, "Show Base Signals (Same TF)")
showStrong   = input.bool(true, "Show Strong Signals (HTF Aligned)")
showExec     = input.bool(false, "Show RSI Execution Signals (Same TF)")

//======================================================================
// RSI CALCULATIONS
//======================================================================
rsiStructure = ta.rsi(close, lenStructure)
rsiMomentum  = ta.rsi(close, lenMomentum)
rsiFast      = ta.rsi(close, lenFast)
rsiMomentumSmooth = ta.ema(rsiMomentum, 5)

//======================================================================
// RSI EFFICIENCY
//======================================================================
rsiChange = math.abs(rsiStructure - rsiStructure[effLen])
rsiNoise  = 0.0
for i = 0 to effLen - 1
    rsiNoise += math.abs(rsiStructure[i] - rsiStructure[i + 1])
rsiEfficiency = rsiNoise != 0 ? rsiChange / rsiNoise : 0.0

//======================================================================
// STRUCTURE STATES (SAME TF)
//======================================================================
structureUp   = rsiStructure > 50 and rsiStructure > rsiStructure[1]
structureDown = rsiStructure < 50 and rsiStructure < rsiStructure[1]

//======================================================================
// MOMENTUM STATES
//======================================================================
momentumUp   = rsiMomentumSmooth > rsiMomentumSmooth[1]
momentumDown = rsiMomentumSmooth < rsiMomentumSmooth[1]

//======================================================================
// EFFICIENCY STATES
//======================================================================
effOK = rsiEfficiency > 0.4

//======================================================================
// EXECUTION STATES (SAME TF)
//======================================================================
execUp   = rsiFast > 40 and rsiFast > rsiFast[1]
execDown = rsiFast < 60 and rsiFast < rsiFast[1]

// Optional execution triggers
rsiCrossUp   = ta.crossover(rsiStructure, 50) and rsiStructure > rsiStructure[1]
rsiCrossDown = ta.crossunder(rsiStructure, 50) and rsiStructure < rsiStructure[1]

//======================================================================
// BASE REGIME (SAME TF ONLY)
//======================================================================
bullBase = structureUp and momentumUp and effOK and execUp
bearBase = structureDown and momentumDown and effOK and execDown

//======================================================================
// STRONG REGIME (REQUIRES HTF)
//======================================================================
bullStrong = bullBase and rsiStructure > 55 and rsiMomentum > 55
bearStrong = bearBase and rsiStructure < 45 and rsiMomentum < 45

//======================================================================
// HIGHER TIMEFRAME FILTER (3x)
//======================================================================
htfTF = timeframe.isdaily ? "D" : str.tostring(timeframe.multiplier * 3)
htfRSI = request.security(syminfo.tickerid, htfTF, ta.rsi(close, lenStructure))
htfBull = htfRSI > 50 and htfRSI > htfRSI[1]
htfBear = htfRSI < 50 and htfRSI < htfRSI[1]

//======================================================================
// STATE MACHINES
//======================================================================
var int baseState   = 0
var int strongState = 0

bullBaseSig = bullBase and baseState != 1
bearBaseSig = bearBase and baseState != -1

if bullBaseSig
    baseState := 1
if bearBaseSig
    baseState := -1

bullStrongSig = bullStrong and htfBull and strongState != 1
bearStrongSig = bearStrong and htfBear and strongState != -1

if bullStrongSig
    strongState := 1
if bearStrongSig
    strongState := -1

//======================================================================
// VISUALS
//======================================================================
plot(rsiStructure, title="RSI Structure", color=color.blue, linewidth=2)
plot(rsiMomentumSmooth, title="RSI Momentum (Smoothed)", color=color.orange)
hline(50, "RSI Midline", color=color.gray)

// Base signal — SINGLE TRIANGLE
plotshape(showBase and bullBaseSig, style=shape.triangleup,
     location=location.bottom, size=size.tiny, color=color.lime, title="Base Bull")

plotshape(showBase and bearBaseSig, style=shape.triangledown,
     location=location.top, size=size.tiny, color=color.red, title="Base Bear")

// Strong signal — DOUBLE STACKED TRIANGLES
plotshape(showStrong and bullStrongSig, style=shape.triangleup,
     location=location.bottom, size=size.small, color=color.lime, title="Strong Bull")

plotshape(showStrong and bullStrongSig, style=shape.triangleup,
     location=location.bottom, size=size.tiny, color=color.lime)

plotshape(showStrong and bearStrongSig, style=shape.triangledown,
     location=location.top, size=size.small, color=color.red, title="Strong Bear")

plotshape(showStrong and bearStrongSig, style=shape.triangledown,
     location=location.top, size=size.tiny, color=color.red)

// Optional execution signals (same TF)
plotshape(showExec and bullBase and rsiCrossUp, style=shape.circle,
     location=location.bottom, size=size.tiny, color=color.new(color.green, 0),
     title="Execution Bull")

plotshape(showExec and bearBase and rsiCrossDown, style=shape.circle,
     location=location.top, size=size.tiny, color=color.new(color.red, 0),
     title="Execution Bear")
