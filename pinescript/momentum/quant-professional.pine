//@version=5
// @description 该指标采用经典的价格行为(Price Action)状态机逻辑。
// @description 通过追踪收盘价相对于前两周期的位置，定义多空序列的持续性。
// @description 核心逻辑：识别价格从长期空头序列向多头爆发转折的瞬间。
indicator("超短线动能转折系统 [Quant Professional]", shorttitle="Ultra-Momentum", overlay=true, precision=2)

// ==========================================
// 1. 多头序列持续性追踪 (Bullish Sequence Persistence)
// 逻辑：通过递归引用追踪多头能量的持稳状态 (VAR1 - VARC)
// ==========================================
// 基础多头定义：当前收盘价同时站上过去两个周期的收盘价
var1 = close > close[1] and close > close[2]
// 序列维持逻辑：当价格未创新高但仍守住关键支撑位时的状态递归
var2 = var1[1] and close <= close[1] and close >= close[2]
var3 = var2[1] and close >= close[1] and close <= close[2]
var4 = var3[1] and close <= close[1] and close >= close[2]
var5 = var4[1] and close >= close[1] and close <= close[2]
var6 = var5[1] and close <= close[1] and close >= close[2]
var7 = var6[1] and close >= close[1] and close <= close[2]
var8 = var7[1] and close <= close[1] and close >= close[2]
var9 = var8[1] and close >= close[1] and close <= close[2]
vara = var9[1] and close <= close[1] and close >= close[2]
varb = vara[1] and close >= close[1] and close >= close[2]
varc = varb[1] and close <= close[1] and close >= close[2]

// ==========================================
// 2. 空头序列持续 性追踪 (Bearish Sequence Persistence)
// 逻辑：通过递归引用追踪空头动能的延伸状态 (VARD - VAR18)
// ==========================================
// 基础空头定义：当前收盘价同时跌破过去两个周期的收盘价
vard  = close < close[1] and close < close[2]
// 跌势衰减/震荡判定：当价格反弹未果或维持在弱势区间时的状态追踪
vare  = vard[1] and close >= close[1] and close <= close[2]
varf  = vare[1] and close <= close[1] and close >= close[2]
var10 = varf[1] and close >= close[1] and close <= close[2]
var11 = var10[1] and close <= close[1] and close >= close[2]
var12 = var11[1] and close >= close[1] and close <= close[2]
var13 = var12[1] and close <= close[1] and close >= close[2]
var14 = var13[1] and close >= close[1] and close <= close[2]
var15 = var14[1] and close <= close[1] and close >= close[2]
var16 = var15[1] and close >= close[1] and close <= close[2]
var17 = var16[1] and close <= close[1] and close >= close[2]
var18 = var17[1] and close >= close[1] and close >= close[2]

// ==========================================
// 3. 信号矩阵与转折判定 (Signal Matrix & Reversal Trigger)
// ==========================================
// 逻辑：昨日处于空头能量序列中，今日出现强势价格破位(Breakout)
// 将12层空头状态汇总为统一的空头背景矩阵 (Matrix)
bear_seq_yesterday = vard[1] or vare[1] or varf[1] or var10[1] or var11[1] or var12[1] or var13[1] or var14[1] or var15[1] or var16[1] or var17[1] or var18[1]

// 触发点：从空头存续状态向多头始发状态的质变切换
entry_signal = bear_seq_yesterday and var1

// ==========================================
// 4. 视觉渲染引擎 (Visualization Layer)
// ==========================================
plotshape(entry_signal, 
     title     = "Momentum Reversal", 
     style     = shape.arrowup, 
     location  = location.belowbar, 
     color     = color.new(#ff3333, 0), 
     size      = size.small, 
     text      = "尾盘买\n次日盈利卖\n快进快出积少成多", 
     textcolor = color.new(#ff3333, 0))

// ==========================================
// 5. 警报集成 (Alert Integration)
// ==========================================
alertcondition(entry_signal, title="动能转折信号", message="检测到多头始发转折信号: {{ticker}}")
