//@version=5
indicator("MACD RSI EMA AGGRESSIVE + ATR SLTP (ALL COIN)", overlay=true)

// ================= INPUT =================
fastLen   = input.int(12, "MACD Fast")
slowLen   = input.int(26, "MACD Slow")
signalLen = input.int(9,  "MACD Signal")

rsiLen  = input.int(14, "RSI Length")
rsiBuy  = input.int(52, "RSI Buy Filter")
rsiSell = input.int(48, "RSI Sell Filter")

emaLen = input.int(21, "EMA Trend")

atrLen = input.int(14, "ATR Length")
slATR  = input.float(1.0, "SL ATR Multiplier")
tpATR  = input.float(1.5, "TP ATR Multiplier")

volLen     = input.int(20, "Volume SMA")
volFactor  = input.float(1.2, "Volume Factor")

// ================= INDICATORS =================
[macdLine, signalLine, _] = ta.macd(close, fastLen, slowLen, signalLen)
rsiVal = ta.rsi(close, rsiLen)
emaVal = ta.ema(close, emaLen)
atrVal = ta.atr(atrLen)

// volume filter (anti sideways)
volOK = volume > ta.sma(volume, volLen) * volFactor

// ================= CONDITIONS =================
buyCond  = ta.crossover(macdLine, signalLine) and rsiVal > rsiBuy  and close > emaVal and volOK
sellCond = ta.crossunder(macdLine, signalLine) and rsiVal < rsiSell and close < emaVal and volOK

// ================= PLOT =================
plot(emaVal, title="EMA Trend", color=color.yellow, linewidth=2)

plotshape(buyCond,  title="BUY",  style=shape.labelup,   location=location.belowbar,
     color=color.new(color.green, 0), text="BUY", textcolor=color.white, size=size.small)

plotshape(sellCond, title="SELL", style=shape.labeldown, location=location.abovebar,
     color=color.new(color.red, 0), text="SELL", textcolor=color.white, size=size.small)

// ================= ATR SL / TP =================
plot(buyCond  ? close - atrVal * slATR : na, title="Buy SL",  color=color.red)
plot(buyCond  ? close + atrVal * tpATR : na, title="Buy TP",  color=color.green)

plot(sellCond ? close + atrVal * slATR : na, title="Sell SL", color=color.red)
plot(sellCond ? close - atrVal * tpATR : na, title="Sell TP", color=color.green)

// ================= ALERTS =================
alertcondition(buyCond,  title="BUY ALERT",  message="BUY {{ticker}} {{interval}}")
alertcondition(sellCond, title="SELL ALERT", message="SELL {{ticker}} {{interval}}")
