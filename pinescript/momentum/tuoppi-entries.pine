//@version=6
indicator("Tuoppi Entries", shorttitle="TuoppiEnt", overlay=true, max_labels_count=500)

//====================
// Inputs
//====================
signalTfOpt = input.string(
    "Chart",
    "Signal timeframe",
    options = [
        "Chart",
        "1min", "3min", "5min", "10min", "15min", "30min",
        "1 hour", "2 hour", "4 hour",
        "1 day", "3 day",
        "1 week", "1 month"
    ]
)

n1 = input.int(10, "Wavetrend Channel Length", minval=1)
n2 = input.int(21, "Wavetrend Average Length", minval=1)
obLevel2 = input.int(53, "Overbought level for SHORT")
osLevel2 = input.int(-53, "Oversold level for LONG")
shortColor = input.color(color.red, "Short icon color")
longColor  = input.color(color.lime, "Long icon color")

//====================
// Resolve timeframe
//====================
tf =
     signalTfOpt == "Chart"   ? timeframe.period :
     signalTfOpt == "1min"    ? "1"  :
     signalTfOpt == "3min"    ? "3"  :
     signalTfOpt == "5min"    ? "5"  :
     signalTfOpt == "10min"   ? "10" :
     signalTfOpt == "15min"   ? "15" :
     signalTfOpt == "30min"   ? "30" :
     signalTfOpt == "1 hour"  ? "60" :
     signalTfOpt == "2 hour"  ? "120":
     signalTfOpt == "4 hour"  ? "240":
     signalTfOpt == "1 day"   ? "D"  :
     signalTfOpt == "3 day"   ? "3D" :
     signalTfOpt == "1 week"  ? "W"  :
     signalTfOpt == "1 month" ? "M"  :
     timeframe.period

//====================
// Wavetrend function (for request.security)
//====================
f_wavetrend(_n1, _n2) =>
    ap = hlc3
    esa = ta.ema(ap, _n1)
    d = ta.ema(math.abs(ap - esa), _n1)
    ci = (ap - esa) / (0.015 * d)
    tci = ta.ema(ci, _n2)
    wt1 = tci
    wt2 = ta.sma(wt1, 4)
    [wt1, wt2]

//====================
// Get WT values from selected timeframe 
//====================
[wt1TF, wt2TF] = request.security(syminfo.tickerid, tf, f_wavetrend(n1, n2))

//====================
// Tuoppi / MCB dot logic
//====================
isCross     = ta.cross(wt1TF, wt2TF)
bearishDot  = isCross and (wt2TF - wt1TF > 0)
bullishDot  = isCross and (wt2TF - wt1TF < 0)

bearishAbove = wt2TF > obLevel2
bullishBelow = wt2TF < osLevel2

shortSignal = bearishDot and bearishAbove
longSignal  = bullishDot and bullishBelow

//====================
// Plot
//====================
plotshape(shortSignal, title="Short signal", style=shape.labeldown, location=location.abovebar, size=size.normal, color=color.new(shortColor, 0))
plotshape(longSignal,  title="Long signal",  style=shape.labelup,   location=location.belowbar, size=size.normal, color=color.new(longColor, 0))

//====================
// Alerts
//====================
alertcondition(shortSignal, title="TuoppiEnt — Short", message="Tuoppi SHORT signal")
alertcondition(longSignal,  title="TuoppiEnt — Long",  message="Tuoppi LONG signal")
