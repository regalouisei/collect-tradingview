//@version=6
indicator('VuMan-Oscillator-Matrix-Pro w/RSI', overlay = false, 
format=format.price, precision=2, timeframe="", timeframe_gaps=true)
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// This code is licensed under the Mozilla Public License 2.0
// You can obtain a copy of the license at https://mozilla.org/MPL/2.0/
//
//Use at your own Risk!!
//
//This is a indicator that was created from three different ones I started with VooManChu's Chphers b With diverenges and updated it from Pine ver.4 to Pine v5
// and satriped the Money Flow Index from it and added it to Oscillator Matrix by R2D2 and then updated to pine Ver.6 and took the stock tradingview's RSI 
// truned on divergences by default and removed the big box lables so now we have the Oscillator Matrix crosses with VooManChu Money Flow and with rsi all rolled into 
// on indicator.
// ==========================================
// ðŸ”¶ SETTINGS
// ==========================================
grp_hw = 'Hyper Wave Settings'
hw_len1 = input.int(10, 'Channel Length', group = grp_hw)
hw_len2 = input.int(21, 'Average Length', group = grp_hw)
show_hw = input.bool(true, 'Show Hyper Wave Ribbon', group = grp_hw)

// RSI+MFI
rsiMFIShow = input.bool(true, title = 'Show MFI', group = 'MFI Settings')
rsiMFIperiod = input.int(60, title = 'MFI Period', group = 'MFI Settings')
rsiMFIMultiplier = input.float(150, title = 'MFI Area multiplier', group = 'MFI Settings')
rsiMFIPosY = input.float(2.5, title = 'MFI Area Y Pos', group = 'MFI Settings')

grp_sig = 'Signal Settings'
show_div = input.bool(true, 'Show Divergences', group = grp_sig)
show_rev = input.bool(true, 'Show Reversal Dots', group = grp_sig)

// ==========================================
// ðŸ”¶ CALCULATIONS
// ==========================================

// --- 1. Hyper Wave (WaveTrend Logic) ---
// The Hyper Wave is typically a "WaveTrend" oscillator (ESA/D momentum).
ap = hlc3
esa = ta.ema(ap, hw_len1)
d = ta.ema(math.abs(ap - esa), hw_len1)
ci = (ap - esa) / (0.015 * d)
tci = ta.ema(ci, hw_len2)

wt1 = tci
wt2 = ta.sma(wt1, 4)

// Colors for Hyper Wave
hw_color_bull = #00ffbb // Teal
hw_color_bear = #ff1100 // Red
curr_hw_color = wt1 >= wt2 ? hw_color_bull : hw_color_bear


// ==========================================
// ðŸ”¶ PLOTTING
// ==========================================
// RSI+MFI
f_rsimfi(_period, _multiplier, _tf) =>
    request.security(syminfo.tickerid, _tf, ta.sma((close - open) / (high - low) * _multiplier, _period) - rsiMFIPosY)
    //////////////////////////////////////////////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Money Flow Index From VuuManChu Market CipherB
// RSI + MFI Area
rsiMFI = f_rsimfi(rsiMFIperiod, rsiMFIMultiplier, timeframe.period)
rsiMFIColorAbove = input.color(color.new(#3ee145, 0), 'MFI Color > 0', group = 'Color Settings')
rsiMFIColorBelow = input.color(color.new(#ff3d2e, 0), 'MFI Color < 0', group = 'Color Settings')
rsiMFIColor = rsiMFI > 0 ? rsiMFIColorAbove : rsiMFIColorBelow


//  MFI BAR
rsiMfiBarTopLine = plot(rsiMFIShow ? -95 : na, title = 'MFI Bar TOP Line')
rsiMfiBarBottomLine = plot(rsiMFIShow ? -99 : na, title = 'MFI Bar BOTTOM Line')
fill(rsiMfiBarTopLine, rsiMfiBarBottomLine, title = 'MFI Bar Colors', color = rsiMFIColor)
plot(rsiMFIShow ? rsiMFI : na, style = plot.style_area, title = 'rsiMFI', color = color.new(rsiMFIColor, 50))

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// --- Hyper Wave Plots ---
// The Ribbon Effect
p1 = plot(show_hw ? wt1 : na, 'HW Fast', color = color.new(#ffffff, 50), linewidth = 1)
p2 = plot(show_hw ? wt2 : na, 'HW Slow', color = color.new(#ffffff, 80), linewidth = 1)
fill(p1, p2, color = color.new(curr_hw_color, 70), title = 'Hyper Wave Ribbon')


// ==========================================
// ðŸ”¶ SIGNALS & DIVERGENCES
// ==========================================

// --- Reversal Dots (High Frequency) ---
// Triggered on Hyper Wave Crossovers
cross_up = ta.crossover(wt1, wt2)
cross_dn = ta.crossunder(wt1, wt2)

// Only show dots if they happen in significant areas (optional filter, here we show all like the image)
plotshape(show_rev and cross_up ? wt2 - 5 : na, 'Reversal Up', shape.circle, location.absolute, hw_color_bull, size = size.tiny)
plotshape(show_rev and cross_dn ? wt2 + 5 : na, 'Reversal Down', shape.circle, location.absolute, hw_color_bear, size = size.tiny)

// --- Real-Time Divergences (Simplified) ---
// Looking for price Lower Lows while Oscillator makes Higher Lows (Bullish)
// Looking for price Higher Highs while Oscillator makes Lower Highs (Bearish)

lookback = 5
src = wt1

// Bullish Divergence
lo = ta.lowest(src, lookback)
is_lowest = src == lo
price_lo = low
var float last_osc_lo = na
var float last_price_lo = na
bool bull_div = false

if is_lowest
    if src > last_osc_lo and low < last_price_lo
        bull_div := true
        bull_div
    last_osc_lo := src
    last_price_lo := low
    last_price_lo

// Bearish Divergence
hi = ta.highest(src, lookback)
is_highest = src == hi
var float last_osc_hi = na
var float last_price_hi = na
bool bear_div = false

if is_highest
    if src < last_osc_hi and high > last_price_hi
        bear_div := true
        bear_div
    last_osc_hi := src
    last_price_hi := high
    last_price_hi

// Plot Divergence Arrows (Large "Strong" Signals)
plotshape(show_div and bull_div, 'Bullish Divergence', shape.triangleup, location.bottom, hw_color_bull, size = size.small)
plotshape(show_div and bear_div, 'Bearish Divergence', shape.triangledown, location.top, hw_color_bear, size = size.small)
// Zero Lines & Boundaries
hline(0, 'Zero Line', color = color.new(color.gray, 50))
hline(60, 'Overbought', color = color.new(#ff0000, 80), linestyle = hline.style_solid, linewidth = 2)
hline(-60, 'Oversold', color = color.new(#186109, 33), linestyle = hline.style_solid, linewidth = 3)

//////////////////////////////////////////////////////////////////////////////////////////////////////////////
//TradingView-RSI
//format=format.price, precision=2, timeframe="", timeframe_gaps=true)

rsiLengthInput = input.int(14, minval=1, title="RSI Length", group="RSI Settings")
rsiSourceInput = input.source(close, "Source", group="RSI Settings")
calculateDivergence = input.bool(true, title="Calculate Divergence", group="RSI Settings", display = display.none, tooltip = "Calculating divergences is needed in order for divergence alerts to fire.")

change = ta.change(rsiSourceInput)
up = ta.rma(math.max(change, 0), rsiLengthInput)
down = ta.rma(-math.min(change, 0), rsiLengthInput)
rsi = down == 0 ? 100 : up == 0 ? 0 : 100 - (100 / (1 + up / down))

rsiPlot = plot(rsi, "RSI", linewidth = 1, color=color.rgb(4, 77, 236, 20))
rsiUpperBand = hline(70, "RSI Upper Band", color=#787b8600)
midline = hline(50, "RSI Middle Band",
linewidth = 2, color = color.new(#fdfdff, 50), linestyle = hline.style_solid)
rsiLowerBand = hline(30, "RSI Lower Band", color=#787b8600)
fill(rsiUpperBand, rsiLowerBand, color=color.rgb(126, 87, 194, 90), title="RSI Background Fill")
midLinePlot = plot(50, color = na, editable = false, display = display.none)
fill(rsiPlot, midLinePlot, 100, 70, top_color = color.new(#f50404, 0), bottom_color = color.new(#f30101, 100),  title = "Overbought Gradient Fill")
fill(rsiPlot, midLinePlot, 30,  0,  top_color = color.new(#2de408, 100), bottom_color = color.new(#2cf504, 0),      title = "Oversold Gradient Fill")

// Smoothing MA inputs
GRP = "Smoothing"
TT_BB = "Only applies when 'SMA + Bollinger Bands' is selected. Determines the distance between the SMA and the bands."
maTypeInput = input.string("SMA", "Type", options = ["None", "SMA", "SMA + Bollinger Bands", "EMA", "SMMA (RMA)", "WMA", "VWMA"], group = GRP, display = display.none)
var isBB = maTypeInput == "SMA + Bollinger Bands"
maLengthInput = input.int(14, "Length", group = GRP, display = display.none, active = maTypeInput != "None")
bbMultInput = input.float(2.0, "BB StdDev", minval = 0.001, maxval = 50, step = 0.5, tooltip = TT_BB, group = GRP, display = display.none, active = isBB)
var enableMA = maTypeInput != "None"

// Smoothing MA Calculation
ma(source, length, MAtype) =>
    switch MAtype
        "SMA"                   => ta.sma(source, length)
        "SMA + Bollinger Bands" => ta.sma(source, length)
        "EMA"                   => ta.ema(source, length)
        "SMMA (RMA)"            => ta.rma(source, length)
        "WMA"                   => ta.wma(source, length)
        "VWMA"                  => ta.vwma(source, length)

// Smoothing MA plots
smoothingMA = enableMA ? ma(rsi, maLengthInput, maTypeInput) : na
smoothingStDev = isBB ? ta.stdev(rsi, maLengthInput) * bbMultInput : na
plot(smoothingMA, "RSI-based MA", linewidth = 1, color=color.rgb(255, 235, 59, 59), display = enableMA ? display.all : display.none, editable = enableMA)
bbUpperBand = plot(smoothingMA + smoothingStDev, title = "Upper Bollinger Band", color=color.green, display = isBB ? display.all : display.none, editable = isBB)
bbLowerBand = plot(smoothingMA - smoothingStDev, title = "Lower Bollinger Band", color=color.green, display = isBB ? display.all : display.none, editable = isBB)
fill(bbUpperBand, bbLowerBand, color= isBB ? color.new(color.green, 90) : na, title="Bollinger Bands Background Fill", display = isBB ? display.all : display.none, editable = isBB)

// Divergence
lookbackRight = 5
lookbackLeft = 5
rangeUpper = 60
rangeLower = 5
bearColor = color.red
bullColor = color.green
textColor = color.white
noneColor = color.new(color.white, 100)

_inRange(bool cond) =>
    bars = ta.barssince(cond)
    rangeLower <= bars and bars <= rangeUpper

plFound = false
phFound = false

bullCond = false
bearCond = false

rsiLBR = rsi[lookbackRight]

if calculateDivergence
    //------------------------------------------------------------------------------
    // Regular Bullish
    // rsi: Higher Low
    plFound := not na(ta.pivotlow(rsi, lookbackLeft, lookbackRight))    
    rsiHL = rsiLBR > ta.valuewhen(plFound, rsiLBR, 1) and _inRange(plFound[1])
    // Price: Lower Low
    lowLBR = low[lookbackRight]
    priceLL = lowLBR < ta.valuewhen(plFound, lowLBR, 1)
    bullCond := priceLL and rsiHL and plFound

    //------------------------------------------------------------------------------
    // Regular Bearish
    // rsi: Lower High
    phFound := not na(ta.pivothigh(rsi, lookbackLeft, lookbackRight))
    rsiLH = rsiLBR < ta.valuewhen(phFound, rsiLBR, 1) and _inRange(phFound[1])
    // Price: Higher High
    highLBR = high[lookbackRight]
    priceHH = highLBR > ta.valuewhen(phFound, highLBR, 1)
    bearCond := priceHH and rsiLH and phFound


plot(
     plFound   ? rsiLBR : na,
     offset    = -lookbackRight,
     title     = "Regular Bullish",
     linewidth = 2,
     color     = (bullCond ? bullColor : noneColor),
     display   = display.pane,
     editable  = calculateDivergence)

plotshape(
     bullCond  ? rsiLBR : na,
     offset    = -lookbackRight,
     title     = "Regular Bullish Label",
     text      = " Bull ",
     style     = shape.xcross,
     location  = location.absolute,
     color     = bullColor,
     textcolor = bullColor,
     display   = display.pane,
     editable  = calculateDivergence)

plot(
     phFound   ? rsiLBR : na,
     offset    = -lookbackRight,
     title     = "Regular Bearish",
     linewidth = 2,
     color     = (bearCond ? bearColor : noneColor),
     display   = display.pane,
     editable  = calculateDivergence)

plotshape(
     bearCond  ? rsiLBR : na,
     offset    = -lookbackRight,
     title     = "Regular Bearish Label",
     text      = " Bear ",
     style     = shape.xcross,
     location  = location.absolute,
     color     = bearColor,
     textcolor = bearColor,
     display   = display.pane,
     editable  = calculateDivergence)

alertcondition(bullCond, title='Regular Bullish Divergence', message="Found a new Regular Bullish Divergence, `Pivot Lookback Right` number of bars to the left of the current bar.")
alertcondition(bearCond, title='Regular Bearish Divergence', message='Found a new Regular Bearish Divergence, `Pivot Lookback Right` number of bars to the left of the current bar.')

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
