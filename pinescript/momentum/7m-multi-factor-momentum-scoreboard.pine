//@version=6
indicator("7M Multi-Factor Momentum Scoreboard", overlay=true, max_bars_back=5000)

// ==========================================
// 1. DYNAMIC UI & COLOR CUSTOMIZATION
// ==========================================
grp_ui      = "ðŸŽ¨ DASHBOARD STYLING"
table_pos   = input.string("top_right", "Dashboard Position", options=["top_right", "top_left", "bottom_right", "bottom_left"], group=grp_ui)
text_size   = input.string("small", "Interface Scale", options=["tiny", "small", "normal", "large"], group=grp_ui)

// Manual Color Overrides
color_bg        = input.color(color.new(#0d1117, 15), "Panel Background", group=grp_ui)
color_header    = input.color(color.new(#161b22, 0), "Header Background", group=grp_ui)
color_text_lab  = input.color(#8b949e, "Label Text Color", group=grp_ui)
color_text_val  = input.color(color.white, "Value Text Color (Neutral)", group=grp_ui)
color_pass      = input.color(#00e676, "7M PASS Color", group=grp_ui) 
color_fail      = input.color(#ff1744, "7M FAIL Color", group=grp_ui) 

f_contrast(bg_col) =>
    r = color.r(bg_col), g = color.g(bg_col), b = color.b(bg_col)
    luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255
    luminance > 0.5 ? color.black : color.white

// ==========================================
// 2. 7M SYSTEM CONFIG & TIME ANCHOR
// ==========================================
g1 = "ðŸ“Š 7M SYSTEM CONFIG"
anchor_mode = input.string("Pre-Market (4:00)", "Price Change Anchor", options=["Pre-Market (4:00)", "Regular Open (9:30)", "Post-Market (16:00)"], group=g1)

flt_max     = input.float(25000.0, "Max Float (Mil)", group=g1) 
chg_min     = input.float(1.0, "Min % Move Threshold", group=g1) 
v5_min      = input.float(1000000, "Min 5m Vol", group=g1)
rvat_m      = input.float(1.2, "Relative Vol Min", group=g1)
rd_m        = input.float(1.1, "Daily RVOL Min", group=g1)
m7_pass_thr = input.int(7, "7M Pass Threshold", group=g1)

// ==========================================
// 3. CORE ANALYTICS
// ==========================================
tz = syminfo.timezone
is_new_day = ta.change(time("D", tz)) != 0

int anchor_h = anchor_mode == "Pre-Market (4:00)" ? 4 : (anchor_mode == "Regular Open (9:30)" ? 9 : 16)
int anchor_m = anchor_mode == "Regular Open (9:30)" ? 30 : 0

var float price_anchor = na
if is_new_day or (hour(time, tz) == anchor_h and minute(time, tz) == anchor_m)
    price_anchor := open

cur_chg  = not na(price_anchor) ? ((close - price_anchor) / price_anchor) * 100 : 0.0

t_reg    = time(timeframe.period, "0930-1600:1234567", tz)
t_pre    = time(timeframe.period, "0400-0930:1234567", tz)
mkt_str  = not na(t_reg) ? "Regular" : (not na(t_pre) ? "Pre" : "Post")

float_val = syminfo.shares_outstanding_float
rvd       = request.security(syminfo.tickerid, "D", volume / ta.sma(volume[1], 30))
vol5      = request.security(syminfo.tickerid, "5", volume)

vwap_v = ta.vwap(close)
vwma_v = ta.vwma(close, 20)
[m_l, m_s, _] = ta.macd(close, 12, 26, 9)
rsi_v  = ta.rsi(close, 14)

f_rvat(len) =>
    float sum_v = 0.0
    int count = 0
    for i = 1 to 2000 
        if hour[i] == hour and minute[i] == minute
            sum_v += volume[i]
            count += 1
            if count >= len
                break
    count > 0 ? volume / (sum_v / count) : 1.0

rvat_val = request.security(syminfo.tickerid, "5", f_rvat(20))

// ==========================================
// 4. 7M SCORING ENGINE
// ==========================================
int m7_score = 0
m7_score += (cur_chg >= chg_min ? 1 : 0)
m7_score += (not na(float_val) and float_val/1e6 <= flt_max ? 1 : 0)
m7_score += (vol5 >= v5_min ? 1 : 0)
m7_score += (rvat_val >= rvat_m ? 1 : 0)
m7_score += (rvd >= rd_m ? 1 : 0)
m7_score += (m_l > m_s ? 1 : 0)
m7_score += (close > vwap_v ? 1 : 0)
m7_score += (rsi_v >= 30 and rsi_v <= 70 ? 1 : 0)
m7_score += (close > vwma_v ? 1 : 0)

// ==========================================
// 5. TERMINAL DISPLAY
// ==========================================
var table ui = table.new(table_pos, 2, 15, border_width=1, border_color=color.new(#30363d, 50))

f_cell(row, label, value, val_color) =>
    table.cell(ui, 0, row, label, bgcolor=color_bg, text_color=color_text_lab, text_size=text_size, text_halign=text.align_left)
    table.cell(ui, 1, row, value, bgcolor=color_bg, text_color=val_color, text_size=text_size, text_halign=text.align_right)

if barstate.islast
    table.clear(ui, 0, 0, 1, 14)
    
    // Header
    table.cell(ui, 0, 0, "7M Dashboard", bgcolor=color_header, text_color=color.white, text_size=text_size, text_halign=text.align_left)
    table.cell(ui, 1, 0, syminfo.ticker + " (" + mkt_str + ")", bgcolor=color_header, text_color=color.white, text_size=text_size, text_halign=text.align_right)
    
    // Rows
    f_cell(1, "Country/Industry", syminfo.country + " / " + syminfo.industry, color_text_val)
    f_cell(2, "Price", str.tostring(close, format.mintick), color_text_val)
    f_cell(3, "Change", str.tostring(cur_chg, "#.##")+"%", cur_chg >= chg_min ? color_pass : color_fail)
    f_cell(4, "Float", str.tostring(float_val/1e6, "#")+"M", float_val/1e6 <= flt_max ? color_pass : color_fail)
    f_cell(5, "5m Volume", str.tostring(vol5, format.volume), vol5 >= v5_min ? color_pass : color_fail)
    f_cell(6, "relVol at time", str.tostring(rvat_val, "#.##")+"x", rvat_val >= rvat_m ? color_pass : color_fail)
    f_cell(7, "relVol Daily", str.tostring(rvd, "#.##")+"x", rvd >= rd_m ? color_pass : color_fail)
    f_cell(8, "MACD", m_l > m_s ? "Bullish" : "Bearish", m_l > m_s ? color_pass : color_fail)
    f_cell(9, "VWAP", close > vwap_v ? "Above" : "Below", close > vwap_v ? color_pass : color_fail)
    f_cell(10, "RSI", str.tostring(rsi_v, "#"), (rsi_v >= 30 and rsi_v <= 70) ? color_pass : color_fail)
    f_cell(11, "Trend (VWMA)", close > vwma_v ? "Supported" : "Broken", close > vwma_v ? color_pass : color_fail)

    // 7M Score Footer
    score_bg = m7_score >= m7_pass_thr ? color_pass : color_fail
    score_txt = f_contrast(score_bg)
    score_size = text_size == "tiny" ? "small" : (text_size == "small" ? "normal" : "large")
    
    table.cell(ui, 0, 12, "7M Score", bgcolor=score_bg, text_color=score_txt, text_size=score_size, text_halign=text.align_left)
    table.cell(ui, 1, 12, str.tostring(m7_score) + " / 9", bgcolor=score_bg, text_color=score_txt, text_size=score_size, text_halign=text.align_right)

// ==========================================
// 6. ALERTS
// ==========================================
if ta.change(m7_score) != 0 and m7_score >= m7_pass_thr and barstate.isconfirmed
    alert("ðŸš€ 7M PASS: " + syminfo.ticker + " Score: " + str.tostring(m7_score) + "/9", alert.freq_once_per_bar_close)
