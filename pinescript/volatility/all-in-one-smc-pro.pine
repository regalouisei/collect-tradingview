//@version=6
indicator("All-in-One SMC Pro – Fixed & Improved", shorttitle="SMC Pro v6", overlay=true, max_labels_count=500, max_lines_count=500, max_boxes_count=500)

// ────────────────────────────────────────
// Inputs
// ────────────────────────────────────────
showBOS       = input.bool(true,  "Show Break of Structure (BOS)")
showCHOCH     = input.bool(true,  "Show Change of Character (CHOCH)")
showFVG       = input.bool(true,  "Show Fair Value Gaps")
showOB        = input.bool(true,  "Show Order Blocks")
showLiq       = input.bool(true,  "Show Liquidity Grabs")
showDiscPrem  = input.bool(true,  "Show Discount / Premium Zones")

swingLen      = input.int(5,      "Swing Lookback (BOS/CHOCH)", minval=3, maxval=20)
fvgSens       = input.float(0.08, "FVG Sensitivity (ATR multiplier)", minval=0.02, step=0.01)
obLookback    = input.int(25,     "Order Block Lookback bars", minval=5)
liqThreshold  = input.int(3,      "Liquidity Grab – equal bars lookback")

colBull       = input.color(color.new(#00ff9d, 65), "Bullish Color")
colBear       = input.color(color.new(#ff3366, 65), "Bearish Color")
colFVG        = input.color(color.new(#cc33ff, 78), "FVG Color")
colOB         = input.color(color.new(#ffaa00, 78), "Order Block Color")
colLiq        = input.color(color.new(#ffff00, 70), "Liquidity Color")

// ────────────────────────────────────────
// Swing detection (more reliable)
// ────────────────────────────────────────
ph = ta.pivothigh(high, swingLen, swingLen)
pl = ta.pivotlow (low,  swingLen, swingLen)

// Keep last confirmed swing points
var float lastPH = na
var float lastPL = na

if not na(ph)
    lastPH := ph
if not na(pl)
    lastPL := pl

// ────────────────────────────────────────
// BOS & CHOCH
// ────────────────────────────────────────
bullBOS  = not na(lastPH) and close > lastPH and close[1] <= lastPH
bearBOS  = not na(lastPL) and close < lastPL and close[1] >= lastPL

// CHOCH – more standard definition (failure to make new extreme + break opposite structure)
bullCHOCH = not na(lastPL) and low < lastPL and close > lastPH
bearCHOCH = not na(lastPH) and high > lastPH and close < lastPL

if showBOS and bullBOS
    line.new(bar_index[swingLen], lastPH, bar_index, lastPH, color=colBull, width=2, style=line.style_solid)

if showBOS and bearBOS
    line.new(bar_index[swingLen], lastPL, bar_index, lastPL, color=colBear, width=2, style=line.style_solid)

if showCHOCH and bullCHOCH
    label.new(bar_index, low, "CHOCH ↑", color=colBull, style=label.style_label_up, textcolor=color.white, size=size.small)

if showCHOCH and bearCHOCH
    label.new(bar_index, high, "CHOCH ↓", color=colBear, style=label.style_label_down, textcolor=color.white, size=size.small)

// ────────────────────────────────────────
// Fair Value Gaps – more sensitive & visible
// ────────────────────────────────────────
atr = ta.atr(14)
minGap = atr * fvgSens

bullFVG = low > high[2] + minGap and close[1] < open[1]
bearFVG = high < low[2] - minGap and close[1] > open[1]

if showFVG and bullFVG
    box.new(left=bar_index[2], top=high[2], right=bar_index+80, bottom=low, 
            bgcolor=color.new(colFVG, 82), border_color=colFVG, border_width=1)

if showFVG and bearFVG
    box.new(left=bar_index[2], top=high, right=bar_index+80, bottom=low[2], 
            bgcolor=color.new(colFVG, 82), border_color=colFVG, border_width=1)

// ────────────────────────────────────────
// Order Blocks (last opposite candle before BOS)
// ────────────────────────────────────────
var float bullOB_top   = na
var float bullOB_bottom = na
var float bearOB_top   = na
var float bearOB_bottom = na

if bullBOS
    // Look back for last bearish candle before BOS
    for i = 1 to 15
        if close[i] < open[i]
            bullOB_top   := high[i]
            bullOB_bottom := low[i]
            break

if bearBOS
    for i = 1 to 15
        if close[i] > open[i]
            bearOB_top   := high[i]
            bearOB_bottom := low[i]
            break

if showOB and not na(bullOB_bottom)
    box.new(left=bar_index-obLookback, top=bullOB_top*1.002, right=bar_index+60, bottom=bullOB_bottom*0.998,
            bgcolor=color.new(colOB, 84), border_color=colOB, border_width=1)

if showOB and not na(bearOB_bottom)
    box.new(left=bar_index-obLookback, top=bearOB_top*1.002, right=bar_index+60, bottom=bearOB_bottom*0.998,
            bgcolor=color.new(colOB, 84), border_color=colOB, border_width=1)

// ────────────────────────────────────────
// Liquidity grabs (equal highs/lows + reversal)
// ────────────────────────────────────────
eqHigh = true
eqLow  = true

tolerance = syminfo.mintick * 1.5          // 1.5 ticks tolerance – adjust as needed
// or: tolerance = 0.0001                   // fixed small value
// or: tolerance = atr * 0.02               // dynamic, relative to volatility

for i = 1 to liqThreshold
    eqHigh := eqHigh and math.abs(high - high[i]) <= tolerance
    eqLow  := eqLow  and math.abs(low  - low[i])  <= tolerance

liqGrabHigh = eqHigh and close < open      // equal highs + bearish reversal candle
liqGrabLow  = eqLow  and close > open      // equal lows  + bullish reversal candle

if showLiq and liqGrabHigh
    label.new(bar_index, high, "Liq High", color=colLiq, style=label.style_label_down, size=size.tiny, textcolor=color.black)

if showLiq and liqGrabLow
    label.new(bar_index, low,  "Liq Low",  color=colLiq, style=label.style_label_up,   size=size.tiny, textcolor=color.black)
// ────────────────────────────────────────
// Discount / Premium (less aggressive)
// ────────────────────────────────────────
eq = (high + low + close) / 3
discount = close < eq * 0.992
premium  = close > eq * 1.008

bgcolor(showDiscPrem and discount ? color.new(color.green, 94) : na)
bgcolor(showDiscPrem and premium  ? color.new(color.red,   94) : na)
