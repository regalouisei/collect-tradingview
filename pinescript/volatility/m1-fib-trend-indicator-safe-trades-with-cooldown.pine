//@version=5
indicator("M1 Fib Trend Indicator - Safe Trades with Cooldown", overlay=true, max_labels_count=500, max_lines_count=500)

// ===== Inputs =====
fastEMA = input.int(9, "Fast EMA")
slowEMA = input.int(21, "Slow EMA")
atrMultiplier = input.float(2.0, "ATR SL Multiplier")  // wider SL
extraBuffer = input.float(0.5, "SL Extra Buffer")      // extra points for SL
cooldownBars = input.int(3, "Cooldown Bars After Exit") // prevent immediate re-entry
showBoxes = input.bool(true, "Show Trade Box")

// ===== EMA Trend =====
emaFast = ta.ema(close, fastEMA)
emaSlow = ta.ema(close, slowEMA)
uptrend = emaFast > emaSlow
downtrend = emaFast < emaSlow

// ===== Swing High/Low for Fibonacci =====
swingHigh = ta.highest(high, 20)
swingLow = ta.lowest(low, 20)

// ===== Fibonacci Levels =====
fib618 = uptrend ? swingLow + (swingHigh - swingLow) * 0.618 : swingHigh - (swingHigh - swingLow) * 0.618
tp161 = uptrend ? swingLow + (swingHigh - swingLow) * 1.618 : swingHigh - (swingHigh - swingLow) * 1.618

plot(fib618, color=color.green)
plot(tp161, color=color.purple)

// ===== ATR-based SL =====
atr = ta.atr(14)
slLong = uptrend ? swingLow - atr * atrMultiplier - extraBuffer : na
slShort = downtrend ? swingHigh + atr * atrMultiplier + extraBuffer : na

// ===== Trade Tracking =====
var bool inLong = false
var bool inShort = false
var float entryPrice = na
var float stopLoss = na
var float takeProfit = na
var box tradeBox = na
var int lastExitBar = na

// ===== Entry Signals with Cooldown =====
longSignal = uptrend and not inLong and not inShort and ta.crossunder(close, fib618) and (na(lastExitBar) or (bar_index - lastExitBar) > cooldownBars)
shortSignal = downtrend and not inLong and not inShort and ta.crossover(close, fib618) and (na(lastExitBar) or (bar_index - lastExitBar) > cooldownBars)

if longSignal
    inLong := true
    entryPrice := close
    stopLoss := slLong
    takeProfit := tp161
    if showBoxes
        tradeBox := box.new(left=bar_index, right=bar_index+50, top=takeProfit, bottom=stopLoss, border_color=color.green, bgcolor=color.new(color.green, 80))
    label.new(bar_index, low, "BUY", style=label.style_label_up, color=color.green, textcolor=color.white, size=size.small)

if shortSignal
    inShort := true
    entryPrice := close
    stopLoss := slShort
    takeProfit := tp161
    if showBoxes
        tradeBox := box.new(left=bar_index, right=bar_index+50, top=stopLoss, bottom=takeProfit, border_color=color.red, bgcolor=color.new(color.red, 80))
    label.new(bar_index, high, "SELL", style=label.style_label_down, color=color.red, textcolor=color.white, size=size.small)

// ===== Exit Signals =====
if inLong
    if close >= takeProfit or close <= stopLoss
        label.new(bar_index, close >= takeProfit ? high : low, close >= takeProfit ? "TP Hit" : "SL Hit", style=label.style_label_down, color=close >= takeProfit ? color.blue : color.red, textcolor=color.white)
        inLong := false
        lastExitBar := bar_index
        if showBoxes
            box.delete(tradeBox)

if inShort
    if close <= takeProfit or close >= stopLoss
        label.new(bar_index, close <= takeProfit ? low : high, close <= takeProfit ? "TP Hit" : "SL Hit", style=close <= takeProfit ? label.style_label_up : label.style_label_up, color=close <= takeProfit ? color.blue : color.red, textcolor=color.white)
        inShort := false
        lastExitBar := bar_index
        if showBoxes
            box.delete(tradeBox)
