//@version=6
indicator("Gold Edge Composite - Hedge Style", shorttitle="GEC Gold", overlay=false, precision=2)

// ───── Inputs ─────
fastEmaLen   = input.int(9,   "Fast EMA", group="Momentum")
slowEmaLen   = input.int(21,  "Slow EMA", group="Momentum")
rsiLen       = input.int(14,  "RSI Length", group="Momentum")
rsiHigh      = input.int(70,  "RSI High", group="Momentum")
rsiLow       = input.int(30,  "RSI Low", group="Momentum")
macdFast     = input.int(12,  "MACD Fast", group="Momentum")
macdSlow     = input.int(26,  "MACD Slow", group="Momentum")
macdSigLen   = input.int(9,   "MACD Signal", group="Momentum")
atrLen       = input.int(14,  "ATR Volatility", group="Filters")
dxyLen       = input.int(20,  "DXY Correlation Len", group="Intermarket")
dxySym       = input.string("TVC:DXY", "DXY Ticker", group="Intermarket")
strongLvl    = input.float(0.55, "Strong Signal >", group="Display", step=0.05)
mildLvl      = input.float(0.15, "Mild Signal >", group="Display", step=0.05)
showIcons    = input.bool(true, "Show Strong Signal Icons")
showBars     = input.bool(true, "Color Price Bars")
showBg       = input.bool(true, "Background Regime Fill")

// ───── Calculations ─────
emaF = ta.ema(close, fastEmaLen)
emaS = ta.ema(close, slowEmaLen)
emaDir = emaF > emaS ? 1 : emaF < emaS ? -1 : 0

rsi = ta.rsi(close, rsiLen)
rsiDir = rsi < rsiLow ? 1 : rsi > rsiHigh ? -1 : 0

[macdL, macdSig, macdHist] = ta.macd(close, macdFast, macdSlow, macdSigLen)
macdDir = macdHist > 0 ? 1 : macdHist < 0 ? -1 : 0

atr = ta.atr(atrLen)
volScale = 1 / math.max(0.001, 1 + atr/close)   // dampen in high vol

dxy = request.security(dxySym, timeframe.period, close, ignore_invalid_symbol=true)
corr = ta.correlation(close, dxy, dxyLen)
dxyDir = na(corr) ? 0 : corr > 0 ? -1 : 1

// Composite (60% technical momentum + 20% DXY inverse + 20% vol adjustment)
tech = (emaDir + rsiDir + macdDir) / 3.0
composite = (0.6 * tech + 0.2 * dxyDir) * volScale
score = math.max(-1.0, math.min(1.0, composite))

// ───── Signal Text & Color ─────
string sig = switch
    score > strongLvl  => "Strong Buy"
    score > mildLvl    => "Buy"
    score < -strongLvl => "Strong Sell"
    score < -mildLvl   => "Sell"
    => "Neutral"

color sigCol = switch sig
    "Strong Buy"  => color.new(color.lime, 0)
    "Buy"         => color.new(color.green, 20)
    "Strong Sell" => color.new(color.maroon, 0)
    "Sell"        => color.new(color.red, 20)
    => color.gray

// ───── Plots ─────
plot(score, "Edge Score", color = score >= 0 ? color.new(color.green, 30) : color.new(color.red, 30), style=plot.style_columns, linewidth=3)
plot(0, "Zero", color=color.new(color.gray, 70), linewidth=1)

hline(strongLvl,  "Strong", color=color.new(color.green, 60), linestyle=hline.style_dotted)
hline(mildLvl,    "Mild Buy", color=color.new(color.green, 80), linestyle=hline.style_dotted)
hline(-mildLvl,   "Mild Sell", color=color.new(color.red, 80), linestyle=hline.style_dotted)
hline(-strongLvl, "Strong Sell", color=color.new(color.red, 60), linestyle=hline.style_dotted)

// Background regime fill
bgcolor(showBg ? color.new(sigCol, 90) : na, title="Regime Fill")

// Icons on strong signal changes
plotshape(showIcons and score > strongLvl and score[1] <= strongLvl, "Strong Buy", shape.triangleup, location.bottom, color.lime, size=size.small)
plotshape(showIcons and score < -strongLvl and score[1] >= -strongLvl, "Strong Sell", shape.triangledown, location.top, color.maroon, size=size.small)

// Bar coloring
barcolor(showBars ? sigCol : na)
