//@version=6
indicator(title="GCM Aether Market Structural Pulse", shorttitle="GCM AMSP", overlay=true, max_lines_count=500, max_labels_count=500)

// ==========================================
// 1. SETTINGS & INPUTS
// ==========================================
grp_core    = "Core Analysis"
bbLength    = input.int(20, "BB Length", group=grp_core)
bbMult      = input.float(2.0, "BB StdDev", group=grp_core)
src         = input(close, "Source", group=grp_core)
bgTransp    = input.int(60, "Cloud Transparency", group=grp_core)

grp_flip    = "Trend Flip (Supertrend)"
tf_atr      = input.int(10, "Trend Flip ATR Length", group=grp_flip)
tf_mult     = input.float(0.25, "Trend Flip Factor", group=grp_flip)
show_turbo  = input.bool(false, "Show Turbo Line", group=grp_flip)
show_barcol = input.bool(true, "Color Bars based on Trend Flip", group=grp_flip)

grp_stc     = "Super Trend Cloud (STC)"
show_stc    = input.bool(true, "Show STC Cloud", group=grp_stc)
stc_atr     = input.int(10, "STC ATR Length", group=grp_stc)
stc_mult    = input.float(2.0, "STC Factor", group=grp_stc)

grp_struc   = "Market Structure (Signal Flow)"
show_struc  = input.bool(true, "Show Seamless Trend Projector", group=grp_struc)
len_scalp   = input.int(7, "Scalper Length (HMA)", group=grp_struc)

grp_sr      = "S/R Settings"
pivotLen    = input.int(10, "Pivot Lookback", group=grp_sr)
extLen      = 5 

grp_alert   = "Alert Configuration"
use_sniper  = input.bool(true, "Alert: Sniper Entries", group=grp_alert)

// ==========================================
// 2. CALCULATIONS ENGINE
// ==========================================

var line struct_line = na 

// --- CORE INDICATORS ---
basis       = ta.sma(src, bbLength), dev = bbMult * ta.stdev(src, bbLength)
upper       = basis + dev, lower = basis - dev
almaLine    = ta.alma(src, 9, 0.85, 6)

// --- STC & TREND FLIP (TURBO) ---
[stc_val, stc_dir] = ta.supertrend(stc_mult, stc_atr)
[turbo_val, tf_dir] = ta.supertrend(tf_mult, tf_atr)

// --- SCALPER ENGINE ---
scalp_val = ta.hma(close, len_scalp)
bool scalp_turn_up = ta.crossover(scalp_val, scalp_val[1])
bool scalp_turn_dn = ta.crossunder(scalp_val, scalp_val[1])
var int active_state = 0 

if barstate.isconfirmed
    if scalp_turn_up
        active_state := 1
    if scalp_turn_dn
        active_state := -1

// --- SUPPORT & RESISTANCE ---
ph = ta.pivothigh(high, pivotLen, pivotLen)
pl = ta.pivotlow(low, pivotLen, pivotLen)
var line resL = na, var line supL = na
var label resLbl = na, var label supLbl = na
var float resP = na, var float supP = na
var bool resBroken = false, var bool supBroken = false
c_res = #ff0000, c_sup = #12e49e

if not na(ph)
    line.delete(resL), label.delete(resLbl)
    resP := ph, resBroken := false
    resL := line.new(bar_index-pivotLen, ph, bar_index + extLen, ph, color=color.new(c_res, 30), width=3)
    resLbl := label.new(bar_index + extLen, ph, "RES (" + str.tostring(ph, format.mintick) + ")", color=color.new(color.black, 100), textcolor=c_res, style=label.style_label_left, size=size.small)

if not na(pl)
    line.delete(supL), label.delete(supLbl)
    supP := pl, supBroken := false
    supL := line.new(bar_index-pivotLen, pl, bar_index + extLen, pl, color=color.new(c_sup, 30), width=3)
    supLbl := label.new(bar_index + extLen, pl, "SUP (" + str.tostring(pl, format.mintick) + ")", color=color.new(color.black, 100), textcolor=c_sup, style=label.style_label_left, size=size.small)

if not na(resL) and high > resP and not resBroken
    resBroken := true
    line.set_style(resL, line.style_dotted)

if not na(supL) and low < supP and not supBroken
    supBroken := true
    line.set_style(supL, line.style_dotted)

if not na(resL) 
    line.set_x2(resL, bar_index + extLen), label.set_x(resLbl, bar_index + extLen)
if not na(supL) 
    line.set_x2(supL, bar_index + extLen), label.set_x(supLbl, bar_index + extLen)

// --- SNIPER LOGIC ---
atr_snipe = ta.atr(10)
var float upT = na, var float dnT = na
upT := close[1] > nz(upT[1]) ? math.max(hlc3 - (1.5 * atr_snipe), nz(upT[1])) : hlc3 - (1.5 * atr_snipe)
dnT := close[1] < nz(dnT[1]) ? math.min(hlc3 + (1.5 * atr_snipe), nz(dnT[1])) : hlc3 + (1.5 * atr_snipe)
sig_buy  = ta.crossover(close, nz(dnT[1]))
sig_sell = ta.crossunder(close, nz(upT[1]))

// ==========================================
// 3. PLOTTING & VISUALS
// ==========================================
bar_col = tf_dir < 0 ? #12e49e : #ff0000
barcolor(show_barcol ? bar_col : na)

plot(show_turbo ? turbo_val : na, color=bar_col, linewidth=1, title="Turbo Line", style=plot.style_linebr)

stc_p1 = plot(stc_val, color=color.new(color.gray, 100), display=display.none)
stc_p2 = plot(close, color=color.new(color.gray, 100), display=display.none)
fill(stc_p1, stc_p2, color = show_stc ? (stc_dir < 0 ? color.new(#12e49e, 82) : color.new(#ff0000, 82)) : na, title="STC Cloud Fill")

// Structure Line Projector (Restricted length)
if ta.change(active_state) != 0 and show_struc
    line.delete(struct_line)
    if active_state == 1
        struct_line := line.new(bar_index-1, low[1], bar_index + 5, low, width=1, style=line.style_dashed, color=#2dff00)
    if active_state == -1
        struct_line := line.new(bar_index-1, high[1], bar_index + 5, high, width=1, style=line.style_dashed, color=#ff0040)

if show_struc and not na(struct_line)
    bool freeze_condition = (active_state == 1 and scalp_turn_dn) or (active_state == -1 and scalp_turn_up)
    if freeze_condition
        line.set_xy2(struct_line, bar_index + 4, (active_state == 1) ? low[1] : high[1])
    else
        line.set_xy2(struct_line, bar_index + 5, (active_state == 1) ? low : high)

p_alma = plot(almaLine, color=color.new(color.gray, 100), display=display.none)
p_u    = plot(upper, color=color.new(#F23645, 80))
p_l    = plot(lower, color=color.new(#089981, 80))
fill(p_u, p_alma, upper, almaLine, color.new(#F23645, bgTransp), color.new(#F23645, 100))
fill(p_l, p_alma, lower, almaLine, color.new(#089981, bgTransp), color.new(#089981, 100))

plotshape(ta.change(tf_dir) < 0, "Flip Up", shape.triangleup, location.belowbar, #12e49e, size=size.tiny)
plotshape(ta.change(tf_dir) > 0, "Flip Down", shape.triangledown, location.abovebar, #ff0000, size=size.tiny)
plotshape(sig_buy, "Sniper Buy", shape.circle, location.belowbar, #FFD700, size=size.tiny)
plotshape(sig_sell, "Sniper Sell", shape.circle, location.abovebar, #FFD700, size=size.tiny)

// ==========================================
// 4. ALERT ENGINE
// ==========================================
if use_sniper and sig_buy
    alert("Sniper BUY | Price: " + str.tostring(close, format.mintick), alert.freq_once_per_bar_close)
if use_sniper and sig_sell
    alert("Sniper SELL | Price: " + str.tostring(close, format.mintick), alert.freq_once_per_bar_close)
