//@version=6
strategy('HalfTrend + Hull (Pure Arrow Mode)', overlay = true, initial_capital = 100000)

// ==========================================
// 1. 回測時間設定
// ==========================================
backtest_year = input.int(title = '回測年份', defval = 2023)
backtest_month = input.int(title = '回測月份', defval = 1)
backtest_date = input.int(title = '回測日期', defval = 1)
backtest_start_time = timestamp(backtest_year, backtest_month, backtest_date, 0, 0, 0)

// ==========================================
// 2. HalfTrend 核心運算
// ==========================================
amplitude = input.int(title = 'HT Amplitude', defval = 2)
channelDeviation = input.float(title = 'HT Deviation', defval = 2)

var int trend = 0, var int nextTrend = 0
var float maxLowPrice = nz(low[1], low), var float minHighPrice = nz(high[1], high)
var float up = 0.0, var float down = 0.0
float arrowUp = na, float arrowDown = na

atr2 = ta.atr(100) / 2
dev = channelDeviation * atr2
highPrice = high[math.abs(ta.highestbars(amplitude))]
lowPrice = low[math.abs(ta.lowestbars(amplitude))]

if nextTrend == 1
    maxLowPrice := math.max(lowPrice, maxLowPrice)
    if ta.sma(high, amplitude) < maxLowPrice and close < nz(low[1], low)
        trend := 1, nextTrend := 0, minHighPrice := highPrice
else
    minHighPrice := math.min(highPrice, minHighPrice)
    if ta.sma(low, amplitude) > minHighPrice and close > nz(high[1], high)
        trend := 0, nextTrend := 1, maxLowPrice := lowPrice

if trend == 0
    up := na(trend[1]) or trend[1] != 0 ? (na(down[1]) ? down : down[1]) : (na(up[1]) ? maxLowPrice : math.max(maxLowPrice, up[1]))
    arrowUp := (not na(trend[1]) and trend[1] != 0) ? up - atr2 : na
else
    down := na(trend[1]) or trend[1] != 1 ? (na(up[1]) ? up : up[1]) : (na(down[1]) ? minHighPrice : math.min(minHighPrice, down[1]))
    arrowDown := (not na(trend[1]) and trend[1] != 1) ? down + atr2 : na

buySignal = not na(arrowUp) and trend == 0 and trend[1] == 1
sellSignal = not na(arrowDown) and trend == 1 and trend[1] == 0

// ==========================================
// 3. Hull Suite 通道與收斂邏輯
// ==========================================
hull_length = input.int(55, title = 'Hull Length')
HMA(_src, _len) => ta.wma(2 * ta.wma(_src, _len / 2) - ta.wma(_src, _len), math.round(math.sqrt(_len)))

MHULL = HMA(close, hull_length)
SHULL = MHULL[2]

isHullGreen = MHULL > SHULL
isHullRed   = not isHullGreen

hullGap = math.abs(MHULL - SHULL)
isConverging = hullGap < hullGap[1] and hullGap[1] < hullGap[2]

// ==========================================
// 4. 進場與出場條件定義
// ==========================================
entry_2 = buySignal and isHullGreen                // 共振買入 (優先級高)
entry_3 = buySignal and isHullRed and isConverging  // 收斂進場 (優先級高)
entry_1 = buySignal and not entry_2 and not entry_3 // 藍色多頭 (普通)

exit_2 = sellSignal and isHullRed                  // 共振賣出 (優先級高)
exit_1 = sellSignal and not exit_2                 // 紅色平倉 (普通)

longcondition = buySignal

// ==========================================
// 5. 視覺化繪圖 (純箭頭模式，無文字)
// ==========================================
// A. 指標線條與通道
hullLineColor = isHullGreen ? #00ff00 : #ff0000
hullFillColor = isHullGreen ? color.new(#00ff00, 90) : color.new(#ff0000, 90)

plot(trend == 0 ? up : down, title = 'HT Line', linewidth = 2, color = trend == 0 ? color.blue : color.red)
hPlot1 = plot(MHULL, title = 'MHULL', color = hullLineColor, linewidth = 1)
hPlot2 = plot(SHULL, title = 'SHULL', color = hullLineColor, linewidth = 1)
fill(hPlot1, hPlot2, title = 'Hull Band Filler', color = hullFillColor)

// B. 進場箭頭 (下方)
// 1. 藍色多頭建倉 (藍色箭頭)
plotshape(entry_1, title="藍色多頭建倉", style=shape.triangleup, location=location.belowbar, color=color.blue, size=size.small)
// 2. 共振買入 (綠色箭頭)
plotshape(entry_2, title="共振買入", style=shape.triangleup, location=location.belowbar, color=#00ff00, size=size.small)
// 3. 收斂進場 (紫色箭頭)
plotshape(entry_3, title="收斂進場", style=shape.triangleup, location=location.belowbar, color=#9b59b6, size=size.small)

// C. 出場箭頭 (上方)
// 1. 紅色訊號平倉 (紅色箭頭)
plotshape(exit_1, title="紅色訊號平倉", style=shape.triangledown, location=location.abovebar, color=color.red, size=size.small)
// 2. 共振賣出 (橘色箭頭)
plotshape(exit_2, title="共振賣出", style=shape.triangledown, location=location.abovebar, color=color.orange, size=size.small)

// ==========================================
// 6. 策略執行
// ==========================================
if time >= backtest_start_time
    if buySignal
        msg = entry_2 ? "共振買入" : entry_3 ? "收斂進場" : "藍色建倉"
        strategy.entry('Long', strategy.long, comment = msg)
    
    strategy.exit('SL', 'Long', stop = 0.94 * strategy.position_avg_price, comment = '損6%')
    
    if sellSignal
        exit_msg = exit_2 ? "共振賣出" : "紅色平倉"
        strategy.close('Long', comment = exit_msg)
