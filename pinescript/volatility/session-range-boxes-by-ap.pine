//@version=6
indicator("Session Range Boxes by AP", overlay=true, precision = 0)

// ─────────────────────────────
// GLOBAL SETTINGS
// ─────────────────────────────
sessionTz = input.string("America/New_York", "Session Timezone", tooltip = "Enter your IANA/Olson Time Zone Identifier for your local timezone.\nExample: America/New_York, Europe/Bratislava, Europe/London, Asia/Tokyo.\nFull list: https://en.wikipedia.org/wiki/List_of_tz_database_time_zones", group="Global Settings")
autoDelete = input.bool(false, "Auto Delete Old Session Boxes", tooltip="If enabled, previous session boxes will be removed when a new session starts.", group="Global Settings")
keepLast = input.int(1, "Keep Last N Sessions", minval=1, tooltip="Number of most recent session boxes to keep. Only applies if Auto Delete is enabled.", group="Global Settings")     
showBorders = input.bool(true, "Show Borders", tooltip = "Toggle to show/hide borders for all session boxes", group="Global Settings")
showLabels  = input.bool(true, "Show Labels", tooltip = "Toggle to show/hide labels for all sessions on the chart", group="Global Settings")


// ─────────────────────────────
// HELPER FUNCTION
// ─────────────────────────────
inSession(sessionStr) =>
    not na(time(timeframe.period, sessionStr))

drawSession(_show, _name, _sessionStr, _fill, _border) =>
    // ───────── Persistent Storage ─────────
    var float sHigh = na
    var float sLow  = na
    var box   currentBox   = na
    var label currentLabel = na
    var box[]   sBoxes  = array.new_box()
    var label[] sLabels = array.new_label()

    // ───────── Session Detection ─────────
    // If session is disabled, force all session booleans to false
    inSess  = _show and inSession(_sessionStr)
    newSess = _show and inSess and not inSess[1]
    endSess = _show and not inSess and inSess[1]

    finalBorder = showBorders ? _border : na

    // ───────── New Session Starts ─────────
    if newSess
        sHigh := high
        sLow  := low

        currentBox := box.new(
            left = time,
            top = high,
            right = time,
            bottom = low,
            xloc = xloc.bar_time,
            bgcolor = _fill,
            border_color = finalBorder,
            border_width = 1
        )
        array.push(sBoxes, currentBox)

        if showLabels
            currentLabel := label.new(
                x = time,
                y = high,
                text = _name,
                xloc = xloc.bar_time,
                style = label.style_label_down,
                textcolor = color.white,
                color = _border
            )
            array.push(sLabels, currentLabel)

        // Auto-delete logic
        if autoDelete
            while array.size(sBoxes) > keepLast
                box.delete(array.shift(sBoxes))
            while array.size(sLabels) > keepLast
                label.delete(array.shift(sLabels))
                

    // ───────── During Session ─────────
    if inSess
        sHigh := math.max(sHigh, high)
        sLow  := math.min(sLow, low)

        if not na(currentBox)
            box.set_right(currentBox, time)
            box.set_top(currentBox, sHigh)
            box.set_bottom(currentBox, sLow)

        if showLabels and not na(currentLabel)
            label.set_y(currentLabel, sHigh)

    // ───────── Session Ends ─────────
    if endSess
        sHigh := na
        sLow  := na
        currentBox := na
        currentLabel := na

    0


// ─────────────────────────────
// USER SESSION INPUTS
// ─────────────────────────────
s1_on      = input.bool(true, "Show Session 1", group="Session 1")
s1_name    = input.string("Asia", "Session 1 Name", group="Session 1")
s1_sess    = input.session("1900-0100", "Session 1 Time", tooltip = "Set the start and end time for this session in 24h format.\nTimes are relative to the selected Session Timezone above (e.g., America/New_York).\nThe session will automatically adjust to your chart's timezone.", group="Session 1")
s1_fill    = input.color(color.new(color.blue, 85), "Background", group="Session 1")
s1_border  = input.color(color.blue, "Border", group="Session 1")

s2_on      = input.bool(true, "Show Session 2", group="Session 2")
s2_name    = input.string("Pre-London", "Session 2 Name", group="Session 2")
s2_sess    = input.session("0100-0200", "Session 2 Time", tooltip = "Set the start and end time for this session in 24h format.\nTimes are relative to the selected Session Timezone above (e.g., America/New_York).\nThe session will automatically adjust to your chart's timezone.", group="Session 2")
s2_fill    = input.color(color.new(color.fuchsia, 85), "Background", group="Session 2")
s2_border  = input.color(color.fuchsia, "Border", group="Session 2")

s3_on      = input.bool(true, "Show Session 3", group="Session 3")
s3_name    = input.string("London Open", "Session 3 Name", group="Session 3")
s3_sess    = input.session("0200-0400", "Session 3 Time", tooltip = "Set the start and end time for this session in 24h format.\nTimes are relative to the selected Session Timezone above (e.g., America/New_York).\nThe session will automatically adjust to your chart's timezone.", group="Session 3")
s3_fill    = input.color(color.new(color.green, 85), "Background", group="Session 3")
s3_border  = input.color(color.green, "Border", group="Session 3")

s4_on      = input.bool(true, "Show Session 4", group="Session 4")
s4_name    = input.string("NY Open", "Session 4 Name", group="Session 4")
s4_sess    = input.session("0830-1100", "Session 4 Time", tooltip = "Set the start and end time for this session in 24h format.\nTimes are relative to the selected Session Timezone above (e.g., America/New_York).\nThe session will automatically adjust to your chart's timezone.", group="Session 4")
s4_fill    = input.color(color.new(color.orange, 85), "Background", group="Session 4")
s4_border  = input.color(color.orange, "Border", group="Session 4")

s5_on      = input.bool(true, "Show Session 5", group="Session 5")
s5_name    = input.string("NY Afternoon", "Session 5 Name", group="Session 5")
s5_sess    = input.session("1200-1430", "Session 5 Time", tooltip = "Set the start and end time for this session in 24h format.\nTimes are relative to the selected Session Timezone above (e.g., America/New_York).\nThe session will automatically adjust to your chart's timezone.", group="Session 5")
s5_fill    = input.color(color.new(color.orange, 85), "Background", group="Session 5")
s5_border  = input.color(color.orange, "Border", group="Session 5")

s6_on      = input.bool(true, "Show Session 6", group="Session 6")
s6_name    = input.string("Topstep Exit", "Session 6 Name", group="Session 6")
s6_sess    = input.session("1450-1500", "Session 6 Time", tooltip = "Set the start and end time for this session in 24h format.\nTimes are relative to the selected Session Timezone above (e.g., America/New_York).\nThe session will automatically adjust to your chart's timezone.", group="Session 6")
s6_fill    = input.color(color.new(color.red, 85), "Background", group="Session 6")
s6_border  = input.color(color.red, "Border", group="Session 6")

// ─────────────────────────────
// DRAW SESSIONS
// ─────────────────────────────
drawSession(s1_on, s1_name, s1_sess, s1_fill, s1_border)
drawSession(s2_on, s2_name, s2_sess, s2_fill, s2_border)
drawSession(s3_on, s3_name, s3_sess, s3_fill, s3_border)
drawSession(s4_on, s4_name, s4_sess, s4_fill, s4_border)
drawSession(s5_on, s5_name, s5_sess, s5_fill, s5_border)
drawSession(s6_on, s6_name, s6_sess, s6_fill, s6_border)
