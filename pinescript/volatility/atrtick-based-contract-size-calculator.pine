//@version=5
indicator("ATR/Tick Based Contract Size Calculator", overlay=false, format=format.price, precision=2)

// =======================================================
// INPUTS
// =======================================================

maxLoss = input.float(200, "Max Loss per Trade ($)", minval=10, step=10)
riskMode = input.string("ATR", "Risk Calculation Mode", options=["ATR", "Ticks"])
atrPeriod = input.int(14, "ATR Period")
atrMultiple = input.float(1.0, "ATR Multiple", minval=0.1, step=0.1)
stopTicks = input.int(10, "Stop Loss (Ticks)", minval=1)
manualDollarPerPoint = input.float(0.0, "Override $ per Point (0 = auto)", step=0.01)

// Layout & Position
layoutVertical = input.bool(true, "Vertical Layout? (true = vertical, false = horizontal)")
positionOption = input.string("top_right", "Table Position", options=["top_left","top_center","top_right","bottom_left","bottom_center","bottom_right"])

// Row Colors & Text
modeBgColor = input.color(color.new(color.orange, 80), "Risk Mode Background Color")
modeOpacity = input.int(80, "Risk Mode Opacity", minval=0, maxval=100)
modeTextColor = input.color(color.white, "Risk Mode Text Color")

atrBgColor = input.color(color.new(color.blue, 80), "ATR Background Color")
atrOpacity = input.int(80, "ATR Opacity", minval=0, maxval=100)
atrTextColor = input.color(color.white, "ATR Text Color")

dppBgColor = input.color(color.new(color.blue, 80), "$ per Point Background Color")
dppOpacity = input.int(80, "$ per Point Opacity", minval=0, maxval=100)
dppTextColor = input.color(color.white, "$ per Point Text Color")

maxLossBgColor = input.color(color.new(color.blue, 80), "Max Loss Background Color")
maxLossOpacity = input.int(80, "Max Loss Opacity", minval=0, maxval=100)
maxLossTextColor = input.color(color.white, "Max Loss Text Color")

contractsBgColor = input.color(color.new(color.teal, 80), "Contracts Background Color")
contractsOpacity = input.int(80, "Contracts Opacity", minval=0, maxval=100)
contractsTextColor = input.color(color.white, "Contracts Text Color")

// =======================================================
// CALCULATIONS
// =======================================================

atr = ta.atr(atrPeriod)

symbolShort = syminfo.ticker
float dollarPerPoint = na

if manualDollarPerPoint != 0
    dollarPerPoint := manualDollarPerPoint
else
    if str.contains(symbolShort, "MNQ")
        dollarPerPoint := 2
    else if str.contains(symbolShort, "NQ")
        dollarPerPoint := 20
    else if str.contains(symbolShort, "MES")
        dollarPerPoint := 5
    else if str.contains(symbolShort, "ES")
        dollarPerPoint := 50
    else if str.contains(symbolShort, "MYM")
        dollarPerPoint := 0.5
    else if str.contains(symbolShort, "YM")
        dollarPerPoint := 5
    else if str.contains(symbolShort, "M2K")
        dollarPerPoint := 5
    else if str.contains(symbolShort, "RTY")
        dollarPerPoint := 50
    else if str.contains(symbolShort, "CL")
        dollarPerPoint := 1000
    else if str.contains(symbolShort, "GC")
        dollarPerPoint := 100

tickValue = syminfo.mintick * dollarPerPoint

float riskPerContract = na
if riskMode == "ATR"
    riskPerContract := atr * atrMultiple * dollarPerPoint
else
    riskPerContract := stopTicks * tickValue

float contracts = na
if not na(riskPerContract) and riskPerContract > 0
    contracts := math.floor(maxLoss / riskPerContract)

// =======================================================
// TABLE
// =======================================================

rows = layoutVertical ? 7 : 2
cols = layoutVertical ? 2 : 6

var table dash = na
if barstate.isfirst
    pos = switch positionOption
        "top_left" => position.top_left
        "top_center" => position.top_center
        "top_right" => position.top_right
        "bottom_left" => position.bottom_left
        "bottom_center" => position.bottom_center
        "bottom_right" => position.bottom_right
        => position.top_right
    dash := table.new(pos, cols, rows, border_width=1)

// =======================================================
// DISPLAY
// =======================================================

if barstate.islast
    if layoutVertical
        table.cell(dash, 0, 0, "Risk Mode", bgcolor=color.new(modeBgColor, modeOpacity), text_color=modeTextColor)
        table.cell(dash, 1, 0, riskMode, text_color=modeTextColor)

        table.cell(dash, 0, 1, "ATR (" + str.tostring(atrPeriod) + ")", bgcolor=color.new(atrBgColor, atrOpacity), text_color=atrTextColor)
        table.cell(dash, 1, 1, str.tostring(atr, format.mintick), text_color=atrTextColor)

        table.cell(dash, 0, 2, "ATR Multiple", bgcolor=color.new(atrBgColor, atrOpacity), text_color=atrTextColor)
        table.cell(dash, 1, 2, str.tostring(atrMultiple), text_color=atrTextColor)

        table.cell(dash, 0, 3, "Stop Loss (Ticks)", bgcolor=color.new(atrBgColor, atrOpacity), text_color=atrTextColor)
        table.cell(dash, 1, 3, str.tostring(stopTicks), text_color=atrTextColor)

        table.cell(dash, 0, 4, "$ per Point", bgcolor=color.new(dppBgColor, dppOpacity), text_color=dppTextColor)
        table.cell(dash, 1, 4, str.tostring(dollarPerPoint), text_color=dppTextColor)

        table.cell(dash, 0, 5, "Max Loss ($)", bgcolor=color.new(maxLossBgColor, maxLossOpacity), text_color=maxLossTextColor)
        table.cell(dash, 1, 5, str.tostring(maxLoss), text_color=maxLossTextColor)

        table.cell(dash, 0, 6, "Contracts", bgcolor=color.new(contractsBgColor, contractsOpacity), text_color=contractsTextColor)
        table.cell(dash, 1, 6, str.tostring(contracts), text_color=contractsTextColor)
