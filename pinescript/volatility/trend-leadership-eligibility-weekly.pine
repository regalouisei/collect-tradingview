//@version=6
// Â© 2026 Ibotrade
// Trend Leadership Eligibility Weekly
// Weekly market-context filter for evaluating trend structure
// and relative strength versus a benchmark.
//
// Research / screening tool only.
// Does not generate buy or sell signals.
// Educational use only.

indicator("Trend Leadership Eligibility Weekly", shorttitle="TLE", overlay=true)


// =====================================================================
// INPUTS
// =====================================================================
groupCore = "Leadership Logic"
benchmarkSymbol = input.symbol("SPY", "Benchmark Source", group=groupCore)
lookbackW       = input.int(30, "Structural Lookback (Weeks)", minval=10, group=groupCore)

groupVis  = "UI/UX Settings"
// Updated options to include requested locations
panelLoc  = input.string("Top Right", "Panel Position", options=["Top Right", "Bottom Right", "Top Left", "Bottom Left", "Top Center", "Bottom Center"], group=groupVis)
panelSize = input.string("Normal", "Text Size", options=["Small", "Normal", "Large"], group=groupVis)

// =====================================================================
// MTF STRUCTURAL TUPLE (Optimized Performance)
// =====================================================================
[wClose, wHigh, wLow, wVol, bClose] = request.security(syminfo.tickerid, "W", [close, high, low, volume, request.security(benchmarkSymbol, "W", close)], lookahead=barmerge.lookahead_off)

// 1. RELATIVE STRENGTH (RS) TREND
rsLine    = wClose / math.max(bClose, 0.001)
rsFast    = ta.sma(rsLine, 10)
rsSlow    = ta.sma(rsLine, 30)
reqRS     = rsFast > rsSlow and rsSlow > rsSlow[8]

// 2. VARIANCE-ADJUSTED ORDERLINESS
atrW      = ta.atr(14)
trendSmoothness = ta.stdev(wClose, 20) / math.max(atrW, 0.001)
reqOrderly = trendSmoothness < 2.5 

// 3. STRUCTURE TIGHTNESS REGIME
rangeW    = (wHigh - wLow) / math.max(wClose, 0.001)
rHi       = ta.highest(rangeW, 20)
rLo       = ta.lowest(rangeW, 20)
rPos      = (rangeW - rLo) / math.max(rHi - rLo, 1e-10)
reqStructure = rPos <= 0.65

// =====================================================================
// ELIGIBILITY COMPOSITE
// =====================================================================
eligible = reqRS and reqOrderly and reqStructure

// Duration Logic (Non-Repainting)
var int eligStart = na
if eligible and not eligible[1]
    eligStart := bar_index
else if not eligible
    eligStart := na

eligDuration = not na(eligStart) ? (bar_index - eligStart) : 0

// =====================================================================
// ALERTS (Added for Eligibility Monitoring)
// =====================================================================
if eligible and not eligible[1]
    alert("ELIGIBILITY FOUND: " + syminfo.ticker + " is now structurally eligible.", alert.freq_once_per_bar_close)

if not eligible and eligible[1]
    alert("ELIGIBILITY LOST: " + syminfo.ticker + " no longer meets structural criteria.", alert.freq_once_per_bar_close)

// =====================================================================
// PANEL RENDER (Confirmed Bars Only)
// =====================================================================
if barstate.islast
    // Updated position logic to handle new inputs
    pos = panelLoc == "Top Right" ? position.top_right : 
          panelLoc == "Bottom Right" ? position.bottom_right : 
          panelLoc == "Top Left" ? position.top_left : 
          panelLoc == "Bottom Left" ? position.bottom_left : 
          panelLoc == "Top Center" ? position.top_center : 
          position.bottom_center

    txt = panelSize == "Small" ? size.small : panelSize == "Large" ? size.large : size.normal
    
    var table panel = table.new(pos, 1, 3, border_width=1, frame_color=color.gray)
    
    table.cell(panel, 0, 0, eligible ? "ELIGIBLE" : "NOT ELIGIBLE", bgcolor=eligible ? color.new(color.lime, 20) : color.new(color.gray, 20), text_color=color.white, text_size=txt)
    table.cell(panel, 0, 1, "Duration: " + str.tostring(eligDuration) + " bars", text_color=color.white, text_size=txt)
    table.cell(panel, 0, 2, "RS: " + (reqRS ? "PASS" : "FAIL") + " | ORD: " + (reqOrderly ? "PASS" : "FAIL"), text_color=color.gray, text_size=size.tiny)
