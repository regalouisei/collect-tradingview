//@version=6
indicator(title="Average True Range V2", shorttitle="ATR V2", overlay=false)

length = input.int(title="Length", defval=14, minval=1)
smoothing = input.string(title="Smoothing", defval="RMA", options=["RMA", "SMA", "EMA", "WMA"])

// New: Wait for current candle close
waitClose = input.bool(true, "Wait for period end before updating")

// New: Flip scale (multiply ATR by -1)
flipScale = input.bool(false, "Flip scale (invert ATR)")

// New: Horizontal line options
showHLine = input.bool(true, "Show current value horizontal line")
hLineColor = input.color(color.new(#B71C1C, 0), "Horizontal line color")
hLineStyle = input.string("Solid", "Horizontal line style", options=["Solid", "Dashed", "Dotted"])
hLineWidth = input.int(1, "Horizontal line width", minval=1, maxval=4)

// New: 3-day extreme marker options
show3DayLow = input.bool(true, "Show 3-day low marker")
low3DayColor = input.color(color.new(#FF9800, 0), "3-day low color")
low3DayStyle = input.string("Circle", "3-day low style", options=["Circle", "Triangle Up", "Triangle Down", "Square", "Diamond", "Cross", "X Cross"])

show3DayHigh = input.bool(true, "Show 3-day high marker")
high3DayColor = input.color(color.new(#4CAF50, 0), "3-day high color")
high3DayStyle = input.string("Circle", "3-day high style", options=["Circle", "Triangle Up", "Triangle Down", "Square", "Diamond", "Cross", "X Cross"])

// New: 7-day extreme marker options
show7DayLow = input.bool(true, "Show 7-day low marker")
low7DayColor = input.color(color.new(#FF5722, 0), "7-day low color")
low7DayStyle = input.string("Circle", "7-day low style", options=["Circle", "Triangle Up", "Triangle Down", "Square", "Diamond", "Cross", "X Cross"])

show7DayHigh = input.bool(true, "Show 7-day high marker")
high7DayColor = input.color(color.new(#2196F3, 0), "7-day high color")
high7DayStyle = input.string("Circle", "7-day high style", options=["Circle", "Triangle Up", "Triangle Down", "Square", "Diamond", "Cross", "X Cross"])

ma_function(source, length) =>
    switch smoothing
        "RMA" => ta.rma(source, length)
        "SMA" => ta.sma(source, length)
        "EMA" => ta.ema(source, length)
        => ta.wma(source, length)

// ATR original calculation
raw_atr_value = ma_function(ta.tr(true), length)

// Wait for period end logic
var float atr_value = na

if waitClose
    if barstate.isconfirmed
        atr_value := raw_atr_value
else
    atr_value := raw_atr_value

// Scale flip handling
plot_val = flipScale ? -atr_value : atr_value

// Main plot
plot(plot_val, title = "ATR", color=color.new(#B71C1C, 0))

// Horizontal line function (fix: using xloc.bar_time)
hlineStyleVal = (
     hLineStyle == "Solid" ? line.style_solid :
     hLineStyle == "Dashed" ? line.style_dashed :
     line.style_dotted
)

var line hline = na

// Only process horizontal line on last bar
if showHLine and barstate.islast
    if na(hline)
        // Use current time minus large offset as start time
        var int start_time = time - 1000 * 60 * 60 * 24 * 365 * 10  // 10 years ago
        hline := line.new(start_time, plot_val, time, plot_val, 
                           xloc = xloc.bar_time,  // Explicitly specify using time coordinates
                           color = hLineColor, 
                           style = hlineStyleVal, 
                           width = hLineWidth, 
                           extend = extend.right)
    else
        // Update line endpoint and Y coordinates
        line.set_xy2(hline, time, plot_val)
        line.set_y1(hline, plot_val)
        line.set_y2(hline, plot_val)
        line.set_color(hline, hLineColor)
        line.set_style(hline, hlineStyleVal)
        line.set_width(hline, hLineWidth)

// Extreme value detection function
getShape(styleStr) => (
     styleStr == "Circle" ? shape.circle :
     styleStr == "Triangle Up" ? shape.triangleup :
     styleStr == "Triangle Down" ? shape.triangledown :
     styleStr == "Square" ? shape.square :
     styleStr == "Diamond" ? shape.diamond :
     styleStr == "Cross" ? shape.cross :
     shape.xcross
)

// Calculate extremes (using flipped values)
low3 = ta.lowest(plot_val, 3)
high3 = ta.highest(plot_val, 3)
low7 = ta.lowest(plot_val, 7)
high7 = ta.highest(plot_val, 7)

// Detect if current is extreme (only on last bar, ensuring valid range)
is3DayLow = barstate.islast and bar_index >= 2 and plot_val == low3 and low3 != high3
is3DayHigh = barstate.islast and bar_index >= 2 and plot_val == high3 and low3 != high3
is7DayLow = barstate.islast and bar_index >= 6 and plot_val == low7 and low7 != high7
is7DayHigh = barstate.islast and bar_index >= 6 and plot_val == high7 and low7 != high7

// Draw markers
plotshape(series=show3DayLow and is3DayLow, 
          title="3-day low", 
          location=location.absolute, 
          color=low3DayColor, 
          style=getShape(low3DayStyle), 
          size=size.small)

plotshape(series=show3DayHigh and is3DayHigh, 
          title="3-day high", 
          location=location.absolute, 
          color=high3DayColor, 
          style=getShape(high3DayStyle), 
          size=size.small)

plotshape(series=show7DayLow and is7DayLow, 
          title="7-day low", 
          location=location.absolute, 
          color=low7DayColor, 
          style=getShape(low7DayStyle), 
          size=size.small)

plotshape(series=show7DayHigh and is7DayHigh, 
          title="7-day high", 
          location=location.absolute, 
          color=high7DayColor, 
          style=getShape(high7DayStyle), 
          size=size.small)
