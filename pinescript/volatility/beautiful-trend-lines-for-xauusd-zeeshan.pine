//@version=6
indicator("XAUUSD Thickest Overlay — High Visibility [Zeeshan]", overlay=true, max_labels_count=200)

// Preconfigured constants
_fast = 34
_slow = 89
_swingLen = 20
_confirmBars = 0
_atrLen = 14
_volLen = 20
_rangeFactor = 0.45
_htf = "240"
_breakoutPct = 0.001
_requireHTF = false
_allowPossibleStart = true
_fadeBars = 600

// Core
fastEma = ta.ema(close, _fast)
slowEma = ta.ema(close, _slow)
atr = ta.atr(_atrLen)
atrMa = ta.sma(atr, _atrLen)
volMa = ta.sma(volume, _volLen)
slopeAbs = math.abs(fastEma - fastEma[1])

emaBull = fastEma > slowEma
emaBear = fastEma < slowEma
slopeBull = fastEma > fastEma[1]
slopeBear = fastEma < fastEma[1]
flatSlope = slopeAbs < atr * 0.1

recentHigh = ta.highest(high, _swingLen)
recentLow = ta.lowest(low, _swingLen)
structBull = close > recentLow
structBear = close < recentHigh
noStruct = not structBull and not structBear

htfFast = request.security(syminfo.tickerid, _htf, ta.ema(close, _fast))
htfSlow = request.security(syminfo.tickerid, _htf, ta.ema(close, _slow))
htfBull = htfFast > htfSlow
htfBear = htfFast < htfSlow

volExp = volume > volMa
atrExp = atr > atrMa
atrCompression = atr < atrMa * _rangeFactor
isRanging = atrCompression and flatSlope and noStruct

breakoutUp = close > recentHigh * (1 + _breakoutPct)
breakoutDown = close < recentLow * (1 - _breakoutPct)

rawBullPossible = (emaBull and slopeBull and structBull and not isRanging) or breakoutUp
rawBearPossible = (emaBear and slopeBear and structBear and not isRanging) or breakoutDown

relaxedVolAtr = volExp or atrExp
relaxedHTF = _requireHTF ? (htfBull or htfBear) : true
relaxedConfirm = relaxedVolAtr and relaxedHTF

breakoutImmediateConfirmBull = breakoutUp and (_requireHTF ? htfBull : true)
breakoutImmediateConfirmBear = breakoutDown and (_requireHTF ? htfBear : true)

barsSinceRawBullPossible = ta.barssince(rawBullPossible)
barsSinceRawBearPossible = ta.barssince(rawBearPossible)

bullConfirmed = (rawBullPossible and relaxedConfirm and barsSinceRawBullPossible <= _confirmBars) or breakoutImmediateConfirmBull
bearConfirmed = (rawBearPossible and relaxedConfirm and barsSinceRawBearPossible <= _confirmBars) or breakoutImmediateConfirmBear

bullStart = bullConfirmed or (_allowPossibleStart and rawBullPossible)
bearStart = bearConfirmed or (_allowPossibleStart and rawBearPossible)

bullEnded = (bullConfirmed or (_allowPossibleStart and rawBullPossible)) and (emaBear or slopeBear or close < recentLow or isRanging)
bearEnded = (bearConfirmed or (_allowPossibleStart and rawBearPossible)) and (emaBull or slopeBull or close > recentHigh or isRanging)

// Trend strength
baseStrength = 0.0
baseStrength += bullConfirmed or bearConfirmed ? 30.0 : 0.0
baseStrength += volExp and atrExp ? 25.0 : 0.0
baseStrength += (_requireHTF ? 20.0 : 10.0) * (htfBull or htfBear ? 1.0 : 0.0)
baseStrength += slopeAbs > atr * 0.2 ? 15.0 : 0.0
baseStrength += not isRanging ? 10.0 : 0.0
trendStrength = math.round(math.min(100.0, math.max(0.0, baseStrength)))

// Transparency mapping
transpLevel = trendStrength > 75 ? 0 : trendStrength > 50 ? 20 : trendStrength > 25 ? 40 : trendStrength > 10 ? 60 : 80

// Color decision with bull-preferred tie
isBull = (bullStart and not bearStart) or (bullStart and bearStart and trendStrength >= 50)
isBear = (bearStart and not bullStart) or (bullStart and bearStart and trendStrength < 50)
lineColor = isBull ? color.new(color.green, transpLevel) : isBear ? color.new(color.red, transpLevel) : color.new(color.gray, 80)

// Continuous base line (always visible) kept very thin and faint
plot(fastEma, title="Base EMA (continuous)", color=color.new(color.gray, 85), linewidth=1, style=plot.style_line)

// Variable-width overlays (no connectors) drawn on top with much larger widths
show_w1 = trendStrength <= 10 ? fastEma : na
show_w2 = trendStrength > 10 and trendStrength <= 25 ? fastEma : na
show_w3 = trendStrength > 25 and trendStrength <= 50 ? fastEma : na
show_w4 = trendStrength > 50 and trendStrength <= 75 ? fastEma : na
show_w5 = trendStrength > 75 ? fastEma : na

// Increased widths for high visibility
plot(show_w1, title="Trend w1", color=lineColor, linewidth=6, style=plot.style_linebr)
plot(show_w2, title="Trend w2", color=lineColor, linewidth=8, style=plot.style_linebr)
plot(show_w3, title="Trend w3", color=lineColor, linewidth=10, style=plot.style_linebr)
plot(show_w4, title="Trend w4", color=lineColor, linewidth=12, style=plot.style_linebr)
plot(show_w5, title="Trend w5", color=lineColor, linewidth=14, style=plot.style_linebr)

// Final label on close (unchanged)
fmt_time(ts) => str.tostring(ts, "yyyy-MM-dd HH:mm")
make_final_text(startTime, endTime, durationBars, startPrice, endPrice, strength) =>
    "S:" + fmt_time(startTime) + " E:" + fmt_time(endTime) + " dur:" + str.tostring(durationBars) + "b TS:" + str.tostring(strength) + " Δ:" + str.tostring(endPrice - startPrice, format.mintick)

var int segStartBar = na
var int segStartTime = na
var float segStartPrice = na
var bool segIsBull = false

if barstate.isconfirmed
    if (bullStart or bearStart) and na(segStartBar)
        segStartBar := bar_index
        segStartTime := time
        segStartPrice := fastEma
        segIsBull := isBull
    if not (bullStart or bearStart)
        segStartBar := na
        segStartTime := na
        segStartPrice := na
        segIsBull := false
    if (bullEnded or bearEnded) and not na(segStartBar)
        labelColor = segIsBull ? color.new(color.green, 0) : color.new(color.red, 0)
        label.new(bar_index, fastEma, make_final_text(segStartTime, time, bar_index - segStartBar, segStartPrice, fastEma, trendStrength), xloc=xloc.bar_index, yloc=yloc.price, style=label.style_label_down, color=labelColor, textcolor=color.white, size=size.small)
        segStartBar := na
        segStartTime := na
        segStartPrice := na
        segIsBull := false

// Diagnostic plot
plot(trendStrength, title="Trend Strength (0-100)", color=color.yellow, linewidth=2)
