//@version=5
indicator(
     title="EH StochRSI DualBB Map",
     shorttitle="EH StochRSI DualBB",
     overlay=true,
     precision=1,
     max_bars_back=500)

// ------------------------------------------------------
// Description:
// Based on LazyBear’s implementation of Stochastic RSI 
// with Ehlers Super Smoother.
// Structurally extended with Dual Bollinger Price Mapping.
//
// This version maps:
// ±50 → BB(20,4)
// ±25 → BB(20,2)
//
// Because oscillator values are projected into price space,
// divergence analysis using this mapped version is NOT recommended.
// ------------------------------------------------------

// ======================================================
// 1. FUNCTIONS
// ======================================================
PI = 3.14159265359

drop1st(src) =>
    x = float(na)
    x := na(src[1]) ? na : src
    x

xrma(src, len) =>
    sum = float(na)
    sum := (src + (len - 1) * nz(sum[1], src)) / len
    sum

xrsi(src, len) =>
    msig = nz(ta.change(src, 1), 0.0)
    up = xrma(math.max(msig, 0.0), len)
    dn = xrma(math.max(-msig, 0.0), len)
    rs = up / dn
    100.0 - 100.0 / (1.0 + rs)

EhlersSuperSmoother(src, lower) =>
    a1 = math.exp(-PI * math.sqrt(2) / lower)
    coeff2 = 2 * a1 * math.cos(math.sqrt(2) * PI / lower)
    coeff3 = -math.pow(a1, 2)
    coeff1 = (1 - coeff2 - coeff3) / 2
    filt = float(na)
    filt := nz(coeff1 * (src + nz(src[1], src)) + coeff2 * filt[1] + coeff3 * filt[2], src)
    filt

// ======================================================
// 2. INPUTS
// ======================================================
smoothK      = input.int(8, minval=1, title='K')
smoothD      = input.int(3, minval=1, title='D')
lengthRSI    = input.int(14, minval=1, title='RSI Length')
lengthStoch  = input.int(7, minval=1, title='Stochastic Length')
src          = input(close, title='Source')

// ======================================================
// 3. STOCH RSI CORE
// ======================================================
price  = math.log(drop1st(src))
rsi1   = xrsi(price, lengthRSI)
stoch  = ta.stoch(rsi1, rsi1, rsi1, lengthStoch)

sig    = EhlersSuperSmoother(stoch, smoothK)
ma     = ta.sma(sig, smoothD)

osc    = math.max(math.min(sig - 50, 50), -50)
signal = math.max(math.min(ma  - 50, 50), -50)

// ======================================================
// 4. BB 20,4
// ======================================================
basis4 = ta.sma(close, 20)
dev4   = ta.stdev(close, 20) * 4.0
upper4 = basis4 + dev4
lower4 = basis4 - dev4

plot(upper4, "BB 20,4 Upper", color=color.rgb(255, 255, 255))
plot(lower4, "BB 20,4 Lower", color=color.rgb(255, 255, 255))

// ======================================================
// 5. BB 20,2
// ======================================================
basis2 = ta.sma(close, 20)
dev2   = ta.stdev(close, 20) * 2.0
upper2 = basis2 + dev2
lower2 = basis2 - dev2

plot(upper2, "BB 20,2 Upper", color=color.yellow, style=plot.style_circles)
plot(lower2, "BB 20,2 Lower", color=color.yellow, style=plot.style_circles)

// ======================================================
// 6. PRICE MAPPING
// ======================================================
map_outer(x) =>
    basis4 + (x / 50.0) * (upper4 - basis4)

OSC_price    = math.max(math.min(map_outer(osc), upper4), lower4)
Signal_price = math.max(math.min(map_outer(signal), upper4), lower4)

trendUp   = osc >= signal
lineColor = trendUp ? color.lime : color.red

plot(OSC_price, "EH StochRSI", color=lineColor, linewidth=3)
plot(Signal_price, "EH Signal", color=color.new(color.gray, 60), linewidth=2)

// Background default OFF
bgcolor(na)
