//@version=6
indicator("Predictive VMACD Linear + Quad Proj", shorttitle="P-VMACD", overlay=false)

// Inputs (same scaling as before)
src       = input.source(close, title="Source")
fast_len  = input.int(12, "Fast Length", minval=1)
slow_len  = input.int(26, "Slow Length", minval=1)
sig_len   = input.int(9,  "Signal Length", minval=1)
reg_len   = input.int(20, "Regression Lookback", minval=2)
proj_bars = input.int(5,  "Projection Ahead (bars)", minval=1)
scale_mult = input.float(500.0, "Scale Multiplier (adjust for visibility)", minval=10.0, step=50.0)
quad_damp  = input.float(0.6, "Quadratic Damping (0.0 = no curve, 1.0 = full)", minval=0.0, maxval=1.0, step=0.1)

// Volume-weighted MACD (unchanged)
fast_vwma = ta.vwma(src, fast_len)
slow_vwma = ta.vwma(src, slow_len)
vmacd_raw = fast_vwma - slow_vwma
signal_raw = ta.ema(vmacd_raw, sig_len)

// Scaled for visibility (same as before)
vmacd  = vmacd_raw  * scale_mult
signal = signal_raw * scale_mult

// Plots (same)
plot(vmacd,  "VMACD",  color = color.blue, linewidth = 2)
plot(signal, "Signal", color = color.orange, linewidth = 1)
hline(0, "Zero", color = color.gray, linestyle = hline.style_dashed)

// Linear slope (same as original)
get_slope(series float src_series, int len) =>
    float stdev_y = ta.stdev(src_series, len)
    float stdev_x = ta.stdev(bar_index, len)
    float corr    = ta.correlation(bar_index, src_series, len)
    stdev_x != 0 ? corr * (stdev_y / stdev_x) : 0.0

slope_v = get_slope(vmacd, reg_len)
slope_s = get_slope(signal, reg_len)

// Simple curvature estimate (difference from linear fit, damped)
linreg_v = ta.linreg(vmacd, reg_len, 0)
curv_v   = (vmacd - linreg_v) * quad_damp * 2 / reg_len   // rough accel/decel

linreg_s = ta.linreg(signal, reg_len, 0)
curv_s   = (signal - linreg_s) * quad_damp * 2 / reg_len

// Quadratic projection: linear extension + curvature term * stepsÂ²
future_v = vmacd + slope_v * proj_bars + curv_v * proj_bars * proj_bars
future_s = signal + slope_s * proj_bars + curv_s * proj_bars * proj_bars

// Draw dotted projection lines (same style, now curved)
var line proj_v_line = na
var line proj_s_line = na

if barstate.islast
    if not na(proj_v_line)
        line.delete(proj_v_line[1])
    if not na(proj_s_line)
        line.delete(proj_s_line[1])
    
    proj_v_line := line.new(
        bar_index, vmacd,
        bar_index + proj_bars, future_v,
        color = color.green, width = 2, style = line.style_dotted)
    
    proj_s_line := line.new(
        bar_index, signal,
        bar_index + proj_bars, future_s,
        color = color.purple, width = 2, style = line.style_dotted)
