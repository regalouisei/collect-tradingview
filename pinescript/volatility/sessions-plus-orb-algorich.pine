//@version=6
indicator(title = 'Sessions Plus ORB [AlgoRich]', overlay = true)

// --- CONFIGURACIÓN GLOBAL ---
timezone = input.string('UTC-3', 'Zona Horaria (UTC)', options = ['UTC-10', 'UTC-9', 'UTC-8', 'UTC-7', 'UTC-6', 'UTC-5', 'UTC-4', 'UTC-3', 'UTC-2', 'UTC-1', 'UTC+0', 'UTC+1', 'UTC+2', 'UTC+3', 'UTC+4', 'UTC+5', 'UTC+6', 'UTC+7', 'UTC+8', 'UTC+9', 'UTC+10', 'UTC+12'], group = 'Ajustes Horarios')
txt_col  = input.color(color.white, 'Color de los Nombres', group = 'Estética Global')
orb_ext  = input.int(10, "Extensión ORB (Velas)", minval = 0, group = "Estética Global")

// Configuración Estilo de Líneas ORB
h_col   = input.color(#006400b3, "Color High", group = "Estética Global")
h_style = input.string("Guiones", "Estilo High", options = ["Sólido", "Punteado", "Guiones"], group = "Estética Global")
m_col   = input.color(color.new(#000000, 30), "Color Mid", group = "Estética Global")
m_style = input.string("Sólido", "Estilo Mid", options = ["Sólido", "Punteado", "Guiones"], group = "Estética Global")
l_col   = input.color(color.new(#FF0000, 30), "Color Low", group = "Estética Global")
l_style = input.string("Guiones", "Estilo Low", options = ["Sólido", "Punteado", "Guiones"], group = "Estética Global")

// Función para convertir texto a estilo de línea
f_get_style(s) =>
    s == "Sólido" ? line.style_solid : s == "Punteado" ? line.style_dotted : line.style_dashed

// --- INPUTS DE SESIONES ---
// Sesión 1
s1_on   = input.bool(true, 'Activar Sesión 1', group = 'Sesión 1 (ASIA)')
s1_name = input.string('ASIA', 'Nombre', group = 'Sesión 1 (ASIA)')
s1_time = input.session('2200-0400', 'Horario', group = 'Sesión 1 (ASIA)')
s1_col  = input.color(color.new(#FF0000, 85), 'Color Fondo', group = 'Sesión 1 (ASIA)')
s1_box  = input.bool(true, 'Modo Box (ORB)', group = 'Sesión 1 (ASIA)')
s1_bg   = input.bool(false, 'Modo Fondo Completo', group = 'Sesión 1 (ASIA)')

// Sesión 2
s2_on   = input.bool(true, 'Activar Sesión 2', group = 'Sesión 2 (LONDRES)')
s2_name = input.string('LONDRES', 'Nombre', group = 'Sesión 2 (LONDRES)')
s2_time = input.session('0500-1000', 'Horario', group = 'Sesión 2 (LONDRES)')
s2_col  = input.color(color.new(#00FF00, 85), 'Color Fondo', group = 'Sesión 2 (LONDRES)')
s2_box  = input.bool(true, 'Modo Box (ORB)', group = 'Sesión 2 (LONDRES)')
s2_bg   = input.bool(true, 'Modo Fondo Completo', group = 'Sesión 2 (LONDRES)')

// Sesión 3
s3_on   = input.bool(true, 'Activar Sesión 3', group = 'Sesión 3 (NY)')
s3_name = input.string('NEW YORK', 'Nombre', group = 'Sesión 3 (NY)')
s3_time = input.session('1000-1400', 'Horario', group = 'Sesión 3 (NY)')
s3_col  = input.color(color.new(#0000FF, 85), 'Color Fondo', group = 'Sesión 3 (NY)')
s3_box  = input.bool(true, 'Modo Box (ORB)', group = 'Sesión 3 (NY)')
s3_bg   = input.bool(true, 'Modo Fondo Completo', group = 'Sesión 3 (NY)')

// Sesión 4
s4_on   = input.bool(true, 'Activar Sesión 4', group = 'Sesión 4 (KILLZONE)')
s4_name = input.string('KILLZONE', 'Nombre', group = 'Sesión 4 (KILLZONE)')
s4_time = input.session('0930-1000', 'Horario', group = 'Sesión 4 (KILLZONE)')
s4_col  = input.color(color.new(#000000, 80), 'Color Fondo', group = 'Sesión 4 (KILLZONE)')
s4_box  = input.bool(true, 'Modo Box (ORB)', group = 'Sesión 4 (KILLZONE)')
s4_bg   = input.bool(true, 'Modo Fondo Completo', group = 'Sesión 4 (KILLZONE)')

// --- FUNCIÓN MAESTRA DE RENDERIZADO ---
// Ahora devuelve un 'color' para ser usado fuera
f_render_session(_on, _name, _time, _color, _is_box, _is_bg) =>
    // Cálculo de tiempo
    bool in_s = _on and not na(time(timeframe.period, _time, timezone))
    bool is_start = in_s and not in_s[1]
    
    // Variables persistentes
    var box b = na
    var line lh = na, var line lm = na, var line ll = na
    var float h = na, var float l = na

    // Lógica de dibujado de CAJA y LÍNEAS (Efectos visuales)
    if in_s and _is_box
        if is_start
            h := high
            l := low
            // Crear objetos
            b := box.new(bar_index, h, bar_index, l, border_color = _color, bgcolor = _color, text = _name, text_color = txt_col, text_size = size.small, text_halign = text.align_left, text_valign = text.align_top)
            lh := line.new(bar_index, h, bar_index, h, color=h_col, style=f_get_style(h_style))
            lm := line.new(bar_index, (h+l)/2, bar_index, (h+l)/2, color=m_col, style=f_get_style(m_style))
            ll := line.new(bar_index, l, bar_index, l, color=l_col, style=f_get_style(l_style))
        else
            // Actualizar máximos y mínimos
            h := math.max(high, h)
            l := math.min(low, l)
            
            // Actualizar Caja
            box.set_top(b, h)
            box.set_bottom(b, l)
            box.set_right(b, bar_index)
            
            // Actualizar y Proyectar Líneas ORB
            line.set_xy1(lh, line.get_x1(lh), h)
            line.set_xy2(lh, bar_index + orb_ext, h)
            
            line.set_xy1(lm, line.get_x1(lm), (h+l)/2)
            line.set_xy2(lm, bar_index + orb_ext, (h+l)/2)
            
            line.set_xy1(ll, line.get_x1(ll), l)
            line.set_xy2(ll, bar_index + orb_ext, l)
    
    // Retorno del color para el fondo (SOLO ESTO se devuelve)
    in_s and _is_bg ? _color : na

// --- EJECUCIÓN (bgcolor se llama AQUÍ, fuera de la función) ---
bgcolor(f_render_session(s1_on, s1_name, s1_time, s1_col, s1_box, s1_bg))
bgcolor(f_render_session(s2_on, s2_name, s2_time, s2_col, s2_box, s2_bg))
bgcolor(f_render_session(s3_on, s3_name, s3_time, s3_col, s3_box, s3_bg))
bgcolor(f_render_session(s4_on, s4_name, s4_time, s4_col, s4_box, s4_bg))
