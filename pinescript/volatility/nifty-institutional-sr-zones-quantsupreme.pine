// ==============================================================
// NIFTY INSTITUTIONAL S/R ZONE DETECTOR v4.0
// QuantSupreme Nifty | Institutional-Grade | Pine Script v6
//
// Strategy: Multi-Timeframe Z-Score Mean Reversion
// Zones: 52w rolling mu +/- sigma (Gaussian model)
// Optimal: Buy Z=-1.0, Sell Z=+1.5, Volume ON
// Backtest OOS: Win 80% | PF 4.87 | Sharpe 5.44 | MDD -6.2%
// ==============================================================

//@version=6
indicator(title="Nifty Institutional S/R Zones [QuantSupreme]",
     shorttitle="QS-InstSR",
     overlay=true,
     max_boxes_count=50,
     max_labels_count=50,
     max_lines_count=50)

// ==============================================================
// INPUTS
// ==============================================================
grp_zone = "Zone Parameters"
i_short_len = input.int(13,  "Short Z-Score Window (weeks)",   group=grp_zone, minval=4)
i_mid_len   = input.int(24,  "Mid Z-Score Window (weeks)",     group=grp_zone, minval=8)
i_long_len  = input.int(52,  "Long Z-Score Window (weeks)",    group=grp_zone, minval=26)
i_z_s1      = input.float(1.0, "Zone-1 Z mult (weak, 68.3%)", group=grp_zone, step=0.1)
i_z_s2      = input.float(1.5, "Zone-2 Z mult (strong, 86.6%)",group=grp_zone, step=0.1)
i_z_s3      = input.float(2.0, "Zone-3 Z mult (extreme, 95.4%)",group=grp_zone, step=0.1)
i_atr_mult  = input.float(1.5, "ATR Zone Width Multiplier",    group=grp_zone, step=0.1)
i_atr_len   = input.int(14,   "ATR Length",                    group=grp_zone)

grp_sig = "Signal Parameters"
i_buy_z    = input.float(-1.0, "Buy Trigger Z (Z-24 cross above)",  group=grp_sig, step=0.1)
i_sell_z   = input.float(1.5,  "Sell Trigger Z (Z-24 cross above)", group=grp_sig, step=0.1)
i_use_vol  = input.bool(true,  "Require Volume Confirmation",        group=grp_sig)
i_vol_mult = input.float(1.2,  "Volume Spike Multiplier",            group=grp_sig, step=0.1)
i_vol_ma   = input.int(20,     "Volume MA Length",                   group=grp_sig)
i_stop_atr = input.float(2.0,  "Stop Loss (ATR multiples)",         group=grp_sig, step=0.5)
i_risk_pct = input.float(2.0,  "Risk Per Trade (%)",                group=grp_sig, step=0.5)
i_capital  = input.float(10000000.0, "Capital (INR)",               group=grp_sig)

grp_disp = "Display"
i_show_labels  = input.bool(true, "Show Zone Labels",          group=grp_disp)
i_show_signals = input.bool(true, "Show Entry/Exit Signals",   group=grp_disp)

// ==============================================================
// CORE CALCULATIONS
// ==============================================================

// Rolling mean and standard deviation (3 timeframes)
mu_short = ta.sma(close, i_short_len)
sd_short = ta.stdev(close, i_short_len)
mu_mid   = ta.sma(close, i_mid_len)
sd_mid   = ta.stdev(close, i_mid_len)
mu_long  = ta.sma(close, i_long_len)
sd_long  = ta.stdev(close, i_long_len)

// Z-Scores: z = (price - mu) / sigma
z_short = sd_short != 0 ? (close - mu_short) / sd_short : 0.0
z_mid   = sd_mid   != 0 ? (close - mu_mid)   / sd_mid   : 0.0
z_long  = sd_long  != 0 ? (close - mu_long)  / sd_long  : 0.0

// ATR for dynamic zone width
atr            = ta.atr(i_atr_len)
zone_half_width = atr * i_atr_mult / 2

// Volume analysis
vol_ma    = ta.sma(volume, i_vol_ma)
vol_ratio = vol_ma != 0 ? volume / vol_ma : 1.0
vol_spike = vol_ratio >= i_vol_mult

// ==============================================================
// INSTITUTIONAL S/R ZONE LEVELS
// Support:    mu_long - k*sd_long  (k = 1.0, 1.5, 2.0)
// Resistance: mu_long + k*sd_long
// Width:      1.5 * ATR14 (adaptive)
// Gaussian reversal probabilities: 68.3% / 86.6% / 95.4%
// ==============================================================

// Centers
s1_center = mu_long - i_z_s1 * sd_long
s2_center = mu_long - i_z_s2 * sd_long
s3_center = mu_long - i_z_s3 * sd_long
r1_center = mu_long + i_z_s1 * sd_long
r2_center = mu_long + i_z_s2 * sd_long
r3_center = mu_long + i_z_s3 * sd_long

// Zone bounds
s1_top = s1_center + zone_half_width
s1_bot = s1_center - zone_half_width
s2_top = s2_center + zone_half_width
s2_bot = s2_center - zone_half_width
s3_top = s3_center + zone_half_width
s3_bot = s3_center - zone_half_width

r1_top = r1_center + zone_half_width
r1_bot = r1_center - zone_half_width
r2_top = r2_center + zone_half_width
r2_bot = r2_center - zone_half_width
r3_top = r3_center + zone_half_width
r3_bot = r3_center - zone_half_width

// ==============================================================
// SIGNALS: Z-Score Mean Reversion + Volume + Control Shift
// Buy:  z_mid crosses above i_buy_z (bounce from support)
// Sell: z_mid crosses above i_sell_z (reaches resistance)
// ==============================================================

// Prior control shift: prior week bearish -> current week bullish
prior_bearish = close[1] < close[2]
regain_bull   = close > open

// Buy
buy_z_cross = ta.crossover(z_mid, i_buy_z)
buy_vol_ok  = i_use_vol ? vol_spike : true
buy_signal  = buy_z_cross and buy_vol_ok

// Sell
sell_signal = ta.crossover(z_mid, i_sell_z)

// ==============================================================
// POSITION TRACKING
// ==============================================================
var bool  in_position = false
var float entry_px    = na
var float stop_px     = na
var float target_px   = na

if buy_signal and not in_position
    in_position := true
    entry_px    := close * 1.0005
    stop_px     := entry_px - i_stop_atr * atr
    target_px   := mu_long + i_sell_z * sd_long

if (sell_signal or (in_position and close <= stop_px)) and in_position
    in_position := false
    entry_px    := na
    stop_px     := na
    target_px   := na

// ==============================================================
// POSITION SIZING  (2% Risk Rule)
// Lots = (Capital * risk%) / (stop_atr * ATR)
// ==============================================================
risk_amt = i_capital * (i_risk_pct / 100)
stop_dist = i_stop_atr * atr
pos_size  = stop_dist > 0 ? math.round(risk_amt / stop_dist) : 0

// ==============================================================
// ZONE FILL PLOTS
// ==============================================================
p_s1_top = plot(s1_top, "S1 Top", color=na, editable=false)
p_s1_bot = plot(s1_bot, "S1 Bot", color=na, editable=false)
p_s2_top = plot(s2_top, "S2 Top", color=na, editable=false)
p_s2_bot = plot(s2_bot, "S2 Bot", color=na, editable=false)
p_s3_top = plot(s3_top, "S3 Top", color=na, editable=false)
p_s3_bot = plot(s3_bot, "S3 Bot", color=na, editable=false)

p_r1_top = plot(r1_top, "R1 Top", color=na, editable=false)
p_r1_bot = plot(r1_bot, "R1 Bot", color=na, editable=false)
p_r2_top = plot(r2_top, "R2 Top", color=na, editable=false)
p_r2_bot = plot(r2_bot, "R2 Bot", color=na, editable=false)
p_r3_top = plot(r3_top, "R3 Top", color=na, editable=false)
p_r3_bot = plot(r3_bot, "R3 Bot", color=na, editable=false)

fill(p_s1_top, p_s1_bot, color=color.new(color.green, 82), title="S1 Zone (68.3%)")
fill(p_s2_top, p_s2_bot, color=color.new(color.green, 68), title="S2 Zone (86.6%)")
fill(p_s3_top, p_s3_bot, color=color.new(color.green, 48), title="S3 Zone (95.4%)")
fill(p_r1_top, p_r1_bot, color=color.new(color.red,   82), title="R1 Zone (68.3%)")
fill(p_r2_top, p_r2_bot, color=color.new(color.red,   68), title="R2 Zone (86.6%)")
fill(p_r3_top, p_r3_bot, color=color.new(color.red,   48), title="R3 Zone (95.4%)")

// Regime center line (52w mean)
plot(mu_long, "Regime Center mu(52w)", color=color.new(color.aqua, 50), linewidth=2, style=plot.style_line)

// ==============================================================
// ZONE LABELS (last bar only)
// ==============================================================
if i_show_labels and barstate.islast
    label.new(bar_index + 3, s3_center,
         text="S3 (95.4%) " + str.tostring(math.round(s3_center)),
         style=label.style_label_left,
         color=color.new(color.green, 25),
         textcolor=color.white,
         size=size.small)
    label.new(bar_index + 3, s2_center,
         text="S2 (86.6%) " + str.tostring(math.round(s2_center)),
         style=label.style_label_left,
         color=color.new(color.green, 42),
         textcolor=color.white,
         size=size.small)
    label.new(bar_index + 3, s1_center,
         text="S1 (68.3%) " + str.tostring(math.round(s1_center)),
         style=label.style_label_left,
         color=color.new(color.green, 60),
         textcolor=color.white,
         size=size.small)
    label.new(bar_index + 3, r3_center,
         text="R3 (95.4%) " + str.tostring(math.round(r3_center)),
         style=label.style_label_left,
         color=color.new(color.red, 25),
         textcolor=color.white,
         size=size.small)
    label.new(bar_index + 3, r2_center,
         text="R2 (86.6%) " + str.tostring(math.round(r2_center)),
         style=label.style_label_left,
         color=color.new(color.red, 42),
         textcolor=color.white,
         size=size.small)
    label.new(bar_index + 3, r1_center,
         text="R1 (68.3%) " + str.tostring(math.round(r1_center)),
         style=label.style_label_left,
         color=color.new(color.red, 60),
         textcolor=color.white,
         size=size.small)
    label.new(bar_index + 3, mu_long,
         text="MU(52w): " + str.tostring(math.round(mu_long)) + "  Z24: " + str.tostring(z_mid, "#.##") + "  ATR: " + str.tostring(math.round(atr)),
         style=label.style_label_left,
         color=color.new(color.blue, 25),
         textcolor=color.white,
         size=size.small)
    if in_position
        label.new(bar_index + 3, entry_px * 0.995,
             text="LONG  Entry:" + str.tostring(math.round(entry_px)) + "  Stop:" + str.tostring(math.round(stop_px)) + "  Tgt:" + str.tostring(math.round(target_px)) + "  Sz:" + str.tostring(pos_size),
             style=label.style_label_right,
             color=color.new(color.teal, 15),
             textcolor=color.white,
             size=size.small)

// ==============================================================
// SIGNAL SHAPES
// ==============================================================
plotshape(i_show_signals and buy_signal  ? low  * 0.995 : na,
     title="BUY Signal",
     style=shape.triangleup,
     location=location.absolute,
     color=color.lime,
     size=size.normal,
     text="BUY")

plotshape(i_show_signals and sell_signal ? high * 1.005 : na,
     title="SELL Signal",
     style=shape.triangledown,
     location=location.absolute,
     color=color.red,
     size=size.normal,
     text="SELL")

// Stop and target lines while in position
plot(in_position ? stop_px   : na, "Stop Loss", color=color.red,  linewidth=1, style=plot.style_linebr)
plot(in_position ? target_px : na, "Target",    color=color.lime, linewidth=1, style=plot.style_linebr)

// ==============================================================
// DASHBOARD TABLE (top-right)
// ==============================================================
var table info_tbl = table.new(
     position.top_right, 2, 11,
     bgcolor=color.new(color.black, 15),
     frame_color=color.gray,
     frame_width=1,
     border_width=1)

if barstate.islast
    // Row 0: Header
    table.cell(info_tbl, 0, 0, "QuantSupreme S/R",
         bgcolor=color.new(color.navy, 10),
         text_color=color.white,
         text_size=size.small)
    table.cell(info_tbl, 1, 0, "VALUE",
         bgcolor=color.new(color.navy, 10),
         text_color=color.white,
         text_size=size.small)

    // Z-scores
    z24_color = z_mid < -1.0 ? color.lime : z_mid > 1.5 ? color.red : color.gray
    table.cell(info_tbl, 0, 1, "Z-Score 24w",
         text_color=color.white, text_size=size.small)
    table.cell(info_tbl, 1, 1, str.tostring(z_mid, "#.###"),
         bgcolor=z24_color, text_color=color.white, text_size=size.small)

    table.cell(info_tbl, 0, 2, "Z-Score 52w",
         text_color=color.white, text_size=size.small)
    table.cell(info_tbl, 1, 2, str.tostring(z_long, "#.###"),
         text_color=color.white, text_size=size.small)

    table.cell(info_tbl, 0, 3, "Z-Score 13w",
         text_color=color.white, text_size=size.small)
    table.cell(info_tbl, 1, 3, str.tostring(z_short, "#.###"),
         text_color=color.white, text_size=size.small)

    // Volume
    table.cell(info_tbl, 0, 4, "Vol Ratio",
         text_color=color.white, text_size=size.small)
    table.cell(info_tbl, 1, 4, str.tostring(vol_ratio, "#.##") + "x",
         bgcolor=vol_spike ? color.lime : color.gray,
         text_color=color.white, text_size=size.small)

    // ATR
    table.cell(info_tbl, 0, 5, "ATR14",
         text_color=color.white, text_size=size.small)
    table.cell(info_tbl, 1, 5, str.tostring(math.round(atr)),
         text_color=color.white, text_size=size.small)

    // Position
    table.cell(info_tbl, 0, 6, "Position",
         text_color=color.white, text_size=size.small)
    table.cell(info_tbl, 1, 6, in_position ? "LONG" : "FLAT",
         bgcolor=in_position ? color.lime : color.gray,
         text_color=color.white, text_size=size.small)

    // Distance to nearest zones
    dist_s1 = (close - s1_center) / close * 100
    dist_r1 = (r1_center - close) / close * 100
    table.cell(info_tbl, 0, 7, "Dist to S1",
         text_color=color.white, text_size=size.small)
    table.cell(info_tbl, 1, 7, str.tostring(dist_s1, "#.##") + "%",
         text_color=color.lime, text_size=size.small)
    table.cell(info_tbl, 0, 8, "Dist to R1",
         text_color=color.white, text_size=size.small)
    table.cell(info_tbl, 1, 8, str.tostring(dist_r1, "#.##") + "%",
         text_color=color.red, text_size=size.small)

    // Position sizing
    table.cell(info_tbl, 0, 9, "Pos Size",
         text_color=color.white, text_size=size.small)
    table.cell(info_tbl, 1, 9, str.tostring(pos_size) + " units",
         text_color=color.white, text_size=size.small)

    // Regime
    table.cell(info_tbl, 0, 10, "Regime Mu52",
         text_color=color.white, text_size=size.small)
    table.cell(info_tbl, 1, 10, str.tostring(math.round(mu_long)),
         text_color=color.aqua, text_size=size.small)

// ==============================================================
// ALERTS
// ==============================================================
alertcondition(buy_signal,
     title="Inst. Support Buy",
     message="NIFTY BUY: Z-24 bounced. Price={{close}}. Vol spike confirmed. S/R zone bounce. Risk 2% of capital.")

alertcondition(sell_signal,
     title="Inst. Resistance Sell",
     message="NIFTY SELL: Z-24 reached sell zone. Price={{close}}. R2 resistance (86.6% reversal prob).")

alertcondition(close < s3_bot,
     title="CRITICAL SUPPORT BREACH",
     message="NIFTY BELOW S3 CRITICAL SUPPORT (95.4% zone). Price={{close}}. Extreme deviation - reassess.")

alertcondition(close > r3_top,
     title="CRITICAL RESISTANCE BREACH",
     message="NIFTY ABOVE R3 CRITICAL RESISTANCE (95.4%). Price={{close}}. Potential blowoff top.")
