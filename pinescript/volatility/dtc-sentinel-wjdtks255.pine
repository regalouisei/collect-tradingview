// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © wjdtks255

//@version=5
indicator("DTC Sentinel [wjdtks255]", overlay=true, max_labels_count=500)

// --- 1. 사용자 설정 (Settings with English Descriptions) ---
gp_visual = "비주얼 설정 (Visual Settings)"
isKor = input.bool(true, "언어 선택 / Language (Checked: Kor, Unchecked: Eng)", group=gp_visual)

// 구름대 색상 설정
bullCloudColor = input.color(color.new(color.lime, 70), "상승 구름 색상 (Bullish Cloud)", group=gp_visual)
bearCloudColor = input.color(color.new(color.red, 70), "하락 구름 색상 (Bearish Cloud)", group=gp_visual)

// 대시보드 설정
gp_dash = "대시보드 설정 (Dashboard Settings)"
dashPos = input.string("Top Right", "위치 (Position)", options=["Top Right", "Top Center", "Top Left", "Middle Right", "Middle Center", "Middle Left", "Bottom Right", "Bottom Center", "Bottom Left"], group=gp_dash)
dashSize = input.string("Small", "크기 (Size)", options=["Tiny", "Small", "Normal", "Large", "Huge"], group=gp_dash)

// 엔진 설정
gp_engine = "DTC 엔진 (DTC Engine)"
atrPeriod = input.int(14, "추세 민감도 기간 (Trend Sensitivity)", group=gp_engine)

// --- 2. [엔진 유지] DTC 추세 로직 ---
atr = ta.atr(atrPeriod)
upper = ta.highest(high, 20)
lower = ta.lowest(low, 20)

var int trend = 0
trend := (close > upper[1]) ? 1 : (close < lower[1]) ? -1 : trend[1]

// 구름대 시각화
p1 = plot(upper, "Sentinel Upper", color=trend == 1 ? color.new(bullCloudColor, 30) : color.new(bearCloudColor, 30), linewidth=2)
p2 = plot(lower, "Sentinel Lower", color=trend == 1 ? color.new(bullCloudColor, 30) : color.new(bearCloudColor, 30), linewidth=2)
fill(p1, p2, color=trend == 1 ? bullCloudColor : bearCloudColor, title="Trend Cloud")

// --- 3. [엔진 유지] 매수/매도 신호 ---
longSignal = ta.crossover(trend, 0)
shortSignal = ta.crossunder(trend, 0)

plotshape(longSignal, "Buy", shape.circle, location.belowbar, color.lime, size=size.small, text="BUY", textcolor=color.white)
plotshape(shortSignal, "Sell", shape.circle, location.abovebar, color.red, size=size.small, text="SELL", textcolor=color.white)

// --- 4. 대시보드 및 영문 텍스트 처리 ---
func_get_pos(pos) =>
    pos == "Top Right" ? position.top_right : pos == "Top Center" ? position.top_center : pos == "Top Left" ? position.top_left : pos == "Middle Right" ? position.middle_right : pos == "Middle Center" ? position.middle_center : pos == "Middle Left" ? position.middle_left : pos == "Bottom Right" ? position.bottom_right : pos == "Bottom Center" ? position.bottom_center : position.bottom_left
func_get_size(sz) =>
    sz == "Tiny" ? size.tiny : sz == "Small" ? size.small : sz == "Normal" ? size.normal : sz == "Large" ? size.large : size.huge

var table dtcBoard = table.new(func_get_pos(dashPos), 2, 6, border_width=1, frame_color=color.gray, border_color=color.gray)
t_size = func_get_size(dashSize)

// 데이터 연산
barsSince = ta.barssince(ta.change(trend) != 0)
ageDisplay = str.tostring(barsSince) + (isKor ? "개 봉" : " Bars")
rsiVal = ta.rsi(close, 14)
ema200 = ta.ema(close, 200)

if barstate.islast
    // 영문 텍스트 변환 테이블
    txt_title = isKor ? "DTC 샌티널" : "DTC Sentinel"
    txt_trend = isKor ? "시장 추세" : "Market Trend"
    txt_age   = isKor ? "신호 지속" : "Signal Age"
    txt_sent  = isKor ? "감시 상태" : "Monitoring"
    
    table.cell(dtcBoard, 0, 0, txt_title, bgcolor=color.black, text_color=color.white, text_size=t_size)
    table.cell(dtcBoard, 1, 0, "FINAL v1.8", bgcolor=color.black, text_color=color.yellow, text_size=t_size)
    
    table.cell(dtcBoard, 0, 1, txt_trend, bgcolor=#2a2e39, text_color=color.white, text_size=t_size)
    table.cell(dtcBoard, 1, 1, trend == 1 ? (isKor ? "상승장" : "BULLISH") : (isKor ? "하락장" : "BEARISH"), bgcolor=trend == 1 ? color.green : color.red, text_color=color.white, text_size=t_size)
    
    table.cell(dtcBoard, 0, 2, txt_age, bgcolor=#2a2e39, text_color=color.white, text_size=t_size)
    table.cell(dtcBoard, 1, 2, ageDisplay, bgcolor=#2a2e39, text_color=color.white, text_size=t_size)
    
    table.cell(dtcBoard, 0, 3, "EMA 200", bgcolor=#2a2e39, text_color=color.white, text_size=t_size)
    table.cell(dtcBoard, 1, 3, close > ema200 ? (isKor ? "상단" : "Above") : (isKor ? "하단" : "Below"), bgcolor=close > ema200 ? color.teal : color.maroon, text_color=color.white, text_size=t_size)

    table.cell(dtcBoard, 0, 4, "RSI (14)", bgcolor=#2a2e39, text_color=color.white, text_size=t_size)
    table.cell(dtcBoard, 1, 4, str.tostring(math.round(rsiVal, 1)), bgcolor=color.black, text_color=color.white, text_size=t_size)
    
    table.cell(dtcBoard, 0, 5, txt_sent, bgcolor=#2a2e39, text_color=color.white, text_size=t_size)
    table.cell(dtcBoard, 1, 5, "ACTIVE", bgcolor=color.teal, text_color=color.white, text_size=t_size)
