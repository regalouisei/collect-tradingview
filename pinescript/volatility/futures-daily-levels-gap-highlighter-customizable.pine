//@version=6
indicator("Futures Daily Levels & Gap Highlighter [Customizable]", overlay=true)

// --- General Inputs ---
gap_threshold = input.float(5.0, "Gap Highlight Threshold (Points)", group="General Settings")
label_offset  = input.int(2, "Label Offset (Bars)", group="General Settings")

// --- Style Settings ---
color_pdh  = input.color(color.green, "PDH Color", group="Style: PDH")
width_pdh  = input.int(1, "PDH Thickness", minval=1, maxval=10, group="Style: PDH")

color_pdl  = input.color(color.red, "PDL Color", group="Style: PDL")
width_pdl  = input.int(1, "PDL Thickness", minval=1, maxval=10, group="Style: PDL")

color_pdo  = input.color(color.gray, "PDO Color", group="Style: PDO")
width_pdo  = input.int(1, "PDO Thickness", minval=1, maxval=10, group="Style: PDO")

color_pdc  = input.color(color.white, "PDC Color", group="Style: PDC")
width_pdc  = input.int(2, "PDC Thickness", minval=1, maxval=10, group="Style: PDC")

color_open = input.color(color.blue, "Open Color", group="Style: Current Open")
width_open = input.int(1, "Open Thickness", minval=1, maxval=10, group="Style: Current Open")

// --- Data Fetching ---
[pdh, pdl, pdo, pdc, cd_open] = request.security(syminfo.tickerid, "D", [high[1], low[1], open[1], close[1], open], lookahead=barmerge.lookahead_on)

// --- Session Logic ---
is_new_session = ta.change(time("D")) != 0

var float globex_open = na
if is_new_session
    globex_open := open

// --- Line & Label Management ---
f_manage_level(price, txt, col, width) =>
    var line lvl_line = line.new(na, na, na, na, xloc=xloc.bar_index, color=col, width=width)
    var label lvl_lbl = label.new(na, na, "", xloc=xloc.bar_index, style=label.style_label_left, color=color.new(color.black, 100), textcolor=col)
    
    // Update line and label properties if user changes inputs
    line.set_color(lvl_line, col)
    line.set_width(lvl_line, width)
    label.set_textcolor(lvl_lbl, col)

    if not na(price)
        if is_new_session
            line.set_x1(lvl_line, bar_index)
        
        line.set_xy2(lvl_line, bar_index, price)
        line.set_y1(lvl_line, price)
        
        label.set_xy(lvl_lbl, bar_index + label_offset, price)
        label.set_text(lvl_lbl, txt + ": " + str.tostring(price, "#.##"))

// Execute for each level using the input variables
f_manage_level(pdh, "PDH", color_pdh, width_pdh)
f_manage_level(pdl, "PDL", color_pdl, width_pdl)
f_manage_level(pdo, "PDO", color_pdo, width_pdo)
f_manage_level(pdc, "PDC", color_pdc, width_pdc)
f_manage_level(cd_open, "Open", color_open, width_open)

// --- Gap Highlight ---
gap_size = math.abs(globex_open - pdc)
var box gap_box = na

if is_new_session
    if gap_size >= gap_threshold
        gap_box := box.new(left=bar_index, top=math.max(pdc, globex_open), 
                           right=bar_index + 1, bottom=math.min(pdc, globex_open), 
                           bgcolor=color.new(color.yellow, 85), border_color=color.new(color.yellow, 100))
    else
        gap_box := na

if not is_new_session and not na(gap_box)
    box.set_right(gap_box, bar_index)
