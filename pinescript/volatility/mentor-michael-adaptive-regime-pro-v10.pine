//@version=6
indicator("Mentor Michael - Adaptive Regime Pro v1.0", overlay=true, max_lines_count=500)

// ═══════════════════════════════════════
// SETTINGS
// ═══════════════════════════════════════

var string calc_group = "════════ Calculation Settings ════════"
var string vis_group  = "════════ Visual Settings ════════"

lookback   = input.int(25, "Entropy Lookback", minval=5, group=calc_group)
fastMult   = input.float(1.8, "Fast Band Multiplier", step=0.1, group=calc_group)
slowMult   = input.float(3.5, "Slow Band Multiplier", step=0.1, group=calc_group)

bullColor  = input.color(color.teal, "Bull Color", group=vis_group)
bearColor  = input.color(color.red, "Bear Color", group=vis_group)
fillTransp = input.int(88, "Fill Transparency", minval=0, maxval=100, group=vis_group)
barColorOn = input.bool(true, "Enable Bar Coloring", group=vis_group)
showPanel  = input.bool(true, "Show Trend Dashboard", group=vis_group)

// ═══════════════════════════════════════
// ENTROPY ENGINE
// ═══════════════════════════════════════

logRet = math.log(close / close[1])
retStd = ta.stdev(logRet, lookback)
retMean = ta.sma(logRet, lookback)

// Improved normalization
entropyRaw = retStd / (math.abs(retMean) + 1e-6)
normalizedEntropy = math.min(math.max(entropyRaw, 0), 1)

// ═══════════════════════════════════════
// ADAPTIVE EMA
// ═══════════════════════════════════════

alpha = 2.0 / (lookback * (0.4 + normalizedEntropy * 1.2) + 1)

var float adaptiveEMA = na
adaptiveEMA := na(adaptiveEMA) ? close : adaptiveEMA + alpha * (close - adaptiveEMA)

// ═══════════════════════════════════════
// VOLATILITY BANDS
// ═══════════════════════════════════════

atr = ta.atr(lookback)
trendStrength = 1 - normalizedEntropy

fastWidth = atr * fastMult * (0.6 + trendStrength)
slowWidth = atr * slowMult * (0.6 + trendStrength)

innerUpper = adaptiveEMA + fastWidth
innerLower = adaptiveEMA - fastWidth
outerUpper = adaptiveEMA + slowWidth
outerLower = adaptiveEMA - slowWidth

// ═══════════════════════════════════════
// TREND LOGIC
// ═══════════════════════════════════════

var int trend = 0

if close > innerUpper
    trend := 1
else if close < innerLower
    trend := -1

bullSignal = trend == 1 and trend[1] != 1
bearSignal = trend == -1 and trend[1] != -1

trendColor = trend == 1 ? bullColor : trend == -1 ? bearColor : color.gray

// ═══════════════════════════════════════
// SIGNAL STRENGTH (0-100)
// ═══════════════════════════════════════

signalStrength = math.round(trendStrength * 100)

// ═══════════════════════════════════════
// VISUALS
// ═══════════════════════════════════════

pOuterU = plot(outerUpper, color=color.new(trendColor, 90))
pInnerU = plot(innerUpper, color=color.new(trendColor, 70))
pEMA    = plot(adaptiveEMA, color=trendColor, linewidth=3)
pInnerL = plot(innerLower, color=color.new(trendColor, 70))
pOuterL = plot(outerLower, color=color.new(trendColor, 90))

fill(pOuterU, pInnerU, color=color.new(trendColor, fillTransp))
fill(pInnerU, pInnerL, color=color.new(trendColor, math.min(fillTransp + 6, 100)))
fill(pInnerL, pOuterL, color=color.new(trendColor, fillTransp))

barcolor(barColorOn ? color.new(trendColor, 20) : na)

// ═══════════════════════════════════════
// DASHBOARD PANEL
// ═══════════════════════════════════════

if showPanel
    var table panel = table.new(position.top_right, 2, 3, border_width=1)

    table.cell(panel, 0, 0, "Trend")
    table.cell(panel, 1, 0, trend == 1 ? "Bullish" : trend == -1 ? "Bearish" : "Neutral", text_color=trendColor)

    table.cell(panel, 0, 1, "Strength")
    table.cell(panel, 1, 1, str.tostring(signalStrength) + "%", text_color=color.white)

    table.cell(panel, 0, 2, "Entropy")
    table.cell(panel, 1, 2, str.tostring(math.round(normalizedEntropy * 100)) + "%", text_color=color.white)

// ═══════════════════════════════════════
// ALERTS
// ═══════════════════════════════════════

alertcondition(bullSignal, title="Bullish Trend",
     message="Mentor Michael Adaptive Regime: BULLISH on {{ticker}}")

alertcondition(bearSignal, title="Bearish Trend",
     message="Mentor Michael Adaptive Regime: BEARISH on {{ticker}}")
