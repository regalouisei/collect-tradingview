//@version=6
indicator("Manual High/Low xATR Tracker â€” Clean", overlay=true)

//==================== Inputs ====================
atrTFMode = input.string("1H", "ATR Timeframe", options=["Chart","1H","4H","Daily"])
atrLen = input.int(14, "ATR Length", minval=1)

anchorLow = input.float(0.0, "LOW price (manual)")
anchorHigh = input.float(0.0, "HIGH price (manual)")

round2 = input.bool(true, "Round xATR to 2 decimals")

//==================== ATR ====================
string atrTF = atrTFMode == "Chart" ? timeframe.period :
     atrTFMode == "1H" ? "60" :
     atrTFMode == "4H" ? "240" : "D"

atrVal = request.security(syminfo.tickerid, atrTF, ta.atr(atrLen),
     barmerge.gaps_off, barmerge.lookahead_off)

//==================== xATR Calculations ====================
useLow = anchorLow != 0.0
useHigh = anchorHigh != 0.0

xFromLow = (not useLow or na(atrVal) or atrVal == 0) ? na : (close - anchorLow) / atrVal
xFromHigh = (not useHigh or na(atrVal) or atrVal == 0) ? na : (anchorHigh - close) / atrVal

//==================== Formatting ====================
fX(x) => na(x) ? "na" : (round2 ? str.tostring(x, "#.##") : str.tostring(x))
fP(x) => str.tostring(x, format.mintick)

//==================== Small Top-Right Box ====================
var table t = table.new(position.top_right, 1, 3,
     frame_color=color.new(color.white, 100),
     force_overlay=true)

if barstate.islast
    table.cell(t, 0, 0,
        "xATR Tracker",
        text_color=color.white,
        bgcolor=color.black)

    table.cell(t, 0, 1,
        useLow
        ? "LOW (" + fP(anchorLow) + "): " + fX(xFromLow) + " xATR"
        : "LOW: OFF",
        text_color=color.white,
        bgcolor=color.black)

    table.cell(t, 0, 2,
        useHigh
        ? "HIGH (" + fP(anchorHigh) + "): " + fX(xFromHigh) + " xATR"
        : "HIGH: OFF",
        text_color=color.white,
        bgcolor=color.black)
