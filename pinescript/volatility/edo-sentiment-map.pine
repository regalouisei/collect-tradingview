//@version=6
indicator("Edo Sentiment Map", overlay=true, max_labels_count=500)

//───────────────────────
// VISUAL OPTIONS (ONLY THESE ARE CONFIGURABLE)
//───────────────────────
showHeatmap  = input.bool(true, "Color Candles")
showLegend   = input.bool(true, "Show Legend")
showTooltips = input.bool(true, "Show State Labels (hover to read meaning)")

//───────────────────────
// FIXED CORE PARAMETERS (LOCKED)
//───────────────────────
len_base   = 10
smooth_len = 1
dd_len     = 5
range_len  = 15

//───────────────────────
// BASE BEHAVIOUR METRICS
//───────────────────────
price_delta = close - close[len_base]
atr_val     = ta.atr(len_base)
efficiency  = math.abs(price_delta) / math.max(atr_val, syminfo.mintick)
vol_norm    = atr_val / ta.sma(atr_val, len_base)
raw_score   = price_delta > 0 ? efficiency * vol_norm : -efficiency * vol_norm
base_score  = ta.ema(raw_score, smooth_len)

//───────────────────────
// ANTI-EUPHORIA FILTERS
//───────────────────────
hh = ta.highest(high, dd_len)
drawdown = (close - hh) / hh
drawdownFactor = drawdown < 0 ? 1 + drawdown : 1
momentumSlope  = base_score - base_score[1]
momentumFactor = momentumSlope < 0 ? 0.6 : 1.0
score = base_score * drawdownFactor * momentumFactor

//───────────────────────
// CONTEXT ADJUSTMENT (SOFT)
//───────────────────────
score_hi = ta.highest(score, range_len)
score_lo = ta.lowest(score, range_len)
range_score = math.max(score_hi - score_lo, syminfo.mintick)
contextFactor = 0.8 + ((score - score_lo) / range_score) * 0.4
score_ctx = score * contextFactor

//───────────────────────
// SENTIMENT STATES
//───────────────────────
int sentiment = 0
string stateName = ""
string tooltipText = ""
string shortText = ""

if score_ctx > 2.8
    sentiment := 5, stateName := "Max Euphoria", shortText := "Take profits", tooltipText := "Extreme optimism. Potential distribution zone. Taking profits is often considered."
else if score_ctx > 2.2
    sentiment := 4, stateName := "Extreme Greed", shortText := "Overextended trend", tooltipText := "Overextended upside trend. Watch for exhaustion or reversal."
else if score_ctx > 1.6
    sentiment := 3, stateName := "High Greed", shortText := "Buying pressure", tooltipText := "Buying pressure dominates. Strong bullish participation."
else if score_ctx > 1.0
    sentiment := 2, stateName := "Greed", shortText := "Trend continuation", tooltipText := "Healthy upward movement. Trend continuation zone."
else if score_ctx > 0.4
    sentiment := 1, stateName := "Mild Greed", shortText := "Weak bullish pressure", tooltipText := "Weak bullish pressure. Buyers slightly in control."
else if score_ctx > -0.4
    sentiment := 0, stateName := "Neutral", shortText := "No clear direction", tooltipText := "Indecision zone. No clear directional edge."
else if score_ctx > -1.0
    sentiment := -1, stateName := "Mild Caution", shortText := "Weak bearish pressure", tooltipText := "Weak bearish pressure. Sellers slightly in control."
else if score_ctx > -1.6
    sentiment := -2, stateName := "Caution", shortText := "Downside risk", tooltipText := "Downside risk increasing. Bearish momentum building."
else if score_ctx > -2.2
    sentiment := -3, stateName := "Concern", shortText := "Selling pressure", tooltipText := "Selling pressure dominates. Strong bearish participation."
else if score_ctx > -2.8
    sentiment := -4, stateName := "Fear", shortText := "Overextended trend", tooltipText := "Overextended downside trend. Watch for exhaustion or reversal."
else
    sentiment := -5, stateName := "Max Fear", shortText := "Potential entry", tooltipText := "Extreme pessimism. Potential accumulation zone and possible entry if confirmed."

//───────────────────────
// COLOR MAP
//───────────────────────
color sentimentColor = color.gray
if sentiment == 5
    sentimentColor := color.rgb(255,105,180)
else if sentiment == 4
    sentimentColor := color.rgb(220,20,60)
else if sentiment == 3
    sentimentColor := color.rgb(255,69,0)
else if sentiment == 2
    sentimentColor := color.rgb(255,140,0)
else if sentiment == 1
    sentimentColor := color.rgb(255,215,0)
else if sentiment == 0
    sentimentColor := color.rgb(255,255,0)
else if sentiment == -1
    sentimentColor := color.rgb(138,43,226)
else if sentiment == -2
    sentimentColor := color.rgb(0,0,255)
else if sentiment == -3
    sentimentColor := color.rgb(0,139,139)
else if sentiment == -4
    sentimentColor := color.rgb(0,255,255)
else
    sentimentColor := color.rgb(0,255,0)

//───────────────────────
// PLOT
//───────────────────────
barcolor(showHeatmap ? sentimentColor : na)

//───────────────────────
// STATE LABEL + TOOLTIP
//───────────────────────
if showTooltips
    label.new(bar_index, high, str.tostring(sentiment), style=label.style_label_down, textcolor=color.black, color=sentimentColor, tooltip=tooltipText, size=size.tiny)

//───────────────────────
// LEGEND (3 COLUMNS)
//───────────────────────
var table legend = table.new(position.top_right, 3, 11, frame_width=1)

if showLegend and barstate.islast
    table.clear(legend, 0, 0, 2, 10)
    table.cell(legend, 0, 0, "(+5)", bgcolor=color.rgb(255,105,180)), table.cell(legend, 1, 0, "Max Euphoria", text_color=color.white), table.cell(legend, 2, 0, "Take profits", text_color=color.white)
    table.cell(legend, 0, 1, "(+4)", bgcolor=color.rgb(220,20,60)),  table.cell(legend, 1, 1, "Extreme Greed", text_color=color.white), table.cell(legend, 2, 1, "Overextended trend", text_color=color.white)
    table.cell(legend, 0, 2, "(+3)", bgcolor=color.rgb(255,69,0)),   table.cell(legend, 1, 2, "High Greed", text_color=color.white), table.cell(legend, 2, 2, "Buying pressure", text_color=color.white)
    table.cell(legend, 0, 3, "(+2)", bgcolor=color.rgb(255,140,0)),  table.cell(legend, 1, 3, "Greed", text_color=color.white), table.cell(legend, 2, 3, "Trend continuation", text_color=color.white)
    table.cell(legend, 0, 4, "(+1)", bgcolor=color.rgb(255,215,0)),  table.cell(legend, 1, 4, "Mild Greed", text_color=color.white), table.cell(legend, 2, 4, "Weak bullish pressure", text_color=color.white)
    table.cell(legend, 0, 5, "(0)",  bgcolor=color.rgb(255,255,0)),  table.cell(legend, 1, 5, "Neutral", text_color=color.white), table.cell(legend, 2, 5, "No clear direction", text_color=color.white)
    table.cell(legend, 0, 6, "(-1)", bgcolor=color.rgb(138,43,226)), table.cell(legend, 1, 6, "Mild Caution", text_color=color.white), table.cell(legend, 2, 6, "Weak bearish pressure", text_color=color.white)
    table.cell(legend, 0, 7, "(-2)", bgcolor=color.rgb(0,0,255)),    table.cell(legend, 1, 7, "Caution", text_color=color.white), table.cell(legend, 2, 7, "Downside risk", text_color=color.white)
    table.cell(legend, 0, 8, "(-3)", bgcolor=color.rgb(0,139,139)),  table.cell(legend, 1, 8, "Concern", text_color=color.white), table.cell(legend, 2, 8, "Selling pressure", text_color=color.white)
    table.cell(legend, 0, 9, "(-4)", bgcolor=color.rgb(0,255,255)),  table.cell(legend, 1, 9, "Fear", text_color=color.white), table.cell(legend, 2, 9, "Overextended trend", text_color=color.white)
    table.cell(legend, 0,10, "(-5)", bgcolor=color.rgb(0,255,0)),    table.cell(legend, 1,10, "Max Fear", text_color=color.white), table.cell(legend, 2,10, "Potential entry", text_color=color.white)
