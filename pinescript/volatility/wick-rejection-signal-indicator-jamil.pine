//@version=5
indicator("Wick Rejection Signal Indicator", overlay=true, max_labels_count=500)

// ================================
// INPUT SETTINGS
// ================================

// Wick Threshold (in dollars/points)
wickThreshold = input.float(8.0, "Wick Threshold ($)", minval=0.1, step=0.1, tooltip="Minimum wick size required for signal")

// Display Settings
showBuySignals = input.bool(true, "Show BUY Signals")
showSellSignals = input.bool(true, "Show SELL Signals")
signalSize = input.string("small", "Signal Size", options=["tiny", "small", "normal", "large"])

// Minimum body/wick ratio (optional filter)
minRejectionRatio = input.float(0.5, "Min Rejection Ratio", minval=0.0, maxval=1.0, tooltip="Wick must be at least this ratio of total range. 0.5 = wick is 50% of candle")

// ================================
// VARIABLES & LOGIC
// ================================

var bool wickDownDetected = false
var bool wickUpDetected = false
var bool buySignalTriggered = false
var bool sellSignalTriggered = false
var float wickDownLevel = na
var float wickUpLevel = na

// Reset on new candle
if barstate.isconfirmed or barstate.isfirst
    wickDownDetected := false
    wickUpDetected := false
    buySignalTriggered := false
    sellSignalTriggered := false
    wickDownLevel := na
    wickUpLevel := na

// ================================
// CALCULATE WICK SIZES
// ================================

// Calculate body range
bodyHigh = math.max(open, close)
bodyLow = math.min(open, close)
bodySize = bodyHigh - bodyLow

// Calculate wick sizes
lowerWickSize = bodyLow - low          // Lower wick (tail below body)
upperWickSize = high - bodyHigh        // Upper wick (tail above body)

// Total candle range
totalRange = high - low

// Wick rejection ratios
lowerWickRatio = totalRange > 0 ? lowerWickSize / totalRange : 0
upperWickRatio = totalRange > 0 ? upperWickSize / totalRange : 0

// ================================
// DETECT WICK REJECTION
// ================================

// LOWER WICK REJECTION (Potential BUY setup)
// Price wicked down X dollars, showing rejection of lower prices
if lowerWickSize >= wickThreshold and lowerWickRatio >= minRejectionRatio and not wickDownDetected
    wickDownDetected := true
    wickDownLevel := low

// UPPER WICK REJECTION (Potential SELL setup)  
// Price wicked up X dollars, showing rejection of higher prices
if upperWickSize >= wickThreshold and upperWickRatio >= minRejectionRatio and not wickUpDetected
    wickUpDetected := true
    wickUpLevel := high

// ================================
// SIGNAL GENERATION
// ================================

// BUY SIGNAL: Lower wick formed (rejection down), then price moved back up
// We confirm this by checking if close is significantly above the low
buySignal = false
if wickDownDetected and not buySignalTriggered
    // Price rejected down and closed in upper portion of candle
    if close > bodyLow  // Close is above the body low (showing bullish rejection)
        buySignal := true
        buySignalTriggered := true

// SELL SIGNAL: Upper wick formed (rejection up), then price moved back down
// We confirm this by checking if close is significantly below the high
sellSignal = false
if wickUpDetected and not sellSignalTriggered
    // Price rejected up and closed in lower portion of candle
    if close < bodyHigh  // Close is below the body high (showing bearish rejection)
        sellSignal := true
        sellSignalTriggered := true

// ================================
// PLOT SIGNALS
// ================================

// Plot BUY signals at the low of the candle
if buySignal and showBuySignals
    label.new(bar_index, low, "BUY", 
             color=color.new(color.green, 0), 
             textcolor=color.white, 
             style=label.style_label_up, 
             size=signalSize,
             tooltip="Lower Wick Rejection: " + str.tostring(lowerWickSize, "#.##") + " | Ratio: " + str.tostring(lowerWickRatio * 100, "#.#") + "%")

// Plot SELL signals at the high of the candle
if sellSignal and showSellSignals
    label.new(bar_index, high, "SELL", 
             color=color.new(color.red, 0), 
             textcolor=color.white, 
             style=label.style_label_down, 
             size=signalSize,
             tooltip="Upper Wick Rejection: " + str.tostring(upperWickSize, "#.##") + " | Ratio: " + str.tostring(upperWickRatio * 100, "#.#") + "%")

// ================================
// VISUAL HELPERS (Optional)
// ================================

// Highlight candles with significant wicks (before signal confirmation)
// barcolor(wickDownDetected and not buySignalTriggered ? color.new(color.green, 80) : 
//          wickUpDetected and not sellSignalTriggered ? color.new(color.red, 80) : na)

// Plot small markers to show wick rejection detected
plotshape(wickDownDetected and not buySignalTriggered ? low : na, 
         "Lower Wick Detected", shape.diamond, location.absolute, 
         color.new(color.green, 50), size=size.tiny)

plotshape(wickUpDetected and not sellSignalTriggered ? high : na, 
         "Upper Wick Detected", shape.diamond, location.absolute, 
         color.new(color.red, 50), size=size.tiny)

// ================================
// ALERTS
// ================================

alertcondition(buySignal, title="BUY Signal", message="BUY Signal: Lower Wick Rejection!")
alertcondition(sellSignal, title="SELL Signal", message="SELL Signal: Upper Wick Rejection!")

// ================================
// DEBUG INFO (Optional)
// ================================

// Show wick sizes in data window
plot(lowerWickSize, "Lower Wick Size", color=color.green, display=display.data_window)
plot(upperWickSize, "Upper Wick Size", color=color.red, display=display.data_window)
plot(lowerWickRatio * 100, "Lower Wick %", color=color.green, display=display.data_window)
plot(upperWickRatio * 100, "Upper Wick %", color=color.red, display=display.data_window)
