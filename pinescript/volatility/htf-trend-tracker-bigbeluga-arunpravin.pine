// This work is licensed under Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International   
// https://creativecommons.org/licenses/by-nc-sa/4.0/
// © BigBeluga

//@version=6
indicator("HTF Trend Tracker [BigBeluga]", overlay = true, max_lines_count = 500, max_labels_count = 500)

// ───── INPUTS ─────────────────────────────────────────────
tf = input.timeframe("D", "Timeframe")

bull_col = input.color(color.rgb(12, 193, 142), "✓", inline = "col")
bear_col = input.color(color.red, "✕", inline = "col")
mid_col  = input.color(color.rgb(121, 121, 121), "-", inline = "col")

arrow_width = input.int(3, "Arrow Line Thickness", minval = 1, maxval = 10)
dotted_width = input.int(3, "Dotted HTF Line Thickness", minval = 1, maxval = 10)

// ───── VARIABLES ───────────────────────────────────────────
var line line_1 = na
var line line_2 = na
var color color_trend = na
var bool trend = false   // ✅ FIXED

// ───── FUNCTION TO DRAW DOTTED HTF LINES ──────────────────
draw_line(x1, x2, y, txt, col)=>
    l = line.new(
         x1, y, x2, y,
         color = col,
         style = line.style_dotted,
         width = dotted_width)   // ← use input
    label.delete(label.new(x1, y, txt, color = color(na), style = label.style_label_right)[1])
    l

// ───── CALCULATIONS ────────────────────────────────────────
var float h = na
var float l = na
var int count = 0

if not timeframe.change(tf)
    count += 1
    h := ta.highest(count)
    l := ta.lowest(count)

if timeframe.change(tf)
    count := 0
    line_1 := draw_line(bar_index, bar_index, h[1], tf + " High", bear_col)
    line_2 := draw_line(bar_index, bar_index, l[1], tf + " Low", bull_col)

// Extend dotted lines
if not na(line_1)
    line.set_x2(line_1, bar_index)

if not na(line_2)
    line.set_x2(line_2, bar_index)

// ───── RIGHT-SIDE ARROW PROJECTION ─────────────────────────
if barstate.islast and not na(line_1) and not na(line_2)
    line.delete(line.new(
        line.get_x1(line_1), line.get_y1(line_1),
        bar_index + 15, line.get_y1(line_1),
        color = bear_col,
        style = line.style_arrow_right,
        width = arrow_width)[1])

    line.delete(line.new(
        line.get_x1(line_2), line.get_y1(line_2),
        bar_index + 15, line.get_y1(line_2),
        color = bull_col,
        style = line.style_arrow_right,
        width = arrow_width)[1])

// ───── MIDPOINT ────────────────────────────────────────────
mid = math.avg(line.get_y1(line_1), line.get_y1(line_2))

// ───── TREND LOGIC ─────────────────────────────────────────
if ta.crossover(close, line.get_y1(line_1)) and barstate.isconfirmed
    color_trend := bull_col
    trend := true

if ta.crossunder(close, line.get_y1(line_2)) and barstate.isconfirmed
    color_trend := bear_col
    trend := false

// ───── PLOTS ───────────────────────────────────────────────
if trend and trend != trend[1]
    label.new(bar_index, low - ta.sma(high-low, 100), "✓",
        style = label.style_label_up, size = size.tiny, color = bull_col)

if not trend and trend != trend[1]
    label.new(bar_index, high + ta.sma(high-low, 100), "✕",
        style = label.style_label_down, size = size.tiny, color = bear_col)

high_sdv = (high - mid)
low_sdv  = (mid - low)

color_bars =
       trend
     ? color.from_gradient(high_sdv, 0, ta.highest(high_sdv, 100), mid_col, bull_col)
     : color.from_gradient(low_sdv, 0, ta.highest(low_sdv, 100), mid_col, bear_col)

plotcandle(open, high, low, close,
     title="Candles",
     color=color_bars,
     wickcolor=color_bars,
     bordercolor=color_bars)

plot(mid, "Trend", color=color_trend, linewidth=2)
