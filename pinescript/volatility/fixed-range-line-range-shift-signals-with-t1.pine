//@version=5
indicator("Fixed Range Line + Range Shift Signals with T1", overlay=true)

// === USER INPUTS ===
step          = input.float(10, "Fixed Value Step", step=0.1)

// === T1 INPUTS ===
enableT1      = input.bool(true, "Enable Target T1")
t1Distance    = input.float(20, "T1 Distance", step=0.1)

// === PERSISTENT RANGE LEVEL ===
var float level = na

if na(level)
    level := close

// Store previous level before updating
prevLevel = level

// Update logic (Range shift logic)
if close >= level + step
    level := level + step
else if close <= level - step
    level := level - step

// Detect new range line start
newUpShift   = level > prevLevel
newDownShift = level < prevLevel

// === SIGNAL CONDITIONS ===
// Buy → new upward range line started
buySignal  = newUpShift

// Sell → new downward range line started
sellSignal = newDownShift

// === RANGE LINE COLOR ===
lineColor = close >= level ? color.green : color.red
plot(level, color=lineColor, linewidth=2, title="Fixed Step Line")

// === PLOT SIGNALS ===
plotshape(buySignal,
     title="Buy",
     style=shape.triangleup,
     location=location.belowbar,
     color=color.green,
     size=size.small,
     text="BUY")

plotshape(sellSignal,
     title="Sell",
     style=shape.triangledown,
     location=location.abovebar,
     color=color.red,
     size=size.small,
     text="SELL")

// === TARGET T1 LOGIC ===
var float t1Level = na
var bool  t1Active = false
var int   tradeDirection = 0   // 1 = Buy, -1 = Sell

if enableT1
    if buySignal
        tradeDirection := 1
        t1Level := close + t1Distance
        t1Active := true

    if sellSignal
        tradeDirection := -1
        t1Level := close - t1Distance
        t1Active := true

// T1 HIT CONDITIONS
t1HitBuy  = t1Active and tradeDirection == 1 and high >= t1Level
t1HitSell = t1Active and tradeDirection == -1 and low <= t1Level

if t1HitBuy or t1HitSell
    t1Active := false

// Plot T1 line
plot(enableT1 and t1Active ? t1Level : na,
     title="Target T1",
     color=color.blue,
     linewidth=2,
     style=plot.style_linebr)

// Plot T1 hit markers
plotshape(t1HitBuy,
     title="T1 Hit Buy",
     location=location.abovebar,
     color=color.blue,
     style=shape.circle,
     size=size.small,
     text="T1")

plotshape(t1HitSell,
     title="T1 Hit Sell",
     location=location.belowbar,
     color=color.blue,
     style=shape.circle,
     size=size.small,
     text="T1")

// === ALERTS ===
alertcondition(buySignal,
     title="Buy Alert",
     message="New UP Range Line Started")

alertcondition(sellSignal,
     title="Sell Alert",
     message="New DOWN Range Line Started")

alertcondition(t1HitBuy,
     title="T1 Hit (Buy)",
     message="Target T1 HIT for BUY trade")

alertcondition(t1HitSell,
     title="T1 Hit (Sell)",
     message="Target T1 HIT for SELL trade")
