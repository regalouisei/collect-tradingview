// This Pine Script™ code is subject to the terms of the Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0) https://creativecommons.org/licenses/by-nc-sa/4.0/
// © UAlgo
//@version=6
indicator("Donchian Ribbon [UAlgo]", overlay = true)

// ==========================================
// ─── TYPE DEFINITIONS ─────────────────────
// ==========================================

// Defines a Donchian Channel object with its parameters and state
type DonchianChannel
    int   length
    float high   = na
    float low    = na
    float mid    = na
    color c_high = na
    color c_low  = na

// ==========================================
// ─── METHODS ──────────────────────────────
// ==========================================

// Method to update the Donchian Channel values
method update(DonchianChannel id) =>
    // Calculate High and Low for the given length
    // We use 'nz' to handle cases where there might not be enough data yet
    id.high := ta.highest(id.length)
    id.low  := ta.lowest(id.length)
    id.mid  := math.avg(id.high, id.low)

// ==========================================
// ─── INPUTS ───────────────────────────────
// ==========================================

grp_sett = "Settings"
int base_length = input.int(20, "Base Length", group = grp_sett)
int step_length = input.int(5,  "Step Length", group = grp_sett)
int ribbon_count = 5 // Fixed number of ribbon bands for plotting

grp_col = "Colors"
color col_upper = input.color(color.rgb(0, 255, 255), "Upper Tone", group = grp_col) // Cyan / Neon Blue
color col_lower = input.color(color.rgb(255, 0, 255), "Lower Tone", group = grp_col) // Magenta / Neon Purple

// ==========================================
// ─── MAIN LOGIC ───────────────────────────
// ==========================================

// Initialize an array to hold our Donchian Channel objects
// using the 'var' keyword so it persists across bars
var array<DonchianChannel> channels = array.new<DonchianChannel>()

// Populate the array on the first bar only
if bar_index == 0
    for i = 0 to ribbon_count - 1
        // Create new instances with increasing lengths
        int len = base_length + (i * step_length)
        channels.push(DonchianChannel.new(len))

// Execute the update method for each channel in the array using a loop
// This demonstrates the use of arrays and methods for iterative logic
for dc in channels
    dc.update()

// ==========================================
// ─── VISUALIZATION ────────────────────────
// ==========================================

// Extract specific channels for plotting (0 is shortest, last is longest)
DonchianChannel dc_fast = channels.get(0)
DonchianChannel dc_mid1 = channels.get(1)
DonchianChannel dc_mid2 = channels.get(2)
DonchianChannel dc_mid3 = channels.get(3)
DonchianChannel dc_slow = channels.get(4)

// Plot the lines (transparent, we only want the fills to be prominent)
p_fast_high = plot(dc_fast.high, "Fast High", color = color.new(col_upper, 80), display = display.none)
p_fast_low  = plot(dc_fast.low,  "Fast Low",  color = color.new(col_lower, 80), display = display.none)

p_mid1_high = plot(dc_mid1.high, "Mid1 High", display = display.none)
p_mid1_low  = plot(dc_mid1.low,  "Mid1 Low",  display = display.none)

p_mid2_high = plot(dc_mid2.high, "Mid2 High", display = display.none)
p_mid2_low  = plot(dc_mid2.low,  "Mid2 Low",  display = display.none)

p_mid3_high = plot(dc_mid3.high, "Mid3 High", display = display.none)
p_mid3_low  = plot(dc_mid3.low,  "Mid3 Low",  display = display.none)

p_slow_high = plot(dc_slow.high, "Slow High", color = color.new(col_upper, 50))
p_slow_low  = plot(dc_slow.low,  "Slow Low",  color = color.new(col_lower, 50))

// Create the gradient ribbon effect using multiple fills
// We mix the upper and lower colors to create a transition
fill(p_fast_high, p_mid1_high, color.new(col_upper, 90), "Ribbon Upper 1")
fill(p_mid1_high, p_mid2_high, color.new(col_upper, 80), "Ribbon Upper 2")
fill(p_mid2_high, p_mid3_high, color.new(col_upper, 70), "Ribbon Upper 3")
fill(p_mid3_high, p_slow_high, color.new(col_upper, 60), "Ribbon Upper 4")

fill(p_fast_low,  p_mid1_low,  color.new(col_lower, 90), "Ribbon Lower 1")
fill(p_mid1_low,  p_mid2_low,  color.new(col_lower, 80), "Ribbon Lower 2")
fill(p_mid2_low,  p_mid3_low,  color.new(col_lower, 70), "Ribbon Lower 3")
fill(p_mid3_low,  p_slow_low,  color.new(col_lower, 60), "Ribbon Lower 4")

// Plot the main trend line based on the slowest channel's midpoint
plot(dc_slow.mid, "Trend Baseline", color = color.from_gradient(0.5, 0, 1, col_lower, col_upper), linewidth = 2)
