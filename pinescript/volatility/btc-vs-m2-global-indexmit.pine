//@version=6
indicator('BTC M2 Global Deviation[MIT]', 
     overlay=false, 
     scale=scale.left)   // ← 已修复：改成 scale.left

// ================== 输入参数 ==================
offsetOption = input.string("108 Days", options=["108 Days", "78 Days"], title="Offset:")
offsetValue  = offsetOption == "108 Days" ? 108 : 78

erweitert = input.bool(false, title="Include extended currencies?", 
     tooltip="Standard: USA, China, Eurozone, Japan, UK\nExtended: + Switzerland, Canada, India, Russia, Brazil, Korea, Mexico, South Africa")

normLength = input.int(200, "归一化周期（天）", minval=50, maxval=500)
showNormLines = input.bool(true,  "显示归一化后的M2和BTC曲线")
showDeviation = input.bool(true,  "显示偏差 (M2 - BTC)")
devStyle      = input.string("Columns", "偏差显示样式", options=["Columns", "Area", "Line"])

// ================== 数据获取 ==================
cnm2   = request.security("ECONOMICS:CNM2",   "D", close)
cnyusd = request.security("FX_IDC:CNYUSD",    "D", close)
usm2   = request.security("ECONOMICS:USM2",   "D", close)
eum2   = request.security("ECONOMICS:EUM2",   "D", close)
eurusd = request.security("FX:EURUSD",        "D", close)
jpm2   = request.security("ECONOMICS:JPM2",   "D", close)
jpyusd = request.security("FX_IDC:JPYUSD",    "D", close)
gbm2   = request.security("ECONOMICS:GBM2",   "D", close)
gbpusd = request.security("FX:GBPUSD",        "D", close)

// 扩展货币组
chm2   = request.security("ECONOMICS:CHM2",   "D", close)
chfusd = request.security("FX_IDC:CHFUSD",    "D", close)
cam2   = request.security("ECONOMICS:CAM2",   "D", close)
cadusd = request.security("FX_IDC:CADUSD",    "D", close)
inm2   = request.security("ECONOMICS:INM2",   "D", close)
inrusd = request.security("FX_IDC:INRUSD",    "D", close)
rum2   = request.security("ECONOMICS:RUM2",   "D", close)
rublusd= request.security("FX_IDC:RUBUSD",    "D", close)
brm2   = request.security("ECONOMICS:BRM2",   "D", close)
brlusd = request.security("FX_IDC:BRLUSD",    "D", close)
krm2   = request.security("ECONOMICS:KRM2",   "D", close)
krwusd = request.security("FX_IDC:KRWUSD",    "D", close)
mxm2   = request.security("ECONOMICS:MXM2",   "D", close)
mxnusd = request.security("FX_IDC:MXNUSD",    "D", close)
sam2   = request.security("ECONOMICS:SAM2",   "D", close)
zarusd = request.security("FX_IDC:ZARUSD",    "D", close)

// 计算 M2 Total
basisTotal = cnm2 * cnyusd + usm2 + eum2 * eurusd + jpm2 * jpyusd + gbm2 * gbpusd
erweitertTotal = basisTotal + chm2*chfusd + cam2*cadusd + inm2*inrusd + rum2*rublusd + 
                 brm2*brlusd + krm2*krwusd + mxm2*mxnusd + sam2*zarusd

total = erweitert ? erweitertTotal : basisTotal

// BTC
btc = request.security("BINANCE:BTCUSDT", timeframe.period, close)

// ================== 归一化处理 ==================
normM2  = total / ta.sma(total, normLength)
normBTC = btc   / ta.sma(btc,   normLength)
deviation = normM2 - normBTC

// 偏差颜色
devColor = deviation > 0 ? color.new(color.lime, 0) : color.new(color.red, 0)

// ================== 绘图 ==================
// 归一化曲线
plot(showNormLines ? normM2  : na, "Normalized M2",  color=color.yellow, linewidth=3, offset=offsetValue)
plot(showNormLines ? normBTC : na, "Normalized BTC", color=color.white,  linewidth=2, offset=offsetValue)

// 偏差（全局绘制）
devPlotStyle = devStyle == "Columns" ? plot.style_columns :
               devStyle == "Area"    ? plot.style_area    : plot.style_line

devLineWidth = devStyle == "Columns" ? 3 : 2

plot(showDeviation ? deviation : na, 
     "M2 vs BTC deviation", 
     color=devColor, 
     style=devPlotStyle, 
     linewidth=devLineWidth)

// 参考线
hline(1.0, "归一化基准线", color=color.gray, linestyle=hline.style_dashed)
hline(0.0, "偏差零轴",     color=color.gray, linestyle=hline.style_dotted)

// 最后一个K线标签
if barstate.islast
    label.new(bar_index, normM2, 
         "Norm M2: " + str.format("{0,number,#.##}", normM2) + 
         "\nNorm BTC: " + str.format("{0,number,#.##}", normBTC) +
         "\Deviation: " + str.format("{0,number,+0.##}", deviation),
         style = label.style_label_left,
         color = color.new(color.blue, 70),
         textcolor = color.white,
         size  = size.small)
