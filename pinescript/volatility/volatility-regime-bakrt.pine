//@version=5
indicator("Volatility Regime Table (Option B)", overlay=true)

atrLen   = input.int(14,  "ATR Length", minval=1)
medLen   = input.int(300, "Median Lookback (bars)", minval=10)
lowMult  = input.float(0.8, "Low Threshold = Median ×", minval=0.01, step=0.05)
highMult = input.float(1.2, "High Threshold = Median ×", minval=0.01, step=0.05)

atr = ta.atr(atrLen)
atrPct = 100.0 * atr / close

// Rolling median via percentile(50)
medAtrPct = ta.percentile_linear_interpolation(atrPct, medLen, 50)
lowThr = medAtrPct * lowMult
highThr = medAtrPct * highMult

regime = na(medAtrPct) ? "(warming up)" : atrPct < lowThr ? "LOW" : atrPct > highThr ? "HIGH" : "MEDIUM"
regimeColor = regime == "LOW" ? color.new(color.green, 0) : regime == "MEDIUM" ? color.new(color.gray, 0) : regime == "HIGH" ? color.new(color.red, 0) : color.new(color.silver, 0)

fmtPct(x) => na(x) ? "na" : str.tostring(x, "#.###") + "%"

var table t = table.new(position.top_right, 2, 5, frame_width=1)

if barstate.islast
    table.cell(t, 0, 0, "Volatility", text_color=color.white, bgcolor=color.new(color.black, 0))
    table.cell(t, 1, 0, regime, text_color=color.white, bgcolor=regimeColor)

    table.cell(t, 0, 1, "ATR%", text_color=color.white, bgcolor=color.new(color.black, 0))
    table.cell(t, 1, 1, fmtPct(atrPct), text_color=color.white, bgcolor=color.new(color.black, 0))

    table.cell(t, 0, 2, "Median ATR%", text_color=color.white, bgcolor=color.new(color.black, 0))
    table.cell(t, 1, 2, fmtPct(medAtrPct), text_color=color.white, bgcolor=color.new(color.black, 0))

    table.cell(t, 0, 3, "Low <", text_color=color.white, bgcolor=color.new(color.black, 0))
    table.cell(t, 1, 3, fmtPct(lowThr), text_color=color.white, bgcolor=color.new(color.black, 0))

    table.cell(t, 0, 4, "High >", text_color=color.white, bgcolor=color.new(color.black, 0))
    table.cell(t, 1, 4, fmtPct(highThr), text_color=color.white, bgcolor=color.new(color.black, 0))
