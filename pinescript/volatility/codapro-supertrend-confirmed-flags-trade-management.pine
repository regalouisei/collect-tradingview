// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © CodaPro LLC

// ═══════════════════════════════════════════════════════════════════════════════
// DISCLAIMER
// ═══════════════════════════════════════════════════════════════════════════════
// This tool was created using the CodaPro Pine Script AI engine — designed to
// produce robust trading overlays, educational visuals, and automation-ready
// alerts. It is provided strictly for educational and informational purposes
// and does not constitute financial advice. Past performance does not guarantee
// future results. Always backtest and demo before applying to real capital.
// Use at your own risk. Created by Aris | CodaPro Engine
// ═══════════════════════════════════════════════════════════════════════════════


//@version=6
indicator("[CodaPro] Supertrend Confirmed Flags + Trade Management [Signals]", overlay=true, max_lines_count=500, max_labels_count=500)

// ──── SUPERTREND INPUTS ────
src            = input.source(hl2, "Source", group="Supertrend")
atrLen         = input.int(14, "ATR Length", minval=1, group="Supertrend")
mult           = input.float(3.0, "ATR Multiplier", minval=0.1, step=0.1, group="Supertrend")
confirmBars    = input.int(2, "Confirmation Bars After Flip", minval=0, maxval=20, group="Supertrend")

// ──── TRADE MANAGEMENT INPUTS ────
enableTM       = input.bool(true, "Enable Trade Management Overlay", group="Trade Management")
tpPct          = input.float(0.15, "Take Profit %", step=0.01, group="Trade Management")
slPct          = input.float(0.10, "Stop Loss %", step=0.01, group="Trade Management")
maxBarsInput   = input.int(80, "Max Bars in Trade", minval=5, group="Trade Management")
cooldownLen    = input.int(10, "Cooldown Bars After Exit", minval=1, group="Trade Management")

// ──── EOD EXIT ────
enableEOD      = input.bool(true, "Enable EOD Exit", group="End of Day")
eodHour        = input.int(16, "EOD Hour", minval=0, maxval=23, group="End of Day")
eodMinute      = input.int(40, "EOD Minute", minval=0, maxval=59, group="End of Day")

// ──── VISUAL INPUTS ────
showStopLine   = input.bool(true, "Show Supertrend Stop Line", group="Visuals")
stopLineWidth  = input.int(2, "Stop Line Width", minval=1, maxval=5, group="Visuals")
showFlags      = input.bool(true, "Show Confirmed Flip Flags", group="Visuals")
buyColor       = input.color(color.lime, "Bullish (Buy) Color", group="Visuals")
shortColor     = input.color(color.red, "Bearish (Short) Color", group="Visuals")
flagTextColor  = input.color(color.white, "Flag Text Color", group="Visuals")
flagSizeOpt    = input.string("Small", "Flag Size", options=["Tiny", "Small", "Normal", "Large"], group="Visuals")
tpColor        = input.color(color.new(#00E676, 30), "TP Line Color", group="Visuals")
slColor        = input.color(color.new(#FF1744, 30), "SL Line Color", group="Visuals")

// ──── SUPERTREND CALCULATION ────
atr = ta.atr(atrLen)
upperBasic = src + mult * atr
lowerBasic = src - mult * atr

float upperFinal = na
float lowerFinal = na

upperFinal := na(upperFinal[1]) ? upperBasic : ((upperBasic < upperFinal[1] or close[1] > upperFinal[1]) ? upperBasic : upperFinal[1])
lowerFinal := na(lowerFinal[1]) ? lowerBasic : ((lowerBasic > lowerFinal[1] or close[1] < lowerFinal[1]) ? lowerBasic : lowerFinal[1])

int dir = na
dir := na(dir[1]) ? 1 : dir[1]
dir := dir == 1 and close < lowerFinal[1] ? -1 :
       dir == -1 and close > upperFinal[1] ? 1 : dir

float supertrend = dir == 1 ? lowerFinal : upperFinal
isBull = dir == 1
isBear = dir == -1

// ──── FLIP DETECTION + CONFIRMATION ────
flipToBear = isBear and isBull[1]
flipToBull = isBull and isBear[1]

bearConfirmed = flipToBear[confirmBars + 1]
bullConfirmed = flipToBull[confirmBars + 1]

// ──── TRADE STATE MACHINE ────
var int tradeDir = 0          // 0 = flat, 1 = long, -1 = short
var float entryPrice = na
var float tpLevel = na
var float slLevel = na
var int entryBar = 0
var int exitBar = -999
var line tpLine = na
var line slLine = na
var label exitLabel = na

isEOD = enableEOD and (hour == eodHour and minute >= eodMinute or hour > eodHour)
isFlat = tradeDir == 0
cooldownOK = (bar_index - exitBar) >= cooldownLen

// ──── SIGNAL CONDITIONS ────
buySignal  = bullConfirmed and isFlat and cooldownOK and not isEOD and barstate.isconfirmed and enableTM
sellSignal = bearConfirmed and isFlat and cooldownOK and not isEOD and barstate.isconfirmed and enableTM

// Raw signals (no trade management — for flag display when TM is off)
buyRaw  = bullConfirmed and barstate.isconfirmed
sellRaw = bearConfirmed and barstate.isconfirmed

// ──── ENTRY LOGIC ────
if buySignal
    tradeDir := 1
    entryPrice := close
    tpLevel := close * (1 + tpPct / 100)
    slLevel := close * (1 - slPct / 100)
    entryBar := bar_index
    // Draw TP/SL lines
    if not na(tpLine)
        line.delete(tpLine)
    if not na(slLine)
        line.delete(slLine)
    tpLine := line.new(bar_index, tpLevel, bar_index + maxBarsInput, tpLevel, color=tpColor, style=line.style_dashed, width=1)
    slLine := line.new(bar_index, slLevel, bar_index + maxBarsInput, slLevel, color=slColor, style=line.style_dashed, width=1)

if sellSignal
    tradeDir := -1
    entryPrice := close
    tpLevel := close * (1 - tpPct / 100)
    slLevel := close * (1 + slPct / 100)
    entryBar := bar_index
    if not na(tpLine)
        line.delete(tpLine)
    if not na(slLine)
        line.delete(slLine)
    tpLine := line.new(bar_index, tpLevel, bar_index + maxBarsInput, tpLevel, color=tpColor, style=line.style_dashed, width=1)
    slLine := line.new(bar_index, slLevel, bar_index + maxBarsInput, slLevel, color=slColor, style=line.style_dashed, width=1)

// ──── EXIT LOGIC ────
string exitReason = ""

if tradeDir == 1 and not na(tpLevel) and barstate.isconfirmed
    if high >= tpLevel
        exitReason := "TP HIT"
    else if low <= slLevel
        exitReason := "SL HIT"
    else if (bar_index - entryBar) >= maxBarsInput
        exitReason := "MAX BARS"
    else if isEOD
        exitReason := "EOD EXIT"

if tradeDir == -1 and not na(tpLevel) and barstate.isconfirmed
    if low <= tpLevel
        exitReason := "TP HIT"
    else if high >= slLevel
        exitReason := "SL HIT"
    else if (bar_index - entryBar) >= maxBarsInput
        exitReason := "MAX BARS"
    else if isEOD
        exitReason := "EOD EXIT"

// ──── PROCESS EXIT ────
if exitReason != ""
    exitBar := bar_index
    // Clean up lines
    if not na(tpLine)
        line.delete(tpLine)
        tpLine := na
    if not na(slLine)
        line.delete(slLine)
        slLine := na
    // Exit label — TP pops big (CodaPro teal), others stay subtle
    bool isTP = str.contains(exitReason, "TP")
    exitLabel := label.new(bar_index, tradeDir == 1 ? low : high,
         exitReason,
         style=tradeDir == 1 ? label.style_label_up : label.style_label_down,
         color=isTP ? color.new(#00BCD4, 0) : color.new(#555555, 40),
         textcolor=isTP ? color.white : color.new(#ffffff, 30),
         size=isTP ? size.normal : size.tiny)
    tradeDir := 0
    entryPrice := na
    tpLevel := na
    slLevel := na

// ──── SUPERTREND LINE ────
stColor = isBull ? buyColor : shortColor
plot(showStopLine ? supertrend : na, "Supertrend Stop", color=stColor, linewidth=stopLineWidth, style=plot.style_line)

// ──── FLAG SIGNALS ────
// When TM enabled: show flags only on valid trade signals
// When TM disabled: show all confirmed flips (original behavior)
showBear = enableTM ? sellSignal : (showFlags and bearConfirmed)
showBull = enableTM ? buySignal : (showFlags and bullConfirmed)

bearTiny   = showBear and flagSizeOpt == "Tiny"
bearSmall  = showBear and flagSizeOpt == "Small"
bearNormal = showBear and flagSizeOpt == "Normal"
bearLarge  = showBear and flagSizeOpt == "Large"

bullTiny   = showBull and flagSizeOpt == "Tiny"
bullSmall  = showBull and flagSizeOpt == "Small"
bullNormal = showBull and flagSizeOpt == "Normal"
bullLarge  = showBull and flagSizeOpt == "Large"

plotshape(bearTiny,   title="Short Flag (Tiny)",   style=shape.flag, location=location.abovebar, color=shortColor, text="short", textcolor=flagTextColor, size=size.tiny)
plotshape(bearSmall,  title="Short Flag (Small)",  style=shape.flag, location=location.abovebar, color=shortColor, text="short", textcolor=flagTextColor, size=size.small)
plotshape(bearNormal, title="Short Flag (Normal)", style=shape.flag, location=location.abovebar, color=shortColor, text="short", textcolor=flagTextColor, size=size.normal)
plotshape(bearLarge,  title="Short Flag (Large)",  style=shape.flag, location=location.abovebar, color=shortColor, text="short", textcolor=flagTextColor, size=size.large)

plotshape(bullTiny,   title="Buy Flag (Tiny)",     style=shape.flag, location=location.belowbar, color=buyColor, text="buy", textcolor=flagTextColor, size=size.tiny)
plotshape(bullSmall,  title="Buy Flag (Small)",    style=shape.flag, location=location.belowbar, color=buyColor, text="buy", textcolor=flagTextColor, size=size.small)
plotshape(bullNormal, title="Buy Flag (Normal)",   style=shape.flag, location=location.belowbar, color=buyColor, text="buy", textcolor=flagTextColor, size=size.normal)
plotshape(bullLarge,  title="Buy Flag (Large)",    style=shape.flag, location=location.belowbar, color=buyColor, text="buy", textcolor=flagTextColor, size=size.large)

// ──── ALERTS ────
alertcondition(buySignal or buyRaw, "Confirmed Buy", "Supertrend confirmed bullish flip")
alertcondition(sellSignal or sellRaw, "Confirmed Sell", "Supertrend confirmed bearish flip")
