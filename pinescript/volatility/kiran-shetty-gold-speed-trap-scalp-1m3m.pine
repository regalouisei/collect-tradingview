//@version=6
indicator("Gemini Gold Speed-Trap [Scalp 1m/3m]", overlay=true, max_lines_count=500)

// ——————————————————————————————————————————————————————————————————————————————
// INPUTS - TUNED FOR FREQUENCY
// ——————————————————————————————————————————————————————————————————————————————
grpScalp   = "Scalp Sensitivity"
microLen   = input.int(20, "Micro-Range Lookback", minval=10, group=grpScalp, tooltip="Lower = More Signals")
stretch    = input.float(3.5, "POC Deviation ($)", group=grpScalp, tooltip="How far from POC before looking for reversal")

grpBias    = "Trend Filter"
use4H      = input.bool(false, "Strict 4H Filter?", group=grpBias, tooltip="Turn OFF to take all signals")
htf_period = input.timeframe("240", "4H Timeframe", group=grpBias)

grpMgmt    = "70/30 Profit Management"
tp1_usd    = input.float(4.0, "TP1 ($) - Close 70%", group=grpMgmt)
tp2_usd    = input.float(8.0, "TP2 ($) - Runner", group=grpMgmt)
sl_usd     = input.float(3.0, "Stop Loss ($)", group=grpMgmt)

// ——————————————————————————————————————————————————————————————————————————————
// CALCULATIONS
// ——————————————————————————————————————————————————————————————————————————————
// 1. POC / Mean (Using VWAP as the anchor)
poc = ta.vwap(close)

// 2. 4H Trend (Visual Only if Strict is OFF)
htf_ema = request.security(syminfo.tickerid, htf_period, ta.ema(close, 200)[1], gaps=barmerge.gaps_off)
is_htf_up = close > htf_ema

// 3. Micro-Liquidity (Looking at the very recent price action)
mHigh = ta.highest(high[1], microLen)
mLow  = ta.lowest(low[1], microLen)

// ——————————————————————————————————————————————————————————————————————————————
// SPEED-TRAP CONDITIONS
// ——————————————————————————————————————————————————————————————————————————————
// Long: Price is stretched BELOW POC + Sweeps Micro Low + RSI Oversold (Quick)
is_stretched_dn = (poc - low) >= stretch
long_sweep      = low < mLow and close > mLow
rsi_fast        = ta.rsi(close, 7)

long_signal  = is_stretched_dn and long_sweep and rsi_fast < 40 and (not use4H or is_htf_up)

// Short: Price is stretched ABOVE POC + Sweeps Micro High + RSI Overbought
is_stretched_up = (high - poc) >= stretch
short_sweep     = high > mHigh and close < mHigh

short_signal = is_stretched_up and short_sweep and rsi_fast > 60 and (not use4H or not is_htf_up)

// ——————————————————————————————————————————————————————————————————————————————
// VISUALS
// ——————————————————————————————————————————————————————————————————————————————
// Plot POC and Deviation Bands
plot(poc, "Volume POC", color.new(color.orange, 50), 2)
p_top = plot(poc + stretch, "Upper Trap", color.new(color.red, 80))
p_bot = plot(poc - stretch, "Lower Trap", color.new(color.lime, 80))
fill(p_top, p_bot, color.new(color.gray, 95))

// Signal Arrows
plotshape(long_signal,  "Buy",  shape.triangleup,   location.belowbar, color.lime, size=size.small)
plotshape(short_signal, "Sell", shape.triangledown, location.abovebar, color.red,  size=size.small)

// Scalp Labels
if long_signal
    label.new(bar_index, low, "BUY\nTP1: " + str.tostring(close + tp1_usd, "#.#"), color=color.lime, style=label.style_label_up, size=size.small)

if short_signal
    label.new(bar_index, high, "SELL\nTP1: " + str.tostring(close - tp1_usd, "#.#"), color=color.red, style=label.style_label_down, size=size.small)
