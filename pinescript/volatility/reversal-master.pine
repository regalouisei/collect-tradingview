// Reversal Master

//@version=6

indicator("Reversal Master", shorttitle="Reversal Master",
 overlay=true, format=format.inherit, max_lines_count=500,
 max_labels_count=500)

//************************************************************************************************************
// Internal Settings
//************************************************************************************************************

source       = hlc3
filter_type  = "Precision Smooth"
length       = 200
innermult    = 1.0
outermult    = 2.415
show_bb      = true
bb_length    = 20
bb_mult      = 2.0
bb_src       = close
show_rsi     = true
rsi_length   = 14
rsi_src      = close
rsi_ob       = 70
rsi_os       = 30
drawchannel  = true
displayzone  = true
zonetransp   = 60

//************************************************************************************************************
// Functions
//************************************************************************************************************

var mult      = math.pi * innermult
var mult2     = math.pi * outermult
var gradsize  = 0.5
var gradtransp = zonetransp

SAK_smoothing(_type, _src, _length) =>
    c0 = 1.0, c1 = 0.0, b0 = 1.0, b1 = 0.0, b2 = 0.0, a1 = 0.0, a2 = 0.0
    alpha = 0.0, beta = 0.0, gamma = 0.0
    cycle = 2 * math.pi / _length

    if _type == "Adaptive EMA"
        alpha := (math.cos(cycle) + math.sin(cycle) - 1) / math.cos(cycle)
        b0 := alpha, a1 := 1 - alpha

    if _type == "Gaussian"
        beta  := 2.415 * (1 - math.cos(cycle))
        alpha := -beta + math.sqrt((beta * beta) + (2 * beta))
        c0 := alpha * alpha, a1 := 2 * (1 - alpha), a2 := -(1 - alpha) * (1 - alpha)

    if _type == "Butterworth"
        beta  := 2.415 * (1 - math.cos(cycle))
        alpha := -beta + math.sqrt((beta * beta) + (2 * beta))
        c0 := alpha * alpha / 4, b1 := 2, b2 := 1
        a1 := 2 * (1 - alpha), a2 := -(1 - alpha) * (1 - alpha)

    if _type == "BandStop"
        beta  := math.cos(cycle)
        gamma := 1 / math.cos(cycle * 2 * 0.1)
        alpha := gamma - math.sqrt((gamma * gamma) - 1)
        c0 := (1 + alpha) / 2, b1 := -2 * beta, b2 := 1
        a1 := beta * (1 + alpha), a2 := -alpha

    if _type == "SMA"
        c1 := 1 / _length, b0 := 1 / _length, a1 := 1

    if _type == "EMA"
        alpha := 2 / (_length + 1), b0 := alpha, a1 := 1 - alpha

    if _type == "RMA"
        alpha := 1 / _length, b0 := alpha, a1 := 1 - alpha

    _Input  = _src
    _Output = 0.0
    _Output := (c0 * ((b0 * _Input) + (b1 * nz(_Input[1])) + (b2 * nz(_Input[2])))) + (a1 * nz(_Output[1])) + (a2 * nz(_Output[2])) - (c1 * nz(_Input[_length]))

precision_smooth(_src, _length) =>
    s_a1 = math.exp(-math.sqrt(2) * math.pi / _length)
    s_b1 = 2 * s_a1 * math.cos(math.sqrt(2) * math.pi / _length)
    s_c3 = -math.pow(s_a1, 2), s_c2 = s_b1, s_c1 = 1 - s_c2 - s_c3
    ss = 0.0
    ss := s_c1 * _src + s_c2 * nz(ss[1], _src[1]) + s_c3 * nz(ss[2], _src[2])

get_cw() =>
    v_condition   = 0
    v_centerline  = source
    v_windowrange = precision_smooth(ta.tr, length)

    if filter_type == "Precision Smooth"
        v_centerline := precision_smooth(source, length)

    if filter_type != "Precision Smooth"
        v_centerline := SAK_smoothing(filter_type, source, length)

    v_bear_inner = v_centerline + (v_windowrange * mult)
    v_bull_inner = v_centerline - (v_windowrange * mult)
    v_bear_cw    = v_centerline + (v_windowrange * mult2)
    v_bull_cw    = v_centerline - (v_windowrange * mult2)

    if close > v_centerline
        v_bear_cw_upper = v_bear_cw + (v_windowrange * gradsize * 4)
        v_bear_cw_lower = v_bear_cw + (v_windowrange * gradsize * -4)
        if high >= v_bear_cw_lower and high < v_bear_cw
            v_condition := 1
        else if high >= v_bear_cw and high < v_bear_cw_upper
            v_condition := 2
        else if high >= v_bear_cw_upper
            v_condition := 3
        else if close <= v_centerline + v_windowrange
            v_condition := 4
        else
            v_condition := 5

    if close < v_centerline
        v_bull_cw_lower = v_bull_cw - (v_windowrange * gradsize * 4)
        v_bull_cw_upper = v_bull_cw - (v_windowrange * gradsize * -4)
        if low <= v_bull_cw_upper and low > v_bull_cw
            v_condition := -1
        else if low <= v_bull_cw and low > v_bull_cw_lower
            v_condition := -2
        else if low <= v_bull_cw_lower
            v_condition := -3
        else if close >= v_centerline + v_windowrange
            v_condition := -4
        else
            v_condition := -5

    [v_centerline, v_windowrange, v_bear_inner, v_bull_inner, v_bear_cw, v_bull_cw, v_condition]

//************************************************************************************************************
// Calculate Confidence Window
//************************************************************************************************************

[centerline, windowrange, bear_inner, bull_inner, bear_cw, bull_cw, condition] = get_cw()

//************************************************************************************************************
// Calculate Bollinger Bands
//************************************************************************************************************

bb_basis = ta.sma(bb_src, bb_length)
bb_dev   = bb_mult * ta.stdev(bb_src, bb_length)
bb_upper = bb_basis + bb_dev
bb_lower = bb_basis - bb_dev

//************************************************************************************************************
// Calculate RSI
//************************************************************************************************************

rsi_value = ta.rsi(rsi_src, rsi_length)

//************************************************************************************************************
// Reversal Alert â€” single condition for both bear and bull
//************************************************************************************************************

bear_g9 = bear_cw + (windowrange * gradsize * -4)
bull_g9 = bull_cw - (windowrange * gradsize * -4)

bear_reversal = ta.crossover(high[1], bear_g9[1])
bull_reversal = ta.crossunder(low[1], bull_g9[1])

reversal_msg = bear_reversal ? "ðŸ”´ " + syminfo.ticker + " " + timeframe.period + " â€” Possible Bear Reversal" : "ðŸŸ¢ " + syminfo.ticker + " " + timeframe.period + " â€” Possible Bull Reversal"

if barstate.isconfirmed and (bear_reversal or bull_reversal)
    alert(reversal_msg, alert.freq_once_per_bar_close)

//************************************************************************************************************
// Drawing
//************************************************************************************************************

float p_centerline = drawchannel ? centerline : na
float p_bear_inner = drawchannel ? bear_inner : na
float p_bull_inner = drawchannel ? bull_inner : na
float p_bear_cw    = drawchannel ? bear_cw : na
float p_bull_cw    = drawchannel ? bull_cw : na

z  = plot(p_centerline, color=#00E676, style=plot.style_line, title="Center", linewidth=2, editable=false)
x1 = plot(p_bear_inner, color=color.new(#69F0AE, 50), style=plot.style_circles, title="Bear Inner", linewidth=1, editable=false)
x2 = plot(p_bull_inner, color=color.new(#69F0AE, 50), style=plot.style_circles, title="Bull Inner", linewidth=1, editable=false)
y1 = plot(p_bear_cw, color=color.new(#00C853, 50), style=plot.style_line, title="Bear Confidence Window", linewidth=1, editable=false)
y2 = plot(p_bull_cw, color=color.new(#00C853, 50), style=plot.style_line, title="Bull Confidence Window", linewidth=1, editable=false)

float p_bb_basis = show_bb ? bb_basis : na
float p_bb_upper = show_bb ? bb_upper : na
float p_bb_lower = show_bb ? bb_lower : na

bb_mid_plot = plot(p_bb_basis, color=#42A5F5, style=plot.style_line, title="BB Basis", linewidth=1, editable=false)
bb_up_plot  = plot(p_bb_upper, color=#90CAF9, style=plot.style_line, title="BB Upper", linewidth=1, editable=false)
bb_lo_plot  = plot(p_bb_lower, color=#90CAF9, style=plot.style_line, title="BB Lower", linewidth=1, editable=false)

fill(bb_up_plot, bb_lo_plot, color=show_bb ? color.new(#42A5F5, 92) : na, title="BB Fill", editable=false)

// â”€â”€ Gradient confidence zones â”€â”€

var color1 = #1B5E20
var color2 = #2E7D32
var color3 = #388E3C
var color4 = #43A047
var color5 = #4CAF50
var color6 = #66BB6A
var color7 = #81C784
var color8 = #A5D6A7

float bear_cw_g1 = drawchannel and displayzone ? bear_cw + (windowrange * gradsize * 4) : na
float bull_cw_g1 = drawchannel and displayzone ? bull_cw - (windowrange * gradsize * 4) : na
float bear_cw_g2 = drawchannel and displayzone ? bear_cw + (windowrange * gradsize * 3) : na
float bull_cw_g2 = drawchannel and displayzone ? bull_cw - (windowrange * gradsize * 3) : na
float bear_cw_g3 = drawchannel and displayzone ? bear_cw + (windowrange * gradsize * 2) : na
float bull_cw_g3 = drawchannel and displayzone ? bull_cw - (windowrange * gradsize * 2) : na
float bear_cw_g4 = drawchannel and displayzone ? bear_cw + (windowrange * gradsize * 1) : na
float bull_cw_g4 = drawchannel and displayzone ? bull_cw - (windowrange * gradsize * 1) : na
float bear_cw_g5 = drawchannel and displayzone ? bear_cw + (windowrange * gradsize * 0) : na
float bull_cw_g5 = drawchannel and displayzone ? bull_cw - (windowrange * gradsize * 0) : na
float bear_cw_g6 = drawchannel and displayzone ? bear_cw + (windowrange * gradsize * -1) : na
float bull_cw_g6 = drawchannel and displayzone ? bull_cw - (windowrange * gradsize * -1) : na
float bear_cw_g7 = drawchannel and displayzone ? bear_cw + (windowrange * gradsize * -2) : na
float bull_cw_g7 = drawchannel and displayzone ? bull_cw - (windowrange * gradsize * -2) : na
float bear_cw_g8 = drawchannel and displayzone ? bear_cw + (windowrange * gradsize * -3) : na
float bull_cw_g8 = drawchannel and displayzone ? bull_cw - (windowrange * gradsize * -3) : na
float bear_cw_g9 = drawchannel and displayzone ? bear_cw + (windowrange * gradsize * -4) : na
float bull_cw_g9 = drawchannel and displayzone ? bull_cw - (windowrange * gradsize * -4) : na

plot_bear_cw_g1 = plot(bear_cw_g1, color=na, editable=false, display=display.none)
plot_bull_cw_g1 = plot(bull_cw_g1, color=na, editable=false, display=display.none)
plot_bear_cw_g2 = plot(bear_cw_g2, color=na, editable=false, display=display.none)
plot_bull_cw_g2 = plot(bull_cw_g2, color=na, editable=false, display=display.none)
plot_bear_cw_g3 = plot(bear_cw_g3, color=na, editable=false, display=display.none)
plot_bull_cw_g3 = plot(bull_cw_g3, color=na, editable=false, display=display.none)
plot_bear_cw_g4 = plot(bear_cw_g4, color=na, editable=false, display=display.none)
plot_bull_cw_g4 = plot(bull_cw_g4, color=na, editable=false, display=display.none)
plot_bear_cw_g5 = plot(bear_cw_g5, color=na, editable=false, display=display.none)
plot_bull_cw_g5 = plot(bull_cw_g5, color=na, editable=false, display=display.none)
plot_bear_cw_g6 = plot(bear_cw_g6, color=na, editable=false, display=display.none)
plot_bull_cw_g6 = plot(bull_cw_g6, color=na, editable=false, display=display.none)
plot_bear_cw_g7 = plot(bear_cw_g7, color=na, editable=false, display=display.none)
plot_bull_cw_g7 = plot(bull_cw_g7, color=na, editable=false, display=display.none)
plot_bear_cw_g8 = plot(bear_cw_g8, color=na, editable=false, display=display.none)
plot_bull_cw_g8 = plot(bull_cw_g8, color=na, editable=false, display=display.none)
plot_bear_cw_g9 = plot(bear_cw_g9, color=na, editable=false, display=display.none)
plot_bull_cw_g9 = plot(bull_cw_g9, color=na, editable=false, display=display.none)

fill(plot_bear_cw_g1, plot_bear_cw_g2, color=color.new(color1, gradtransp), editable=false)
fill(plot_bull_cw_g1, plot_bull_cw_g2, color=color.new(color1, gradtransp), editable=false)
fill(plot_bear_cw_g2, plot_bear_cw_g3, color=color.new(color2, gradtransp), editable=false)
fill(plot_bull_cw_g2, plot_bull_cw_g3, color=color.new(color2, gradtransp), editable=false)
fill(plot_bear_cw_g3, plot_bear_cw_g4, color=color.new(color3, gradtransp), editable=false)
fill(plot_bull_cw_g3, plot_bull_cw_g4, color=color.new(color3, gradtransp), editable=false)
fill(plot_bear_cw_g4, plot_bear_cw_g5, color=color.new(color4, gradtransp), editable=false)
fill(plot_bull_cw_g4, plot_bull_cw_g5, color=color.new(color4, gradtransp), editable=false)
fill(plot_bear_cw_g5, plot_bear_cw_g6, color=color.new(color5, gradtransp), editable=false)
fill(plot_bull_cw_g5, plot_bull_cw_g6, color=color.new(color5, gradtransp), editable=false)
fill(plot_bear_cw_g6, plot_bear_cw_g7, color=color.new(color6, gradtransp), editable=false)
fill(plot_bull_cw_g6, plot_bull_cw_g7, color=color.new(color6, gradtransp), editable=false)
fill(plot_bear_cw_g7, plot_bear_cw_g8, color=color.new(color7, gradtransp), editable=false)
fill(plot_bull_cw_g7, plot_bull_cw_g8, color=color.new(color7, gradtransp), editable=false)
fill(plot_bear_cw_g8, plot_bear_cw_g9, color=color.new(color8, gradtransp), editable=false)
fill(plot_bull_cw_g8, plot_bull_cw_g9, color=color.new(color8, gradtransp), editable=false)

//************************************************************************************************************
// RSI Bar
//************************************************************************************************************

var table rsi_tbl = na

if barstate.islast
    if not na(rsi_tbl)
        table.delete(rsi_tbl)
        rsi_tbl := na

    if show_rsi
        rsi_is_green = not na(rsi_value) and ((close > centerline and rsi_value >= rsi_ob) or (close < centerline and rsi_value <= rsi_os))
        rsi_bar_clr  = rsi_is_green ? #00E676 : #FF5252
        rsi_num_str  = na(rsi_value) ? "â€”" : str.tostring(rsi_value, "#.#")

        rsi_tbl := table.new(position.top_right, 1, 3, bgcolor=#0D1117, frame_color=#0D1117, frame_width=0, border_color=#0D1117, border_width=0)
        table.cell(rsi_tbl, 0, 0, "RSI", text_color=color.white, bgcolor=#0D1117, text_size=size.small, text_halign=text.align_center)
        table.cell(rsi_tbl, 0, 1, "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ", text_color=rsi_bar_clr, bgcolor=#0D1117, text_size=size.large)
        table.cell(rsi_tbl, 0, 2, rsi_num_str, text_color=rsi_bar_clr, bgcolor=#0D1117, text_size=size.small, text_halign=text.align_center)
