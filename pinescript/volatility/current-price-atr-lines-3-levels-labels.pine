// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © rinada1210

//@version=5
indicator("Current Price ATR Lines [3 Levels + Labels]", overlay=true)

// === 1. 기본 설정 (Inputs) ===
atrLength = input.int(14, title="ATR 기간", minval=1)

// (추가) 리스크 관리 설정
grp_risk = "리스크 관리 설정"
posSize = input.float(1000.0, title="포지션 사이즈 (증거금)", group=grp_risk)
stopLossAmt = input.float(50.0, title="손절 금액", group=grp_risk)

// 배수 및 표시 설정 그룹
grp_mult = "ATR 배수 및 표시 설정"
mult1 = input.float(1.0, title="레벨 1 배수 (ATR x ?)", step=0.1, group=grp_mult)
show1 = input.bool(true, title="레벨 1 표시", group=grp_mult)

mult2 = input.float(2.0, title="레벨 2 배수 (ATR x ?)", step=0.1, group=grp_mult)
show2 = input.bool(true, title="레벨 2 표시", group=grp_mult)

mult3 = input.float(3.0, title="레벨 3 배수 (ATR x ?)", step=0.1, group=grp_mult)
show3 = input.bool(true, title="레벨 3 표시", group=grp_mult)

// 선 디자인 설정 그룹 (색상 및 굵기)
grp_style = "선 색상 및 굵기 커스텀"
c_center = input.color(color.new(color.blue, 50), title="기준선 색상", group=grp_style)
w_center = input.int(1, title="기준선 굵기", minval=1, maxval=5, group=grp_style)

c_u1 = input.color(color.new(color.red, 30), title="상단 1 색상", group=grp_style)
c_d1 = input.color(color.new(color.green, 30), title="하단 1 색상", group=grp_style)
w_1 = input.int(1, title="레벨 1 굵기", minval=1, maxval=5, group=grp_style)

c_u2 = input.color(color.new(color.red, 50), title="상단 2 색상", group=grp_style)
c_d2 = input.color(color.new(color.green, 50), title="하단 2 색상", group=grp_style)
w_2 = input.int(2, title="레벨 2 굵기", minval=1, maxval=5, group=grp_style)

c_u3 = input.color(color.new(color.red, 70), title="상단 3 색상", group=grp_style)
c_d3 = input.color(color.new(color.green, 70), title="하단 3 색상", group=grp_style)
w_3 = input.int(1, title="레벨 3 굵기", minval=1, maxval=5, group=grp_style)

// === 2. 계산 (Calculations) ===
atrValue = ta.atr(atrLength)

// === 3. 객체 초기화 (Lines & Labels) ===
// 라인 초기화
var line l_center = line.new(na, na, na, na, extend=extend.both, style=line.style_dashed)
var line l_u1 = line.new(na, na, na, na, extend=extend.both)
var line l_d1 = line.new(na, na, na, na, extend=extend.both)
var line l_u2 = line.new(na, na, na, na, extend=extend.both)
var line l_d2 = line.new(na, na, na, na, extend=extend.both)
var line l_u3 = line.new(na, na, na, na, extend=extend.both)
var line l_d3 = line.new(na, na, na, na, extend=extend.both)

// 라벨 초기화
var label lbl_center = label.new(na, na, na, style=label.style_label_left, textcolor=color.white, size=size.small)
var label lbl_u1 = label.new(na, na, na, style=label.style_label_left, textcolor=color.white, size=size.small)
var label lbl_d1 = label.new(na, na, na, style=label.style_label_left, textcolor=color.white, size=size.small)
var label lbl_u2 = label.new(na, na, na, style=label.style_label_left, textcolor=color.white, size=size.small)
var label lbl_d2 = label.new(na, na, na, style=label.style_label_left, textcolor=color.white, size=size.small)
var label lbl_u3 = label.new(na, na, na, style=label.style_label_left, textcolor=color.white, size=size.small)
var label lbl_d3 = label.new(na, na, na, style=label.style_label_left, textcolor=color.white, size=size.small)

// === 4. 차트에 그리기 및 업데이트 ===
if barstate.islast
    c = close
    a = atrValue
    
    // 가격 계산
    val_u1 = c + (a * mult1)
    val_d1 = c - (a * mult1)
    val_u2 = c + (a * mult2)
    val_d2 = c - (a * mult2)
    val_u3 = c + (a * mult3)
    val_d3 = c - (a * mult3)

    // 퍼센트 계산 ((N * ATR) / 현재가 * 100)
    pct1 = (a * mult1) / c * 100
    pct2 = (a * mult2) / c * 100
    pct3 = (a * mult3) / c * 100

    // (추가) 레버리지 계산: 포지션사이즈 * (ATR% * 레버리지) = 손절금액
    // 레버리지 = 손절금액 / (포지션사이즈 * ATR%)
    // 여기서는 Level 1 (mult1) 기준으로 계산합니다.
    target_pct = (a * mult1) / c 
    lev = math.floor(stopLossAmt / (posSize * target_pct))

    // 라벨이 캔들에 겹치지 않게 우측으로 조금 띄워서 배치 (bar_index + 3)
    lbl_x = bar_index + 3

    // --- 기준선 업데이트 ---
    line.set_xy1(l_center, bar_index - 1, c)
    line.set_xy2(l_center, bar_index, c)
    line.set_color(l_center, c_center)
    line.set_width(l_center, w_center)
    
    label.set_xy(lbl_center, lbl_x, c)
    // (수정) 현재가 라벨 끝에 레버리지 값 추가
    label.set_text(lbl_center, "C: " + str.tostring(c, "#.0") + " [Lev: " + str.tostring(lev, "0") + "]")
    label.set_color(lbl_center, c_center)
    
    // --- 레벨 1 업데이트 ---
    if show1
        line.set_xy1(l_u1, bar_index - 1, val_u1)
        line.set_xy2(l_u1, bar_index, val_u1)
        line.set_color(l_u1, c_u1)
        line.set_width(l_u1, w_1)
        label.set_xy(lbl_u1, lbl_x, val_u1)
        label.set_text(lbl_u1, "U1: " + str.tostring(val_u1, "#.0") + " (" + str.tostring(pct1, "#.0") + "%)")
        label.set_color(lbl_u1, c_u1)

        line.set_xy1(l_d1, bar_index - 1, val_d1)
        line.set_xy2(l_d1, bar_index, val_d1)
        line.set_color(l_d1, c_d1)
        line.set_width(l_d1, w_1)
        label.set_xy(lbl_d1, lbl_x, val_d1)
        label.set_text(lbl_d1, "D1: " + str.tostring(val_d1, "#.0") + " (" + str.tostring(pct1, "#.0") + "%)")
        label.set_color(lbl_d1, c_d1)
    else
        line.set_xy1(l_u1, na, na)
        label.set_xy(lbl_u1, na, na)
        line.set_xy1(l_d1, na, na)
        label.set_xy(lbl_d1, na, na)
        
    // --- 레벨 2 업데이트 ---
    if show2
        line.set_xy1(l_u2, bar_index - 1, val_u2)
        line.set_xy2(l_u2, bar_index, val_u2)
        line.set_color(l_u2, c_u2)
        line.set_width(l_u2, w_2)
        label.set_xy(lbl_u2, lbl_x, val_u2)
        label.set_text(lbl_u2, "U2: " + str.tostring(val_u2, "#.0") + " (" + str.tostring(pct2, "#.0") + "%)")
        label.set_color(lbl_u2, c_u2)

        line.set_xy1(l_d2, bar_index - 1, val_d2)
        line.set_xy2(l_d2, bar_index, val_d2)
        line.set_color(l_d2, c_d2)
        line.set_width(l_d2, w_2)
        label.set_xy(lbl_d2, lbl_x, val_d2)
        label.set_text(lbl_d2, "D2: " + str.tostring(val_d2, "#.0") + " (" + str.tostring(pct2, "#.0") + "%)")
        label.set_color(lbl_d2, c_d2)
    else
        line.set_xy1(l_u2, na, na)
        label.set_xy(lbl_u2, na, na)
        line.set_xy1(l_d2, na, na)
        label.set_xy(lbl_d2, na, na)

    // --- 레벨 3 업데이트 ---
    if show3
        line.set_xy1(l_u3, bar_index - 1, val_u3)
        line.set_xy2(l_u3, bar_index, val_u3)
        line.set_color(l_u3, c_u3)
        line.set_width(l_u3, w_3)
        label.set_xy(lbl_u3, lbl_x, val_u3)
        label.set_text(lbl_u3, "U3: " + str.tostring(val_u3, "#.0") + " (" + str.tostring(pct3, "#.0") + "%)")
        label.set_color(lbl_u3, c_u3)

        line.set_xy1(l_d3, bar_index - 1, val_d3)
        line.set_xy2(l_d3, bar_index, val_d3)
        line.set_color(l_d3, c_d3)
        line.set_width(l_d3, w_3)
        label.set_xy(lbl_d3, lbl_x, val_d3)
        label.set_text(lbl_d3, "D3: " + str.tostring(val_d3, "#.0") + " (" + str.tostring(pct3, "#.0") + "%)")
        label.set_color(lbl_d3, c_d3)
    else
        line.set_xy1(l_u3, na, na)
        label.set_xy(lbl_u3, na, na)
        line.set_xy1(l_d3, na, na)
        label.set_xy(lbl_d3, na, na)
