//@version=5
indicator("Advanced Volatility Squeeze Pro v2 [identityKa]", shorttitle="Squeeze Pro v2 [identityKa]", overlay=false)

// ==========================================
// 1. USER SETTINGS (identityKa Standard)
// ==========================================
grp_1 = "âš™ï¸ Squeeze & Momentum Settings"
length = input.int(20, "Squeeze Channel Length", minval=5, group=grp_1)
multBB = input.float(2.0, "Bollinger Band Multiplier", step=0.1, group=grp_1)
multKC = input.float(1.5, "Keltner Channel Multiplier", step=0.1, group=grp_1)
fastMom = input.int(8, "Fast Momentum EMA", minval=1, group=grp_1, tooltip="Lower value = Faster reaction (less lag)")
slowMom = input.int(21, "Slow Momentum EMA", minval=1, group=grp_1, tooltip="Higher value = Smoother signal")

grp_2 = "ðŸŽ¨ identityKa Theme & Visuals"
col_sqz_on  = input.color(#ff1744, "Squeeze ON (Red Dot)", group=grp_2)
col_sqz_off = input.color(#555555, "Squeeze OFF (Gray Dot)", group=grp_2)
col_up_high = input.color(#00E676, "Strong Bullish (Neon Green)", group=grp_2)
col_up_low  = input.color(#00796B, "Weak Bullish (Dark Green)", group=grp_2)
col_dn_high = input.color(#ff1744, "Strong Bearish (Neon Red)", group=grp_2)
col_dn_low  = input.color(#880E4F, "Weak Bearish (Dark Red)", group=grp_2)
showDash    = input.bool(true, "Show Dashboard Table?", group=grp_2)

// ==========================================
// 2. BOLLINGER BANDS & KELTNER CHANNELS MATH
// ==========================================
// Calculate BB
basis = ta.sma(close, length)
dev   = multBB * ta.stdev(close, length)
upperBB = basis + dev
lowerBB = basis - dev

// Calculate KC
ma = ta.sma(close, length)
range_ema = ta.sma(ta.tr, length)
upperKC = ma + range_ema * multKC
lowerKC = ma - range_ema * multKC

// Squeeze Conditions
sqzOn  = (lowerBB > lowerKC) and (upperBB < upperKC)
sqzOff = (lowerBB < lowerKC) and (upperBB > upperKC)
noSqz  = (sqzOn == false) and (sqzOff == false)

// ==========================================
// 3. LAG-FREE MOMENTUM CALCULATION (NEW!)
// ==========================================
// Using the difference between Fast and Slow EMA for instant momentum reaction
mom_fast = ta.ema(close, fastMom)
mom_slow = ta.ema(close, slowMom)
mom_val  = mom_fast - mom_slow

// Histogram Colors (Dynamic & Fast)
bcolor = mom_val > 0 ? (mom_val > nz(mom_val[1]) ? col_up_high : col_up_low) : (mom_val < nz(mom_val[1]) ? col_dn_high : col_dn_low)

// ==========================================
// 4. PLOTTING
// ==========================================
plot(mom_val, title="Momentum Histogram", color=bcolor, style=plot.style_histogram, linewidth=4)

// Zero Line & Squeeze Dots
plot(0, title="Zero Line", color=color.new(color.gray, 50), linewidth=1)
dot_color = sqzOn ? col_sqz_on : col_sqz_off
plot(0, title="Squeeze Status", color=dot_color, style=plot.style_circles, linewidth=3)

// ==========================================
// 5. PREMIUM DASHBOARD (TABLE)
// ==========================================
var table dash = table.new(position.top_right, 2, 3, border_width=1, border_color=color.new(color.gray, 80))

if showDash and barstate.islast
    // Header
    table.cell(dash, 0, 0, "IDENTITYKA", text_color=color.white, bgcolor=color.new(color.black, 20), text_size=size.small)
    table.cell(dash, 1, 0, "SQUEEZE PRO v2", text_color=color.white, bgcolor=color.new(color.black, 20), text_size=size.small)
    
    // Squeeze Status
    string sqzText  = sqzOn ? "ON (Consolidation)" : "OFF (Fired/Firing)"
    color  sqzColor = sqzOn ? col_sqz_on : col_up_high
    table.cell(dash, 0, 1, "Squeeze", text_color=color.gray, bgcolor=color.new(color.black, 40), text_size=size.small)
    table.cell(dash, 1, 1, sqzText, text_color=sqzColor, bgcolor=color.new(color.black, 40), text_size=size.small)
    
    // Momentum Direction
    string momText  = mom_val > 0 ? "BULLISH" : "BEARISH"
    color  momColor = mom_val > 0 ? col_up_high : col_dn_high
    table.cell(dash, 0, 2, "Momentum", text_color=color.gray, bgcolor=color.new(color.black, 40), text_size=size.small)
    table.cell(dash, 1, 2, momText, text_color=momColor, bgcolor=color.new(color.black, 40), text_size=size.small)

// ==========================================
// 6. ALERTS
// ==========================================
// Firing alerts when squeeze turns off and momentum establishes direction
sqz_fire_long  = sqzOn[1] and not sqzOn and mom_val > 0
sqz_fire_short = sqzOn[1] and not sqzOn and mom_val < 0

alertcondition(sqz_fire_long, title="Squeeze Fired LONG", message="Volatility breakout! Squeeze fired LONG with bullish momentum.")
alertcondition(sqz_fire_short, title="Squeeze Fired SHORT", message="Volatility breakout! Squeeze fired SHORT with bearish momentum.")
alertcondition(sqzOn, title="Squeeze is ON", message="Market is consolidating (Squeeze is ON). Prepare for a move.")
