// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © fr0xMaster
//@version=5
indicator("[fr0x] Heikin Ashi Close Levels", overlay=true, max_lines_count=500)

// --- PARAMETERS ---
ema_period = input.int(7, "EMA Period", minval=1)
ema7 = ta.ema(close, ema_period)
plot(ema7, color=color.blue, title="Trend EMA")

// --- DATA STORAGE ---
var float[] bullLevels = array.new_float()
var int[]   bullBars   = array.new_int()
var float[] bearLevels = array.new_float()
var int[]   bearBars   = array.new_int()

var float currentMax = na
var int   currentMaxBar = na
var float currentMin = na
var int   currentMinBar = na

// Trend Detection
crossUnder = ta.crossunder(close, ema7)
crossOver = ta.crossover(close, ema7)

// --- LOGIC: TRACKING EXTREMES ---
if close > ema7
    if na(currentMax) or close > currentMax
        currentMax := close
        currentMaxBar := bar_index
else if close < ema7
    if na(currentMin) or close < currentMin
        currentMin := close
        currentMinBar := bar_index

// --- LOGIC: ARCHIVING COMPLETED SERIES ---
if crossUnder and not na(currentMax)
    array.push(bullLevels, currentMax)
    array.push(bullBars, currentMaxBar)
    currentMax := na 
    currentMaxBar := na

if crossOver and not na(currentMin)
    array.push(bearLevels, currentMin)
    array.push(bearBars, currentMinBar)
    currentMin := na 
    currentMinBar := na

// --- LOGIC: INVALIDATION & ALERTS ---
bool alertBull = false
bool alertBear = false

if array.size(bullLevels) > 0
    for i = array.size(bullLevels) - 1 to 0
        if bar_index > array.get(bullBars, i) and high >= array.get(bullLevels, i)
            alertBull := true
            array.remove(bullLevels, i)
            array.remove(bullBars, i)

if array.size(bearLevels) > 0
    for i = array.size(bearLevels) - 1 to 0
        if bar_index > array.get(bearBars, i) and low <= array.get(bearLevels, i)
            alertBear := true
            array.remove(bearLevels, i)
            array.remove(bearBars, i)

// --- TRIGGER ALERTS ---
if alertBull
    alert("Resistance Level (High) Touched/Broken!", alert.freq_once_per_bar)
if alertBear
    alert("Support Level (Low) Touched/Broken!", alert.freq_once_per_bar)

// --- DISPLAY ---
var line bLine = na, var label bPriceLabel = na,
var line sLine = na, var label sPriceLabel = na

// High Level (Resistance - Red)
if array.size(bullLevels) > 0
    line.delete(bLine), label.delete(bPriceLabel),
    val = array.get(bullLevels, array.size(bullLevels)-1)
    bar = array.get(bullBars, array.size(bullBars)-1)
    
    bLine := line.new(bar, val, bar_index, val, color=color.red, width=2, extend=extend.right)
    bPriceLabel := label.new(bar_index + 10, val, str.tostring(val, format.mintick), color=color.red, textcolor=color.white, style=label.style_label_left, size=size.small)
else
    line.delete(bLine), label.delete(bPriceLabel)

// Low Level (Support - Green)
if array.size(bearLevels) > 0
    line.delete(sLine), label.delete(sPriceLabel)
    val = array.get(bearLevels, array.size(bearLevels)-1)
    bar = array.get(bearBars, array.size(bearBars)-1)
    
    sLine := line.new(bar, val, bar_index, val, color=color.green, width=2, extend=extend.right)
    sPriceLabel := label.new(bar_index + 10, val, str.tostring(val, format.mintick), color=color.green, textcolor=color.white, style=label.style_label_left, size=size.small)
else
    line.delete(sLine), label.delete(sPriceLabel)
