//@version=6
indicator("Quad Bollinger Ribbon", shorttitle="QBB Ribbon", overlay=true, timeframe="", timeframe_gaps=true)

// ─────────────────────────────────────────────────────────────────────────────
// Visual inputs
// ─────────────────────────────────────────────────────────────────────────────
groupVis = "Visual"
showLines      = input.bool(true,  "Show BB Lines (8 lines)", group=groupVis)
showRibbons    = input.bool(true,  "Show Shaded Ribbons (4 ribbons)", group=groupVis)
ribbonTransp   = input.int(85,     "Ribbon Transparency (0=solid, 100=transparent)", minval=0, maxval=100, group=groupVis)
lineWidth      = input.int(1,      "Line Width", minval=1, maxval=4, group=groupVis)
offset         = input.int(0,      "Offset", minval=-500, maxval=500, group=groupVis)

// Colors
cGreen = color.lime
cRed   = color.red

// ─────────────────────────────────────────────────────────────────────────────
// Helpers
// ─────────────────────────────────────────────────────────────────────────────
ma(source, len, _type) =>
    switch _type
        "SMA" => ta.sma(source, len)
        "EMA" => ta.ema(source, len)
        "SMMA (RMA)" => ta.rma(source, len)
        "WMA" => ta.wma(source, len)
        "VWMA" => ta.vwma(source, len)

bb(src, len, maType, m) =>
    basis = ma(src, len, maType)
    dev   = m * ta.stdev(src, len)
    upper = basis + dev
    lower = basis - dev
    [upper, lower]

// ─────────────────────────────────────────────────────────────────────────────
// 4 independent BB configs (defaults = your current setup)
// ─────────────────────────────────────────────────────────────────────────────
groupG1 = "Green #1 (High / EMA default)"
g1_len  = input.int(20, "Length", minval=1, group=groupG1)
g1_mult = input.float(2.0, "StdDev", minval=0.001, maxval=50, group=groupG1)
g1_src  = input.source(high, "Source", group=groupG1)
g1_ma   = input.string("EMA", "Basis MA Type", options=["SMA","EMA","SMMA (RMA)","WMA","VWMA"], group=groupG1)

groupG2 = "Green #2 (High / WMA default)"
g2_len  = input.int(20, "Length", minval=1, group=groupG2)
g2_mult = input.float(2.0, "StdDev", minval=0.001, maxval=50, group=groupG2)
g2_src  = input.source(high, "Source", group=groupG2)
g2_ma   = input.string("WMA", "Basis MA Type", options=["SMA","EMA","SMMA (RMA)","WMA","VWMA"], group=groupG2)

groupR1 = "Red #1 (Low / EMA default)"
r1_len  = input.int(20, "Length", minval=1, group=groupR1)
r1_mult = input.float(2.0, "StdDev", minval=0.001, maxval=50, group=groupR1)
r1_src  = input.source(low, "Source", group=groupR1)
r1_ma   = input.string("EMA", "Basis MA Type", options=["SMA","EMA","SMMA (RMA)","WMA","VWMA"], group=groupR1)

groupR2 = "Red #2 (Low / WMA default)"
r2_len  = input.int(20, "Length", minval=1, group=groupR2)
r2_mult = input.float(2.0, "StdDev", minval=0.001, maxval=50, group=groupR2)
r2_src  = input.source(low, "Source", group=groupR2)
r2_ma   = input.string("WMA", "Basis MA Type", options=["SMA","EMA","SMMA (RMA)","WMA","VWMA"], group=groupR2)

// ─────────────────────────────────────────────────────────────────────────────
// Compute
// ─────────────────────────────────────────────────────────────────────────────
[g1_up, g1_lo] = bb(g1_src, g1_len, g1_ma, g1_mult)
[g2_up, g2_lo] = bb(g2_src, g2_len, g2_ma, g2_mult)

[r1_up, r1_lo] = bb(r1_src, r1_len, r1_ma, r1_mult)
[r2_up, r2_lo] = bb(r2_src, r2_len, r2_ma, r2_mult)

/// ─────────────────────────────────────────────────────────────────────────────
// Plot & Fill (clean UI: no titles spam)
// ─────────────────────────────────────────────────────────────────────────────
plotDisplay = showLines ? display.all : display.none

// Set to true if you also want to hide the indicator values from the top "values line"
hideValuesLine = input.bool(true, "Hide values line text", group=groupVis)
valDisplay = hideValuesLine ? display.none : plotDisplay

// Green lines (titles empty to avoid long labels)
pG1U = plot(g1_up, "", color=cGreen, linewidth=lineWidth, offset=offset, display=valDisplay)
pG2U = plot(g2_up, "", color=cGreen, linewidth=lineWidth, offset=offset, display=valDisplay)
pG1L = plot(g1_lo, "", color=cGreen, linewidth=lineWidth, offset=offset, display=valDisplay)
pG2L = plot(g2_lo, "", color=cGreen, linewidth=lineWidth, offset=offset, display=valDisplay)

// Red lines
pR1U = plot(r1_up, "", color=cRed, linewidth=lineWidth, offset=offset, display=valDisplay)
pR2U = plot(r2_up, "", color=cRed, linewidth=lineWidth, offset=offset, display=valDisplay)
pR1L = plot(r1_lo, "", color=cRed, linewidth=lineWidth, offset=offset, display=valDisplay)
pR2L = plot(r2_lo, "", color=cRed, linewidth=lineWidth, offset=offset, display=valDisplay)

// Ribbons (keep these visible; fills don't need local scope)
rTransp = showRibbons ? ribbonTransp : 100
fill(pG1U, pG2U, title="", color=color.new(cGreen, rTransp))
fill(pR1U, pR2U, title="", color=color.new(cRed,   rTransp))
fill(pG1L, pG2L, title="", color=color.new(cGreen, rTransp))
fill(pR1L, pR2L, title="", color=color.new(cRed,   rTransp))
