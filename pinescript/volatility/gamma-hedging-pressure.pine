//@version=6
indicator("Gamma Hedging Pressure (Proxy)", overlay=false, max_labels_count=50)

// ─────────────────────────────
// INPUTS
// ─────────────────────────────
lenATR      = input.int(14, "ATR Length")
lenVol      = input.int(20, "Volume MA Length")
gammaThresh = input.float(0.5, "Gamma Threshold", step=0.1)

useSessionReset = input.bool(true, "Reset on New Session")

// ─────────────────────────────
// SESSION DETECTION
// ─────────────────────────────
newSession = ta.change(time("D"))

// ─────────────────────────────
// CORE COMPONENTS
// ─────────────────────────────

// Volatility expansion
atr = ta.atr(lenATR)
rangeNorm = (high - low) / atr

// Price acceleration
priceDelta = close - close[1]
acceleration = priceDelta - priceDelta[1]

// Volume participation
volMA = ta.sma(volume, lenVol)
volNorm = volume / volMA

// ─────────────────────────────
// GAMMA PRESSURE LOGIC
// ─────────────────────────────

// Expansion + volume + acceleration = negative gamma
rawPressure =
     (rangeNorm * acceleration * volNorm)

// Normalize
gammaPressure = ta.ema(rawPressure, 5)

// Session detection
isNewSession = ta.change(time("D")) != 0

// Optional session reset
gammaPressure := (useSessionReset and isNewSession) ? 0.0 : gammaPressure


// ─────────────────────────────
// REGIME CLASSIFICATION
// ─────────────────────────────
int gammaState = na

if gammaPressure > gammaThresh
    gammaState := -1   // Negative Gamma (Trend / Breakout)
else if gammaPressure < -gammaThresh
    gammaState := 1    // Positive Gamma (Mean Reversion)
else
    gammaState := 0    // Neutral / Chop

// ─────────────────────────────
// PLOTS
// ─────────────────────────────
plot(gammaPressure, 
     title="Gamma Hedging Pressure", 
     style=plot.style_histogram,
     linewidth=2,
     color = gammaState == -1 ? color.red :
             gammaState == 1  ? color.green :
                                color.gray)

// Zero line
hline(0, "Neutral", color=color.gray)

// ─────────────────────────────
// BACKGROUND REGIME
// ─────────────────────────────
bgcolor(
     gammaState == -1 ? color.new(color.red, 90) :
     gammaState == 1  ? color.new(color.green, 90) :
                        na
)

// ─────────────────────────────
// LABELS (OPTIONAL)
// ─────────────────────────────
if barstate.islast
    label.new(bar_index, gammaPressure,
        text = gammaState == -1 ? "NEGATIVE GAMMA\nTrend / Breakout" :
               gammaState == 1  ? "POSITIVE GAMMA\nMean Reversion" :
                                  "NEUTRAL",
        style=label.style_label_down,
        textcolor=color.white,
        color= gammaState == -1 ? color.red :
               gammaState == 1  ? color.green :
                                  color.gray)
