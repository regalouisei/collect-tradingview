//@version=5
indicator("IVR - Implied Volatility Rate", shorttitle="IV Rate", overlay=false, max_bars_back=500)

// ============================================================================
// INPUTS (matches original)
// ============================================================================
src           = input.source(close, "Src")
len           = input.int(52, "Length")
lvl           = input.int(10, "Level")
smooth_period = input.int(21, "Smooth EMA")

// ============================================================================
// CALCULATION
// ============================================================================
ivr = ta.percentrank(src, len)
ivr := na(ivr) ? 50 : math.max(0, math.min(100, ivr))

smooth_line = ta.ema(ivr, smooth_period)

// ============================================================================
// VISUALS
// ============================================================================
is_low   = ivr < lvl
col_line = is_low ? #FF0000 : #00FFFF

p_ivr = plot(ivr,       "IVR",       col_line, linewidth=1)
plot(smooth_line,       "Smooth",    color.white, linewidth=3)

hline(100, color=color.new(#808080, 60), linestyle=hline.style_dashed)
hline(lvl, color=color.rgb(255, 0, 0), linestyle=hline.style_solid, linewidth=1)  // orange
hline(0,   color=color.new(#808080, 60), linestyle=hline.style_dashed)

p_lvl = plot(lvl, title="", color=na, display=display.none)

// === SINGLE DIRECTIONAL FILL (prevents red bleed above level) ===
color zone_col = is_low ? color.new(#FF0000, 10) : color.new(#00f7ff, 90)

// When below level: fill DOWN from lvl to ivr (red low zone)
// When above level: fill UP from lvl to ivr (gray normal zone)
fill(p_lvl, p_ivr, color = is_low ? zone_col : na, title="Low Zone Fill")
fill(p_ivr, p_lvl, color = not is_low ? zone_col : na, title="Normal Zone Fill")
