//@version=6
indicator("GCM Hybrid SuperTrend", "GCM HST", overlay = true)

// --- 1. Auto Logic & Settings ---
auto_settings() =>
    float auto_f = 2.0 
    int auto_p = 10
    if timeframe.isintraday
        if timeframe.period == "1"
            auto_f := 0.5
        else if timeframe.period == "3"
            auto_f := 1.0
        else if timeframe.period == "5"
            auto_f := 1.5
        else if timeframe.period == "15"
            auto_f := 2.0
        else
            auto_f := 3.0
    else
        auto_f := 3.0
    [auto_f, auto_p]

grp_logic = "Strategy Core"
useAuto      = input.bool(true, "Auto Mode", group = grp_logic)
manualATR    = input.int(10, "Manual ATR Period", minval = 1, group = grp_logic)
manualFactor = input.float(1.0, "Manual Factor", step = 0.1, group = grp_logic)
safetyBars   = input.int(3, "Dead Ball Window (Bars)", minval = 1, group = grp_logic)
showGoldBar  = input.bool(true, "Show Gold Bar at Dead Point", group = grp_logic)

[autoF, autoP] = auto_settings()
currentFactor = useAuto ? autoF : manualFactor
currentATR    = useAuto ? autoP : manualATR

// --- 2. Hybrid Engine ---
[stValue, stDirection] = ta.supertrend(currentFactor, currentATR)
atr_val = ta.atr(14) 

var float finalST = na
var float deadPoint = na
var int barsSinceChange = 0
var float currentDirection = 0.0

trendChanged = ta.change(stDirection) != 0

if trendChanged
    deadPoint := stValue[1]
    currentDirection := stDirection
    barsSinceChange := 0
else
    barsSinceChange += 1

bool safetyTriggered = false
if currentDirection < 0 
    if barsSinceChange <= safetyBars
        finalST := deadPoint
        if close < deadPoint
            currentDirection := 1.0
            safetyTriggered := true
    else
        finalST := stValue
        if close < stValue
            currentDirection := 1.0
else if currentDirection > 0 
    if barsSinceChange <= safetyBars
        finalST := deadPoint
        if close > deadPoint
            currentDirection := -1.0
            safetyTriggered := true
    else
        finalST := stValue
        if close > stValue
            currentDirection := -1.0

// --- 3. Visuals (Colors: Bull #089981, Bear #f23645) ---
bullCol = #089981
bearCol = #f23645
tColor = currentDirection < 0 ? bullCol : bearCol

p1 = plot(finalST, "Hybrid ST line", color = tColor, linewidth = 1, style = plot.style_linebr, display = display.all - display.status_line)
p2 = plot(ohlc4, "Body Middle", color = color.new(color.white, 100), display = display.none)

fill(p1, p2, finalST > ohlc4 ? color.new(bearCol, 85) : color.new(bullCol, 85), "Trend Cloud", display = display.all)
barcolor(tColor, title = "Trend-Based Bar Color", display = display.all)

// --- THE GOLD BAR ---
var box safetyLineBox = na
if trendChanged and showGoldBar
    box.delete(safetyLineBox) 
    safetyLineBox := box.new(left = bar_index, 
                             top = deadPoint + (atr_val * 0.04), 
                             right = bar_index + safetyBars, 
                             bottom = deadPoint - (atr_val * 0.04), 
                             bgcolor = color.new(color.yellow, 40), 
                             border_color = color.new(color.yellow, 0),
                             xloc = xloc.bar_index)

plotshape(ta.change(currentDirection) < 0, "Trend Flip Up", shape.triangleup, location.belowbar, color = bullCol, size=size.small, display = display.all - display.status_line)
plotshape(ta.change(currentDirection) > 0, "Trend Flip Down", shape.triangledown, location.abovebar, color = bearCol, size=size.small, display = display.all - display.status_line)
plot(barsSinceChange <= safetyBars and showGoldBar ? deadPoint : na, "Dead Point Dot", color = color.yellow, linewidth = 2, style = plot.style_circles, display = display.all - display.status_line)

// --- 4. Dashboard (Position BR as Default) ---
grp_db = "Dashboard"
db_pos = input.string("Bottom Right", "DB Position", options = ["Top Left", "Top Right", "Middle Left", "Middle Right", "Bottom Left", "Bottom Right"], group = grp_db)
db_size = input.string("Normal", "DB Size", options = ["Tiny", "Small", "Normal", "Large", "Huge"], group = grp_db)

get_pos(pos) =>
    pos == "Top Left"     ? position.top_left : 
     pos == "Top Right"    ? position.top_right : 
     pos == "Middle Left"  ? position.middle_left : 
     pos == "Middle Right" ? position.middle_right : 
     pos == "Bottom Left"  ? position.bottom_left : position.bottom_right

get_size(sz) =>
    sz == "Tiny" ? size.tiny : sz == "Small" ? size.small : sz == "Normal" ? size.normal : sz == "Large" ? size.large : size.huge

var table gcm_table = na
if barstate.islast
    gcm_table := table.new(get_pos(db_pos), 2, 5, bgcolor = color.new(#1e222d, 5), border_color = color.new(color.gray, 50), border_width = 1)
    sz = get_size(db_size)
    table.cell(gcm_table, 0, 0, "GCM HST", bgcolor = color.new(#00bcd4, 80), text_color = color.white, text_size = sz)
    table.merge_cells(gcm_table, 0, 0, 1, 0)
    table.cell(gcm_table, 0, 1, "MODE", text_color = color.gray, text_size = sz, text_halign = text.align_left)
    table.cell(gcm_table, 1, 1, useAuto ? "AUTO" : "MANUAL", text_color = useAuto ? color.lime : color.orange, text_size = sz, text_font_family = font.family_monospace)
    table.cell(gcm_table, 0, 2, "FACTOR", text_color = color.gray, text_size = sz, text_halign = text.align_left)
    table.cell(gcm_table, 1, 2, str.tostring(currentFactor, "#.#"), text_color = color.yellow, text_size = sz, text_font_family = font.family_monospace)
    table.cell(gcm_table, 0, 3, "ATR", text_color = color.gray, text_size = sz, text_halign = text.align_left)
    table.cell(gcm_table, 1, 3, str.tostring(currentATR), text_color = #ff9800, text_size = sz, text_font_family = font.family_monospace)
    bool isBullish = currentDirection < 0
    table.cell(gcm_table, 0, 4, "TREND", text_color = color.white, text_size = sz, text_halign = text.align_left)
    table.cell(gcm_table, 1, 4, isBullish ? "BULLISH ⬆" : "BEARISH ⬇", bgcolor = isBullish ? color.new(bullCol, 80) : color.new(bearCol, 80), text_color = isBullish ? color.lime : #ff5252, text_size = sz, text_font_family = font.family_monospace)

// --- 5. Alerts ---
alertcondition(ta.change(currentDirection) < 0, "GCM Buy", "GCM HST: BUY Signal")
alertcondition(ta.change(currentDirection) > 0, "GCM Sell", "GCM HST: SELL Signal")
alertcondition(safetyTriggered, "GCM Safety Exit", "GCM HST: Dead Ball Breached! EXIT")
