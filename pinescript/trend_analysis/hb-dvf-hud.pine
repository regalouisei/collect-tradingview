// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © cdnicholson1970  (aka HillBillyKrypto)


//@version=5


indicator("HB - DVF HUD", overlay=true)

//────────────────────────────────────────────
// INPUTS
//────────────────────────────────────────────
grpCore = "Core"
ltf        = input.timeframe("1", "Lower TF (intrabar)", group=grpCore)
volMode    = input.string("Volume", "Volume Source", options=["Volume","Volume*Range"], group=grpCore)
resetMode  = input.string("None", "Reset Mode", options=["None","Session","Day"], group=grpCore)
sessionStr = input.session("0830-1500", "Session (for Session reset)", group=grpCore)

grpSmooth = "Normalization"
normLen  = input.int(200, "Normalization Lookback", minval=20, group=grpSmooth)
useZ     = input.bool(false, "Use Z-Score", group=grpSmooth)

grpHUD = "HUD Settings"
hudSize     = input.string("Normal", "HUD Size", options=["Small","Normal","Large"], group=grpHUD)
hudPosition = input.string("Top Right", "HUD Position",
     options=["Top Right","Top Left","Bottom Right","Bottom Left","Middle Right","Middle Left","Top Center","Bottom Center"],
     group=grpHUD)
bgOpacity   = input.int(85, "Background Opacity (0–100)", minval=0, maxval=100, group=grpHUD)

//────────────────────────────────────────────
// HELPERS
//────────────────────────────────────────────
f_inSession(_sess) =>
    not na(time(timeframe.period, _sess))

f_resetNow() =>
    resetMode == "Day" ? ta.change(time("D")) :
     resetMode == "Session" ? (f_inSession(sessionStr) and not f_inSession(sessionStr)[1]) :
     false

f_arrSumFloat(array<float> a) =>
    float s = 0.0
    int n = array.size(a)
    if n > 0
        for i = 0 to n - 1
            s += array.get(a, i)
    s

//────────────────────────────────────────────
// DATA
//────────────────────────────────────────────
volBase = volMode == "Volume" ? volume : volume * math.max(high - low, syminfo.mintick)

buyArr  = request.security_lower_tf(syminfo.tickerid, ltf, (close > open ? volBase : 0.0))
sellArr = request.security_lower_tf(syminfo.tickerid, ltf, (close < open ? volBase : 0.0))

buy  = f_arrSumFloat(buyArr)
sell = f_arrSumFloat(sellArr)

totVol = buy + sell
delta  = buy - sell

// Cumulative Delta
var float cumDelta = 0.0
if barstate.isfirst or f_resetNow()
    cumDelta := 0.0
cumDelta += delta

// Normalization
deltaMean = ta.sma(delta, normLen)
deltaStd  = ta.stdev(delta, normLen)
normDelta = useZ ? (deltaStd != 0 ? (delta - deltaMean) / deltaStd : 0.0) : delta

//────────────────────────────────────────────
// HUD STYLE LOGIC
//────────────────────────────────────────────
pos =
     hudPosition == "Top Right"     ? position.top_right :
     hudPosition == "Top Left"      ? position.top_left :
     hudPosition == "Bottom Right"  ? position.bottom_right :
     hudPosition == "Bottom Left"   ? position.bottom_left :
     hudPosition == "Middle Right"  ? position.middle_right :
     hudPosition == "Middle Left"   ? position.middle_left :
     hudPosition == "Top Center"    ? position.top_center :
     position.bottom_center

textSize =
     hudSize == "Small"  ? size.small :
     hudSize == "Large"  ? size.large :
     size.normal

bgColor = color.new(color.black, bgOpacity)

//────────────────────────────────────────────
// HUD TABLE
//────────────────────────────────────────────
var table hud = table.new(pos, 2, 6, border_width=1)

if barstate.islast
    table.cell(hud, 0, 0, "DVF HUD", text_color=color.white, text_size=textSize, bgcolor=bgColor)
    table.cell(hud, 1, 0, "", bgcolor=bgColor)

    table.cell(hud, 0, 1, "LTF", text_color=color.gray, text_size=textSize, bgcolor=bgColor)
    table.cell(hud, 1, 1, ltf, text_color=color.white, text_size=textSize, bgcolor=bgColor)

    table.cell(hud, 0, 2, "Buy", text_color=color.gray, text_size=textSize, bgcolor=bgColor)
    table.cell(hud, 1, 2, str.tostring(buy, format.mintick), text_color=color.lime, text_size=textSize, bgcolor=bgColor)

    table.cell(hud, 0, 3, "Sell", text_color=color.gray, text_size=textSize, bgcolor=bgColor)
    table.cell(hud, 1, 3, str.tostring(sell, format.mintick), text_color=color.red, text_size=textSize, bgcolor=bgColor)

    table.cell(hud, 0, 4, "Delta", text_color=color.gray, text_size=textSize, bgcolor=bgColor)
    table.cell(hud, 1, 4, str.tostring(delta, format.mintick), text_color=(delta >= 0 ? color.lime : color.red), text_size=textSize, bgcolor=bgColor)

    table.cell(hud, 0, 5, "Cum Δ", text_color=color.gray, text_size=textSize, bgcolor=bgColor)
    table.cell(hud, 1, 5, str.tostring(cumDelta, format.mintick), text_color=(cumDelta >= 0 ? color.lime : color.red), text_size=textSize, bgcolor=bgColor)
