// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © officialjackofalltrades
//@version=6
indicator("Cascade Trend Navigator [JOAT]", shorttitle="CTN [JOAT]", overlay=true, max_bars_back=500, max_lines_count=200, max_boxes_count=50)

// ═══════════════════════════════════════════════════════════════════════════════
// CASCADE TREND NAVIGATOR - Institutional Grade Multi-Timeframe Trend & Flow System
// Combines Dynamic Support/Resistance, Volume Profile, and Liquidity Zones
// ═══════════════════════════════════════════════════════════════════════════════

// ═══════════════════════════════════════════
// INPUTS
// ═══════════════════════════════════════════

// Trend Settings
trendGroup = "Trend Settings"
fastLen = input.int(20, "Fast MA Length", minval=1, group=trendGroup)
slowLen = input.int(50, "Slow MA Length", minval=1, group=trendGroup)
trendLen = input.int(200, "Trend MA Length", minval=1, group=trendGroup)
maType = input.string("HMA", "MA Type", options=["SMA", "EMA", "HMA", "TEMA", "DEMA", "ZEMA", "VWMA"], group=trendGroup)
showMACloud = input.bool(true, "Show MA Cloud", group=trendGroup)

// Zone Settings
zoneGroup = "Zone Settings"
zoneLength = input.int(50, "Zone Calculation Length", minval=10, group=zoneGroup)
zoneDeviation = input.float(1.5, "Zone Deviation", minval=0.5, step=0.1, group=zoneGroup)
showZones = input.bool(true, "Show Support/Resistance Zones", group=zoneGroup)

// Volume Profile Settings
volGroup = "Volume Profile Settings"
volProfileLen = input.int(100, "Volume Profile Length", minval=20, group=volGroup)
volBins = input.int(20, "Number of Price Bins", minval=5, maxval=50, group=volGroup)
showVolProfile = input.bool(true, "Show Volume Profile", group=volGroup)

// Liquidity Settings
liqGroup = "Liquidity Settings"
showLiquidity = input.bool(true, "Show Liquidity Zones", group=liqGroup)
liqLookback = input.int(50, "Liquidity Lookback", minval=10, group=liqGroup)

// Color Settings
colorGroup = "Color Settings"
bullTrendColor = input.color(color.new(#00D9FF, 0), "Bullish Trend", inline="trend", group=colorGroup)
bearTrendColor = input.color(color.new(#FF3366, 0), "Bearish Trend", inline="trend", group=colorGroup)
supportColor = input.color(color.new(#00FF88, 80), "Support Zone", inline="zone", group=colorGroup)
resistanceColor = input.color(color.new(#FF0066, 80), "Resistance Zone", inline="zone", group=colorGroup)

// ═══════════════════════════════════════════
// MOVING AVERAGE FUNCTIONS
// ═══════════════════════════════════════════

hma(src, length) =>
    wma1 = ta.wma(src, length / 2)
    wma2 = ta.wma(src, length)
    ta.wma(2 * wma1 - wma2, math.round(math.sqrt(length)))

tema(src, length) =>
    ema1 = ta.ema(src, length)
    ema2 = ta.ema(ema1, length)
    ema3 = ta.ema(ema2, length)
    3 * ema1 - 3 * ema2 + ema3

dema(src, length) =>
    ema1 = ta.ema(src, length)
    ema2 = ta.ema(ema1, length)
    2 * ema1 - ema2

zema(src, length) =>
    lag = (length - 1) / 2
    ema_data = src + (src - src[math.floor(lag)])
    ta.ema(ema_data, length)

vwma_custom(src, length) =>
    ta.vwma(src, length)

getMA(src, length, type) =>
    switch type
        "SMA" => ta.sma(src, length)
        "EMA" => ta.ema(src, length)
        "HMA" => hma(src, length)
        "TEMA" => tema(src, length)
        "DEMA" => dema(src, length)
        "ZEMA" => zema(src, length)
        "VWMA" => vwma_custom(src, length)
        => ta.sma(src, length)

// ═══════════════════════════════════════════
// TREND CALCULATIONS
// ═══════════════════════════════════════════

fastMA = getMA(close, fastLen, maType)
slowMA = getMA(close, slowLen, maType)
trendMA = getMA(close, trendLen, maType)

// Trend Direction
bullTrend = fastMA > slowMA and close > trendMA
bearTrend = fastMA < slowMA and close < trendMA
trendStrength = math.abs((fastMA - slowMA) / slowMA) * 100

// Trend Color
trendColor = bullTrend ? bullTrendColor : bearTrend ? bearTrendColor : color.gray

// ═══════════════════════════════════════════
// SUPPORT/RESISTANCE ZONES
// ═══════════════════════════════════════════

// Calculate dynamic zones using HMA
hmaHigh = hma(high, zoneLength)
hmaLow = hma(low, zoneLength)
atr = ta.atr(14)

// Resistance Zone
resistanceTop = hmaHigh + (atr * zoneDeviation)
resistanceBottom = hmaHigh

// Support Zone
supportTop = hmaLow
supportBottom = hmaLow - (atr * zoneDeviation)

// ═══════════════════════════════════════════
// VOLUME PROFILE
// ═══════════════════════════════════════════

// Calculate price range outside conditional scope
priceHigh = ta.highest(high, volProfileLen)
priceLow = ta.lowest(low, volProfileLen)
priceRange = priceHigh - priceLow
binSize = priceRange / volBins

var array<float> volProfile = array.new_float(volBins, 0)

if barstate.islast and showVolProfile
    // Reset array
    array.fill(volProfile, 0)
    
    // Calculate volume for each price bin
    for i = 0 to math.min(volProfileLen - 1, bar_index)
        price = close[i]
        vol = volume[i]
        binIndex = math.floor((price - priceLow) / binSize)
        binIndex := math.max(0, math.min(volBins - 1, binIndex))
        currentVol = array.get(volProfile, binIndex)
        array.set(volProfile, binIndex, currentVol + vol)

// Find POC (Point of Control - highest volume bin)
maxVol = showVolProfile ? array.max(volProfile) : 0
pocIndex = showVolProfile ? array.indexof(volProfile, maxVol) : 0
pocPrice = showVolProfile ? priceLow + (pocIndex * (priceHigh - priceLow) / volBins) : na

// ═══════════════════════════════════════════
// LIQUIDITY ZONES
// ═══════════════════════════════════════════

// Equal Highs (Liquidity Pool)
equalHighs = high == high[1] and high > high[2]
equalHighPrice = equalHighs ? high : na

// Equal Lows (Liquidity Pool)
equalLows = low == low[1] and low < low[2]
equalLowPrice = equalLows ? low : na

// Swing Highs/Lows
swingHigh = ta.pivothigh(high, 5, 5)
swingLow = ta.pivotlow(low, 5, 5)

// ═══════════════════════════════════════════
// PLOTS
// ═══════════════════════════════════════════

// Moving Averages
p_fast = plot(fastMA, "Fast MA", color=color.new(trendColor, 0), linewidth=2)
p_slow = plot(slowMA, "Slow MA", color=color.new(trendColor, 40), linewidth=2)
plot(trendMA, "Trend MA", color=color.new(trendColor, 60), linewidth=3)

// MA Cloud Fill
cloudColor = bullTrend ? color.new(bullTrendColor, 90) : color.new(bearTrendColor, 90)
fill(p_fast, p_slow, color=showMACloud ? cloudColor : na, title="MA Cloud")

// Support/Resistance Zones with glowing borders
p1 = plot(showZones ? resistanceTop : na, "Resistance Top", color=color.new(#FF0066, 0), linewidth=2, style=plot.style_line)
p2 = plot(showZones ? resistanceBottom : na, "Resistance Bottom", color=color.new(#FF0066, 0), linewidth=2, style=plot.style_line)
fill(p1, p2, color=resistanceColor, title="Resistance Zone")

p3 = plot(showZones ? supportTop : na, "Support Top", color=color.new(#00FF88, 0), linewidth=2, style=plot.style_line)
p4 = plot(showZones ? supportBottom : na, "Support Bottom", color=color.new(#00FF88, 0), linewidth=2, style=plot.style_line)
fill(p3, p4, color=supportColor, title="Support Zone")

// POC Line
plot(showVolProfile ? pocPrice : na, "POC", color=color.new(#FFD700, 0), 
     linewidth=2, style=plot.style_cross)

// Liquidity Zones
plotshape(showLiquidity and equalHighs, "Equal Highs", shape.triangledown, 
          location.abovebar, color=color.new(resistanceColor, 0), size=size.tiny)
plotshape(showLiquidity and equalLows, "Equal Lows", shape.triangleup, 
          location.belowbar, color=color.new(supportColor, 0), size=size.tiny)

// Swing Points
plotshape(showLiquidity and not na(swingHigh), "Swing High", shape.diamond, 
          location.abovebar, color=color.new(bearTrendColor, 50), size=size.tiny)
plotshape(showLiquidity and not na(swingLow), "Swing Low", shape.diamond, 
          location.belowbar, color=color.new(bullTrendColor, 50), size=size.tiny)

// ═══════════════════════════════════════════
// TREND BACKGROUND
// ═══════════════════════════════════════════

bgColor = bullTrend ? color.new(bullTrendColor, 95) : 
          bearTrend ? color.new(bearTrendColor, 95) : na
bgcolor(bgColor, title="Trend Background")

// ═══════════════════════════════════════════
// SIGNALS
// ═══════════════════════════════════════════

// Trend Change Signals
bullSignal = ta.crossover(fastMA, slowMA) and close > trendMA
bearSignal = ta.crossunder(fastMA, slowMA) and close < trendMA

// Zone Touch Signals
supportTouch = low <= supportTop and low >= supportBottom and bullTrend
resistanceTouch = high >= resistanceBottom and high <= resistanceTop and bearTrend

// Signal Markers
plotshape(bullSignal, "Bull Signal", shape.labelup, location.belowbar, 
          color=bullTrendColor, text="BUY", textcolor=color.white, size=size.small)
plotshape(bearSignal, "Bear Signal", shape.labeldown, location.abovebar, 
          color=bearTrendColor, text="SELL", textcolor=color.white, size=size.small)

plotshape(supportTouch, "Support Touch", shape.circle, location.belowbar, 
          color=supportColor, size=size.tiny)
plotshape(resistanceTouch, "Resistance Touch", shape.circle, location.abovebar, 
          color=resistanceColor, size=size.tiny)

// ═══════════════════════════════════════════
// DASHBOARD
// ═══════════════════════════════════════════

var table dashboard = table.new(position.top_right, 2, 7, 
                                 border_width=1, 
                                 border_color=color.new(color.gray, 50),
                                 frame_width=1,
                                 frame_color=color.new(color.gray, 50))

if barstate.islast
    // Header
    table.cell(dashboard, 0, 0, "Cascade Navigator", text_color=color.white, 
               bgcolor=color.new(color.gray, 30), text_size=size.normal)
    table.cell(dashboard, 1, 0, "Status", text_color=color.white, 
               bgcolor=color.new(color.gray, 30), text_size=size.normal)
    
    // Trend
    trendText = bullTrend ? "BULLISH" : bearTrend ? "BEARISH" : "NEUTRAL"
    trendBg = bullTrend ? color.new(bullTrendColor, 70) : 
              bearTrend ? color.new(bearTrendColor, 70) : 
              color.new(color.gray, 70)
    table.cell(dashboard, 0, 1, "Trend", text_color=color.white, 
               bgcolor=color.new(color.gray, 80), text_size=size.small)
    table.cell(dashboard, 1, 1, trendText, text_color=color.white, 
               bgcolor=trendBg, text_size=size.small)
    
    // Trend Strength
    strengthText = str.tostring(math.round(trendStrength, 2)) + "%"
    table.cell(dashboard, 0, 2, "Strength", text_color=color.white, 
               bgcolor=color.new(color.gray, 80), text_size=size.small)
    table.cell(dashboard, 1, 2, strengthText, text_color=color.white, 
               bgcolor=color.new(color.gray, 70), text_size=size.small)
    
    // Price vs POC
    pocDist = ((close - pocPrice) / pocPrice) * 100
    pocText = str.tostring(math.round(pocDist, 2)) + "%"
    pocBg = pocDist > 0 ? color.new(bullTrendColor, 70) : color.new(bearTrendColor, 70)
    table.cell(dashboard, 0, 3, "POC Distance", text_color=color.white, 
               bgcolor=color.new(color.gray, 80), text_size=size.small)
    table.cell(dashboard, 1, 3, pocText, text_color=color.white, 
               bgcolor=pocBg, text_size=size.small)
    
    // Support Distance
    suppDist = ((close - supportTop) / close) * 100
    suppText = str.tostring(math.round(suppDist, 2)) + "%"
    table.cell(dashboard, 0, 4, "Support Dist", text_color=color.white, 
               bgcolor=color.new(color.gray, 80), text_size=size.small)
    table.cell(dashboard, 1, 4, suppText, text_color=color.white, 
               bgcolor=color.new(supportColor, 50), text_size=size.small)
    
    // Resistance Distance
    resDist = ((resistanceBottom - close) / close) * 100
    resText = str.tostring(math.round(resDist, 2)) + "%"
    table.cell(dashboard, 0, 5, "Resistance Dist", text_color=color.white, 
               bgcolor=color.new(color.gray, 80), text_size=size.small)
    table.cell(dashboard, 1, 5, resText, text_color=color.white, 
               bgcolor=color.new(resistanceColor, 50), text_size=size.small)
    
    // Signal
    signalText = bullSignal ? "BUY" : 
                 bearSignal ? "SELL" : 
                 supportTouch ? "Support" : 
                 resistanceTouch ? "Resistance" : 
                 "None"
    signalBg = bullSignal or supportTouch ? color.new(bullTrendColor, 50) : 
               bearSignal or resistanceTouch ? color.new(bearTrendColor, 50) : 
               color.new(color.gray, 70)
    table.cell(dashboard, 0, 6, "Signal", text_color=color.white, 
               bgcolor=color.new(color.gray, 80), text_size=size.small)
    table.cell(dashboard, 1, 6, signalText, text_color=color.white, 
               bgcolor=signalBg, text_size=size.small)

// ═══════════════════════════════════════════
// ALERTS
// ═══════════════════════════════════════════

alertcondition(bullSignal, "Bullish Trend Change", "Cascade Navigator: Bullish Trend Change - Fast MA crossed above Slow MA")
alertcondition(bearSignal, "Bearish Trend Change", "Cascade Navigator: Bearish Trend Change - Fast MA crossed below Slow MA")
alertcondition(supportTouch, "Support Zone Touch", "Cascade Navigator: Price touched Support Zone in Bullish Trend")
alertcondition(resistanceTouch, "Resistance Zone Touch", "Cascade Navigator: Price touched Resistance Zone in Bearish Trend")
alertcondition(equalHighs, "Equal Highs Detected", "Cascade Navigator: Equal Highs - Potential Liquidity Pool")
alertcondition(equalLows, "Equal Lows Detected", "Cascade Navigator: Equal Lows - Potential Liquidity Pool")
