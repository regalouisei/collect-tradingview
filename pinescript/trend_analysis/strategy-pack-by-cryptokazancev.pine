//Ğ Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº @ZeeZeeMon
//@version=5
indicator("Cryptokazancev Strategy Pack", overlay=true, calc_bars_count = 1200)


// â”€â”€â”€ Ğ“Ğ Ğ£ĞŸĞŸĞ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
group_main       = "âš™ï¸ ===== ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ ====="
group_ob         = "ğŸŸ¦ ===== ĞÑ€Ğ´ĞµÑ€Ğ±Ğ»Ğ¾ĞºĞ¸ ====="
group_pivot      = "ğŸŸª ===== ĞŸĞ¸Ğ²Ğ¾Ñ‚Ñ‹ ====="
group_structure  = "ğŸŸ© ===== Ğ Ñ‹Ğ½Ğ¾Ñ‡Ğ½Ğ°Ñ Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° ====="
group_reversals  = "ğŸŸ¥ ===== Ğ Ğ°Ğ·Ğ²Ğ¾Ñ€Ğ¾Ñ‚Ğ½Ñ‹Ğµ ĞšĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ğ¸ ====="
group_zones      = "ğŸŸ¨ ===== Ğ—Ğ¾Ğ½Ñ‹ Ğ˜Ğ½Ñ‚ĞµÑ€ĞµÑĞ° ====="

// â”€â”€â”€ ĞĞ¡ĞĞĞ’ĞĞ«Ğ• ĞŸĞĞ ĞĞœĞ•Ğ¢Ğ Ğ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
enable_ob       = input.bool(true,  "ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ ĞÑ€Ğ´ĞµÑ€Ğ±Ğ»Ğ¾ĞºĞ¸",         group=group_main, inline = "ob1")
maxOBBlocks     = input.int(10,    "",   minval=1, maxval=30, group=group_main, inline = "ob1")
enable_pivots   = input.bool(false, "ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ ĞŸĞ¸Ğ²Ğ¾Ñ‚Ñ‹",             group=group_main, inline = "pivots")
pivotAnchorInput= input.string("ĞœĞµÑÑÑ‡Ğ½Ñ‹Ğµ", "", inline = "pivots", options=["Ğ”Ğ½ĞµĞ²Ğ½Ñ‹Ğµ","ĞĞµĞ´ĞµĞ»ÑŒĞ½Ñ‹Ğµ","ĞœĞµÑÑÑ‡Ğ½Ñ‹Ğµ","ĞšĞ²Ğ°Ñ€Ñ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ","Ğ“Ğ¾Ğ´Ğ¾Ğ²Ñ‹Ğµ"], group=group_main)

enable_structure = input.bool(true, "ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ¤Ğ¸Ğ±Ğ¾/Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ", group=group_main)
swingLen         = input.int(2,     "Ğ”Ğ»Ğ¸Ğ½Ğ° Ğ¡Ğ²Ğ¸Ğ½Ğ³Ğ°", inline = "fibo", minval=1, maxval=10, group=group_main)
deep             = input.int(100, title = "Ğ“Ğ»ÑƒĞ±Ğ¸Ğ½Ğ°", inline = "fibo", group=group_main, minval = 10, maxval = 1000, tooltip = "Ğ”Ğ»Ğ¸Ğ½Ğ° ÑĞ²Ğ¸Ğ½Ğ³Ğ° - ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞ²ĞµÑ‡ĞµĞ¹ ÑĞ»ĞµĞ²Ğ° Ğ¸ ÑĞ¿Ñ€Ğ°Ğ²Ğ° Ğ¾Ñ‚ ÑĞºÑÑ‚Ñ€ĞµĞ¼ÑƒĞ¼Ğ°, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ğ½ ÑÑ‡Ğ¸Ñ‚Ğ°Ğ»ÑÑ ÑĞ²Ğ¸Ğ½Ğ³Ğ¾Ğ¼ Ğ¸ ÑƒÑ‡Ğ°Ğ²ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ» Ğ² Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğ¸ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹. ĞŸÑ€Ğ¸ Ğ¿Ñ€Ğ¾Ğ±Ğ¾Ğµ ÑƒÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ·Ğ°ĞºÑ€ĞµĞ¿Ğ»ĞµĞ½Ğ¸Ğµ Ğ¢Ğ•Ğ›ĞĞœ.\n\nĞ“Ğ»ÑƒĞ±Ğ¸Ğ½Ğ° Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ Ğ·Ğ° Ñ‚Ğ¾, ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ñ… ÑĞ²ĞµÑ‡ĞµĞ¹ ÑƒÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ´Ğ»Ñ Ğ¿Ğ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ñ Ğ¤Ğ¸Ğ±Ğ¾/Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹. Ğ§ĞµĞ¼ Ğ¼ĞµĞ½ÑŒÑˆĞµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ, Ñ‚ĞµĞ¼ Ğ±Ğ¾Ğ»ĞµĞµ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½ĞµĞµ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ÑÑ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°\n")

struct_reversal  = input.bool(true, "ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¸Ğ½Ğ±Ğ°Ñ€Ñ‹ Ğ¸ Ğ¿Ğ¾Ğ³Ğ»Ğ¾Ñ‰ĞµĞ½Ğ¸Ñ",         group=group_main)
ZIenable_zones   = input.bool(false, "ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ—Ğ¾Ğ½Ñ‹ Ğ˜Ğ½Ñ‚ĞµÑ€ĞµÑĞ°",     group=group_main)


// â”€â”€â”€ Ğ—ĞĞĞ« Ğ˜ĞĞ¢Ğ•Ğ Ğ•Ğ¡Ğ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ZIlookback         = input.int(10, "ĞŸĞµÑ€Ğ¸Ğ¾Ğ´ Ğ¿Ğ¾Ğ¸ÑĞºĞ° ÑĞ²Ğ¸Ğ½Ğ³-Ñ‚Ğ¾Ñ‡ĞµĞº", group = group_zones,tooltip = "Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ ÑĞ²ĞµÑ‡ĞµĞ¹ Ğ²Ğ»ĞµĞ²Ğ¾ Ğ¸ Ğ²Ğ¿Ñ€Ğ°Ğ²Ğ¾ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ½Ğ°Ñ…Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼Ğ¾Ğ² Ğ¸ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼Ğ¾Ğ²")
ZImultiplier_ATR   = input.float(1.0, step=0.1, minval=0.1, maxval=5.0, title="ĞœĞ½Ğ¾Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ° Ğ·Ğ¾Ğ½Ñ‹", group = group_zones,tooltip = "Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½ Ğ·Ğ¾Ğ½Ñ‹ Ğ¸Ğ½Ñ‚ĞµÑ€ĞµÑĞ° Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ²Ğ¾Ğ»Ğ°Ñ‚Ğ¸Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸")
ZIminSwingCount    = input.int(5, title="ĞœĞ¸Ğ½. ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞ²Ğ¸Ğ½Ğ³Ğ¾Ğ² Ğ² Ğ·Ğ¾Ğ½Ğµ", minval=3, group = group_zones,tooltip = "Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ ÑĞ²Ğ¸Ğ½Ğ³Ğ¾Ğ² Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ¿Ğ¾Ğ¿Ğ°ÑÑ‚ÑŒ Ğ² Ğ·Ğ¾Ğ½Ñƒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ğ½Ğ° ÑÑ‡Ğ¸Ñ‚Ğ°Ğ»Ğ°ÑÑŒ Ğ·Ğ½Ğ°Ñ‡Ğ¸Ğ¼Ğ¾Ğ¹")
ZImaxZonesToDraw   = input.int(10, title="ĞœĞ°ĞºÑ. ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµĞ¼Ñ‹Ñ… Ğ·Ğ¾Ğ½", minval=1, group = group_zones)
ZImaxCandles       = input.int(1000, maxval = 1100, title="ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ ÑĞ²ĞµÑ‡ĞµĞ¹ Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°", group = group_zones,tooltip="Ğ¡Ğ²Ğ¸Ğ½Ğ³Ğ¸ Ğ²Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ° Ğ½Ğµ ÑƒÑ‡Ğ°ÑÑ‚Ğ²ÑƒÑÑ‚ Ğ² Ğ¿Ğ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğ¸ Ğ·Ğ¾Ğ½")
ZIshowDebug        = input.bool(false, title="ĞÑ‚Ğ»Ğ°Ğ´ĞºĞ°", group = group_zones,tooltip="ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµÑ‚ ÑĞ²Ğ¸Ğ½Ğ³-Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ğ¸ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ ATR Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸")
ZIcolor            = input.color(color.rgb(255, 235, 59, 85),      "Ğ—Ğ¾Ğ½Ğ° Ğ¸Ğ½Ñ‚ĞµÑ€ĞµÑĞ°", group=group_zones)
ZITextColor        = input.color(color.rgb(0, 0, 0, 50), title = "Ğ¦Ğ²ĞµÑ‚ Ñ‚ĞµĞºÑÑ‚Ğ°", group=group_zones)


// â”€â”€â”€ ĞĞ Ğ”Ğ•Ğ Ğ‘Ğ›ĞĞšĞ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ² ÑĞµĞºÑ†Ğ¸Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº Ğ¸Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€Ğ°
// leftBars = input.int(3, "Ğ¡Ğ²ĞµÑ‡ĞµĞ¹ ÑĞ»ĞµĞ²Ğ° Ğ´Ğ»Ñ ÑĞ²Ğ¸Ğ½Ğ³Ğ°", minval=1, maxval=5,  group=group_ob)
// rightBars = input.int(3, "Ğ¡Ğ²ĞµÑ‡ĞµĞ¹ ÑĞ¿Ñ€Ğ°Ğ²Ğ° Ğ´Ğ»Ñ ÑĞ²Ğ¸Ğ½Ğ³Ğ°", minval=1, maxval=5,  group=group_ob)
bullOBColor = input.color(color.rgb(76, 175, 80, 90), "Ğ‘Ñ‹Ñ‡Ğ¸Ğ¹ OB",  group=group_ob)
bearOBColor = input.color(color.rgb(242, 54, 69, 90),   "ĞœĞµĞ´Ğ²ĞµĞ¶Ğ¸Ğ¹ OB",group=group_ob)
OBTextColor        = input.color(color.rgb(0, 0, 0, 50), title = "Ğ¦Ğ²ĞµÑ‚ Ñ‚ĞµĞºÑÑ‚Ğ°", group=group_ob)

// â”€â”€â”€ ĞŸĞ˜Ğ’ĞĞ¢Ğ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
showLabelsInput = true    // Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ»ĞµĞ¹Ğ±Ğ»Ñ‹
showPricesInput = true    // Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ†ĞµĞ½Ñ‹
linewidthInput  = 1       // Ñ‚Ğ¾Ğ»Ñ‰Ğ¸Ğ½Ğ°

// â”€â”€â”€ Ğ Ğ«ĞĞĞ§ĞĞĞ¯ Ğ¡Ğ¢Ğ Ğ£ĞšĞ¢Ğ£Ğ Ğ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
bullColor   = input.color(color.rgb(76, 175, 80, 90),      "Ğ’Ğ¾ÑÑ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğ¹ Ğ¢Ñ€ĞµĞ½Ğ´",    inline="c1", group=group_structure)
bearColor   = input.color(color.rgb(242, 54, 69, 90),       "ĞĞ¸ÑÑ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğ¹ Ğ¢Ñ€ĞµĞ½Ğ´",    inline="c1", group=group_structure)
Color_618   = input.color(color.rgb(0, 119, 255, 75),       "Ğ—Ğ¾Ğ½Ğ° 0.618",          inline="c2", group=group_structure)
Color_786   = input.color(color.rgb(76, 175, 80, 75),      "Ğ—Ğ¾Ğ½Ğ° 0.786",          inline="c2", group=group_structure)
StructureTextColor        = input.color(color.rgb(0, 0, 0, 1), title = "Ğ¦Ğ²ĞµÑ‚ Ñ‚ĞµĞºÑÑ‚Ğ°", group=group_structure)

// â”€â”€â”€ Ğ ĞĞ—Ğ’ĞĞ ĞĞ¢ĞĞ«Ğ• ĞšĞĞĞ¡Ğ¢Ğ Ğ£ĞšĞ¦Ğ˜Ğ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
bull_color           = input.color(color.green,  "Ğ‘Ñ‹Ñ‡ÑŒĞµ ĞŸĞ¾Ğ³Ğ»Ğ¾Ñ‰ĞµĞ½Ğ¸Ğµ",           inline="a1", group=group_reversals)
bear_color           = input.color(color.red,    "ĞœĞµĞ´Ğ²ĞµĞ¶ÑŒĞµ ĞŸĞ¾Ğ³Ğ»Ğ¾Ñ‰ĞµĞ½Ğ¸Ğµ",        inline="a1", group=group_reversals)
show_details          = input.bool(false, title = "ĞÑ‚Ğ»Ğ°Ğ´ĞºĞ°", group = group_reversals,tooltip = "Ğ Ğ°Ğ·Ğ¼ĞµÑ€ Ñ‚ĞµĞ»Ğ° Ğ¸ Ñ‚ĞµĞ½Ğ¸ Ğ¿Ğ¸Ğ½Ğ±Ğ°Ñ€Ğ° Ğ² Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚Ğ°Ñ…")
multiplier_ATR        = input.float(0.8, step=0.05, minval=0.7, maxval=5.0, title = "ĞœĞ½Ğ¾Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒ Ñ„Ğ¸Ñ‚Ğ¸Ğ»Ñ Ğ¿Ğ¸Ğ½Ğ±Ğ°Ñ€Ğ°", tooltip = "ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½ÑƒÑ Ğ´Ğ»Ğ¸Ğ½Ñƒ Ñ„Ğ¸Ñ‚Ğ¸Ğ»Ñ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ ATR 500 ÑĞ²ĞµÑ‡ĞµĞ¹")
multiplier_ENGULFING  = input.float(0.8, step=0.05, minval=0.7, maxval=5.0, title = "ĞœĞ½Ğ¾Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒ Ñ‚ĞµĞ»Ğ° Ğ¿Ğ¾Ğ³Ğ»Ğ¾Ñ‰Ğ°ÑÑ‰ĞµĞ¹ ÑĞ²ĞµÑ‡Ğ¸",tooltip = "ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ñ‚ĞµĞ»Ğ° Ğ¿Ğ¾Ğ³Ğ»Ğ¾Ñ‰Ğ°ÑÑ‰ĞµĞ¹ ÑĞ²ĞµÑ‡Ğ¸")




// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Ğ—Ğ¾Ğ½Ñ‹ Ğ¸Ğ½Ñ‚ĞµÑ€ĞµÑĞ°

var int BARS_COUNT = 0
BARS_COUNT += 1
count = 500
// === Ğ ĞĞ¡Ğ§Ğ•Ğ¢ ATR ===
percent_range = (high - low) / low * 100
custom_atr = ta.sma(percent_range, count) * ZImultiplier_ATR / 100
atr = ta.sma(percent_range, count)

// === Ğ¡Ğ’Ğ˜ĞĞ“-Ğ¢ĞĞ§ĞšĞ˜ ===
SwingHIGH = ta.pivothigh(open, ZIlookback, ZIlookback)
SwingLOW = ta.pivotlow(close, ZIlookback, ZIlookback)
phC = na(SwingHIGH) ? na : SwingHIGH
plC = na(SwingLOW) ? na : SwingLOW

plot(ZIshowDebug ? phC : na, style=plot.style_circles, linewidth=3, color=color.green, offset=-ZIlookback)
plot(ZIshowDebug ? plC : na, style=plot.style_circles, linewidth=3, color=color.red, offset=-ZIlookback)

// === ĞœĞĞ¡Ğ¡Ğ˜Ğ’ Ğ”Ğ›Ğ¯ Ğ¡Ğ’Ğ˜ĞĞ“ĞĞ’ ===
type SwingPoint
    float price
    int index

var SwingPoint[] SWINGS = array.new<SwingPoint>()

// === Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ¯ Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ˜Ğ¯ Ğ¡Ğ’Ğ˜ĞĞ“ĞĞ’ ===
ADD_TO_SWING(val, idx) =>
    if array.size(SWINGS) > 0
        for i = array.size(SWINGS) - 1 to 0
            sp = array.get(SWINGS, i)
            if idx - sp.index > ZImaxCandles
                array.remove(SWINGS, i)

    array.push(SWINGS, SwingPoint.new(val, idx))

// === Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ¡Ğ’Ğ˜ĞĞ“ĞĞ’ Ğ’ ĞœĞĞ¡Ğ¡Ğ˜Ğ’ ===
if not na(SwingHIGH)
    ADD_TO_SWING(SwingHIGH, bar_index - ZIlookback)
if not na(SwingLOW)
    ADD_TO_SWING(SwingLOW, bar_index - ZIlookback)

// === Ğ¡Ğ¢Ğ Ğ£ĞšĞ¢Ğ£Ğ Ğ« Ğ”ĞĞĞĞ«Ğ¥ ===
type Zone
    float minPrice
    float maxPrice
    int count

type FoundZone
    float low
    float high
    int count

// === ĞœĞĞ¡Ğ¡Ğ˜Ğ’Ğ« ĞšĞĞĞ”Ğ˜Ğ”ĞĞ¢ĞĞ’ Ğ˜ ĞĞĞ™Ğ”Ğ•ĞĞĞ«Ğ¥ Ğ—ĞĞ ===
var Zone[] zoneCandidates = array.new<Zone>()
var FoundZone[] foundZones = array.new<FoundZone>()

// === Ğ ĞĞ¡Ğ§Ğ•Ğ¢ ĞšĞĞĞ”Ğ˜Ğ”ĞĞ¢ĞĞ’ Ğ—ĞĞ ===
if barstate.islast and array.size(SWINGS) > 0
    array.clear(zoneCandidates)
    array.clear(foundZones)

    for i = 0 to array.size(SWINGS) - 1
        center = array.get(SWINGS, i).price
        upper = center * (1 + custom_atr)
        lower = center

        tempCount = 0
        float minInZone = na
        float maxInZone = na

        for j = 0 to array.size(SWINGS) - 1
            val = array.get(SWINGS, j).price
            if val >= lower and val <= upper
                tempCount += 1
                minInZone := na(minInZone) ? val : math.min(minInZone, val)
                maxInZone := na(maxInZone) ? val : math.max(maxInZone, val)

        if tempCount >= ZIminSwingCount
            array.push(zoneCandidates, Zone.new(minInZone, maxInZone, tempCount))

// === Ğ£Ğ”ĞĞ›Ğ•ĞĞ˜Ğ• ĞŸĞ•Ğ Ğ•Ğ¡Ğ•ĞšĞĞ®Ğ©Ğ˜Ğ¥Ğ¡Ğ¯ Ğ—ĞĞ ===
remove_overlapping_zones() =>
    for i = array.size(zoneCandidates) - 1 to 0
        candidate = array.get(zoneCandidates, i)
        overlaps = false
        for z = 0 to array.size(foundZones) - 1
            fz = array.get(foundZones, z)
            if candidate.minPrice <= fz.high and candidate.maxPrice >= fz.low
                overlaps := true
                break
        if overlaps
            array.remove(zoneCandidates, i)

// === ĞŸĞĞ˜Ğ¡Ğš Ğ˜ Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ›Ğ£Ğ§Ğ¨Ğ˜Ğ¥ Ğ—ĞĞ ===
if barstate.islast
    while array.size(zoneCandidates) > 0
        maxCount = -1
        maxIndex = -1
        for i = 0 to array.size(zoneCandidates) - 1
            z = array.get(zoneCandidates, i)
            if z.count > maxCount
                maxCount := z.count
                maxIndex := i
        if maxIndex == -1
            break
        bestZone = array.get(zoneCandidates, maxIndex)
        newZone = FoundZone.new(bestZone.minPrice, bestZone.maxPrice, bestZone.count)
        array.push(foundZones, newZone)

        remove_overlapping_zones()

// === Ğ¥Ğ ĞĞĞ•ĞĞ˜Ğ• Ğ˜ Ğ£Ğ”ĞĞ›Ğ•ĞĞ˜Ğ• ĞŸĞ Ğ¯ĞœĞĞ£Ğ“ĞĞ›Ğ¬ĞĞ˜ĞšĞĞ’ ===
var box[] zoneBoxes = array.new<box>()

clear_zone_boxes() =>
    if array.size(zoneBoxes) > 0
        for i = 0 to array.size(zoneBoxes) - 1
            b = array.get(zoneBoxes, i)
            box.delete(b)
    array.clear(zoneBoxes)

// === ĞĞ¢Ğ Ğ˜Ğ¡ĞĞ’ĞšĞ ĞŸĞ Ğ¯ĞœĞĞ£Ğ“ĞĞ›Ğ¬ĞĞ˜ĞšĞĞ’ Ğ”Ğ›Ğ¯ Ğ—ĞĞ ===
if barstate.islast
    clear_zone_boxes()

    zonesToDraw = math.min(array.size(foundZones), ZImaxZonesToDraw)
    if zonesToDraw > 0 and bar_index > ZImaxCandles and ZIenable_zones
        for i = 0 to zonesToDraw - 1
            z = array.get(foundZones, i)
            leftTime = time[ZImaxCandles]
            rightTime = time

            labelText = "Ğ—Ğ¾Ğ½Ğ° Ğ¸Ğ½Ñ‚ĞµÑ€ĞµÑĞ°\nĞšĞ°ÑĞ°Ğ½Ğ¸Ğ¹: " + str.tostring(z.count)
            b = box.new(left = leftTime,right = rightTime,top = z.high,bottom = z.low,text = labelText, text_color = ZITextColor, text_halign = text.align_right,text_size = size.small,border_color = ZIcolor,bgcolor = ZIcolor,xloc = xloc.bar_time)
            array.push(zoneBoxes, b)





// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Ğ¤Ğ¸Ğ±Ğ¾/Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°

if enable_structure and bar_index >= last_bar_index - deep


    // ========== Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… ==========
    // -- ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ ÑĞºÑÑ‚Ñ€ĞµĞ¼ÑƒĞ¼Ñ‹ --
    var float NewKeySwingHigh = na
    var float NewKeySwingLow  = na
    var float PrevKeyHigh     = na
    var float PrevKeyLow      = na

    // -- Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ ÑĞºÑÑ‚Ñ€ĞµĞ¼ÑƒĞ¼Ñ‹ --
    var float tempPivotLow  = na
    var float tempPivotHigh = na

    // -- Ğ“Ñ€Ğ°Ñ„Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ñ‹ --
    var line  lastHighLine  = na
    var line  lastLowLine   = na
    var label lastHighLabel = na
    var label lastLowLabel  = na
    var box   premiumDiscountBox = na

    // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¸Ñ… Ğ·Ğ¾Ğ½ box
    var box box1 = na
    var box box2 = na
    var box box3 = na
    var box box4 = na


    // -- Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ --
    var int    KeyHighBar = na
    var int    KeyLowBar  = na
    var string TREND      = na

    // ========== ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ñ ==========
    // -- Ğ Ğ°ÑÑ‡ĞµÑ‚ ÑĞ²Ğ¸Ğ½Ğ³Ğ¾Ğ² --
    swingHigh = ta.pivothigh(high, swingLen, swingLen)  // Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼
    swingLow  = ta.pivotlow(low,  swingLen, swingLen)   // Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼

    // -- ĞĞ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ²Ğ¸Ğ½Ğ³Ğ¾Ğ² --
    if not na(swingLow)
        tempPivotLow := na(tempPivotLow) ? swingLow : math.min(tempPivotLow, swingLow)

    if not na(swingHigh)
        tempPivotHigh := na(tempPivotHigh) ? swingHigh : math.max(tempPivotHigh, swingHigh)

    // ========== Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ñ… ÑĞºÑÑ‚Ñ€ĞµĞ¼ÑƒĞ¼Ğ¾Ğ² ==========
    // -- Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿ĞµÑ€Ğ²Ñ‹Ñ… ÑĞºÑÑ‚Ñ€ĞµĞ¼ÑƒĞ¼Ğ¾Ğ² --
    if na(NewKeySwingHigh) and not na(swingHigh)
        NewKeySwingHigh := swingHigh
        KeyHighBar := bar_index - swingLen

    if na(NewKeySwingLow) and not na(swingLow)
        NewKeySwingLow := swingLow
        KeyLowBar := bar_index - swingLen

    // -- ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ»ÑÑ‡ĞµĞ²Ğ¾Ğ³Ğ¾ Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼Ğ° --
    if swingHigh > NewKeySwingHigh and (close[swingLen] > NewKeySwingHigh or open[swingLen] > NewKeySwingHigh)
        PrevKeyHigh     := NewKeySwingHigh
        NewKeySwingHigh := swingHigh
        if not na(tempPivotLow)
            NewKeySwingLow := tempPivotLow
        KeyHighBar      := bar_index - swingLen
        tempPivotLow    := na
        TREND := "UP"

    // -- ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ»ÑÑ‡ĞµĞ²Ğ¾Ğ³Ğ¾ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼Ğ° --
    if swingLow < NewKeySwingLow and (close[swingLen] < NewKeySwingLow or open[swingLen] < NewKeySwingLow)
        PrevKeyLow      := NewKeySwingLow
        NewKeySwingLow  := swingLow
        if not na(tempPivotHigh)
            NewKeySwingHigh := tempPivotHigh
        KeyLowBar       := bar_index - swingLen
        tempPivotHigh   := na
        TREND := "DOWN"

    // ========== Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ³Ñ€Ğ°Ñ„Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¼Ğ¸ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ°Ğ¼Ğ¸ ==========
    // -- ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ÑÑ‚Ğ°Ñ€Ñ‹Ñ… Ğ»Ğ¸Ğ½Ğ¸Ğ¹ --
    if not na(lastHighLine) and (not na(NewKeySwingHigh) and not na(KeyHighBar))
        line.delete(lastHighLine)
        lastHighLine := na

    if not na(lastLowLine) and (not na(NewKeySwingLow) and not na(KeyLowBar))
        line.delete(lastLowLine)
        lastLowLine := na

    // -- ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ÑÑ‚Ğ°Ñ€Ñ‹Ñ… Ğ¼ĞµÑ‚Ğ¾Ğº --
    if not na(lastHighLabel)
        label.delete(lastHighLabel)
        lastHighLabel := na

    if not na(lastLowLabel)
        label.delete(lastLowLabel)
        lastLowLabel := na

    // ========== Ğ’Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Premium/Discount Ğ·Ğ¾Ğ½ ==========
    // ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ÑÑ‚Ğ°Ñ€Ñ‹Ñ… Ğ·Ğ¾Ğ½
    if not na(box1)
        box.delete(box1)
    if not na(box2)
        box.delete(box2)
    if not na(box3)
        box.delete(box3)
    if not na(box4)
        box.delete(box4)

    // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ·Ğ¾Ğ½
    if not na(NewKeySwingHigh) and not na(NewKeySwingLow)
        float rangee = NewKeySwingHigh - NewKeySwingLow
        float fib_0_5   = NewKeySwingHigh - rangee * 0.5
        float fib_0_618 = NewKeySwingHigh - rangee * 0.382
        float fib_0_786 = NewKeySwingHigh - rangee * 0.214
        float Ufib_0_618 = NewKeySwingHigh - rangee * 0.618
        float Ufib_0_786 = NewKeySwingHigh - rangee * 0.786



        int left  = bar_index + 5
        int right = bar_index + 10


    
        if TREND == "UP"
            box1 := box.new(left=left, right=right, top=NewKeySwingHigh, bottom=fib_0_5, border_color=color.rgb(120, 123, 134, 100), bgcolor=bullColor,  text = "â†‘", text_color = StructureTextColor)
            box2 := box.new(left=left, right=right, top=fib_0_5, bottom=Ufib_0_618, border_color=color.rgb(120, 123, 134, 100), bgcolor=Color_618,  text = "0.618", text_color = StructureTextColor)
            box3 := box.new(left=left, right=right, top=Ufib_0_618, bottom=Ufib_0_786, border_color=color.rgb(0, 0, 0, 100), bgcolor=Color_786,  text = "0.786", text_color = StructureTextColor)
            box4 := box.new(left=left, right=right, top=Ufib_0_786, bottom=NewKeySwingLow, border_color=color.rgb(120, 123, 134, 100), bgcolor=bullColor)
        else if TREND == "DOWN"
            box1 := box.new(left=left, right=right, top=fib_0_5, bottom=NewKeySwingLow, border_color=color.rgb(120, 123, 134, 100), bgcolor=bearColor, text = "â†“", text_color = StructureTextColor)
            box2 := box.new(left=left, right=right, top=fib_0_618, bottom=fib_0_5, border_color=color.rgb(120, 123, 134, 100), bgcolor=Color_618, text = "0.618", text_color = StructureTextColor)
            box3 := box.new(left=left, right=right, top=fib_0_786, bottom=fib_0_618, border_color=color.rgb(120, 123, 134, 100), bgcolor=Color_786, text = "0.786", text_color = StructureTextColor)
            box4 := box.new(left=left, right=right, top=NewKeySwingHigh, bottom=fib_0_786, border_color=color.rgb(120, 123, 134, 100), bgcolor=bearColor)





// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Ğ Ğ°Ğ·Ğ²Ğ¾Ñ€Ğ¾Ñ‚Ğ½Ñ‹Ğµ

// === Ğ ĞĞ¡Ğ§Ğ•Ğ¢ ATR ===
percent_rangee = (high - low) / low * 100
atrr = ta.sma(percent_rangee, count)
custom_atr_PINBAR = atr * multiplier_ATR / 100
custom_atr_ENGULFING = atr * multiplier_ENGULFING / 100

// === ĞŸĞ˜ĞĞ‘ĞĞ  ===
// Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ Ñ‚ĞµĞ»Ğ° ÑĞ²ĞµÑ‡Ğ¸
body = math.abs(close - open) / low * 100
upper_wick = (high - math.max(open, close)) / low * 100
lower_wick = (math.min(open, close) - low) / low * 100

// Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ñ Ğ¿Ğ¸Ğ½Ğ±Ğ°Ñ€Ğ¾Ğ²
is_bull_pin = struct_reversal and lower_wick > body * 1.1 and lower_wick > atr * multiplier_ATR and lower_wick > 0.3 and low < low[1]
is_bear_pin = struct_reversal and upper_wick > body * 1.1 and upper_wick > atr * multiplier_ATR and upper_wick > 0.3 and high > high[1]

if struct_reversal and show_details
    if is_bull_pin
        label.new(bar_index, low, "Ğ¢ĞµĞ»Ğ¾: " + str.tostring(body, "#.##") + "%" + "\nĞ¢ĞµĞ½ÑŒ: " + str.tostring(lower_wick, "#.##") + "%",style=label.style_label_up, color=color.green, textcolor=color.black, size=size.small)
    if is_bear_pin
        label.new(bar_index, high, "Ğ¢ĞµĞ»Ğ¾: " + str.tostring(body, "#.##") + "%" + "\nĞ¢ĞµĞ½ÑŒ: " + str.tostring(upper_wick, "#.##") + "%",style=label.style_label_down, color=color.red, textcolor=color.white, size=size.small)

plotshape(struct_reversal and not show_details and is_bull_pin ? true : na, title="Bullish PinBar", location=location.belowbar,color=color.green, style=shape.labelup, text="Pin", textcolor=color.white)
plotshape(struct_reversal and not show_details and is_bear_pin ? true : na, title="Bearish PinBar", location=location.abovebar,color=color.red, style=shape.labeldown, text="Pin", textcolor=color.white)


// === ĞĞ‘ĞĞĞ Ğ£Ğ–Ğ•ĞĞ˜Ğ• ĞŸĞĞ“Ğ›ĞĞ©Ğ•ĞĞ˜Ğ™ ===
body_curr = math.abs(close - open) / open

// Ğ‘Ñ‹Ñ‡ÑŒĞµ Ğ¿Ğ¾Ğ³Ğ»Ğ¾Ñ‰ĞµĞ½Ğ¸Ğµ
is_bullish_engulfing = struct_reversal and close > open and close[1] < open[1] and open <= close[1] and close >= open[1] and body_curr * 100 > atr * multiplier_ENGULFING and low[1] < low[2]

// ĞœĞµĞ´Ğ²ĞµĞ¶ÑŒĞµ Ğ¿Ğ¾Ğ³Ğ»Ğ¾Ñ‰ĞµĞ½Ğ¸Ğµ
is_bearish_engulfing = struct_reversal and close < open and close[1] > open[1] and open >= close[1] and close <= open[1] and body_curr * 100 > atr * multiplier_ENGULFING and high[1] > high[2]

// === ĞĞšĞ ĞĞ¡ĞšĞ Ğ¡Ğ’Ğ•Ğ§Ğ•Ğ™ ===
barcolor(is_bullish_engulfing ? bull_color : na)
barcolor(is_bearish_engulfing ? bear_color : na)


// === Ğ•Ğ”Ğ˜ĞĞĞ¯ Ğ¢ĞĞ‘Ğ›Ğ˜Ğ¦Ğ Ğ”Ğ›Ğ¯ PINBAR Ğ¸ ĞŸĞĞ“Ğ›ĞĞ©Ğ•ĞĞ˜Ğ™ ===
var table atr_tablee = table.new(position=position.top_right, columns=1, rows=2, bgcolor=color.rgb(255, 235, 59, 70))

if barstate.islast and (show_details or ZIshowDebug)
    // ĞŸĞµÑ€Ğ²Ğ°Ñ ÑÑ‚Ñ€Ğ¾ĞºĞ° â€” Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾ PINBAR
    table.cell(atr_tablee, 0, 0, "ğŸ“ Ğ¡Ñ€. Ğ²Ğ¾Ğ»Ğ°Ñ‚Ğ¸Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ: " + str.tostring(atr, "#.##") + "%\nĞ¤Ğ¸Ñ‚Ğ¸Ğ»ÑŒ Ğ¾Ñ‚ ~" + str.tostring(custom_atr_PINBAR * 100, "#.##") + " %" + "%\nĞŸĞ¾Ğ³Ğ»Ğ¾Ñ‰ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚ ~" + str.tostring(custom_atr_ENGULFING * 100, "#.##") + " %", text_color=color.black, text_size=size.normal)





// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ ĞÑ€Ğ´ĞµÑ€Ğ±Ğ»Ğ¾ĞºĞ¸

// === ĞœĞ°ÑÑĞ¸Ğ²Ñ‹ ===
var box[] bullOBBoxes = array.new_box()
var box[] bearOBBoxes = array.new_box()

isSwingLow(idx) =>
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ñƒ Ğ½Ğ°Ñ Ğ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°
    if idx >= 3 and bar_index >= 3 + 3
        lowest = ta.lowest(low, 3 + 3 + 1)
        low[idx] == lowest[idx - 3]
    else
        false

isSwingHigh(idx) =>
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ñƒ Ğ½Ğ°Ñ Ğ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°
    if idx >= 3 and bar_index >= 3 + 3
        highest = ta.highest(high, 3 + 3 + 1)
        high[idx] == highest[idx - 3]
    else
        false

// === Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ¸Ñ‚Ñ‹Ñ… Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ¼Ğ°ÑÑĞ¸Ğ²Ğ° Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ñ… Ğ±Ğ»Ğ¾ĞºĞ¾Ğ² ===
cleanAndReturnValid(boxArray, isBull) =>
    if array.size(boxArray) > 0
        for i = array.size(boxArray) - 1 to 0
            b = array.get(boxArray, i)
            isBroken = isBull ? low < box.get_bottom(b) : high > box.get_top(b)
            if isBroken
                box.delete(b)
                array.remove(boxArray, i)
    array.size(boxArray)

// === ĞŸÑ€Ğ¾Ğ´Ğ»ĞµĞ½Ğ¸Ğµ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ñ… Ğ±Ğ»Ğ¾ĞºĞ¾Ğ² ===
extendIfValid(b, isBull) =>
    valid = isBull ? close >= box.get_bottom(b) : close <= box.get_top(b)
    if valid
        box.set_right(b, bar_index)

// === ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° ===

// 1. Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ±Ğ¸Ñ‚Ñ‹Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸ Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞºĞ¾Ğ»-Ğ²Ğ¾ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ñ…
cleanAndReturnValid(bullOBBoxes, true)
cleanAndReturnValid(bearOBBoxes, false)

// 2. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸, ĞµÑĞ»Ğ¸ ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ñ ÑĞ¾Ğ±Ğ»ÑĞ´ĞµĞ½Ñ‹

// Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ² Ñ€Ğ°Ğ·Ğ´ĞµĞ» Ğ¼Ğ°ÑÑĞ¸Ğ²Ğ¾Ğ²
var int[] bullOBProcessedBars = array.new_int()
var int[] bearOBProcessedBars = array.new_int()

// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ¸ ÑƒÑÑ‚Ğ°Ñ€ĞµĞ²ÑˆĞ¸Ñ… Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹
cleanProcessedArray(arr) =>
    if array.size(arr) > 0
        for j = array.size(arr) - 1 to 0
            if array.get(arr, j) < bar_index - 100
                array.remove(arr, j)

// 2. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸ (Ğ±Ñ‹Ñ‡ÑŒĞ¸)
cleanProcessedArray(bullOBProcessedBars)
for i = 1 to 4
    if bar_index >= i
        swingBar = bar_index - i
        if not array.includes(bullOBProcessedBars, swingBar)
            if (low > high[i] and isSwingLow(i) and enable_ob)
                while array.size(bullOBBoxes) >= maxOBBlocks
                    box.delete(array.shift(bullOBBoxes))
                rangePerc = ((high[i] - low[i]) / low[i]) * 100
                labelText = "â†‘ OB " + str.tostring(rangePerc, "#.##") + "%"
                b = box.new(
                  left=swingBar, 
                  right=bar_index, 
                  top=high[i], 
                  bottom=low[i],
                  bgcolor=bullOBColor,
                  border_color=color.new(bullOBColor, 90),
                  text=labelText,
                  text_color=OBTextColor,
                  text_size=size.small,
                  text_halign=text.align_right)
                array.push(bullOBBoxes, b)
                array.push(bullOBProcessedBars, swingBar)


// 2. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸ (Ğ¼ĞµĞ´Ğ²ĞµĞ¶ÑŒĞ¸)
cleanProcessedArray(bearOBProcessedBars)
for i = 1 to 4
    if bar_index >= i
        swingBar = bar_index - i
        if not array.includes(bearOBProcessedBars, swingBar)
            if (high < low[i] and isSwingHigh(i) and enable_ob)
                while array.size(bearOBBoxes) >= maxOBBlocks
                    box.delete(array.shift(bearOBBoxes))
                rangePerc = ((high[i] - low[i]) / high[i]) * 100
                labelText = "â†“ OB " + str.tostring(rangePerc, "#.##") + "%"
                b = box.new(
                  left=swingBar,
                  right=bar_index,
                  top=high[i],
                  bottom=low[i],
                  bgcolor=bearOBColor,
                  border_color=color.new(bearOBColor, 90),
                  text=labelText,
                  text_color=OBTextColor,
                  text_size=size.small,
                  text_halign=text.align_right)
                array.push(bearOBBoxes, b)
                array.push(bearOBProcessedBars, swingBar)



















// 3. ĞŸÑ€Ğ¾Ğ´Ğ»ĞµĞ²Ğ°ĞµĞ¼ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸
if array.size(bullOBBoxes) > 0
    for i = 0 to array.size(bullOBBoxes) - 1
        extendIfValid(array.get(bullOBBoxes, i), true)

if array.size(bearOBBoxes) > 0
    for i = 0 to array.size(bearOBBoxes) - 1
        extendIfValid(array.get(bearOBBoxes, i), false)







// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ ĞŸĞ¸Ğ²Ğ¾Ñ‚Ñ‹

// Ğ¦Ğ²ĞµÑ‚ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… ÑƒÑ€Ğ¾Ğ²Ğ½ĞµĞ¹
DEFAULT_COLOR = #FB8C00
commonColorInput = input.color(DEFAULT_COLOR, "Ğ¦Ğ²ĞµÑ‚ ÑƒÑ€Ğ¾Ğ²Ğ½ĞµĞ¹", group= group_pivot, inline = "pivots", display = display.data_window)

// ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ ÑƒÑ€Ğ¾Ğ²Ğ½ĞµĞ¹ â€” Ğ²ÑĞµ ÑƒÑ€Ğ¾Ğ²Ğ½Ğ¸ Ğ²ÑĞµĞ³Ğ´Ğ° Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ñ‹
type graphicSettings
    string levelName
    bool showLevel

var graphicSettingsArray = array.from(graphicSettings.new(" P", true),graphicSettings.new("R1", true),graphicSettings.new("S1", true),graphicSettings.new("R2", true),graphicSettings.new("S2", true),graphicSettings.new("R3", true),graphicSettings.new("S3", true),graphicSettings.new("R4", true),graphicSettings.new("S4", true))

autoAnchor = switch
    timeframe.isintraday => timeframe.multiplier <= 15 ? "1D" : "1W"
    timeframe.isdaily    => "1M"
    => "12M"

pivotTimeframe = switch pivotAnchorInput
    "Auto"      => autoAnchor
    "Ğ”Ğ½ĞµĞ²Ğ½Ñ‹Ğµ"     => "1D"
    "ĞĞµĞ´ĞµĞ»ÑŒĞ½Ñ‹Ğµ"    => "1W"
    "ĞœĞµÑÑÑ‡Ğ½Ñ‹Ğµ"   => "1M"
    "ĞšĞ²Ğ°Ñ€Ñ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ" => "3M"
    => "12M"

pivotYearMultiplier = switch pivotAnchorInput
    "Biyearly"       => 2
    "Triyearly"      => 3
    "Quinquennially" => 5
    "Decennially"    => 10
    => 1

type pivotGraphic
    line pivotLine
    label pivotLabel

method delete(pivotGraphic graphic) =>
    graphic.pivotLine.delete()
    graphic.pivotLabel.delete()

var drawnGraphics = matrix.new<pivotGraphic>()

localPivotTimeframeChange = timeframe.change(pivotTimeframe) and year % pivotYearMultiplier == 0
securityPivotTimeframeChange = timeframe.change(timeframe.period) and year % pivotYearMultiplier == 0

pivotTimeframeChangeCounter(condition) =>
    var count = 0
    if condition and bar_index > 0
        count += 1
    count

localPivots = ta.pivot_point_levels("Camarilla", localPivotTimeframeChange)
securityPivotPointsArray = ta.pivot_point_levels("Camarilla", securityPivotTimeframeChange)

securityTimeframe = timeframe.isintraday ? "1D" : timeframe.period
[securityPivots, securityPivotCounter] = request.security(syminfo.tickerid, pivotTimeframe, [securityPivotPointsArray, pivotTimeframeChangeCounter(securityPivotTimeframeChange)], lookahead = barmerge.lookahead_on)
pivotPointsArray = securityPivots  // Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾ Ğ´Ğ½ĞµĞ²Ğ½Ñ‹Ğ¼ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸ÑĞ¼

affixOldPivots(endTime) =>
    if drawnGraphics.rows() > 0
        lastGraphics = drawnGraphics.row(drawnGraphics.rows() - 1)
        for graphic in lastGraphics
            graphic.pivotLine.set_x2(endTime)
            graphic.pivotLabel.set_x(endTime)

drawNewPivots(startTime) =>
    newGraphics = array.new<pivotGraphic>()
    for [index, coord] in pivotPointsArray
        if index < array.size(graphicSettingsArray)
            levelSettings = graphicSettingsArray.get(index)
            if not na(coord) and levelSettings.showLevel and enable_pivots
                lineEndTime = startTime + timeframe.in_seconds(pivotTimeframe) * 1000 * pivotYearMultiplier
                pivotLine = line.new(startTime, coord, lineEndTime, coord, xloc = xloc.bar_time, color=commonColorInput, width=linewidthInput)
                pivotLabel = label.new(x = lineEndTime, y = coord, text = (showLabelsInput ? levelSettings.levelName + " " : "") + (showPricesInput ? "(" + str.tostring(coord, format.mintick) + ")" : ""), style = label.style_label_left, textcolor = commonColorInput, color = #00000000, xloc = xloc.bar_time)
                newGraphics.push(pivotGraphic.new(pivotLine, pivotLabel))
    drawnGraphics.add_row(array_id = newGraphics)
    if drawnGraphics.rows() > 1
        oldGraphics = drawnGraphics.remove_row(0)
        for graphic in oldGraphics
            graphic.delete()

localPivotDrawConditionStatic = false
securityPivotDrawConditionStatic = securityPivotCounter != securityPivotCounter[1]

var isMultiYearly = array.from("Biyearly", "Triyearly", "Quinquennially", "Decennially").includes(pivotAnchorInput)
localPivotDrawConditionDeveloping = time_close == time_close(pivotTimeframe) and not isMultiYearly
securityPivotDrawConditionDeveloping = false

if (securityPivotDrawConditionStatic or localPivotDrawConditionStatic)
    affixOldPivots(time)
    drawNewPivots(time)

var FIRST_BAR_TIME = time
if (barstate.islastconfirmedhistory and drawnGraphics.columns() == 0)
    if not na(securityPivots) and securityPivotCounter > 0
        drawNewPivots(FIRST_BAR_TIME)
    else
        runtime.error("Not enough data to calculate Pivot Points. Lower the Pivots Timeframe in the indicator settings.")
