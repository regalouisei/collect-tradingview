//@version=6
indicator("[blackcat] L1 Uptrend Entry Indicator", shorttitle="L1 Uptrend Entry", overlay=true, max_bars_back=5000, max_labels_count = 500)

// ============================================================
// Input Parameters
// ============================================================
period1 = input.int(20, "Period 1", minval=1, group="Settings")
period2 = input.int(60, "Period 2", minval=1, group="Settings")
showStatusTable = input.bool(true, "Show Status Table", group="Display")
showBuySellLabels = input.bool(true, "Show Buy/Sell Labels", group="Display")
showEntryText = input.bool(true, "Show Entry Text", group="Display")

// ============================================================
// Core Calculations
// ============================================================
// Calculate typical price: (Low + High + Close) / 3
typicalPrice = (low + high + close) / 3

// Calculate smoothed price: period1-day simple moving average of typical price
smoothedPrice = ta.sma(typicalPrice, period1)

// Calculate highest price lines
highestPrice1 = ta.highest(smoothedPrice, period1)
highestPrice2 = ta.highest(smoothedPrice, period2)

// Calculate support line: 0.98 times period2-period highest of high
supportLine = ta.highest(high, period2) * 0.98

// Calculate lowest price
lowestPrice1 = ta.lowest(smoothedPrice, period1)

// Calculate support level: 1.02 times period1-period lowest of low
supportLevel = ta.lowest(low, period1) * 1.02

// ============================================================
// Price Range Analysis
// ============================================================
// Calculate price range: (High - Low) / 3
priceRange = (high - low) / 3

// Calculate open position conditions
openAboveRange = open > priceRange * 2 + low
openBelowRange = open < priceRange + low

// Calculate close position conditions
closeAboveRange = close > priceRange * 2 + low
closeBelowRange = close < priceRange + low
closeMiddleRange = not(closeAboveRange or closeBelowRange)

// ============================================================
// Trend Strength Analysis
// ============================================================
// Calculate trend strength
strongUp = closeAboveRange or (openBelowRange and closeMiddleRange)
weakUp = openBelowRange and closeMiddleRange
strongDown = not(strongUp or weakUp)

// ============================================================
// Trend Direction Analysis
// ============================================================
// Calculate mid price: (High + Low) / 2
midPrice = (high + low) / 2

// Calculate trend direction
trendUp = midPrice > high[1]
trendDown = midPrice < low[1]
trendNeutral = not(trendUp or trendDown)

// ============================================================
// Signal Conditions
// ============================================================
// Calculate signal conditions
signal1 = strongUp and trendUp
signal2 = strongDown and trendDown
signal3 = strongUp and trendDown
signal4 = strongDown and trendUp
signal5 = strongUp and trendNeutral
signal6 = strongDown and trendNeutral
signal7 = weakUp and (trendUp or trendDown or trendNeutral)

// ============================================================
// Buy/Sell Signal Logic
// ============================================================
// Buy condition: smoothed price > lowest price and equals highest price with breakout
buyCondition = smoothedPrice > lowestPrice1 and smoothedPrice == highestPrice1 and smoothedPrice[1] < highestPrice1[1]

// Entry condition: smoothed price equals highest price with breakout
entryCondition = smoothedPrice == highestPrice1 and smoothedPrice[1] < highestPrice1[1]

// Sell condition: smoothed price < highest price and equals lowest price with breakdown (duality principle)
sellCondition = smoothedPrice < highestPrice1 and smoothedPrice == lowestPrice1 and smoothedPrice[1] > lowestPrice1[1]

// ============================================================
// Visualization - Lines
// ============================================================
// Plot highest price 1 line (magenta)
plot(highestPrice1, "Highest Price 1", color=#ff00ff, linewidth=2)

// Plot highest price 2 line (green)
plot(highestPrice2, "Highest Price 2", color=color.green, linewidth=2)

// Plot support line (blue)
plot(supportLine, "Support Line", color=color.blue, linewidth=2)

// ============================================================
// Visualization - Colored Candlesticks
// ============================================================
// Signal 1: Strong Up + Trend Up (Bright Green candle)
plotcandle(signal1 ? open : na, signal1 ? high : na, signal1 ? low : na, signal1 ? close : na,
           "Signal 1", color=color.new(#00ff00, 0), bordercolor=color.new(#00ff00, 0), wickcolor=color.new(#00ff00, 0))

// Signal 2: Strong Down + Trend Down (Bright Red candle)
plotcandle(signal2 ? open : na, signal2 ? high : na, signal2 ? low : na, signal2 ? close : na,
           "Signal 2", color=color.new(#ff0000, 0), bordercolor=color.new(#ff0000, 0), wickcolor=color.new(#ff0000, 0))

// Signal 3: Strong Up + Trend Down (Yellow candle - reversal warning)
plotcandle(signal3 ? open : na, signal3 ? high : na, signal3 ? low : na, signal3 ? close : na,
           "Signal 3", color=color.new(#ffff00, 0), bordercolor=color.new(#ffff00, 0), wickcolor=color.new(#ffff00, 0))

// Signal 4: Strong Down + Trend Up (Orange candle - reversal warning)
plotcandle(signal4 ? open : na, signal4 ? high : na, signal4 ? low : na, signal4 ? close : na,
           "Signal 4", color=color.new(#ff8800, 0), bordercolor=color.new(#ff8800, 0), wickcolor=color.new(#ff8800, 0))

// Signal 5: Strong Up + Trend Neutral (Light Green candle)
plotcandle(signal5 ? open : na, signal5 ? high : na, signal5 ? low : na, signal5 ? close : na,
           "Signal 5", color=color.new(#88ff88, 0), bordercolor=color.new(#88ff88, 0), wickcolor=color.new(#88ff88, 0))

// Signal 6: Strong Down + Trend Neutral (Light Red candle)
plotcandle(signal6 ? open : na, signal6 ? high : na, signal6 ? low : na, signal6 ? close : na,
           "Signal 6", color=color.new(#ff8888, 0), bordercolor=color.new(#ff8888, 0), wickcolor=color.new(#ff8888, 0))

// Signal 7: Weak Up + Any Trend (Gray candle)
plotcandle(signal7 ? open : na, signal7 ? high : na, signal7 ? low : na, signal7 ? close : na,
           "Signal 7", color=color.new(#808080, 0), bordercolor=color.new(#808080, 0), wickcolor=color.new(#808080, 0))

// ============================================================
// Buy/Sell Labels
// ============================================================
if showBuySellLabels
    // Buy label (BUY) - Green
    if buyCondition
        label.new(bar_index, low, "BUY", color=color.new(color.green, 0), textcolor=color.white, 
                  style=label.style_label_up, size=size.large)
    
    // Sell label (SELL) - Red
    if sellCondition
        label.new(bar_index, high, "SELL", color=color.new(color.red, 0), textcolor=color.white, 
                  style=label.style_label_down, size=size.large)

// ============================================================
// Status Table
// ============================================================
var table statusTable = table.new(position.top_right, 2, 8, bgcolor=color.new(color.black, 80), 
                                   border_width=1, border_color=color.gray)

if showStatusTable and barstate.islast
    // Table header
    table.cell(statusTable, 0, 0, "Status", text_color=color.white, text_size=size.small, bgcolor=color.new(color.blue, 0))
    table.cell(statusTable, 1, 0, "Value", text_color=color.white, text_size=size.small, bgcolor=color.new(color.blue, 0))
    
    // Trend Direction
    trendDirectionText = trendUp ? "UP" : trendDown ? "DOWN" : "NEUTRAL"
    trendDirectionColor = trendUp ? color.green : trendDown ? color.red : color.yellow
    table.cell(statusTable, 0, 1, "Trend Direction", text_color=color.white, text_size=size.small)
    table.cell(statusTable, 1, 1, trendDirectionText, text_color=trendDirectionColor, text_size=size.small)
    
    // Trend Strength
    trendStrengthText = strongUp ? "STRONG UP" : strongDown ? "STRONG DOWN" : weakUp ? "WEAK UP" : "NEUTRAL"
    trendStrengthColor = strongUp ? color.green : strongDown ? color.red : weakUp ? color.yellow : color.gray
    table.cell(statusTable, 0, 2, "Trend Strength", text_color=color.white, text_size=size.small)
    table.cell(statusTable, 1, 2, trendStrengthText, text_color=trendStrengthColor, text_size=size.small)
    
    // Signal Status
    activeSignalText = signal1 ? "Signal 1" : signal2 ? "Signal 2" : signal3 ? "Signal 3" : 
                       signal4 ? "Signal 4" : signal5 ? "Signal 5" : signal6 ? "Signal 6" : 
                       signal7 ? "Signal 7" : "None"
    activeSignalColor = signal1 ? color.new(#00ff00, 0) : signal2 ? color.new(#ff0000, 0) : 
     signal3 ? color.new(#ffff00, 0) : signal4 ? color.new(#ff8800, 0) : 
     signal5 ? color.new(#88ff88, 0) : signal6 ? color.new(#ff8888, 0) : 
     signal7 ? color.new(#808080, 0) : color.gray
    table.cell(statusTable, 0, 3, "Active Signal", text_color=color.white, text_size=size.small)
    table.cell(statusTable, 1, 3, activeSignalText, text_color=activeSignalColor, text_size=size.small)
    
    // Price Position
    pricePositionText = smoothedPrice > highestPrice1 ? "Above Highest" : 
     smoothedPrice < lowestPrice1 ? "Below Lowest" : "In Range"
    pricePositionColor = smoothedPrice > highestPrice1 ? color.green : 
     smoothedPrice < lowestPrice1 ? color.red : color.yellow
    table.cell(statusTable, 0, 4, "Price Position", text_color=color.white, text_size=size.small)
    table.cell(statusTable, 1, 4, pricePositionText, text_color=pricePositionColor, text_size=size.small)
    
    // Price vs Support
    supportPositionText = smoothedPrice > supportLine ? "Above Support" : "Below Support"
    supportPositionColor = smoothedPrice > supportLine ? color.green : color.red
    table.cell(statusTable, 0, 5, "Price vs Support", text_color=color.white, text_size=size.small)
    table.cell(statusTable, 1, 5, supportPositionText, text_color=supportPositionColor, text_size=size.small)
    
    // Breakout Status
    breakoutText = buyCondition ? "BUY BREAKOUT" : sellCondition ? "SELL BREAKDOWN" : "NO BREAKOUT"
    breakoutColor = buyCondition ? color.green : sellCondition ? color.red : color.gray
    table.cell(statusTable, 0, 6, "Breakout Status", text_color=color.white, text_size=size.small)
    table.cell(statusTable, 1, 6, breakoutText, text_color=breakoutColor, text_size=size.small)
    
    // Action
    buySellStatusText = buyCondition ? "BUY" : sellCondition ? "SELL" : "HOLD"
    buySellStatusColor = buyCondition ? color.green : sellCondition ? color.red : color.gray
    table.cell(statusTable, 0, 7, "Action", text_color=color.white, text_size=size.small)
    table.cell(statusTable, 1, 7, buySellStatusText, text_color=buySellStatusColor, text_size=size.small)

// ============================================================
// Background Color Based on Trend and Signals
// ============================================================
// Calculate background color: buy/sell signals take priority over trend
// Buy signal highlight (green, 85 transparency)
// Sell signal highlight (red, 85 transparency)
// Trend background (green/red/na, 90 transparency)
bgColor = buyCondition ? color.new(color.green, 85) : 
          sellCondition ? color.new(color.red, 85) : 
          trendUp ? color.new(color.green, 90) : 
          trendDown ? color.new(color.red, 90) : na
bgcolor(bgColor, title="Background")

// ============================================================
// Alerts
// ============================================================
alertcondition(buyCondition, title="Buy Signal", message="Uptrend Entry: Buy Signal Detected")
alertcondition(sellCondition, title="Sell Signal", message="Uptrend Entry: Sell Signal Detected")
alertcondition(entryCondition, title="Entry Signal", message="Uptrend Entry: Strong Uptrend, Entry Possible")
