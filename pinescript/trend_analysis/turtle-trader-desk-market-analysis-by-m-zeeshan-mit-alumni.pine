//@version=6
indicator("Turtle Trader Desk, market analysis by M. Zeeshan MIT Alumni", overlay = true, max_lines_count = 500, max_labels_count = 500, max_boxes_count = 500)



//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TREND LINE MODULE (your full trend script)
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Preconfigured constants
_fast = 34
_slow = 89
_swingLen = 20
_confirmBars = 0
_atrLen = 14
_volLen = 20
_rangeFactor = 0.45
_htf = "240"
_breakoutPct = 0.001
_requireHTF = false
_allowPossibleStart = true
_fadeBars = 600

// Core
fastEma = ta.ema(close, _fast)
slowEma = ta.ema(close, _slow)
atr = ta.atr(_atrLen)
atrMa = ta.sma(atr, _atrLen)
volMa = ta.sma(volume, _volLen)
slopeAbs = math.abs(fastEma - fastEma[1])

emaBull = fastEma > slowEma
emaBear = fastEma < slowEma
slopeBull = fastEma > fastEma[1]
slopeBear = fastEma < fastEma[1]
flatSlope = slopeAbs < atr * 0.1

recentHigh = ta.highest(high, _swingLen)
recentLow = ta.lowest(low, _swingLen)
structBull = close > recentLow
structBear = close < recentHigh
noStruct = not structBull and not structBear

htfFast = request.security(syminfo.tickerid, _htf, ta.ema(close, _fast))
htfSlow = request.security(syminfo.tickerid, _htf, ta.ema(close, _slow))
htfBull = htfFast > htfSlow
htfBear = htfFast < htfSlow

volExp = volume > volMa
atrExp = atr > atrMa
atrCompression = atr < atrMa * _rangeFactor
isRanging = atrCompression and flatSlope and noStruct

breakoutUp = close > recentHigh * (1 + _breakoutPct)
breakoutDown = close < recentLow * (1 - _breakoutPct)

rawBullPossible = (emaBull and slopeBull and structBull and not isRanging) or breakoutUp
rawBearPossible = (emaBear and slopeBear and structBear and not isRanging) or breakoutDown

relaxedVolAtr = volExp or atrExp
relaxedHTF = _requireHTF ? (htfBull or htfBear) : true
relaxedConfirm = relaxedVolAtr and relaxedHTF

breakoutImmediateConfirmBull = breakoutUp and (_requireHTF ? htfBull : true)
breakoutImmediateConfirmBear = breakoutDown and (_requireHTF ? htfBear : true)

barsSinceRawBullPossible = ta.barssince(rawBullPossible)
barsSinceRawBearPossible = ta.barssince(rawBearPossible)

bullConfirmed = (rawBullPossible and relaxedConfirm and barsSinceRawBullPossible <= _confirmBars) or breakoutImmediateConfirmBull
bearConfirmed = (rawBearPossible and relaxedConfirm and barsSinceRawBearPossible <= _confirmBars) or breakoutImmediateConfirmBear

bullStart = bullConfirmed or (_allowPossibleStart and rawBullPossible)
bearStart = bearConfirmed or (_allowPossibleStart and rawBearPossible)

bullEnded = (bullConfirmed or (_allowPossibleStart and rawBullPossible)) and (emaBear or slopeBear or close < recentLow or isRanging)
bearEnded = (bearConfirmed or (_allowPossibleStart and rawBearPossible)) and (emaBull or slopeBull or close > recentHigh or isRanging)

// Trend strength
baseStrength = 0.0
baseStrength += bullConfirmed or bearConfirmed ? 30.0 : 0.0
baseStrength += volExp and atrExp ? 25.0 : 0.0
baseStrength += (_requireHTF ? 20.0 : 10.0) * (htfBull or htfBear ? 1.0 : 0.0)
baseStrength += slopeAbs > atr * 0.2 ? 15.0 : 0.0
baseStrength += not isRanging ? 10.0 : 0.0
trendStrength = math.round(math.min(100.0, math.max(0.0, baseStrength)))

// Transparency mapping
transpLevel = trendStrength > 75 ? 0 : trendStrength > 50 ? 20 : trendStrength > 25 ? 40 : trendStrength > 10 ? 60 : 80

// Color decision
isBull = (bullStart and not bearStart) or (bullStart and bearStart and trendStrength >= 50)
isBear = (bearStart and not bullStart) or (bullStart and bearStart and trendStrength < 50)
grayColor = color.new(color.gray, 80)
lineColor = isBull ? color.new(color.green, transpLevel) : isBear ? color.new(color.red, transpLevel) : grayColor

// Trendâ€‘line width layers
show_w1 = trendStrength <= 10 ? fastEma : na
show_w2 = trendStrength > 10 and trendStrength <= 25 ? fastEma : na
show_w3 = trendStrength > 25 and trendStrength <= 50 ? fastEma : na
show_w4 = trendStrength > 50 and trendStrength <= 75 ? fastEma : na
show_w5 = trendStrength > 75 ? fastEma : na


//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TREND FILTER FOR SWEEPS
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
allowBullSweep = isBull or lineColor == grayColor
allowBearSweep = isBear or lineColor == grayColor


//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TREND COLOR
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
trendColor = allowBullSweep ? color.green : allowBearSweep ? color.red : color.gray

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CORE TREND METRICS
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
sig_trendText = trendColor == color.green ? "Uptrend ğŸ“ˆ" : trendColor == color.red ? "Downtrend ğŸ“‰" : "â¡ï¸ Neutral"
sig_slope = ta.sma(close, 1) - ta.sma(close, 5)
sig_trendStrength = math.min(math.max((math.abs(sig_slope) / ta.atr(14)) * 100, 0), 100)
sig_strengthColor = sig_trendStrength > 60 ? "ğŸŸ¢ Strong" : sig_trendStrength > 20 ? "ğŸŸ¡ Moderate" : "ğŸ”´ Weak"

// Trend state
sig_trendState = sig_trendStrength > 80 and sig_slope < sig_slope[1] ? "Cooling slightly" : sig_trendStrength > 60 and sig_slope < sig_slope[1] ? "Losing momentum" : sig_slope > sig_slope[1] ? "Strengthening" : sig_slope < sig_slope[1] ? "Weakening" : "Stable"

// Warnings
sig_flipWarning = (trendColor == color.green and sig_slope < 0) ? "âš ï¸ Possible Trend Flip Down" : (trendColor == color.red and sig_slope > 0) ? "âš ï¸ Possible Trend Flip Up" : ""
sig_danger = sig_trendStrength < 20 ? "ğŸš¨ Danger Zone â€” Trend Very Weak" : ""
sig_exhaustion = (trendColor == color.green and high < high[1] and sig_slope < sig_slope[1] and sig_trendStrength < sig_trendStrength[1]) ? "ğŸ’€ Uptrend Exhaustion Detected" : (trendColor == color.red and low > low[1] and sig_slope < sig_slope[1] and sig_trendStrength < sig_trendStrength[1]) ? "ğŸ’€ Downtrend Exhaustion Detected" : ""

// Basic advice
sig_tradeAdvice = trendColor == color.green ? "ğŸ§­ Only BUY in uptrend." : trendColor == color.red ? "ğŸ§­ Only SELL in downtrend." : "ğŸ§­ Neutral â€” trade small."
sig_lotAdvice = "ğŸ“‰ Take smaller lots â€” I'll help you grow."
sig_slAdvice = "ğŸ›¡ï¸ Never trade without a stop-loss."
sig_breakAdvice = "â˜• If in loss, take a break. Don't trade against trend."

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INTELLIGENCE MODULES
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// 1. Market Structure
marketStructure = high > high[1] and low > low[1] ? "Market making higher highs â€” buyers in control" : high < high[1] and low < low[1] ? "Market making lower lows â€” sellers in control" : "Market moving sideways â€” no clear direction"

// 2. Volatility Regime
atrNow = ta.atr(14)
atrPrev = ta.atr(14)[1]
volatilityRegime = atrNow > atrPrev * 1.1 ? "Market waking up â€” good time to prepare for entries" : atrNow < atrPrev * 0.9 ? "Market slowing down â€” wait for a clean setup" : "Normal movement â€” trade with patience"

// Liquidity
nearHigh = high >= ta.highest(high, 20) * 0.995
nearLow = low <= ta.lowest(low, 20) * 1.005
liquidityText = nearHigh and trendColor == color.red ? "Price grabbed liquidity above â€” sellers may push down" : nearLow and trendColor == color.green ? "Price grabbed liquidity below â€” buyers may push up" : "Market has no fuel â€” expect slow, choppy movement"

// 5. Trend Alignment (HTF vs LTF)
htfFast2 = request.security(syminfo.tickerid, "60", ta.sma(close, 20))
htfSlow2 = request.security(syminfo.tickerid, "60", ta.sma(close, 50))
htfTrend = htfFast2 > htfSlow2 ? "Bullish" : htfFast2 < htfSlow2 ? "Bearish" : "Neutral"
ltfTrend = trendColor == color.green ? "Bullish" : trendColor == color.red ? "Bearish" : "Neutral"
trendAlignment = (htfTrend == "Bullish" and ltfTrend == "Bullish") ? "Bigger trend agrees with BUYING â€” safer long setups" : (htfTrend == "Bearish" and ltfTrend == "Bearish") ? "Bigger trend agrees with SELLING â€” safer short setups" : "Timeframes disagree â€” reduce size or wait"

// 6. Session Context
sessHour = hour(time)
sessionText = sessHour >= 7 and sessHour < 10 ? "London just opened â€” strong moves possible" : sessHour >= 13 and sessHour < 17 ? "New York active â€” high volatility expected" : sessHour >= 0 and sessHour < 6 ? "Asian session â€” slow and choppy" : "Lowâ€‘energy session â€” expect smaller moves"

// 8. Risk Environment
riskRatio = atrNow / close
riskEnvironment = riskRatio > 0.02 ? "Market moving fast â€” use smaller lot size" : riskRatio > 0.01 ? "Normal conditions â€” trade normally" : "Calm market â€” good for small, clean entries"

// 10. Stop-Loss Guide
slGuide = trendColor == color.green ? "Place SL below recent low â€” protects long trades" : trendColor == color.red ? "Place SL above recent high â€” protects short trades" : "Use tight SL â€” market unclear"

// 12. Confidence Meter
confidenceBase = sig_trendStrength
confidenceStruct = str.contains(marketStructure, "HH") or str.contains(marketStructure, "LL") ? 10.0 : 0.0
confidenceAlign = str.contains(trendAlignment, "Aligned") ? 10.0 : 0.0
confidenceVol = str.contains(volatilityRegime, "Enter") ? 5.0 : str.contains(volatilityRegime, "Wait") ? -5.0 : 0.0
tradeConfidenceRaw = math.min(math.max(confidenceBase + confidenceStruct + confidenceAlign + confidenceVol, 0), 100)
confBars = math.round(tradeConfidenceRaw / 10)
confBar = ""
for i = 0 to 10
    confBar += i <= confBars ? "â–ˆ" : "â–‘"
tradeConfidenceText = "Trade confidence: " + str.tostring(tradeConfidenceRaw, "#") + "% â€” higher = safer entry"

// 14. Candle Strength (renamed)
candleBody2 = math.abs(close - open)
candleRange2 = high - low
candleBodyRatio2 = candleRange2 > 0 ? candleBody2 / candleRange2 : 0.0
candleStrength2 = candleBodyRatio2 > 0.7 and close > open ? "Strong buying candle â€” buyers showing power" : candleBodyRatio2 > 0.7 and close < open ? "Strong selling candle â€” sellers showing power" : candleBodyRatio2 > 0.4 ? "Medium strength candle â€” moderate pressure" : "Weak candle â€” market undecided"

// 15. Trend Exhaustion Probability
exhaustionScore = (sig_exhaustion != "" ? 70.0 : 0.0) + (sig_trendStrength < 20 ? 20.0 : 0.0) + (sig_trendStrength > 80 and sig_slope < sig_slope[1] ? 10.0 : 0.0)
exhaustionProb = math.min(math.max(exhaustionScore, 0), 100)
exhaustionText = exhaustionProb > 70 ? "Trend losing power â€” prepare for reversal" : exhaustionProb < 30 ? "Trend healthy â€” continuation likely" : "Trend slowing â€” watch for pullbacks"


buyReadiness =
     trendColor == color.green and str.contains(marketStructure, "buyers") and str.contains(trendAlignment, "BUYING") and str.contains(volatilityRegime, "waking") ? "Good moment to prepare a BUY" :
     trendColor == color.green and str.contains(exhaustionText, "reversal") ? "Avoid BUY â€” trend losing power" :
     trendColor == color.green and str.contains(liquidityText, "no fuel") ? "Avoid BUY â€” market slow and choppy" :
     trendColor == color.green ? "BUY possible â€” wait for a clean candle" :
     "BUY not recommended right now"

sellReadiness =
     trendColor == color.red and str.contains(marketStructure, "sellers") and str.contains(trendAlignment, "SELLING") and str.contains(volatilityRegime, "waking") ? "SELL setup forming soon" :
     trendColor == color.red and str.contains(exhaustionText, "reversal") ? "Avoid SELL â€” trend losing power" :
     trendColor == color.red and str.contains(liquidityText, "no fuel") ? "Avoid SELL â€” market slow and choppy" :
     trendColor == color.red ? "SELL possible â€” wait for a clean candle" :
     "SELL not recommended right now"

neutralReadiness =
     trendColor == color.gray ? "Not a good time to trade â€” market unclear" :
     "Market direction clear â€” see BUY/SELL readiness"

// Emotion-aware tone shifting
tone =
     sig_trendStrength > 70 and not str.contains(exhaustionText, "reversal") ? "optimistic" :
     sig_trendStrength < 30 or str.contains(exhaustionText, "reversal") ? "cautious" :
     riskRatio > 0.02 ? "alert" :
     "neutral"

// AI confidence score (0â€“100)
aiConfidence = math.min(math.max((tradeConfidenceRaw + sig_trendStrength) / 2, 0), 100)
aiConfidenceText = "My confidence in this analysis: " + str.tostring(aiConfidence, "#") + "%."

finalDecision =
     trendColor == color.green and str.contains(buyReadiness, "Good moment") and tone == "optimistic" ?
          "I would be preparing for a BUY here, but only after a clean confirmation candle. Strong trends reward patience, not haste." :
     trendColor == color.red and str.contains(sellReadiness, "forming") and tone == "optimistic" ?
          "A SELL opportunity is forming, though I would wait for one more decisive candle before committing. Let the market show conviction." :
     tone == "cautious" ?
          "I would hold back for now. The market is losing strength, and entering during uncertainty is how traders lose good capital." :
     tone == "alert" ?
          "Volatility is high. If I were you, Iâ€™d wait for the storm to settle before taking any position." :
     "Conditions are mixed. If I were in your place, I would wait for a clearer setup rather than forcing a trade."


// Conversational, idiomatic paragraph variations (no colons, line breaks for narrow labels)
variation1 =
     "The market looks like " + sig_trendText + " and momentum feels strong at " + str.tostring(sig_trendStrength, "#") + "%.\n" +
     "Price action is showing " + marketStructure + " and volatility is behaving as " + volatilityRegime + ".\n" +
     "We swept liquidity and reclaimed it, which reads as " + liquidityText + ", and the higher timeframe is aligned with " + trendAlignment + ".\n" +
     "With the session in play expect " + sessionText + ".\n" +
     "Risk is " + riskEnvironment + " so keep your stops sensible, for example " + slGuide + ".\n" +
     "The most recent candle looks like " + candleStrength2 + " and the trend condition reads " + exhaustionText + ".\n" +
     "Overall conviction sits around " + str.tostring(tradeConfidenceRaw, "#") + "% and " + aiConfidenceText + "\n" +
     "If it were my money, Iâ€™d say this in plain terms " + finalDecision

variation2 =
     "Quick take, the market is " + sig_trendText + " with strength near " + str.tostring(sig_trendStrength, "#") + "%.\n" +
     "Structurally we see " + marketStructure + " and volatility is " + volatilityRegime + ".\n" +
     "Liquidity has behaved like " + liquidityText + " and the bigger picture shows " + trendAlignment + ".\n" +
     "Expect the session to act like " + sessionText + ".\n" +
     "Risk reads " + riskEnvironment + " so size down if youâ€™re unsure, and consider " + slGuide + " for protection.\n" +
     "Candle action is " + candleStrength2 + " and trend health is " + exhaustionText + ".\n" +
     "Confidence is about " + str.tostring(tradeConfidenceRaw, "#") + "% and " + aiConfidenceText + "\n" +
     "My practical view, from years in the markets, is " + finalDecision

variation3 =
     "Right now the tape is showing " + sig_trendText + " and the strength gauge reads " + str.tostring(sig_trendStrength, "#") + "%.\n" +
     "What Iâ€™m seeing in structure is " + marketStructure + " and volatility is " + volatilityRegime + ".\n" +
     "We noticed liquidity behaving as " + liquidityText + " and the higher timeframe is signaling " + trendAlignment + ".\n" +
     "During this session expect " + sessionText + ".\n" +
     "Risk looks " + riskEnvironment + " so keep your risk per trade modest and use " + slGuide + " as a guide.\n" +
     "The latest candle reads " + candleStrength2 + " and the trend reads " + exhaustionText + ".\n" +
     "Confidence sits at " + str.tostring(tradeConfidenceRaw, "#") + "% and " + aiConfidenceText + "\n" +
     "If I had to choose, hereâ€™s what Iâ€™d do with calm capital " + finalDecision

variation4 =
     "Hereâ€™s the short story, the market is " + sig_trendText + " with a strength of " + str.tostring(sig_trendStrength, "#") + "%.\n" +
     "Price structure appears as " + marketStructure + " and volatility is " + volatilityRegime + ".\n" +
     "Liquidity action reads " + liquidityText + " and the multi timeframe view is " + trendAlignment + ".\n" +
     "Expect session behavior like " + sessionText + ".\n" +
     "Risk is " + riskEnvironment + " so keep powder dry if youâ€™re unsure, and place stops according to " + slGuide + ".\n" +
     "Candle strength is " + candleStrength2 + " and trend health is " + exhaustionText + ".\n" +
     "Confidence is around " + str.tostring(tradeConfidenceRaw, "#") + "% and " + aiConfidenceText + "\n" +
     "From a seasoned perspective, my recommendation is " + finalDecision

variation5 =
     "Well, the market reads " + sig_trendText + " and the strength meter shows " + str.tostring(sig_trendStrength, "#") + "%.\n" +
     "The structure suggests " + marketStructure + " while volatility is " + volatilityRegime + ".\n" +
     "Liquidity looks like " + liquidityText + " and the higher timeframe leans " + trendAlignment + ".\n" +
     "With the session underway expect " + sessionText + ".\n" +
     "Risk is " + riskEnvironment + " so size carefully and follow " + slGuide + " for stops.\n" +
     "Recent candle action is " + candleStrength2 + " and trend health reads " + exhaustionText + ".\n" +
     "Confidence sits at " + str.tostring(tradeConfidenceRaw, "#") + "% and " + aiConfidenceText + "\n" +
     "In plain language, and speaking from long experience, Iâ€™d advise " + finalDecision

// rotate variations and assign to marketReport
reportVersion = bar_index % 5
marketReport =
     reportVersion == 0 ? variation1 :
     reportVersion == 1 ? variation2 :
     reportVersion == 2 ? variation3 :
     reportVersion == 3 ? variation4 :
                          variation5

// Decision-based action line derived from the analysis (humanâ€‘like, actionable)
aiConfidence := math.min(math.max((tradeConfidenceRaw + sig_trendStrength) / 2, 0), 100)

// Tone detection (reuse if already defined)
toneLocal =
     sig_trendStrength > 70 and not str.contains(exhaustionText, "reversal") ? "optimistic" :
     sig_trendStrength < 30 or str.contains(exhaustionText, "reversal") ? "cautious" :
     riskRatio > 0.02 ? "alert" :
     "neutral"

// Decision-based action line with forced line breaks for narrow labels
// (each string broken into short lines to avoid wide labels)
actionLine =
     // Strong buy case: trend up, clear buy readiness, good AI confidence, trend not exhausted
     (trendColor == color.green and str.contains(buyReadiness, "Good moment") and aiConfidence > 60 and not str.contains(exhaustionText, "losing")) ?
          "Letâ€™s buy now.\nWait for a clean confirmation candle.\nEnter with measured size\nand place your stop as advised." :

     // Conservative buy case: uptrend but prefer a better entry
     (trendColor == color.green and (str.contains(buyReadiness, "wait") or str.contains(buyReadiness, "possible") or aiConfidence <= 60)) ?
          "Can we wait a bit\nfor a better entry?\nIâ€™d like to see a small pullback\nor a clear confirmation candle\nbefore committing." :

     // Strong sell case: trend down, clear sell readiness, good AI confidence, trend not exhausted
     (trendColor == color.red and str.contains(sellReadiness, "forming") and aiConfidence > 60 and not str.contains(exhaustionText, "losing")) ?
          "Letâ€™s sell now.\nWait for a decisive candle\nto confirm the move.\nSize the trade sensibly\nand keep your stop tight." :

     // Conservative sell case: downtrend but prefer a better entry
     (trendColor == color.red and (str.contains(sellReadiness, "wait") or str.contains(sellReadiness, "possible") or aiConfidence <= 60)) ?
          "Can we wait a bit\nfor a clearer sell setup?\nIâ€™d rather see one more\nconfirming candle or a clean retest." :

     // Neutral / cautious cases: low confidence, mixed signals, or explicit neutral readiness
     (str.contains(neutralReadiness, "Not a good time") or toneLocal == "cautious" or aiConfidence < 45) ?
          "Iâ€™d hold off for now.\nConditions are mixed.\nPatience will likely preserve capital\nbetter than forcing a trade." :

     // Alert / high volatility: suggest waiting or reduced size
     (toneLocal == "alert" or riskRatio > 0.03) ?
          "Volatility is elevated.\nIf you trade, reduce size\nand use disciplined stops.\nOtherwise wait for the noise to settle." :

     // Fallback: balanced, noncommittal guidance
          "Conditions are mixed.\nIf you prefer action,\nwait for a clean confirmation.\nOtherwise thereâ€™s no harm\nin sitting this one out."


// Greeting based on local bar time and append to panel with the decision action
greeting =
     hour(time) >= 5 and hour(time) < 12 ? "Good morning.. Hope you had a coffee!" :
     hour(time) >= 12 and hour(time) < 17 ? "Good afternoon.. Had lunch yet?" :
     hour(time) >= 17 and hour(time) < 22 ? "Good evening.. Let's dive into the market!" :
     "Ah! Up late at night hmm.."

// Compose a friendly lead into the action line so it reads naturally after the AI report
greetingLine = greeting + ", " + (str.length(actionLine) > 0 ? actionLine : "no clear action right now; stay patient.")

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MATRIX PANEL (50â€‘CHAR BOX)
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
sig_matrixBg = color.new(color.black, 0)
sig_prefix = ".."
sig_arrow = trendColor == color.green ? "â–²" : trendColor == color.red ? "â–¼" : "â€¢"
bootStep = bar_index % 4
bootText = bootStep == 0 ? "[BOOT] Initializingâ€¦" : bootStep == 1 ? "[BOOT] Loading modulesâ€¦" : bootStep == 2 ? "[BOOT] Establishing uplinkâ€¦" : "[BOOT] Market Intelligence"
scanColor = bar_index % 2 == 0 ? color.lime : color.new(color.lime, 20)
barCount = math.round(sig_trendStrength / 10)
pulseBar = ""
for i = 0 to 10
    pulseBar += i <= barCount ? "â–ˆ" : "â–‘"

// PANEL TEXT
panelText =
     "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" +
     "\nâ•‘ 01 10 01 " + bootText + " 01 10 01 â•‘" +
     "\nâ• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" +
     "\n" + greetingLine + sig_prefix+"\n\n"+
     "\n" + sig_prefix + sig_arrow + " Trend: " + sig_trendText +
     "\n" + sig_prefix + "Trend Strength: " + str.tostring(sig_trendStrength, "#") + "% (" + sig_strengthColor + ")" +
     "\n" + sig_prefix + "Candle Pressure: " + pulseBar +
     "\n" + sig_prefix + "Trend Behavior: " + sig_trendState +
     (sig_flipWarning != "" ? "\n" + sig_prefix + "Warning: " + sig_flipWarning : "") +
     (sig_danger != "" ? "\n" + sig_prefix + "Caution: " + sig_danger : "") +
     (sig_exhaustion != "" ? "\n" + sig_prefix + "Exhaustion: " + sig_exhaustion : "") +

     "\n" + sig_prefix + "Market Structure: " + marketStructure +
     "\n" + sig_prefix + "Volatility: " + volatilityRegime +
     "\n" + sig_prefix + "Retail Activity: " + liquidityText +
     "\n" + sig_prefix + "Bigger Trend: " + trendAlignment +
     "\n" + sig_prefix + "Session Mood: " + sessionText +
     "\n" + sig_prefix + "Risk Level: " + riskEnvironment +
     "\n" + sig_prefix + "Stopâ€‘Loss Guide: " + slGuide +

     "\n" + sig_prefix + tradeConfidenceText +
     "\n" + sig_prefix + "Candle Strength: " + candleStrength2 +
     "\n" + sig_prefix + "Trend Health: " + exhaustionText +

     "\n" + sig_prefix + "Advice: " + sig_tradeAdvice +
     "\n" + sig_prefix + sig_lotAdvice +
     "\n" + sig_prefix + sig_slAdvice +
     "\n" + sig_prefix + sig_breakAdvice +

     "\n" + sig_prefix + "BUY Readiness: " + buyReadiness +
     "\n" + sig_prefix + "SELL Readiness: " + sellReadiness +
     "\n" + sig_prefix + "Neutral: " + neutralReadiness +
     "\n" + sig_prefix + "\n\n Analysis Report:\n" + marketReport +
     "\nâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"


// POSITION
barSpacing = time - time[1]
xpos = time + barSpacing * 3
ypos = high + ta.atr(14) * 0.5

// LABEL
var label sig_trendLabel = na
if barstate.islast
    if na(sig_trendLabel)
        sig_trendLabel := label.new(xpos, ypos, panelText, xloc = xloc.bar_time, yloc = yloc.price, style = label.style_label_left, color = sig_matrixBg, textcolor = scanColor, size = size.small, textalign = text.align_left)
    else
        label.set_x(sig_trendLabel, xpos), label.set_y(sig_trendLabel, ypos), label.set_text(sig_trendLabel, panelText), label.set_color(sig_trendLabel, sig_matrixBg), label.set_textcolor(sig_trendLabel, scanColor), label.set_size(sig_trendLabel, size.small)



//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LUXALGO LIQUIDITY SWINGS MODULE
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Settings
length = input(14, 'Pivot Lookback', display=display.none)
area = input.string('Wick Extremity', 'Swing Area', options=['Wick Extremity','Full Range'], display=display.none)
intraPrecision = input(false, 'Intrabar Precision', inline='intrabar', display=display.none)
intrabarTf = input.timeframe('1', '', inline='intrabar', display=display.none)
filterOptions = input.string('Count', 'Filter Areas By', options=['Count','Volume'], inline='filter', display=display.none)
filterValue = input.float(0, '', inline='filter', display=display.none)

// Style
showTop = input(true, 'Swing High', inline='top', group='Style', display=display.none)
topCss = input(color.red, '', inline='top', group='Style', display=display.none)
topAreaCss = input(color.new(color.red, 50), 'Area', inline='top', group='Style', display=display.none)

showBtm = input(true, 'Swing Low', inline='btm', group='Style', display=display.none)
btmCss = input(color.teal, '', inline='btm', group='Style', display=display.none)
btmAreaCss = input(color.new(color.teal, 50), 'Area', inline='btm', group='Style', display=display.none)

labelSize = input.string('Tiny', 'Labels Size', options=['Tiny','Small','Normal'], group='Style', display=display.none)

// Internal
n = bar_index
get_data()=> [high, low, volume]
[h, l, v] = request.security_lower_tf(syminfo.tickerid, intrabarTf, get_data())

// Count function
get_counts(bool condition, top, btm)=>
    var count = 0
    var vol = 0.
    if condition
        count := 0
        vol := 0.
    else
        if intraPrecision
            if n > length and array.size(v[length]) > 0
                for [idx, elem] in v[length]
                    vol += array.get(l[length], idx) < top and array.get(h[length], idx) > btm ? elem : 0
        else
            vol += low[length] < top and high[length] > btm ? volume[length] : 0
        count += low[length] < top and high[length] > btm ? 1 : 0
    [count, vol]

// Label function
set_label(count, vol, x, y, css, lbl_style)=>
    var label lbl = na
    var label_size = labelSize == 'Tiny' ? size.tiny : labelSize == 'Small' ? size.small : size.normal
    target = filterOptions == 'Count' ? count : vol
    if ta.crossover(target, filterValue)
        lbl := label.new(x, y, str.tostring(vol, format.volume), style=lbl_style, size=label_size, color=#00000000, textcolor=css)
    if target > filterValue
        label.set_text(lbl, str.tostring(vol, format.volume))

// Level function
set_level(bool condition, crossed, value, count, vol, css)=>
    var line lvl = na
    target = filterOptions == 'Count' ? count : vol
    if condition
        if target[1] < filterValue[1]
            line.delete(lvl[1])
        else if not crossed[1]
            line.set_x2(lvl, n - length)
        lvl := line.new(n - length, value, n, value, color=na)
    if not crossed[1]
        line.set_x2(lvl, n+3)
    if crossed and not crossed[1]
        line.set_x2(lvl, n)
        line.set_style(lvl, line.style_dashed)
    if target > filterValue
        line.set_color(lvl, css)

// Zone function
set_zone(condition, x, top, btm, count, vol, css)=>
    var box bx = na
    target = filterOptions == 'Count' ? count : vol
    if ta.crossover(target, filterValue)
        bx := box.new(x, top, x + count, btm, border_color=na, bgcolor=css)
    if target > filterValue
        box.set_right(bx, x + count)

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// GLOBAL VARIABLES FOR LIQUIDITY BOXES
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Pivot high
var float ph_top = na
var float ph_btm = na
var bool  ph_crossed = false
var int   ph_x1 = 0
var box   ph_bx = box.new(na, na, na, na, bgcolor=color.new(topAreaCss, 80), border_color=na)

// Pivot low
var float pl_top = na
var float pl_btm = na
var bool  pl_crossed = false
var int   pl_x1 = 0
var box   pl_bx = box.new(na, na, na, na, bgcolor=color.new(btmAreaCss, 80), border_color=na)

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DISPLAY SWING HIGH BOXES
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ph = ta.pivothigh(length, length)
[ph_count, ph_vol] = get_counts(not na(ph), ph_top, ph_btm)
if not na(ph) and showTop
    ph_top := high[length]
    ph_btm := area == 'Wick Extremity' ? math.max(close[length], open[length]) : low[length]
    ph_x1 := n - length
    ph_crossed := false
    box.set_lefttop(ph_bx, ph_x1, ph_top)
    box.set_rightbottom(ph_bx, ph_x1, ph_btm)
else
    ph_crossed := close > ph_top ? true : ph_crossed
    box.set_right(ph_bx, ph_crossed ? ph_x1 : n+3)

if showTop
    set_zone(ph, ph_x1, ph_top, ph_btm, ph_count, ph_vol, topAreaCss)
    set_level(not na(ph), ph_crossed, ph_top, ph_count, ph_vol, topCss)
    set_label(ph_count, ph_vol, ph_x1, ph_top, topCss, label.style_label_down)

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DISPLAY SWING LOW BOXES
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
pl = ta.pivotlow(length, length)
[pl_count, pl_vol] = get_counts(not na(pl), pl_top, pl_btm)
if not na(pl) and showBtm
    pl_top := area == 'Wick Extremity' ? math.min(close[length], open[length]) : high[length]
    pl_btm := low[length]
    pl_x1 := n - length
    pl_crossed := false
    box.set_lefttop(pl_bx, pl_x1, pl_top)
    box.set_rightbottom(pl_bx, pl_x1, pl_btm)
else
    pl_crossed := close < pl_btm ? true : pl_crossed
    box.set_right(pl_bx, pl_crossed ? pl_x1 : n+3)

if showBtm
    set_zone(pl, pl_x1, pl_top, pl_btm, pl_count, pl_vol, btmAreaCss)
    set_level(not na(pl), pl_crossed, pl_btm, pl_count, pl_vol, btmCss)
    set_label(pl_count, pl_vol, pl_x1, pl_btm, btmCss, label.style_label_up)


//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LUX-STYLE LIQUIDITY BOX LABEL (Reversal Expected + SL + Strength)
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Format volume
liqVolTop = str.tostring(ph_vol, format.volume)
liqVolBtm = str.tostring(pl_vol, format.volume)

// Rolling averages for strength classification
avgTopVol = ta.sma(ph_vol, 20)
avgBtmVol = ta.sma(pl_vol, 20)

ph_strong = ph_vol > avgTopVol
pl_strong = pl_vol > avgBtmVol

// Stop-loss levels
ph_sl = ph_top   // highest wick inside top box
pl_sl = pl_btm   // lowest wick inside bottom box
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SIGNAL VARIABLES (prefixed to avoid conflicts)
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// BUY/SELL prices
sig_bullBuy  = close
sig_bearSell = close

// Stop-loss levels
sig_bullSL = pl_sl
sig_bearSL = ph_sl

// Strength scoring (0â€“100%)
sig_bullStrength = pl_strong ? 85 : 45
sig_bearStrength = ph_strong ? 85 : 45

// TP levels (pivot-based)
sig_bullTP1 = ta.pivothigh(3,3)
sig_bullTP2 = ta.pivothigh(10,10)
sig_bullTP3 = ta.pivothigh(20,20)

sig_bearTP1 = ta.pivotlow(3,3)
sig_bearTP2 = ta.pivotlow(10,10)
sig_bearTP3 = ta.pivotlow(20,20)


//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// BULLISH LIQUIDITY SWEEP SIGNAL (Swing Low)
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if showBtm and not na(pl)
    label.new(
        pl_x1,
        pl_btm,
        "BUY NOW!" +
        "\nStrength: " + str.tostring(sig_bullStrength) + "%" +
        "\nWe swept the LOW â€” high probability reversal." +
        "\nLiquidity grabbed: " + liqVolBtm +
        "\nBuy Price: " + str.tostring(sig_bullBuy) +
        "\nStop Loss: " + str.tostring(sig_bullSL) +
        "\nTP1: " + str.tostring(sig_bullTP1) +
        "\nTP2: " + str.tostring(sig_bullTP2) +
        "\nTP3: " + str.tostring(sig_bullTP3) +
        (pl_strong ? "\nDon't miss this chance!" : "\nVolume weaker â€” trade with caution."),
        style = label.style_label_up,
        color = color.new(color.green, 0),
        textcolor = color.white,
        yloc = yloc.belowbar
    )


//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// BEARISH LIQUIDITY SWEEP SIGNAL (Swing High)
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if showTop and not na(ph)
    label.new(
        ph_x1,
        ph_top,
        "SELL NOW!" +
        "\nStrength: " + str.tostring(sig_bearStrength) + "%" +
        "\nWe swept the HIGH â€” high probability reversal." +
        "\nLiquidity grabbed: " + liqVolTop +
        "\nSell Price: " + str.tostring(sig_bearSell) +
        "\nStop Loss: " + str.tostring(sig_bearSL) +
        "\nTP1: " + str.tostring(sig_bearTP1) +
        "\nTP2: " + str.tostring(sig_bearTP2) +
        "\nTP3: " + str.tostring(sig_bearTP3) +
        (ph_strong ? "\nDon't miss this chance!" : "\nVolume weaker â€” trade with caution."),
        style = label.style_label_down,
        color = color.new(color.red, 0),
        textcolor = color.white,
        yloc = yloc.abovebar
    )



//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SWEEP LOGIC
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
low0 = low
low1 = low[1]
high0 = high
high1 = high[1]
open0 = open
close0 = close
open1 = open[1]
close1 = close[1]
vol0 = volume
candleRange1 = high1 - low1
vol1 = volume[1]

candleRange = high0 - low0
lowerWick = math.min(open0, close0) - low0
upperWick = high0 - math.max(open0, close0)

bullishSweep = low0 < low1 and upperWick <= candleRange * 0.3 and vol0 > vol1 and close0 > open0 and close1 < open1
bearishSweep = high0 > high1 and lowerWick <= candleRange * 0.3 and vol0 > vol1 and close0 < open0 and close1 > open1


// Inside box
insideLowBox = low0 <= pl_top and low0 >= pl_btm
insideHighBox = high0 >= ph_btm and high0 <= ph_top

insideHighBox1 = high1 <= ph_top and low1 >= ph_btm
insideLowBox1  = low1 >= pl_btm and high1 <= pl_top
allowBearSweep1 = isBear[1] or lineColor[1] == grayColor
allowBullSweep1 = isBull[1] or lineColor[1] == grayColor

lineIsRed1   = isBear[1]
lineIsGreen1 = isBull[1]

isBullCandle1 = close1 > open1
isBearCandle1 = close1 < open1

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LOWâ€‘VOLUME ENGULFING REVERSALS
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
bullishLVEngulf = low0 < low1 and high0 > high1 and vol0 < vol1 and insideLowBox and allowBullSweep and not pl_crossed
bearishLVEngulf = high0 > high1 and low0 < low1 and vol0 < vol1 and insideHighBox and allowBearSweep and not ph_crossed
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CAB MODULE â€” Final Clean Block (Working Lines)
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ BARâ€‘0 VALUES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
candleRange0    = high - low
isBullCandle0   = close > open
isBearCandle0   = close < open

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ PROXIMITY INPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
cabProximityPct = input.float(1.0, "CAB proximity to box (%)", minval=0.0, maxval=5.0, display=display.none)
cabDistance     = close * (cabProximityPct / 100.0)

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ PROXIMITY TO BOX (BARâ€‘0) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
insideLowBox0   = low  >= pl_btm and high <= pl_top
insideHighBox0  = high <= ph_top and low  >= ph_btm

nearLowBox0     = math.abs(low  - pl_top) <= cabDistance or math.abs(low  - pl_btm) <= cabDistance
nearHighBox0    = math.abs(high - ph_top) <= cabDistance or math.abs(high - ph_btm) <= cabDistance

inBox0 = insideLowBox0 or insideHighBox0 or nearLowBox0 or nearHighBox0

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ TREND COLOR (BARâ€‘0) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
lineIsGreen0 = isBull
lineIsRed0   = isBear
lineIsGrey0  = not lineIsGreen0 and not lineIsRed0

trendAllowsBearCAB = lineIsGreen0 or lineIsGrey0
trendAllowsBullCAB = lineIsRed0   or lineIsGrey0

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SWEEP ALLOWANCE (BARâ€‘0) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
allowBullSweep0 = allowBullSweep
allowBearSweep0 = allowBearSweep

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ HIGHEST VOLUME LOGIC (BARâ€‘0) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
lookbackCAB = 10

// Track historical inâ€‘box volume
inBoxSeries = inBox0 ? volume : na

// Highest volume inside the box (last 10 bars)
highestVolInBox = ta.highest(inBoxSeries, lookbackCAB)

// Current bar must be the highest volume bar inside the box
isHighestVol0 = inBox0 and vol0 == highestVolInBox

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SWING RESET FOR LOCKOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
newSwingHigh     = not na(ph)
newSwingLow      = not na(pl)
newSwingDetected = newSwingHigh or newSwingLow

var bool cabLockout = false
if newSwingDetected
    cabLockout := false

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CAB CONDITIONS (ONEâ€‘LINERS) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
bullishCAB = not cabLockout and trendAllowsBullCAB and candleRange0 > ta.sma(candleRange0, 20) * 1.2 and vol0 > ta.sma(vol0, 20) * 1.2 and inBox0 and allowBullSweep0 and isBullCandle0 and isHighestVol0
bearishCAB = not cabLockout and trendAllowsBearCAB and candleRange0 > ta.sma(candleRange0, 20) * 1.2 and vol0 > ta.sma(vol0, 20) * 1.2 and inBox0 and allowBearSweep0 and isBearCandle0 and isHighestVol0

if bullishCAB or bearishCAB
    cabLockout := true

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SMART-MONEY CAB LABEL (Single Label with Entry + SL)
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Volume formatting
volText = str.tostring(volume, format.volume)

// Stop-loss levels (buffer = 2 ticks)
bearishSL = high + syminfo.mintick * 2
bullishSL = low  - syminfo.mintick * 2

// Entry levels
bearishEntry = low
bullishEntry = high

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// BEARISH CAB (SELL SETUP)
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if bearishCAB
    label.new(
        bar_index,
        high,
        "Instutions just grabbed "+volText + " of Gold Liquidity â†’ SELL Setup" +
        "\nWait for a low-volume momentum candle to break below CAB low." +
        "\nSell at: " + str.tostring(bearishEntry) +
        "\nStop Loss: " + str.tostring(bearishSL),
        style = label.style_label_down,
        color = color.new(color.black, 0),
        textcolor = color.white,
        yloc = yloc.abovebar
    )

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// BULLISH CAB (BUY SETUP)
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if bullishCAB
    label.new(
        bar_index,
        low,
        "Instutions just grabbed "+volText + "  Liquidity â†’ BUY Setup" +
        "\nWait for a low-volume momentum candle to break above CAB high." +
        "\nBuy at: " + str.tostring(bullishEntry) +
        "\nStop Loss: " + str.tostring(bullishSL),
        style = label.style_label_up,
        color = color.new(color.black, 0),
        textcolor = color.white,
        yloc = yloc.belowbar
    )

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CAB LINES (20â€‘bar horizontal levels)
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var cabLines = array.new_line()

// Draw lines IMMEDIATELY when CAB fires
if bullishCAB
    ln = line.new(bar_index, low, bar_index + 20, low, extend=extend.none, color=color.black, width=1)
    array.push(cabLines, ln)

if bearishCAB
    ln = line.new(bar_index, high, bar_index + 20, high, extend=extend.none, color=color.black, width=1)
    array.push(cabLines, ln)
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Clean up ONLY when array is not empty
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if array.size(cabLines) > 0
    for i = array.size(cabLines) - 1 to 0
        ln = array.get(cabLines, i)
        if bar_index > line.get_x2(ln)
            line.delete(ln)
            array.remove(cabLines, i)




//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Detect CAB Breaks
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
cabBroken = false
cabBreakDir = ""

if array.size(cabLines) > 0
    for i = 0 to array.size(cabLines) - 1
        ln = array.get(cabLines, i)
        y  = line.get_y1(ln)

        if close > y
            cabBroken := true
            cabBreakDir := "up"
            break

        if close < y
            cabBroken := true
            cabBreakDir := "down"
            break


//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STRENGTH SCORING (0â€“100%)
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Rolling averages (already renamed earlier)
avgTopVol_sweep = ta.sma(ph_vol, 20)
avgBtmVol_sweep = ta.sma(pl_vol, 20)

// Sweep depth (relative to ATR)
bullDepth = (low[length] - pl_btm) / atr
bearDepth = (ph_top - high[length]) / atr

// Clamp helper
clamp(x, minv, maxv) =>
    math.max(minv, math.min(maxv, x))

// Bullish strength score
bullVolScore   = clamp(pl_vol / avgBtmVol_sweep, 0, 2) * 40
bullDepthScore = clamp(bullDepth, 0, 1) * 30
bullTrendScore = allowBullSweep ? 30 : 0
bullStrength   = math.min(100, bullVolScore + bullDepthScore + bullTrendScore)

// Bearish strength score
bearVolScore   = clamp(ph_vol / avgTopVol_sweep, 0, 2) * 40
bearDepthScore = clamp(bearDepth, 0, 1) * 30
bearTrendScore = allowBearSweep ? 30 : 0
bearStrength   = math.min(100, bearVolScore + bearDepthScore + bearTrendScore)

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TAKE PROFIT LEVELS (TP1 / TP2 / TP3)
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Bullish TP levels
bullTP1 = ta.pivothigh(3,3)
bullTP2 = ta.pivothigh(10,10)
bullTP3 = ta.pivothigh(20,20)

// Bearish TP levels
bearTP1 = ta.pivotlow(3,3)
bearTP2 = ta.pivotlow(10,10)
bearTP3 = ta.pivotlow(20,20)

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STOP LOSS LEVELS
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
bullSL = pl_btm
bearSL = ph_top

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// BULLISH SWEEP SIGNAL
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if bullishSweep and insideLowBox and not pl_crossed and allowBullSweep
    label.new(
        bar_index,
        low0,
        "BUY SIGNAL" +
        "\nStrength: " + str.tostring(bullStrength, "#") + "%" +
        "\nWe swept the LOW â€” liquidity grabbed." +
        "\nVolume: " + str.tostring(pl_vol, format.volume) +
        "\nStop Loss: " + str.tostring(bullSL) +
        "\nTP1: " + str.tostring(bullTP1) +
        "\nTP2: " + str.tostring(bullTP2) +
        "\nTP3: " + str.tostring(bullTP3) +
        (bullStrength > 70 ? "\nHIGHâ€‘PROBABILITY SETUP â€” Don't miss this chance!" : ""),
        style = label.style_label_up,
        color = color.new(color.teal, 0),
        textcolor = color.white,
        yloc = yloc.belowbar
    )

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// BEARISH SWEEP SIGNAL
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if bearishSweep and insideHighBox and not ph_crossed and allowBearSweep
    label.new(
        bar_index,
        high0,
        "SELL SIGNAL" +
        "\nStrength: " + str.tostring(bearStrength, "#") + "%" +
        "\nWe swept the HIGH â€” liquidity grabbed." +
        "\nVolume: " + str.tostring(ph_vol, format.volume) +
        "\nStop Loss: " + str.tostring(bearSL) +
        "\nTP1: " + str.tostring(bearTP1) +
        "\nTP2: " + str.tostring(bearTP2) +
        "\nTP3: " + str.tostring(bearTP3) +
        (bearStrength > 70 ? "\nHIGHâ€‘PROBABILITY SETUP â€” Don't miss this chance!" : ""),
        style = label.style_label_down,
        color = color.new(color.red, 0),
        textcolor = color.white,
        yloc = yloc.abovebar
    )






//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LOW VOLUME ENGULFING SETUPS (Strong/Weak)
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Strength classification
bullishStrong = close > high[1]                     // full wick engulf
bullishWeak   = close > close[1] and low > low[1] and high < high[1]   // body-only engulf

bearishStrong = close < low[1]                      // full wick engulf
bearishWeak   = close < close[1] and high < high[1] and low > low[1]   // body-only engulf

// Entry & SL levels (renamed to avoid conflicts)
bullishLVEntry = high0
bullishLVSL    = low0  - syminfo.mintick * 2

bearishLVEntry = low0
bearishLVSL    = high0 + syminfo.mintick * 2

// Strength text
bullishStrengthText = bullishStrong ? "STRONG Bullish Low Volume Engulfing" :
                      bullishWeak   ? "WEAK Bullish Low Volume Engulfing" :
                                       "Bullish Low Volume Engulfing"

bearishStrengthText = bearishStrong ? "STRONG Bearish Low Volume Engulfing" :
                      bearishWeak   ? "WEAK Bearish Low Volume Engulfing" :
                                       "Bearish Low Volume Engulfing"

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// BULLISH LOW VOLUME ENGULFING SETUP
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if bullishLVEngulf
    label.new(
        bar_index,
        low0,
        bullishStrengthText +
        "\nLiquidity Grab Below Lows" +
        "\nWait for price to break ABOVE engulf high." +
        "\nBuy at: " + str.tostring(bullishLVEntry) +
        "\nStop Loss: " + str.tostring(bullishLVSL),
        style = label.style_label_up,
        color = color.new(color.green, 0),
        textcolor = color.white,
        yloc = yloc.belowbar
    )

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// BEARISH LOW VOLUME ENGULFING SETUP
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if bearishLVEngulf
    label.new(
        bar_index,
        high0,
        bearishStrengthText +
        "\nLiquidity Grab Above Highs" +
        "\nWait for price to break BELOW engulf low." +
        "\nSell at: " + str.tostring(bearishLVEntry) +
        "\nStop Loss: " + str.tostring(bearishLVSL),
        style = label.style_label_down,
        color = color.new(color.red, 0),
        textcolor = color.white,
        yloc = yloc.abovebar
    )



//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TREND LINE PLOTS (must be last to stay visible)
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Base faint EMA line
plot(fastEma, title="Base EMA (continuous)", color=color.new(color.gray, 85), linewidth=1, style=plot.style_line)

// Trend-strength overlays
plot(show_w1, title="Trend w1", color=lineColor, linewidth=6, style=plot.style_linebr)
plot(show_w2, title="Trend w2", color=lineColor, linewidth=8, style=plot.style_linebr)
plot(show_w3, title="Trend w3", color=lineColor, linewidth=10, style=plot.style_linebr)
plot(show_w4, title="Trend w4", color=lineColor, linewidth=12, style=plot.style_linebr)
plot(show_w5, title="Trend w5", color=lineColor, linewidth=14, style=plot.style_linebr)
