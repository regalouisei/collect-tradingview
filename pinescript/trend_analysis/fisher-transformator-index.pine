//@version=5
indicator("Fisher Transformator Index", shorttitle="Fisher TI", format=format.price, precision=2)

// ── Inputs ────────────────────────────────────────
len          = input.int(9,   "Length", minval=1)
mult         = input.float(2.2, "Normalization strength", minval=0.5, step=0.1)
smooth       = input.float(0.80, "Smoothing factor value", minval=0.0, maxval=0.98, step=0.1)
clip         = input.float(0.92, "Hard clip level", minval=-5, maxval=5, step=0.1)

trigger_lead = input.float(0.65, "Trigger Lead (0=slow EMA ←→ 1=fast envelope)", minval=-5.0, maxval=5.0, step=0.05)
trigger_len  = input.int(5,    "Trigger EMA Length", minval=1, maxval=21)

// ── Core Fisher ───────────────────────────────────
hl2_val    = hl2
highest    = ta.highest(hl2_val, len)
lowest     = ta.lowest (hl2_val, len)
priceRange = highest - lowest

range_safe = math.max(priceRange, syminfo.mintick * 10)

raw       = (hl2_val - lowest) / range_safe
centered  = raw - 0.5
stretched = centered * mult

value = 0.0
value := smooth * math.max(-clip, math.min(clip, stretched)) + (1 - smooth) * nz(value[1])

fish1 = 0.0
fish1 := 0.5 * math.log((1 + value) / (1 - value + 1e-10)) + 0.5 * nz(fish1[1])

// ── Neuer anpassbarer Trigger (Mischung EMA + Envelope-ähnlich) ────────────────
// 0.0   → fast reagiert fast wie fish1 selbst (sehr aggressiv)
// 1.0   → sehr glatte EMA (verzögert, klassisch)
// dazwischen → gewichtete Mischung

ema_slow   = ta.ema(fish1, trigger_len)
env_fast   = fish1                                 // quasi 0-period EMA = instant

trigger    = (1 - trigger_lead) * ema_slow + trigger_lead * env_fast

// ── Plots ──────────────────────────────────────────
plot(fish1,   "Fisher",    color=#2962FF, linewidth=2)
plot(trigger, "Trigger",   color=#FF6D00, linewidth=1)

// Füllung zwischen Fisher und Trigger
fill(plot(fish1), plot(trigger), 
     color = fish1 > trigger ? color.new(#00C853, 84) : color.new(#D50000, 84), 
     title = "Fisher vs Trigger")

// Nur noch Nulllinie als Orientierung (optional auskommentieren wenn nicht gewünscht)
hline(0, "Zero", color=color.new(color.gray, 70), linestyle=hline.style_dotted)
