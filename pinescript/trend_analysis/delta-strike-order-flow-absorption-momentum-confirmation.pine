//@version=6
//@author https://github.com/KodaTao
//@author https://t.me/kodatao
indicator("é‡èƒ½çŒæ€æŒ‡æ ‡ (Delta Strike)", overlay=true, max_labels_count=500, max_boxes_count=500, max_lines_count=500)

// ================= 1. å‚æ•°è®¾ç½® =================
ticks_per_row = input.int(50, title="Ticks Per Row (ç½‘æ ¼èšåˆ)", group="è®¢å•æµåº•å±‚è®¾ç½®")

va_percent = input.int(86, title="VPä»·å€¼åŒºé—´æ¯”ä¾‹", group="Volume Profile")
lose_balance_ratio = input.float(15, title="æµåŠ¨æ€§å¤±è¡¡æ¯”", group="Volume Profile")

vol_length_short = input.int(20, title="çŸ­å‡é‡è®¡ç®—å‘¨æœŸ", group="æˆäº¤é‡è®¾ç½®")
vol_length_middle = input.int(60, title="ä¸­å‡é‡è®¡ç®—å‘¨æœŸ", group="æˆäº¤é‡è®¾ç½®")
vol_length_long  = input.int(180, title="é•¿å‡é‡è®¡ç®—å‘¨æœŸ", group="æˆäº¤é‡è®¾ç½®")

ratio_short   = input.float(1.5, title="çŸ­æœŸåè½¬æ”¾é‡å€æ•°", group="æ”¾é‡çº§åˆ«åˆ¤å®š")
ratio_mid     = input.float(3.0, title="ä¸­æœŸåè½¬æ”¾é‡å€æ•°", group="æ”¾é‡çº§åˆ«åˆ¤å®š")
ratio_long    = input.float(5.0, title="é•¿æœŸåè½¬æ”¾é‡å€æ•°", group="æ”¾é‡çº§åˆ«åˆ¤å®š")

rsi_len       = input.int(14, title="RSI å‘¨æœŸ", group="è¶…ä¹°è¶…å–ç¯å¢ƒè¿‡æ»¤")
rsi_ob        = input.int(60, title="RSI è¶…ä¹°çº¿ (å¯»é¡¶é˜ˆå€¼)", group="è¶…ä¹°è¶…å–ç¯å¢ƒè¿‡æ»¤")
rsi_os        = input.int(40, title="RSI è¶…å–çº¿ (å¯»åº•é˜ˆå€¼)", group="è¶…ä¹°è¶…å–ç¯å¢ƒè¿‡æ»¤")

n_confirm        = input.int(12, title="æœ€å¤§ç­‰å¾…ç¡®è®¤Kçº¿æ•° (N)", group="å³ä¾§è·Ÿè¿›ç¡®è®¤", minval=1)
use_strict_delta = input.bool(true, title="å¯ç”¨å³ä¾§ Delta å¼ºåº¦è¿‡æ»¤", group="å³ä¾§è·Ÿè¿›ç¡®è®¤")
min_delta_pct    = input.float(5.0, title="æœ€å°ä¸»åŠ¨å‡€èƒœæ¯”ä¾‹(%)", group="å³ä¾§è·Ÿè¿›ç¡®è®¤") / 100.0

st_atr_len       = input.int(14, title="Supertrend ATR å‘¨æœŸ", group="è¶…çº§è¶‹åŠ¿çªç ´è®¾ç½®")
st_mult          = input.float(3.0, title="Supertrend ä¹˜æ•°", group="è¶…çº§è¶‹åŠ¿çªç ´è®¾ç½®")
st_filter_delta  = input.bool(true, title="STçªç ´éœ€ç»“åˆDeltaæ–¹å‘éªŒè¯", group="è¶…çº§è¶‹åŠ¿çªç ´è®¾ç½®")

// --- å‘Šè­¦æ§åˆ¶é¢æ¿ ---
grp_alert = "å‘Šè­¦è®¾ç½® (Alerts)"
alert_bottom  = input.bool(true, title="å¼€å¯ï¼šåº•éƒ¨å¸æ”¶ç¡®è®¤å‘Šè­¦ (åšå¤š)", group=grp_alert)
alert_top     = input.bool(true, title="å¼€å¯ï¼šé¡¶éƒ¨å¸æ”¶ç¡®è®¤å‘Šè­¦ (åšç©º)", group=grp_alert)
alert_st_buy  = input.bool(true, title="å¼€å¯ï¼šSTæœ‰æ•ˆå¤šå¤´çªç ´å‘Šè­¦", group=grp_alert)
alert_st_sell = input.bool(true, title="å¼€å¯ï¼šSTæœ‰æ•ˆç©ºå¤´çªç ´å‘Šè­¦", group=grp_alert)

// ================= 2. è·å–åº•å±‚æ•°æ® =================
fp = request.footprint(ticks_per_row, va_percent, 300)
float delta_vol = na(fp) ? na : fp.delta()

avg_vol_short   = ta.sma(volume, vol_length_short)
vol_ratio_short = volume / avg_vol_short
avg_vol_middle   = ta.sma(volume, vol_length_middle)
vol_ratio_middle = volume / avg_vol_middle
avg_vol_long    = ta.sma(volume, vol_length_long)
vol_ratio_long  = volume / avg_vol_long

rsi_val = ta.rsi(close, rsi_len)
float current_delta_pct = volume == 0 ? 0 : math.abs(delta_vol) / volume
[st_value, st_dir] = ta.supertrend(st_mult, st_atr_len)

var int last_base_index_bottom = na
var int last_base_index_top = na

// ================= 3. æ ¸å¿ƒé‡åŒ–é€»è¾‘ (æ›´æ–°åŠ å…¥ Footprint æ·±åº¦éªŒè¯) =================
bool is_vol_spike = (vol_ratio_short >= ratio_short) or (vol_ratio_middle >= ratio_short) or (vol_ratio_long >= ratio_short)

// æå–åŸæœ‰çš„åŸºç¡€åˆ¤æ–­é€»è¾‘
bool base_setup_bottom = is_vol_spike and (delta_vol < 0) and (close > low + (high - low) * 0.2) and (rsi_val <= rsi_os)
bool base_setup_top    = is_vol_spike and (delta_vol > 0) and (close < high - (high - low) * 0.2) and (rsi_val >= rsi_ob)

bool fp_bottom_exhaustion = false
bool fp_top_exhaustion = false
float current_imb_bottom = na // æ–°å¢ï¼šå½“å‰Kçº¿åº•éƒ¨å¤±è¡¡æ¯”
float current_imb_top = na    // æ–°å¢ï¼šå½“å‰Kçº¿é¡¶éƒ¨å¤±è¡¡æ¯”

if not na(fp)
    volume_row val_row = fp.val()
    volume_row vah_row = fp.vah()
    array<volume_row> rows = fp.rows()
    
    // 1. åˆ¤æ–­åº•éƒ¨å¸æ”¶ï¼šéå†æ‰€æœ‰ä½äº VAL ä¹‹ä¸‹çš„è¡Œï¼Œå¦‚æœæ€»å–å‡º > æ€»ä¹°å…¥ï¼Œè§†ä¸ºææ…Œç›˜å¯èƒ½æ€å°½
    if not na(val_row)
        float val_price = val_row.down_price()
        float sum_sell_below_val = 0.0
        float sum_buy_below_val  = 0.0
        for r in rows
            if r.up_price() <= val_price
                sum_sell_below_val += r.sell_volume()
                sum_buy_below_val  += r.buy_volume()
        
        // å®‰å…¨è®¡ç®—ï¼šé˜²æ­¢ä¹°å…¥é‡ä¸º0å¯¼è‡´é™¤ä»¥é›¶é”™è¯¯
        current_imb_bottom := sum_buy_below_val == 0 ? (sum_sell_below_val > 0 ? 999.0 : 0) : (sum_sell_below_val / sum_buy_below_val)
        if current_imb_bottom > lose_balance_ratio
            fp_bottom_exhaustion := true

    // 2. åˆ¤æ–­é¡¶éƒ¨å¸æ”¶ï¼šéå†æ‰€æœ‰ä½äº VAH ä¹‹ä¸Šçš„è¡Œï¼Œå¦‚æœæ€»ä¹°å…¥ > æ€»å–å‡ºï¼Œè§†ä¸ºé€¼ç©ºç›˜å¯èƒ½è€—å°½
    if not na(vah_row)
        float vah_price = vah_row.up_price()
        float sum_sell_above_vah = 0.0
        float sum_buy_above_vah  = 0.0
        for r in rows
            if r.down_price() >= vah_price
                sum_sell_above_vah += r.sell_volume()
                sum_buy_above_vah  += r.buy_volume()
        
        // å®‰å…¨è®¡ç®—ï¼šé˜²æ­¢å–å‡ºé‡ä¸º0å¯¼è‡´é™¤ä»¥é›¶é”™è¯¯
        current_imb_top := sum_sell_above_vah == 0 ? (sum_buy_above_vah > 0 ? 999.0 : 0) : (sum_buy_above_vah / sum_sell_above_vah)
        if current_imb_top > lose_balance_ratio
            fp_top_exhaustion := true

// ç»„åˆæœ€ç»ˆçš„ Setup åˆ¤å®šï¼Œå°†åŸºç¡€é€»è¾‘ä¸æ·±åº¦è¿‡æ»¤ç»“æœåˆå¹¶ï¼Œä¿è¯å‘ä¸‹å…¼å®¹ä¸å½±å“åç»­ history å¼•ç”¨ [j]
bool is_setup_bottom = base_setup_bottom and fp_bottom_exhaustion
bool is_setup_top    = base_setup_top and fp_top_exhaustion


bool  confirm_bottom = false
int   setup_offset_b = na
float setup_ratio_s_b = na
float setup_ratio_m_b = na
float setup_ratio_l_b = na
float setup_delta_b  = na
float setup_imb_b    = na // è®°å½•è§¦å‘ä¿¡å·æ—¶çš„åº•éƒ¨å¤±è¡¡æ¯”

bool  confirm_top = false
int   setup_offset_t = na
float setup_ratio_s_t = na
float setup_ratio_m_t = na
float setup_ratio_l_t = na
float setup_delta_t  = na
float setup_imb_t    = na // è®°å½•è§¦å‘ä¿¡å·æ—¶çš„é¡¶éƒ¨å¤±è¡¡æ¯”

// å‘å‰å¯»æ‰¾åº•éƒ¨ç¡®è®¤
for j = 1 to n_confirm
    if is_setup_bottom[j]
        bool base_confirm = (close > open) and (close > close[j])
        bool delta_confirm = (delta_vol > 0) and (not use_strict_delta or current_delta_pct >= min_delta_pct)

        if base_confirm and delta_confirm
            confirm_bottom := true
            setup_offset_b := j
            setup_ratio_s_b := vol_ratio_short[j]
            setup_ratio_m_b := vol_ratio_middle[j]
            setup_ratio_l_b := vol_ratio_long[j]
            setup_delta_b  := delta_vol[j]
            setup_imb_b    := current_imb_bottom[j] // æ•è·å½“æ—¶çš„å¤±è¡¡æ¯”
            break

// å‘å‰å¯»æ‰¾é¡¶éƒ¨ç¡®è®¤
for j = 1 to n_confirm
    if is_setup_top[j]
        bool base_confirm = (close < open) and (close < close[j])
        bool delta_confirm = (delta_vol < 0) and (not use_strict_delta or current_delta_pct >= min_delta_pct)

        if base_confirm and delta_confirm
            confirm_top := true
            setup_offset_t := j
            setup_ratio_s_t := vol_ratio_short[j]
            setup_ratio_m_t := vol_ratio_middle[j]
            setup_ratio_l_t := vol_ratio_long[j]
            setup_delta_t  := delta_vol[j]
            setup_imb_t    := current_imb_top[j] // æ•è·å½“æ—¶çš„å¤±è¡¡æ¯”
            break

bool is_st_buy_breakout  = ta.change(st_dir) < 0
bool is_st_sell_breakout = ta.change(st_dir) > 0
bool valid_st_buy  = is_st_buy_breakout  and (not st_filter_delta or delta_vol > 0)
bool valid_st_sell = is_st_sell_breakout and (not st_filter_delta or delta_vol < 0)

// ================= 4. å¯è§†åŒ–ç»˜åˆ¶ (åŸæœ‰é€»è¾‘å®Œæ•´ä¿ç•™) =================
var int base_index = na
var bool is_bottom = false
if confirm_bottom
    base_index := bar_index - setup_offset_b
    is_bottom := true
    if na(last_base_index_bottom) or base_index != last_base_index_bottom
        string spike_type = "è¯„åˆ†ï¼š"
        int spike_score = 0
        if (setup_ratio_s_b >= ratio_short)
            spike_score += 1
        if (setup_ratio_m_b >= ratio_short)
            spike_score += 1
        if (setup_ratio_l_b >= ratio_short)
            spike_score += 1
        if (setup_ratio_s_b >= ratio_mid)
            spike_score += 1
        if (setup_ratio_m_b >= ratio_mid)
            spike_score += 1
        if (setup_ratio_l_b >= ratio_mid)
            spike_score += 1
        if (setup_ratio_s_b >= ratio_long)
            spike_score += 1
        if (setup_ratio_m_b >= ratio_long)
            spike_score += 1
        if (setup_ratio_l_b >= ratio_long)
            spike_score += 1
        spike_type := spike_type+str.tostring(spike_score)+"/9"
        
        // æ›´æ–°äº† Label å†…å®¹ï¼ŒåŠ å…¥â€œå¤±è¡¡â€æ¯”ä¾‹
        string imb_str = setup_imb_b >= 999.0 ? "MAX" : str.tostring(math.round(setup_imb_b, 1)) + "x"
        string base_text = "ğŸ˜±ææ…ŒğŸ˜±\n" + spike_type + "\nå¤±è¡¡: " + imb_str + "\nçŸ­æœŸ: " + str.tostring(math.round(setup_ratio_s_b, 1)) +"x\nä¸­æœŸ: " + str.tostring(math.round(setup_ratio_m_b, 1)) + "x\né•¿æœŸ: " + str.tostring(math.round(setup_ratio_l_b, 1)) + "x\nè¢«åŠ¨: " + str.tostring(setup_delta_b, format.volume)
        label.new(base_index, low[setup_offset_b] - ta.tr[setup_offset_b] * 0.5, text=base_text, style=label.style_label_up, color=color.green, textcolor=color.white, size=size.tiny)
        last_base_index_bottom := base_index

if confirm_top
    base_index := bar_index - setup_offset_t
    is_bottom := false
    if na(last_base_index_top) or base_index != last_base_index_top
        
        string spike_type = "è¯„åˆ†ï¼š"
        int spike_score = 0
        if (setup_ratio_s_t >= ratio_short)
            spike_score += 1
        if (setup_ratio_m_t >= ratio_short)
            spike_score += 1
        if (setup_ratio_l_t >= ratio_short)
            spike_score += 1
        if (setup_ratio_s_t >= ratio_mid)
            spike_score += 1
        if (setup_ratio_m_t >= ratio_mid)
            spike_score += 1
        if (setup_ratio_l_t >= ratio_mid)
            spike_score += 1
        if (setup_ratio_s_t >= ratio_long)
            spike_score += 1
        if (setup_ratio_m_t >= ratio_long)
            spike_score += 1
        if (setup_ratio_l_t >= ratio_long)
            spike_score += 1
        spike_type := spike_type+str.tostring(spike_score)+"/9"
        
        // æ›´æ–°äº† Label å†…å®¹ï¼ŒåŠ å…¥â€œå¤±è¡¡â€æ¯”ä¾‹
        string imb_str = setup_imb_t >= 999.0 ? "MAX" : str.tostring(math.round(setup_imb_t, 1)) + "x"
        string base_text = "ğŸ‘‘é€¼ç©ºğŸ‘‘\n" + spike_type + "\nå¤±è¡¡: " + imb_str + "\nçŸ­æœŸ: " + str.tostring(math.round(setup_ratio_s_t, 1)) +"x\nä¸­æœŸ: " + str.tostring(math.round(setup_ratio_m_t, 1)) + "x\né•¿æœŸ: " + str.tostring(math.round(setup_ratio_l_t, 1)) + "x\nè¢«åŠ¨: " + str.tostring(setup_delta_t, format.volume)
        label.new(base_index, high[setup_offset_t] + ta.tr[setup_offset_t] * 0.5, text=base_text, style=label.style_label_down, color=color.red, textcolor=color.white, size=size.tiny)
        last_base_index_top := base_index

// --- N æ ¹ K çº¿æ€»ç»“ ---
if barstate.islast and bar_index <= base_index + n_confirm
    int bull_bars = 0
    int bear_bars = 0
    float sum_delta = 0.0
    float sum_bull_delta = 0.0
    float sum_bear_delta = 0.0
    int bull_close_cnt = 0
    int bear_close_cnt = 0

    for k = 0 to n_confirm - 1
        float d = nz(delta_vol[k])
        sum_delta += d
        if d > 0
            bull_bars += 1
            sum_bull_delta += d
        else if d < 0
            bear_bars += 1
            sum_bear_delta += d
        if close[k] > open[k]
            bull_close_cnt += 1
        else if close[k] < open[k]
            bear_close_cnt += 1

    string winner = sum_delta < 0 ? "ğŸ”´ ç©ºèƒœ" : (sum_delta > 0 ? "ğŸŸ¢ å¤šèƒœ" : "âšª å‡è¡¡")
    string summary_txt = "â•â•â• "+ str.tostring(n_confirm) +"Kæ€»ç»“ â•â•â•\n" + winner + "\nå¤šÎ”æ ¹: " + str.tostring(bull_bars) + " | ç©ºÎ”æ ¹: " + str.tostring(bear_bars) + "\né˜³çº¿: " + str.tostring(bull_close_cnt) + " | é˜´çº¿: " + str.tostring(bear_close_cnt) + "\nå‡€Î”åˆè®¡: " + str.tostring(sum_delta, format.volume) + "\nå¤šæ–¹Î”: +" + str.tostring(sum_bull_delta, format.volume) + "\nç©ºæ–¹Î”: " + str.tostring(sum_bear_delta, format.volume) + "\n"

    if (is_bottom)
        label.new(bar_index, low-ta.tr * 0.15, text=summary_txt, style=label.style_label_up, color=color.new(#c4ffae, 10), textcolor=color.black, size=size.tiny)
        // line.new(x1=base_index, y1=low[setup_offset_b], x2=bar_index, y2=low, color=color.new(color.lime, 40), style=line.style_arrow_both, width=2)
    else
        label.new(bar_index, high+ta.tr*0.15, text=summary_txt, style=label.style_label_down, color=color.new(#f5c9ad, 10), textcolor=color.black, size=size.tiny)
        // line.new(x1=base_index, y1=high[setup_offset_t], x2=bar_index, y2=high, color=color.new(color.red, 40), style=line.style_dashed, width=2)


plot(st_dir < 0 ? st_value : na, color=color.new(color.teal, 20), style=plot.style_linebr, linewidth=2, title="ST æ”¯æ’‘çº¿")
plot(st_dir > 0 ? st_value : na, color=color.new(color.orange, 20), style=plot.style_linebr, linewidth=2, title="ST é˜»åŠ›çº¿")
plotshape(valid_st_buy,  title="ST æœ‰æ•ˆå¤šå¤´çªç ´", style=shape.triangleup,   location=location.belowbar, color=color.teal,   size=size.small, text="STçªç ´", textcolor=color.teal)
plotshape(valid_st_sell, title="ST æœ‰æ•ˆç©ºå¤´çªç ´", style=shape.triangledown, location=location.abovebar, color=color.orange, size=size.small, text="STè·Œç ´", textcolor=color.orange)

// ================= 5. å‘Šè­¦è§¦å‘æ¨¡å— (åŸæœ‰å®Œæ•´ä¿ç•™) =================
if confirm_bottom and alert_bottom
    alert("ğŸŸ¢ã€åšå¤šä¿¡å·ã€‘è®¢å•æµåº•éƒ¨å¸æ”¶å·²è¢«å¼ºåŠ›ç¡®è®¤ï¼", alert.freq_once_per_bar_close)

if confirm_top and alert_top
    alert("ğŸ”´ã€åšç©ºä¿¡å·ã€‘è®¢å•æµé¡¶éƒ¨å¸æ”¶å·²è¢«å¼ºåŠ›ç¡®è®¤ï¼", alert.freq_once_per_bar_close)

if valid_st_buy and alert_st_buy
    alert("ğŸš€ã€è¶‹åŠ¿åšå¤šã€‘è¶…çº§è¶‹åŠ¿å‘ä¸Šæœ‰æ•ˆçªç ´ï¼", alert.freq_once_per_bar_close)

if valid_st_sell and alert_st_sell
    alert("ğŸ”»ã€è¶‹åŠ¿åšç©ºã€‘è¶…çº§è¶‹åŠ¿å‘ä¸‹æœ‰æ•ˆè·Œç ´ï¼", alert.freq_once_per_bar_close)

alertcondition(confirm_bottom and alert_bottom, title="[å‘Šè­¦] åº•éƒ¨å¸æ”¶ç¡®è®¤ (åšå¤š)", message="ğŸŸ¢ã€åšå¤šä¿¡å·ã€‘è®¢å•æµåº•éƒ¨å¸æ”¶å·²ç¡®è®¤ï¼")
alertcondition(confirm_top and alert_top,       title="[å‘Šè­¦] é¡¶éƒ¨å¸æ”¶ç¡®è®¤ (åšç©º)", message="ğŸ”´ã€åšç©ºä¿¡å·ã€‘è®¢å•æµé¡¶éƒ¨å¸æ”¶å·²ç¡®è®¤ï¼")
alertcondition(valid_st_buy and alert_st_buy,   title="[å‘Šè­¦] STæœ‰æ•ˆå¤šå¤´çªç ´",     message="ğŸš€ã€è¶‹åŠ¿åšå¤šã€‘è¶…çº§è¶‹åŠ¿å‘ä¸Šæœ‰æ•ˆçªç ´ï¼")
alertcondition(valid_st_sell and alert_st_sell, title="[å‘Šè­¦] STæœ‰æ•ˆç©ºå¤´çªç ´",     message="ğŸ”»ã€è¶‹åŠ¿åšç©ºã€‘è¶…çº§è¶‹åŠ¿å‘ä¸‹æœ‰æ•ˆè·Œç ´ï¼")
