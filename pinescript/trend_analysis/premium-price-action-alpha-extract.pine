//@version=6
indicator("Premium Price Action [Alpha Extract]", overlay=true, max_labels_count=500, behind_chart = false)

// INPUT SETTINGS
group_lookback = "Lookback Periods"
lookback1 = input.int(12, "First Lookback", minval=1, group=group_lookback)
lookback2 = input.int(27, "Second Lookback", minval=1, group=group_lookback)
sma_length = input.int(30, "SMA Length", minval=1, group=group_lookback)

group_engine = "Trend Engine"
smooth_len = input.int(5, "Baseline Smoothing", minval=1, group=group_engine)
atr_len = input.int(16, "ATR Length", minval=1, group=group_engine)
rail_mult = input.float(1.35, "Rail Distance (ATR)", minval=0.1, step=0.05, group=group_engine)
ribbon_mult = input.float(0.50, "Ribbon Width (ATR)", minval=0.1, step=0.05, group=group_engine)

group_colors = "Colors"
color_bull = input.color(color.new(#00C896, 0), "Bullish", group=group_colors)
color_bear = input.color(color.new(#FF3D6E, 0), "Bearish", group=group_colors)
color_neutral = input.color(color.new(#787B86, 0), "Neutral", group=group_colors)

group_visuals = "Visual Style"
line_width = input.int(3, "Main Rail Width", minval=1, maxval=6, group=group_visuals)
show_glow = input.bool(true, "Rail Glow", group=group_visuals)
glow_transp = input.int(78, "Glow Transparency", minval=0, maxval=100, group=group_visuals)
show_ribbon = input.bool(true, "Trend Ribbon", group=group_visuals)
ribbon_transp = input.int(84, "Ribbon Transparency", minval=0, maxval=100, group=group_visuals)
show_background = input.bool(true, "Regime Background", group=group_visuals)
bg_base_transp = input.int(94, "Background Transparency", minval=0, maxval=100, group=group_visuals)
show_baseline = input.bool(false, "Show Baseline", group=group_visuals)
show_candles = input.bool(true, "Plot Trend Candles", group=group_visuals)
tint_candles = input.bool(false, "Color Chart Candles", group=group_visuals)
show_flip_labels = input.bool(true, "Show BULL/BEAR Labels", group=group_visuals)

// CORE CALCULATIONS
c1 = close[lookback1]
c2 = close[lookback2]
c_avg = (c1 + c2) / 2.0
baseline_raw = ta.sma(c_avg, sma_length)
baseline = ta.ema(baseline_raw, smooth_len)

atr = ta.atr(atr_len)
upper = baseline + atr * rail_mult
lower = baseline - atr * rail_mult

// Adaptive trailing rails for cleaner staircase behavior.
var float rail_bull = na
var float rail_bear = na
rail_bull := close[1] > nz(rail_bull[1], lower) ? math.max(lower, nz(rail_bull[1], lower)) : lower
rail_bear := close[1] < nz(rail_bear[1], upper) ? math.min(upper, nz(rail_bear[1], upper)) : upper

var int trend = 1
prev_trend = nz(trend[1], 1)
trend := prev_trend
if prev_trend == 1 and close < nz(rail_bull[1], lower)
    trend := -1
else if prev_trend == -1 and close > nz(rail_bear[1], upper)
    trend := 1

rail = trend == 1 ? rail_bull : rail_bear
trend_color = trend == 1 ? color_bull : color_bear

momentum = close - baseline
momentum_smooth = ta.ema(momentum, 5)
strength = math.min(1.0, atr > 0 ? math.abs(momentum_smooth) / atr : 0.0)
bg_dynamic_transp = int(math.max(0.0, math.min(100.0, bg_base_transp - strength * 25.0)))
ribbon_dynamic_transp = int(math.max(0.0, math.min(100.0, ribbon_transp - strength * 12.0)))
glow_outer_transp = int(math.min(100.0, glow_transp + 12.0))

ribbon_size = atr * ribbon_mult
bull_ribbon_top = trend == 1 ? rail : na
bull_ribbon_bot = trend == 1 ? rail - ribbon_size : na
bear_ribbon_bot = trend == -1 ? rail : na
bear_ribbon_top = trend == -1 ? rail + ribbon_size : na

flip_to_bull = trend == 1 and prev_trend == -1
flip_to_bear = trend == -1 and prev_trend == 1

// PLOTTING
plot(show_glow ? rail : na, "Rail Glow Outer", color=color.new(trend_color, glow_outer_transp), linewidth=line_width + 4, style=plot.style_stepline)
plot(show_glow ? rail : na, "Rail Glow Inner", color=color.new(trend_color, glow_transp), linewidth=line_width + 2, style=plot.style_stepline)
plot(rail, "Trend Rail", color=trend_color, linewidth=line_width, style=plot.style_stepline)
plot(show_baseline ? baseline : na, "Baseline", color=color.new(color_neutral, 35), linewidth=1)

bull_top_plot = plot(show_ribbon ? bull_ribbon_top : na, "Bull Ribbon Top", color=color.new(color_bull, 100), style=plot.style_stepline, display=display.none)
bull_bot_plot = plot(show_ribbon ? bull_ribbon_bot : na, "Bull Ribbon Bot", color=color.new(color_bull, 100), style=plot.style_stepline, display=display.none)
fill(bull_top_plot, bull_bot_plot, title="Bull Ribbon", color=color.new(color_bull, ribbon_dynamic_transp))

bear_top_plot = plot(show_ribbon ? bear_ribbon_top : na, "Bear Ribbon Top", color=color.new(color_bear, 100), style=plot.style_stepline, display=display.none)
bear_bot_plot = plot(show_ribbon ? bear_ribbon_bot : na, "Bear Ribbon Bot", color=color.new(color_bear, 100), style=plot.style_stepline, display=display.none)
fill(bear_top_plot, bear_bot_plot, title="Bear Ribbon", color=color.new(color_bear, ribbon_dynamic_transp))

bgcolor(show_background ? color.new(trend_color, bg_dynamic_transp) : na, title="Regime Background")
barcolor(tint_candles ? trend_color : na, title="Candle Tint")
plotcandle(show_candles ? open : na, show_candles ? high : na, show_candles ? low : na, show_candles ? close : na,
     title="Trend Candles", color=trend_color, wickcolor=trend_color, bordercolor=trend_color, force_overlay=true)

if show_flip_labels and flip_to_bull
    label.new(bar_index, rail - ribbon_size * 0.35, "BULL", style=label.style_label_up, color=color.new(color_bull, 0), textcolor=color.white, size=size.tiny)

if show_flip_labels and flip_to_bear
    label.new(bar_index, rail + ribbon_size * 0.35, "BEAR", style=label.style_label_down, color=color.new(color_bear, 0), textcolor=color.white, size=size.tiny)
