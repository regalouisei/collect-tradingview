//@version=5
// @description 这是一个基于指定历史区间的静态黄金分割指标。
// This script calculates static Fibonacci levels based on a defined historical lookback period.

indicator("Golden Ratio Levels: Static Range Anchor", shorttitle="GR_Static", overlay=true)

// ==========================================
// --- INPUT PARAMETERS | 输入参数 ---
// ==========================================
n1         = input.int(150, "Lookback Period | 统计周期", minval=1, tooltip="The number of bars to search for High/Low values. | 用于寻找最高价/最低价的 K 线数量。")
m1         = input.int(3, "Offset Bars | 偏移周期", minval=0, tooltip="Shift the calculation window back from the current bar. | 计算窗口相对于当前 K 线的向后偏移量。")
showLabels = input.bool(true, "Display Labels | 显示比例标签", group="Visual Settings | 视觉设置")

// ==========================================
// --- CORE CALCULATION | 核心计算 ---
// ==========================================
// Extracting extremum values. ta.highest/lowest must run on every bar for sequence consistency.
// 提取极值。注意：ta.highest/lowest 必须在每根 K 线上运行以确保序列一致性。
src_hh = ta.highest(high[m1], n1)
src_ll = ta.lowest(low[m1], n1)

// Variables for anchoring values to prevent recalculation jitter.
// 使用 var 声明变量以锚定数值，防止随实时价格波动而产生重绘抖动。
var float anchor_hh = na
var float anchor_ll = na

// Capture the final values only when the last historical bar is reached (simulating CONST).
// 仅在最后一根 K 线处捕获最终数值（模拟通达信中的 CONST 效果）。
if barstate.islast
    anchor_hh := src_hh
    anchor_ll := src_ll

float diff = anchor_hh - anchor_ll

// Define Fibonacci retracement levels.
// 定义黄金分割回撤位。
p191 = anchor_hh - diff * 0.191
p382 = anchor_hh - diff * 0.382
pmid = (anchor_hh + anchor_ll) / 2
p618 = anchor_hh - diff * 0.618
p809 = anchor_hh - diff * 0.809

// ==========================================
// --- RENDERING ENGINE | 绘图引擎 ---
// ==========================================
int start_bar = last_bar_index - (n1 + m1)

// Initialize line/label objects with 'var' to enable persistent management.
// 使用 'var' 初始化线段和标签对象，以便进行持久化管理和清除。
var line ln_hh = na, var line ln_191 = na, var line ln_382 = na
var line ln_mid = na, var line ln_618 = na, var line ln_809 = na
var line ln_ll = na, var line ln_v = na

var label lb_hh = na, var label lb_191 = na, var label lb_382 = na
var label lb_mid = na, var label lb_618 = na, var label lb_809 = na
var label lb_ll = na, var label lb_start = na

if barstate.islast
    // Garbage collection: Remove existing drawings before re-plotting.
    // 垃圾回收：在重新绘图前删除已有图形，确保性能。
    line.delete(ln_hh), line.delete(ln_191), line.delete(ln_382), line.delete(ln_mid)
    line.delete(ln_618), line.delete(ln_809), line.delete(ln_ll), line.delete(ln_v)
    
    label.delete(lb_hh), label.delete(lb_191), label.delete(lb_382), label.delete(lb_mid)
    label.delete(lb_618), label.delete(lb_809), label.delete(lb_ll), label.delete(lb_start)

    // --- Plotting Lines | 绘制线条 ---
    ln_hh  := line.new(start_bar, anchor_hh, last_bar_index, anchor_hh, color=color.red, width=2)
    ln_191 := line.new(start_bar, p191, last_bar_index, p191, color=color.rgb(183, 226, 226), style=line.style_dashed)
    ln_382 := line.new(start_bar, p382, last_bar_index, p382, color=color.red, style=line.style_dashed)
    ln_mid := line.new(start_bar, pmid, last_bar_index, pmid, color=color.white, style=line.style_solid)
    ln_618 := line.new(start_bar, p618, last_bar_index, p618, color=color.red, style=line.style_dashed)
    ln_809 := line.new(start_bar, p809, last_bar_index, p809, color=color.rgb(183, 226, 226), style=line.style_dashed)
    ln_ll  := line.new(start_bar, anchor_ll, last_bar_index, anchor_ll, color=color.green, width=2)
    ln_v   := line.new(start_bar, anchor_hh, start_bar, anchor_ll, color=color.gray, style=line.style_dotted)

    // --- Plotting Labels | 绘制标签 ---
    if showLabels
        // Construct labels with transparent background for a clean UI.
        // 使用透明背景创建标签，保持 UI 清洁。
        lb_hh    := label.new(last_bar_index, anchor_hh, "HH [" + str.tostring(anchor_hh, format.mintick) + "]", style=label.style_label_left, textcolor=color.red, color=color.new(color.black, 100))
        lb_191   := label.new(last_bar_index, p191, "19.1%", style=label.style_label_left, textcolor=color.rgb(183, 226, 226), color=color.new(color.black, 100))
        lb_382   := label.new(last_bar_index, p382, "38.2%", style=label.style_label_left, textcolor=color.red, color=color.new(color.black, 100))
        lb_mid   := label.new(last_bar_index, pmid, "50.0%", style=label.style_label_left, textcolor=color.white, color=color.new(color.black, 100))
        lb_618   := label.new(last_bar_index, p618, "61.8%", style=label.style_label_left, textcolor=color.red, color=color.new(color.black, 100))
        lb_809   := label.new(last_bar_index, p809, "80.9%", style=label.style_label_left, textcolor=color.rgb(183, 226, 226), color=color.new(color.black, 100))
        lb_ll    := label.new(last_bar_index, anchor_ll, "LL [" + str.tostring(anchor_ll, format.mintick) + "]", style=label.style_label_left, textcolor=color.green, color=color.new(color.black, 100))
        lb_start := label.new(start_bar, anchor_ll, "Anchor Point | 起点", style=label.style_label_up, textcolor=color.white, color=color.new(color.black, 100))
