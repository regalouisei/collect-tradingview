//@version=5
indicator("Master Strategy: Q-Trend + Surge Bar + Squeeze [v31]", overlay=true, max_labels_count=500, max_lines_count=500)

// ──────────────────────────────────────────────────────────────
// 1. Q-TREND (TRIGGER) INPUTS
// ──────────────────────────────────────────────────────────────
grp_qt = "1. Q-Trend (Trigger/Signal Settings)"
src_qt          = input.source(close, "Source", group=grp_qt)
p_t             = input.int(200, "Trend Period", minval=1, group=grp_qt)
atr_p_t         = input.int(14, "ATR Period", minval=1, group=grp_qt)
mult_t          = input.float(1.0, "ATR Multiplier", step=0.1, group=grp_qt)
mode_t          = input.string("Type A", "Signal Mode", options=["Type A", "Type B"], group=grp_qt)
show_tl_t       = input.bool(false, "Show Trigger Line on Chart?", group=grp_qt)
color_bars      = input.bool(true, "Color Bars based on Trigger Trend?", group=grp_qt)
show_smc_q      = input.bool(false, "Show SMC-Q-Trend (Secondary)?", group=grp_qt)

// ──────────────────────────────────────────────────────────────
// 2. Q-TREND (VISUAL) INPUTS
// ──────────────────────────────────────────────────────────────
grp_qv = "2. Q-Trend (Visual Only Settings)"
useTriggerForVis= input.bool(false, "Use Trigger Settings for Visuals?", group=grp_qv)
src_qv          = input.source(close, "Source", group=grp_qv)
p_v             = input.int(200, "Trend Period", minval=1, group=grp_qv)
atr_p_v         = input.int(14, "ATR Period", minval=1, group=grp_qv)
mult_v          = input.float(3.0, "ATR Multiplier", step=0.1, group=grp_qv)
mode_v          = input.string("Type A", "Signal Mode", options=["Type A", "Type B"], group=grp_qv)
show_tl_v       = input.bool(true, "Show Visual Trend Line?", group=grp_qv)

// ──────────────────────────────────────────────────────────────
// 3a. SURGE BAR SETTINGS (MTF)
// ──────────────────────────────────────────────────────────────
grp_s = "3a. Surge Bar Settings & Filters"
htfSurge        = input.timeframe("2", "Surge Calculation Timeframe", group=grp_s)
volMult         = input.float(0.8,  "Volume Surge Multiplier", step=0.1, group=grp_s)
surgeMult       = input.float(0.9,  "Surge Bar Size Multiplier", step=0.1, group=grp_s)
maxSpreadPct    = input.float(1.5,  "Max Distance 20/200 (%)", step=0.1, group=grp_s)
flatSlope       = input.bool(false, "Require Flat 20 MA (slope check)?", group=grp_s)

// Surge Filters
filterLocation20_S = input.bool(false, "[Surge] Filter: Buy Below / Sell Above 20 EMA", group=grp_s)
filterSlope_S      = input.bool(true,  "[Surge] Filter by Slope (20 MA)", group=grp_s)
filterBias20200_S  = input.bool(false, "[Surge] Filter by 20/200 Location", group=grp_s)
filterBias23h_S    = input.bool(false, "[Surge] Filter by HTF 23h Bias", group=grp_s)
filterBias4h_S     = input.bool(false, "[Surge] Filter by HTF 4h Bias", group=grp_s)
filterCounter_S    = input.bool(false, "[Surge] Filter Counter-Trend Surges", group=grp_s)

// ──────────────────────────────────────────────────────────────
// 3b. Q-TREND FILTERS
// ──────────────────────────────────────────────────────────────
grp_qf = "3b. Q-Trend Signal Filters"
filterQTrend       = input.bool(false, "Enable Extra Filters for Q-Trend?", group=grp_qf)
filterLocation20_Q = input.bool(false, "[Q-Trend] Filter: Buy Below / Sell Above 20 EMA", group=grp_qf)
filterSlope_Q      = input.bool(true,  "[Q-Trend] Filter by Slope (20 MA)", group=grp_qf) 
filterBias20200_Q  = input.bool(false, "[Q-Trend] Filter by 20/200 Location", group=grp_qf)
filterBias23h_Q    = input.bool(false, "[Q-Trend] Filter by HTF 23h Bias", group=grp_qf)
filterBias4h_Q     = input.bool(false, "[Q-Trend] Filter by HTF 4h Bias", group=grp_qf)

mitigationType  = input.string("Close", "Mitigation Type", options=["Wick", "Close"], group="Trade Management")

// ──────────────────────────────────────────────────────────────
// 4. TABLE SETTINGS
// ──────────────────────────────────────────────────────────────
grp_tbl = "Dashboard Table"
showDebugTable  = input.bool(true,  "Show Dashboard", group=grp_tbl)
tablePosition   = input.string("top_right", "Table Position", options=["top_right", "top_left", "bottom_right", "bottom_left"], group=grp_tbl)
tableBgColor    = input.color(color.black, "Table Background Color", group=grp_tbl)
tableBgOpacity  = input.int(0,      "Table Opacity (0=Solid)", minval=0, maxval=100, group=grp_tbl)
useCellColors   = input.bool(true,  "Use Colored Cell Backgrounds for HTF?", group=grp_tbl)
slopeLookback   = input.int(5,      "Slope Lookback Bars", minval=1, group=grp_tbl)

grp_rows = "Table Rows"
showRowPrice20  = input.bool(true,  "Show Price vs 20", group=grp_rows)
showRowSlope    = input.bool(true,  "Show Slope", group=grp_rows)
showRowBias     = input.bool(true,  "Show Bias 20/200", group=grp_rows)
showRowSMC_Pct  = input.bool(true,  "Show SMC %", group=grp_rows)
showRowSMC_Lvls = input.bool(false, "Show SMC Levels", group=grp_rows)
showRowHTF_4h_Bias   = input.bool(true,  "Show 4h Bias", group=grp_rows)
showRowHTF_4h_Range  = input.bool(false, "Show 4h Range", group=grp_rows) 
showRowHTF_4h_Mid    = input.bool(false, "Show 4h Mid", group=grp_rows)   
showRowHTF_23h_Bias  = input.bool(true,  "Show 23h Bias", group=grp_rows)
showRowHTF_23h_Range = input.bool(false, "Show 23h Range", group=grp_rows) 
showRowHTF_23h_Mid   = input.bool(false, "Show 23h Mid", group=grp_rows)   
showRowWeekly   = input.bool(true,  "Show Weekly & Prev Week", group=grp_rows)
showRowNarrow   = input.bool(false, "Show Narrow Status", group=grp_rows)  
showRowTrades   = input.bool(false, "Show Active Trades", group=grp_rows)  

grp_htf = "HTF Calculation & Levels"
lb23h           = input.int(1400, "23-Hour (S/R) Lookback", minval=1, group=grp_htf)
lb4h            = input.int(240,  "4-Hour Lookback", minval=1, group=grp_htf)
neutralMode     = input.string("23h vs SMC", "Neutral Logic", options=["23h vs 4h", "23h vs SMC"], group=grp_htf)

// ──────────────────────────────────────────────────────────────
// 5. KELTNER SQUEEZE INPUTS
// ──────────────────────────────────────────────────────────────
grp_k = "5. Keltner Squeeze Settings"
show_keltner_bands   = input.bool(true, "Show Keltner Bands & Zones", group=grp_k)
show_squeeze_signals = input.bool(true, "Show Squeeze Breakout Signals", group=grp_k)
htfKeltner           = input.timeframe("", "Keltner HTF (blank = chart)", group=grp_k)
kc_length            = input.int(40, "Keltner Length", minval=1, group=grp_k)
kc_mult_inner        = input.float(1.8, "Inner Multiplier", group=grp_k)
kc_mult_outer        = input.float(3.3, "Outer Multiplier", group=grp_k)
bb_length            = input.int(20, "BB Length", group=grp_k)
bb_mult              = input.float(2.0, "BB Mult", group=grp_k)

// ──────────────────────────────────────────────────────────────
// 6. TRADE MANAGEMENT
// ──────────────────────────────────────────────────────────────
grp_tm = "Trade Management"
triggerSource   = input.string("Q-Trend Signal", "Trade Trigger Source", options=["Surge Bar", "Q-Trend Signal"], group=grp_tm)
slSource        = input.string("Pivot High/Low", "Stop Loss Source", options=["Signal Candle", "Previous Candle", "Pivot High/Low"], group=grp_tm)
pivotLen        = input.int(10, "Pivot Lookback Length", minval=1, group=grp_tm)
showSL          = input.bool(true, "Show SL/TP Lines", group=grp_tm)
atrPeriod       = input.int(14, "ATR Period", group=grp_tm)
tp1Mult         = input.float(2.0, "TP1 Multiplier", step=0.1, group=grp_tm)
tp2Mult         = input.float(5.0, "TP2 Multiplier", step=0.1, group=grp_tm)
tp3Mult         = input.float(10.0, "TP3 Multiplier", step=0.1, group=grp_tm)

color slColorBull  = color.blue
color tpColorBull  = color.blue
color slColorBear  = color.red
color tpColorBear  = color.red
structureLen    = input.int(50,  "Market Structure Lookback", minval=10, group="Surge Bar & Filters")

// ==============================================================
// CALCULATIONS
// ==============================================================
pl = ta.pivotlow(low, pivotLen, 1)
ph = ta.pivothigh(high, pivotLen, 1)
var float lastPivotHigh = high
var float lastPivotLow  = low
if not na(pl)
    lastPivotLow := pl
if not na(ph)
    lastPivotHigh := ph

[wOpen, wHigh, wLow, wClose] = request.security(syminfo.tickerid, "W", [open, high, low, close])
wRange = wHigh - wLow
wPosPct = wRange != 0 ? ((close - wLow) / wRange) * 100 : 50
[pwHigh, pwLow, pwClose] = request.security(syminfo.tickerid, "W", [high[1], low[1], close[1]])
pwRange = pwHigh - pwLow
string pwStatus = ""
float pwPctVal = 0.0
color pwColor = color.gray
if close > pwHigh
    pwPctVal := pwRange != 0 ? ((close - pwHigh) / pwRange) * 100 : 0
    pwStatus := "Out +" + str.tostring(pwPctVal, "#") + "%"
    pwColor := color.blue
else if close < pwLow
    pwPctVal := pwRange != 0 ? ((pwLow - close) / pwRange) * 100 : 0
    pwStatus := "Out -" + str.tostring(pwPctVal, "#") + "%"
    pwColor := color.red
else
    pwPctVal := pwRange != 0 ? ((close - pwLow) / pwRange) * 100 : 50
    pwStatus := "In " + str.tostring(pwPctVal, "#") + "%"
    pwColor := pwPctVal > 50 ? color.blue : color.red

maShortLen = 20
maLongLen = 200
maShort = ta.sma(close, maShortLen)
maLong  = ta.sma(close, maLongLen)
spreadPct = (math.abs(maShort - maLong) / close) * 100
var bool isNarrow = false
maSlope = math.abs(maShort - maShort[3]) / maShort * 100
isFlat  = flatSlope ? maSlope < 0.1 : true
bool morningCheck = not na(time(timeframe.period, "0930-0932", "America/New_York"))
bool endOfDay     = not na(time(timeframe.period, "1600-1605", "America/New_York"))
if morningCheck
    bool newNarrow = spreadPct < maxSpreadPct and isFlat
    isNarrow := newNarrow
else if endOfDay
    isNarrow := false
bullBias200 = maShort > maLong
bearBias200 = maShort < maLong
slope = maShort - maShort[slopeLookback]
slopeDirection = slope > 0 ? "Up" : slope < 0 ? "Down" : "Neutral"

var float structureTop = high
var float structureBot = low
structureTop := math.max(structureTop, high)
structureBot := math.min(structureBot, low)
smc_rangeMid  = math.avg(structureTop, structureBot)

h23 = ta.highest(high, lb23h)
l23 = ta.lowest(low, lb23h)
rng23 = h23 - l23
mid23 = l23 + rng23 * 0.50
h4 = ta.highest(high, lb4h)
l4 = ta.lowest(low, lb4h)
mid4 = math.avg(h4, l4)
pct23 = (rng23 == 0) ? 50.0 : ((close - l23) / rng23) * 100
pct4  = (h4 == l4)   ? 50.0 : ((close - l4) / (h4 - l4)) * 100
string bias23 = close > mid23 ? "Bull" : "Bear"
string bias4  = close > mid4  ? "Bull" : "Bear"
bool inBetween = false
if neutralMode == "23h vs 4h"
    inBetween := (close > mid23 and close < mid4) or (close < mid23 and close > mid4)
else
    inBetween := (close > mid23 and close < smc_rangeMid) or (close < mid23 and close > smc_rangeMid)
if inBetween
    bias23 := "Neutral"
    bias4  := "Neutral"

bool isSlopeUp   = slopeDirection == "Up"
bool isSlopeDown = slopeDirection == "Down"
bool isBiasBull  = maShort > maLong
bool isBiasBear  = maShort < maLong
bool is23hBull   = bias23 == "Bull"
bool is23hBear   = bias23 == "Bear"
bool is4hBull    = bias4 == "Bull"
bool is4hBear    = bias4 == "Bear"
bool isLocBelow  = close < maShort
bool isLocAbove  = close > maShort

// Filters
passSlopeBull_S   = filterSlope_S ? isSlopeUp : true
passSlopeBear_S   = filterSlope_S ? isSlopeDown : true
passBias200Bull_S = filterBias20200_S ? isBiasBull : true
passBias200Bear_S = filterBias20200_S ? isBiasBear : true
passBias23hBull_S = filterBias23h_S ? is23hBull : true
passBias23hBear_S = filterBias23h_S ? is23hBear : true
passBias4hBull_S  = filterBias4h_S ? is4hBull : true
passBias4hBear_S  = filterBias4h_S ? is4hBear : true
passLoc20Bull_S   = filterLocation20_S ? isLocBelow : true
passLoc20Bear_S   = filterLocation20_S ? isLocAbove : true

passSlopeBull_Q   = filterSlope_Q ? isSlopeUp : (not isSlopeDown)
passSlopeBear_Q   = filterSlope_Q ? isSlopeDown : (not isSlopeUp)
passBias200Bull_Q = filterBias20200_Q ? isBiasBull : true
passBias200Bear_Q = filterBias20200_Q ? isBiasBear : true
passBias23hBull_Q = filterBias23h_Q ? is23hBull : true
passBias23hBear_Q = filterBias23h_Q ? is23hBear : true
passBias4hBull_Q  = filterBias4h_Q ? is4hBull : true
passBias4hBear_Q  = filterBias4h_Q ? is4hBear : true
passLoc20Bull_Q   = filterLocation20_Q ? isLocBelow : true
passLoc20Bear_Q   = filterLocation20_Q ? isLocAbove : true

// Q-Trend Trigger
h_t = ta.highest(src_qt, p_t)
l_t = ta.lowest(src_qt, p_t)
d_t = h_t - l_t
m_t = (h_t + l_t) / 2
m_t := bar_index > p_t ? m_t[1] : m_t
atr_t = ta.atr(atr_p_t)[1]
epsilon_t = mult_t * atr_t
change_up_t   = (mode_t == "Type B" ? ta.cross(src_qt, m_t + epsilon_t) : ta.crossover(src_qt, m_t + epsilon_t)) or src_qt > m_t + epsilon_t
change_down_t = (mode_t == "Type B" ? ta.cross(src_qt, m_t - epsilon_t) : ta.crossunder(src_qt, m_t - epsilon_t)) or src_qt < m_t - epsilon_t
m_t := (change_up_t or change_down_t) and m_t != m_t[1] ? m_t : change_up_t ? m_t + epsilon_t : change_down_t ? m_t - epsilon_t : nz(m_t[1], m_t)
var string ls_t = ""
ls_t := change_up_t ? "B" : change_down_t ? "S" : ls_t[1]
col_t = ls_t == "B" ? color.blue : color.red
plot(show_tl_t ? m_t : na, "Trigger Trend Line", col_t, 3)

sb_t = open < l_t + d_t / 8 and open >= l_t
ss_t = open > h_t - d_t / 8 and open <= h_t
strong_buy_t  = sb_t or sb_t[1] or sb_t[2] or sb_t[3] or sb_t[4]
strong_sell_t = ss_t or ss_t[1] or ss_t[2] or ss_t[3] or ss_t[4]

q_valid_buy = change_up_t and ls_t[1] != "B" and passSlopeBull_Q and (filterQTrend ? (passBias200Bull_Q and passBias23hBull_Q and passBias4hBull_Q and passLoc20Bull_Q) : true)
q_valid_sell = change_down_t and ls_t[1] != "S" and passSlopeBear_Q and (filterQTrend ? (passBias200Bear_Q and passBias23hBear_Q and passBias4hBear_Q and passLoc20Bear_Q) : true)

plotshape(q_valid_buy and not strong_buy_t, "Buy", shape.labelup, location.belowbar, color.blue, size=size.small, text="BUY", textcolor=color.white)
plotshape(q_valid_sell and not strong_sell_t, "Sell", shape.labeldown, location.abovebar, color.red, size=size.small, text="SELL", textcolor=color.white)
plotshape(q_valid_buy and strong_buy_t, "Strong Buy", shape.labelup, location.belowbar, color.blue, size=size.small, text="STRONG", textcolor=color.white)
plotshape(q_valid_sell and strong_sell_t, "Strong Sell", shape.labeldown, location.abovebar, color.red, size=size.small, text="STRONG", textcolor=color.white)

// Q-Trend Visual
src_vis = useTriggerForVis ? src_qt : src_qv
p_vis   = useTriggerForVis ? p_t : p_v
atr_p_vis = useTriggerForVis ? atr_p_t : atr_p_v
mult_vis = useTriggerForVis ? mult_t : mult_v
mode_vis = useTriggerForVis ? mode_t : mode_v
h_v = ta.highest(src_vis, p_vis)
l_v = ta.lowest(src_vis, p_vis)
m_v = (h_v + l_v) / 2
m_v := bar_index > p_vis ? m_v[1] : m_v
atr_v = ta.atr(atr_p_vis)[1]
epsilon_v = mult_vis * atr_v
change_up_v   = (mode_vis == "Type B" ? ta.cross(src_vis, m_v + epsilon_v) : ta.crossover(src_vis, m_v + epsilon_v)) or src_vis > m_v + epsilon_v
change_down_v = (mode_vis == "Type B" ? ta.cross(src_vis, m_v - epsilon_v) : ta.crossunder(src_vis, m_v - epsilon_v)) or src_vis < m_v - epsilon_v
m_v := (change_up_v or change_down_v) and m_v != m_v[1] ? m_v : change_up_v ? m_v + epsilon_v : change_down_v ? m_v - epsilon_v : nz(m_v[1], m_v)
var string ls_v = ""
ls_v := change_up_v ? "B" : change_down_v ? "S" : ls_v[1]
col_v = ls_v == "B" ? color.blue : color.red
plot(show_tl_v ? m_v : na, "Visual Trend Line", col_v, 3)
barcolor(color_bars ? col_t : na)

// SMC Structure
bool isNewHigh = high[structureLen] > ta.highest(high, structureLen)
bool isNewLow  = low[structureLen]  < ta.lowest(low, structureLen)
int currentLeg = 0
if isNewHigh
    currentLeg := -1 
else if isNewLow
    currentLeg := 1  
var int lastLeg = 0
bool legChanged = (currentLeg != 0) and (currentLeg != lastLeg)
if legChanged
    lastLeg := currentLeg
    if currentLeg == 1
        structureBot := low[structureLen]
    else
        structureTop := high[structureLen]
rangeHigh = structureTop
rangeLow  = structureBot
rangeMid  = math.avg(rangeHigh, rangeLow)
rangePosPct = rangeHigh != rangeLow ? ((close - rangeLow) / (rangeHigh - rangeLow)) * 100 : 50

// SMC-Q-Trend
var float m_smc = 0.0
if bar_index == 0
    m_smc := rangeMid
if legChanged
    m_smc := rangeMid
atr_smc = ta.atr(atr_p_t)[1]
epsilon_smc = mult_t * atr_smc
change_up_smc   = (mode_t == "Type B" ? ta.cross(src_qt, m_smc + epsilon_smc) : ta.crossover(src_qt, m_smc + epsilon_smc)) or src_qt > m_smc + epsilon_smc
change_down_smc = (mode_t == "Type B" ? ta.cross(src_qt, m_smc - epsilon_smc) : ta.crossunder(src_qt, m_smc - epsilon_smc)) or src_qt < m_smc - epsilon_smc
if not legChanged
    m_smc := (change_up_smc or change_down_smc) and m_smc != m_smc[1] ? m_smc : change_up_smc ? m_smc + epsilon_smc : change_down_smc ? m_smc - epsilon_smc : nz(m_smc[1], m_smc)
plot(show_smc_q ? m_smc : na, "SMC-Q Trend", color.purple, 2)
if show_smc_q and change_up_smc and not change_up_smc[1]
    label.new(bar_index, low, "SMC-B", color=color.purple, textcolor=color.white, style=label.style_label_up, size=size.tiny)
if show_smc_q and change_down_smc and not change_down_smc[1]
    label.new(bar_index, high, "SMC-S", color=color.purple, textcolor=color.white, style=label.style_label_down, size=size.tiny)

// Surge Bar (MTF)
[o_htf, h_htf, l_htf, c_htf, v_htf] = request.security(syminfo.tickerid, htfSurge, [open, high, low, close, volume], lookahead=barmerge.lookahead_on)
body_htf       = math.abs(c_htf - o_htf)
avgBody_val_htf = request.security(syminfo.tickerid, htfSurge, ta.sma(math.abs(close-open), 20))
isSurge_htf    = body_htf > (avgBody_val_htf * surgeMult)
upperWick_htf  = h_htf - math.max(o_htf, c_htf)
lowerWick_htf  = math.min(o_htf, c_htf) - l_htf
strongBullSurge = c_htf > o_htf and isSurge_htf and upperWick_htf < body_htf * 0.4 and lowerWick_htf < body_htf * 0.5
strongBearSurge = c_htf < o_htf and isSurge_htf and lowerWick_htf < body_htf * 0.4 and upperWick_htf < body_htf * 0.5
volSma_val_htf = request.security(syminfo.tickerid, htfSurge, ta.sma(volume, 5))
volSurge_htf   = v_htf > volSma_val_htf * volMult
isBullSignal = strongBullSurge and volSurge_htf
isBearSignal = strongBearSurge and volSurge_htf
validBullSurge = isBullSignal and passSlopeBull_S and passBias200Bull_S and passBias23hBull_S and passBias4hBull_S and passLoc20Bull_S
validBearSurge = isBearSignal and passSlopeBear_S and passBias200Bear_S and passBias23hBear_S and passBias4hBear_S and passLoc20Bear_S
if filterCounter_S
    if validBullSurge and close < m_t
        validBullSurge := false
    if validBearSurge and close > m_t
        validBearSurge := false
if validBullSurge
    label.new(bar_index, low, "Surge", color=color.new(color.blue, 50), textcolor=color.white, style=label.style_label_up, size=size.tiny)
if validBearSurge
    label.new(bar_index, high, "Surge", color=color.new(color.red, 50), textcolor=color.white, style=label.style_label_down, size=size.tiny)

// Keltner (MTF)
ema_center_val  = htfKeltner == "" ? ta.ema(close, kc_length) : request.security(syminfo.tickerid, htfKeltner, ta.ema(close, kc_length))
k_atr_val       = htfKeltner == "" ? ta.atr(kc_length)        : request.security(syminfo.tickerid, htfKeltner, ta.atr(kc_length))
upper_inner = ema_center_val + kc_mult_inner * k_atr_val
upper_outer = ema_center_val + kc_mult_outer * k_atr_val
lower_inner = ema_center_val - kc_mult_inner * k_atr_val
lower_outer = ema_center_val - kc_mult_outer * k_atr_val
bb_basis_val = htfKeltner == "" ? ta.sma(close, bb_length) : request.security(syminfo.tickerid, htfKeltner, ta.sma(close, bb_length))
bb_stdev_val = htfKeltner == "" ? ta.stdev(close, bb_length) : request.security(syminfo.tickerid, htfKeltner, ta.stdev(close, bb_length))
bb_upper = bb_basis_val + bb_mult * bb_stdev_val
bb_lower = bb_basis_val - bb_mult * bb_stdev_val
in_squeeze = (bb_upper - bb_lower) < (upper_inner - lower_inner)
breakout_up   = in_squeeze[1] and close > upper_inner and close[1] <= upper_inner
breakout_down = in_squeeze[1] and close < lower_inner and close[1] >= lower_inner

// Global Plots
plot(show_keltner_bands ? ema_center_val : na, "Keltner Mid", color.orange, 2)
p_u_in = plot(show_keltner_bands ? upper_inner : na, "U In", color.new(color.red, 30))
p_u_out = plot(show_keltner_bands ? upper_outer : na, "U Out", color.new(color.red, 30), style=plot.style_circles)
p_l_in = plot(show_keltner_bands ? lower_inner : na, "L In", color.new(color.blue, 30))
p_l_out = plot(show_keltner_bands ? lower_outer : na, "L Out", color.new(color.blue, 30), style=plot.style_circles)
fill(p_u_in, p_u_out, show_keltner_bands ? color.new(color.red, 90) : na, "Short Zone")
fill(p_l_in, p_l_out, show_keltner_bands ? color.new(color.blue, 90) : na, "Long Zone")
plotshape(show_squeeze_signals and breakout_up, "SQZ UP", shape.triangleup, location.belowbar, color.lime, size=size.small, text="SQZ UP", textcolor=color.white)
plotshape(show_squeeze_signals and breakout_down, "SQZ DOWN", shape.triangledown, location.abovebar, color.red, size=size.small, text="SQZ DOWN", textcolor=color.white)

// Trade Mgmt
var line[] slLines = array.new_line()
var line[] tpLines = array.new_line()
var label[] slLabels = array.new_label()
var label[] tpLabels = array.new_label()
var float[] slPrices = array.new_float()
var float[] tpPrices1 = array.new_float()
var float[] tpPrices2 = array.new_float()
var float[] tpPrices3 = array.new_float()
var string[] tradeDirs = array.new_string()
var int[]    tradeBarIdx = array.new_int()

bool bullTrigger = triggerSource == "Surge Bar" ? validBullSurge : q_valid_buy
bool bearTrigger = triggerSource == "Surge Bar" ? validBearSurge : q_valid_sell

// ADDED: Define atrVal using the atrPeriod defined in settings
atrVal = ta.atr(atrPeriod)

wipeLines() =>
    if array.size(slLines) > 0
        for i = 0 to array.size(slLines) - 1
            line.delete(array.get(slLines, i))
            line.delete(array.get(tpLines, i*3))
            line.delete(array.get(tpLines, i*3+1))
            line.delete(array.get(tpLines, i*3+2))
            label.delete(array.get(slLabels, i))
            label.delete(array.get(tpLabels, i*3))
            label.delete(array.get(tpLabels, i*3+1))
            label.delete(array.get(tpLabels, i*3+2))
    array.clear(slLines)
    array.clear(tpLines)
    array.clear(slLabels)
    array.clear(tpLabels)
    array.clear(slPrices)
    array.clear(tpPrices1)
    array.clear(tpPrices2)
    array.clear(tpPrices3)
    array.clear(tradeDirs)
    array.clear(tradeBarIdx)

if (array.size(tradeDirs) > 0)
    string currentDir = array.get(tradeDirs, 0)
    if (currentDir == "Bull" and bearTrigger)
        wipeLines()
    if (currentDir == "Bear" and bullTrigger)
        wipeLines()

if bullTrigger and ls_t == "B" and showSL
    float stop = na
    if triggerSource == "Surge Bar"
        stop := slSource == "Pivot High/Low" ? lastPivotLow : (slSource == "Previous Candle" ? low[1] : low)
    else
        stop := slSource == "Pivot High/Low" ? lastPivotLow : (slSource == "Previous Candle" ? low[1] : low)
    if na(stop)
        stop := low
    float tp1 = close + atrVal * tp1Mult
    float tp2 = close + atrVal * tp2Mult
    float tp3 = close + atrVal * tp3Mult
    array.push(slLines, line.new(bar_index, stop, bar_index+10, stop, color=slColorBull, style=line.style_dashed))
    array.push(slLabels, label.new(bar_index+10, stop, "SL", color=slColorBull, textcolor=color.white, style=label.style_label_left, size=size.tiny))
    array.push(tpLines, line.new(bar_index, tp1, bar_index+10, tp1, color=tpColorBull))
    array.push(tpLabels, label.new(bar_index+10, tp1, "TP1", color=tpColorBull, textcolor=color.white, style=label.style_label_left, size=size.tiny))
    array.push(tpLines, line.new(bar_index, tp2, bar_index+10, tp2, color=tpColorBull))
    array.push(tpLabels, label.new(bar_index+10, tp2, "TP2", color=tpColorBull, textcolor=color.white, style=label.style_label_left, size=size.tiny))
    array.push(tpLines, line.new(bar_index, tp3, bar_index+10, tp3, color=tpColorBull))
    array.push(tpLabels, label.new(bar_index+10, tp3, "TP3", color=tpColorBull, textcolor=color.white, style=label.style_label_left, size=size.tiny))
    array.push(slPrices, stop)
    array.push(tpPrices1, tp1)
    array.push(tpPrices2, tp2)
    array.push(tpPrices3, tp3)
    array.push(tradeDirs, "Bull")
    array.push(tradeBarIdx, bar_index)

if bearTrigger and ls_t == "S" and showSL
    float stop = na
    if triggerSource == "Surge Bar"
        stop := slSource == "Pivot High/Low" ? lastPivotHigh : (slSource == "Previous Candle" ? high[1] : high)
    else
        stop := slSource == "Pivot High/Low" ? lastPivotHigh : (slSource == "Previous Candle" ? high[1] : high)
    if na(stop)
        stop := high
    float tp1 = close - atrVal * tp1Mult
    float tp2 = close - atrVal * tp2Mult
    float tp3 = close - atrVal * tp3Mult
    array.push(slLines, line.new(bar_index, stop, bar_index+10, stop, color=slColorBear, style=line.style_dashed))
    array.push(slLabels, label.new(bar_index+10, stop, "SL", color=slColorBear, textcolor=color.white, style=label.style_label_left, size=size.tiny))
    array.push(tpLines, line.new(bar_index, tp1, bar_index+10, tp1, color=tpColorBear))
    array.push(tpLabels, label.new(bar_index+10, tp1, "TP1", color=tpColorBear, textcolor=color.white, style=label.style_label_left, size=size.tiny))
    array.push(tpLines, line.new(bar_index, tp2, bar_index+10, tp2, color=tpColorBear))
    array.push(tpLabels, label.new(bar_index+10, tp2, "TP2", color=tpColorBear, textcolor=color.white, style=label.style_label_left, size=size.tiny))
    array.push(tpLines, line.new(bar_index, tp3, bar_index+10, tp3, color=tpColorBear))
    array.push(tpLabels, label.new(bar_index+10, tp3, "TP3", color=tpColorBear, textcolor=color.white, style=label.style_label_left, size=size.tiny))
    array.push(slPrices, stop)
    array.push(tpPrices1, tp1)
    array.push(tpPrices2, tp2)
    array.push(tpPrices3, tp3)
    array.push(tradeDirs, "Bear")
    array.push(tradeBarIdx, bar_index)

if array.size(slLines) > 0
    for i = 0 to array.size(slLines) - 1
        line.set_x2(array.get(slLines, i), bar_index + 10)
        label.set_x(array.get(slLabels, i), bar_index + 10)
        if not na(array.get(tpPrices1, i))
            line.set_x2(array.get(tpLines, i*3), bar_index + 10)
            label.set_x(array.get(tpLabels, i*3), bar_index + 10)
        if not na(array.get(tpPrices2, i))
            line.set_x2(array.get(tpLines, i*3+1), bar_index + 10)
            label.set_x(array.get(tpLabels, i*3+1), bar_index + 10)
        if not na(array.get(tpPrices3, i))
            line.set_x2(array.get(tpLines, i*3+2), bar_index + 10)
            label.set_x(array.get(tpLabels, i*3+2), bar_index + 10)

if array.size(slLines) > 0
    for i = array.size(slLines) - 1 to 0
        int entryIdx = array.get(tradeBarIdx, i)
        if bar_index > entryIdx
            string dir = array.get(tradeDirs, i)
            float sl   = array.get(slPrices, i)
            bool slHit = false
            if dir == "Bull" and low <= sl
                slHit := true
            if dir == "Bear" and high >= sl
                slHit := true
            if slHit
                line.delete(array.get(slLines, i))
                line.delete(array.get(tpLines, i*3))
                line.delete(array.get(tpLines, i*3+1))
                line.delete(array.get(tpLines, i*3+2))
                label.delete(array.get(slLabels, i))
                label.delete(array.get(tpLabels, i*3))
                label.delete(array.get(tpLabels, i*3+1))
                label.delete(array.get(tpLabels, i*3+2))
                array.remove(slLines, i)
                array.remove(tpLines, i*3+2)
                array.remove(tpLines, i*3+1)
                array.remove(tpLines, i*3)
                array.remove(slLabels, i)
                array.remove(tpLabels, i*3+2)
                array.remove(tpLabels, i*3+1)
                array.remove(tpLabels, i*3)
                array.remove(slPrices, i)
                array.remove(tpPrices1, i)
                array.remove(tpPrices2, i)
                array.remove(tpPrices3, i)
                array.remove(tradeDirs, i)
                array.remove(tradeBarIdx, i)
            else
                float tp1 = array.get(tpPrices1, i)
                float tp2 = array.get(tpPrices2, i)
                float tp3 = array.get(tpPrices3, i)
                if not na(tp1)
                    bool hit1 = (dir == "Bull" and high >= tp1) or (dir == "Bear" and low <= tp1)
                    if hit1
                        line.delete(array.get(tpLines, i*3))
                        label.delete(array.get(tpLabels, i*3))
                        array.set(tpPrices1, i, na)
                if not na(tp2)
                    bool hit2 = (dir == "Bull" and high >= tp2) or (dir == "Bear" and low <= tp2)
                    if hit2
                        line.delete(array.get(tpLines, i*3+1))
                        label.delete(array.get(tpLabels, i*3+1))
                        array.set(tpPrices2, i, na)
                if not na(tp3)
                    bool hit3 = (dir == "Bull" and high >= tp3) or (dir == "Bear" and low <= tp3)
                    if hit3
                        line.delete(array.get(tpLines, i*3+2))
                        label.delete(array.get(tpLabels, i*3+2))
                        array.set(tpPrices3, i, na)

if showDebugTable and barstate.islast
    pos = switch tablePosition
        "top_right"     => position.top_right
        "top_left"      => position.top_left
        "bottom_right"  => position.bottom_right
        "bottom_left"   => position.bottom_left
        => position.top_right
    int rows = 1 
    if showRowPrice20
        rows := rows + 1
    if showRowSlope
        rows := rows + 1
    if showRowBias
        rows := rows + 1
    if showRowSMC_Pct
        rows := rows + 1
    if showRowSMC_Lvls
        rows := rows + 3
    if showRowHTF_4h_Bias
        rows := rows + 1
    if showRowHTF_4h_Range
        rows := rows + 1
    if showRowHTF_4h_Mid
        rows := rows + 1
    if showRowHTF_23h_Bias
        rows := rows + 1
    if showRowHTF_23h_Range
        rows := rows + 1
    if showRowHTF_23h_Mid
        rows := rows + 1
    if showRowWeekly
        rows := rows + 2
    if showRowNarrow
        rows := rows + 1
    if showRowTrades
        rows := rows + 1
    var table debugTable = table.new(pos, 2, rows, bgcolor=color.new(tableBgColor, tableBgOpacity), border_width=1)
    int currentRow = 0
    table.cell(debugTable, 0, currentRow, "Directional Bias", text_color=color.white, bgcolor=color.new(tableBgColor, 0))
    table.cell(debugTable, 1, currentRow, "", bgcolor=color.new(tableBgColor, 0))
    color cBull = color.blue 
    color cBear = color.red
    color cNeu  = color.white
    color cGray = color.gray
    if showRowPrice20
        currentRow := currentRow + 1
        string locText = close < maShort ? "Below 20" : "Above 20"
        color locCol   = close < maShort ? cBull : cBear
        locCol := close > maShort ? cBull : cBear
        table.cell(debugTable, 0, currentRow, "Price vs 20", text_color=color.white)
        table.cell(debugTable, 1, currentRow, locText, text_color=locCol)
    if showRowSlope
        currentRow := currentRow + 1
        table.cell(debugTable, 0, currentRow, "Slope", text_color=color.white)
        table.cell(debugTable, 1, currentRow, slopeDirection, text_color=slopeDirection == "Up" ? cBull : slopeDirection == "Down" ? cBear : cGray)
    if showRowBias
        currentRow := currentRow + 1
        table.cell(debugTable, 0, currentRow, "Bias 20/200", text_color=color.white)
        table.cell(debugTable, 1, currentRow, bullBias200 ? "Bull" : bearBias200 ? "Bear" : "None", text_color=bullBias200 ? cBull : bearBias200 ? cBear : cGray)
    if showRowSMC_Pct
        currentRow := currentRow + 1
        string biasText = rangePosPct > 50 ? " (Bull)" : rangePosPct < 50 ? " (Bear)" : ""
        string smcStr   = str.tostring(math.round(rangePosPct)) + "%" + biasText
        color smcCol    = rangePosPct > 50 ? color.blue : color.red
        table.cell(debugTable, 0, currentRow, "SMC %", text_color=color.white)
        table.cell(debugTable, 1, currentRow, smcStr, text_color=smcCol)
    if showRowSMC_Lvls
        currentRow := currentRow + 1
        table.cell(debugTable, 0, currentRow, "Premium", text_color=color.white)
        table.cell(debugTable, 1, currentRow, str.tostring(rangeHigh, format.mintick), text_color=color.orange)
        currentRow := currentRow + 1
        table.cell(debugTable, 0, currentRow, "Equilibrium", text_color=color.white)
        table.cell(debugTable, 1, currentRow, str.tostring(rangeMid, format.mintick), text_color=color.yellow)
        currentRow := currentRow + 1
        table.cell(debugTable, 0, currentRow, "Discount", text_color=color.white)
        table.cell(debugTable, 1, currentRow, str.tostring(rangeLow, format.mintick), text_color=color.orange)
    if showRowHTF_4h_Bias
        currentRow := currentRow + 1
        table.cell(debugTable, 0, currentRow, "4H Bias", text_color=color.white)
        string txt4 = bias4 + " (" + str.tostring(pct4, "#") + "%)"
        color col4  = bias4 == "Bull" ? cBull : bias4 == "Bear" ? cBear : cNeu
        color bg4   = useCellColors ? (pct4 > 50 ? color.new(color.blue, 70) : color.new(color.red, 70)) : color.new(tableBgColor, 100)
        table.cell(debugTable, 1, currentRow, txt4, text_color=col4, bgcolor=bg4)
    if showRowHTF_4h_Range
        currentRow := currentRow + 1
        string h4s = str.tostring(h4, format.mintick)
        string l4s = str.tostring(l4, format.mintick)
        table.cell(debugTable, 0, currentRow, "4H Range", text_color=color.gray)
        table.cell(debugTable, 1, currentRow, "H: " + h4s + " / L: " + l4s, text_color=color.gray, text_size=size.small)
    if showRowHTF_4h_Mid
        currentRow := currentRow + 1
        string m4s = str.tostring(mid4, format.mintick)
        table.cell(debugTable, 0, currentRow, "4H Mid", text_color=color.fuchsia)
        table.cell(debugTable, 1, currentRow, m4s, text_color=color.fuchsia)
    if showRowHTF_23h_Bias
        currentRow := currentRow + 1
        table.cell(debugTable, 0, currentRow, "23H Bias", text_color=color.white)
        string txt23 = bias23 + " (" + str.tostring(pct23, "#") + "%)"
        color col23  = bias23 == "Bull" ? cBull : bias23 == "Bear" ? cBear : cNeu
        color bg23   = useCellColors ? (pct23 > 50 ? color.new(color.blue, 70) : color.new(color.red, 70)) : color.new(tableBgColor, 100)
        table.cell(debugTable, 1, currentRow, txt23, text_color=col23, bgcolor=bg23)
    if showRowHTF_23h_Range
        currentRow := currentRow + 1
        string h23s = str.tostring(h23, format.mintick)
        string l23s = str.tostring(l23, format.mintick)
        table.cell(debugTable, 0, currentRow, "23H Range", text_color=color.gray)
        table.cell(debugTable, 1, currentRow, "H: " + h23s + " / L: " + l23s, text_color=color.gray, text_size=size.small)
    if showRowHTF_23h_Mid
        currentRow := currentRow + 1
        string m23s = str.tostring(mid23, format.mintick)
        table.cell(debugTable, 0, currentRow, "23H Mid", text_color=color.orange)
        table.cell(debugTable, 1, currentRow, m23s, text_color=color.orange)
    if showRowWeekly
        currentRow := currentRow + 1
        table.cell(debugTable, 0, currentRow, "Weekly", text_color=color.white)
        color wCol = wPosPct > 50 ? cBull : cBear
        table.cell(debugTable, 1, currentRow, str.tostring(wPosPct, "#") + "%", text_color=wCol)
        currentRow := currentRow + 1
        table.cell(debugTable, 0, currentRow, "Prev Week", text_color=color.white)
        table.cell(debugTable, 1, currentRow, pwStatus, text_color=pwColor)
    if showRowNarrow
        currentRow := currentRow + 1
        table.cell(debugTable, 0, currentRow, "Narrow?", text_color=color.white)
        table.cell(debugTable, 1, currentRow, isNarrow ? "Yes" : "No", text_color=isNarrow ? cBull : cGray)
    if showRowTrades
        currentRow := currentRow + 1
        table.cell(debugTable, 0, currentRow, "Active Trades", text_color=color.white)
        table.cell(debugTable, 1, currentRow, str.tostring(array.size(slLines)), text_color=color.white)
