//@version=5
indicator("Liquidity Magnet Zones [identityKa]", overlay=true, max_lines_count=100, max_labels_count=100)

// ==========================================
// 1. KULLANICI AYARLARI
// ==========================================
grp1 = "âš™ï¸ Likidite AlgoritmasÄ±"
pivot_len = input.int(15, title="Pivot Hassasiyeti (Uzunluk)", minval=5, maxval=50, group=grp1)
max_zones = input.int(3, title="Maksimum Aktif MÄ±knatÄ±s (YÃ¶n BaÅŸÄ±na)", minval=1, maxval=10, group=grp1, tooltip="Grafik kirliliÄŸini Ã¶nlemek iÃ§in sadece en taze X bÃ¶lgeyi tutar.")
show_labels = input.bool(true, title="BSL / SSL Etiketlerini GÃ¶ster", group=grp1)

grp2 = "ğŸ¨ identityKa TemasÄ±"
color_bsl = input.color(color.new(#00ffbb, 30), title="BSL (AlÄ±ÅŸ Likiditesi)", group=grp2)
color_ssl = input.color(color.new(#ff1744, 30), title="SSL (SatÄ±ÅŸ Likiditesi)", group=grp2)

// ==========================================
// 2. TESPÄ°T (PÄ°VOTLAR)
// ==========================================
ph = ta.pivothigh(high, pivot_len, pivot_len)
pl = ta.pivotlow(low, pivot_len, pivot_len)

var bsl_lines = array.new_line()
var bsl_labels = array.new_label()
var ssl_lines = array.new_line()
var ssl_labels = array.new_label()

// ==========================================
// 3. YENÄ° LÄ°KÄ°DÄ°TE OLUÅTURMA VE LÄ°MÄ°TLEME
// ==========================================
// Yeni BSL (Buy Side Liquidity)
if not na(ph)
    l = line.new(bar_index[pivot_len], ph, bar_index, ph, color=color_bsl, style=line.style_dashed, width=1)
    array.push(bsl_lines, l)
    if show_labels
        lb = label.new(bar_index, ph, "BSL", color=color.new(color.white, 100), textcolor=color_bsl, style=label.style_label_down, size=size.tiny)
        array.push(bsl_labels, lb)
    
    // SÄ±nÄ±r KontrolÃ¼ (Limit aÅŸÄ±ldÄ±ysa en eski Ã§izgiyi SÄ°L)
    if array.size(bsl_lines) > max_zones
        line.delete(array.shift(bsl_lines))
        if show_labels
            label.delete(array.shift(bsl_labels))

// Yeni SSL (Sell Side Liquidity)
if not na(pl)
    l = line.new(bar_index[pivot_len], pl, bar_index, pl, color=color_ssl, style=line.style_dashed, width=1)
    array.push(ssl_lines, l)
    if show_labels
        lb = label.new(bar_index, pl, "SSL", color=color.new(color.white, 100), textcolor=color_ssl, style=label.style_label_up, size=size.tiny)
        array.push(ssl_labels, lb)
        
    // SÄ±nÄ±r KontrolÃ¼ (Limit aÅŸÄ±ldÄ±ysa en eski Ã§izgiyi SÄ°L)
    if array.size(ssl_lines) > max_zones
        line.delete(array.shift(ssl_lines))
        if show_labels
            label.delete(array.shift(ssl_labels))

// ==========================================
// 4. LÄ°KÄ°DÄ°TE ALIMI (SWEEP) VE UZATMA
// ==========================================
// BSL KontrolÃ¼
if array.size(bsl_lines) > 0
    for i = array.size(bsl_lines) - 1 to 0
        l = array.get(bsl_lines, i)
        lbl = show_labels ? array.get(bsl_labels, i) : na
        line_y = line.get_y1(l)
        
        // Fiyat likiditeyi aldÄ±ysa SÄ°L
        if high >= line_y and bar_index > line.get_x1(l)
            line.delete(l)
            array.remove(bsl_lines, i)
            if show_labels
                label.delete(lbl)
                array.remove(bsl_labels, i)
        else
            // AlÄ±nmadÄ±ysa saÄŸa UZAT
            line.set_x2(l, bar_index + 3)
            if show_labels
                label.set_x(lbl, bar_index + 3)

// SSL KontrolÃ¼
if array.size(ssl_lines) > 0
    for i = array.size(ssl_lines) - 1 to 0
        l = array.get(ssl_lines, i)
        lbl = show_labels ? array.get(ssl_labels, i) : na
        line_y = line.get_y1(l)
        
        // Fiyat likiditeyi aldÄ±ysa SÄ°L
        if low <= line_y and bar_index > line.get_x1(l)
            line.delete(l)
            array.remove(ssl_lines, i)
            if show_labels
                label.delete(lbl)
                array.remove(ssl_labels, i)
        else
            // AlÄ±nmadÄ±ysa saÄŸa UZAT
            line.set_x2(l, bar_index + 3)
            if show_labels
                label.set_x(lbl, bar_index + 3)
