// This Pine Script™ code is subject to the terms of the
// Mozilla Public License 2.0
// https://mozilla.org/MPL/2.0/
// © NPR21

//@version=6
indicator("SMI Fractal Iron HMA",
     shorttitle="SMI Fractal Iron HMA",
     overlay=true, max_labels_count=500,
     max_lines_count=500)

// ══════════════════════════════════════
// SMI Fractal Iron HMA
// Created by: NPR21
// Version: 7.0
// Last Updated: February 22, 2026
//
// Fractal pivot detection with split
// Left/Right bars, SMI momentum filter,
// HMA Trend Duration Forecast, Risk
// Management (SL/TP/P&L), and Short
// Trend Dashboard.
//
// All Rights Reserved
// ══════════════════════════════════════

// ════════════════════
// HELPER FUNCTION
// ════════════════════
formatWithCommas(value, decimals) =>
    formatStr = decimals == 2 ? "#.00" :
         decimals == 1 ? "#.0" : "#"
    valueStr = str.tostring(value, formatStr)
    parts = str.split(valueStr, ".")
    intPart = array.get(parts, 0)
    decPart = array.size(parts) > 1 ?
         "." + array.get(parts, 1) : ""
    len = str.length(intPart)
    result = ""
    for i = 0 to len - 1
        char = str.substring(intPart, i, i + 1)
        result := result + char
        remaining = len - i - 1
        if remaining > 0 and remaining % 3 == 0
             and char != "-"
            result := result + ","
    result + decPart

// ═══════════════════════════════════
//          SMI SETTINGS
// ═══════════════════════════════════
grpSMI = "═══  SMI Settings  ═══"
smiscale       = input.float(100, "SMI Scale",
     minval=1, group=grpSMI)
percentDLength = input.int(3, "SMI %D Length",
     minval=1, group=grpSMI)
percentKLength = input.int(5, "SMI %K Length",
     minval=1, group=grpSMI)
smiLimit = input.int(30, "Chop Zone (±)",
     minval=1, group=grpSMI)
useSmiFilter = input.bool(false,
     "Filter Signals by SMI Trend",
     group=grpSMI,
     tooltip="Long labels only when SMI rising." +
     " Short only when SMI falling.")
showBarColor = input.bool(false,
     "Color Bars by SMI Momentum",
     group=grpSMI)

// ═══════════════════════════════════
//          PIVOT SETTINGS
// ═══════════════════════════════════
grpSIG = "═══  Pivot Settings  ═══"
pivotLeft = input.int(5, "Left Bars",
     minval=1, maxval=20, group=grpSIG,
     tooltip="Structural selectivity.")
pivotRight = input.int(1, "Right Bars",
     minval=0, maxval=20, group=grpSIG,
     tooltip="Confirmation delay. 0 = zero lag.")

// ═══════════════════════════════════
//          SIGNAL MODE
// ═══════════════════════════════════
grpMode = "═══  Signal Mode  ═══"
signalMode = input.string(
     "Confirmed + Preview", "Signal Mode",
     options=["Confirmed Only",
              "Confirmed + Preview",
              "Preview Only"],
     group=grpMode)

// ═══════════════════════════════════
//          SIGNAL FILTERS
// ═══════════════════════════════════
grpFilter = "═══  Signal Filters  ═══"
useAlternating = input.bool(true,
     "Alternating Mode",
     group=grpFilter)
cooldownBars = input.int(3, "Cooldown Bars",
     minval=0, maxval=50, group=grpFilter)
usePriceFilter = input.bool(false,
     "Require Min Price Move",
     group=grpFilter)
priceFilterATR = input.float(0.75,
     "Min Move (ATR x)",
     minval=0.1, step=0.1, group=grpFilter)
filterAtrLen = input.int(14, "ATR Length",
     minval=1, group=grpFilter)

// ═══════════════════════════════════
//       RISK MANAGEMENT
// ═══════════════════════════════════
grpRisk = "═══  Risk Management  ═══"
enableRisk = input.bool(false,
     "Enable Risk Management Overlay",
     group=grpRisk,
     tooltip="Shows SL/TP lines, P&L dashboard," +
     " and trade tracking.")
tradeDirection = input.string("Both",
     "Trade Direction",
     options=["Long", "Short", "Both"],
     group=grpRisk)
numContracts = input.int(1,
     "Number of Contracts",
     minval=1, maxval=100, group=grpRisk)
pointValue = input.float(2.0, "Point Value",
     minval=0.01, step=0.01, group=grpRisk,
     tooltip="MNQ=2, MES=5, MYM=0.5, " +
     "MGC=10, MCL=10")
currencySymbol = input.string("$",
     "Currency Symbol",
     options=["$","€","£","¥","₹","₿",""],
     group=grpRisk)
slMethod = input.string("Points", "SL Method",
     options=["Points", "Percentage"],
     group=grpRisk)
stopLossPoints = input.float(3.0,
     "Stop Loss (points)",
     minval=0.01, step=0.01, group=grpRisk)
stopLossPercent = input.float(0.5,
     "Stop Loss (%)",
     minval=0.01, step=0.01, group=grpRisk)
tp1Ratio = input.float(2.0,
     "TP1 Reward:Risk",
     minval=0.5, step=0.1, group=grpRisk)
tp2Ratio = input.float(3.0,
     "TP2 Reward:Risk",
     minval=0.5, step=0.1, group=grpRisk)
tp3Ratio = input.float(4.0,
     "TP3 Reward:Risk",
     minval=0.5, step=0.1, group=grpRisk)
enableTP2Trail = input.bool(true,
     "Enable TP2+ Reversal Exit",
     group=grpRisk)
tp2ReversalPts = input.float(2.0,
     "TP2+ Reversal Distance (pts)",
     minval=0.25, step=0.25, group=grpRisk)
enableTrailing = input.bool(false,
     "Enable Trailing Stop", group=grpRisk)
breakevenPoints = input.float(8.0,
     "Move to Breakeven at (pts)",
     minval=1.0, step=1.0, group=grpRisk)
trailStartPoints = input.float(10.0,
     "Start Trailing at (pts)",
     minval=1.0, step=1.0, group=grpRisk)
trailOffsetPoints = input.float(5.0,
     "Trail Offset (pts)",
     minval=1.0, step=1.0, group=grpRisk)
autoResetOnComplete = input.bool(true,
     "Auto-Reset When Trade Completes",
     group=grpRisk)

// ═══════════════════════════════════
//       RISK DISPLAY
// ═══════════════════════════════════
grpRiskDisp = "═══  Risk Display  ═══"
showRiskLabels = input.bool(true,
     "Show Price Labels", group=grpRiskDisp)
showRiskDash = input.bool(true,
     "Show P&L Dashboard", group=grpRiskDisp)
riskDashPos = input.string("Top Right",
     "Dashboard Position",
     options=["Top Left","Top Center",
     "Top Right","Middle Left",
     "Middle Center","Middle Right",
     "Bottom Left","Bottom Center",
     "Bottom Right"], group=grpRiskDisp)
riskDashSize = input.string("Normal",
     "Dashboard Size",
     options=["Tiny","Small","Normal",
     "Large","Huge"], group=grpRiskDisp)
riskLabelOffset = input.int(8,
     "Label Distance from Bar",
     minval=3, maxval=20, group=grpRiskDisp)
riskLineLen = input.int(15,
     "Level Line Length (bars)",
     minval=0, maxval=500, group=grpRiskDisp)
colorEntry = input.color(color.white,
     "Entry Line", group=grpRiskDisp)
colorSL = input.color(color.red,
     "Stop Loss Line", group=grpRiskDisp)
colorTP1 = input.color(color.green,
     "TP1 Line", group=grpRiskDisp)
colorTP2 = input.color(color.lime,
     "TP2 Line", group=grpRiskDisp)
colorTP3 = input.color(color.aqua,
     "TP3 Line", group=grpRiskDisp)

// ═══════════════════════════════════
//      HMA TREND OVERLAY
// ═══════════════════════════════════
grpHMA = "═══  HMA Trend Overlay  ═══"
hmaLength = input.int(20, "Smoothing Length",
     minval=1, maxval=200, group=grpHMA)
hmaTrendSens = input.int(3,
     "Trend Detection Sensitivity",
     minval=1, maxval=10, group=grpHMA)
hmaSamples = input.int(10,
     "Trend Sample Size",
     minval=2, maxval=50, group=grpHMA)
showHMA = input.bool(true, "Show HMA Line",
     group=grpHMA)
hmaDisplayMode = input.string(
     "HMA + Forecast", "HMA Display Mode",
     options=["HMA + Forecast", "HMA Only",
          "Forecast Only", "Off"],
     group=grpHMA)
showHistTrend = input.bool(true,
     "Show Historical Trend Labels",
     group=grpHMA)
showHmaBuySell = input.bool(true,
     "Show HMA BUY/SELL Labels",
     group=grpHMA)
showHmaBuySellPrice = input.bool(true,
     "Show Price on HMA Labels",
     group=grpHMA)
hmaBuySellStyle = input.string("Offset",
     "HMA Label Layout",
     options=["Offset", "On Bar"],
     group=grpHMA)
hmaBuySellLayout = input.string("Inline",
     "HMA Price Layout",
     options=["Inline", "Stack"],
     group=grpHMA)
hmaLabelSize = input.string("Normal",
     "BUY/SELL Label Size",
     options=["Tiny","Small","Normal",
     "Large","Huge"], group=grpHMA)
hmaForecastSize = input.string("Small",
     "Forecast Label Size",
     options=["Tiny","Small","Normal",
     "Large","Huge"], group=grpHMA)
colorHmaUp = input.color(
     color.rgb(18, 228, 158),
     "HMA Bullish", group=grpHMA)
colorHmaDn = input.color(
     color.rgb(236, 86, 16),
     "HMA Bearish", group=grpHMA)
hmaLineWidth = input.int(3, "HMA Line Width",
     minval=1, maxval=5, group=grpHMA)

// ═══════════════════════════════════
//     SHORT TREND DASHBOARD
// ═══════════════════════════════════
grpST = "═══  Short Trend Dashboard  ═══"
showSTDash = input.bool(true,
     "Show Short Trend Dashboard",
     group=grpST)
stDashPosition = input.string("Bottom Right",
     "Dashboard Position",
     options=["Top Left","Top Center",
     "Top Right","Middle Left",
     "Middle Center","Middle Right",
     "Bottom Left","Bottom Center",
     "Bottom Right"], group=grpST)
stDashSize = input.string("Normal",
     "Dashboard Text Size",
     options=["Tiny","Small","Normal",
     "Large","Huge"], group=grpST)
scalperMode = input.bool(true,
     "SCALPER MODE (Ultra-Fast)",
     group=grpST)
showInstantFlip = input.bool(true,
     "Show Instant Flip Detection",
     group=grpST)

// ═══════════════════════════════════
//     SHORT TREND SENSITIVITY
// ═══════════════════════════════════
grpSTSens = "═══  Short Trend Sensitivity  ═══"
stMomLen = input.int(5, "Momentum Length",
     minval=2, maxval=20, group=grpSTSens)
stMicroFast = input.int(3,
     "Micro Trend Fast EMA",
     minval=2, maxval=10, group=grpSTSens)
stMicroSlow = input.int(8,
     "Micro Trend Slow EMA",
     minval=5, maxval=20, group=grpSTSens)
stAtrMult = input.float(0.5,
     "ATR Sensitivity",
     minval=0.1, maxval=2.0, step=0.1,
     group=grpSTSens)

// ═══════════════════════════════════
//       SCALPER TUNING
// ═══════════════════════════════════
grpScalp = "═══  Scalper Tuning  ═══"
scalperMomLen = input.int(2,
     "Scalper Momentum Length",
     minval=1, maxval=10, group=grpScalp)
scalperFastEMA = input.int(2,
     "Scalper Fast EMA",
     minval=1, maxval=10, group=grpScalp)
scalperSlowEMA = input.int(5,
     "Scalper Slow EMA",
     minval=2, maxval=15, group=grpScalp)
scalperATRMult = input.float(0.25,
     "Scalper ATR Mult",
     minval=0.1, maxval=1.0, step=0.05,
     group=grpScalp)
instantFlipATR = input.float(0.5,
     "Instant Flip ATR Threshold",
     minval=0.1, maxval=2.0, step=0.1,
     group=grpScalp)

// ═══════════════════════════════════
//     SHORT TREND COLORS
// ═══════════════════════════════════
grpSTClr = "═══  Short Trend Colors  ═══"
stColLong = input.color(#00FF00,
     "LONG Color", group=grpSTClr)
stColShort = input.color(#FF0000,
     "SHORT Color", group=grpSTClr)
stColNeutral = input.color(#808080,
     "NEUTRAL Color", group=grpSTClr)
stColFlip = input.color(#FF00FF,
     "Instant Flip Color", group=grpSTClr)

// ═══════════════════════════════════
//        PIVOT LABELS
// ═══════════════════════════════════
grpLabels = "═══  Pivot Labels  ═══"
showLabels = input.bool(true,
     "Show Labels", group=grpLabels)
labelSizeStr = input.string("Normal", "Size",
     options=["Tiny","Small","Normal",
     "Large","Huge"], group=grpLabels)
pivotLblLayout = input.string("Stack",
     "Label Layout",
     options=["Stack", "Pointer"],
     group=grpLabels)
showTimestamp = input.bool(false,
     "Show Timestamp on Label",
     group=grpLabels)
timestampFmt = input.string("HH:mm",
     "Timestamp Format",
     options=["HH:mm", "HH:mm:ss",
              "h:mm a", "MMM dd HH:mm",
              "MMM dd"], group=grpLabels)
buyOffsetTicks = input.int(8,
     "Long Label Offset (ticks)",
     minval=0, group=grpLabels)
sellOffsetTicks = input.int(8,
     "Short Label Offset (ticks)",
     minval=0, group=grpLabels)
buyLabelBgColor = input.color(
     color.rgb(0, 50, 45),
     "Long Label Background", group=grpLabels)
buyTextColor = input.color(color.white,
     "Long Label Text", group=grpLabels)
sellLabelBgColor = input.color(
     color.rgb(120, 0, 0),
     "Short Label Background", group=grpLabels)
sellTextColor = input.color(color.yellow,
     "Short Label Text", group=grpLabels)

// ═══════════════════════════════════
//         BAR COLORS
// ═══════════════════════════════════
grpBAR = "═══  Bar Colors  ═══"
bullBarColor = input.color(
     color.rgb(0, 200, 0),
     "Bullish Bar Color", group=grpBAR)
bearBarColor = input.color(
     color.rgb(220, 30, 30),
     "Bearish Bar Color", group=grpBAR)
neutralBarColor = input.color(
     color.rgb(160, 160, 160),
     "Neutral/Chop Bar Color", group=grpBAR)

// ═══════════════════════════════════
//           ALERTS
// ═══════════════════════════════════
grpAlerts = "═══  Alerts  ═══"
audio = input.bool(true,
     "Enable Alerts", group=grpAlerts)

// ═══════════════════════════════════
//       SMI CALCULATION
// ═══════════════════════════════════
min_low  = ta.lowest(low, percentKLength)
max_high = ta.highest(high, percentKLength)
rel_diff = close - (max_high + min_low) / 2.0
diffx    = max_high - min_low
avgrel  = ta.ema(
     ta.ema(rel_diff, percentDLength),
     percentDLength)
avgdiff = ta.ema(
     ta.ema(diffx, percentDLength),
     percentDLength)
smi_raw = avgdiff != 0.0
     ? (avgrel / (avgdiff / 2.0)) * smiscale
     : 0.0
smi = ta.ema(smi_raw, 3)
smiRising  = smi > smi[1]
smiFalling = smi < smi[1]
smiInChop  = smi > -smiLimit and smi < smiLimit

// ═══════════════════════════════════
//            ATR
// ═══════════════════════════════════
atrVal = ta.atr(filterAtrLen)

// ═══════════════════════════════════
//   HMA TREND DURATION FORECAST
// ═══════════════════════════════════
bool showHmaLine = (hmaDisplayMode ==
     "HMA + Forecast" or
     hmaDisplayMode == "HMA Only") and showHMA
bool showTrendOverlay = (hmaDisplayMode ==
     "HMA + Forecast" or
     hmaDisplayMode == "Forecast Only")

series float hmaLine = ta.hma(close, hmaLength)
var float hmaTrendF = na
var int hmaTrendCount = 0
var bullishDurations = array.new<int>()
var bearishDurations = array.new<int>()
var TrendUP = label(na)
var TrendDN = label(na)
var LengthLine = line(na)
var LabelProbLen = label(na)
bool hmaTrendChanged = false
bool hmaIsRising = ta.rising(hmaLine,
     hmaTrendSens)
bool hmaIsFalling = ta.falling(hmaLine,
     hmaTrendSens)

getHmaLblSize() =>
    switch hmaLabelSize
        "Tiny"   => size.tiny
        "Small"  => size.small
        "Normal" => size.normal
        "Large"  => size.large
        "Huge"   => size.huge
        => size.normal

getHmaFcSize() =>
    switch hmaForecastSize
        "Tiny"   => size.tiny
        "Small"  => size.small
        "Normal" => size.normal
        "Large"  => size.large
        "Huge"   => size.huge
        => size.small

string _hmaLblSz = getHmaLblSize()
string _hmaFcSz = getHmaFcSize()
bool hmaStack = (hmaBuySellLayout == "Stack")

if barstate.isconfirmed
    if hmaIsRising
        hmaTrendF := 1.0
    if hmaIsFalling
        hmaTrendF := -1.0
if not na(hmaTrendF)
    hmaTrendCount += 1
if not na(hmaTrendF) and not na(hmaTrendF[1])
     and hmaTrendF != hmaTrendF[1]
    hmaTrendChanged := true
    if showHmaBuySell
        bool useOffset =
             (hmaBuySellStyle == "Offset")
        if hmaTrendF > 0
            string buyTxt =
                 showHmaBuySellPrice ?
                 (hmaStack ?
                      "HMA BUY\n" +
                      formatWithCommas(
                      close[1], 2) :
                      "HMA BUY  " +
                      formatWithCommas(
                      close[1], 2)) :
                 "HMA BUY"
            if useOffset
                label.new(bar_index - 1,
                     low[1], buyTxt,
                     style=label.style_label_upper_left,
                     color=colorHmaUp,
                     textcolor=color.rgb(0,0,0),
                     size=_hmaLblSz)
            else
                label.new(bar_index - 1,
                     low[1], buyTxt,
                     style=label.style_label_up,
                     color=colorHmaUp,
                     textcolor=color.rgb(0,0,0),
                     size=_hmaLblSz)
        else
            string sellTxt =
                 showHmaBuySellPrice ?
                 (hmaStack ?
                      "HMA SELL\n" +
                      formatWithCommas(
                      close[1], 2) :
                      "HMA SELL  " +
                      formatWithCommas(
                      close[1], 2)) :
                 "HMA SELL"
            if useOffset
                label.new(bar_index - 1,
                     high[1], sellTxt,
                     style=label.style_label_lower_right,
                     color=colorHmaDn,
                     textcolor=color.white,
                     size=_hmaLblSz)
            else
                label.new(bar_index - 1,
                     high[1], sellTxt,
                     style=label.style_label_down,
                     color=colorHmaDn,
                     textcolor=color.white,
                     size=_hmaLblSz)
    LengthLine.delete()
    LabelProbLen.delete()
    TrendUP.delete()
    TrendDN.delete()
    if hmaTrendF > 0
        bearishDurations.push(hmaTrendCount)
        if showTrendOverlay
            float avgInit =
                 bullishDurations.size() > 0 ?
                 bullishDurations.avg() : 10
            int arrowX1 = bar_index - 1
            int arrowX2 = int(arrowX1 +
                 nz(avgInit, 10) + 1)
            int midX = int(math.avg(
                 arrowX1, arrowX2))
            LengthLine := line.new(
                 arrowX1, hmaLine[1],
                 arrowX2, hmaLine[1],
                 color=color.white,
                 style=line.style_arrow_right)
            TrendUP := label.new(
                 midX, hmaLine[1],
                 "Trend ↑ Up Real: —",
                 color=color.rgb(0, 40, 0),
                 textcolor=color.rgb(0,255,0),
                 style=label.style_label_upper_left,
                 size=_hmaFcSz)
            LabelProbLen := label.new(
                 arrowX2, hmaLine[1],
                 "Prob: " + str.tostring(
                      bullishDurations.avg(),
                      "##"),
                 style=label.style_label_left,
                 textcolor=color.white,
                 color=color.rgb(30, 30, 30),
                 size=_hmaFcSz)
            if showHistTrend
                TrendDN.set_text(
                     "Trend ↓ Down Real: " +
                     str.tostring(
                     hmaTrendCount))
    else
        bullishDurations.push(hmaTrendCount)
        if showTrendOverlay
            float avgInit =
                 bearishDurations.size() > 0 ?
                 bearishDurations.avg() : 10
            int arrowX1 = bar_index - 1
            int arrowX2 = int(arrowX1 +
                 nz(avgInit, 10) + 1)
            int midX = int(math.avg(
                 arrowX1, arrowX2))
            LengthLine := line.new(
                 arrowX1, hmaLine[1],
                 arrowX2, hmaLine[1],
                 color=color.white,
                 style=line.style_arrow_right)
            TrendDN := label.new(
                 midX, hmaLine[1],
                 "Trend ↓ Down Real: —",
                 color=color.rgb(50, 0, 0),
                 textcolor=color.rgb(255,0,0),
                 style=label.style_label_lower_left,
                 size=_hmaFcSz)
            LabelProbLen := label.new(
                 arrowX2, hmaLine[1],
                 "Prob: " + str.tostring(
                      bearishDurations.avg(),
                      "##"),
                 style=label.style_label_left,
                 textcolor=color.white,
                 color=color.rgb(30, 30, 30),
                 size=_hmaFcSz)
            if showHistTrend
                TrendUP.set_text(
                     "Trend ↑ Up Real: " +
                     str.tostring(
                     hmaTrendCount))
    hmaTrendCount := 0

if showTrendOverlay
    if not na(hmaTrendF) and hmaTrendF < 0
        float avgBear =
             bearishDurations.size() > 0 ?
             bearishDurations.avg() : na
        string probStr = na(avgBear) ? "—" :
             str.tostring(avgBear, "##")
        TrendDN.set_text(
             "Trend ↓ Down Real: " +
             str.tostring(hmaTrendCount))
        TrendDN.set_textcolor(
             color.rgb(255, 0, 0))
        TrendDN.set_size(_hmaFcSz)
        LabelProbLen.set_text(
             "Prob: " + probStr)
        LabelProbLen.set_textcolor(color.white)
        LabelProbLen.set_size(_hmaFcSz)
        LengthLine.set_x2(int(
             LengthLine.get_x1() +
             nz(avgBear, 10) + 1))
        TrendDN.set_x(int(math.avg(
             LengthLine.get_x1(),
             LengthLine.get_x2())))
        TrendDN.set_y(LengthLine.get_y2())
        LabelProbLen.set_x(int(
             LengthLine.get_x2()))
        LabelProbLen.set_y(
             LengthLine.get_y2())
    else if not na(hmaTrendF) and hmaTrendF > 0
        float avgBull =
             bullishDurations.size() > 0 ?
             bullishDurations.avg() : na
        string probStr = na(avgBull) ? "—" :
             str.tostring(avgBull, "##")
        TrendUP.set_text(
             "Trend ↑ Up Real: " +
             str.tostring(hmaTrendCount))
        TrendUP.set_textcolor(
             color.rgb(0, 255, 0))
        TrendUP.set_size(_hmaFcSz)
        LabelProbLen.set_text(
             "Prob: " + probStr)
        LabelProbLen.set_textcolor(color.white)
        LabelProbLen.set_size(_hmaFcSz)
        LengthLine.set_x2(int(
             LengthLine.get_x1() +
             nz(avgBull, 10) + 1))
        TrendUP.set_x(int(math.avg(
             LengthLine.get_x1(),
             LengthLine.get_x2())))
        TrendUP.set_y(LengthLine.get_y2())
        LabelProbLen.set_x(int(
             LengthLine.get_x2()))
        LabelProbLen.set_y(
             LengthLine.get_y2())

if bullishDurations.size() > hmaSamples
    bullishDurations.shift()
if bearishDurations.size() > hmaSamples
    bearishDurations.shift()

color hmaColor = (not na(hmaTrendF) and
     hmaTrendF > 0) ? colorHmaUp : colorHmaDn
plot(showHmaLine ? hmaLine : na, "HMA",
     hmaColor, linewidth=hmaLineWidth)

float hmaTrendDuration = hmaTrendCount
float hmaProbableLen = (not na(hmaTrendF) and
     hmaTrendF > 0) ?
     (bullishDurations.size() > 0 ?
          bullishDurations.avg() : na) :
     (bearishDurations.size() > 0 ?
          bearishDurations.avg() : na)
string hmaTrendDirStr = (not na(hmaTrendF) and
     hmaTrendF > 0) ? "↑ Up" : "↓ Down"

// ═══════════════════════════════════
//    SHORT TREND ENGINE (UCD v7.0)
// ═══════════════════════════════════
float stATR = ta.atr(14)
int stMomLength = scalperMode ?
     scalperMomLen : stMomLen
int stFastEma = scalperMode ?
     scalperFastEMA : stMicroFast
int stSlowEma = scalperMode ?
     scalperSlowEMA : stMicroSlow
float stAtrSens = scalperMode ?
     scalperATRMult : stAtrMult

float stBarMove = close - open
bool stBullFlip = stBarMove > 0 and
     stBarMove > stATR * instantFlipATR
bool stBearFlip = stBarMove < 0 and
     stBarMove < -stATR * instantFlipATR

// MOMENTUM (25 pts)
float stPriceChg = close - close[stMomLength]
float stAvgMove = ta.sma(
     math.abs(close - close[1]), stMomLength)
float stMomStr = stAvgMove > 0 ?
     math.abs(stPriceChg) /
     (stAvgMove * stMomLength) : 0
float stMomThresh = scalperMode ?
     stATR * stAtrSens * 0.5 :
     stATR * stAtrSens
int stMomDir = stPriceChg > stMomThresh ? 1 :
     stPriceChg < -stMomThresh ? -1 : 0
if scalperMode and stBullFlip
    stMomDir := 1
if scalperMode and stBearFlip
    stMomDir := -1
int stMomScore = stMomStr > 2.0 ? 25 :
     stMomStr > 1.5 ? 20 :
     stMomStr > 1.0 ? 15 :
     stMomStr > 0.5 ? 10 : 5
if scalperMode and (stBullFlip or stBearFlip)
    stMomScore := 25

// CANDLE (25 pts)
float stBodySz = math.abs(close - open)
float stTotRange = high - low
float stBodyRat = stTotRange > 0 ?
     stBodySz / stTotRange : 0
float stUpWick = high - math.max(close, open)
float stDnWick = math.min(close, open) - low
bool stIsBull = close > open
bool stIsBear = close < open
bool stStrongBody = stBodyRat > 0.6
bool stBullReject = stDnWick >
     stBodySz * 1.5 and
     stUpWick < stBodySz * 0.5
bool stBearReject = stUpWick >
     stBodySz * 1.5 and
     stDnWick < stBodySz * 0.5
int stCandDir = stBullReject ? 1 :
     stBearReject ? -1 :
     stIsBull ? 1 : stIsBear ? -1 : 0
int stCandScore = stStrongBody ? 25 :
     (stBullReject or stBearReject) ? 20 :
     stBodyRat > 0.4 ? 15 : 10

// MICRO TREND (25 pts)
float stEmaF = ta.ema(close, stFastEma)
float stEmaS = ta.ema(close, stSlowEma)
float stEmaGap = stEmaF - stEmaS
float stEmaGapN = stATR > 0 ?
     stEmaGap / stATR : 0
int stTrendDir = stEmaF > stEmaS ? 1 :
     stEmaF < stEmaS ? -1 : 0
float stGT1 = scalperMode ? 0.5 : 1.0
float stGT2 = scalperMode ? 0.25 : 0.5
float stGT3 = scalperMode ? 0.1 : 0.25
int stTrendScore =
     math.abs(stEmaGapN) > stGT1 ? 25 :
     math.abs(stEmaGapN) > stGT2 ? 20 :
     math.abs(stEmaGapN) > stGT3 ? 15 : 10

// ACCELERATION (25 pts)
float stMomNow = close - close[1]
float stMomPrev = close[1] - close[2]
bool stMomIncr = (stMomNow > 0 and
     stMomNow > stMomPrev) or
     (stMomNow < 0 and stMomNow < stMomPrev)
int stAccDir = stMomNow > 0 ? 1 :
     stMomNow < 0 ? -1 : 0
int stAccScore = stMomIncr ? 25 : 15

// HEAT GAUGE (0-100)
float stROC3 = (close - close[3]) /
     close[3] * 100
int hROC = stROC3 > 0.5 ? 15 :
     stROC3 > 0.2 ? 12 :
     stROC3 > 0 ? 8 : stROC3 < -0.5 ? 0 :
     stROC3 < -0.2 ? 3 :
     stROC3 < 0 ? 7 : 7
float stRSI5 = ta.rsi(close, 5)
int hRSI = stRSI5 > 70 ? 15 :
     stRSI5 > 60 ? 12 : stRSI5 > 50 ? 9 :
     stRSI5 < 30 ? 0 : stRSI5 < 40 ? 3 :
     stRSI5 < 50 ? 6 : 7
float stStochK = ta.sma(
     ta.stoch(close, high, low, 5), 3)
int hStoch = stStochK > 80 ? 15 :
     stStochK > 60 ? 12 :
     stStochK > 50 ? 9 : stStochK < 20 ? 0 :
     stStochK < 40 ? 3 :
     stStochK < 50 ? 6 : 7
float hRngSafe = math.max(
     high - low, syminfo.mintick)
float hBuyVol = volume *
     (close - low) / hRngSafe
float hSellVol = volume *
     (high - close) / hRngSafe
float hTotVol = hBuyVol + hSellVol
float hBuyPct = hTotVol > 0 ?
     (hBuyVol / hTotVol) * 100 : 50
int hVol = hBuyPct > 70 ? 20 :
     hBuyPct > 60 ? 16 :
     hBuyPct > 50 ? 12 : hBuyPct < 30 ? 0 :
     hBuyPct < 40 ? 4 :
     hBuyPct < 50 ? 8 : 10
float hEma5 = ta.ema(close, 5)
float hPrVsEma = stATR > 0 ?
     (close - hEma5) / stATR : 0
int hEMA = hPrVsEma > 0.5 ? 15 :
     hPrVsEma > 0.2 ? 12 :
     hPrVsEma > 0 ? 9 :
     hPrVsEma < -0.5 ? 0 :
     hPrVsEma < -0.2 ? 3 :
     hPrVsEma < 0 ? 6 : 7
int hCand = 5
if stIsBull and stBodyRat > 0.6
    hCand := 10
else if stIsBull and stBodyRat > 0.4
    hCand := 8
else if stIsBull
    hCand := 6
else if stIsBear and stBodyRat > 0.6
    hCand := 0
else if stIsBear and stBodyRat > 0.4
    hCand := 2
else if stIsBear
    hCand := 4
int hAcc = 5
if stMomNow > 0 and stMomNow > stMomPrev
    hAcc := 10
else if stMomNow > 0
    hAcc := 7
else if stMomNow < 0 and
     stMomNow < stMomPrev
    hAcc := 0
else if stMomNow < 0
    hAcc := 3
int heatGauge = hROC + hRSI + hStoch +
     hVol + hEMA + hCand + hAcc
color heatColor = heatGauge >= 80 ?
     color.rgb(0,255,0) :
     heatGauge >= 65 ?
     color.rgb(50,205,50) :
     heatGauge >= 55 ?
     color.rgb(144,238,144) :
     heatGauge >= 45 ?
     color.rgb(255,255,0) :
     heatGauge >= 35 ?
     color.rgb(100,180,255) :
     heatGauge >= 20 ?
     color.rgb(50,130,255) :
     color.rgb(0,80,255)
string heatLabel = heatGauge >= 70 ? "HOT" :
     heatGauge >= 55 ? "WARM" :
     heatGauge >= 45 ? "NEUTRAL" :
     heatGauge >= 30 ? "COOL" : "COLD"
color heatTextClr = heatGauge >= 45 ?
     color.rgb(0,0,0) : color.rgb(255,255,255)

// VOLUME B/S (10 pts)
float bsRng = math.max(
     high - low, syminfo.mintick)
float bsBuyV = volume *
     (close - low) / bsRng
float bsSellV = volume *
     (high - close) / bsRng
float bsTot = bsBuyV + bsSellV
float bsBuyP = bsTot > 0 ?
     (bsBuyV / bsTot) * 100 : 0
float bsVolDiff = math.abs(
     bsBuyP - (100 - bsBuyP))
bool bsIsNeut = bsVolDiff <= 10.0
bool bsBuyDom = bsBuyP > 50
int stVolDir = bsIsNeut ? 0 :
     bsBuyDom ? 1 : -1
int stVolScore = bsVolDiff > 30 ? 10 :
     bsVolDiff > 20 ? 8 :
     bsVolDiff > 10 ? 5 : 0

// DIRECTION + SCORING
int stDirVote = stMomDir + stCandDir +
     stTrendDir + stAccDir + stVolDir
string stDirection = "NEUTRAL"
color stDirColor = #C0C0C0
int stDirSign = 0
if stDirVote >= 4
    stDirection := "BULLISH"
    stDirColor := stColLong
    stDirSign := 1
else if stDirVote <= -4
    stDirection := "BEARISH"
    stDirColor := stColShort
    stDirSign := -1
else if stDirVote >= 3
    stDirection := scalperMode ?
         "BULLISH" : "LEAN BULL"
    stDirColor := stColLong
    stDirSign := 1
else if stDirVote <= -3
    stDirection := scalperMode ?
         "BEARISH" : "LEAN BEAR"
    stDirColor := stColShort
    stDirSign := -1
else if stDirVote >= 1
    stDirection := "LEAN BULL"
    stDirColor := stColLong
    stDirSign := 1
else if stDirVote <= -1
    stDirection := "LEAN BEAR"
    stDirColor := stColShort
    stDirSign := -1
string stFlipInd = ""
if scalperMode and showInstantFlip
    if stBullFlip
        stFlipInd := " **"
        if stDirSign != 1
            stDirection := "FLIP BULL"
            stDirColor := stColFlip
            stDirSign := 1
    else if stBearFlip
        stFlipInd := " **"
        if stDirSign != -1
            stDirection := "FLIP BEAR"
            stDirColor := stColFlip
            stDirSign := -1
int stRawScore = 0
if stDirSign == 1
    stRawScore :=
         (stMomDir >= 0 ? stMomScore : 0) +
         (stCandDir >= 0 ? stCandScore : 0) +
         (stTrendDir >= 0 ? stTrendScore : 0)+
         (stAccDir >= 0 ? stAccScore : 0) +
         (stVolDir >= 0 ? stVolScore : 0)
else if stDirSign == -1
    stRawScore :=
         (stMomDir <= 0 ? stMomScore : 0) +
         (stCandDir <= 0 ? stCandScore : 0) +
         (stTrendDir <= 0 ? stTrendScore : 0)+
         (stAccDir <= 0 ? stAccScore : 0) +
         (stVolDir <= 0 ? stVolScore : 0)
else
    stRawScore := stMomScore + stCandScore +
         stTrendScore + stAccScore + stVolScore
    stRawScore := math.round(stRawScore * 0.5)
int stTotalScore = stDirSign != 0 ?
     math.round(stRawScore * 100.0 / 110.0) :
     stRawScore
string stGrade = stTotalScore >= 85 ? "A+" :
     stTotalScore >= 70 ? "A" :
     stTotalScore >= 50 ? "B" : "C"
color stGradeClr = stDirSign == 0 ?
     color.yellow : stDirSign == 1 ?
     (stGrade == "A+" ? color.rgb(0,255,0) :
      stGrade == "A" ? color.rgb(50,220,50) :
      stGrade == "B" ? color.rgb(80,200,80) :
      color.yellow) :
     (stGrade == "A+" ? color.rgb(255,0,0) :
      stGrade == "A" ? color.rgb(255,60,60) :
      stGrade == "B" ?
           color.rgb(230,100,100) :
      color.yellow)
color stScoreClr = stDirSign == 0 ?
     color.yellow : stDirSign == 1 ?
     (stTotalScore >= 85 ?
          color.rgb(0,255,0) :
      stTotalScore >= 70 ?
          color.rgb(50,220,50) :
      stTotalScore >= 50 ?
          color.rgb(80,200,80) :
      color.yellow) :
     (stTotalScore >= 85 ?
          color.rgb(255,0,0) :
      stTotalScore >= 70 ?
          color.rgb(255,60,60) :
      stTotalScore >= 50 ?
          color.rgb(230,100,100) :
      color.yellow)
color stBorderClr = stDirSign == 1 ?
     stColLong : stDirSign == -1 ?
     stColShort : stColNeutral

string stMomLbl = stMomDir == 1 ? "BULL" :
     stMomDir == -1 ? "BEAR" : "FLAT"
color stMomCol = stMomDir == 1 ? stColLong :
     stMomDir == -1 ? stColShort : #C0C0C0
string stCandLbl = stCandDir == 1 ? "BULL" :
     stCandDir == -1 ? "BEAR" : "DOJI"
color stCandCol = stCandDir == 1 ?
     stColLong :
     stCandDir == -1 ? stColShort : #C0C0C0
string stTrendLbl = stTrendDir == 1 ?
     "BULL" :
     stTrendDir == -1 ? "BEAR" : "FLAT"
color stTrendCol = stTrendDir == 1 ?
     stColLong :
     stTrendDir == -1 ? stColShort : #C0C0C0
string stAccLbl = stMomIncr ?
     "ACCEL" : "DECEL"
color stAccCol = stAccDir == 1 ? stColLong :
     stAccDir == -1 ? stColShort : #C0C0C0
string stVolLbl = stVolDir == 1 ? "BULL" :
     stVolDir == -1 ? "BEAR" : "FLAT"
color stVolCol = stVolDir == 1 ? stColLong :
     stVolDir == -1 ? stColShort : #C0C0C0

// ═══════════════════════════════════
//       PIVOT DETECTION
// ═══════════════════════════════════
float ph = na
float pl = na
if pivotRight == 0
    ph := ta.pivothigh(high, pivotLeft, 0)
    pl := ta.pivotlow(low, pivotLeft, 0)
else
    ph := ta.pivothigh(pivotLeft, pivotRight)
    pl := ta.pivotlow(pivotLeft, pivotRight)

bool shortRaw = not na(ph)
bool longRaw  = not na(pl)
bool longBase = longRaw and
     (useSmiFilter ? smiRising : true)
bool shortBase = shortRaw and
     (useSmiFilter ? smiFalling : true)

// Direction filter
if tradeDirection == "Long"
    shortBase := false
else if tradeDirection == "Short"
    longBase := false

// ═══════════════════════════════════
//          FILTERS
// ═══════════════════════════════════
var int   lastSignalBar   = 0
var float lastSignalPrice = na
var int   lastSignalDir   = 0

bool cooldownOK = (bar_index - lastSignalBar)
     >= cooldownBars
bool priceMoveOK = true
if usePriceFilter and
     not na(lastSignalPrice)
    priceMoveOK :=
         math.abs(close - lastSignalPrice)
         >= (atrVal * priceFilterATR)
bool alternateOK_long = useAlternating ?
     lastSignalDir != 1 : true
bool alternateOK_short = useAlternating ?
     lastSignalDir != -1 : true
bool validBars = bar_index >=
     pivotLeft + pivotRight + 1

bool filteredLong = validBars and longBase
     and cooldownOK and priceMoveOK
     and alternateOK_long
bool filteredShort = validBars and shortBase
     and cooldownOK and priceMoveOK
     and alternateOK_short

// ═══════════════════════════════════
//     CONFIRMED vs PREVIEW
// ═══════════════════════════════════
bool showConfirmedMode =
     signalMode == "Confirmed Only" or
     signalMode == "Confirmed + Preview"
bool showPreviewMode =
     signalMode == "Confirmed + Preview" or
     signalMode == "Preview Only"

bool confirmedLong = filteredLong and
     barstate.isconfirmed
bool confirmedShort = filteredShort and
     barstate.isconfirmed
bool previewLong = filteredLong and
     not barstate.isconfirmed
bool previewShort = filteredShort and
     not barstate.isconfirmed

// ═══════════════════════════════════
//      STATE UPDATE
// ═══════════════════════════════════
if confirmedLong
    lastSignalBar := bar_index
    lastSignalPrice := pivotRight > 0 ?
         low[pivotRight] : low
    lastSignalDir := 1
if confirmedShort
    lastSignalBar := bar_index
    lastSignalPrice := pivotRight > 0 ?
         high[pivotRight] : high
    lastSignalDir := -1

// ═══════════════════════════════════
//   PIVOT LABEL RENDERING
// ═══════════════════════════════════
lblSize = switch labelSizeStr
    "Tiny"   => size.tiny
    "Small"  => size.small
    "Normal" => size.normal
    "Large"  => size.large
    "Huge"   => size.huge

buyOffset = buyOffsetTicks * syminfo.mintick
sellOffset = sellOffsetTicks * syminfo.mintick
bool usePointer =
     (pivotLblLayout == "Pointer")

getTimestamp(int idx) =>
    int t = time[idx]
    switch timestampFmt
        "HH:mm" =>
             str.format_time(t, "HH:mm",
                  syminfo.timezone)
        "HH:mm:ss" =>
             str.format_time(t, "HH:mm:ss",
                  syminfo.timezone)
        "h:mm a" =>
             str.format_time(t, "h:mm a",
                  syminfo.timezone)
        "MMM dd HH:mm" =>
             str.format_time(t,
                  "MMM dd HH:mm",
                  syminfo.timezone)
        "MMM dd" =>
             str.format_time(t, "MMM dd",
                  syminfo.timezone)
        => str.format_time(t, "HH:mm",
                  syminfo.timezone)

buildBuyText(bool preview, int idx) =>
    string core = preview ? "~ BUY ~" : "BUY"
    string ts = showTimestamp ?
         "\n" + getTimestamp(idx) : ""
    core + ts

buildSellText(bool preview, int idx) =>
    string core = preview ?
         "~ SELL ~" : "SELL"
    string ts = showTimestamp ?
         "\n" + getTimestamp(idx) : ""
    core + ts

int bIdx = pivotRight > 0 ? pivotRight : 0
int buyBar = bar_index - bIdx
int sellBar = bar_index - bIdx

float buyYstack = pivotRight > 0 ?
     low[bIdx] - buyOffset : low - buyOffset
float sellYstack = pivotRight > 0 ?
     high[bIdx] + sellOffset :
     high + sellOffset
float buyYptr = pivotRight > 0 ?
     low[bIdx] : low
float sellYptr = pivotRight > 0 ?
     high[bIdx] : high
float buyYfinal = usePointer ?
     buyYptr : buyYstack
float sellYfinal = usePointer ?
     sellYptr : sellYstack

buyLblStyle = usePointer ?
     label.style_label_upper_right :
     label.style_label_up
sellLblStyle = usePointer ?
     label.style_label_lower_right :
     label.style_label_down

var label prevBuyLbl  = na
var label prevSellLbl = na
label.delete(prevBuyLbl)
label.delete(prevSellLbl)
prevBuyLbl  := na
prevSellLbl := na

if showLabels and showConfirmedMode
     and confirmedLong
    label.new(buyBar, buyYfinal,
         buildBuyText(false, bIdx),
         xloc=xloc.bar_index,
         yloc=yloc.price,
         style=buyLblStyle,
         color=buyLabelBgColor,
         textcolor=buyTextColor,
         size=lblSize)

if showLabels and showConfirmedMode
     and confirmedShort
    label.new(sellBar, sellYfinal,
         buildSellText(false, bIdx),
         xloc=xloc.bar_index,
         yloc=yloc.price,
         style=sellLblStyle,
         color=sellLabelBgColor,
         textcolor=sellTextColor,
         size=lblSize)

if showLabels and showPreviewMode
     and previewLong
    prevBuyLbl := label.new(buyBar,
         buyYfinal,
         buildBuyText(true, bIdx),
         xloc=xloc.bar_index,
         yloc=yloc.price,
         style=buyLblStyle,
         color=color.new(
              buyLabelBgColor, 50),
         textcolor=buyTextColor,
         size=lblSize)

if showLabels and showPreviewMode
     and previewShort
    prevSellLbl := label.new(sellBar,
         sellYfinal,
         buildSellText(true, bIdx),
         xloc=xloc.bar_index,
         yloc=yloc.price,
         style=sellLblStyle,
         color=color.new(
              sellLabelBgColor, 50),
         textcolor=sellTextColor,
         size=lblSize)

// ═══════════════════════════════════
//     RISK MANAGEMENT ENGINE
// ═══════════════════════════════════
var float riskEntryPrice = na
var string riskDirection = na
var int riskEntryBar = na
var bool riskActive = false
var float trailingSL = na
var bool tp1Hit = false
var bool tp2Hit = false
var bool tp3Hit_tracked = false
var float tp2TrailExtreme = na
var bool tradeComplete = false

var line entryLine = na
var line slLine = na
var line tp1Line = na
var line tp2Line = na
var line tp3Line = na
var label entryLabel = na
var label slLabel = na
var label tp1Label = na
var label tp2Label = na
var label tp3Label = na
var label tp1MarkerLbl = na
var label tp2MarkerLbl = na
var label tp3MarkerLbl = na

getSlDist(ePrice) =>
    slMethod == "Percentage" ?
         ePrice * (stopLossPercent / 100.0) :
         stopLossPoints

bool riskLong = enableRisk and confirmedLong
bool riskShort = enableRisk and confirmedShort
bool riskNewSignal = riskLong or riskShort

if riskNewSignal
    // Reset previous trade objects
    line.delete(entryLine)
    line.delete(slLine)
    line.delete(tp1Line)
    line.delete(tp2Line)
    line.delete(tp3Line)
    label.delete(entryLabel)
    label.delete(slLabel)
    label.delete(tp1Label)
    label.delete(tp2Label)
    label.delete(tp3Label)
    label.delete(tp1MarkerLbl)
    label.delete(tp2MarkerLbl)
    label.delete(tp3MarkerLbl)
    entryLine := na
    slLine := na
    tp1Line := na
    tp2Line := na
    tp3Line := na
    entryLabel := na
    slLabel := na
    tp1Label := na
    tp2Label := na
    tp3Label := na
    tp1Hit := false
    tp2Hit := false
    tp3Hit_tracked := false
    tp2TrailExtreme := na
    tradeComplete := false
    trailingSL := na

    riskEntryPrice := pivotRight > 0 ?
         close[pivotRight] : close
    riskDirection := riskLong ?
         "Long" : "Short"
    riskEntryBar := pivotRight > 0 ?
         bar_index - pivotRight : bar_index
    riskActive := true

float initialSL = na
float tp1Level = na
float tp2Level = na
float tp3Level = na

bool hasRiskEntry = enableRisk and
     riskActive and not na(riskEntryPrice)

float effSLDist = hasRiskEntry ?
     getSlDist(riskEntryPrice) :
     stopLossPoints

if hasRiskEntry
    if riskDirection == "Long"
        initialSL := riskEntryPrice - effSLDist
        tp1Level := riskEntryPrice +
             effSLDist * tp1Ratio
        tp2Level := riskEntryPrice +
             effSLDist * tp2Ratio
        tp3Level := riskEntryPrice +
             effSLDist * tp3Ratio
    else
        initialSL := riskEntryPrice + effSLDist
        tp1Level := riskEntryPrice -
             effSLDist * tp1Ratio
        tp2Level := riskEntryPrice -
             effSLDist * tp2Ratio
        tp3Level := riskEntryPrice -
             effSLDist * tp3Ratio

if riskNewSignal and not na(initialSL)
    trailingSL := initialSL

if enableTrailing and hasRiskEntry and
     not na(trailingSL)
    if riskDirection == "Long"
        float profit = close - riskEntryPrice
        if profit >= breakevenPoints and
             trailingSL < riskEntryPrice
            trailingSL := riskEntryPrice
        else if profit >= trailStartPoints
            float newSL = close -
                 trailOffsetPoints
            if newSL > trailingSL
                trailingSL := newSL
    else
        float profit = riskEntryPrice - close
        if profit >= breakevenPoints and
             trailingSL > riskEntryPrice
            trailingSL := riskEntryPrice
        else if profit >= trailStartPoints
            float newSL = close +
                 trailOffsetPoints
            if newSL < trailingSL
                trailingSL := newSL

float displaySL = enableTrailing ?
     trailingSL : initialSL

// TP HIT TRACKING
bool tp1JustHit = false
bool tp2JustHit = false
bool tp3JustHit = false

bool canTrackTP = hasRiskEntry and
     not na(tp1Level) and
     bar_index > nz(riskEntryBar, bar_index)

if canTrackTP and not tradeComplete
    if riskDirection == "Long"
        if not tp1Hit and high >= tp1Level
            tp1Hit := true
            tp1JustHit := true
        if not tp2Hit and high >= tp2Level
            tp2Hit := true
            tp2JustHit := true
        if not tp3Hit_tracked and
             high >= tp3Level
            tp3Hit_tracked := true
            tp3JustHit := true
    else
        if not tp1Hit and low <= tp1Level
            tp1Hit := true
            tp1JustHit := true
        if not tp2Hit and low <= tp2Level
            tp2Hit := true
            tp2JustHit := true
        if not tp3Hit_tracked and
             low <= tp3Level
            tp3Hit_tracked := true
            tp3JustHit := true

// TP2+ REVERSAL EXIT
bool tp2ReversalExit = false
if enableTP2Trail and tp2Hit and
     not tp3Hit_tracked and riskActive and
     not tradeComplete
    if riskDirection == "Long"
        if na(tp2TrailExtreme) or
             high > tp2TrailExtreme
            tp2TrailExtreme := high
        if not na(tp2TrailExtreme) and
             low <= (tp2TrailExtreme -
             tp2ReversalPts)
            tp2ReversalExit := true
    else
        if na(tp2TrailExtreme) or
             low < tp2TrailExtreme
            tp2TrailExtreme := low
        if not na(tp2TrailExtreme) and
             high >= (tp2TrailExtreme +
             tp2ReversalPts)
            tp2ReversalExit := true

// TRADE COMPLETION
bool slHit = false
if not tradeComplete and hasRiskEntry and
     bar_index > nz(riskEntryBar,
     bar_index)
    if tp3JustHit
        tradeComplete := true
    if tp2ReversalExit
        tradeComplete := true
    if riskDirection == "Long" and
         not na(displaySL) and
         low <= displaySL
        tradeComplete := true
        slHit := true
    if riskDirection == "Short" and
         not na(displaySL) and
         high >= displaySL
        tradeComplete := true
        slHit := true

if tradeComplete and autoResetOnComplete
    riskActive := false
    riskEntryPrice := na
    riskDirection := na
    trailingSL := na
    tp1Hit := false
    tp2Hit := false
    tp3Hit_tracked := false
    tp2TrailExtreme := na
    tradeComplete := false
    line.delete(entryLine)
    line.delete(slLine)
    line.delete(tp1Line)
    line.delete(tp2Line)
    line.delete(tp3Line)
    label.delete(entryLabel)
    label.delete(slLabel)
    label.delete(tp1Label)
    label.delete(tp2Label)
    label.delete(tp3Label)
    label.delete(tp1MarkerLbl)
    label.delete(tp2MarkerLbl)
    label.delete(tp3MarkerLbl)

// RISK LINES
bool canDrawRisk = hasRiskEntry and
     not na(displaySL) and
     not na(tp1Level) and not tradeComplete

if canDrawRisk and na(entryLine)
    int startBar = nz(riskEntryBar,
         bar_index)
    int endBar = riskLineLen > 0 ?
         math.max(startBar + riskLineLen,
              bar_index + riskLabelOffset) :
         bar_index + riskLabelOffset
    entryLine := line.new(startBar,
         riskEntryPrice, endBar,
         riskEntryPrice,
         color=colorEntry, width=1)
    slLine := line.new(startBar, displaySL,
         endBar, displaySL,
         color=colorSL, width=1)
    tp1Line := line.new(startBar, tp1Level,
         endBar, tp1Level,
         color=colorTP1, width=1)
    tp2Line := line.new(startBar, tp2Level,
         endBar, tp2Level,
         color=colorTP2, width=1)
    tp3Line := line.new(startBar, tp3Level,
         endBar, tp3Level,
         color=colorTP3, width=1)

if not na(entryLine)
    int endBar = riskLineLen > 0 ?
         math.max(nz(riskEntryBar,
              bar_index) + riskLineLen,
              bar_index + riskLabelOffset) :
         bar_index + riskLabelOffset
    line.set_x2(entryLine, endBar)
    line.set_x2(slLine, endBar)
    line.set_y1(slLine, displaySL)
    line.set_y2(slLine, displaySL)
    line.set_x2(tp1Line, endBar)
    line.set_x2(tp2Line, endBar)
    line.set_x2(tp3Line, endBar)
if not na(tp1Line) and tp1Hit
    line.set_style(tp1Line, line.style_dashed)
if not na(tp2Line) and tp2Hit
    line.set_style(tp2Line, line.style_dashed)
if not na(tp3Line) and tp3Hit_tracked
    line.set_style(tp3Line, line.style_dashed)

// TP MARKERS
if tp1JustHit and riskActive
    label.delete(tp1MarkerLbl)
    tp1MarkerLbl := label.new(bar_index,
         tp1Level, "✓ TP1",
         style=riskDirection == "Long" ?
              label.style_label_down :
              label.style_label_up,
         color=colorTP1,
         textcolor=color.white,
         size=size.tiny)
if tp2JustHit and riskActive
    label.delete(tp2MarkerLbl)
    tp2MarkerLbl := label.new(bar_index,
         tp2Level, "✓ TP2",
         style=riskDirection == "Long" ?
              label.style_label_down :
              label.style_label_up,
         color=colorTP2,
         textcolor=color.black,
         size=size.tiny)
if tp3JustHit and riskActive
    label.delete(tp3MarkerLbl)
    tp3MarkerLbl := label.new(bar_index,
         tp3Level, "✓ TP3",
         style=riskDirection == "Long" ?
              label.style_label_down :
              label.style_label_up,
         color=colorTP3,
         textcolor=color.white,
         size=size.tiny)

// PRICE LABELS
if showRiskLabels and canDrawRisk and
     barstate.islast
    label.delete(entryLabel)
    label.delete(slLabel)
    label.delete(tp1Label)
    label.delete(tp2Label)
    label.delete(tp3Label)
    int lblPos = bar_index + riskLabelOffset
    entryLabel := label.new(lblPos,
         riskEntryPrice,
         "  ENTRY: " + formatWithCommas(
              riskEntryPrice, 2) + "  ",
         style=label.style_label_left,
         color=colorEntry,
         textcolor=color.black,
         size=size.small)
    slLabel := label.new(lblPos, displaySL,
         "  SL: " + formatWithCommas(
              displaySL, 2) + "  ",
         style=label.style_label_left,
         color=colorSL,
         textcolor=color.white,
         size=size.small)
    string tp1S = tp1Hit ? " ✓" : ""
    string tp2S = tp2Hit ? " ✓" : ""
    tp1Label := label.new(lblPos, tp1Level,
         "  TP1: " + formatWithCommas(
              tp1Level, 2) + tp1S + "  ",
         style=label.style_label_left,
         color=tp1Hit ? color.new(
              colorTP1, 50) : colorTP1,
         textcolor=color.white,
         size=size.small)
    tp2Label := label.new(lblPos, tp2Level,
         "  TP2: " + formatWithCommas(
              tp2Level, 2) + tp2S + "  ",
         style=label.style_label_left,
         color=tp2Hit ? color.new(
              colorTP2, 50) : colorTP2,
         textcolor=color.black,
         size=size.small)
    tp3Label := label.new(lblPos, tp3Level,
         "  TP3: " + formatWithCommas(
              tp3Level, 2) + "  ",
         style=label.style_label_left,
         color=colorTP3,
         textcolor=color.white,
         size=size.small)

// ═══════════════════════════════════
//        P&L DASHBOARD
// ═══════════════════════════════════
getRiskDashPos() =>
    switch riskDashPos
        "Top Left" => position.top_left
        "Top Center" => position.top_center
        "Top Right" => position.top_right
        "Middle Left" => position.middle_left
        "Middle Center" =>
             position.middle_center
        "Middle Right" =>
             position.middle_right
        "Bottom Left" => position.bottom_left
        "Bottom Center" =>
             position.bottom_center
        => position.bottom_right

getRiskDashSize() =>
    switch riskDashSize
        "Tiny" => size.tiny
        "Small" => size.small
        "Normal" => size.normal
        "Large" => size.large
        "Huge" => size.huge
        => size.normal

var table riskDash = na
if showRiskDash and canDrawRisk
    if na(riskDash)
        riskDash := table.new(
             getRiskDashPos(), 2, 14,
             bgcolor=color.new(#1a1a1a, 0),
             frame_color=color.gray,
             frame_width=2)
    if barstate.islast
        dSize = getRiskDashSize()
        float slDist = math.abs(
             riskEntryPrice - displaySL)
        float currentPL =
             riskDirection == "Long" ?
             close - riskEntryPrice :
             riskEntryPrice - close
        float dRisk = slDist * pointValue *
             numContracts
        float dTP1 = math.abs(tp1Level -
             riskEntryPrice) * pointValue *
             numContracts
        float dTP2 = math.abs(tp2Level -
             riskEntryPrice) * pointValue *
             numContracts
        float dTP3 = math.abs(tp3Level -
             riskEntryPrice) * pointValue *
             numContracts
        float dPL = currentPL * pointValue *
             numContracts
        float currentRR = slDist > 0 ?
             currentPL / slDist : 0.0

        table.cell(riskDash, 0, 0,
             "SMI Fractal Iron HMA",
             text_color=color.white,
             text_size=dSize,
             bgcolor=color.new(
                  color.blue, 50))
        table.merge_cells(riskDash,
             0, 0, 1, 0)
        table.cell(riskDash, 0, 1,
             "Direction:",
             text_color=color.silver,
             text_size=dSize)
        color dirClr =
             riskDirection == "Long" ?
             color.lime : color.red
        table.cell(riskDash, 1, 1,
             riskDirection,
             text_color=dirClr,
             text_size=dSize)
        table.cell(riskDash, 0, 2,
             "Entry:",
             text_color=color.silver,
             text_size=dSize)
        table.cell(riskDash, 1, 2,
             formatWithCommas(
                  riskEntryPrice, 2),
             text_color=color.white,
             text_size=dSize)
        table.cell(riskDash, 0, 3,
             "Current P&L:",
             text_color=color.silver,
             text_size=dSize)
        color plClr = dPL >= 0 ?
             color.lime : color.red
        table.cell(riskDash, 1, 3,
             currencySymbol +
             formatWithCommas(dPL, 0),
             text_color=plClr,
             text_size=dSize)
        table.cell(riskDash, 0, 4,
             "Current R:R:",
             text_color=color.silver,
             text_size=dSize)
        color rrClr = currentRR >= 0 ?
             color.lime : color.red
        table.cell(riskDash, 1, 4,
             str.tostring(currentRR,
                  "#.##") + "R",
             text_color=rrClr,
             text_size=dSize)
        table.cell(riskDash, 0, 5,
             "Risk:",
             text_color=color.silver,
             text_size=dSize)
        table.cell(riskDash, 1, 5,
             currencySymbol +
             formatWithCommas(dRisk, 0),
             text_color=colorSL,
             text_size=dSize)
        string tp1D = "TP1:" +
             (tp1Hit ? " ✓" : "")
        table.cell(riskDash, 0, 6, tp1D,
             text_color=tp1Hit ?
                  color.white : color.silver,
             text_size=dSize)
        table.cell(riskDash, 1, 6,
             currencySymbol +
             formatWithCommas(dTP1, 0),
             text_color=colorTP1,
             text_size=dSize)
        string tp2D = "TP2:" +
             (tp2Hit ? " ✓" : "")
        table.cell(riskDash, 0, 7, tp2D,
             text_color=tp2Hit ?
                  color.white : color.silver,
             text_size=dSize)
        table.cell(riskDash, 1, 7,
             currencySymbol +
             formatWithCommas(dTP2, 0),
             text_color=colorTP2,
             text_size=dSize)
        string tp3D = "TP3:" +
             (tp3Hit_tracked ? " ✓" : "")
        table.cell(riskDash, 0, 8, tp3D,
             text_color=tp3Hit_tracked ?
                  color.white : color.silver,
             text_size=dSize)
        table.cell(riskDash, 1, 8,
             currencySymbol +
             formatWithCommas(dTP3, 0),
             text_color=colorTP3,
             text_size=dSize)
        int barsInTrade = bar_index -
             nz(riskEntryBar, bar_index)
        table.cell(riskDash, 0, 9,
             "Bars:",
             text_color=color.silver,
             text_size=dSize)
        table.cell(riskDash, 1, 9,
             str.tostring(barsInTrade),
             text_color=color.white,
             text_size=dSize)
        color trendDirClr =
             (not na(hmaTrendF) and
             hmaTrendF > 0) ?
             colorHmaUp : colorHmaDn
        table.cell(riskDash, 0, 10,
             "Trend " + hmaTrendDirStr +
             ":",
             text_color=trendDirClr,
             text_size=dSize)
        table.cell(riskDash, 1, 10,
             str.tostring(hmaTrendCount) +
             " bars",
             text_color=trendDirClr,
             text_size=dSize)
        table.cell(riskDash, 0, 11,
             "Prob. Length:",
             text_color=color.silver,
             text_size=dSize)
        string probTxt = na(hmaProbableLen) ?
             "—" : str.tostring(
             hmaProbableLen, "##") + " bars"
        table.cell(riskDash, 1, 11, probTxt,
             text_color=color.white,
             text_size=dSize)
else
    if not na(riskDash)
        table.delete(riskDash)
        riskDash := na

// ═══════════════════════════════════
//     SHORT TREND DASHBOARD
// ═══════════════════════════════════
getSTDashPos() =>
    switch stDashPosition
        "Top Left" => position.top_left
        "Top Center" => position.top_center
        "Top Right" => position.top_right
        "Middle Left" => position.middle_left
        "Middle Center" =>
             position.middle_center
        "Middle Right" =>
             position.middle_right
        "Bottom Left" => position.bottom_left
        "Bottom Center" =>
             position.bottom_center
        => position.bottom_right

getSTDashSize() =>
    switch stDashSize
        "Tiny" => size.tiny
        "Small" => size.small
        "Normal" => size.normal
        "Large" => size.large
        "Huge" => size.huge
        => size.normal

var table stDashboard = na
color stCellBg = color.rgb(42, 42, 42)
color stBlackBg = color.rgb(0, 0, 0)

if barstate.islast and showSTDash
    if not na(stDashboard)
        table.delete(stDashboard)
    stDashboard := table.new(
         getSTDashPos(), 2, 14,
         bgcolor=color.new(#1a1a1a, 0),
         border_width=1,
         border_color=color.white,
         frame_width=3,
         frame_color=stBorderClr)
    stSz = getSTDashSize()
    int r = 0
    table.cell(stDashboard, 0, r,
         "= SHORT TREND =",
         text_color=#FF0000,
         text_size=stSz,
         bgcolor=stBlackBg,
         text_halign=text.align_center)
    table.merge_cells(stDashboard, 0, r, 1, r)
    r += 1
    table.cell(stDashboard, 0, r,
         stDirection + stFlipInd,
         text_color=stDirColor,
         text_size=size.large,
         bgcolor=stBlackBg,
         text_halign=text.align_center)
    table.merge_cells(stDashboard, 0, r, 1, r)
    r += 1
    table.cell(stDashboard, 0, r,
         str.tostring(stTotalScore),
         text_color=stScoreClr,
         text_size=size.large,
         bgcolor=stBlackBg,
         text_halign=text.align_center)
    table.merge_cells(stDashboard, 0, r, 1, r)
    r += 1
    table.cell(stDashboard, 0, r,
         "GRADE: " + stGrade,
         text_color=stGradeClr,
         text_size=stSz,
         bgcolor=stBlackBg,
         text_halign=text.align_center)
    table.merge_cells(stDashboard, 0, r, 1, r)
    r += 1
    table.cell(stDashboard, 0, r,
         "TEMP: " +
         str.tostring(heatGauge) +
         " " + heatLabel,
         text_color=heatTextClr,
         text_size=stSz,
         bgcolor=heatColor,
         text_halign=text.align_center)
    table.merge_cells(stDashboard, 0, r, 1, r)
    r += 1
    table.cell(stDashboard, 0, r,
         "──────────",
         text_color=color.gray,
         text_size=size.small,
         bgcolor=stCellBg,
         text_halign=text.align_center)
    table.merge_cells(stDashboard, 0, r, 1, r)
    r += 1
    table.cell(stDashboard, 0, r, "MOM:",
         text_color=color.white,
         text_size=size.small,
         bgcolor=stCellBg)
    table.cell(stDashboard, 1, r,
         stMomLbl + " " +
         str.tostring(stMomScore),
         text_color=stMomCol,
         text_size=size.small,
         bgcolor=stCellBg)
    r += 1
    table.cell(stDashboard, 0, r, "CANDLE:",
         text_color=color.white,
         text_size=size.small,
         bgcolor=stCellBg)
    table.cell(stDashboard, 1, r,
         stCandLbl + " " +
         str.tostring(stCandScore),
         text_color=stCandCol,
         text_size=size.small,
         bgcolor=stCellBg)
    r += 1
    table.cell(stDashboard, 0, r, "TREND:",
         text_color=color.white,
         text_size=size.small,
         bgcolor=stCellBg)
    table.cell(stDashboard, 1, r,
         stTrendLbl + " " +
         str.tostring(stTrendScore),
         text_color=stTrendCol,
         text_size=size.small,
         bgcolor=stCellBg)
    r += 1
    table.cell(stDashboard, 0, r, "ACCEL:",
         text_color=color.white,
         text_size=size.small,
         bgcolor=stCellBg)
    table.cell(stDashboard, 1, r,
         stAccLbl + " " +
         str.tostring(stAccScore),
         text_color=stAccCol,
         text_size=size.small,
         bgcolor=stCellBg)
    r += 1
    table.cell(stDashboard, 0, r, "VOL B/S:",
         text_color=color.white,
         text_size=size.small,
         bgcolor=stCellBg)
    table.cell(stDashboard, 1, r,
         stVolLbl + " " +
         str.tostring(stVolScore),
         text_color=stVolCol,
         text_size=size.small,
         bgcolor=stCellBg)
    r += 1
    table.cell(stDashboard, 0, r,
         "──────────",
         text_color=color.gray,
         text_size=size.small,
         bgcolor=stCellBg,
         text_halign=text.align_center)
    table.merge_cells(stDashboard, 0, r, 1, r)
    r += 1
    table.cell(stDashboard, 0, r,
         "CONSENSUS: " +
         (stDirVote >= 0 ? "+" : "") +
         str.tostring(stDirVote) + "/5",
         text_color=stDirColor,
         text_size=size.small,
         bgcolor=stCellBg,
         text_halign=text.align_center)
    table.merge_cells(stDashboard, 0, r, 1, r)
else
    if not na(stDashboard)
        table.delete(stDashboard)
        stDashboard := na

// ═══════════════════════════════════
//         BAR COLORING
// ═══════════════════════════════════
color barCol = showBarColor ?
     (smiInChop ? neutralBarColor :
     smiRising ? bullBarColor :
     smiFalling ? bearBarColor :
     neutralBarColor) : na
barcolor(barCol, title="SMI Bar Color")

// ═══════════════════════════════════
//           ALERTS
// ═══════════════════════════════════
alertcondition(confirmedLong,
     title="Pivot Long Signal",
     message="{{ticker}} {{interval}} — " +
     "SMI Fractal Iron HMA: Long")
alertcondition(confirmedShort,
     title="Pivot Short Signal",
     message="{{ticker}} {{interval}} — " +
     "SMI Fractal Iron HMA: Short")
alertcondition(
     confirmedLong and not smiInChop,
     title="Strong Long",
     message="{{ticker}} {{interval}} — " +
     "SMI Fractal Iron HMA: Strong long")
alertcondition(
     confirmedShort and not smiInChop,
     title="Strong Short",
     message="{{ticker}} {{interval}} — " +
     "SMI Fractal Iron HMA: Strong short")
alertcondition(
     hmaTrendChanged and hmaTrendF > 0,
     title="HMA Bullish",
     message="{{ticker}} {{interval}} — " +
     "HMA bullish trend")
alertcondition(
     hmaTrendChanged and hmaTrendF < 0,
     title="HMA Bearish",
     message="{{ticker}} {{interval}} — " +
     "HMA bearish trend")
alertcondition(tp1JustHit,
     title="TP1 Hit",
     message="{{ticker}} — TP1 reached")
alertcondition(tp2JustHit,
     title="TP2 Hit",
     message="{{ticker}} — TP2 reached")
alertcondition(tp3JustHit,
     title="TP3 Hit",
     message="{{ticker}} — TP3 hit")
alertcondition(slHit,
     title="Stop Loss Hit",
     message="{{ticker}} — SL hit")

if audio and confirmedLong
    alert("Long (L" +
         str.tostring(pivotLeft) + "/R" +
         str.tostring(pivotRight) +
         ") — " + syminfo.ticker + " " +
         timeframe.period,
         alert.freq_once_per_bar_close)
if audio and confirmedShort
    alert("Short (L" +
         str.tostring(pivotLeft) + "/R" +
         str.tostring(pivotRight) +
         ") — " + syminfo.ticker + " " +
         timeframe.period,
         alert.freq_once_per_bar_close)
if audio and hmaTrendChanged and
     hmaTrendF > 0
    alert("HMA Bullish — " +
         syminfo.ticker + " " +
         timeframe.period,
         alert.freq_once_per_bar_close)
if audio and hmaTrendChanged and
     hmaTrendF < 0
    alert("HMA Bearish — " +
         syminfo.ticker + " " +
         timeframe.period,
         alert.freq_once_per_bar_close)
