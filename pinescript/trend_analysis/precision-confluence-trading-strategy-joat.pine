// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © officialjackofalltrades
//@version=6
strategy("Precision Confluence Trading Strategy [JOAT]", shorttitle="PCT [JOAT]", overlay=true, 
         initial_capital=10000, default_qty_type=strategy.percent_of_equity, 
         default_qty_value=10, commission_type=strategy.commission.percent, 
         commission_value=0.1, slippage=2, max_bars_back=5000)

// ═══════════════════════════════════════════════════════════════════════════════
// PRECISION CONFLUENCE TRADING Strategy [JOAT]
// Elite Multi-Factor Strategy Combining All Professional Indicators
// Integrates CPR Levels, HMA Trend, RSI Divergence, ADX Strength, Volume Confirmation,
// Smart Money Concepts (FVG, Order Blocks, Liquidity Sweeps) & Multi-Timeframe Analysis
// Advanced Risk Management with ATR-Based Stops, Trailing Exits & Position Sizing
// ═══════════════════════════════════════════════════════════════════════════════

// ────────────────────────────────────────────────────────────────────────────────
// INPUTS
// ────────────────────────────────────────────────────────────────────────────────

// Strategy Settings
strategyGroup = "Strategy Settings"
useMultiTimeframe = input.bool(false, "Use Multi-Timeframe Confirmation", group=strategyGroup)
useDivergence = input.bool(true, "Use Divergence Signals", group=strategyGroup)
useSMC = input.bool(true, "Use Smart Money Concepts", group=strategyGroup)
useVolume = input.bool(true, "Use Volume Confirmation", group=strategyGroup)
useCPR = input.bool(true, "Use CPR Levels", group=strategyGroup)
useWaveTrend = input.bool(true, "Use WaveTrend Signals", group=strategyGroup)
useHMAAlignment = input.bool(true, "Use HMA Ribbon Alignment", group=strategyGroup)
useSessionFilter = input.bool(false, "Use Session Filters", group=strategyGroup)
minConfluenceScore = input.int(50, "Minimum Confluence Score %", minval=30, maxval=100, group=strategyGroup)

// Risk Management
riskGroup = "Risk Management"
riskPercent = input.float(2.0, "Risk Per Trade %", minval=0.1, maxval=10, step=0.1, group=riskGroup)
rewardRatio = input.float(2.5, "Reward:Risk Ratio", minval=1.0, maxval=5.0, step=0.1, group=riskGroup)
useTrailingStop = input.bool(true, "Use Trailing Stop", group=riskGroup)
trailOffset = input.float(2.0, "Trailing Stop %", minval=0.1, maxval=5.0, step=0.1, group=riskGroup)
useBreakeven = input.bool(true, "Move to Breakeven", group=riskGroup)
breakevenTrigger = input.float(1.2, "Breakeven Trigger R:R", minval=0.5, maxval=3.0, step=0.1, group=riskGroup)
atrMultiplier = input.float(1.5, "ATR Stop Multiplier", minval=0.5, maxval=5.0, step=0.1, group=riskGroup)

// Indicator Parameters
indicatorGroup = "Indicator Parameters"
rsiLength = input.int(14, "RSI Length", minval=2, group=indicatorGroup)
adxLength = input.int(14, "ADX Length", minval=1, group=indicatorGroup)
adxThreshold = input.int(20, "ADX Threshold", minval=10, group=indicatorGroup)
volMaLength = input.int(20, "Volume MA Length", minval=1, group=indicatorGroup)
hmaLength = input.int(21, "HMA Length", minval=1, group=indicatorGroup)
wtChannelLen = input.int(10, "WaveTrend Channel Length", minval=1, group=indicatorGroup)
wtAverageLen = input.int(21, "WaveTrend Average Length", minval=1, group=indicatorGroup)

// Session Settings
sessionGroup = "Session Settings"
londonSession = input.session("0300-1200", "London Session", group=sessionGroup)
nySession = input.session("0830-1700", "NY Session", group=sessionGroup)

// ────────────────────────────────────────────────────────────────────────────────
// COLOR DEFINITIONS
// ────────────────────────────────────────────────────────────────────────────────

strongBullColor = color.rgb(0, 255, 0)
weakBullColor = color.rgb(129, 199, 132)
strongBearColor = color.rgb(255, 0, 0)
weakBearColor = color.rgb(229, 115, 115)
neutralColor = color.rgb(158, 158, 158)
entryColor = color.rgb(0, 255, 0)
exitColor = color.rgb(255, 0, 0)
cprColor = color.rgb(255, 235, 59)
volumeColor = color.rgb(255, 152, 0)

// ────────────────────────────────────────────────────────────────────────────────
// ENHANCED CPR CALCULATIONS (FROM INDICATOR 1)
// ────────────────────────────────────────────────────────────────────────────────

calcCPR(h, l, c) =>
    pivot = (h + l + c) / 3
    bc = (h + l) / 2
    tc = (pivot - bc) + pivot
    [pivot, bc, tc]

// Daily CPR
dHigh = request.security(syminfo.tickerid, "D", high[1], lookahead=barmerge.lookahead_on)
dLow = request.security(syminfo.tickerid, "D", low[1], lookahead=barmerge.lookahead_on)
dClose = request.security(syminfo.tickerid, "D", close[1], lookahead=barmerge.lookahead_on)
[dPivot, dBC, dTC] = calcCPR(dHigh, dLow, dClose)

// Weekly CPR
wHigh = request.security(syminfo.tickerid, "W", high[1], lookahead=barmerge.lookahead_on)
wLow = request.security(syminfo.tickerid, "W", low[1], lookahead=barmerge.lookahead_on)
wClose = request.security(syminfo.tickerid, "W", close[1], lookahead=barmerge.lookahead_on)
[wPivot, wBC, wTC] = calcCPR(wHigh, wLow, wClose)

// CPR Width Analysis
dCPRWidth = ((dTC - dBC) / dPivot) * 100
wCPRWidth = ((wTC - wBC) / wPivot) * 100

// CPR Position Analysis
cprBullish = close > dPivot and close > wPivot
cprBearish = close < dPivot and close < wPivot
cprNarrow = dCPRWidth < 0.5  // Narrow CPR indicates potential breakout
cprWide = dCPRWidth > 1.5    // Wide CPR indicates ranging market

// Distance from CPR levels
distFromDailyPivot = ((close - dPivot) / dPivot) * 100
distFromWeeklyPivot = ((close - wPivot) / wPivot) * 100

// ────────────────────────────────────────────────────────────────────────────────
// ENHANCED HMA RIBBON SYSTEM (FROM INDICATOR 7)
// ────────────────────────────────────────────────────────────────────────────────

hullMA(src, length) =>
    wma1 = ta.wma(src, length / 2)
    wma2 = ta.wma(src, length)
    ta.wma(2 * wma1 - wma2, int(math.sqrt(length)))

// Multiple HMAs for ribbon
hma8 = hullMA(close, 8)
hma13 = hullMA(close, 13)
hma21 = hullMA(close, 21)
hma34 = hullMA(close, 34)
hma55 = hullMA(close, 55)

// HMA Alignment Check
hmaFullBullish = hma8 > hma13 and hma13 > hma21 and hma21 > hma34 and hma34 > hma55
hmaFullBearish = hma8 < hma13 and hma13 < hma21 and hma21 < hma34 and hma34 < hma55
hmaBullish = close > hma21 and hma21 > hma21[1]
hmaBearish = close < hma21 and hma21 < hma21[1]

// EMA Cloud
emaFast = ta.ema(close, 9)
emaSlow = ta.ema(close, 21)
emaCloudBullish = emaFast > emaSlow
emaCloudBearish = emaFast < emaSlow

// Key Moving Averages
sma50 = ta.sma(close, 50)
sma200 = ta.sma(close, 200)
goldenCross = sma50 > sma200
deathCross = sma50 < sma200

// ────────────────────────────────────────────────────────────────────────────────
// WAVETREND OSCILLATOR (FROM INDICATOR 2)
// ────────────────────────────────────────────────────────────────────────────────

calcWaveTrend(src, chlen, avglen) =>
    esa = ta.ema(src, chlen)
    d = ta.ema(math.abs(src - esa), chlen)
    ci = (src - esa) / (0.015 * d)
    tci = ta.ema(ci, avglen)
    wt1 = tci
    wt2 = ta.sma(wt1, 4)
    [wt1, wt2]

[wt1, wt2] = calcWaveTrend(hlc3, wtChannelLen, wtAverageLen)

// WaveTrend Signals
wtCross = ta.cross(wt1, wt2)
wtCrossUp = ta.crossover(wt1, wt2)
wtCrossDown = ta.crossunder(wt1, wt2)
wtOverbought = wt1 > 60
wtOversold = wt1 < -60
wtExtremeOverbought = wt1 > 80
wtExtremeOversold = wt1 < -80

// WaveTrend Divergence
wtPivotHigh = ta.pivothigh(wt1, 5, 5)
wtPivotLow = ta.pivotlow(wt1, 5, 5)

var float lastWTPivotHighVal = na
var float lastWTPivotHighPrice = na
var float lastWTPivotLowVal = na
var float lastWTPivotLowPrice = na

wtBullDiv = false
wtBearDiv = false

if not na(wtPivotHigh)
    currentHighPrice = high[5]
    currentHighWT = wt1[5]
    if not na(lastWTPivotHighPrice)
        wtBearDiv := currentHighPrice > lastWTPivotHighPrice and currentHighWT < lastWTPivotHighVal
    lastWTPivotHighVal := currentHighWT
    lastWTPivotHighPrice := currentHighPrice

if not na(wtPivotLow)
    currentLowPrice = low[5]
    currentLowWT = wt1[5]
    if not na(lastWTPivotLowPrice)
        wtBullDiv := currentLowPrice < lastWTPivotLowPrice and currentLowWT > lastWTPivotLowVal
    lastWTPivotLowVal := currentLowWT
    lastWTPivotLowPrice := currentLowPrice

// WaveTrend Momentum
wtMomentum = wt1 - wt2
wtMomentumBullish = wtMomentum > 0 and wtMomentum > wtMomentum[1]
wtMomentumBearish = wtMomentum < 0 and wtMomentum < wtMomentum[1]

// ────────────────────────────────────────────────────────────────────────────────
// MULTI-OSCILLATOR DIVERGENCE SYSTEM (FROM INDICATOR 4)
// ────────────────────────────────────────────────────────────────────────────────

// RSI
rsi = ta.rsi(close, rsiLength)
rsiOversold = rsi < 30
rsiOverbought = rsi > 70

// Stochastic RSI
stochRSI = ta.stoch(rsi, rsi, rsi, 14)

// MACD
[macdLine, macdSignal, macdHist] = ta.macd(close, 12, 26, 9)

// CCI
cci = ta.cci(close, 20)

// Composite Oscillator
compositeOsc = (rsi + stochRSI + ((macdHist + 100) / 2) + ((cci + 200) / 4)) / 4

// RSI Divergence
pivotLookback = 5
rsiPivotHigh = ta.pivothigh(rsi, pivotLookback, pivotLookback)
rsiPivotLow = ta.pivotlow(rsi, pivotLookback, pivotLookback)

var float lastRSIPivotHighVal = na
var float lastRSIPivotHighPrice = na
var float lastRSIPivotLowVal = na
var float lastRSIPivotLowPrice = na

rsiBullDiv = false
rsiBearDiv = false

if not na(rsiPivotHigh)
    currentHighPrice = high[pivotLookback]
    currentHighRSI = rsi[pivotLookback]
    if not na(lastRSIPivotHighPrice)
        rsiBearDiv := currentHighPrice > lastRSIPivotHighPrice and currentHighRSI < lastRSIPivotHighVal
    lastRSIPivotHighVal := currentHighRSI
    lastRSIPivotHighPrice := currentHighPrice

if not na(rsiPivotLow)
    currentLowPrice = low[pivotLookback]
    currentLowRSI = rsi[pivotLookback]
    if not na(lastRSIPivotLowPrice)
        rsiBullDiv := currentLowPrice < lastRSIPivotLowPrice and currentLowRSI > lastRSIPivotLowVal
    lastRSIPivotLowVal := currentLowRSI
    lastRSIPivotLowPrice := currentLowPrice

// Combined Divergence Signal
bullishDivergence = rsiBullDiv or wtBullDiv
bearishDivergence = rsiBearDiv or wtBearDiv
strongBullDiv = rsiBullDiv and wtBullDiv
strongBearDiv = rsiBearDiv and wtBearDiv

// ────────────────────────────────────────────────────────────────────────────────
// ADX & TREND STRENGTH
// ────────────────────────────────────────────────────────────────────────────────

[plus, minus, adx] = ta.dmi(adxLength, adxLength)
strongTrend = adx > adxThreshold
trendBullish = plus > minus
trendBearish = minus > plus

// ────────────────────────────────────────────────────────────────────────────────
// ENHANCED VOLUME ANALYSIS (FROM INDICATOR 6)
// ────────────────────────────────────────────────────────────────────────────────

volMA = ta.sma(volume, volMaLength)
highVolume = volume > volMA * 1.5
climaxVolume = volume > volMA * 3.0
bullishVolume = close > open and highVolume
bearishVolume = close < open and highVolume

// Volume Delta
buyVolume = close > open ? volume : 0
sellVolume = close < open ? volume : 0
volumeDelta = ta.cum(buyVolume) - ta.cum(sellVolume)
volumeDeltaMA = ta.sma(volumeDelta, 20)
deltaRising = volumeDelta > volumeDeltaMA
deltaFalling = volumeDelta < volumeDeltaMA

// Volume Confirmation
volConfirmedBull = bullishVolume and deltaRising
volConfirmedBear = bearishVolume and deltaFalling

// ────────────────────────────────────────────────────────────────────────────────
// ENHANCED SMART MONEY CONCEPTS (FROM INDICATOR 5)
// ────────────────────────────────────────────────────────────────────────────────

// Fair Value Gap with size calculation
bullishFVG = low > high[2] and close[1] > high[2]
fvgBullSize = bullishFVG ? ((low - high[2]) / high[2]) * 100 : 0
bearishFVG = high < low[2] and close[1] < low[2]
fvgBearSize = bearishFVG ? ((low[2] - high) / high) * 100 : 0

// Significant FVG (larger gaps are more important)
significantBullFVG = bullishFVG and fvgBullSize > 0.3
significantBearFVG = bearishFVG and fvgBearSize > 0.3

// Order Blocks with volume confirmation
bullishOB = close[2] < open[2] and close[1] < open[1] and close > open and highVolume
bearishOB = close[2] > open[2] and close[1] > open[1] and close < open and highVolume

// Breaker Blocks (failed order blocks)
var float lastBullOBHigh = na
var float lastBearOBLow = na

if bullishOB
    lastBullOBHigh := high[1]
if bearishOB
    lastBearOBLow := low[1]

breakerBull = not na(lastBearOBLow) and close > lastBearOBLow and close[1] <= lastBearOBLow
breakerBear = not na(lastBullOBHigh) and close < lastBullOBHigh and close[1] >= lastBullOBHigh

// Liquidity Sweeps with volume confirmation
lookbackBars = 20
recentHigh = ta.highest(high, lookbackBars)
recentLow = ta.lowest(low, lookbackBars)
liquiditySweepHigh = high > recentHigh[1] and close < recentHigh[1]
liquiditySweepLow = low < recentLow[1] and close > recentLow[1]
volConfirmedSweepHigh = liquiditySweepHigh and highVolume
volConfirmedSweepLow = liquiditySweepLow and highVolume

// Displacement (strong institutional move)
atr = ta.atr(14)
displacement = math.abs(close - open) > atr * 2 and climaxVolume
bullishDisplacement = displacement and close > open
bearishDisplacement = displacement and close < open

// SMC Confluence Score
smcBullScore = (significantBullFVG ? 2 : 0) + (bullishOB ? 2 : 0) + (breakerBull ? 1 : 0) + 
               (volConfirmedSweepLow ? 2 : 0) + (bullishDisplacement ? 3 : 0)
smcBearScore = (significantBearFVG ? 2 : 0) + (bearishOB ? 2 : 0) + (breakerBear ? 1 : 0) + 
               (volConfirmedSweepHigh ? 2 : 0) + (bearishDisplacement ? 3 : 0)

// ────────────────────────────────────────────────────────────────────────────────
// SESSION FILTERS (FROM INDICATOR 6)
// ────────────────────────────────────────────────────────────────────────────────

inLondonSession = not na(time(timeframe.period, londonSession))
inNYSession = not na(time(timeframe.period, nySession))
inTradingSession = inLondonSession or inNYSession

// ────────────────────────────────────────────────────────────────────────────────
// MULTI-TIMEFRAME CONFIRMATION (FROM INDICATOR 3)
// ────────────────────────────────────────────────────────────────────────────────

htfTrend() =>
    htfClose = close
    htfHMA = hullMA(htfClose, 21)
    [htfPlus, htfMinus, htfADX] = ta.dmi(14, 14)
    htfTrendDir = htfClose > htfHMA ? 1 : -1
    htfStrong = htfADX > 20
    [htfTrendDir, htfStrong]

[htf15mDir, htf15mStrong] = request.security(syminfo.tickerid, "15", htfTrend())
[htf1hDir, htf1hStrong] = request.security(syminfo.tickerid, "60", htfTrend())
[htf4hDir, htf4hStrong] = request.security(syminfo.tickerid, "240", htfTrend())

mtfBullish = htf15mDir == 1 and htf1hDir == 1 and htf4hDir == 1
mtfBearish = htf15mDir == -1 and htf1hDir == -1 and htf4hDir == -1
mtfStrongBullish = mtfBullish and htf15mStrong and htf1hStrong and htf4hStrong
mtfStrongBearish = mtfBearish and htf15mStrong and htf1hStrong and htf4hStrong

// ────────────────────────────────────────────────────────────────────────────────
// COMPREHENSIVE CONFLUENCE SCORING SYSTEM
// ────────────────────────────────────────────────────────────────────────────────

// Calculate individual component scores (0-100 scale)

// 1. CPR Score (0-15 points)
cprBullScore = 0
cprBullScore := cprBullScore + (cprBullish ? 10 : 0)
cprBullScore := cprBullScore + (close > dTC ? 3 : 0)
cprBullScore := cprBullScore + (cprNarrow ? 2 : 0)

cprBearScore = 0
cprBearScore := cprBearScore + (cprBearish ? 10 : 0)
cprBearScore := cprBearScore + (close < dBC ? 3 : 0)
cprBearScore := cprBearScore + (cprNarrow ? 2 : 0)

// 2. HMA Ribbon Score (0-15 points)
hmaRibbonBullScore = 0
hmaRibbonBullScore := hmaRibbonBullScore + (hmaBullish ? 5 : 0)
hmaRibbonBullScore := hmaRibbonBullScore + (hmaFullBullish ? 7 : 0)
hmaRibbonBullScore := hmaRibbonBullScore + (emaCloudBullish ? 3 : 0)

hmaRibbonBearScore = 0
hmaRibbonBearScore := hmaRibbonBearScore + (hmaBearish ? 5 : 0)
hmaRibbonBearScore := hmaRibbonBearScore + (hmaFullBearish ? 7 : 0)
hmaRibbonBearScore := hmaRibbonBearScore + (emaCloudBearish ? 3 : 0)

// 3. WaveTrend Score (0-15 points)
wtBullScore = 0
wtBullScore := wtBullScore + (wtCrossUp and wtOversold ? 8 : wtCrossUp ? 5 : 0)
wtBullScore := wtBullScore + (wtBullDiv ? 5 : 0)
wtBullScore := wtBullScore + (wtMomentumBullish ? 2 : 0)

wtBearScore = 0
wtBearScore := wtBearScore + (wtCrossDown and wtOverbought ? 8 : wtCrossDown ? 5 : 0)
wtBearScore := wtBearScore + (wtBearDiv ? 5 : 0)
wtBearScore := wtBearScore + (wtMomentumBearish ? 2 : 0)

// 4. Multi-Oscillator Divergence Score (0-10 points)
divBullScore = 0
divBullScore := divBullScore + (rsiBullDiv ? 5 : 0)
divBullScore := divBullScore + (strongBullDiv ? 5 : 0)

divBearScore = 0
divBearScore := divBearScore + (rsiBearDiv ? 5 : 0)
divBearScore := divBearScore + (strongBearDiv ? 5 : 0)

// 5. ADX Trend Strength Score (0-10 points)
adxBullScore = strongTrend and trendBullish ? 10 : trendBullish ? 5 : 0
adxBearScore = strongTrend and trendBearish ? 10 : trendBearish ? 5 : 0

// 6. Volume Confirmation Score (0-10 points)
volBullScore = 0
volBullScore := volBullScore + (volConfirmedBull ? 7 : bullishVolume ? 5 : 0)
volBullScore := volBullScore + (climaxVolume and close > open ? 3 : 0)

volBearScore = 0
volBearScore := volBearScore + (volConfirmedBear ? 7 : bearishVolume ? 5 : 0)
volBearScore := volBearScore + (climaxVolume and close < open ? 3 : 0)

// 7. Smart Money Concepts Score (0-10 points) - already calculated as smcBullScore/smcBearScore

// 8. Multi-Timeframe Score (0-15 points)
mtfBullScore = 0
mtfBullScore := mtfBullScore + (mtfStrongBullish ? 15 : mtfBullish ? 10 : htf1hDir == 1 ? 5 : 0)

mtfBearScore = 0
mtfBearScore := mtfBearScore + (mtfStrongBearish ? 15 : mtfBearish ? 10 : htf1hDir == -1 ? 5 : 0)

// 9. Key MA Score (0-10 points)
maBullScore = 0
maBullScore := maBullScore + (close > sma50 ? 3 : 0)
maBullScore := maBullScore + (close > sma200 ? 4 : 0)
maBullScore := maBullScore + (goldenCross ? 3 : 0)

maBearScore = 0
maBearScore := maBearScore + (close < sma50 ? 3 : 0)
maBearScore := maBearScore + (close < sma200 ? 4 : 0)
maBearScore := maBearScore + (deathCross ? 3 : 0)

// TOTAL CONFLUENCE SCORE (0-100)
bullConfluenceScore = (useCPR ? cprBullScore : 0) + 
                      (useHMAAlignment ? hmaRibbonBullScore : 0) + 
                      (useWaveTrend ? wtBullScore : 0) + 
                      (useDivergence ? divBullScore : 0) + 
                      adxBullScore + 
                      (useVolume ? volBullScore : 0) + 
                      (useSMC ? smcBullScore : 0) + 
                      (useMultiTimeframe ? mtfBullScore : 0) + 
                      maBullScore

bearConfluenceScore = (useCPR ? cprBearScore : 0) + 
                      (useHMAAlignment ? hmaRibbonBearScore : 0) + 
                      (useWaveTrend ? wtBearScore : 0) + 
                      (useDivergence ? divBearScore : 0) + 
                      adxBearScore + 
                      (useVolume ? volBearScore : 0) + 
                      (useSMC ? smcBearScore : 0) + 
                      (useMultiTimeframe ? mtfBearScore : 0) + 
                      maBearScore

// Entry Signals with Confluence Threshold and Session Filter
sessionFilter = useSessionFilter ? inTradingSession : true

// More aggressive entry conditions
strongLongSignal = bullConfluenceScore >= 70 and bearConfluenceScore < 40 and sessionFilter
strongShortSignal = bearConfluenceScore >= 70 and bullConfluenceScore < 40 and sessionFilter

// Medium strength signals
mediumLongSignal = bullConfluenceScore >= 55 and bullConfluenceScore > bearConfluenceScore + 15 and sessionFilter and not strongLongSignal
mediumShortSignal = bearConfluenceScore >= 55 and bearConfluenceScore > bullConfluenceScore + 15 and sessionFilter and not strongShortSignal

// Combined signals
longSignal = (strongLongSignal or mediumLongSignal) and bullConfluenceScore >= minConfluenceScore
shortSignal = (strongShortSignal or mediumShortSignal) and bearConfluenceScore >= minConfluenceScore

// ULTRA Signals (85+ confluence with strong momentum)
ultraLongSignal = bullConfluenceScore >= 85 and bearConfluenceScore < 25 and (wtCrossUp or rsiBullDiv or bullishDisplacement)
ultraShortSignal = bearConfluenceScore >= 85 and bullConfluenceScore < 25 and (wtCrossDown or rsiBearDiv or bearishDisplacement)

// ────────────────────────────────────────────────────────────────────────────────
// ENHANCED POSITION SIZING & RISK MANAGEMENT
// ────────────────────────────────────────────────────────────────────────────────

// Calculate ATR for stop loss
stopLossDistance = atr * atrMultiplier

// Dynamic stop adjustment based on signal strength
dynamicStopMultiplier = ultraLongSignal or ultraShortSignal ? atrMultiplier * 0.8 : strongLongSignal or strongShortSignal ? atrMultiplier : atrMultiplier * 1.2

// Calculate position size based on risk
accountSize = strategy.equity
riskAmount = accountSize * (riskPercent / 100)
positionSize = riskAmount / stopLossDistance

// Dynamic stop loss based on market structure and recent swing points
swingLowLookback = 10
swingHighLookback = 10
recentSwingLow = ta.lowest(low, swingLowLookback)
recentSwingHigh = ta.highest(high, swingHighLookback)

dynamicStopBull = math.min(close - (atr * dynamicStopMultiplier), recentSwingLow - (atr * 0.2))
dynamicStopBear = math.max(close + (atr * dynamicStopMultiplier), recentSwingHigh + (atr * 0.2))

// ────────────────────────────────────────────────────────────────────────────────
// ENHANCED STRATEGY EXECUTION
// ────────────────────────────────────────────────────────────────────────────────

// Track entry price for breakeven
var float entryPrice = na
var bool movedToBreakeven = false

// Long Entry
if longSignal and strategy.position_size == 0
    stopLoss = dynamicStopBull
    stopDistance = close - stopLoss
    takeProfit = close + (stopDistance * rewardRatio)
    strategy.entry("Long", strategy.long)
    strategy.exit("Long Exit", "Long", stop=stopLoss, limit=takeProfit)
    
    entryPrice := close
    movedToBreakeven := false
    
    labelText = ultraLongSignal ? "ULTRA LONG\n" + str.tostring(bullConfluenceScore) : strongLongSignal ? "STRONG LONG\n" + str.tostring(bullConfluenceScore) : "LONG\n" + str.tostring(bullConfluenceScore)
    labelColor = ultraLongSignal ? color.new(strongBullColor, 0) : strongLongSignal ? color.new(weakBullColor, 0) : color.new(entryColor, 20)
    labelSize = ultraLongSignal ? size.large : strongLongSignal ? size.normal : size.small
    
    label.new(bar_index, low, labelText, style=label.style_label_up, color=labelColor, textcolor=color.white, size=labelSize)

// Short Entry
if shortSignal and strategy.position_size == 0
    stopLoss = dynamicStopBear
    stopDistance = stopLoss - close
    takeProfit = close - (stopDistance * rewardRatio)
    strategy.entry("Short", strategy.short)
    strategy.exit("Short Exit", "Short", stop=stopLoss, limit=takeProfit)
    
    entryPrice := close
    movedToBreakeven := false
    
    labelText = ultraShortSignal ? "ULTRA SHORT\n" + str.tostring(bearConfluenceScore) : strongShortSignal ? "STRONG SHORT\n" + str.tostring(bearConfluenceScore) : "SHORT\n" + str.tostring(bearConfluenceScore)
    labelColor = ultraShortSignal ? color.new(strongBearColor, 0) : strongShortSignal ? color.new(weakBearColor, 0) : color.new(exitColor, 20)
    labelSize = ultraShortSignal ? size.large : strongShortSignal ? size.normal : size.small
    
    label.new(bar_index, high, labelText, style=label.style_label_down, color=labelColor, textcolor=color.white, size=labelSize)

// Breakeven Management
if useBreakeven and strategy.position_size > 0 and not movedToBreakeven
    stopDistance = entryPrice - dynamicStopBull
    if close >= entryPrice + (stopDistance * breakevenTrigger)
        newStop = entryPrice + (stopDistance * 0.1)
        newTP = entryPrice + (stopDistance * rewardRatio)
        strategy.exit("Long Exit", "Long", stop=newStop, limit=newTP)
        movedToBreakeven := true
        label.new(bar_index, low, "BE", style=label.style_label_up, color=color.new(color.blue, 0), textcolor=color.white, size=size.tiny)

if useBreakeven and strategy.position_size < 0 and not movedToBreakeven
    stopDistance = dynamicStopBear - entryPrice
    if close <= entryPrice - (stopDistance * breakevenTrigger)
        newStop = entryPrice - (stopDistance * 0.1)
        newTP = entryPrice - (stopDistance * rewardRatio)
        strategy.exit("Short Exit", "Short", stop=newStop, limit=newTP)
        movedToBreakeven := true
        label.new(bar_index, high, "BE", style=label.style_label_down, color=color.new(color.blue, 0), textcolor=color.white, size=size.tiny)

// ────────────────────────────────────────────────────────────────────────────────
// ENHANCED PLOTTING
// ────────────────────────────────────────────────────────────────────────────────

// CPR Levels - Clean lines only
plot(useCPR ? dPivot : na, "Daily Pivot", color.new(cprColor, 0), 2, plot.style_line)
plot(useCPR ? dTC : na, "Daily TC", color.new(cprColor, 60), 1, plot.style_line)
plot(useCPR ? dBC : na, "Daily BC", color.new(cprColor, 60), 1, plot.style_line)

// HMA Ribbon with gradient colors
hmaColor1 = color.rgb(0, 255, 0)
hmaColor2 = color.rgb(102, 255, 102)
hmaColor3 = color.rgb(255, 255, 0)
hmaColor4 = color.rgb(255, 153, 0)
hmaColor5 = color.rgb(255, 0, 0)

hma8Plot = plot(hma8, "HMA 8", color.new(hmaColor1, 50), 2)
hma13Plot = plot(hma13, "HMA 13", color.new(hmaColor2, 50), 2)
hma21Plot = plot(hma21, "HMA 21", color.new(hmaColor3, 50), 2)
hma34Plot = plot(hma34, "HMA 34", color.new(hmaColor4, 50), 2)
hma55Plot = plot(hma55, "HMA 55", color.new(hmaColor5, 50), 2)

// HMA Ribbon Fills
ribbonTransparency = 85
fill(hma8Plot, hma13Plot, color.new(hmaColor1, ribbonTransparency), title="HMA Fill 1-2")
fill(hma13Plot, hma21Plot, color.new(hmaColor2, ribbonTransparency), title="HMA Fill 2-3")
fill(hma21Plot, hma34Plot, color.new(hmaColor3, ribbonTransparency), title="HMA Fill 3-4")
fill(hma34Plot, hma55Plot, color.new(hmaColor4, ribbonTransparency), title="HMA Fill 4-5")

// EMA Cloud
emaFastPlot = plot(emaFast, "EMA 9", color.new(emaCloudBullish ? strongBullColor : strongBearColor, 60), 1)
emaSlowPlot = plot(emaSlow, "EMA 21", color.new(emaCloudBullish ? strongBullColor : strongBearColor, 60), 1)
fill(emaFastPlot, emaSlowPlot, color.new(emaCloudBullish ? strongBullColor : strongBearColor, 90), title="EMA Cloud")

// Key MAs
plot(sma50, "SMA 50", color.new(color.blue, 40), 2)
plot(sma200, "SMA 200", color.new(color.orange, 40), 3)

// Signal Strength Visualization with Gradient
confluenceGradient = bullConfluenceScore > bearConfluenceScore ? color.from_gradient(bullConfluenceScore, 50, 100, color.new(weakBullColor, 95), color.new(strongBullColor, 85)) : color.from_gradient(bearConfluenceScore, 50, 100, color.new(weakBearColor, 95), color.new(strongBearColor, 85))

bgcolor(longSignal or shortSignal ? confluenceGradient : na, title="Signal BG")

// ULTRA Signal Markers
plotshape(ultraLongSignal ? low : na, "ULTRA Long", shape.diamond, location.belowbar, 
         color.new(strongBullColor, 0), size=size.large)
plotshape(ultraShortSignal ? high : na, "ULTRA Short", shape.diamond, location.abovebar, 
         color.new(strongBearColor, 0), size=size.large)

// ────────────────────────────────────────────────────────────────────────────────
// COMPREHENSIVE INFORMATION TABLE
// ────────────────────────────────────────────────────────────────────────────────

var table perfTable = table.new(position.bottom_right, 3, 12,
                                 bgcolor=color.new(color.black, 85),
                                 frame_color=color.new(color.gray, 50),
                                 frame_width=2,
                                 border_width=1,
                                 border_color=color.new(color.gray, 50))

if barstate.islast
    // Header
    table.cell(perfTable, 0, 0, "Component", bgcolor=color.new(color.gray, 70), text_color=color.white, text_size=size.small)
    table.cell(perfTable, 1, 0, "Bull", bgcolor=color.new(color.gray, 70), text_color=color.white, text_size=size.small)
    table.cell(perfTable, 2, 0, "Bear", bgcolor=color.new(color.gray, 70), text_color=color.white, text_size=size.small)
    
    // Position Status
    table.cell(perfTable, 0, 1, "Position", text_color=color.white, text_size=size.small)
    posText = strategy.position_size > 0 ? "LONG" : strategy.position_size < 0 ? "SHORT" : "FLAT"
    posColor = strategy.position_size > 0 ? color.new(strongBullColor, 30) : strategy.position_size < 0 ? color.new(strongBearColor, 30) : color.new(neutralColor, 70)
    table.cell(perfTable, 1, 1, posText, bgcolor=posColor, text_color=color.white, text_size=size.small)
    table.merge_cells(perfTable, 1, 1, 2, 1)
    
    // Confluence Scores
    table.cell(perfTable, 0, 2, "CONFLUENCE", text_color=color.yellow, text_size=size.small)
    bullScoreColor = bullConfluenceScore >= 90 ? color.new(strongBullColor, 20) : bullConfluenceScore >= 70 ? color.new(weakBullColor, 30) : color.new(neutralColor, 70)
    bearScoreColor = bearConfluenceScore >= 90 ? color.new(strongBearColor, 20) : bearConfluenceScore >= 70 ? color.new(weakBearColor, 30) : color.new(neutralColor, 70)
    table.cell(perfTable, 1, 2, str.tostring(bullConfluenceScore, "#"), bgcolor=bullScoreColor, text_color=color.white, text_size=size.normal)
    table.cell(perfTable, 2, 2, str.tostring(bearConfluenceScore, "#"), bgcolor=bearScoreColor, text_color=color.white, text_size=size.normal)
    
    // Individual Components
    table.cell(perfTable, 0, 3, "CPR", text_color=cprColor, text_size=size.tiny)
    table.cell(perfTable, 1, 3, str.tostring(cprBullScore), text_color=color.white, text_size=size.tiny)
    table.cell(perfTable, 2, 3, str.tostring(cprBearScore), text_color=color.white, text_size=size.tiny)
    
    table.cell(perfTable, 0, 4, "HMA Ribbon", text_color=color.white, text_size=size.tiny)
    table.cell(perfTable, 1, 4, str.tostring(hmaRibbonBullScore), text_color=color.white, text_size=size.tiny)
    table.cell(perfTable, 2, 4, str.tostring(hmaRibbonBearScore), text_color=color.white, text_size=size.tiny)
    
    table.cell(perfTable, 0, 5, "WaveTrend", text_color=color.white, text_size=size.tiny)
    table.cell(perfTable, 1, 5, str.tostring(wtBullScore), text_color=color.white, text_size=size.tiny)
    table.cell(perfTable, 2, 5, str.tostring(wtBearScore), text_color=color.white, text_size=size.tiny)
    
    table.cell(perfTable, 0, 6, "Divergence", text_color=color.white, text_size=size.tiny)
    table.cell(perfTable, 1, 6, str.tostring(divBullScore), text_color=color.white, text_size=size.tiny)
    table.cell(perfTable, 2, 6, str.tostring(divBearScore), text_color=color.white, text_size=size.tiny)
    
    table.cell(perfTable, 0, 7, "ADX", text_color=color.white, text_size=size.tiny)
    table.cell(perfTable, 1, 7, str.tostring(adxBullScore), text_color=color.white, text_size=size.tiny)
    table.cell(perfTable, 2, 7, str.tostring(adxBearScore), text_color=color.white, text_size=size.tiny)
    
    table.cell(perfTable, 0, 8, "Volume", text_color=volumeColor, text_size=size.tiny)
    table.cell(perfTable, 1, 8, str.tostring(volBullScore), text_color=color.white, text_size=size.tiny)
    table.cell(perfTable, 2, 8, str.tostring(volBearScore), text_color=color.white, text_size=size.tiny)
    
    table.cell(perfTable, 0, 9, "SMC", text_color=color.white, text_size=size.tiny)
    table.cell(perfTable, 1, 9, str.tostring(smcBullScore), text_color=color.white, text_size=size.tiny)
    table.cell(perfTable, 2, 9, str.tostring(smcBearScore), text_color=color.white, text_size=size.tiny)
    
    table.cell(perfTable, 0, 10, "MTF", text_color=color.white, text_size=size.tiny)
    table.cell(perfTable, 1, 10, str.tostring(mtfBullScore), text_color=color.white, text_size=size.tiny)
    table.cell(perfTable, 2, 10, str.tostring(mtfBearScore), text_color=color.white, text_size=size.tiny)
    
    // Equity
    table.cell(perfTable, 0, 11, "Equity", text_color=color.white, text_size=size.small)
    equityText = "$" + str.tostring(strategy.equity, "#,###")
    equityColor = strategy.equity > strategy.initial_capital ? color.new(strongBullColor, 30) : color.new(strongBearColor, 30)
    pnlPercent = ((strategy.equity - strategy.initial_capital) / strategy.initial_capital) * 100
    pnlText = str.tostring(pnlPercent, "#.##") + "%"
    table.cell(perfTable, 1, 11, equityText + "\n" + pnlText, bgcolor=equityColor, text_color=color.white, text_size=size.small)
    table.merge_cells(perfTable, 1, 11, 2, 11)
