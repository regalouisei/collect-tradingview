//@version=5
indicator("Smart Money: Auto Order Blocks [identityKa]", overlay=true, max_boxes_count=10)

// ==========================================
// 1. KULLANICI AYARLARI (SADE VE ANLAÅžILIR)
// ==========================================
grp1 = "âš™ï¸ Algoritma AyarlarÄ±"
prd = input.int(5, title="Pivot Hassasiyeti (Swing)", minval=2, maxval=20, group=grp1, tooltip="DÃ¼ÅŸÃ¼k deÄŸerler daha sÄ±k, yÃ¼ksek deÄŸerler daha majÃ¶r bÃ¶lgeleri bulur.")

grp2 = "ðŸŽ¨ identityKa GÃ¶rsel Tema"
bull_col = input.color(color.new(#00ffbb, 85), title="Bullish OB (Destek) Rengi", group=grp2)
bear_col = input.color(color.new(#ff1744, 85), title="Bearish OB (DirenÃ§) Rengi", group=grp2)
show_text = input.bool(true, title="Kutu Ä°simlerini GÃ¶ster", group=grp2)

// ==========================================
// 2. FÄ°YAT HAREKETÄ° VE PÄ°VOT TESPÄ°TÄ°
// ==========================================
ph = ta.pivothigh(high, prd, prd)
pl = ta.pivotlow(low, prd, prd)

// KutularÄ± hafÄ±zada tutmak iÃ§in diziler (Sadece son 2 kutuyu tutacaÄŸÄ±z ki grafik temiz kalsÄ±n)
var box[] bull_boxes = array.new_box()
var box[] bear_boxes = array.new_box()

// ==========================================
// 3. BEARISH ORDER BLOCK (DÄ°RENÃ‡ - KIRMIZI)
// ==========================================
// Fiyat dÃ¼ÅŸmeden Ã¶nceki son tepe noktasÄ±
if not na(ph)
    top = high[prd]
    bot = math.max(open[prd], close[prd]) // Fitil ucu ile gÃ¶vde arasÄ±
    
    // Yeni Kutu Ã‡iz
    bx = box.new(left=bar_index[prd], top=top, right=bar_index + 10, bottom=bot, border_color=na, bgcolor=bear_col)
    
    if show_text
        box.set_text(bx, "Bearish OB")
        box.set_text_color(bx, color.new(color.red, 30))
        box.set_text_halign(bx, text.align_right)
        box.set_text_valign(bx, text.align_bottom)
        box.set_text_size(bx, size.small)
        
    array.push(bear_boxes, bx)
    
    // Eski kutularÄ± sil (Sadece son 2 kalsÄ±n)
    if array.size(bear_boxes) > 2 
        box.delete(array.shift(bear_boxes))

// ==========================================
// 4. BULLISH ORDER BLOCK (DESTEK - YEÅžÄ°L)
// ==========================================
// Fiyat yÃ¼kselmeden Ã¶nceki son dip noktasÄ±
if not na(pl)
    top = math.min(open[prd], close[prd]) // Fitil ucu ile gÃ¶vde arasÄ±
    bot = low[prd]
    
    bx = box.new(left=bar_index[prd], top=top, right=bar_index + 10, bottom=bot, border_color=na, bgcolor=bull_col)
    
    if show_text
        box.set_text(bx, "Bullish OB")
        box.set_text_color(bx, color.new(color.green, 30))
        box.set_text_halign(bx, text.align_right)
        box.set_text_valign(bx, text.align_top)
        box.set_text_size(bx, size.small)

    array.push(bull_boxes, bx)
    
    if array.size(bull_boxes) > 2
        box.delete(array.shift(bull_boxes))

// ==========================================
// 5. KUTULARI CANLI OLARAK UZATMA
// ==========================================
if barstate.islast
    for b in bull_boxes
        box.set_right(b, bar_index + 15)
    for b in bear_boxes
        box.set_right(b, bar_index + 15)
