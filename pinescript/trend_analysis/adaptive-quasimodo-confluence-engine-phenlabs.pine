// This work is licensed under a Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0) https://creativecommons.org/licenses/by-nc-sa/4.0/
// Â© PhenLabs
//v2 chart update
//@version=6
indicator('Adaptive Quasimodo + Session Distribution Confluence Engine - PhenLabs', shorttitle = 'QM Confluence - Phen', overlay = true, max_bars_back = 500)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUT PARAMETERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

group_qm = 'QUASIMODO SETTINGS'
swingThreshold = input.int(5, 'Swing Detection Bars', minval = 2, group = group_qm)
qmQualityWeight = input.float(0.6, 'QM Structural Quality Weight (0-1)', minval = 0, maxval = 1, group = group_qm)

group_session = 'SESSION DISTRIBUTION'
sessionOpenTime = input.string('0930', 'Session Open Time (HHMM)', group = group_session)
p25Threshold = input.float(0.25, 'P25 Percentile', minval = 0, maxval = 1, group = group_session)
p50Threshold = input.float(0.50, 'P50 Percentile', minval = 0, maxval = 1, group = group_session)
maeWindowBars = input.int(20, 'MAE Window (bars)', minval = 5, group = group_session)

group_confluence = 'CONFLUENCE ENGINE'
enableConfluence = input.bool(true, 'Enable Confluence Filtering', group = group_confluence)
minConfluenceScore = input.float(0.65, 'Min Confluence Score (0-1)', minval = 0, maxval = 1, group = group_confluence)
displayLabels = input.bool(true, 'Show Labels & Zones', group = group_confluence)
displayScore = input.bool(true, 'Show Confluence Score', group = group_confluence)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE VARIABLES - QUASIMODO STATE MACHINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var float qmSwingHigh = 0.0
var float qmLowerHigh = 0.0
var float qmSwingLow = 0.0
var float qmHigherLow = 0.0
var float qmRetestLevel = 0.0
var bool qmRetestDetected = false
var string qmState = 'INIT'
var float qmStructuralScore = 0.0

// SESSION STATE VARIABLES
var int sessionOpenBar = 0
var float sessionHigh = 0.0
var float sessionLow = 0.0
var float sessionOpen = 0.0
var float sessionDistribution = 0.0

// MAE BUFFER
var array<float> maeBuffer = array.new<float>()

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUASIMODO STATE MACHINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

bool isSwingHigh = high == ta.highest(high, swingThreshold * 2 + 1)
bool isSwingLow = low == ta.lowest(low, swingThreshold * 2 + 1)

// State machine logic
if isSwingHigh
    qmSwingHigh := high
    qmState := 'SH'
    qmState

if qmState == 'SH' and isSwingLow and low < qmSwingHigh
    qmSwingLow := low
    qmState := 'SL'
    qmState

if qmState == 'SL' and isSwingHigh and high > qmSwingLow and high < qmSwingHigh
    qmLowerHigh := high
    qmState := 'LH'
    qmState

if qmState == 'LH' and isSwingLow and low > qmSwingLow
    qmHigherLow := low
    qmState := 'HL'
    qmRetestLevel := qmSwingLow
    qmStructuralScore := 1.0
    qmStructuralScore

// Detect retest of QM level
if qmState == 'HL' and low <= qmRetestLevel and high >= qmRetestLevel
    qmRetestDetected := true
    qmRetestDetected
else
    qmRetestDetected := false
    qmRetestDetected

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SESSION DISTRIBUTION CALCULATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

bool timeCondition = hour * 100 + minute == int(str.tonumber(sessionOpenTime))

if timeCondition
    sessionOpen := open
    sessionOpenBar := bar_index
    sessionHigh := high
    sessionLow := low
    sessionLow

// Track session range development
if bar_index > sessionOpenBar and not timeCondition
    sessionHigh := math.max(sessionHigh, high)
    sessionLow := math.min(sessionLow, low)
    sessionLow

// Calculate session percentile placement
float sessionRange = sessionHigh - sessionLow
if sessionRange > 0
    float distFromOpen = close - sessionOpen
    float percentile = distFromOpen / sessionRange
    sessionDistribution := math.min(math.max(percentile, 0.0), 1.0)
    sessionDistribution

// Calculate P25 & P50 levels
float p25Level = sessionOpen + sessionRange * p25Threshold
float p50Level = sessionOpen + sessionRange * p50Threshold

// Check if QM level is in premium statistical zone (P25-P50)
bool qmInPremiumZone = qmRetestLevel >= p25Level and qmRetestLevel <= p50Level

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAE/MFE ABSORPTION ZONE CALCULATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if bar_index > sessionOpenBar and bar_index <= sessionOpenBar + maeWindowBars
    float mae = sessionOpen - low
    array.push(maeBuffer, mae)

// Calculate MAE zone using percentiles
float maeAvg = 0.0
if array.size(maeBuffer) > 0
    float sum = 0.0
    for i = 0 to array.size(maeBuffer) - 1 by 1
        sum := sum + array.get(maeBuffer, i)
        sum
    maeAvg := sum / array.size(maeBuffer)
    maeAvg

float maeZoneHigh = sessionOpen - maeAvg * 0.5
float maeZoneLow = sessionOpen - maeAvg * 1.5

// Check if retest is within historical MAE absorption zone
bool retestInMaeZone = qmRetestLevel <= maeZoneHigh and qmRetestLevel >= maeZoneLow

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFLUENCE ENGINE - PREMIUM QM RETEST DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Structural quality score (from QM pattern completion)
float structuralScore = qmStructuralScore * qmQualityWeight

// Session percentile score (P25-P50 zone is optimal)
float percentileScore = 0.0
if qmInPremiumZone
    float distFromP25 = qmRetestLevel - p25Level
    float rangeP25toP50 = p50Level - p25Level
    if rangeP25toP50 > 0
        percentileScore := 0.9 + 0.1 * (1.0 - math.abs(distFromP25 - rangeP25toP50 / 2) / (rangeP25toP50 / 2))
        percentileScore
    else
        percentileScore := 0.85
        percentileScore
else
    percentileScore := 0.4
    percentileScore

// MAE alignment score
float maeScore = retestInMaeZone ? 0.95 : 0.50

// CONFLUENCE SCORE = Structural Ã— Percentile Ã— MAE
float confluenceScore = structuralScore * percentileScore * maeScore

// Premium signal only fires if confluence is above threshold
bool premiumQmRetest = qmRetestDetected and confluenceScore >= minConfluenceScore and enableConfluence

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VISUALIZATION & ALERTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Plot QM Levels
plot(qmRetestLevel != 0 ? qmRetestLevel : na, title = 'QM Retest Level', color = color.blue, linewidth = 2)
plot(p25Level != 0 ? p25Level : na, title = 'P25 Level', color = color.purple, linewidth = 1)
plot(p50Level != 0 ? p50Level : na, title = 'P50 Level', color = color.orange, linewidth = 1)

// Plot MAE Zone
plot(maeZoneHigh != 0 ? maeZoneHigh : na, title = 'MAE Zone High', color = color.gray, linewidth = 1)
plot(maeZoneLow != 0 ? maeZoneLow : na, title = 'MAE Zone Low', color = color.gray, linewidth = 1)

// Alert background
color alertColor = premiumQmRetest ? color.new(color.green, 80) : na
bgcolor(alertColor, title = 'Premium QM Retest Alert')

// Labels on chart
if displayLabels and qmRetestDetected
    string labelText = 'QM RETEST\nState: ' + qmState
    label.new(bar_index, high + high * 0.01, labelText, yloc = yloc.abovebar, color = color.blue, textcolor = color.white, size = size.small)

if displayScore and premiumQmRetest
    string scoreText = 'PREMIUM QM\nScore: ' + str.tostring(confluenceScore, '#.##')
    label.new(bar_index, high + high * 0.02, scoreText, yloc = yloc.abovebar, color = color.green, textcolor = color.white, size = size.small)

// Alert notification
if premiumQmRetest
    alert('ğŸ”¥ PREMIUM QM RETEST DETECTED!\nConfluence Score: ' + str.tostring(confluenceScore, '#.##') + '\nRetest Level: ' + str.tostring(qmRetestLevel, '#.##'), alert.freq_once_per_bar)
