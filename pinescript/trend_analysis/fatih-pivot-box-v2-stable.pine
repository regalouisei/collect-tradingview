//@version=6
indicator("Fatih Pivot Box V2 - Stable", overlay=true)

// =========================
// === AYARLAR ===
// =========================

mode = input.string("Auto", title="Zaman Modu", options=["Auto","Günlük", "Haftalık", "Aylık"])

showFuture  = input.bool(true,  "Gelecek Kutusu Göster")
showPast    = input.bool(true,  "Geçmiş Kutuları Göster")
showActive  = input.bool(true,  "Aktif Periyot Kutusu Göster")
showEMA1    = input.bool(true,  "EMA 1 Göster")
showEMA2    = input.bool(true,  "EMA 2 Göster")

pastCount = input.int(5, "Kaç Geçmiş Kutu", minval=1)

// =========================
// === AUTO MOD ===
// =========================

autoMode =
     timeframe.isintraday ? "Günlük" :
     timeframe.isdaily    ? "Haftalık" :
     "Aylık"

selectedMode = mode == "Auto" ? autoMode : mode

tf = selectedMode == "Günlük"  ? "D" :
     selectedMode == "Haftalık" ? "W" :
     "M"

periodLen = timeframe.in_seconds(tf) * 1000

// =========================
// === EMA ===
// =========================

ema1 = ta.ema(close, 10)
ema2 = ta.ema(close, 21)

plot(showEMA1 ? ema1 : na, color=color.black, linewidth=1)
plot(showEMA2 ? ema2 : na, color=color.black, linewidth=3)

// =========================
// === PP & 3OP HESAP ===
// =========================

pp1 = request.security(syminfo.tickerid, tf,
     (high[1] + low[1] + close[1]) / 3)

pp2 = request.security(syminfo.tickerid, tf,
     (high[2] + low[2] + close[2]) / 3)

pp3 = request.security(syminfo.tickerid, tf,
     (high[3] + low[3] + close[3]) / 3)

op3 = (pp1 + pp2 + pp3) / 3

top = math.max(pp1, op3)
bot = math.min(pp1, op3)

// =========================
// === YENİ PERİYOT (BOOL FIX)
// =========================

isNewPeriod = ta.change(time(tf)) != 0

// =========================
// === GEÇMİŞ KUTULAR ===
// =========================

var box[] pastBoxes = array.new_box()

if showPast and isNewPeriod
    newBox = box.new(
        left = time(tf)[1],
        right = time(tf)[1] + periodLen,
        top = top[1],
        bottom = bot[1],
        xloc = xloc.bar_time,
        bgcolor = color.new(color.orange, 85),
        border_color = color.orange)

    array.push(pastBoxes, newBox)

    while array.size(pastBoxes) > pastCount
        box.delete(array.shift(pastBoxes))

// =========================
// === AKTİF KUTU ===
// =========================

// =========================
// AKTİF KUTU (BIST FIX)
// =========================

htfTime = request.security(syminfo.tickerid, tf, time)

activeStart = htfTime
activeEnd   = htfTime + periodLen

var box activeBox = na

if showActive
    if na(activeBox)
        activeBox := box.new(
            left = activeStart,
            right = activeEnd,
            top = top,
            bottom = bot,
            xloc = xloc.bar_time,
            bgcolor = color.new(color.gray, 85),
            border_color = color.gray)
    else
        box.set_left(activeBox, activeStart)
        box.set_right(activeBox, activeEnd)
        box.set_top(activeBox, top)
        box.set_bottom(activeBox, bot)

// =========================
// === GELECEK KUTU (DİNAMİK)
// =========================

pp_today = request.security(syminfo.tickerid, tf,
     (high + low + close) / 3)

pp_f1 = request.security(syminfo.tickerid, tf,
     (high[1] + low[1] + close[1]) / 3)

pp_f2 = request.security(syminfo.tickerid, tf,
     (high[2] + low[2] + close[2]) / 3)

op3_future = (pp_today + pp_f1 + pp_f2) / 3

top_future = math.max(pp_today, op3_future)
bot_future = math.min(pp_today, op3_future)

nextStart = activeEnd
nextEnd   = nextStart + periodLen

var box futureBox = na

if showFuture
    if na(futureBox)
        futureBox := box.new(
            left = nextStart,
            right = nextEnd,
            top = top_future,
            bottom = bot_future,
            xloc = xloc.bar_time,
            bgcolor = color.new(color.blue, 75),
            border_color = color.blue)
    else
        box.set_left(futureBox, nextStart)
        box.set_right(futureBox, nextEnd)
        box.set_top(futureBox, top_future)
        box.set_bottom(futureBox, bot_future)
else
    if not na(futureBox)
        box.delete(futureBox)
        futureBox := na
