//@version=5
indicator("Market Gravity: Relative Value Engine", overlay=true, max_labels_count=100)

// -----------------------------------------------------------------------------
// INPUTS
// -----------------------------------------------------------------------------
group_data = "1) Data and Model"
ref_symbol = input.symbol("CRYPTOCAP:USDT.D", "Reference Symbol", group=group_data, tooltip="The prediction model uses the relationship between this symbol and the current chart.")
ref_tf = input.timeframe("", "Reference Timeframe", group=group_data, tooltip="Leave empty to use the current chart timeframe.")
method = input.string("Linear Regression (Correlation)", "Model Type", options=["Linear Range", "Linear Regression (Correlation)", "Logarithmic Range"], group=group_data)
lookback = input.int(20, "Lookback Period", minval=10, group=group_data, tooltip="Use shorter values on lower timeframes and longer values on higher timeframes.")

group_smooth = "2) Smoothing"
smooth_type = input.string("SMA", "Smoothing Type", options=["None", "SMA", "EMA", "RMA", "WMA"], group=group_smooth)
smooth_len = input.int(5, "Smoothing Length", minval=1, group=group_smooth)

group_signal = "3) Signals and Risk"
band_mult = input.float(1.5, "Residual Band Multiplier", minval=0.1, step=0.1, group=group_signal)
z_threshold = input.float(2.0, "Z-Score Threshold", minval=0.1, step=0.1, group=group_signal)

group_view = "4) Visualization"
show_bands = input.bool(true, "Show Residual Bands", group=group_view)
show_table = input.bool(true, "Show Info Panel", group=group_view)
theme_mode = input.string("Auto", "Panel Theme Mode", options=["Auto", "Manual"], group=group_view)
manual_theme = input.string("Dark", "Manual Panel Theme", options=["Dark", "Light"], group=group_view)
col_est = input.color(color.yellow, "Prediction Line", group=group_view)
col_band = input.color(color.new(color.aqua, 65), "Band Color", group=group_view)
col_premium = input.color(color.new(color.green, 82), "Premium Zone", group=group_view)
col_discount = input.color(color.new(color.red, 82), "Discount Zone", group=group_view)

// -----------------------------------------------------------------------------
// HELPERS
// -----------------------------------------------------------------------------
safe_div(num, den, fallback) =>
    den_ok = not na(den) and den != 0
    den_ok ? num / den : fallback

apply_smoothing(src, kind, len) =>
    if kind == "SMA"
        ta.sma(src, len)
    else if kind == "EMA"
        ta.ema(src, len)
    else if kind == "RMA"
        ta.rma(src, len)
    else if kind == "WMA"
        ta.wma(src, len)
    else
        src

// -----------------------------------------------------------------------------
// DATA
// -----------------------------------------------------------------------------
selected_tf = ref_tf == "" ? timeframe.period : ref_tf
[r_open, r_high, r_low, r_close] = request.security(ref_symbol, selected_tf, [open, high, low, close], lookahead=barmerge.lookahead_off, ignore_invalid_symbol=true)

t_high = high
t_low = low
t_close = close

is_ref_valid = not na(r_close) and not na(r_high) and not na(r_low)
has_history = bar_index >= lookback

// -----------------------------------------------------------------------------
// CORE CALCULATION METHODS (core logic preserved)
// -----------------------------------------------------------------------------
calc_linear_range(len) =>
    r_highest = ta.highest(r_high, len)
    r_lowest = ta.lowest(r_low, len)
    r_range = r_highest - r_lowest

    t_highest = ta.highest(t_high, len)
    t_lowest = ta.lowest(t_low, len)
    t_range = t_highest - t_lowest

    slope = t_range / (r_range > 0 ? r_range : 1)
    intercept = t_highest - (slope * r_highest)
    estimated = (slope * r_close) + intercept
    estimated

calc_regression(len) =>
    avg_y = ta.sma(t_close, len)
    avg_x = ta.sma(r_close, len)

    stdev_y = ta.stdev(t_close, len)
    stdev_x = ta.stdev(r_close, len)
    correlation = ta.correlation(r_close, t_close, len)

    beta = correlation * (stdev_y / (stdev_x > 0 ? stdev_x : 1))
    alpha = avg_y - (beta * avg_x)
    estimated = alpha + (beta * r_close)
    estimated

calc_log_range(len) =>
    log_r_h = math.log(math.max(r_high, 1e-10))
    log_r_l = math.log(math.max(r_low, 1e-10))
    log_r_c = math.log(math.max(r_close, 1e-10))

    log_t_h = math.log(math.max(t_high, 1e-10))
    log_t_l = math.log(math.max(t_low, 1e-10))

    r_highest = ta.highest(log_r_h, len)
    r_lowest = ta.lowest(log_r_l, len)
    t_highest = ta.highest(log_t_h, len)
    t_lowest = ta.lowest(log_t_l, len)

    slope = (t_highest - t_lowest) / ((r_highest - r_lowest) > 0 ? (r_highest - r_lowest) : 1)
    intercept = t_highest - (slope * r_highest)
    log_est = (slope * log_r_c) + intercept
    estimated = math.exp(log_est)
    estimated

// -----------------------------------------------------------------------------
// MODEL OUTPUT
// -----------------------------------------------------------------------------
float predicted_raw = na
if is_ref_valid and has_history
    if method == "Linear Range"
        predicted_raw := calc_linear_range(lookback)
    else if method == "Linear Regression (Correlation)"
        predicted_raw := calc_regression(lookback)
    else
        predicted_raw := calc_log_range(lookback)

predicted = apply_smoothing(predicted_raw, smooth_type, smooth_len)

is_pred_valid = not na(predicted) and predicted > 0
price_diff = is_pred_valid ? (close - predicted) : na
diff_pct = is_pred_valid ? safe_div(price_diff, predicted, 0.0) * 100 : na

// -----------------------------------------------------------------------------
// QUALITY METRICS & SIGNALS
// -----------------------------------------------------------------------------
residual = is_pred_valid ? close - predicted : na
res_stdev = ta.stdev(residual, lookback)
mae = ta.sma(math.abs(residual), lookback)
mape = ta.sma(math.abs(safe_div(residual, close, 0.0)) * 100, lookback)
corr_cp = ta.correlation(close, predicted, lookback)
r2 = corr_cp * corr_cp
z_score = safe_div(residual, res_stdev, 0.0)

upper_band = is_pred_valid ? predicted + (band_mult * res_stdev) : na
lower_band = is_pred_valid ? predicted - (band_mult * res_stdev) : na

is_premium = is_pred_valid and close > predicted
is_discount = is_pred_valid and close < predicted

// -----------------------------------------------------------------------------
// PLOTS
// -----------------------------------------------------------------------------
plot_pred = plot(predicted, "Predicted Price", color=col_est, linewidth=2)
plot_actual = plot(close, "Actual Price", display=display.none)

plot_up = plot(show_bands ? upper_band : na, "Upper Band", color=col_band, linewidth=1)
plot_dn = plot(show_bands ? lower_band : na, "Lower Band", color=col_band, linewidth=1)
fill(plot_up, plot_dn, color=color.new(col_band, 70), title="Residual Band Area")

fill(plot_pred, plot_actual, color=is_premium ? col_premium : col_discount, title="Premium / Discount")

plotshape(ta.crossover(z_score, z_threshold), "Extreme Premium", shape.triangledown, location.abovebar, color.red, size=size.tiny, text="Z+")
plotshape(ta.crossunder(z_score, -z_threshold), "Extreme Discount", shape.triangleup, location.belowbar, color.lime, size=size.tiny, text="Z-")
plotshape(ta.crossover(close, predicted), "Long Signal", shape.triangleup, location.belowbar, color.green, size=size.small, text="LONG")
plotshape(ta.crossunder(close, predicted), "Short Signal", shape.triangledown, location.abovebar, color.red, size=size.small, text="SHORT")

// -----------------------------------------------------------------------------
// ALERTS
// -----------------------------------------------------------------------------
alertcondition(ta.crossover(z_score, z_threshold), title="Z-Score Premium Threshold Crossed", message="Price moved into extreme premium territory above the model.")
alertcondition(ta.crossunder(z_score, -z_threshold), title="Z-Score Discount Threshold Crossed", message="Price moved into extreme discount territory below the model.")
alertcondition(ta.cross(close, predicted), title="Price Crossed Model", message="Price crossed the prediction line (possible regime change).")

// -----------------------------------------------------------------------------
// STATUS PANEL
// -----------------------------------------------------------------------------
var table panel = table.new(position.top_right, 2, 10, frame_color=color.new(color.white, 70), border_width=1)

if barstate.islast and show_table
    regime_text = is_premium ? "Premium" : is_discount ? "Discount" : "Neutral"
    regime_color = is_premium ? color.green : is_discount ? color.red : color.gray

    model_health = na(r2) ? "N/A" : r2 >= 0.6 ? "Strong" : r2 >= 0.35 ? "Moderate" : "Weak"
    health_color = na(r2) ? color.gray : r2 >= 0.6 ? color.green : r2 >= 0.35 ? color.orange : color.red

    chart_bg = chart.bg_color
    bg_luma = (0.299 * color.r(chart_bg)) + (0.587 * color.g(chart_bg)) + (0.114 * color.b(chart_bg))
    is_dark_auto = bg_luma < 128
    use_dark_theme = theme_mode == "Auto" ? is_dark_auto : manual_theme == "Dark"

    bg_header_l = use_dark_theme ? color.rgb(25, 47, 89) : color.rgb(221, 235, 255)
    bg_header_r = use_dark_theme ? color.rgb(34, 65, 120) : color.rgb(197, 221, 250)
    bg_label = use_dark_theme ? color.rgb(35, 35, 40) : color.rgb(236, 239, 244)
    bg_row_odd = use_dark_theme ? color.rgb(20, 20, 24) : color.rgb(250, 251, 253)
    bg_row_even = use_dark_theme ? color.rgb(27, 27, 32) : color.rgb(242, 245, 250)
    header_text = use_dark_theme ? color.white : color.rgb(25, 35, 55)
    label_text = use_dark_theme ? color.silver : color.rgb(70, 78, 96)
    value_text = use_dark_theme ? color.white : color.rgb(30, 35, 48)
    smooth_text = use_dark_theme ? color.silver : color.rgb(85, 94, 112)

    diff_text = na(diff_pct) ? "N/A" : (diff_pct >= 0 ? "+" : "") + str.tostring(diff_pct, "#.##") + "%"
    z_text = na(z_score) ? "N/A" : str.tostring(z_score, "#.##")
    r2_text = na(r2) ? "N/A" : str.tostring(r2, "#.###")
    pred_text = na(predicted) ? "N/A" : str.tostring(predicted, "#.####")
    mae_text = na(mae) ? "N/A" : str.tostring(mae, "#.####")
    mape_text = na(mape) ? "N/A" : str.tostring(mape, "#.##") + "%"
    z_state = na(z_score) ? "N/A" : math.abs(z_score) >= z_threshold ? "Extreme" : "Normal"

    table.cell(panel, 0, 0, "RELATIVE VALUE DASHBOARD", text_color=header_text, text_halign=text.align_left, text_size=size.small, bgcolor=bg_header_l)
    table.cell(panel, 1, 0, ref_symbol + " @ " + selected_tf, text_color=header_text, text_halign=text.align_right, text_size=size.small, bgcolor=bg_header_r)

    table.cell(panel, 0, 1, "Regime", text_color=label_text, text_halign=text.align_left, text_size=size.small, bgcolor=bg_label)
    table.cell(panel, 1, 1, regime_text, text_color=regime_color, text_halign=text.align_right, text_size=size.small, bgcolor=bg_row_odd)

    table.cell(panel, 0, 2, "Diff %", text_color=label_text, text_halign=text.align_left, text_size=size.small, bgcolor=bg_label)
    table.cell(panel, 1, 2, diff_text, text_color=na(diff_pct) ? color.gray : diff_pct >= 0 ? color.lime : color.red, text_halign=text.align_right, text_size=size.small, bgcolor=bg_row_even)

    table.cell(panel, 0, 3, "Prediction", text_color=label_text, text_halign=text.align_left, text_size=size.small, bgcolor=bg_label)
    table.cell(panel, 1, 3, pred_text, text_color=value_text, text_halign=text.align_right, text_size=size.small, bgcolor=bg_row_odd)

    table.cell(panel, 0, 4, "Z-Score", text_color=label_text, text_halign=text.align_left, text_size=size.small, bgcolor=bg_label)
    table.cell(panel, 1, 4, z_text + "  (" + z_state + ")", text_color=na(z_score) ? color.gray : math.abs(z_score) >= z_threshold ? color.yellow : value_text, text_halign=text.align_right, text_size=size.small, bgcolor=bg_row_even)

    table.cell(panel, 0, 5, "R2", text_color=label_text, text_halign=text.align_left, text_size=size.small, bgcolor=bg_label)
    table.cell(panel, 1, 5, r2_text, text_color=health_color, text_halign=text.align_right, text_size=size.small, bgcolor=bg_row_odd)

    table.cell(panel, 0, 6, "Model Quality", text_color=label_text, text_halign=text.align_left, text_size=size.small, bgcolor=bg_label)
    table.cell(panel, 1, 6, model_health, text_color=health_color, text_halign=text.align_right, text_size=size.small, bgcolor=bg_row_even)

    table.cell(panel, 0, 7, "MAE", text_color=label_text, text_halign=text.align_left, text_size=size.small, bgcolor=bg_label)
    table.cell(panel, 1, 7, mae_text, text_color=value_text, text_halign=text.align_right, text_size=size.small, bgcolor=bg_row_odd)

    table.cell(panel, 0, 8, "MAPE %", text_color=label_text, text_halign=text.align_left, text_size=size.small, bgcolor=bg_label)
    table.cell(panel, 1, 8, mape_text, text_color=value_text, text_halign=text.align_right, text_size=size.small, bgcolor=bg_row_even)

    table.cell(panel, 0, 9, "Smoothing", text_color=label_text, text_halign=text.align_left, text_size=size.small, bgcolor=bg_label)
    table.cell(panel, 1, 9, smooth_type + " (" + str.tostring(smooth_len) + ")", text_color=smooth_text, text_halign=text.align_right, text_size=size.small, bgcolor=bg_row_odd)
