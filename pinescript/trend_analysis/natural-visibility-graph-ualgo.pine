// This Pine Script™ code is subject to the terms of the Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0) https://creativecommons.org/licenses/by-nc-sa/4.0/
// © UAlgo

//@version=6
indicator("Natural Visibility Graph [UAlgo]", overlay=true, max_lines_count=500)

// -----------------------------------------------------------------------------
// Constants & Settings
// -----------------------------------------------------------------------------
string G_GRAPH = "Visibility Graph Settings"
string G_STYLE = "Visual Style"

int     lookback    = input.int(50, "Visibility Lookback", minval=10, maxval=200, group=G_GRAPH, tooltip="How many past bars to check for visibility connections. Higher = Slower computation but stronger pivots.")
float   threshold   = input.float(0.85, "Hub Threshold (Percentile)", minval=0.5, step=0.05, group=G_GRAPH, tooltip="Top X% of nodes are marked as structural hubs.")

// Neon Color Palette
color   colNeonCyan = #00e5ff
color   colNeonPink = #ff2975
color   colNeonPurp = #9d46ff
color   colDark     = #131722

// -----------------------------------------------------------------------------
// Logic: Natural Visibility Graph (NVG) Algorithm
// -----------------------------------------------------------------------------

// Calculate 'In-Degree' (Visibility from past) for Highs
// We look backwards from Current (0) to Past (i).
// If the line of sight is clear, Degree increases.
int degreeH = 0
int furthestVisIdxH = 0 

for i = 1 to lookback
    bool isVisible = true
    // Slope from Current High to Past High
    float slope = (high - high[i]) / float(i)
    
    // Check intermediate obstructions
    for k = 1 to i - 1
        // Projected Height at distance k
        float y_projected = high - (slope * k)
        // Obstruction Check
        if high[k] >= y_projected
            isVisible := false
            break
    
    if isVisible
        degreeH += 1
        furthestVisIdxH := i // Keep track of the furthest visible bar

// Calculate 'In-Degree' for Lows (Inverted Valley Logic)
int degreeL = 0
int furthestVisIdxL = 0

for i = 1 to lookback
    bool isVisible = true
    float slope = (low - low[i]) / float(i)
    
    for k = 1 to i - 1
        float y_projected = low - (slope * k)
        if low[k] <= y_projected // Lower bars block visibility for valleys
            isVisible := false
            break
            
    if isVisible
        degreeL += 1
        furthestVisIdxL := i

// -----------------------------------------------------------------------------
// Dynamic Thresholding & Hub Detection
// -----------------------------------------------------------------------------
// Rolling maximum to determine relative importance
var int maxDegH = 5
var int maxDegL = 5

// Slow decay for threshold adaptation
if bar_index % int(lookback/2) == 0
    maxDegH := int(math.max(5, maxDegH * 0.95))
    maxDegL := int(math.max(5, maxDegL * 0.95))

maxDegH := math.max(maxDegH, degreeH)
maxDegL := math.max(maxDegL, degreeL)

bool isHubH = degreeH >= maxDegH * threshold
bool isHubL = degreeL >= maxDegL * threshold

// -----------------------------------------------------------------------------
// Visuals: The "Neon Web" Design
// -----------------------------------------------------------------------------

// 1. Heatmap Bar Coloring
// Color bars based on their connectivity degree relative to the local max
// High Connectivity = Hot Pink/Cyan, Low = Gray
color barColH = color.from_gradient(degreeH, 0, maxDegH, color.new(color.gray, 80), colNeonCyan)
color barColL = color.from_gradient(degreeL, 0, maxDegL, color.new(color.gray, 80), colNeonPink)

// Mix colors if a bar is both (rare but possible in consolidation)
color finalBarCol = isHubH ? colNeonCyan : (isHubL ? colNeonPink : color.new(color.gray, 70))
barcolor(finalBarCol)

// 2. Hub Markers & Horizon Beams
if isHubH
    // Top Label (Diamond)
    label.new(bar_index, high, "◈", textcolor=colNeonCyan, style=label.style_label_down, color=color.new(color.white, 100), size=size.tiny)
    
    // The "Horizon Beam": Connects Hub to its furthest visible point
    // This visualizes the "Range of Influence" of the pivot
    line.new(bar_index, high, bar_index - furthestVisIdxH, high[furthestVisIdxH], color=color.new(colNeonCyan, 60), style=line.style_dotted)

if isHubL
    // Bottom Label (Diamond)
    label.new(bar_index, low, "◈", textcolor=colNeonPink, style=label.style_label_up, color=color.new(color.white, 100), size=size.tiny)
    
    // Horizon Beam
    line.new(bar_index, low, bar_index - furthestVisIdxL, low[furthestVisIdxL], color=color.new(colNeonPink, 60), style=line.style_dotted)

// -----------------------------------------------------------------------------
// Alerts
// -----------------------------------------------------------------------------
alertcondition(isHubH, "NVG High Hub", "High Visibility Structural Peak Detected")
alertcondition(isHubL, "NVG Low Hub", "High Visibility Structural Valley Detected")
