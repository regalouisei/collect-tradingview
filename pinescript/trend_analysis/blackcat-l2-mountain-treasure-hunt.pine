//@version=6
indicator("[blackcat] L2 Mountain Treasure Hunt", overlay=true, max_bars_back=5000, max_labels_count = 500)

// ============================================================
// Input Parameters
// ============================================================
fibPeriod = input.int(120, "Fibonacci Period", minval=1)
ema10Period = input.int(10, "EMA 10 Period", minval=1)
ema14Period = input.int(14, "EMA 14 Period", minval=1)
showFibLevels = input.bool(true, "Show Fibonacci Levels")
showStatusTable = input.bool(true, "Show Status Table")
showBsLabels = input.bool(true, "Show Buy/Sell Labels")
showSignalLabels = input.bool(true, "Show Signal Labels")
enableAlerts = input.bool(true, "Enable Alerts")

// ============================================================
// Custom Functions
// ============================================================
// Get EMA value at crossover point
getEmaAtCrossover(emaSeries, crossoverSignal) =>
    var float emaAtCross = na
    if crossoverSignal
        emaAtCross := emaSeries
    emaAtCross

// Get EMA value at crossunder point
getEmaAtCrossunder(emaSeries, crossunderSignal) =>
    var float emaAtCross = na
    if crossunderSignal
        emaAtCross := emaSeries
    emaAtCross

// ============================================================
// Fibonacci Levels Calculation
// ============================================================
// Calculate highest price 120 days ago, 3 bars back
highest120DaysAgo = ta.highest(high, fibPeriod)[3]
// Calculate lowest price 120 days ago, 3 bars back
lowest120DaysAgo = ta.lowest(low, fibPeriod)[3]
// Calculate Fibonacci retracement levels
fibLevel191 = highest120DaysAgo - (highest120DaysAgo - lowest120DaysAgo) * 0.191
fibLevel382 = highest120DaysAgo - (highest120DaysAgo - lowest120DaysAgo) * 0.382
fibLevel500 = highest120DaysAgo - (highest120DaysAgo - lowest120DaysAgo) * 0.500
fibLevel618 = highest120DaysAgo - (highest120DaysAgo - lowest120DaysAgo) * 0.618
fibLevel809 = highest120DaysAgo - (highest120DaysAgo - lowest120DaysAgo) * 0.809

// ============================================================
// EMA Breakthrough System
// ============================================================
// Calculate EMA10 and EMA14
ema10 = ta.ema(close, ema10Period)
ema14 = ta.ema(close, ema14Period)

// Calculate breakthrough level (previous day's EMA14)
breakthroughLevel = ema14[1]

// Calculate EMA breakthrough percentage
emaBreakthroughPercent = (ema10 - breakthroughLevel) / breakthroughLevel * 100

// Calculate baseline level using crossover/crossunder EMA values
ema10AtCrossover = getEmaAtCrossover(ema10, ta.crossover(emaBreakthroughPercent, 0))
ema10AtCrossunder = getEmaAtCrossunder(ema10, ta.crossunder(emaBreakthroughPercent, 0))

baselineLevel = emaBreakthroughPercent >= 0 ? ema10AtCrossover : ema10AtCrossunder

// ============================================================
// Signal Calculations
// ============================================================
// Upward signal: emaBreakthroughPercent crosses above 0
upwardSignal = ta.crossover(emaBreakthroughPercent, 0)

// Downward signal: emaBreakthroughPercent crosses below 0
downwardSignal = ta.crossunder(emaBreakthroughPercent, 0)

// Price range analysis
priceRangeThird = (high - low) / 3
openAboveRange = open > priceRangeThird * 2 + low
openBelowRange = open < priceRangeThird + low
closeAboveRange = close > priceRangeThird * 2 + low
closeBelowRange = close < priceRangeThird + low
closeMiddleRange = not (closeAboveRange or closeBelowRange)

// Signal strength calculations
strongUpwardSignal = closeAboveRange or (openBelowRange and closeMiddleRange)
weakSignal = openBelowRange and closeMiddleRange
strongDownwardSignal = not (strongUpwardSignal or weakSignal)

// Trend calculations
midPrice = (high + low) / 2
upwardTrend = midPrice > high[1]
downwardTrend = midPrice < low[1]
weakTrend = not (upwardTrend or downwardTrend)

// Combined signals
signal1 = strongUpwardSignal and upwardTrend
signal2 = strongDownwardSignal and downwardTrend
signal3 = strongUpwardSignal and downwardTrend
signal4 = strongDownwardSignal and downwardTrend
signal5 = strongUpwardSignal and weakTrend
signal6 = strongDownwardSignal and weakTrend
signal7 = weakSignal and (upwardTrend or downwardTrend or weakTrend)

// ============================================================
// Visualization - Fibonacci Levels
// ============================================================
plot(showFibLevels ? fibLevel191 : na, "Fib 19.1%", color=color.new(color.blue, 50), linewidth=1, style=plot.style_linebr)
plot(showFibLevels ? fibLevel382 : na, "Fib 38.2%", color=color.new(color.blue, 40), linewidth=1, style=plot.style_linebr)
plot(showFibLevels ? fibLevel500 : na, "Fib 50.0%", color=color.new(color.blue, 30), linewidth=1, style=plot.style_linebr)
plot(showFibLevels ? fibLevel618 : na, "Fib 61.8%", color=color.new(color.blue, 20), linewidth=1, style=plot.style_linebr)
plot(showFibLevels ? fibLevel809 : na, "Fib 80.9%", color=color.new(color.blue, 10), linewidth=1, style=plot.style_linebr)

// ============================================================
// Visualization - EMA Lines
// ============================================================
plot(ema10, "EMA 10", color=color.new(color.orange, 0), linewidth=2)
plot(ema14, "EMA 14", color=color.new(color.purple, 0), linewidth=2)
plot(breakthroughLevel, "Breakthrough Level", color=color.new(color.teal, 0), linewidth=1, linestyle=plot.linestyle_dotted)
plot(baselineLevel, "Baseline Level", color=color.new(color.maroon, 0), linewidth=1, linestyle=plot.linestyle_dotted)

// ============================================================
// Visualization - Enhanced Candlestick Coloring
// ============================================================
// Enhanced bullish candlestick with gradient simulation (brighter green #00C853)
plotcandle(emaBreakthroughPercent >= 0 ? open : na, emaBreakthroughPercent >= 0 ? high : na, emaBreakthroughPercent >= 0 ? low : na, emaBreakthroughPercent >= 0 ? close : na, "Bullish Candle", color=color.new(#00C853, 0), wickcolor=color.new(#69F0AE, 0), bordercolor=color.new(#00E676, 0))

// Enhanced bearish candlestick with gradient simulation (brighter red #FF1744)
plotcandle(emaBreakthroughPercent < 0 ? open : na, emaBreakthroughPercent < 0 ? high : na, emaBreakthroughPercent < 0 ? low : na, emaBreakthroughPercent < 0 ? close : na, "Bearish Candle", color=color.new(#FF1744, 0), wickcolor=color.new(#FF8A80, 0), bordercolor=color.new(#FF5252, 0))

// Enhanced buy signal candle with purple-pink gradient (#E040FB)
plotcandle(upwardSignal ? open : na, upwardSignal ? high : na, upwardSignal ? low : na, upwardSignal ? close : na, "Buy Signal Candle", color=color.new(#E040FB, 0), wickcolor=color.new(#EA80FC, 0), bordercolor=color.new(#D500F9, 0))

// Enhanced sell signal candle with orange-red gradient (#FF6D00)
plotcandle(downwardSignal ? open : na, downwardSignal ? high : na, downwardSignal ? low : na, downwardSignal ? close : na, "Sell Signal Candle", color=color.new(#FF6D00, 0), wickcolor=color.new(#FF9E80, 0), bordercolor=color.new(#FF3D00, 0))

// ============================================================
// Enhanced Buy/Sell Labels with Arrows
// ============================================================
if showBsLabels
    // Enhanced buy label (▲ BUY) on upward signal
    if upwardSignal
        label.new(bar_index, low, "▲ BUY", color=color.new(#00C853, 0), textcolor=color.white, style=label.style_label_up, size=size.normal, yloc=yloc.belowbar)

    // Enhanced sell label (▼ SELL) on downward signal
    if downwardSignal
        label.new(bar_index, high, "▼ SELL", color=color.new(#FF1744, 0), textcolor=color.white, style=label.style_label_down, size=size.normal, yloc=yloc.abovebar)

// ============================================================
// Enhanced Status Table with Improved Layout
// ============================================================
if showStatusTable
    var table statusTable = table.new(position.top_right, 4, 4, 
        bgcolor=color.new(#1A1A2E, 70), 
        border_width=1, 
        border_color=color.new(#0F3460, 50))

    // Enhanced table headers with better styling
    if barstate.islast
        table.cell(statusTable, 0, 0, "TREND", 
            text_color=#E8F5E9, 
            bgcolor=color.new(#16213E, 40), 
            text_size=size.small)
        table.cell(statusTable, 1, 0, "SIGNAL", 
            text_color=#E8F5E9, 
            bgcolor=color.new(#16213E, 40), 
            text_size=size.small)
        table.cell(statusTable, 2, 0, "EMA STATUS", 
            text_color=#E8F5E9, 
            bgcolor=color.new(#16213E, 40), 
            text_size=size.small)
        table.cell(statusTable, 3, 0, "FIB LEVEL", 
            text_color=#E8F5E9, 
            bgcolor=color.new(#16213E, 40), 
            text_size=size.small)

        // Enhanced trend status with unicode symbols
        trendText = upwardTrend ? "▲ UP" : downwardTrend ? "▼ DOWN" : "◀ NEUTRAL"
        trendColor = upwardTrend ? color.new(#00C853, 20) : downwardTrend ? color.new(#FF1744, 20) : color.new(#757575, 20)
        table.cell(statusTable, 0, 1, trendText, 
            text_color=#FFFFFF, 
            bgcolor=trendColor, 
            text_size=size.normal)

        // Enhanced signal status with unicode symbols
        signalText = upwardSignal ? "● BUY" : downwardSignal ? "● SELL" : "○ WAIT"
        signalColor = upwardSignal ? color.new(#00C853, 20) : downwardSignal ? color.new(#FF1744, 20) : color.new(#757575, 20)
        table.cell(statusTable, 1, 1, signalText, 
            text_color=#FFFFFF, 
            bgcolor=signalColor, 
            text_size=size.normal)

        // Enhanced EMA status with unicode symbols
        emaStatusText = ema10 > ema14 ? "▲ ABOVE" : "▼ BELOW"
        emaStatusColor = ema10 > ema14 ? color.new(#00C853, 20) : color.new(#FF1744, 20)
        table.cell(statusTable, 2, 1, emaStatusText, 
            text_color=#FFFFFF, 
            bgcolor=emaStatusColor, 
            text_size=size.normal)

        // Enhanced Fibonacci level with unicode symbols
        fibLevelText = close > fibLevel618 ? "▲ 61.8%" : close > fibLevel500 ? "▲ 50%" : close > fibLevel382 ? "▲ 38.2%" : "▼ 38.2%"
        fibLevelColor = close > fibLevel618 ? color.new(#00C853, 20) : close > fibLevel500 ? color.new(#64DD17, 20) : close > fibLevel382 ? color.new(#FFD600, 20) : color.new(#FF1744, 20)
        table.cell(statusTable, 3, 1, fibLevelText, 
            text_color=#FFFFFF, 
            bgcolor=fibLevelColor, 
            text_size=size.normal)

        // Enhanced breakthrough percentage
        breakthroughText = (emaBreakthroughPercent >= 0 ? "+" : "") + str.tostring(emaBreakthroughPercent, "#.##") + "%"
        breakthroughColor = emaBreakthroughPercent >= 0 ? color.new(#00C853, 20) : color.new(#FF1744, 20)
        table.cell(statusTable, 0, 2, "BREAK", 
            text_color=#E8F5E9, 
            bgcolor=color.new(#16213E, 40), 
            text_size=size.small)
        table.cell(statusTable, 1, 2, breakthroughText, 
            text_color=#FFFFFF, 
            bgcolor=breakthroughColor, 
            text_size=size.normal)

        // Enhanced signal strength with unicode symbols
        signalStrengthText = strongUpwardSignal ? "▲ STRONG UP" : strongDownwardSignal ? "▼ STRONG DOWN" : weakSignal ? "○ WEAK" : "◀ NEUTRAL"
        signalStrengthColor = strongUpwardSignal ? color.new(#00C853, 20) : strongDownwardSignal ? color.new(#FF1744, 20) : weakSignal ? color.new(#FFD600, 20) : color.new(#757575, 20)
        table.cell(statusTable, 2, 2, "STR", 
            text_color=#E8F5E9, 
            bgcolor=color.new(#16213E, 40), 
            text_size=size.small)
        table.cell(statusTable, 3, 2, signalStrengthText, 
            text_color=#FFFFFF, 
            bgcolor=signalStrengthColor, 
            text_size=size.normal)

        // Enhanced combined signal
        combinedSignalText = signal1 ? "S1" : signal2 ? "S2" : signal3 ? "S3" : signal4 ? "S4" : signal5 ? "S5" : signal6 ? "S6" : signal7 ? "S7" : "NONE"
        combinedSignalColor = signal1 or signal5 ? color.new(#00C853, 20) : signal2 or signal4 or signal6 ? color.new(#FF1744, 20) : signal3 or signal7 ? color.new(#FFD600, 20) : color.new(#757575, 20)
        table.cell(statusTable, 0, 3, "COMB", 
            text_color=#E8F5E9, 
            bgcolor=color.new(#16213E, 40), 
            text_size=size.small)
        table.cell(statusTable, 1, 3, combinedSignalText, 
            text_color=#FFFFFF, 
            bgcolor=combinedSignalColor, 
            text_size=size.normal)

        // Add current price row
        table.cell(statusTable, 2, 3, "PRICE", 
            text_color=#E8F5E9, 
            bgcolor=color.new(#16213E, 40), 
            text_size=size.small)
        table.cell(statusTable, 3, 3, str.tostring(close, "#.##"), 
            text_color=#FFFFFF, 
            bgcolor=color.new(#0F3460, 30), 
            text_size=size.normal)

// ============================================================
// Alert Conditions
// ============================================================
// Use alert() function (Pine Script v6) instead of deprecated alertcondition()
if enableAlerts and upwardSignal
    alert("Mountain Treasure Hunt: BUY signal detected at " + str.tostring(close, "#.##"))
if enableAlerts and downwardSignal
    alert("Mountain Treasure Hunt: SELL signal detected at " + str.tostring(close, "#.##"))
