//@version=6
indicator("MTF Fractal Model [Side Panel]", overlay=true, max_boxes_count=50, max_lines_count=50, max_labels_count=50)

// --- Settings ---
group_tf    = "Timeframes"
tf1_input   = input.timeframe("60", "Timeframe 1", group=group_tf)
tf2_input   = input.timeframe("240", "Timeframe 2", group=group_tf)
tf3_input   = input.timeframe("D", "Timeframe 3", group=group_tf)

group_vis   = "Visuals"
offset_val  = input.int(10, "Right Side Offset (Bars)", group=group_vis, minval=1)
space_val   = input.int(6, "Spacing Between Candles", group=group_vis, minval=2)
bull_color  = input.color(color.teal, "Bullish Color", group=group_vis)
bear_color  = input.color(color.red, "Bearish Color", group=group_vis)
wick_color  = input.color(color.gray, "Wick Color", group=group_vis)
txt_color   = input.color(color.gray, "Text Color", group=group_vis)

// --- Data Fetching Function ---
// We use request.security to get the current (forming) candle data from higher timeframes.
get_htf_data(_tf) =>
    [o, h, l, c] = request.security(syminfo.tickerid, _tf, [open, high, low, close])
    [o, h, l, c]

// Fetch data for the 3 selected timeframes
[o1, h1, l1, c1] = get_htf_data(tf1_input)
[o2, h2, l2, c2] = get_htf_data(tf2_input)
[o3, h3, l3, c3] = get_htf_data(tf3_input)

// --- Drawing Function ---
// This function draws a 'ghost' candle using boxes (body) and lines (wicks)
draw_candle(idx, _o, _h, _l, _c, _tf_label, _offset_step) =>
    // Calculate Position
    x_pos = bar_index + offset_val + _offset_step
    
    // Determine Color
    is_bull = _c >= _o
    c_color = is_bull ? bull_color : bear_color
    
    // 1. Draw Wicks (Line)
    // We draw one line from High to Low
    l_wick = line.new(x_pos, _h, x_pos, _l, color=wick_color, width=1)
    
    // 2. Draw Body (Box)
    // Box requires top-left and bottom-right coordinates
    // We create a box with a width of approx 3-4 bars worth of visual space (conceptually)
    // Note: In overlay, we can't control pixel width easily, so we use single bar x-coordinate.
    // To make it look "fat" like the screenshot, we can just use the border size or a trick, 
    // but standard practice for side-panels is a single thick line or a box spanning slight time.
    // Here we use a box centered on the x_pos.
    
    // Calculate box top and bottom (Top is strictly the higher price, Bottom is lower)
    box_top = math.max(_o, _c)
    box_bot = math.min(_o, _c)
    
    // We cheat slightly to make the box wider by using x_pos - 1 to x_pos + 1 if desired,
    // but simpler to use a single thick box if 'right' alignment is strict. 
    // Let's use left/right coords to give it width.
    b_body = box.new(x_pos - 1, box_top, x_pos + 1, box_bot, border_color=c_color, bgcolor=c_color)
    
    // 3. Draw Label (Timeframe Name)
    lbl = label.new(x_pos, _h, text=_tf_label, yloc=yloc.price, style=label.style_none, textcolor=txt_color, size=size.normal)
    
    // Return objects so we can manage garbage collection (delete old ones)
    [l_wick, b_body, lbl]

// --- Execution ---
// We only draw on the very last bar to avoid cluttering history
var line l1_wick = na
var box b1_body = na
var label lbl1 = na

var line l2_wick = na
var box b2_body = na
var label lbl2 = na

var line l3_wick = na
var box b3_body = na
var label lbl3 = na

if barstate.islast
    // Delete previous drawings to simulate "animation/updating" without trailing ghosts
    line.delete(l1_wick)
    box.delete(b1_body)
    label.delete(lbl1)
    
    line.delete(l2_wick)
    box.delete(b2_body)
    label.delete(lbl2)
    
    line.delete(l3_wick)
    box.delete(b3_body)
    label.delete(lbl3)
    
    // Draw new candles
    // Candle 1 (H1)
    [w1, b1, lb1] = draw_candle(bar_index, o1, h1, l1, c1, "H1", 0)
    l1_wick := w1
    b1_body := b1
    lbl1 := lb1
    
    // Candle 2 (H4)
    [w2, b2, lb2] = draw_candle(bar_index, o2, h2, l2, c2, "H4", space_val)
    l2_wick := w2
    b2_body := b2
    lbl2 := lb2
    
    // Candle 3 (D1)
    [w3, b3, lb3] = draw_candle(bar_index, o3, h3, l3, c3, "D1", space_val * 2)
    l3_wick := w3
    b3_body := b3
    lbl3 := lb3
