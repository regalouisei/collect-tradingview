//@version=5
indicator("Dynamic Trendlines & Breakouts [identityKa]", overlay=true, max_lines_count=10, max_labels_count=50)

// ==========================================
// 1. KULLANICI AYARLARI
// ==========================================
grp_1 = "âš™ï¸ Trend AlgoritmasÄ±"
length = input.int(14, "Pivot Hassasiyeti (Lookback)", minval=5, maxval=50, tooltip="DÃ¼ÅŸÃ¼k deÄŸer: KÄ±sa vade trendler. YÃ¼ksek deÄŸer: Uzun vade majÃ¶r trendler.", group=grp_1)

grp_2 = "ğŸ¨ identityKa TemasÄ±"
col_up = input.color(#00ffbb, "Bullish Breakout (Neon YeÅŸil)", group=grp_2)
col_dn = input.color(#ff1744, "Bearish Breakout (Neon KÄ±rmÄ±zÄ±)", group=grp_2)

// ==========================================
// 2. MATEMATÄ°K VE KOORDÄ°NAT SÄ°STEMÄ°
// ==========================================
var float ph_y1 = na, var int ph_x1 = na
var float ph_y2 = na, var int ph_x2 = na
var float pl_y1 = na, var int pl_x1 = na
var float pl_y2 = na, var int pl_x2 = na

var line upper_line = na
var line lower_line = na

// Etiketleri hafÄ±zada tutmak iÃ§in diziler (Hayalet etiketleri silmek iÃ§in)
var label[] upper_labels = array.new_label()
var label[] lower_labels = array.new_label()

ph = ta.pivothigh(high, length, length)
pl = ta.pivotlow(low, length, length)

// ==========================================
// 3. Ã‡Ä°ZGÄ°LER VE AKILLI TEMÄ°ZLÄ°K
// ==========================================
// Ãœst Trend Ã‡izgisi (DirenÃ§)
if not na(ph)
    ph_y2 := ph_y1, ph_x2 := ph_x1
    ph_y1 := ph, ph_x1 := bar_index[length]
    if not na(ph_x2)
        line.delete(upper_line)
        upper_line := line.new(ph_x2, ph_y2, ph_x1, ph_y1, color=color.new(col_dn, 40), style=line.style_dashed, width=2, extend=extend.right)
        
        // Yeni direnÃ§ Ã§izildiÄŸinde, eski dirence ait tÃ¼m "B" etiketlerini temizle
        if array.size(upper_labels) > 0
            for l in upper_labels
                label.delete(l)
            array.clear(upper_labels)

// Alt Trend Ã‡izgisi (Destek)
if not na(pl)
    pl_y2 := pl_y1, pl_x2 := pl_x1
    pl_y1 := pl, pl_x1 := bar_index[length]
    if not na(pl_x2)
        line.delete(lower_line)
        lower_line := line.new(pl_x2, pl_y2, pl_x1, pl_y1, color=color.new(col_up, 40), style=line.style_dashed, width=2, extend=extend.right)
        
        // Yeni destek Ã§izildiÄŸinde, eski desteÄŸe ait tÃ¼m "B" etiketlerini temizle
        if array.size(lower_labels) > 0
            for l in lower_labels
                label.delete(l)
            array.clear(lower_labels)

// ==========================================
// 4. KIRILIM (BREAKOUT) TESPÄ°TÄ°
// ==========================================
upper_val = line.get_price(upper_line, bar_index)
lower_val = line.get_price(lower_line, bar_index)

var line last_brk_up = na
var line last_brk_dn = na

bullish_break = not na(upper_val) and ta.crossover(close, upper_val) and upper_line != last_brk_up
bearish_break = not na(lower_val) and ta.crossunder(close, lower_val) and lower_line != last_brk_dn

if bullish_break
    last_brk_up := upper_line
    lbl = label.new(bar_index, low, text="B", color=col_up, style=label.style_label_up, textcolor=color.black, size=size.small)
    array.push(upper_labels, lbl)

if bearish_break
    last_brk_dn := lower_line
    lbl = label.new(bar_index, high, text="B", color=col_dn, style=label.style_label_down, textcolor=color.white, size=size.small)
    array.push(lower_labels, lbl)

// Alarmlar
alertcondition(bullish_break, title="YukarÄ± KÄ±rÄ±lÄ±m", message="Trend direnci kÄ±rÄ±ldÄ±!")
alertcondition(bearish_break, title="AÅŸaÄŸÄ± KÄ±rÄ±lÄ±m", message="Trend desteÄŸi kÄ±rÄ±ldÄ±!")
