// This Pine Script¬Æ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// ¬© MisinkoMaster

//@version=6
indicator("Strategic Trend Filter", "STF | MisinkoMaster", behind_chart = false, overlay = true)
//////////////////////////////////////////////////////////////////////////////////////////////////
//Import Libraries
import TradingView/ta/12
//////////////////////////////////////////////////////////////////////////////////////////////////
//Get User Defined Inputs
len = input.int(28, "Lookback Period", step = 1, minval = 2,
     tooltip = "Changes the length of the STF calculation",
     group = "Strategic Trend Filter | MisinkoMaster")
cl = input.int(11, "Confirmation Length", step = 1, minval = 2,
     tooltip = "Changes the length of the confirmation calculation",
     group = "Strategic Trend Filter | MisinkoMaster")
al = input.bool(false, "Allow Labels?",
     group = "Strategic Trend Filter | MisinkoMaster")
//////////////////////////////////////////////////////////////////////////////////////////////////
//Calculations
o = open
h = high
l = low
c = close

ohlc = math.avg(o,h,l,c)

//Factors
fo1 = ta.correlation(l, ohlc, len)
fo2 = ta.stdev(l, len)
fo3 = math.abs(ta.roc(l, len))

fh1 = ta.correlation(h, ohlc, len)
fh2 = ta.stdev(h, len)
fh3 = math.abs(ta.roc(h, len))

fl1 = ta.correlation(l, ohlc, len)
fl2 = ta.stdev(l, len)
fl3 = math.abs(ta.roc(l, len))

fc1 = ta.correlation(c, ohlc, len)
fc2 = ta.stdev(c, len)
fc3 = math.abs(ta.roc(c, len))

fo = fo1*fo2*fo3
fh = fh1*fh2*fh3
fl = fl1*fl2*fl3
fc = fc1*fc2*fc3

om = math.avg(ta.highest(o, len), ta.lowest(o, len))
hm = math.avg(ta.highest(h, len), ta.lowest(h, len))
lm = math.avg(ta.highest(l, len), ta.lowest(l, len))
cm = math.avg(ta.highest(c, len), ta.lowest(c, len))

filter_ = (om*fo+hm*fh+lm*fl+cm*fc)/(fo+fh+fl+fc)
filter = volume < volume[1] ? filter_[1] : filter_

tr = ta.tr(true)
mtr = ta.median(tr, cl)
//////////////////////////////////////////////////////////////////////////////////////////////////
//Trend Logic
var trend = 0

L = low > filter and tr > mtr
S = high < filter and tr > mtr

if L and not S
    trend := 1
if S
    trend := -1
//////////////////////////////////////////////////////////////////////////////////////////////////
//Plotting
var col = color.rgb(72, 72, 72)
var colT = color.rgb(72, 72, 72, 50)
if trend == 1
    col := color.rgb(0, 255, 187)
    colT := color.rgb(0, 255, 187, 50)
if trend == -1
    col := color.rgb(255, 0, 157)
    colT := color.rgb(255, 0, 157, 50)

a = plot(filter, "Filter", color = col, linewidth = 2)
b = plot(close, display = display.pane, color = color.rgb(0, 0, 0, 100), editable = false)

fill(a, b, colT)

plotcandle(open, high, low, close, bordercolor = col, color = col, wickcolor = col, display = display.pane, force_overlay = true)

plotshape(trend > trend[1] and al ? math.min(filter, low) : na, style = shape.labelup, location = location.absolute, size = size.normal, color = color.rgb(0, 255, 187), text = "ùìõùì∏ùì∑ùì∞", textcolor = color.rgb(7, 83, 63))
plotshape(trend < trend[1] and al ? math.max(filter, high) : na, style = shape.labeldown,location = location.absolute, size = size.normal,color = color.rgb(255, 0, 157), text = "ùì¢ùì±ùì∏ùìªùìΩ", textcolor = color.rgb(146, 11, 94))
