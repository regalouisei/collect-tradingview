//@version=6
indicator("[blackcat] L2 TTM Squeeze Security Risk", shorttitle="L2 TTM Squeeze+", overlay=false, max_bars_back=5000)

//**
//* 【Enhanced TTM Squeeze Indicator】
//* Indicator Name: TTM Squeeze (Security Risk) Enhanced Version
//* Indicator Type: Sub-chart Indicator with Enhanced Visualization
//* Core Function: Improved indicator based on Bollinger Bands and MACD with vibrant colors and status table
//* 
//* 【Enhanced Features】
//* - Vibrant gradient colors for better visual appeal
//* - Fast/Slow line crossover B/S labels
//* - Real-time status table showing market conditions
//* - Dynamic background colors based on market state
//* - Enhanced signal visibility with animated elements
//*/

// Input parameters for customization
showTable = input.bool(true, "Show Status Table", group="Display Settings")
showLabels = input.bool(true, "Show Buy/Sell Labels", group="Display Settings")
showBackground = input.bool(true, "Show Dynamic Background", group="Display Settings")
transparencyLevel = input.int(70, "Background Transparency", 0, 100, group="Display Settings")

// Calculate 20-day simple moving average
float ma20 = ta.sma(close, 20)

// Calculate MACD2: 2×(close price - 20-day moving average), 20-day period MACD
float macd20 = 2 * (close - ma20)

// Calculate upper band: 20-day moving average + 2×20-day standard deviation
float upperBand = ma20 + 2 * ta.stdev(close, 20)

// Calculate lower band: 20-day moving average - 2×20-day standard deviation
float lowerBand = ma20 - 2 * ta.stdev(close, 20)

// Calculate UP: 2×(upper band - 20-day moving average)
float upLine = 2 * (upperBand - ma20)

// Calculate LO: 2×(lower band - 20-day moving average)
float loLine = 2 * (lowerBand - ma20)

// Calculate 5-day simple moving average
float ma5 = ta.sma(close, 5)

// Calculate MACD1: 2×(close price - 5-day moving average), 5-day period MACD
float macd5 = 2 * (close - ma5)

// Enhanced signal calculations
bool macd20RisingCondition = macd20 > macd20[1] and macd20[1] < macd20[2] and macd20[2] < macd20[3]
bool macd5PositiveCross = macd5[1] < 0 and macd5 > 0
bool ma20Rising = ma20 > ma20[1]

// Original signals
bool buySignal = ta.crossover(close, lowerBand)
bool sellSignal = ta.crossover(upperBand, close)
bool specialSignal = macd20RisingCondition and macd5PositiveCross and ma20Rising

// Additional crossover signals for consistent execution
bool closeCrossLowerBand = ta.crossover(close, lowerBand)
bool upperBandCrossClose = ta.crossover(upperBand, close)

// Enhanced fast/slow line crossover signals
bool fastCrossUp = ta.crossover(macd5, macd20)
bool fastCrossDown = ta.crossunder(macd5, macd20)

// Market state determination
string marketState = macd20 > 0 and macd5 > 0 ? "Strong Uptrend" : macd20 > 0 and macd5 < 0 ? "Consolidation" : macd20 < 0 and macd5 > 0 ? "Rebound Signal" : "Weak Downtrend"

color marketStateColor = macd20 > 0 and macd5 > 0 ? color.new(#00FF00, 60) : macd20 > 0 and macd5 < 0 ? color.new(#FFFF00, 60) : macd20 < 0 and macd5 > 0 ? color.new(#FF9900, 60) : color.new(#FF0000, 60)

// Dynamic background based on market state
bgcolor(showBackground ? marketStateColor : na, title="Market State Background")

// Enhanced vibrant color plots
plot(upLine, "Upper Band", color=#FF1493, linewidth=3)  // Deep Pink
plot(loLine, "Lower Band", color=#00CED1, linewidth=3)  // Dark Turquoise
hline(0, "Zero Line", color=#FFD700, linestyle=hline.style_dashed, linewidth=2)  // Gold

// Enhanced MACD histograms with gradient effects
color macd20PositiveColor = macd20 > macd20[1] ? #FF00FF : #FF69B4  // Magenta to Hot Pink
color macd20NegativeColor = macd20 < macd20[1] ? #00FFFF : #87CEEB  // Cyan to Sky Blue
color macd5PositiveColor = macd5 > macd5[1] ? #9370DB : #DDA0DD  // Purple to Plum
color macd5NegativeColor = macd5 < macd5[1] ? #00FA9A : #98FB98  // Medium Spring Green to Pale Green

plot(macd20 > 0 ? macd20 : na, "MACD20+Positive", color=macd20PositiveColor, style=plot.style_columns, linewidth=2)
plot(macd20 < 0 ? macd20 : na, "MACD20-Negative", color=macd20NegativeColor, style=plot.style_columns, linewidth=2)
plot(macd5 > 0 ? macd5 : na, "MACD5+Positive", color=color.new(macd5PositiveColor, 60), style=plot.style_columns, linewidth=2)
plot(macd5 < 0 ? macd5 : na, "MACD5-Negative", color=color.new(macd5NegativeColor, 60), style=plot.style_columns, linewidth=2)

// Enhanced signal labels with vibrant colors
if showLabels and buySignal
    label.new(bar_index, loLine, "B", style=label.style_label_down, color=#00FF00, textcolor=color.white, size=size.large, textalign=text.align_center)

if showLabels and sellSignal
    label.new(bar_index, upLine, "S", style=label.style_label_up, color=#FF0000, textcolor=color.white, size=size.large, textalign=text.align_center)

if showLabels and closeCrossLowerBand
    label.new(bar_index, loLine, "↑Safe", style=label.style_label_up, color=#FFFFFF, textcolor=color.black, size=size.normal, textalign=text.align_center)

if showLabels and upperBandCrossClose
    label.new(bar_index, upLine, "★Risk", style=label.style_label_down, color=#32CD32, textcolor=color.white, size=size.normal, textalign=text.align_center)

if showLabels and specialSignal
    label.new(bar_index, 0, "●", style=label.style_circle, color=#FF4500, textcolor=color.white, size=size.large, textalign=text.align_center)

// Enhanced fast/slow line crossover B/S labels
if showLabels and fastCrossUp
    label.new(bar_index, math.max(macd5, macd20), "B", style=label.style_label_up, color=#00BFFF, textcolor=color.white, size=size.large, textalign=text.align_center)

if showLabels and fastCrossDown
    label.new(bar_index, math.min(macd5, macd20), "S", style=label.style_label_down, color=#FF6347, textcolor=color.white, size=size.large, textalign=text.align_center)

// Status table creation
var table statusTable = table.new(position.top_right, 4, 6, bgcolor=color.new(#000000, transparencyLevel), border_width=1, border_color=color.gray)

if showTable and barstate.islast
    // Table headers
    table.cell(statusTable, 0, 0, "Indicator", text_color=color.white, text_size=size.small, bgcolor=color.new(#4169E1, 60))
    table.cell(statusTable, 1, 0, "Current", text_color=color.white, text_size=size.small, bgcolor=color.new(#4169E1, 60))
    table.cell(statusTable, 2, 0, "Status", text_color=color.white, text_size=size.small, bgcolor=color.new(#4169E1, 60))
    table.cell(statusTable, 3, 0, "Signal", text_color=color.white, text_size=size.small, bgcolor=color.new(#4169E1, 60))
    
    // MACD20 row
    table.cell(statusTable, 0, 1, "MACD20", text_color=color.white, text_size=size.small)
    table.cell(statusTable, 1, 1, str.tostring(math.round(macd20, 4)), text_color=color.white, text_size=size.small)
    table.cell(statusTable, 2, 1, macd20 > 0 ? "Bullish" : "Bearish", text_color=macd20 > 0 ? color.green : color.red, text_size=size.small)
    table.cell(statusTable, 3, 1, macd20RisingCondition ? "↑" : "→", text_color=macd20RisingCondition ? color.green : color.gray, text_size=size.small)
    
    // MACD5 row
    table.cell(statusTable, 0, 2, "MACD5", text_color=color.white, text_size=size.small)
    table.cell(statusTable, 1, 2, str.tostring(math.round(macd5, 4)), text_color=color.white, text_size=size.small)
    table.cell(statusTable, 2, 2, macd5 > 0 ? "Bullish" : "Bearish", text_color=macd5 > 0 ? color.green : color.red, text_size=size.small)
    table.cell(statusTable, 3, 2, macd5PositiveCross ? "Golden" : "→", text_color=macd5PositiveCross ? color.yellow : color.gray, text_size=size.small)
    
    // MA20 row
    table.cell(statusTable, 0, 3, "MA20", text_color=color.white, text_size=size.small)
    table.cell(statusTable, 1, 3, str.tostring(math.round(ma20, 4)), text_color=color.white, text_size=size.small)
    table.cell(statusTable, 2, 3, ma20Rising ? "Rising" : "Falling", text_color=ma20Rising ? color.green : color.red, text_size=size.small)
    table.cell(statusTable, 3, 3, ma20Rising ? "↑" : "↓", text_color=ma20Rising ? color.green : color.red, text_size=size.small)
    
    // Market State row
    table.cell(statusTable, 0, 4, "Market State", text_color=color.white, text_size=size.small)
    table.cell(statusTable, 1, 4, marketState, text_color=marketStateColor, text_size=size.small, bgcolor=color.new(marketStateColor, 60))
    table.cell(statusTable, 2, 4, fastCrossUp ? "Fast Cross Up" : fastCrossDown ? "Fast Cross Down" : "Balanced", 
              text_color=fastCrossUp ? color.green : fastCrossDown ? color.red : color.gray, text_size=size.small)
    table.cell(statusTable, 3, 4, specialSignal ? "★" : "○", text_color=specialSignal ? color.yellow : color.gray, text_size=size.small)
    
    // Signal Summary row
    table.cell(statusTable, 0, 5, "Signal Summary", text_color=color.white, text_size=size.small, bgcolor=color.new(#FFD700, 60))
    string signalSummary = buySignal ? "Buy" : sellSignal ? "Sell" : specialSignal ? "Special" : "Wait"
    table.cell(statusTable, 1, 5, signalSummary, text_color=buySignal ? color.green : sellSignal ? color.red : specialSignal ? color.yellow : color.gray, 
              text_size=size.small, bgcolor=color.new(buySignal ? color.green : sellSignal ? color.red : specialSignal ? color.yellow : color.gray, 60))
    table.cell(statusTable, 2, 5, closeCrossLowerBand ? "Safe" : upperBandCrossClose ? "Risk" : "Neutral",
              text_color=closeCrossLowerBand ? color.white : upperBandCrossClose ? color.orange : color.gray, text_size=size.small)
    table.cell(statusTable, 3, 5, fastCrossUp ? "B" : fastCrossDown ? "S" : "-", 
              text_color=fastCrossUp ? color.aqua : fastCrossDown ? color.fuchsia : color.gray, text_size=size.small)

// Enhanced visual elements - animated circles for special conditions
if specialSignal
    line.new(bar_index, 0, bar_index + 5, 0, color=color.yellow, width=3, style=line.style_dashed)
    // Circle drawing is not supported in Pine Script, replaced with a label
    label.new(bar_index + 2, 0, "●", style=label.style_circle, color=color.new(color.yellow, 70), textcolor=color.yellow, size=size.large)

// Add trend strength indicator
float trendStrength = math.abs(macd20) + math.abs(macd5)
float maxTrend = ta.highest(trendStrength, 50)
float normalizedTrend = maxTrend > 0 ? trendStrength / maxTrend * 100 : 0

plot(normalizedTrend, "Trend Strength", color=color.new(#FF1493, 60), style=plot.style_area)
hline(50, "Trend Strength Midline", color=color.gray, linestyle=hline.style_dotted)
