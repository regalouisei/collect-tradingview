//@version=6
indicator("HB Directional Range", overlay=true, max_boxes_count=500)

// === Inputs ===
bullColor = input.color(color.new(color.green, 75), "Bullish Range Box Color")
bearColor = input.color(color.new(color.red,   75), "Bearish Range Box Color")
borderClr = input.color(color.new(color.white, 0), "Box Border Color")
borderW   = input.int(1, "Box Border Width", minval=1, maxval=4)

// === Helpers ===
var COORDINATE_MODE = xloc.bar_index
getCurrentX() => COORDINATE_MODE == xloc.bar_index ? bar_index : time
getNextX()    => COORDINATE_MODE == xloc.bar_index ? bar_index + 1 : time + (time - time[1])

isWithinRange(src, bottom, top) => bottom <= src and src <= top
bodyTop()    => math.max(open, close)
bodyBottom() => math.min(open, close)

// Body-based breakout tests (NOT wick-based)
bodyBreaksAbove(top, bottom) =>
    (top < bodyBottom()) or (bottom < bodyBottom() and bodyBottom() < top and bodyTop() > top)
bodyBreaksBelow(top, bottom) =>
    (bottom > bodyTop()) or (bottom < bodyTop() and bodyTop() < top and bodyBottom() < bottom)

// === Range State ===
var float consHigh      = na
var float consLow       = na
var int   consStartX    = na
var int   consEndX      = na
var bool  consStartedUp = false   // initialise as false (set properly later)
var box   consBox       = na

// Breakout flags (optional debug)
var bool isBreakUp   = false
var bool isBreakDown = false

// === Initialization on first bar ===
if na(consHigh)
    consHigh      := high
    consLow       := low
    consStartX    := getCurrentX()
    consEndX      := getNextX()
    consStartedUp := close >= open
    consBox       := box.new(consStartX, consHigh, consEndX, consLow, xloc=COORDINATE_MODE, bgcolor=consStartedUp ? bullColor : bearColor, border_color=borderClr, border_width=borderW)

// === Per-bar maintenance ===
else
    consEndX := getNextX()

    // Is the candle BODY fully inside the current range?
    openIn  = isWithinRange(open,  consLow, consHigh)
    closeIn = isWithinRange(close, consLow, consHigh)

    if not openIn or not closeIn
        // --- Body-based breakout ---
        isBreakUp   := bodyBreaksAbove(consHigh, consLow)
        isBreakDown := bodyBreaksBelow(consHigh, consLow)

        // Start a NEW range anchored to THIS bar (the breakout bar)
        consHigh      := high
        consLow       := low
        consStartX    := getCurrentX()
        consEndX      := getNextX()
        consStartedUp := close >= open

        // Create a new box with direction-based color
        consBox := box.new(consStartX, consHigh, consEndX, consLow, xloc=COORDINATE_MODE, bgcolor=consStartedUp ? bullColor : bearColor, border_color=borderClr, border_width=borderW)

    else
        // --- Body is inside: extend right, expand with wicks if needed ---
        if not na(consBox)
            box.set_right(consBox, consEndX)

        if high > consHigh
            consHigh := high
            if not na(consBox)
                box.set_top(consBox, consHigh)

        if low < consLow
            consLow := low
            if not na(consBox)
                box.set_bottom(consBox, consLow)

// Optional tiny markers to visualize breakout direction
plotchar(isBreakUp,   "Body Break Up",   char="▲", location=location.abovebar, color=color.new(color.green, 0), size=size.tiny)
plotchar(isBreakDown, "Body Break Down", char="▼", location=location.belowbar, color=color.new(color.red,   0), size=size.tiny)
